Index: buddy.php
===================================================================
--- buddy.php	(revision 1095)
+++ buddy.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,10 +26,15 @@
  *
  **/
 
+define('X_SCRIPT', 'buddy.php');
+
 require 'header.php';
 require ROOT.'include/buddy.inc.php';
 
 loadtemplates(
+'buddy_u2u_inv',
+'buddy_u2u_off',
+'buddy_u2u_on',
 'buddy_u2u',
 'buddylist',
 'buddylist_buddy_offline',
@@ -45,12 +50,12 @@
     error($lang['u2unotloggedin']);
 }
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'add':
-        $buddys = getVar('buddys');
+        $buddys = postedVar('buddys', '', TRUE, TRUE, FALSE, 'g');
         if (empty($buddys)) {
-            $buddys = formArray('buddys');
+            $buddys = postedArray('buddys');
         }
         buddy_add($buddys);
         break;
@@ -58,13 +63,16 @@
         buddy_edit();
         break;
     case 'delete':
-        $delete = formArray('delete');
+        $delete = postedArray('delete');
         if ($delete) {
             buddy_delete($delete);
         } else {
             blistmsg($lang['nomember']);
         }
         break;
+    case 'add2u2u':
+        buddy_addu2u();
+        break;
     default:
         buddy_display();
         break;
Index: config.php
===================================================================
--- config.php	(revision 1095)
+++ config.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -125,4 +125,12 @@
     / Comment first line and uncomment second line to use debug mode (1.9+ only). Only one define can be
     / active as define is immutable once set.
     */
+    //
+    /*
+    / To allow everyone to see debug errors (in the case of registration errors or the like), comment first
+    / line and uncomment second line.  DEBUG queries will not be shown.
+    / ****  DEBUG MUST BE SET TO TRUE  ****
+    */
+    define('DEBUG_ALL', false);
+    // define('DEBUG_ALL', true);
 ?>
\ No newline at end of file
Index: cp.php
===================================================================
--- cp.php	(revision 1095)
+++ cp.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'cp.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
@@ -38,7 +40,7 @@
 echo '<script language="JavaScript" type="text/javascript" src="./js/admin.js"></script>';
 
 if (!X_ADMIN) {
-    eval('echo stripslashes("'.template('error_nologinsession').'");');
+    eval('echo "'.template('error_nologinsession').'";');
     end_time();
     eval('echo "'.template('footer').'";');
     exit();
@@ -54,7 +56,7 @@
 
 displayAdminPanel();
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($action == "settings") {
     if (noSubmit('settingsubmit')) {
@@ -72,6 +74,7 @@
         }
         $themelist[] = '</select>';
         $themelist = implode("\n", $themelist);
+        $db->free_result($query);
 
         $onselect = $offselect = '';
         settingHTML('bbstatus', $onselect, $offselect);
@@ -406,22 +409,22 @@
         <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings1']?></font></strong></td>
         </tr>
         <?php
-        printsetting2($lang['textsitename'], 'sitenamenew', stripslashes($SETTINGS['sitename']), 50);
-        printsetting2($lang['bbname'], 'bbnamenew', stripslashes($SETTINGS['bbname']), 50);
-        printsetting2($lang['textsiteurl'], 'siteurlnew', stripslashes($SETTINGS['siteurl']), 50);
-        printsetting2($lang['textboardurl'], 'boardurlnew', stripslashes($SETTINGS['boardurl']), 50);
-        printsetting2($lang['adminemail'], 'adminemailnew', stripslashes($SETTINGS['adminemail']), 50);
+        printsetting2($lang['textsitename'], 'sitenamenew', $SETTINGS['sitename'], 50);
+        printsetting2($lang['bbname'], 'bbnamenew', $SETTINGS['bbname'], 50);
+        printsetting2($lang['textsiteurl'], 'siteurlnew', $SETTINGS['siteurl'], 50);
+        printsetting2($lang['textboardurl'], 'boardurlnew', $SETTINGS['boardurl'], 50);
+        printsetting2($lang['adminemail'], 'adminemailnew', $SETTINGS['adminemail'], 50);
         printsetting1($lang['textbbrules'], 'bbrulesnew', $ruleson, $rulesoff);
         ?>
         <?php
-        printsetting4($lang['textbbrulestxt'], 'bbrulestxtnew', stripslashes($SETTINGS['bbrulestxt']), 5, 50);
+        printsetting4($lang['textbbrulestxt'], 'bbrulestxtnew', $SETTINGS['bbrulestxt'], 5, 50);
         printsetting1($lang['textbstatus'], 'bbstatusnew', $onselect, $offselect);
-        printsetting4($lang['textbboffreason'], 'bboffreasonnew', stripslashes($SETTINGS['bboffreason']), 5, 50);
+        printsetting4($lang['textbboffreason'], 'bboffreasonnew', $SETTINGS['bboffreason'], 5, 50);
         printsetting1($lang['gzipcompression'], 'gzipcompressnew', $gzipcompresson, $gzipcompressoff);
         ?>
         <tr class="tablerow">
@@ -533,7 +536,7 @@
         printsetting2($lang['max_avatar_size_h'], 'max_avatar_size_h_new', $max_avatar_sizes[1], 4);
         printsetting1($lang['what_tickerstatus'], 'tickerstatusnew', $tickerstatuson, $tickerstatusoff);
         printsetting2($lang['what_tickerdelay'], 'tickerdelaynew', ((int)$SETTINGS['tickerdelay']), 5);
-        printsetting4($lang['tickercontents'], 'tickercontentsnew', stripslashes($SETTINGS['tickercontents']), 5, 50);
+        printsetting4($lang['tickercontents'], 'tickercontentsnew', $SETTINGS['tickercontents'], 5, 50);
         ?>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
@@ -572,15 +575,15 @@
         </tr>
         <?php
     } else {
-        $sitenamenew = formVar('sitenamenew');
-        $bbnamenew = formVar('bbnamenew');
-        $siteurlnew = formVar('siteurlnew');
-        $boardurlnew = formVar('boardurlnew');
-        $adminemailnew = formVar('adminemailnew');
+        $sitenamenew = postedVar('sitenamenew');
+        $bbnamenew = postedVar('bbnamenew');
+        $siteurlnew = postedVar('siteurlnew');
+        $boardurlnew = postedVar('boardurlnew');
+        $adminemailnew = postedVar('adminemailnew');
         $bbrulesnew = formOnOff('bbrulesnew');
-        $bbrulestxtnew = addslashes(formVar('bbrulestxtnew'));
+        $bbrulestxtnew = postedVar('bbrulestxtnew');
         $bbstatusnew = formOnOff('bbstatusnew');
-        $bboffreasonnew = addslashes(formVar('bboffreasonnew'));
+        $bboffreasonnew = postedVar('bboffreasonnew');
         $gzipcompressnew = formOnOff('gzipcompressnew');
 
         $langfilenew = getLangFileNameFromHash($langfilenew);
@@ -595,7 +598,7 @@
         $topicperpagenew = formInt('topicperpagenew');
         $memberperpagenew = formInt('memberperpagenew');
         $timeformatnew = formInt('timeformatnew');
-        $dateformatnew = formVar('dateformatnew');
+        $dateformatnew = postedVar('dateformatnew');
         $searchstatusnew = formOnOff('searchstatusnew');
         $faqstatusnew = formOnOff('faqstatusnew');
         $todaystatusnew = formOnOff('todaystatusnew');
@@ -624,7 +627,10 @@
         $emailchecknew = formOnOff('emailchecknew');
         $floodctrlnew = formInt('floodctrlnew');
         $u2uquotanew = formInt('u2uquotanew');
-        $avastatusnew = formOnOff('avastatusnew');
+        $avastatusnew = postedVar('avastatusnew');
+        if ($avastatusnew != 'on' And $avastatusnew != 'list') {
+            $avastatusnew = 'off';
+        }
         $resetSigNew = formOnOff('resetSigNew');
         $doubleenew = formOnOff('doubleenew');
         $pruneusersnew = formInt('pruneusersnew');
@@ -640,28 +646,30 @@
         }
 
         $maxAttachSize = formInt('maxAttachSize');
-        $def_tz_new = formInt('def_tz_new');
+        $def_tz_new = isset($_POST['def_tz_new']) && is_numeric($_POST['def_tz_new']) ? $_POST['def_tz_new'] : 0;
         $addtimenew = isset($_POST['addtimenew']) && is_numeric($_POST['addtimenew']) ? $_POST['addtimenew'] : 0;
         $sigbbcodenew = formOnOff('sigbbcodenew');
         $sightmlnew = formOnOff('sightmlnew');
         $max_avatar_size_w_new = formInt('max_avatar_size_w_new');
         $max_avatar_size_h_new = formInt('max_avatar_size_h_new');
+        $tickerstatusnew = formOnOff('tickerstatusnew');
         $tickerdelaynew = formInt('tickerdelaynew');
+        $tickercontentsnew = postedVar('tickercontentsnew');
         $maxDayReg = formInt('maxDayReg');
         $captchanew = formOnOff('captchanew');
         $captcharegnew = formOnOff('captcharegnew');
         $captchapostnew = formOnOff('captchapostnew');
-        $captchacharsetnew = formVar('captchacharsetnew');
+        $captchacharsetnew = postedVar('captchacharsetnew');
         $captchacodenew = formInt('captchacodenew');
         $captchacodecasenew = formOnOff('captchacodecasenew');
         $captchacodeshadownew = formOnOff('captchacodeshadownew');
-        $captchaimagetypenew = formVar('captchaimagetypenew');
+        $captchaimagetypenew = postedVar('captchaimagetypenew');
         $captchaimagewidthnew = formInt('captchaimagewidthnew');
         $captchaimageheightnew = formInt('captchaimageheightnew');
-        $captchaimagebgnew = formVar('captchaimagebgnew');
+        $captchaimagebgnew = postedVar('captchaimagebgnew');
         $captchaimagedotsnew = formInt('captchaimagedotsnew');
         $captchaimagelinesnew = formInt('captchaimagelinesnew');
-        $captchaimagefontsnew = formVar('captchaimagefontsnew');
+        $captchaimagefontsnew = postedVar('captchaimagefontsnew');
         $captchaimageminfontnew = formInt('captchaimageminfontnew');
         $captchaimagemaxfontnew = formInt('captchaimagemaxfontnew');
         $captchaimagecolornew = formOnOff('captchaimagecolornew');
@@ -773,8 +781,8 @@
     }
 
     if (onSubmit('renamesubmit')) {
-        $vUserFrom = formVar('frmUserFrom');
-        $vUserTo = formVar('frmUserTo');
+        $vUserFrom = postedVar('frmUserFrom', '', TRUE, FALSE);
+        $vUserTo = postedVar('frmUserTo', '', TRUE, FALSE);
         $adm = new admin();
         $myErr = $adm->rename_user($vUserFrom, $vUserTo);
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$myErr.'</td></tr>';
@@ -786,7 +794,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><strong><font color="<?php echo $cattext?>"><?php echo $lang['admin_rename_txt']?></font></strong></td>
         </tr>
@@ -825,14 +833,14 @@
         while($selForums = $db->fetch_array($query)) {
             if ($selForums['type'] == 'group') {
                 $groups[$i]['fid'] = $selForums['fid'];
-                $groups[$i]['name'] = htmlspecialchars_decode($selForums['name']);
+                $groups[$i]['name'] = $selForums['name'];
                 $groups[$i]['displayorder'] = $selForums['displayorder'];
                 $groups[$i]['status'] = $selForums['status'];
                 $groups[$i]['fup'] = $selForums['fup'];
             } else if ($selForums['type'] == 'forum') {
                 $id = (empty($selForums['fup'])) ? 0 : $selForums['fup'];
                 $forums[$id][$i]['fid'] = $selForums['fid'];
-                $forums[$id][$i]['name'] = htmlspecialchars_decode($selForums['name']);
+                $forums[$id][$i]['name'] = $selForums['name'];
                 $forums[$id][$i]['displayorder'] = $selForums['displayorder'];
                 $forums[$id][$i]['status'] = $selForums['status'];
                 $forums[$id][$i]['fup'] = $selForums['fup'];
@@ -840,7 +848,7 @@
                 $forumlist[$i]['name'] = $selForums['name'];
             } else if ($selForums['type'] == 'sub') {
                 $subs[$selForums['fup']][$i]['fid'] = $selForums['fid'];
-                $subs[$selForums['fup']][$i]['name'] = htmlspecialchars_decode($selForums['name']);
+                $subs[$selForums['fup']][$i]['name'] = $selForums['name'];
                 $subs[$selForums['fup']][$i]['displayorder'] = $selForums['displayorder'];
                 $subs[$selForums['fup']][$i]['status'] = $selForums['status'];
                 $subs[$selForums['fup']][$i]['fup'] = $selForums['fup'];
@@ -854,7 +862,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textforumopts']?></strong></font></td>
         </tr>
@@ -875,8 +883,20 @@
             <option value="on" <?php echo $on?>><?php echo $lang['texton']?></option><option value="off" <?php echo $off?>><?php echo $lang['textoff']?></option></select>
             &nbsp; <select name="moveto<?php echo $forum['fid']?>"><option value="" selected="selected">-<?php echo $lang['textnone']?>-</option>
             <?php
-            foreach($groups as $moveforum) {
+            if (!isset($subs[$forum['fid']])) { //Ungrouped forum options.
+                foreach($forums[0] as $moveforum) {
+                    if ($moveforum['fid'] != $forum['fid']) {
+                        echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                    }
+                }
+            }
+            foreach($groups as $moveforum) { //Groups and grouped forum options.
                 echo "<option value=\"$moveforum[fid]\">".stripslashes($moveforum['name'])."</option>";
+                if (!isset($subs[$forum['fid']])) {
+                    foreach($forums[$moveforum['fid']] as $moveforum) {
+                        echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                    }
+                }
             }
             ?>
             </select>
@@ -898,15 +918,22 @@
                     &nbsp; <?php echo $lang['textorder']?> <input type="text" name="displayorder<?php echo $subforum['fid']?>" size="2" value="<?php echo $subforum['displayorder']?>" />
                     &nbsp; <select name="status<?php echo $subforum['fid']?>">
                     <option value="on" <?php echo $on?>><?php echo $lang['texton']?></option><option value="off" <?php echo $off?>><?php echo $lang['textoff']?></option></select>
-                    &nbsp; <select name="moveto<?php echo $subforum['fid']?>">
+                    &nbsp; <select name="moveto<?php echo $subforum['fid']?>"><option value="" selected="selected">-<?php echo $lang['textnone']?>-</option>
                     <?php
-                    foreach($forumlist as $moveforum) {
-                        if ($subforum['fup'] == $moveforum['fid']) {
-                            echo '<option value="'.$moveforum['fid'].'" selected="selected">'.stripslashes($moveforum['name']).'</option>';
+                    foreach($forums[0] as $moveforum) { //Ungrouped forum options.
+                        if ($moveforum['fid'] == $subforum['fup']) {
+                            $curgroup = $selHTML;
                         } else {
-                            echo '<option value="'.$moveforum['fid'].'">'.stripslashes($moveforum['name']).'</option>';
+                            $curgroup = '';
                         }
+                        echo "<option value=\"$moveforum[fid]\" $curgroup> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
                     }
+                    foreach($groups as $moveforum) { //Groups and grouped forum options.
+                        echo '<option value="'.$moveforum['fid'].'">'.stripslashes($moveforum['name']).'</option>';
+                        foreach($forums[$moveforum['fid']] as $moveforum) {
+                            echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                        }
+                    }
                     ?>
                     </select>
                     <a href="cp.php?action=forum&amp;fdetails=<?php echo $subforum['fid']?>"><?php echo $lang['textmoreopts']?></a></td>
@@ -953,13 +980,25 @@
                     <option value="on" <?php echo $on?>><?php echo $lang['texton']?></option><option value="off" <?php echo $off?>><?php echo $lang['textoff']?></option></select>
                     &nbsp; <select name="moveto<?php echo $forum['fid']?>"><option value="">-<?php echo $lang['textnone']?>-</option>
                     <?php
-                    foreach($groups as $moveforum) {
+                    if (!isset($subs[$forum['fid']])) { //Ungrouped forum options.
+                        foreach($forums[0] as $moveforum) {
+                            echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                        }
+                    }
+                    foreach($groups as $moveforum) { //Groups and grouped forum options.
                         if ($moveforum['fid'] == $forum['fup']) {
                             $curgroup = $selHTML;
                         } else {
                             $curgroup = '';
                         }
                         echo '<option value="'.$moveforum['fid'].'" '.$curgroup.'>'.stripslashes($moveforum['name']).'</option>';
+                        if (!isset($subs[$forum['fid']]) And isset($forums[$moveforum['fid']])) {
+                            foreach($forums[$moveforum['fid']] as $moveforum) {
+                                if ($moveforum['fid'] != $forum['fid']) {
+                                    echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                                }
+                            }
+                        }
                     }
                     ?>
                     </select>
@@ -981,13 +1020,22 @@
                             &nbsp; <?php echo $lang['textorder']?> <input type="text" name="displayorder<?php echo $forum['fid']?>" size="2" value="<?php echo $forum['displayorder']?>" />
                             &nbsp; <select name="status<?php echo $forum['fid']?>">
                             <option value="on" <?php echo $on?>><?php echo $lang['texton']?></option><option value="off" <?php echo $off?>><?php echo $lang['textoff']?></option></select>
-                            &nbsp; <select name="moveto<?php echo $forum['fid']?>">
+                            &nbsp; <select name="moveto<?php echo $forum['fid']?>"><option value="" selected="selected">-<?php echo $lang['textnone']?>-</option>
                             <?php
-                            foreach($forumlist as $moveforum) {
-                                if ($moveforum['fid'] == $forum['fup']) {
-                                    echo '<option value="'.$moveforum['fid'].'" selected="selected">'.html_entity_decode(stripslashes($moveforum['name'])).'</option>';
-                                } else {
-                                    echo '<option value="'.$moveforum['fid'].'">'.html_entity_decode(stripslashes($moveforum['name'])).'</option>';
+                            foreach($forums[0] as $moveforum) { //Ungrouped forum options.
+                                echo "<option value=\"$moveforum[fid]\" $curgroup> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                            }
+                            foreach($groups as $moveforum) { //Groups and grouped forum options.
+                                echo '<option value="'.$moveforum['fid'].'">'.stripslashes($moveforum['name']).'</option>';
+                                if (isset($forums[$moveforum['fid']])) {
+                                    foreach($forums[$moveforum['fid']] as $moveforum) {
+                                        if ($moveforum['fid'] == $forum['fup']) {
+                                            $curgroup = $selHTML;
+                                        } else {
+                                            $curgroup = '';
+                                        }
+                                        echo "<option value=\"$moveforum[fid]\" $curgroup> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                                    }
                                 }
                             }
                             ?>
@@ -1018,7 +1066,7 @@
         &nbsp; <select name="newffup"><option value="" selected="selected">-<?php echo $lang['textnone']?>-</option>
         <?php
         foreach($groups as $group) {
-            echo '<option value="'.$group['fid'].'">'.html_entity_decode(stripslashes($group['name'])).'</option>';
+            echo '<option value="'.$group['fid'].'">'.fnameOut($group['name']).'</option>';
         }
         ?>
         </select>
@@ -1031,7 +1079,7 @@
         &nbsp; <select name="newsubfup">
         <?php
         foreach($forumlist as $group) {
-            echo '<option value="'.$group['fid'].'">'.html_entity_decode(stripslashes($group['name'])).'</option>';
+            echo '<option value="'.$group['fid'].'">'.fnameOut($group['name']).'</option>';
         }
         ?>
         </select>
@@ -1056,7 +1104,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textforumopts']?></strong></font></td>
         </tr>
@@ -1077,6 +1125,7 @@
         }
         $themelist[] = '</select>';
         $themelist = implode("\n", $themelist);
+        $db->free_result($query);
 
         if ($forum['allowhtml'] == "yes") {
             $checked2 = $cheHTML;
@@ -1108,63 +1157,15 @@
             $checked6 = '';
         }
 
-        if ($forum['pollstatus'] == "on") {
-            $checked7 = $cheHTML;
-        } else {
-            $checked7 = '';
-        }
-
-        if ($forum['guestposting'] == "on") {
-            $checked8 = $cheHTML;
-        } else {
-            $checked8 = '';
-        }
-
-        $pperm = explode('|', $forum['postperm']);
-
-        $type11 = $type12 = $type13 = $type14 = '';
-        if ($pperm[0] == 2) {
-            $type12 = $selHTML;
-        } else if ($pperm['0'] == 3) {
-            $type13 = $selHTML;
-        } else if ($pperm[0] == 4) {
-            $type14 = $selHTML;
-        } else if ($pperm[0] == 1) {
-            $type11 = $selHTML;
-        }
-
-        $type21 = $type22 = $type23 = $type24 = '';
-        if ($pperm[1] == 2) {
-            $type22 = $selHTML;
-        } else if ($pperm[1] == 3) {
-            $type23 = $selHTML;
-        } else if ($pperm[1] == 4) {
-            $type24 = $selHTML;
-        } else if ($pperm[1] == 1) {
-            $type21 = $selHTML;
-        }
-
-        $type31 = $type32 = $type33 = $type34 = '';
-        if ($forum['private'] == 2) {
-            $type32 = $selHTML;
-        } else if ($forum['private'] == 3) {
-            $type33 = $selHTML;
-        } else if ($forum['private'] == 4) {
-            $type34 = $selHTML;
-        } else if ($forum['private'] == 1) {
-            $type31 = $selHTML;
-        }
-
         $forum['name'] = stripslashes($forum['name']);
-        $forum['description'] = stripslashes($forum['description']);
         ?>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textforumname']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><input type="text" name="namenew" value="<?php echo htmlspecialchars_decode($forum['name'])?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>"><input type="text" name="namenew" value="<?php echo $forum['name']; ?>" /></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textdesc']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="descnew"><?php echo htmlspecialchars_decode($forum['description'])?></textarea></td>
+        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="descnew"><?php echo $forum['description']; ?></textarea></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>" valign="top"><?php echo $lang['textallow']?></td>
@@ -1174,51 +1175,61 @@
         <input type="checkbox" name="allowbbcodenew" value="yes" <?php echo $checked4?> /><?php echo $lang['textbbcode']?><br />
         <input type="checkbox" name="allowimgcodenew" value="yes" <?php echo $checked5?> /><?php echo $lang['textimgcode']?><br />
         <input type="checkbox" name="attachstatusnew" value="on" <?php echo $checked6?> /><?php echo $lang['attachments']?><br />
-        <input type="checkbox" name="pollstatusnew" value="on" <?php echo $checked7?> /><?php echo $lang['polls']?><br />
-        <input type="checkbox" name="guestpostingnew" value="on" <?php echo $checked8?> /><?php echo $lang['textanonymousposting']?><br />
         </td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['texttheme']?></td>
         <td bgcolor="<?php echo $altbg2?>"><?php echo $themelist?></td>
         </tr>
+
         <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['whopostop1']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><select name="postperm1">
-        <option value="1" <?php echo $type11?>><?php echo $lang['textpermission1']?>
-        <option value="2" <?php echo $type12?>><?php echo $lang['textpermission2']?>
-        <option value="3" <?php echo $type13?>><?php echo $lang['textpermission3']?>
-        <option value="4" <?php echo $type14?>><?php echo $lang['textpermission41']?>
-        </select>
-        </td>
+        <td style="background-color: <?php echo $THEME['altbg1']?>"><?php echo $lang['forumpermissions']?></td>
+        <td style="background-color: <?php echo $THEME['altbg2']?>"><table style="width: 100%; text-align: center;">
+        <?php
+        $perms = explode(',', $forum['postperm']);
+        $statusList = array(
+            'Super Administrator'   => 1,
+            'Administrator'         => 2,
+            'Super Moderator'       => 4,
+            'Moderator'             => 8,
+            'Member'                => 16,
+            'guest'                 => 32);
+         ?>
+        <tr>
+            <td class="tablerow" style="width: 25ex;">&nbsp;</td>
+            <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['polls'];   ?></td>
+            <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['threads']; ?></td>
+            <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['replies']; ?></td>
+            <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['view'];    ?></td>
         </tr>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['whopostop2']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><select name="postperm2">
-        <option value="1" <?php echo $type21?>><?php echo $lang['textpermission1']?>
-        <option value="2" <?php echo $type22?>><?php echo $lang['textpermission2']?>
-        <option value="3" <?php echo $type23?>><?php echo $lang['textpermission3']?>
-        <option value="4" <?php echo $type24?>><?php echo $lang['textpermission41']?>
-        </select>
-        </td>
+        <?php
+        foreach($statusList as $key=>$val) {
+            if (!X_SADMIN and $key == 'Super Administrator') {
+                $disabled = 'disabled="disabled"';
+            } else {
+                $disabled = '';
+            }
+            ?>
+            <tr class="tablerow">
+                <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: right;"><?php echo ucwords($key);?></td>
+                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[0][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_POLL]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[1][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_THREAD]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[2][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_REPLY]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[3][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_VIEW]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+            </tr>
+            <?php
+        }
+        ?>
+        </table></td>
         </tr>
+
         <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['whoview']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><select name="privatenew">
-        <option value="1" <?php echo $type31?>><?php echo $lang['textpermission1']?>
-        <option value="2" <?php echo $type32?>><?php echo $lang['textpermission2']?>
-        <option value="3" <?php echo $type33?>><?php echo $lang['textpermission3']?>
-        <option value="4" <?php echo $type34?>><?php echo $lang['textpermission42']?>
-        </select>
-        </td>
-        </tr>
-        <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textuserlist']?></td>
         <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="userlistnew"><?php echo $forum['userlist']?></textarea></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['forumpw']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><input type="text" name="passwordnew" value="<?php echo htmlspecialchars($forum['password'])?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>"><input type="text" name="passwordnew" value="<?php echo attrOut($forum['password'], 'javascript')?>" /></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textdeleteques']?></td>
@@ -1236,18 +1247,18 @@
         </tr>
         <?php
     } else if (onSubmit('forumsubmit') && !$fdetails) {
-        $queryforum = $db->query("SELECT fid, type FROM ".X_PREFIX."forums WHERE type='forum' OR type='sub'");
+        $queryforum = $db->query("SELECT fid, type, fup FROM ".X_PREFIX."forums WHERE type='forum' OR type='sub'");
         $db->query("DELETE FROM ".X_PREFIX."forums WHERE name=''");
         while($forum = $db->fetch_array($queryforum)) {
             $displayorder = formInt('displayorder'.$forum['fid']);
             $self['status'] = formOnOff('status'.$forum['fid']);
-            $name = formVar('name'.$forum['fid']);
-            $delete = formVar('delete'.$forum['fid']);
+            $name = addslashes(htmlspecialchars(postedVar('name'.$forum['fid'], 'javascript', FALSE), ENT_COMPAT)); //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
+            $delete = formInt('delete'.$forum['fid']);
             $moveto = formInt('moveto'.$forum['fid']);
 
-            if ($delete) {
-                $db->query("DELETE FROM ".X_PREFIX."forums WHERE (type='forum' OR type='sub') AND fid='$delete'");
-                $querythread = $db->query("SELECT tid, author FROM ".X_PREFIX."threads WHERE fid='$delete'");
+            if ($delete == $forum['fid']) {
+                $db->query("DELETE FROM ".X_PREFIX."forums WHERE (type='forum' OR type='sub') AND fid=$delete");
+                $querythread = $db->query("SELECT tid, author FROM ".X_PREFIX."threads WHERE fid=$delete");
                 while($thread = $db->fetch_array($querythread)) {
                     $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$thread[tid]'");
                     $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$thread[tid]'");
@@ -1261,73 +1272,109 @@
                 }
                 $db->free_result($querythread);
             }
-            $name = addslashes($name);
-            $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='$self[status]', fup=".$moveto." WHERE fid='".$forum['fid']."'");
+            $settype = '';
+            if ($forum['fup'] != $moveto And $moveto != $forum['fid'] And $forum['type'] != 'group') { //Forum is being moved
+                if ($moveto == 0) {
+                    $settype = ", type='forum', fup=0";
+                } else {
+                    $query = $db->query("SELECT type FROM ".X_PREFIX."forums WHERE fid=$moveto");
+                    if ($frow = $db->fetch_array($query)) {
+                        if ($frow['type'] == 'group') {
+                            $settype = ", type='forum', fup=$moveto";
+                        } else if ($frow['type'] == 'forum') {
+                            if ($forum['type'] == 'sub') {
+                                $settype = ", fup=$moveto";
+                            } else if ($forum['type'] == 'forum') { //Make sure the admin didn't try to demote a parent
+                                $query2 = $db->query("SELECT COUNT(*) AS subcount FROM ".X_PREFIX."forums WHERE fup={$forum['fid']}");
+                                $frow = $db->fetch_array($query2);
+                                $db->free_result($query2);
+                                if ($frow['subcount'] == 0) {
+                                    $settype = ", type='sub', fup=$moveto";
+                                }
+                            }
+                        }
+                    }
+                    $db->free_result($query);
+                }
+            }
+            $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='$self[status]'$settype WHERE fid='".$forum['fid']."'");
         }
 
         $querygroup = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
         while($group = $db->fetch_array($querygroup)) {
-            $name = formVar('name'.$group['fid']);
+            $name = addslashes(htmlspecialchars(postedVar('name'.$group['fid'], 'javascript', FALSE), ENT_COMPAT));  //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
             $displayorder = formInt('displayorder'.$group['fid']);
             $self['status'] = formOnOff('status'.$group['fid']);
-            $delete = formVar('delete'.$group['fid']);
+            $delete = formInt('delete'.$group['fid']);
 
-            if ($delete) {
-                $query = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup='$delete'");
+            if ($delete == $group['fid']) {
+                $query = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup=$delete");
                 while($forum = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."forums SET fup=0 WHERE type='forum' AND fup='$delete'");
+                    $db->query("UPDATE ".X_PREFIX."forums SET fup=0 WHERE type='forum' AND fup=$delete");
                 }
-                $db->query("DELETE FROM ".X_PREFIX."forums WHERE type='group' AND fid='$delete'");
+                $db->query("DELETE FROM ".X_PREFIX."forums WHERE type='group' AND fid=$delete");
             }
-            $name = addslashes($name);
             $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='".$self['status']."' WHERE fid='".$group['fid']."'");
         }
 
-        $newgname = formVar('newgname');
-        $newfname = formVar('newfname');
-        $newsubname = formVar('newsubname');
-        $newgorder = formVar('newgorder');
-        $newforder = formVar('newforder');
-        $newsuborder = formVar('newsuborder');
+        $newgname = addslashes(htmlspecialchars(postedVar('newgname', 'javascript', FALSE), ENT_COMPAT));  //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
+        $newfname = addslashes(htmlspecialchars(postedVar('newfname', 'javascript', FALSE), ENT_COMPAT));
+        $newsubname = addslashes(htmlspecialchars(postedVar('newsubname', 'javascript', FALSE), ENT_COMPAT));
+        $newgorder = formInt('newgorder');
+        $newforder = formInt('newforder');
+        $newsuborder = formInt('newsuborder');
         $newgstatus = formOnOff('newgstatus');
         $newfstatus = formOnOff('newfstatus');
         $newsubstatus = formOnOff('newsubstatus');
         $newffup = formInt('newffup');
         $newsubfup = formInt('newsubfup');
 
-        if ($newfname != $lang['textnewforum']) {
-            $newfname = addslashes($newfname);
-            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, private, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, pollstatus, password, guestposting) VALUES ('forum', '$newfname', '$newfstatus', '', '', ".(int)$newforder.", '1', '', 'no', 'yes', 'yes', '', 0, 0, 0, ".(int)$newffup.", '1|1', 'yes', 'on', 'on', '', 'off')");
+        if ($newfname != $lang['textnewforum'] And $newfname != '') {
+            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, password) VALUES ('forum', '$newfname', '$newfstatus', '', '', $newforder, '', 'no', 'yes', 'yes', '', 0, 0, 0, $newffup, '31,31,31,63', 'yes', 'on', '')");
         }
 
-        if ($newgname != $lang['textnewgroup']) {
-            $newgname = addslashes($newgname);
-            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, private, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, pollstatus, password, guestposting) VALUES ('group', '$newgname', '$newgstatus', '', '', ".(int)$newgorder.", '', '', '', '', '', '', 0, 0, 0, 0, '', '', '', '', '', 'off')");
+        if ($newgname != $lang['textnewgroup'] And $newgname != '') {
+            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, password) VALUES ('group', '$newgname', '$newgstatus', '', '', $newgorder, '', '', '', '', '', 0, 0, 0, 0, '', '', '', '')");
         }
 
-        if ($newsubname != $lang['textnewsubf']) {
-            $newsubname = addslashes($newsubname);
-            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, private, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, pollstatus, password, guestposting) VALUES ('sub', '$newsubname', '$newsubstatus', '', '', ".(int)$newsuborder.", '1', '', 'no', 'yes', 'yes', '', 0, 0, 0, ".(int)$newsubfup.", '1|1', 'yes', 'on', 'on', '', 'off')");
+        if ($newsubname != $lang['textnewsubf'] And $newsubname != '') {
+            $db->query("INSERT INTO ".X_PREFIX."forums (type, name, status, lastpost, moderator, displayorder, description, allowhtml, allowsmilies, allowbbcode, userlist, theme, posts, threads, fup, postperm, allowimgcode, attachstatus, password) VALUES ('sub', '$newsubname', '$newsubstatus', '', '', $newsuborder, '', 'no', 'yes', 'yes', '', 0, 0, 0, $newsubfup, '31,31,31,63', 'yes', 'on', '')");
         }
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textforumupdate'].'</td></tr>';
     } else {
-        $namenew = addslashes(formVar('namenew', false));
-        $descnew = addslashes(formVar('descnew', false));
+        $namenew = addslashes(htmlspecialchars(postedVar('namenew', 'javascript', FALSE), ENT_COMPAT));  //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
+        $descnew = postedVar('descnew');
         $allowhtmlnew = formYesNo('allowhtmlnew');
         $allowsmiliesnew = formYesNo('allowsmiliesnew');
         $allowbbcodenew = formYesNo('allowbbcodenew');
         $allowimgcodenew = formYesNo('allowimgcodenew');
         $attachstatusnew = formOnOff('attachstatusnew');
-        $pollstatusnew = formOnOff('pollstatusnew');
-        $guestpostingnew = formOnOff('guestpostingnew');
         $themeforumnew = formInt('themeforumnew');
-        $postperm1 = formInt('postperm1');
-        $postperm2 = formInt('postperm2');
-        $privatenew = formInt('privatenew');
-        $userlistnew = addslashes(formVar('userlistnew'));
-        $passwordnew = formVar('passwordnew');
+        $userlistnew = postedVar('userlistnew', 'javascript');
+        $passwordnew = postedVar('passwordnew', '', FALSE, TRUE);
         $delete = formInt('delete');
 
+        if (!X_SADMIN) {
+            $overrule = array(0,0,0,0);
+            $forum = $db->fetch_array($db->query("SELECT postperm FROM ".X_PREFIX."forums WHERE fid=$fdetails"));
+            $parts = explode(',', $forum['postperm']);
+            foreach($parts as $p=>$v) {
+                if ($v & 1 == 1) {
+                    // super admin status set
+                    $overrule[$p] = 1;
+                }
+            }
+        } else {
+            $overrule = array(0,0,0,0);
+        }
+
+        $perms = array(0,0,0,0);
+        foreach($permsNew as $key=>$val) {
+            $perms[$key] = array_sum($val);
+            $perms[$key] |= $overrule[$key];
+        }
+        $perms = implode(',', $perms);
+
         $db->query("UPDATE ".X_PREFIX."forums SET
             name='$namenew',
             description='$descnew',
@@ -1336,18 +1383,15 @@
             allowbbcode='$allowbbcodenew',
             theme='$themeforumnew',
             userlist='$userlistnew',
-            private='$privatenew',
-            postperm='$postperm1|$postperm2',
+            postperm='$perms',
             allowimgcode='$allowimgcodenew',
             attachstatus='$attachstatusnew',
-            pollstatus='$pollstatusnew',
-            password='$passwordnew',
-            guestposting='$guestpostingnew'
+            password='$passwordnew'
             WHERE fid='$fdetails'"
-        );
+       );
 
         if ($delete) {
-            $db->query("DELETE FROM ".X_PREFIX."forums WHERE fid='$delete'");
+            $db->query("DELETE FROM ".X_PREFIX."forums WHERE fid=$delete");
         }
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textforumupdate'].'</td></tr>';
     }
@@ -1362,7 +1406,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textforum']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textmoderator']?></font></strong></td>
@@ -1375,13 +1419,13 @@
                 $oldfid = $forum['cat_fid']
                 ?>
                 <tr bgcolor="<?php echo $altbg1?>" class="tablerow">
-                <td colspan="2"><strong><?php echo html_entity_decode(stripslashes($forum['cat_name']))?></strong></td>
+                <td colspan="2"><strong><?php echo fnameOut($forum['cat_name'])?></strong></td>
                 </tr>
                 <?php
             }
             ?>
             <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-            <td><?php echo html_entity_decode(stripslashes($forum['name']))?></td>
+            <td><?php echo fnameOut($forum['name'])?></td>
             <td><input type="text" name="mod[<?php echo $forum['fid']?>]"" value="<?php echo $forum['moderator']?>" /></td>
             </tr>
             <?php
@@ -1389,7 +1433,7 @@
             while($sub = $db->fetch_array($querys)) {
                 ?>
                 <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-                <td><?php echo $lang['4spaces']?><?php echo $lang['4spaces']?><em><?php echo html_entity_decode(stripslashes($sub['name']))?></em></td>
+                <td><?php echo $lang['4spaces']?><?php echo $lang['4spaces']?><em><?php echo fnameOut($sub['name'])?></em></td>
                 <td><input type="text" name="mod[<?php echo $sub['fid']?>]"" value="<?php echo $sub['moderator']?>" /></td>
                 </tr>
                 <?php
@@ -1422,7 +1466,7 @@
 }
 
 if ($action == "members") {
-    $members = getVar('members');
+    $members = postedVar('members', '', FALSE, FALSE, FALSE, 'g');
     if (noSubmit('membersubmit')) {
         if (!$members) {
             ?>
@@ -1432,7 +1476,7 @@
             <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
             <tr>
             <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
             <tr>
             <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textmembers']?></strong></font></td>
             </tr>
@@ -1468,13 +1512,14 @@
             <?php
         } else if ($members == "search") {
             ?>
+            <script language="javascript" type="text/javascript">var delmem = Array();</script>
             <tr bgcolor="<?php echo $altbg2?>">
             <td align="center">
             <form method="post" action="cp.php?action=members">
             <table cellspacing="0" cellpadding="0" border="0" width="91%" align="center">
             <tr>
             <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
             <tr class="category">
             <td align="center" width="3%"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
             <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textusername']?></font></strong></td>
@@ -1485,14 +1530,15 @@
             <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textbanfrom']?></font></strong></td>
             </tr>
             <?php
-            $srchmem = formVar('srchmem');
-            $srchstatus = formVar('srchstatus');
+            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE);
+            $dblikemem = $db->like_escape($srchmem);
+            $srchstatus = postedVar('srchstatus');
             if ($srchstatus == '0') {
-                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%' ORDER BY username");
+                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' ORDER BY username");
             } else if ($srchstatus == "Pending") {
                 $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE lastvisit=0 ORDER BY username");
             } else {
-                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%' AND status='$srchstatus' ORDER BY username");
+                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND status='$srchstatus' ORDER BY username");
             }
 
             $sadminselect = $adminselect = $smodselect = '';
@@ -1545,9 +1591,9 @@
                 }
                 ?>
                 <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-                <td align="center"><input type="checkbox" name="delete<?php echo $member['uid']?>" onclick="confirmActionCheckbox('<?php echo $lang['confirmDeleteUser']?>', this, true, false);" value="<?php echo $member['uid']?>" /></td>
-                <td><a href="member.php?action=viewpro&amp;member=<?php echo $member['username']?>"><?php echo $member['username']?></a>
-                <br /><a href="javascript:confirmAction('<?php echo addslashes($lang['confirmDeletePosts']);?>', 'cp.php?action=deleteposts&amp;member=<?php echo $member['username']?>', false);"><strong><?php echo $lang['cp_deleteposts']?></strong></a><?php echo $pending ?>
+                <td align="center"><input type="checkbox" name="delete<?php echo $member['uid']?>" onclick="addUserDel(<?php echo $member['uid']?>, '<?php echo $member['username']?>', this)" value="<?php echo $member['uid']?>" /></td>
+                <td><a href="member.php?action=viewpro&amp;member=<?php echo recodeOut($member['username']);?>"><?php echo $member['username']?></a>
+                <br /><a href="javascript:confirmAction('<?php echo addslashes($lang['confirmDeletePosts']);?>', 'cp.php?action=deleteposts&amp;member=<?php echo recodeJavaOut($member['username'])?>', false);"><strong><?php echo $lang['cp_deleteposts']?></strong></a><?php echo $pending ?>
                 </td>
                 <td><input type="text" size="12" name="pw<?php echo $member['uid']?>"></td>
                 <td><input type="text" size="3" name="postnum<?php echo $member['uid']?>" value="<?php echo $member['postnum']?>"></td>
@@ -1574,7 +1620,7 @@
             }
             ?>
             <tr>
-            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7"><input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="srchmem" value="<?php echo $srchmem?>" /><input type="hidden" name="srchstatus" value="<?php echo $srchstatus?>" /></td>
+            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7"><input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']?>" onclick="return confirmUserDel('<?php echo $lang['confirmDeleteUser']?>');" /><input type="hidden" name="srchmem" value="<?php echo $srchmem?>" /><input type="hidden" name="srchstatus" value="<?php echo $srchstatus?>" /></td>
             </tr>
             </table>
             </td>
@@ -1590,14 +1636,14 @@
         $sa_uid = $db->result($query, 0);
         $db->free_result($query);
 
-        $srchmem = formVar('srchmem');
-        $srchstatus = formVar('srchstatus');
+        $dblikemem = $db->like_escape(postedVar('srchmem', '', TRUE, FALSE));
+        $srchstatus = postedVar('srchstatus');
         if ($srchstatus == '0') {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%'");
+            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%'");
         } else if ($srchstatus == "Pending") {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%' AND lastvisit = 0");
+            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND lastvisit = 0");
         } else {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%' AND status='$srchstatus'");
+            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND status='$srchstatus'");
         }
 
         while($mem = $db->fetch_array($query)) {
@@ -1662,7 +1708,7 @@
         <form method="post" action="cp.php?action=ipban">
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textip']?>:</font></strong></td>
@@ -1715,11 +1761,11 @@
         <?php
     } else {
         $newip = array();
-        $newip[] = trim(formInt('newip1'));
-        $newip[] = trim(formInt('newip2'));
-        $newip[] = trim(formInt('newip3'));
-        $newip[] = trim(formInt('newip4'));
-        $delete = formArray('delete');
+        $newip[] = (is_numeric(postedVar('newip1')) Or postedVar('newip1') == '*') ? trim(postedVar('newip1')) : '0' ;
+        $newip[] = (is_numeric(postedVar('newip2')) Or postedVar('newip2') == '*') ? trim(postedVar('newip2')) : '0' ;
+        $newip[] = (is_numeric(postedVar('newip3')) Or postedVar('newip3') == '*') ? trim(postedVar('newip3')) : '0' ;
+        $newip[] = (is_numeric(postedVar('newip4')) Or postedVar('newip4') == '*') ? trim(postedVar('newip4')) : '0' ;
+        $delete = postedArray('delete', 'int');
 
         if ($delete) {
             $dels = array();
@@ -1736,13 +1782,13 @@
         }
         $self['status'] = $lang['textipupdate'];
 
-        if ($newip[1] != '0' && $newip[1] != '0' && $newip[2] != '0' && $newip[3] != '0') {
+        if ($newip[0] != '0' || $newip[1] != '0' || $newip[2] != '0' || $newip[3] != '0') {
             $invalid = 0;
             for($i=0; $i<=3 && !$invalid; ++$i) {
                 if ($newip[$i] == "*") {
                     $ip[$i+1] = -1;
-                } else if (preg_match("#^[0-9]+$#", $newip[$i])) {
-                    $ip[$i+1] = $newip[$i];
+                } else if (intval($newip[$i]) >=0 And intval($newip[$i]) <= 255) {
+                    $ip[$i+1] = intval($newip[$i]);
                 } else {
                     $invalid = 1;
                 }
@@ -1769,16 +1815,21 @@
 }
 
 if ($action == "deleteposts") {
-    $member = getVar('member');
-    $queryd = $db->query("DELETE FROM ".X_PREFIX."posts WHERE author='$member'");
-    $queryt = $db->query("SELECT * FROM ".X_PREFIX."threads");
-    while($threads = $db->fetch_array($queryt)) {
-        $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."posts WHERE tid='$threads[tid]'");
-        $replynum = $db->result($query, 0);
-        $replynum--;
-        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$threads[tid]'");
-        $db->query("DELETE FROM ".X_PREFIX."threads WHERE author='$member'");
+    $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
+    $countquery = $db->query("SELECT tid, COUNT(*) AS postcount FROM ".X_PREFIX."posts WHERE author='$member' GROUP BY tid");
+    //Critical: Do not alias tables in the next query.  MySQL 4.0 and MySQL 4.1 use mutually incompatible syntax.
+    $db->query("DELETE ".X_PREFIX."attachments, ".X_PREFIX."posts FROM ".X_PREFIX."posts LEFT JOIN ".X_PREFIX."attachments USING(pid) WHERE author='$member'");
+    $db->query("UPDATE ".X_PREFIX."members SET postnum = 0 WHERE username='$member'");
+    while($threads = $db->fetch_array($countquery)) {
+        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-{$threads['postcount']} WHERE tid='{$threads['tid']}'");
     }
+    $countquery = $db->query("SELECT t.tid, COUNT(p.pid) AS postcount FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."posts AS p USING (tid) WHERE t.author='$member' GROUP BY t.tid");
+    while($threads = $db->fetch_array($countquery)) {
+        if ($threads['postcount'] == 0) { //This will also delete thread redirectors where the redirect's author is $member
+            $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='{$threads['tid']}'");
+            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='{$threads['tid']}'");
+        }
+    }
 }
 
 if ($action == "upgrade") {
@@ -1787,7 +1838,7 @@
     }
 
     if (onSubmit('upgradesubmit')) {
-        $upgrade = formVar('upgrade');
+        $upgrade = postedVar('upgrade', '', FALSE, FALSE);
         if (isset($_FILES['sql_file'])) {
             $add = get_attached_file($_FILES['sql_file'], 'on');
             if ($add !== false) {
@@ -1807,7 +1858,6 @@
         echo '</table></td></tr></table>';
 
         for($num=0;$num<$count;$num++) {
-            $explode[$num] = stripslashes($explode[$num]);
             if ($allow_spec_q !== true) {
                 if (strtoupper(substr(trim($explode[$num]), 0, 3)) == 'USE' || strtoupper(substr(trim($explode[$num]), 0, 14)) == 'SHOW DATABASES') {
                     error($lang['textillegalquery'], false, '</td></tr></table></td></tr></table><br />');
@@ -1815,40 +1865,41 @@
             }
 
             if ($explode[$num] != '') {
-                $query = $db->query($explode[$num], true);
+                $query = $db->query($explode[$num]." -- Injected by $xmbuser using cp.php", true);
+
+                echo '<br />';
+                ?>
+                <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
+                <tr>
+                <td bgcolor="<?php echo $bordercolor?>">
+                <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+                <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
+                <td colspan="<?php echo $db->num_fields($query)?>"><strong><?php echo $lang['upgraderesults']?></strong>&nbsp;<?php echo $explode[$num]?>
+                <?php
+                $xn = strtoupper($explode[$num]);
+                if (strpos($xn, 'SELECT') !== false || strpos($xn, 'SHOW') !== false || strpos($xn, 'EXPLAIN') !== false || strpos($xn, 'DESCRIBE') !== false) {
+                    dump_query($query, true);
+                } else {
+                    $selq=false;
+                }
+                ?>
+                </td>
+                </tr>
+                </td>
+                </tr>
+                </table>
+                </td>
+                </tr>
+                </table>
+                <?php
             }
-            echo '<br />';
-            ?>
-            <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
-            <tr>
-            <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
-            <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-            <td colspan="<?php echo $db->num_fields($query)?>"><strong><?php echo $lang['upgraderesults']?></strong>&nbsp;<?php echo $explode[$num]?>
-            <?php
-            $xn = strtoupper($explode[$num]);
-            if (strpos($xn, 'SELECT') !== false || strpos($xn, 'SHOW') !== false || strpos($xn, 'EXPLAIN') !== false || strpos($xn, 'DESCRIBE') !== false) {
-                dump_query($query, true);
-            } else {
-                $selq=false;
-            }
-            ?>
-            </td>
-            </tr>
-            </td>
-            </tr>
-            </table>
-            </td>
-            </tr>
-            </table>
-            <?php
         }
         ?>
         <br />
         <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['upgradesuccess']?></td>
         </tr>
@@ -1868,7 +1919,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="tablerow" bgcolor="<?php echo $altbg1?>" colspan="2"><strong><?php echo $lang['textupgrade']?></strong></td>
         </tr>
@@ -1900,18 +1951,18 @@
 
 if ($action == "search") {
     if (onSubmit('searchsubmit')) {
-        $userip = formVar('userip');
-        $postip = formVar('postip');
-        $profileword = formVar('profileword');
-        $postword = formVar('postword');
+        $userip = postedVar('userip');
+        $postip = postedVar('postip');
+        $dblikeprofile = $db->like_escape(postedVar('profileword', '', TRUE, FALSE));
+        $dblikepost = $db->like_escape(postedVar('postword', '', TRUE, FALSE));
 
         $found = 0;
         $list = array();
         if ($userip) {
             $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE regip = '$userip'");
             while($users = $db->fetch_array($query)) {
-                $link = "./member.php?action=viewpro&amp;member=$users[username]";
-                $list[] = "<a href = \"$link\">$users[username]<br />";
+                $link = "./member.php?action=viewpro&amp;member=".recodeOut($users['username']);
+                $list[] = "<a href = \"$link\">{$users['username']}<br />";
                 $found++;
             }
         }
@@ -1921,7 +1972,7 @@
             while($users = $db->fetch_array($query)) {
                 $link = "./viewthread.php?tid=$users[tid]#pid$users[pid]";
                 if (!empty($users['subject'])) {
-                    $list[] = '<a href="$link">'.$users['subject'].'<br />';
+                    $list[] = '<a href="'.$link.'">'.rawHTMLsubject(stripslashes($users['subject'])).'<br />';
                 } else {
                     $list[] = "<a href = \"$link\">- - No subject - -<br />";
                 }
@@ -1929,23 +1980,23 @@
             }
         }
 
-        if ($profileword) {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE bio = '%$profileword%'");
+        if ($dblikeprofile != '') {
+            $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE bio LIKE '%$dblikeprofile%'");
             while($users = $db->fetch_array($query)) {
-                $link = "./member.php?action=viewpro&amp;member=$users[username]";
-                $list[] = "<a href = \"$link\">$users[username]<br />";
+                $link = "./member.php?action=viewpro&amp;member=".recodeOut($users['username']);
+                $list[] = "<a href = \"$link\">{$users['username']}<br />";
                 $found++;
             }
         }
 
-        if ($postword) {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE subject LIKE '%".$postword."%' OR message LIKE '%".$postword."%'");
+        if ($dblikepost != '') {
+            $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE subject LIKE '%$dblikepost%' OR message LIKE '%$dblikepost%'");
             while($users = $db->fetch_array($query)) {
                 $link = "./viewthread.php?tid=$users[tid]#pid$users[pid]";
                 if (!empty($users['subject'])) {
-                    $list[] = '<a href="$link">'.$users['subject'].'<br />';
+                    $list[] = '<a href="'.$link.'">'.rawHTMLsubject(stripslashes($users['subject'])).'<br />';
                 } else {
-                    $list[] = '<a href="$link">- - No subject - -<br />';
+                    $list[] = '<a href="'.$link.'">- - No subject - -<br />';
                 }
                 $found++;
             }
@@ -1965,7 +2016,7 @@
             <strong><?php echo ($num+1)?>.</strong>
             </td>
             <td align="left" width="95%" bgcolor="<?php echo $altbg1?>">
-            <?php echo html_entity_decode(stripslashes($val))?>
+            <?php echo stripslashes($val); ?>
             </td>
             </tr>
             <?php
@@ -1978,7 +2029,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan=2><strong><font color="<?php echo $cattext?>"><?php echo $lang['insertdata']?>:</font></strong></td>
         </tr>
@@ -2015,4 +2066,4 @@
 echo '</table></td></tr></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
+?>
\ No newline at end of file
Index: cp2.php
===================================================================
--- cp2.php	(revision 1095)
+++ cp2.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,19 +26,20 @@
  *
  **/
 
+define('X_SCRIPT', 'cp2.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
 loadtemplates('error_nologinsession');
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if (X_ADMIN) {
-    $download = formVar('download');
-    if ($action == "templates" && $download) {
+    if ($action == 'templates' && onSubmit('download')) {
         $code = '';
-        $templates  = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name ASC");
+        $templates = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name ASC");
         while($template = $db->fetch_array($templates)) {
             $template['template'] = trim($template['template']);
             $template['name'] = trim($template['name']);
@@ -57,7 +58,7 @@
         exit();
     }
 
-    $download = getVar('download');
+    $download = getInt('download');
     if ($action == "themes" && $download) {
         $contents = array();
         $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$download'");
@@ -81,7 +82,7 @@
 echo '<script language="JavaScript" type="text/javascript" src="./js/admin.js"></script>';
 
 if (!X_ADMIN) {
-    eval('echo stripslashes("'.template('error_nologinsession').'");');
+    eval('echo "'.template('error_nologinsession').'";');
     end_time();
     eval('echo "'.template('footer').'";');
     exit();
@@ -106,7 +107,7 @@
         <table align="center" border="0" cellspacing="0" cellpadding="0" width="80%">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><span class="smalltxt"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></span></td>
         <td><span class="smalltxt"><strong><font color="<?php echo $cattext?>"><?php echo $lang['restrictedname']?></font></strong></span></td>
@@ -161,7 +162,7 @@
         </tr>
         <tr>
         <td><span class="smalltxt">case-sensitive:</span></td>
-        <td><input type="checkbox" name="newcase" value="1" checked="unchecked" /></td>
+        <td><input type="checkbox" name="newcase" value="1" /></td>
         </tr>
         <tr>
         <td><span class="smalltxt">partial-match:</span></td>
@@ -182,39 +183,31 @@
     } else {
         $queryrestricted = $db->query("SELECT id FROM ".X_PREFIX."restricted");
         while($restricted = $db->fetch_array($queryrestricted)) {
-            $name = isset(${'name'.$restricted['id']}) && !empty(${'name'.$restricted['id']}) ? ${'name'.$restricted['id']} : '';
-            $delete = formInt('delete'.$restricted['id']);
-            $case = formInt('case'.$restricted['id']);
-            $partial = formInt('partial'.$restricted['id']);
-            $newname = isset($newname) && !empty($newname) ? $newname : '';
-            $newcase = formInt('newcase');
-            $newpartial = formInt('newpartial');
-
+            $name = postedVar('name'.$restricted['id'], '', FALSE, TRUE);
+            $delete = getInt('delete'.$restricted['id'], 'p');
+            $case = getInt('case'.$restricted['id'], 'p');
+            $partial = getInt('partial'.$restricted['id'], 'p');
             if ($partial) {
                 $partial = 1;
             }
-
             if ($case) {
                 $case = 1;
             }
-
             if ($delete) {
                 $db->query("DELETE FROM ".X_PREFIX."restricted WHERE id=$delete");
-                continue;
+            } else {
+                $db->query("UPDATE ".X_PREFIX."restricted SET name='$name', case_sensitivity='$case', partial='$partial' WHERE id=".$restricted['id']);
             }
-            $db->query("UPDATE ".X_PREFIX."restricted SET name='$name', case_sensitivity='$case', partial='$partial' WHERE id=".$restricted['id']);
         }
 
+        $newname = postedVar('newname', '', FALSE, TRUE);
+        $newcase = getInt('newcase', 'p');
+        $newpartial = getInt('newpartial', 'p');
         if (!empty($newname)) {
-            if (!$newpartial || $newpartial != 1) {
-                $newpartial = 0;
-            } else {
+            if ($newpartial) {
                 $newpartial = 1;
             }
-
-            if (!$newcase || $newcase != 1) {
-                $newcase = 0;
-            } else {
+            if ($newcase) {
                 $newcase = 1;
             }
             $db->query("INSERT INTO ".X_PREFIX."restricted (`name`, `case_sensitivity`, `partial`) VALUES ('$newname', '$newcase', '$newpartial')");
@@ -225,10 +218,12 @@
 }
 
 if ($action == 'themes') {
-    $single = getVar('single');
-    $newtheme = formVar('newtheme');
+    $single = '';
+    $single_str = postedVar('single', '', FALSE, FALSE, FALSE, 'g');
+    $single_int = getInt('single');
+    $newtheme = postedVar('newtheme');
 
-    if (noSubmit('themesubmit') && !$single && noSubmit('importsubmit')) {
+    if (noSubmit('themesubmit') && $single_str == '' && noSubmit('importsubmit')) {
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td>
@@ -236,7 +231,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textthemename']?></font></strong></td>
@@ -258,7 +253,7 @@
 
             if ($themeinfo['themeid'] == $SETTINGS['theme']) {
                 $members = ($themeMem[$themeid]+$themeMem[0]);
-            } else{
+            } else {
                 $members = $themeMem[$themeid];
             }
 
@@ -319,7 +314,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="header">
         <td colspan="2"><?php echo $lang['textimporttheme']?></td>
         </tr>
@@ -359,7 +354,7 @@
         $keysql = implode(', ', $keysql);
         $valsql = implode(', ', $valsql);
 
-        $query = $db->query("SELECT count(themeid) FROM ".X_PREFIX."themes WHERE name='".addslashes($name)."'");
+        $query = $db->query("SELECT COUNT(themeid) FROM ".X_PREFIX."themes WHERE name='".addslashes($name)."'");
         if ($db->result($query, 0) > 0) {
             error($lang['theme_already_exists'], false, '</td></tr></table></td></tr></table>');
         }
@@ -403,9 +398,10 @@
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
     }
 
-    if ($single && $single != "submit" && $single != "anewtheme1") {
-        $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$single'");
+    if ($single_int > 0) {
+        $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$single_int'");
         $themestuff = $db->fetch_array($query);
+        $db->free_result($query);
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td>
@@ -413,7 +409,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['texthemename']?></td>
         <td colspan="2"><input type="text" name="namenew" value="<?php echo $themestuff['name']?>" /></td>
@@ -511,7 +507,7 @@
         <td colspan="2"><input type="text"  value="<?php echo $themestuff['smdir']?>" name="smdirnew" /></td>
         </tr>
         <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="3"><input type="submit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="orig" value="<?php echo $single?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="3"><input type="submit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="orig" value="<?php echo $single_int?>" /></td>
         </tr>
         </table>
         </td>
@@ -521,7 +517,7 @@
         </td>
         </tr>
         <?php
-    } else if ($single && $single == "anewtheme1") {
+    } else if ($single_str == "anewtheme1") {
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -529,7 +525,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['texthemename']?></td>
         <td><input type="text" name="namenew" /></td>
@@ -614,8 +610,8 @@
         <td><?php echo $lang['smdir']?></td>
         <td><input type="text" name="smdirnew" value="images" /></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="2"><input class="submit" type="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="newtheme" value="<?php echo $single?>" /></td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="newtheme" value="true" /></td>
         </tr>
         </table>
         </td>
@@ -625,53 +621,53 @@
         </td>
         </tr>
         <?php
-    } else if ($single && $single == "submit" && !$newtheme) {
-        $namenew = formVar('namenew');
-        $bgcolornew = formVar('bgcolornew');
-        $altbg1new = formVar('altbg1new');
-        $altbg2new = formVar('altbg2new');
-        $linknew = formVar('linknew');
-        $bordercolornew = formVar('bordercolornew');
-        $headernew = formVar('headernew');
-        $headertextnew = formVar('headertextnew');
-        $topnew = formVar('topnew');
-        $catcolornew = formVar('catcolornew');
-        $cattextnew = formVar('cattextnew');
-        $tabletextnew = formVar('tabletextnew');
-        $textnew = formVar('textnew');
-        $borderwidthnew = formVar('borderwidthnew');
-        $tablewidthnew = formVar('tablewidthnew');
-        $tablespacenew = formVar('tablespacenew');
-        $fnew = formVar('fnew');
-        $fsizenew = formVar('fsizenew');
-        $boardlogonew = formVar('boardlogonew');
-        $imgdirnew = formVar('imgdirnew');
-        $smdirnew = formVar('smdirnew');
+    } else if ($single_str == "submit" && !$newtheme) {
+        $namenew = postedVar('namenew');
+        $bgcolornew = postedVar('bgcolornew');
+        $altbg1new = postedVar('altbg1new');
+        $altbg2new = postedVar('altbg2new');
+        $linknew = postedVar('linknew');
+        $bordercolornew = postedVar('bordercolornew');
+        $headernew = postedVar('headernew');
+        $headertextnew = postedVar('headertextnew');
+        $topnew = postedVar('topnew');
+        $catcolornew = postedVar('catcolornew');
+        $cattextnew = postedVar('cattextnew');
+        $tabletextnew = postedVar('tabletextnew');
+        $textnew = postedVar('textnew');
+        $borderwidthnew = postedVar('borderwidthnew');
+        $tablewidthnew = postedVar('tablewidthnew');
+        $tablespacenew = postedVar('tablespacenew');
+        $fnew = postedVar('fnew');
+        $fsizenew = postedVar('fsizenew');
+        $boardlogonew = postedVar('boardlogonew');
+        $imgdirnew = postedVar('imgdirnew');
+        $smdirnew = postedVar('smdirnew');
 
         $db->query("UPDATE ".X_PREFIX."themes SET name='$namenew', bgcolor='$bgcolornew', altbg1='$altbg1new', altbg2='$altbg2new', link='$linknew', bordercolor='$bordercolornew', header='$headernew', headertext='$headertextnew', top='$topnew', catcolor='$catcolornew', tabletext='$tabletextnew', text='$textnew', borderwidth='$borderwidthnew', tablewidth='$tablewidthnew', tablespace='$tablespacenew', fontsize='$fsizenew', font='$fnew', boardimg='$boardlogonew', imgdir='$imgdirnew', smdir='$smdirnew', cattext='$cattextnew' WHERE themeid='$orig'");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
-    } else if ($single && $single == "submit" && $newtheme) {
-        $namenew = formVar('namenew');
-        $bgcolornew = formVar('bgcolornew');
-        $altbg1new = formVar('altbg1new');
-        $altbg2new = formVar('altbg2new');
-        $linknew = formVar('linknew');
-        $bordercolornew = formVar('bordercolornew');
-        $headernew = formVar('headernew');
-        $headertextnew = formVar('headertextnew');
-        $topnew = formVar('topnew');
-        $catcolornew = formVar('catcolornew');
-        $cattextnew = formVar('cattextnew');
-        $tabletextnew = formVar('tabletextnew');
-        $textnew = formVar('textnew');
-        $borderwidthnew = formVar('borderwidthnew');
-        $tablewidthnew = formVar('tablewidthnew');
-        $tablespacenew = formVar('tablespacenew');
-        $fnew = formVar('fnew');
-        $fsizenew = formVar('fsizenew');
-        $boardlogonew = formVar('boardlogonew');
-        $imgdirnew = formVar('imgdirnew');
-        $smdirnew = formVar('smdirnew');
+    } else if ($single_str == "submit" && $newtheme) {
+        $namenew = postedVar('namenew');
+        $bgcolornew = postedVar('bgcolornew');
+        $altbg1new = postedVar('altbg1new');
+        $altbg2new = postedVar('altbg2new');
+        $linknew = postedVar('linknew');
+        $bordercolornew = postedVar('bordercolornew');
+        $headernew = postedVar('headernew');
+        $headertextnew = postedVar('headertextnew');
+        $topnew = postedVar('topnew');
+        $catcolornew = postedVar('catcolornew');
+        $cattextnew = postedVar('cattextnew');
+        $tabletextnew = postedVar('tabletextnew');
+        $textnew = postedVar('textnew');
+        $borderwidthnew = postedVar('borderwidthnew');
+        $tablewidthnew = postedVar('tablewidthnew');
+        $tablespacenew = postedVar('tablespacenew');
+        $fnew = postedVar('fnew');
+        $fsizenew = postedVar('fsizenew');
+        $boardlogonew = postedVar('boardlogonew');
+        $imgdirnew = postedVar('imgdirnew');
+        $smdirnew = postedVar('smdirnew');
 
         $db->query("INSERT INTO ".X_PREFIX."themes (name, bgcolor, altbg1, altbg2, link, bordercolor, header, headertext, top, catcolor, tabletext, text, borderwidth, tablewidth, tablespace, font, fontsize, boardimg, imgdir, smdir, cattext) VALUES('$namenew', '$bgcolornew', '$altbg1new', '$altbg2new', '$linknew', '$bordercolornew', '$headernew', '$headertextnew', '$topnew', '$catcolornew', '$tabletextnew', '$textnew', '$borderwidthnew', '$tablewidthnew', '$tablespacenew', '$fnew', '$fsizenew', '$boardlogonew', '$imgdirnew', '$smdirnew', '$cattextnew')");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
@@ -687,7 +683,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="4" align="left"><font color="<?php echo $cattext?>"><strong><?php echo $lang['smilies']?></strong></font></td>
         </tr>
@@ -773,14 +769,14 @@
         $smcode = formArray('smcode');
         $smurl = formArray('smurl');
 
-        $newcode = formVar('newcode');
-        $newurl1 = formVar('newurl1');
+        $newcode = postedVar('newcode');
+        $newurl1 = postedVar('newurl1');
         $autoinsertsmilies = formInt('autoinsertsmilies');
 
         $pidelete = formArray('pidelete');
         $piurl = formArray('piurl');
 
-        $newurl2 = formVar('newurl2');
+        $newurl2 = postedVar('newurl2');
         $autoinsertposticons = formInt('autoinsertposticons');
 
         if ($smcode) {
@@ -899,7 +895,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="450" align="center">
         <tr>
         <td style="background-color: <?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td width="4%" align="center"><font style="color: <?php echo $cattext?>"><strong><?php echo $lang['textdeleteques']?></strong></font></td>
         <td align="left"><font style="color: <?php echo $cattext?>"><strong><?php echo $lang['textcensorfind']?></strong></font></td>
@@ -940,14 +936,16 @@
     }
 
     if (onSubmit('censorsubmit')) {
+        $newfind = postedVar('newfind', 'javascript');
+        $newreplace = postedVar('newreplace', 'javascript');
         $querycensor = $db->query("SELECT id FROM ".X_PREFIX."words");
         while($censor = $db->fetch_array($querycensor)) {
-            $find = formVar('find'.$censor['id']);
-            $replace = formVar('replace'.$censor['id']);
-            $delete = formVar('delete'.$censor['id']);
+            $find = postedVar('find'.$censor['id']);
+            $replace = postedVar('replace'.$censor['id']);
+            $delete = formInt('delete'.$censor['id']);
 
             if ($delete) {
-                $db->query("DELETE FROM ".X_PREFIX."words WHERE id='$delete'");
+                $db->query("DELETE FROM ".X_PREFIX."words WHERE id=$delete");
             }
 
             if ($find) {
@@ -972,7 +970,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="650" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td class="category" align="left"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textcusstatus']?></font></strong></td>
@@ -1040,11 +1038,11 @@
         $stars = formArray('stars');
         $allowavatars = formArray('allowavatars');
         $avaurl = formArray('avaurl');
-        $newtitle = formVar('newtitle');
+        $newtitle = postedVar('newtitle');
         $newposts = formInt('newposts');
         $newstars = formInt('newstars');
-        $newallowavatars = formOnOff('newallowavatars');
-        $newavaurl = formVar('newavaurl');
+        $newallowavatars = formYesNo('newallowavatars');
+        $newavaurl = postedVar('newavaurl');
 
         $query = $db->query("SELECT * FROM ".X_PREFIX."ranks");
         $staffranks = array();
@@ -1087,7 +1085,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan="2"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textnewsletter']?></font></strong></td>
         </tr>
@@ -1141,10 +1139,10 @@
         <?php
     } else {
         @set_time_limit(0);
-        $newssubject = addslashes(formVar('newssubject'));
-        $newsmessage = addslashes(formVar('newsmessage'));
-        $sendvia = formVar('sendvia');
-        $to = formVar('to');
+        $newssubject = postedVar('newssubject');
+        $newsmessage = postedVar('newsmessage');
+        $sendvia = postedVar('sendvia', '', FALSE, FALSE);
+        $to = postedVar('to', '', FALSE, FALSE);
         $newscopy = formYesNo('newscopy');
         $wait = formInt('wait');
 
@@ -1166,11 +1164,9 @@
             $query = $db->query("SELECT username, email FROM ".X_PREFIX."members WHERE status='Moderator' ORDER BY uid");
         }
 
-        $_xmbuser = addslashes($xmbuser);
-
         if ($sendvia == "u2u") {
             while($memnews = $db->fetch_array($query)) {
-                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus ) VALUES ('".addslashes($memnews['username'])."', '".$_xmbuser."', 'incoming', '".addslashes($memnews['username'])."', 'Inbox', '$newssubject', '$newsmessage', '" . time() . "', 'no', 'yes')");
+                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('".addslashes($memnews['username'])."', '$xmbuser', 'incoming', '".addslashes($memnews['username'])."', 'Inbox', '$newssubject', '$newsmessage', '" . time() . "', 'no', 'yes')");
             }
         } else {
             $newssubject = stripslashes(stripslashes($newssubject));
@@ -1215,7 +1211,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%" style="vertical-align: top;">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%" style="vertical-align: top;">
         <tr>
         <td class="category" colspan="2">
         <strong>
@@ -1233,20 +1229,20 @@
         <table>
         <tr>
         <td>
-        <input type="checkbox" name="pruneBy[date][check]" value="1" />
+        <input type="checkbox" name="pruneByDate[check]" value="1" checked="checked" />
         </td>
         <td>
-        <select name="pruneBy[date][type]">
+        <select name="pruneByDate[type]">
         <option value="more"><?php echo $lang['prunemorethan']?></option>
         <option value="is"><?php echo $lang['pruneexactly']?></option>
         <option value="less"><?php echo $lang['prunelessthan']?></option>
         </select>
-        <input type="text" name="pruneBy[date][date]" value="10" /> <?php echo $lang['daysold']?>
+        <input type="text" name="pruneByDate[date]" value="100" /> <?php echo $lang['daysold']?>
         </td>
         </tr>
         <tr>
         <td>
-        <input type="checkbox" name="pruneBy[posts][check]" value="1" />
+        <input type="checkbox" name="pruneByPosts[check]" value="1" />
         </td>
         <td>
         <select name="pruneBy[posts][type]">
@@ -1254,7 +1250,7 @@
         <option value="is"><?php echo $lang['pruneexactly']?></option>
         <option value="less"><?php echo $lang['prunelessthan']?></option>
         </select>
-        <input type="text" name="pruneBy[posts][posts]" value="10" /> <?php echo $lang['memposts']?>
+        <input type="text" name="pruneByPosts[posts]" value="10" /> <?php echo $lang['memposts']?>
         </td>
         </tr>
         </table>
@@ -1268,7 +1264,7 @@
         <table>
         <tr>
         <td>
-        <input type="radio" name="pruneFrom" value="all" checked="checked" />
+        <input type="radio" name="pruneFrom" value="all" />
         </td>
         <td>
         <?php echo $lang['textallforumsandsubs']?>
@@ -1284,7 +1280,7 @@
         </tr>
         <tr>
         <td>
-        <input type="radio" name="pruneFrom" value="fid" />
+        <input type="radio" name="pruneFrom" value="fid" checked="checked" />
         </td>
         <td>
         <?php echo $lang['prunefids']?> <input type="text" name="pruneFromFid" /> <span class="smalltxt">(<?php echo $lang['seperatebycomma']?>)</span>
@@ -1315,10 +1311,11 @@
         </tr>
         <?php
     } else {
-        $pruneBy = formArray('pruneBy');
-        $pruneFrom = formVar('pruneFrom');
-        $pruneFromList = formArray('pruneFromList');
-        $pruneFromFid = formVar('pruneFromFid');
+        $pruneByDate = formArray('pruneByDate');
+        $pruneByPosts = formArray('pruneByPosts');
+        $pruneFrom = postedVar('pruneFrom', '', FALSE, FALSE);
+        $pruneFromList = postedArray('pruneFromList', 'int');
+        $pruneFromFid = postedVar('pruneFromFid', '', FALSE, FALSE);
         $pruneType = formArray('pruneType');
 
         $queryWhere = array();
@@ -1329,7 +1326,9 @@
             case 'list':
                 $fs = array();
                 foreach($pruneFromList as $fid) {
-                    $fs[] = (int) trim($fid);
+                    if ($fid > 0) {
+                        $fs[] = $fid;
+                    }
                 }
                 $fs = array_unique($fs);
                 if (count($fs) < 1) {
@@ -1341,7 +1340,9 @@
                 $fs = array();
                 $fids = explode(',', $pruneFromFid);
                 foreach($fids as $fid) {
-                    $fs[] = (int) trim($fid);
+                    if ($fid > 0) {
+                        $fs[] = $fid;
+                    }
                 }
                 $fs = array_unique($fs);
                 if (count($fs) < 1) {
@@ -1353,9 +1354,9 @@
                 error($lang['nopruneforums'], false, '</td></tr></table></td></tr></table><br />');
         }
 
-        if (isset($pruneBy['posts']['check']) && $pruneBy['posts']['check'] == 1) {
-            $sign = '';
-            switch($pruneBy['posts']['type']) {
+        $sign = '';
+        if (isset($pruneByPosts['check']) && $pruneByPosts['check'] == "1") {
+            switch($pruneByPosts['type']) {
                 case 'less':
                     $sign = '<';
                     break;
@@ -1367,23 +1368,24 @@
                     $sign = '>';
                     break;
             }
-            $queryWhere[] = 'replies '.$sign.' '.(int) ($pruneBy['posts']['posts']-1);
+            $queryWhere[] = 'replies '.$sign.' '.(int) ($pruneByPosts['posts']-1);
         }
 
-        if (isset($pruneBy['date']['check']) && $pruneBy['date']['check'] == 1) {
-            $sign = '';
-            switch($pruneBy['date']['type']) {
+        if (isset($pruneByDate['check']) && $pruneByDate['check'] == 1) {
+            switch($pruneByDate['type']) {
                 case 'less':
-                    $queryWhere[] = 'lastpost >= '.(time()-(24*3600*$pruneBy['date']['date']));
+                    $queryWhere[] = 'lastpost >= '.(time()-(24*3600*$pruneByDate['date']));
                     break;
                 case 'is':
-                    $queryWhere[] = 'lastpost >= '.(time()-(24*3600*($pruneBy['date']['date']-1))).' AND lastpost <= '.(time()-(24*3600*($pruneBy['date']['date'])));
+                    $queryWhere[] = 'lastpost >= '.(time()-(24*3600*($pruneByDate['date']-1))).' AND lastpost <= '.(time()-(24*3600*($pruneByDate['date'])));
                     break;
                 case 'more':
                 default:
-                    $queryWhere[] = 'lastpost <= '.(time()-(24*3600*$pruneBy['date']['date']));
+                    $queryWhere[] = 'lastpost <= '.(time()-(24*3600*$pruneByDate['date']));
                     break;
             }
+        } else if ($sign == '') {
+            $queryWhere[] = '1=0'; //Neither 'prune by' option was set, prune should abort.
         }
 
         if (!isset($pruneType['closed']) || $pruneType['closed'] != 1) {
@@ -1407,9 +1409,9 @@
                     $tids[] = $t['tid'];
                 }
                 $tids = implode(',', $tids);
-                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid IN($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN ($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN ($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid IN ($tids)");
             }
         } else {
             $db->query("TRUNCATE TABLE ".X_PREFIX."threads");
@@ -1430,7 +1432,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="80%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1444,20 +1446,21 @@
         <td bgcolor="<?php echo $altbg2?>" class="tablerow">
         <?php
         $query = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name");
-        echo "<select name=\"tid\"><option value=\"default\">$lang[selecttemplate]</option>";
+        echo '<select name="tid"><option value="default">'.$lang['selecttemplate'].'</option>';
         while($template = $db->fetch_array($query)) {
             if (!empty($template['name'])) {
-                echo "<option value=\"$template[id]\">$template[name]</option>\r\n";
+                echo '<option value="'.intval($template['id']).'">'.stripslashes($template['name']).'</option>\r\n';
             }
         }
-        echo "</select>&nbsp;&nbsp;";
+        echo '</select>&nbsp;&nbsp;';
+        $db->free_result($query);
         ?>
         </td>
         </tr>
         <tr>
         <td bgcolor="<?php echo $altbg2?>" class="tablerow">
-        <input type="submit" class="submit"name="edit" value="<?php echo $lang['textedit']?>" />&nbsp;
-        <input type="submit" class="submit"name="delete" value="<?php echo $lang['deletebutton']?>" />&nbsp;
+        <input type="submit" class="submit" name="edit" value="<?php echo $lang['textedit']?>" />&nbsp;
+        <input type="submit" class="submit" name="delete" value="<?php echo $lang['deletebutton']?>" />&nbsp;
         <input type="submit" class="submit" name="restore" value="<?php echo $lang['textrestoredeftemps']?>" />&nbsp;
         <input type="submit" class="submit" name="download" value="<?php echo $lang['textdownloadtemps']?>" />
         </td>
@@ -1480,7 +1483,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1517,15 +1520,18 @@
             $template[1] = isset($template[1]) ? addslashes($template[1]) : '';
             $db->query("INSERT INTO ".X_PREFIX."templates (name, template) VALUES ('".addslashes($template[0])."', '".addslashes($template[1])."')");
         }
+
         $db->query("DELETE FROM ".X_PREFIX."templates WHERE name=''");
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesrestoredone]</td></tr>";
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesrestoredone'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('edit') && noSubmit('editsubmit')) {
-        $tid = formVar('tid');
+        $tid = postedVar('tid', '', FALSE, FALSE);
         if ($tid == 'default') {
             error($lang['selecttemplate'], false, '</td></tr></table></td></tr></table><br />');
         }
+        $tid = formInt('tid');
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1533,25 +1539,23 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
         <?php
-        $query = $db->query("SELECT * FROM ".X_PREFIX."templates WHERE id='$tid' ORDER BY name");
+        $query = $db->query("SELECT * FROM ".X_PREFIX."templates WHERE id=$tid ORDER BY name");
         $template = $db->fetch_array($query);
-        $template['template'] = stripslashes($template['template']);
-        $template['template'] = htmlspecialchars($template['template']);
+        $db->free_result($query);
         ?>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><?php echo $lang['templatename']?>&nbsp;<strong><?php echo $template['name']?></strong></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td><?php echo $lang['templatename']?>&nbsp;<strong><?php echo stripslashes($template['name'])?></strong></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
-        <textarea cols="100" rows="30" name="templatenew"><?php echo $template['template']?></textarea></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg1?>">
+        <td><textarea cols="100" rows="30" name="templatenew"><?php echo stripslashes(htmlspecialchars($template['template']))?></textarea></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></strong></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td><input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></strong></td>
         </tr>
         </table>
         </td>
@@ -1564,15 +1568,16 @@
     }
 
     if (onSubmit('editsubmit')) {
-        $tid = getVar('tid');
-        $namenew = formVar('namenew');
-        $templatenew = addslashes(getRequestVar('templatenew'));
+        $tid = postedVar('tid', '', FALSE, FALSE, FALSE, 'g');
+        $namenew = postedVar('namenew');
+        //Templates are double-slashed so that they can be eval'd as raw strings.
+        $templatenew = $db->escape(getRequestVar('templatenew'));
 
-        if ($tid == "new") {
+        if ($tid == 'new') {
             if (!$namenew) {
                 error($lang['templateempty'], false, '</td></tr></table></td></tr></table><br />');
             } else {
-                $check = $db->query("SELECT name FROM ".X_PREFIX."templates WHERE name = '$namenew'");
+                $check = $db->query("SELECT name FROM ".X_PREFIX."templates WHERE name='$namenew'");
                 if ($db->num_rows($check) != 0) {
                     error($lang['templateexists'], false, '</td></tr></table></td></tr></table><br />');
                 } else {
@@ -1580,15 +1585,18 @@
                 }
             }
         } else {
-            $db->query("UPDATE ".X_PREFIX."templates SET template='$templatenew' WHERE id='$tid'");
+            $tid = getInt('tid');
+            $db->query("UPDATE ".X_PREFIX."templates SET template='$templatenew' WHERE id=$tid");
         }
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesupdate]</td></tr>";
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesupdate'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('delete')) {
-        if ($tid == "default") {
+        if ($tid == 'default') {
             error($lang['selecttemplate'], false, '</td></tr></table></td></tr></table><br />');
         }
+        $tid = getInt('tid', 'r');
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1596,15 +1604,15 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg1?>" class="ctrtablerow"><?php echo $lang['templatedelconfirm']?></td>
+        <tr bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
+        <td><?php echo $lang['templatedelconfirm']?></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><input type="submit" class="submit" name="deletesubmit" value="<?php echo $lang['textyes']?>" /></td>
+        <tr bgcolor="<?php echo $altbg2?>" class="ctrtablerow">
+        <td><input type="submit" class="submit" name="deletesubmit" value="<?php echo $lang['textyes']?>" /></td>
         </tr>
         </table>
         </td>
@@ -1617,8 +1625,10 @@
     }
 
     if (onSubmit('deletesubmit')) {
-        $db->query("DELETE FROM ".X_PREFIX."templates WHERE id='$tid'");
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesdelete]</td></tr>";
+        $tid = getInt('tid', 'r');
+        $db->query("DELETE FROM ".X_PREFIX."templates WHERE id=$tid");
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesdelete'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('new')) {
@@ -1629,7 +1639,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1662,44 +1672,44 @@
         <form method="post" action="cp2.php?action=attachments">
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textsearch']?></font></strong></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwherename']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwherename']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="filename" size="30" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereauthor']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereauthor']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="author" size="40" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereforum']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereforum']?></td>
         <td bgcolor="<?php echo $altbg2?>"><?php echo $forumselect?></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizesmaller']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizesmaller']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="sizeless" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizegreater']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizegreater']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="sizemore" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountsmaller']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountsmaller']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="dlcountless" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountgreater']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountgreater']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="dlcountmore" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredaysold']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredaysold']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="daysold" size="20" /></td>
         </tr>
-        <tr>
-        <td align="center" class="tablerow" bgcolor="<?php echo $altbg2?>" colspan="2"><input type="submit" name="searchsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input type="submit" name="searchsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         </table>
         </td>
@@ -1712,9 +1722,9 @@
     }
 
     if (onSubmit('searchsubmit')) {
-        $filename = formVar('filename');
-        $author = formVar('author');
-        $forumprune = formVar('forumprune');
+        $dblikefilename = $db->like_escape(postedVar('filename', '', FALSE, FALSE));
+        $author = postedVar('author');
+        $forumprune = postedVar('forumprune');
         $forumprune = $forumprune == 'all' ? '' : intval($forumprune);
         $sizeless = formInt('sizeless');
         $sizemore = formInt('sizemore');
@@ -1728,7 +1738,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="6"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textattachsearchresults']?></strong></font></td>
         </tr>
@@ -1745,7 +1755,7 @@
         $orderby = '';
 
         if ($forumprune) {
-            $restriction .= "AND p.fid=$forumprune ";
+            $restriction .= "AND t.fid=$forumprune ";
         }
 
         if ($daysold) {
@@ -1759,8 +1769,8 @@
             $orderby = ' ORDER BY p.author ASC';
         }
 
-        if ($filename) {
-            $restriction .= "AND a.filename LIKE '%$filename%' ";
+        if ($dblikefilename != '') {
+            $restriction .= "AND a.filename LIKE '%$dblikefilename%' ";
         }
 
         if ($sizeless) {
@@ -1783,9 +1793,9 @@
             $orderby = ' ORDER BY a.downloads DESC ';
         }
 
-        $query = $db->query("SELECT a.*, p.*, t.tid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a, ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE a.pid=p.pid AND t.tid=a.tid AND f.fid=p.fid $restriction $orderby");
+        $query = $db->query("SELECT a.aid, a.pid, a.filename, LENGTH(a.attachment) AS rowsize, a.downloads, p.author, p.tid, t.fid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a LEFT JOIN ".X_PREFIX."posts p USING (pid) LEFT JOIN ".X_PREFIX."threads t ON t.tid=p.tid LEFT JOIN ".X_PREFIX."forums f ON f.fid=t.fid WHERE 1=1 $restriction $orderby");
         while($attachment = $db->fetch_array($query)) {
-            $attachsize = strlen($attachment['attachment']);
+            $attachsize = $attachment['rowsize'];
             if ($attachsize >= 1073741824) {
                 $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
             } else if ($attachsize >= 1048576) {
@@ -1796,9 +1806,9 @@
                 $attachsize = $attachsize . "b";
             }
 
-            $attachment['tsubject'] = html_entity_decode(stripslashes($attachment['tsubject']));
-            $attachment['fname'] = html_entity_decode(stripslashes($attachment['fname']));
-            $attachment['filename'] = stripslashes($attachment['filename']);
+            $attachment['tsubject'] = stripslashes($attachment['tsubject']); //old databases were double-slashed
+            $attachment['fname'] = stripslashes($attachment['fname']);
+            $attachment['filename'] = attrOut($attachment['filename'], 'javascript');
             ?>
             <tr>
             <td bgcolor="<?php echo $altbg1?>" class="tablerow" align="center" valign="middle"><a href="cp2.php?action=delete_attachment&amp;aid=<?php echo $attachment['aid']?>">Delete</a>
@@ -1818,14 +1828,6 @@
         </td>
         </tr>
         </table>
-        <input type="hidden" name="filename" value="<?php echo $filename?>" />
-        <input type="hidden" name="author" value="<?php echo $author?>" />
-        <input type="hidden" name="forumprune" value="<?php echo $forumprune?>" />
-        <input type="hidden" name="sizeless" value="<?php echo $sizeless?>" />
-        <input type="hidden" name="sizemore" value="<?php echo $sizemore?>" />
-        <input type="hidden" name="dlcountless" value="<?php echo $dlcountless?>" />
-        <input type="hidden" name="dlcountmore" value="<?php echo $dlcountmore?>" />
-        <input type="hidden" name="daysold" value="<?php echo $daysold?>" />
         </form>
         </td>
         </tr>
@@ -1833,55 +1835,21 @@
     }
 
     if (onSubmit('deletesubmit')) {
-        $filename1 = formVar('filename1');
-        $filename = formVar('filename');
-        $author = formVar('author');
-        $forumprune = formInt('forumprune');
-        $sizeless = formInt('sizeless');
-        $sizemore = formInt('sizemore');
-        $dlcountless = formInt('dlcountless');
-        $dlcountmore = formInt('dlcountmore');
-        $daysold = formInt('daysold');
-
-        if ($forumprune) {
-            $queryforum = "AND p.fid='$forumprune' ";
+        $filelist = '';
+        foreach($_POST as $postedname => $rawvalue) {
+            if (substr($postedname, 0, 8) == 'filename' And is_numeric($fileaid = substr($postedname, 8))) {
+                $filelist .= $fileaid.', ';
+            }
         }
+        $filelist = substr($filelist, 0, -2);
 
-        if ($daysold) {
-            $datethen = $onlinetime - (86400 * $daysold);
-            $querydate = "AND p.dateline <= '$datethen' ";
-        }
-
-        if ($author) {
-            $queryauthor = "AND p.author = '$author' ";
-        }
-
-        if ($filename) {
-            $queryname = "AND a.filename LIKE '%$filename%' ";
-        }
-
-        if ($sizeless) {
-            $querysizeless = "AND a.filesize < '$sizeless' ";
-        }
-
-        if ($sizemore) {
-            $querysizemore = "AND a.filesize > '$sizemore' ";
-        }
-
-        if ($dlcountless) {
-            $querydlcountless = "AND a.downloads < '$dlcountless' ";
-        }
-
-        if ($dlcountmore) {
-            $querydlcountmore = "AND a.downloads > '$dlcountmore' ";
-        }
-
-        $query = $db->query("SELECT a.*, p.*, t.tid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a, ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE a.pid=p.pid AND t.tid=a.tid AND f.fid=p.fid $queryforum $querydate $queryauthor $queryname $querysizeless $querysizemore");
+        $query = $db->query("SELECT a.aid, a.filename FROM ".X_PREFIX."attachments a WHERE a.aid IN ($filelist)");
         while($attachment = $db->fetch_array($query)) {
             $afilename = "filename" . $attachment['aid'];
-            $afilename = isset($_POST[$afilename]) ? $_POST[$afilename] : '';
-            if ($attachment['filename'] != $afilename) {
-                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$afilename' WHERE aid='$attachment[aid]'");
+            $postedvalue = trim(postedVar($afilename, '', FALSE, FALSE));
+            if ($attachment['filename'] != $postedvalue And isValidFilename($postedvalue)) {
+                $dbrename = $db->escape($postedvalue);
+                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$dbrename' WHERE aid={$attachment['aid']}");
             }
         }
         echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[textattachmentsupdate]</td></tr>";
@@ -1897,7 +1865,7 @@
     <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
     <tr>
     <td bgcolor="<?php echo $bordercolor?>">
-    <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+    <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
     <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
@@ -2019,7 +1987,7 @@
     <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
     <tr>
     <td bgcolor="<?php echo $bordercolor?>">
-    <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+    <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
     <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
@@ -2129,8 +2097,8 @@
 }
 
 if ($action == "delete_attachment") {
-    $aid = getInt($aid);
-    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid='$aid'");
+    $aid = getInt('aid');
+    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid=$aid");
     echo "<p align=\"center\">Deleted ...</br>";
 }
 
Index: db/mysql.php
===================================================================
--- db/mysql.php	(revision 1095)
+++ db/mysql.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -49,26 +49,19 @@
     var $timer      = 0;
 
     function connect($dbhost="localhost", $dbuser, $dbpw, $dbname, $pconnect=0, $force_db=false) {
-        $die = false;
 
         if ($pconnect) {
-            $this->link = @mysql_pconnect($dbhost, $dbuser, $dbpw) or ($die = true);
+            $this->link = @mysql_pconnect($dbhost, $dbuser, $dbpw);
         } else {
-            $this->link = @mysql_connect($dbhost, $dbuser, $dbpw) or ($die = true);
+            $this->link = @mysql_connect($dbhost, $dbuser, $dbpw);
         }
 
-        if ($die) {
+        if ($this->link == false) {
             echo '<h3>Database connection error!</h3>';
             echo 'A connection to the Database could not be established.<br />';
             echo 'Please check your username, password, database name and host.<br />';
             echo 'Also make sure <i>config.php</i> is rightly configured!<br /><br />';
-            if (defined('X_SADMIN') && X_SADMIN && defined('DEBUG') && DEBUG) {
-                $num = mysql_errno();
-                $msg = mysql_error();
-                echo 'When connecting, the database returned:<br />';
-                echo '<i><b>Error '.$num.': </b>'.$msg.'</i>';
-            }
-            exit();
+            $this->panic();
         }
 
         unset($GLOBALS['dbhost'], $GLOBALS['dbuser'], $GLOBALS['dbpw']);
@@ -138,25 +131,43 @@
         return mysql_field_name($query, $field);
     }
 
-    function implicitError($sql, $overwriteErrorPerms=false) {
-        if (($error = $this->error()) !== false) {
-            if ($overwriteErrorPerms) {
-                return $error;
+    function panic($sql = '') {
+
+        if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
+            // Check that we actually made a connection
+            if ($this->link === FALSE) {
+                $error = mysql_error();
+                $errno = mysql_errno();
             } else {
-                if ((defined('X_SADMIN') && X_SADMIN && defined('DEBUG') && DEBUG) || (!defined('X_MEMBER') && !defined('X_GUEST'))) {
-                    return 'MySQL encountered the following error: '.$error."\n<br />".'In the following query: <em>'.$sql.'</em>';
-                } else {
-                    return 'MySQL has encountered an unknown error. To find out the exact problem, please set the DEBUG flag to true in config.php.';
-                }
+                $error = mysql_error($this->link);
+                $errno = mysql_errno($this->link);
             }
+
+            echo '<pre>MySQL encountered the following error: '.cdataOut($error)."(errno = ".$errno.")\n<br />".'In the following query: <em>'.cdataOut($sql).'</em></pre>';
         } else {
-            return 'oops';
+            echo '<pre>The system has failed to process your request. If you\'re an administrator, please set the DEBUG flag to true in config.php.</pre>';
         }
+        exit;
     }
 
+    function escape($rawstring) {
+        return mysql_real_escape_string($rawstring, $this->link);
+    }
+
+    function like_escape($rawstring) {
+        return str_replace(array('%', '_'), array('\%', '\_'), mysql_real_escape_string($rawstring, $this->link));
+    }
+
+    function regexp_escape($rawstring) {
+        return mysql_real_escape_string(preg_quote($rawstring), $this->link);
+    }
+
     function query($sql, $overwriteErrorPerms=false) {
         $this->start_timer();
-        $query = mysql_query($sql, $this->link) or die($this->implicitError($sql, $overwriteErrorPerms));
+        $query = mysql_query($sql, $this->link);
+        if ($query == false) {
+            $this->panic($sql);
+        }
         $this->querynum++;
         $this->querylist[] = $sql;
         $this->querytimes[] = $this->stop_timer();
@@ -165,7 +176,10 @@
 
     function unbuffered_query($sql) {
         $this->start_timer();
-        $query = mysql_unbuffered_query($sql, $this->link) or die(mysql_error());
+        $query = mysql_unbuffered_query($sql, $this->link);
+        if ($query == false) {
+            $this->panic($sql);
+        }
         $this->querynum++;
         $this->querylist[] = $sql;
         $this->querytimes[] = $this->stop_timer();
@@ -231,6 +245,7 @@
         return $taken;
     }
 }
+
 define('SQL_NUM', MYSQL_NUM);
 define('SQL_BOTH', MYSQL_BOTH);
 define('SQL_ASSOC', MYSQL_ASSOC);
Index: editprofile.php
===================================================================
--- editprofile.php	(revision 1095)
+++ editprofile.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'editprofile.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -45,17 +47,15 @@
     error($lang['superadminonly'], false);
 }
 
-$user = getVar('user');
+$user = postedVar('user', '', TRUE, TRUE, FALSE, 'g');
 
-$userid = $db->fetch_array($db->query("SELECT uid FROM ".X_PREFIX."members WHERE username='$user'"));
-if (empty($userid['uid'])) {
+$query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$user'");
+if ($db->num_rows($query) != 1) {
     error($lang['nomember'], false);
 }
+$member = $db->fetch_array($query);
 
 if (noSubmit('editsubmit')) {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='".rawurldecode($user)."'");
-    $member = $db->fetch_array($query);
-
     $checked = '';
     if ($member['showemail'] == 'yes') {
         $checked = $cheHTML;
@@ -82,7 +82,7 @@
     }
 
     $invchecked = '';
-    if ($member['invisible'] == 1 ) {
+    if ($member['invisible'] == 1) {
         $invchecked = $cheHTML;
     }
 
@@ -109,23 +109,23 @@
 
     $langfileselect = createLangFileSelect($member['langfile']);
 
-    $day = substr($member['bday'], 8, 2);
-    $month = substr($member['bday'], 5, 2);
+    $day = intval(substr($member['bday'], 8, 2));
+    $month = intval(substr($member['bday'], 5, 2));
     $year = substr($member['bday'], 0, 4);
 
-    $sel0 = $sel1 = $sel2 = $sel3 = $sel4 = $sel5 = $sel6 = '';
-    $sel7 = $sel8 = $sel9 = $sel10 = $sel11 = $sel12 = '';
+    for($i = 0; $i <= 12; $i++) {
+        $sel[$i] = '';
+    }
+    $sel[$month] = $selHTML;
 
-    ${'sel'.(int)$month} = $selHTML;
-
     $dayselect = array();
     $dayselect[] = '<select name="day">';
     $dayselect[] = '<option value="">&nbsp;</option>';
     for($num = 1; $num <= 31; $num++) {
         if ($day == $num) {
-            $dayselect[] = '<option value='.$num.'" '.$selHTML.'>'.$num.'</option>';
+            $dayselect[] = '<option value="'.$num.'" '.$selHTML.'>'.$num.'</option>';
         } else {
-            $dayselect[] = '<option value='.$num.'">'.$num.'</option>';
+            $dayselect[] = '<option value="'.$num.'">'.$num.'</option>';
         }
     }
     $dayselect[] = '</select>';
@@ -169,41 +169,40 @@
         closedir($dir1);
     }
 
-    $lang['searchusermsg'] = str_replace('*USER*', $user, $lang['searchusermsg']);
+    $lang['searchusermsg'] = str_replace('*USER*', $member['username'], $lang['searchusermsg']);
 
     $member['icq'] = ($member['icq'] > 0) ? $member['icq'] : '';
 
-    eval('echo stripslashes("'.template('admintool_editprofile').'");');
-} else {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$user'");
-    $member = $db->fetch_array($query);
+    $userrecode = recodeOut($member['username']);
 
-    if (!$member['username']) {
-        error($lang['badname'], false);
-    }
-
-    $langfilenew = getLangFileNameFromHash(formVar('langfilenew'));
-    $fileNameHash = getLangFileNameFromHash($langfilenew);
-    if ($fileNameHash === false) {
+    eval('echo "'.template('admintool_editprofile').'";');
+} else {
+    $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
+    $langfilenew = getLangFileNameFromHash($langfilenew);
+    if ($langfilenew === false) {
         $langfilenew = $SETTINGS['langfile'];
     } else {
-        $langfilenew = basename($fileNameHash);
+        $langfilenew = basename($langfilenew);
     }
+    $langfilenew = $db->escape($langfilenew);
 
-    $timeoffset1 = formInt('timeoffset1');
+    $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
     $thememem = formInt('thememem');
     $tppnew = isset($_POST['tppnew']) ? (int) $_POST['tppnew'] : $SETTINGS['topicperpage'];
     $pppnew = isset($_POST['pppnew']) ? (int) $_POST['pppnew'] : $SETTINGS['postperpage'];
 
-    $dateformatnew = formVar('dateformatnew');
-    if (strlen($dateformatnew) == 0) {
+    $dateformatnew = postedVar('dateformatnew', '', FALSE, TRUE);
+    $dateformattest = attrOut($dateformatnew, 'javascript');  // NEVER allow attribute-special data in the date format because it can be unescaped using the date() parser.
+    if (strlen($dateformatnew) == 0 Or $dateformatnew != $dateformattest) {
         $dateformatnew = $SETTINGS['dateformat'];
-    } else {
-        $dateformatnew = isset($dateformatnew) ? checkInput($dateformatnew, '', '', 'script', true) : $SETTINGS['dateformat'];
     }
+    unset($dateformattest);
 
     $timeformatnew = formInt('timeformatnew');
-    $timeformatnew = $timeformatnew ? checkInput($timeformatnew, '', '', 'script', true) : $SETTINGS['timeformat'];
+    if ($timeformatnew != 12 And $timeformatnew != 24) {
+        $timeformatnew = $SETTINGS['timeformat'];
+    }
+
     $saveogu2u = formYesNo('saveogu2u');
     $emailonu2u = formYesNo('emailonu2u');
     $useoldu2u = formYesNo('useoldu2u');
@@ -214,50 +213,36 @@
     $month = formInt('month');
     $day = formInt('day');
     $bday = iso8601_date($year, $month, $day);
-    $newavatar = formVar('newavatar');
-    $avatar = $newavatar ? checkInput($newavatar, 'no', 'no', 'javascript', false) : '';
-    $newlocation = formVar('newlocation');
-    $location = $newlocation ? checkInput($newlocation, 'no', 'no', 'javascript', false) : '';
-    $newicq = formVar('newicq');
-    $icq = ($newicq && is_numeric($newicq) && $newicq > 0) ? $newicq : 0;
-    $newyahoo = formVar('newyahoo');
-    $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'no', 'javascript', false) : '';
-    $newaim = formVar('newaim');
-    $aim = $newaim ? checkInput($newaim, 'no', 'no', 'javascript', false) : '';
-    $newmsn = formVar('newmsn');
-    $msn = $newmsn ? checkInput($newmsn, 'no', 'no', 'javascript', false) : '';
-    $newemail = formVar('newemail');
-    $email = $newemail ? checkInput($newemail, 'no', 'no', 'javascript', false) : '';
-    $newsite = formVar('newsite');
-    $site = $newsite ? checkInput($newsite, 'no', 'no', 'javascript', false) : '';
-    $bio = isset($_POST['newbio']) ? checkInput($_POST['newbio'], 'no', 'no', 'javascript', false) : '';
-    $mood = isset($_POST['newmood']) ? checkInput($_POST['newmood'], 'no', 'no', 'javascript', false) : '';
-    $sig = isset($_POST['newsig']) ? checkInput($_POST['newsig'], '', $SETTINGS['sightml'], '', false) : '';
+    $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+    $newavatarcheck = postedVar('newavatarcheck');
+    $location = postedVar('newlocation', 'javascript', TRUE, TRUE, TRUE);
+    $icq = postedVar('newicq', '', FALSE, FALSE);
+    $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
+    $yahoo = postedVar('newyahoo', 'javascript', TRUE, TRUE, TRUE);
+    $aim = postedVar('newaim', 'javascript', TRUE, TRUE, TRUE);
+    $msn = postedVar('newmsn', 'javascript', TRUE, TRUE, TRUE);
+    $email = postedVar('newemail', 'javascript', TRUE, TRUE, TRUE);
+    $site = postedVar('newsite', 'javascript', TRUE, TRUE, TRUE);
+    $bio = postedVar('newbio', 'javascript', TRUE, TRUE, TRUE);
+    $mood = postedVar('newmood', 'javascript', TRUE, TRUE, TRUE);
+    $sig = postedVar('newsig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-    $avatar = addslashes($avatar);
-    $location = addslashes($location);
-    $yahoo = addslashes($yahoo);
-    $aim = addslashes($aim);
-    $msn = addslashes($msn);
-    $email = addslashes($email);
-    $site = addslashes($site);
-    $bio = addslashes($bio);
-    $mood = addslashes($mood);
-    $sig = addslashes($sig);
-
     $max_size = explode('x', $SETTINGS['max_avatar_size']);
-    if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-        $size = @getimagesize($avatar);
-        if ($size === false) {
-            $avatar = '';
-        } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
-            error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+    if (ini_get('allow_url_fopen')) {
+        if ($max_size[0] > 0 && $max_size[1] > 0) {
+            $size = @getimagesize($_POST['newavatar']);
+            if ($size === false) {
+                $avatar = '';
+            } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
+                error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+            }
         }
+    } else if ($newavatarcheck == "no") {
+        $avatar = '';
     }
 
     $db->query("UPDATE ".X_PREFIX."members SET email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u' WHERE username='$user'");
-
-    $newpassword = formVar('newpassword');
+    $newpassword = $_POST['newpassword'];
     if ($newpassword) {
         $newpassword = md5($newpassword);
         $db->query("UPDATE ".X_PREFIX."members SET password='$newpassword' WHERE username='$user'");
Index: faq.php
===================================================================
--- faq.php	(revision 1095)
+++ faq.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,9 +26,11 @@
  *
  **/
 
+define('X_SCRIPT', 'faq.php');
+
 require 'header.php';
 
-$page = getVar('page');
+$page = postedVar('page', '', FALSE, FALSE, FALSE, 'g');
 
 if ($SETTINGS['faqstatus'] == 'off' && $page != 'forumrules') {
     loadtemplates('misc_feature_notavailable');
@@ -67,7 +69,7 @@
         loadtemplates('faq_messages_smilierow', 'faq_messages');
         $smilierows = NULL;
         nav($lang['textpostread']);
-        $querysmilie = $db->query("SELECT * FROM `" .X_PREFIX. "smilies` WHERE type = 'smiley'") or die($db->error());
+        $querysmilie = $db->query("SELECT * FROM `" .X_PREFIX. "smilies` WHERE type = 'smiley'");
         while($smilie = $db->fetch_array($querysmilie)) {
             eval('$smilierows .= "'.template('faq_messages_smilierow').'";');
         }
Index: forumdisplay.php
===================================================================
--- forumdisplay.php	(revision 1095)
+++ forumdisplay.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'forumdisplay.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -56,76 +58,79 @@
 $fid = getInt('fid');
 $page = getInt('page');
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
+$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
 $forum = $db->fetch_array($query);
 $db->free_result($query);
 
-$notexist = false;
-if (!isset($forum['type']) && $forum['type'] != 'forum' && $forum['type'] != 'sub' || $fid == 0) {
-    $notexist = $lang['textnoforum'];
+if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    error($lang['textnoforum']);
 }
 
+$perms = checkForumPermissions($forum);
+if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+    error($lang['privforummsg']);
+} else if (!$perms[X_PERMS_PASSWORD]) {
+    handlePasswordDialog($fid);
+}
+
 $fup = array();
-if (isset($forum['type']) && $forum['type'] == 'sub') {
-    $query = $db->query("SELECT private, userlist, name, fid FROM ".X_PREFIX."forums WHERE fid='$forum[fup]'");
+if ($forum['type'] == 'sub') {
+    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
     $fup = $db->fetch_array($query);
     $db->free_result($query);
-    if (!privfcheck($fup['private'], $fup['userlist'])) {
+
+    // prevent access to subforum when upper forum can't be viewed.
+    $fupPerms = checkForumPermissions($fup);
+    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
         error($lang['privforummsg']);
+    } else if (!$fupPerms[X_PERMS_PASSWORD]) {
+        handlePasswordDialog($fup['fid']);
+    } else if ($fup['fup'] > 0) {
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
     }
-} else if (!isset($forum['type']) && $forum['type'] != 'forum') {
-    error($notexist);
+    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
+} else if ($forum['fup'] > 0) { // 'forum' in a 'group'
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+    nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
 }
+nav(fnameOut($forum['name']));
 
-$authorization = privfcheck($forum['private'], $forum['userlist']);
-if (!$authorization) {
-    error($lang['privforummsg']);
+eval('echo "'.template('header').'";');
+
+if ($perms[X_PERMS_POLL]) {
+    eval('$newpolllink = "'.template('forumdisplay_newpoll').'";');
+} else {
+    $newpolllink = '';
 }
-pwverify($forum['password'], 'forumdisplay.php?fid='.$fid, $fid, true);
 
-if (isset($forum['type']) && $forum['type'] == 'forum') {
-    nav(html_entity_decode(stripslashes($forum['name'])));
-} else if (isset($forum['type']) && $forum['type'] == 'sub') {
-    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.html_entity_decode(stripslashes($fup['name'])).'</a>');
-    nav(html_entity_decode(stripslashes($forum['name'])));
+if ($perms[X_PERMS_THREAD]) {
+    eval('$newtopiclink = "'.template('forumdisplay_newtopic').'";');
+} else {
+    $newtopiclink = '';
 }
 
-eval('echo "'.template('header').'";');
-
 $subforums = '';
-if (count($fup) == 0) {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE type='sub' AND fup='$fid' AND status='on' ORDER BY displayorder");
+if ($forum['type'] == 'forum') {
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE type='sub' AND fup=$fid AND status='on' ORDER BY displayorder");
     if ($db->num_rows($query) != 0) {
         $forumlist = '';
-        $fulist = $forum['userlist'];
         while($sub = $db->fetch_array($query)) {
-            $forumlist .= forum($sub, "forumdisplay_subforum");
+            $perms = checkForumPermissions($sub);
+            if ($perms[X_PERMS_VIEW] And $perms[X_PERMS_USERLIST]) {
+                $forumlist .= forum($sub, "forumdisplay_subforum");
+            }
         }
-        $forum['userlist'] = $fulist;
-        if (!empty($forumlist)) {
+        if ($forumlist != '') {
             eval('$subforums .= "'.template('forumdisplay_subforums').'";');
         }
         $db->free_result($query);
     }
 }
 
-if (!$notexist) {
-    if (!postperm($forum, 'thread')) {
-        $newtopiclink = $newpolllink = '';
-    } else {
-        if (X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] != 'on') {
-            $newtopiclink = $newpolllink = '';
-        } else {
-            eval('$newtopiclink = "'.template('forumdisplay_newtopic').'";');
-            if (isset($forum['pollstatus']) && $forum['pollstatus'] != 'off') {
-                eval('$newpolllink = "'.template('forumdisplay_newpoll').'";');
-            } else {
-                $newpolllink = '';
-            }
-        }
-    }
-}
-
 $t_extension = get_extension($lang['toppedprefix']);
 switch($t_extension) {
     case 'gif':
@@ -165,20 +170,14 @@
     $cusdate = '';
 }
 
-$ascdesc = formVar('ascdesc');
+$ascdesc = postedVar('ascdesc', '', FALSE, FALSE);
 if (strtolower($ascdesc) != 'asc') {
     $ascdesc = "desc";
 }
 
 $forumdisplay_thread = 'forumdisplay_thread';
 
-if (X_STAFF && $self['status'] != 'Moderator') {
-    $status1 = 'Moderator';
-} else if ($self['status'] == 'Moderator') {
-    $status1 = modcheck($self['status'], $xmbuser, $forum['moderator']);
-} else {
-    $status1 = '';
-}
+$status1 = modcheck($self['username'], $forum['moderator']);
 
 if ($status1 == 'Moderator') {
     $forumdisplay_thread = 'forumdisplay_thread_admin';
@@ -209,12 +208,12 @@
         $topimage = '<img src="./images/admin/top.gif" alt="'.$lang['alttopthread'].'" border="0" />';
     }
 
-    $thread['subject'] = shortenString($thread['subject'], 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+    $thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
 
     if ($thread['author'] == $lang['textanonymous']) {
         $authorlink = $thread['author'];
     } else {
-        $authorlink = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($thread['author']).'">'.$thread['author'].'</a>';
+        $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
     }
 
     $prefix = '';
@@ -223,7 +222,7 @@
     $dalast = trim($lastpost[0]);
 
     if ($lastpost[1] != $lang['textanonymous']) {
-        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode(trim($lastpost[1])).'">'.trim($lastpost[1]).'</a>';
+        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut(trim($lastpost[1])).'">'.trim($lastpost[1]).'</a>';
     } else {
         $lastpost[1] = $lang['textanonymous'];
     }
@@ -286,8 +285,6 @@
         $prefix = $lang['toppedprefix'].' '.$prefix;
     }
 
-    $thread['subject'] = checkOutput(censor($thread['subject']), 'no', '', true);
-
     $postnum = $thread['replies']+1;
     if ($postnum > $ppp) {
         $pagelinks = multi($postnum, $ppp, 0, 'viewthread.php?tid='.intval($thread['tid']));
@@ -303,11 +300,7 @@
 }
 $db->free_result($querytop);
 
-if ($notexist) {
-    eval('$threadlist = "'.template('forumdisplay_invalidforum').'";');
-}
-
-if ($topicsnum == 0 && !$notexist) {
+if ($topicsnum == 0) {
     eval('$threadlist = "'.template('forumdisplay_nothreads').'";');
 }
 
@@ -352,17 +345,17 @@
 if (($multipage = multi($topicsnum, $tpp, $page, $mpurl)) === false) {
     $multipage = '';
 } else {
-    if (X_ADMIN || $status1 == 'Moderator') {
+    if ($status1 == 'Moderator') {
         eval('$multipage = "'.template('forumdisplay_multipage_admin').'";');
     } else {
         eval('$multipage = "'.template('forumdisplay_multipage').'";');
     }
 }
 
-if (X_ADMIN || $status1 == 'Moderator') {
-    eval('echo stripslashes("'.template('forumdisplay_admin').'");');
+if ($status1 == 'Moderator') {
+    eval('echo "'.template('forumdisplay_admin').'";');
 } else {
-    eval('echo stripslashes("'.template('forumdisplay').'");');
+    eval('echo "'.template('forumdisplay').'";');
 }
 
 end_time();
Index: header.php
===================================================================
--- header.php	(revision 1095)
+++ header.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,10 @@
  *
  **/
 
+if (!defined('X_SCRIPT')) {
+    exit("Not allowed to run this file directly.");
+}
+
 error_reporting(E_ALL&~E_NOTICE);
 
 define('IN_CODE', true);
@@ -36,6 +40,14 @@
 define('X_SHORTEN_SOFT', 1);
 define('X_SHORTEN_HARD', 2);
 
+// permissions constants
+define('X_PERMS_POLL', 0);
+define('X_PERMS_THREAD', 1);
+define('X_PERMS_REPLY', 2);
+define('X_PERMS_VIEW', 3);
+define('X_PERMS_USERLIST', 4);
+define('X_PERMS_PASSWORD', 5);
+
 if (!defined('ROOT')) {
     define('ROOT', './');
 }
@@ -64,7 +76,6 @@
 $onlinetime = time();
 $bbcodescript = '';
 $threadSubject = '';
-$self = array();
 $user = (isset($user)) ? $user : '';
 $SETTINGS = array();
 $THEME = array();
@@ -83,6 +94,7 @@
 $filetype = '';
 $quickjump = '';
 $newu2umsg = '';
+$othertid = '';
 
 define('COMMENTOUTPUT', false);
 define('MAXATTACHSIZE', 256000);
@@ -93,22 +105,35 @@
 
 require ROOT.'config.php';
 
+if (!defined('DEBUG')) {
+    define('DEBUG', FALSE);
+}
+
 if (DEBUG) {
     error_reporting(E_ALL | E_STRICT);
 }
 
+if (headers_sent()) {
+    if (DEBUG) {
+        headers_sent($filepath, $linenum);
+        exit(cdataOut("Error: XMB failed to start due to file corruption.  Please inspect $filepath at line number $linenum."));
+    } else {
+        exit("Error: XMB failed to start.  Set DEBUG to TRUE in config.php to see file system details.");
+    }
+}
+
 // Initialise pre-set Variables
 // These strings can be pulled for use on any page as header is required by all XMB pages
 $versioncompany = 'The XMB Group';
-$versionshort = 'XMB 1.9.8';
-$versiongeneral = 'XMB 1.9.8 Engage';
++$versionshort = 'XMB 1.9.10';
++$versiongeneral = 'XMB 1.9.10 Karl';
 $copyright = '2001-2008';
 if ($show_full_info) {
     $alpha = '';
     $beta = '';
-    $gamma = 'Final';
-    $service_pack = ' SP2';
-    $versionbuild = 20071231;
+    $gamma = '';
+    $service_pack = '';
+    $versionbuild = 20080609;
     $versionlong = 'Powered by '.$versiongeneral.' '.$alpha.$beta.$gamma.$service_pack.''.(DEBUG === true ? ' (Debug Mode)' : '');
 } else {
     $alpha = '';
@@ -124,6 +149,10 @@
 // this allows the use of various nice new features in eg mozilla
 // while others are available via IE and/or opera
 $browser = 'opera'; // default to opera for now
+if (!isset($_SERVER['HTTP_USER_AGENT'])) {
+    $_SERVER['HTTP_USER_AGENT'] = '';
+}
+
 if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'Gecko') && false === strpos($_SERVER['HTTP_USER_AGENT'], 'Safari')) {
     define('IS_MOZILLA', true);
     $browser = 'mozilla';
@@ -134,13 +163,6 @@
     $browser = 'opera';
 }
 
-if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE') && false === strpos($_SERVER['HTTP_USER_AGENT'], 'Opera')) {
-    define('IS_IE', true);
-    $browser = 'ie';
-}
-
-// Fix provided by whinpo :)
-// Browser incompatability regarding insertion.
 if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE')) {
     define('IS_IE', true);
     $browser = 'ie';
@@ -182,7 +204,7 @@
 }
 
 // Security checks
-if (file_exists('./install/') && !@unlink('./install/')) {
+if (file_exists('./install/') && !@rmdir('./install/')) {
     exit('<h1>Error:</h1><br />The installation files ("./install/") have been found on the server, but could not be removed. Please remove them as soon as possible. If you have not yet installed XMB, please do so at this time. Just <a href="./install/index.php">click here</a>.');
 }
 
@@ -194,14 +216,20 @@
     exit('<h1>Error:</h1><br />The hack repair tool ("./fixhack.php") has been found on the server, but could not be removed. Please remove it as soon as possible.');
 }
 
-if (file_exists('./Upgrade/') && !@unlink('./Upgrade/')) {
-    exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade/") has been found on the server, but could not be removed. Please remove it as soon as possible.');
+if (file_exists('./Upgrade/') && !@rmdir('./Upgrade/')) {
+    exit('<h1>Error:</h1><br />The upgrade tool ("./Upgrade/") has been found on the server, but could not be removed. Please remove it as soon as possible.');
 }
 
-if (file_exists('./upgrade/') && !@unlink('./upgrade/')) {
+if (file_exists('./upgrade/') && !@rmdir('./upgrade/')) {
     exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade/") has been found on the server, but could not be removed. Please remove it as soon as possible.');
 }
 
+if (file_exists('./upgrade.php') And X_SCRIPT != 'upgrade.php') {
+    if (!@unlink('./upgrade.php')) {
+        exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade.php") has been found on the server, but could not be removed. Please remove it as soon as possible.');
+    }
+}
+
 // Checks the format of the URL, blocks if necessary....
 if (eregi("\?[0-9]+$", $url)) {
     exit("Invalid String Format, Please Check Your URL");
@@ -221,15 +249,6 @@
     }
 }
 
-// Checks for various variables in the URL, if any of them is found, script is halted
-$url_check = Array('status=', 'xmbuser=', 'xmbpw=', '<script');
-$url = urldecode($url);
-foreach($url_check as $name) {
-    if (strpos(strtolower($url), $name)) {
-        exit();
-    }
-}
-
 // Load Objects, and such
 $tables = array(
     'attachments',
@@ -256,20 +275,30 @@
     'vote_voters'
 );
 
-foreach($tables as $name) {
-    ${'table_'.$name} = $tablepre.$name;
-}
-
 // Secured table prefix constant
 define('X_PREFIX', $tablepre);
 
 $db = new dbstuff;
 $db->connect($dbhost, $dbuser, $dbpw, $dbname, $pconnect);
 
+// Checks for various variables in the URL, if any of them is found, script is halted
+$url_check = Array('status=', 'xmbuser=', 'xmbpw=', '%3cscript');
+foreach($url_check as $name) {
+    if (strpos(strtolower($url), $name)) {
+        $auditaction = $_SERVER['REQUEST_URI'];
+        $aapos = strpos($auditaction, "?");
+        if ($aapos !== false) {
+            $auditaction = substr($auditaction, $aapos + 1);
+        }
+        $auditaction = $db->escape("$onlineip|#|ATTACK: $auditaction");
+        audit($xmbuser, $auditaction, 0, 0);
+        exit("Attack logged.");
+    }
+}
+
 // Load a few constants
 define('XMB_VERSION', $versiongeneral);
 define('XMB_BUILD', $versionbuild);
-
 define('X_REDIRECT_HEADER', 1);
 define('X_REDIRECT_JS', 2);
 
@@ -290,18 +319,20 @@
     $cookiepath = $array['path'];
 }
 
-// Set cookies
-put_cookie('xmblva', $onlinetime, ($onlinetime + (86400*365)), $cookiepath, $cookiedomain);
+// Update last visit cookies
+$xmblva = getInt('xmblva', 'c'); // Last visit
+$xmblvb = getInt('xmblvb', 'c'); // Duration of this visit (considered to be up to 600 seconds)
 
-if (isset($xmblvb)) {
-    $thetime = $xmblvb;
-} else if (isset($xmblva)) {
-    $thetime = $xmblva;
+if ($xmblvb > 0) {
+    $thetime = $xmblvb;     // lvb will expire in 600 seconds, so if it's there, we're in a current session
+} else if ($xmblva > 0) {
+    $thetime = $xmblva;     // Not currently logged in, so let's get the time from the last visit
 } else {
-    $thetime = $onlinetime;
+    $thetime = $onlinetime; // no cookie at all, so this is your first visit
 }
 
-put_cookie('xmblvb', $thetime, ($onlinetime + 600), $cookiepath, $cookiedomain);
+put_cookie('xmblva', $onlinetime, ($onlinetime + (86400*365)), $cookiepath, $cookiedomain); // lva == now
+put_cookie('xmblvb', $thetime, ($onlinetime + 600), $cookiepath, $cookiedomain); // lvb =
 
 $lastvisit = $thetime;
 $lastvisit2 = $lastvisit - 540;
@@ -335,30 +366,12 @@
 }
 
 // Get the user-vars, and make them semi-global
-if (!isset($xmbuser)) {
-    $xmbuser = '';
-    $xmbpw = '';
-    $self['status'] = '';
-}
 
-$q = false;
-if ($xmbuser != '') {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuser'");
-    $userrec = $db->fetch_array($query);
-    if ($db->num_rows($query) == 1 && $userrec['password'] == $xmbpw) {
-        $q = true;
-    }
-    $db->free_result($query);
-}
+elevateUser(postedVar('xmbuser', '', FALSE, TRUE, FALSE, 'c'), postedVar('xmbpw', '', FALSE, FALSE, FALSE, 'c'));
 
-if ($q) {
-    foreach($userrec as $key => $val) {
-        $self[$key] = $val;
-    }
 
-    define('X_MEMBER', true);
-    define('X_GUEST', false);
-
+if (X_MEMBER) {
+    $langfile = ($self['langfile'] == "" || !file_exists("lang/{$self['langfile']}.lang.php")) ? $SETTINGS['langfile'] : $self['langfile'];
     $timeoffset = $self['timeoffset'];
     $themeuser = $self['theme'];
     $status = $self['status'];
@@ -369,17 +382,9 @@
     $sig = $self['sig'];
     $invisible = $self['invisible'];
     $time = $onlinetime;
-    $langfile = ($self['langfile'] == "" || !file_exists("lang/$self[langfile].lang.php")) ? $SETTINGS['langfile'] : $self['langfile'];
-
-    if (!empty($theme)) {
-        $themeuser = $self['theme'];
-    }
-
     $db->query("UPDATE ".X_PREFIX."members SET lastvisit=".$db->time($onlinetime)." WHERE username='$xmbuser'");
 } else {
-    define('X_MEMBER', false);
-    define('X_GUEST', true);
-
+    $langfile = $SETTINGS['langfile'];
     $timeoffset = $SETTINGS['def_tz'];
     $themeuser = '';
     $status = 'member';
@@ -390,9 +395,10 @@
     $sig = '';
     $invisible = 0;
     $time = $onlinetime;
-    $langfile = $SETTINGS['langfile'];
     $self['ban'] = '';
     $self['sig'] = '';
+    $self['status'] = '';
+    $self['username'] = '';
 }
 
 if ($memtime == '') {
@@ -409,58 +415,7 @@
     }
 }
 
-$role = array();
-$role['sadmin'] = false;
-$role['admin'] = false;
-$role['smod'] = false;
-$role['mod'] = false;
-$role['staff'] = false;
-if (X_MEMBER) {
-    switch($self['status']) {
-        case 'Super Administrator':
-            $role['sadmin'] = true;
-            $role['admin'] = true;
-            $role['smod'] = true;
-            $role['mod'] = true;
-            $role['staff'] = true;
-            break;
-        case 'Administrator':
-            $role['sadmin'] = false;
-            $role['admin'] = true;
-            $role['smod'] = true;
-            $role['mod'] = true;
-            $role['staff'] = true;
-            break;
-        case 'Super Moderator':
-            $role['sadmin'] = false;
-            $role['admin'] = false;
-            $role['smod'] = true;
-            $role['mod'] = true;
-            $role['staff'] = true;
-            break;
-        case 'Moderator':
-            $role['sadmin'] = false;
-            $role['admin'] = false;
-            $role['smod'] = false;
-            $role['mod'] = true;
-            $role['staff'] = true;
-            break;
-        default:
-            $role['sadmin'] = false;
-            $role['admin'] = false;
-            $role['smod'] = false;
-            $role['mod'] = false;
-            $role['staff'] = false;
-            break;
-    }
-}
-define('X_SADMIN', $role['sadmin']);
-define('X_ADMIN', $role['admin']);
-define('X_SMOD', $role['smod']);
-define('X_MOD', $role['smod']);
-define('X_STAFF', $role['staff']);
-
-// Get the required language file
+// Load a language file
 if (file_exists(ROOT.'lang/'.$langfile.'.lang.php')) {
     require ROOT.'lang/'.$langfile.'.lang.php';
 } else {
@@ -479,11 +434,11 @@
     $memcp = '<a href="memcp.php">'.$lang['textusercp'].'</a>';
     $onlineuser = $xmbuser;
     $cplink = '';
-    $u2ulink = "<a href=\"#\" onclick=\"Popup('u2u.php', 'Window', 700, 450);\">$lang[banu2u]</a> - ";
+    $u2ulink = "<a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['banu2u']}</a> - ";
     if (X_ADMIN) {
         $cplink = ' - <a href="cp.php">'.$lang['textcp'].'</a>';
     }
-    $notify = $lang['loggedin'].' <a href="member.php?action=viewpro&amp;member='.rawurlencode($onlineuser).'">'.$xmbuser.'</a><br />['.$loginout.' - '.$u2ulink.''.$memcp.''.$cplink.']';
+    $notify = $lang['loggedin'].' <a href="member.php?action=viewpro&amp;member='.recodeOut($xmbuser).'">'.$xmbuser.'</a><br />['.$loginout.' - '.$u2ulink.''.$memcp.''.$cplink.']';
 } else {
     $loginout = '<a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
     $onlineuser = 'xguest123';
@@ -502,19 +457,14 @@
 $dateformat = str_replace(array('mm', 'MM', 'dd', 'DD', 'yyyy', 'YYYY', 'yy', 'YY'), array('n', 'n', 'j', 'j', 'Y', 'Y', 'y', 'y'), $dateformat);
 
 // Get themes, [fid, [tid]]
-if (isset($tid) && $action != 'templates') {
-    $query = $db->query("SELECT f.fid, f.theme, t.subject FROM ".X_PREFIX."forums f, ".X_PREFIX."threads t WHERE f.fid=t.fid AND t.tid='$tid'");
+if (isset($tid) && is_numeric($tid) && $action != 'templates') {
+    $query = $db->query("SELECT f.fid, f.theme FROM ".X_PREFIX."forums f RIGHT JOIN ".X_PREFIX."threads t USING (fid) WHERE t.tid=$tid");
     $locate = $db->fetch_array($query);
     $db->free_result($query);
     $fid = $locate['fid'];
     $forumtheme = $locate['theme'];
-    if ($SETTINGS['subject_in_title'] == 'on' && $locate['subject']) {
-        $threadSubject = '- '.html_entity_decode(stripslashes(htmlspecialchars($locate['subject'])));
-    } else {
-        $threadSubject = '';
-    }
-} else if (isset($fid)) {
-    $q = $db->query("SELECT theme FROM ".X_PREFIX."forums WHERE fid='$fid'");
+ } else if (isset($fid) && is_numeric($fid)) {
+    $q = $db->query("SELECT theme FROM ".X_PREFIX."forums WHERE fid=$fid");
     if ($db->num_rows($q) === 1) {
         $forumtheme = $db->result($q, 0);
         $db->free_result($q);
@@ -523,25 +473,13 @@
     }
 }
 
-$wollocation = addslashes($url);
+$wollocation = $db->escape($url);
 $newtime = $onlinetime - 600;
 
 // clear out old entries and guests
 $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ((ip='$onlineip' && username='xguest123') OR (username='$xmbuser') OR (time < '$newtime'))");
 $db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
 
-// Find duplicate entries for users only
-$username = isset($username) ? $username : '';
-if (X_MEMBER) {
-    $result = $db->query("SELECT count(username) FROM ".X_PREFIX."whosonline WHERE (username='$xmbuser')");
-    $usercount = $db->result($result, 0);
-    if ($usercount > 1) {
-        $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE (username='$xmbuser')");
-        $db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
-    }
-    $db->free_result($result);
-}
-
 // Check what theme to use
 if ((int) $themeuser > 0) {
     $theme = (int) $themeuser;
@@ -623,7 +561,7 @@
     $lasttime = gmdate($timecode, $theTime);
     $lastvisittext = $lang['lastactive'].' '.$lastdate.' '.$lang['textat'].' '.$lasttime;
 } else {
-    $lastvisittext = $lang['lastactive'].' '.$lang['textnever'];
+    $lastvisittext = '';
 }
 
 // Checks for various settings
@@ -685,14 +623,14 @@
 // Show all plugins
 $pluglinks = array();
 foreach($plugname as $plugnum => $item) {
-    if (!empty($plugurl[$plugnum]) && !empty($plugname[$plugnum]) ) {
-        if (trim($plugimg[$plugnum]) != '' ) {
+    if (!empty($plugurl[$plugnum]) && !empty($plugname[$plugnum])) {
+        if (trim($plugimg[$plugnum]) != '') {
             $img = '&nbsp;<img src="'.$plugimg[$plugnum].'" border="0" />&nbsp;';
         } else {
             $img = '';
         }
 
-        if ($plugadmin[$plugnum] != true || X_ADMIN ) {
+        if ($plugadmin[$plugnum] != true || X_ADMIN) {
             $pluglinks[] = $img.'<a href="'.$plugurl[$plugnum].'"><font class="navtd">'.$plugname[$plugnum].'</font></a>&nbsp;';
         }
     }
@@ -705,20 +643,15 @@
 }
 
 // If the board is offline, display an appropriate message
-if ($SETTINGS['bbstatus'] == 'off' && !(X_ADMIN) && false === strpos($url, 'misc.php') && false === strpos($url, 'member.php')) {
-    $newu2umsg = '';
+if ($SETTINGS['bbstatus'] == 'off' && !(X_ADMIN) && X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php') {
     eval('$css = "'.template('css').'";');
     message(nl2br(stripslashes($bboffreason)));
 }
 
 // If the board is set to 'reg-only' use, check if someone is logged in, and if not display a message
-if ($SETTINGS['regviewonly'] == 'on') {
-    if (X_GUEST && $action != 'reg' && $action != 'login' && $action != 'lostpw' && $action != 'coppa' && $action != 'captchaimage') {
-        if ($SETTINGS['coppa'] == 'on') {
-            $message = $lang['reggedonly'].' <a href="member.php?action=coppa">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-        } else {
-            $message = $lang['reggedonly'].' <a href="member.php?action=reg">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-        }
+if ($SETTINGS['regviewonly'] == 'on' && X_GUEST) {
+    if (($action != 'reg' && $action != 'login' && $action != 'lostpw' && $action != 'coppa' && $action != 'captchaimage') || (X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php')) {
+        $message = $lang['reggedonly'].' <a href="member.php?action=coppa">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
         eval('$css = "'.template('css').'";');
         message($message);
     }
@@ -728,11 +661,11 @@
 $ips = explode(".", $onlineip);
 // also disable 'ban all'-possibility
 $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE ((ip1='$ips[0]' OR ip1='-1') AND (ip2='$ips[1]' OR ip2='-1') AND (ip3='$ips[2]' OR ip3='-1') AND (ip4='$ips[3]' OR ip4='-1')) AND NOT (ip1='-1' AND ip2='-1' AND ip3='-1' AND ip4='-1')");
-$result = $db->fetch_array($query);
+$result = $db->num_rows($query);
 $db->free_result($query);
 
 // don't *ever* ban a (super-)admin!
-if (!X_ADMIN && ($self['status'] == 'Banned' || $result)) {
+if (($self['status'] == 'Banned' || $result > 0) && !(X_ADMIN || (X_SCRIPT == 'misc.php' && $action == 'logout'))) {
     eval('$css = "'.template('css').'";');
     error($lang['bannedmessage']);
 }
@@ -740,10 +673,10 @@
 // if the user is registered, check for new u2u's
 $newu2umsg = '';
 if (X_MEMBER) {
-    $query = $db->query("SELECT COUNT(readstatus) FROM ".X_PREFIX."u2u WHERE owner='$self[username]' AND folder='Inbox' AND readstatus='no'");
+    $query = $db->query("SELECT COUNT(readstatus) FROM ".X_PREFIX."u2u WHERE owner='$xmbuser' AND folder='Inbox' AND readstatus='no'");
     $newu2unum = $db->result($query, 0);
     if ($newu2unum > 0) {
-        $newu2umsg = "<a href=\"#\" onclick=\"Popup('u2u.php', 'Window', 700, 450);\">$lang[newu2u1] $newu2unum $lang[newu2u2]</a>";
+        $newu2umsg = "<a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['newu2u1']} $newu2unum {$lang['newu2u2']}</a>";
     }
     $db->free_result($query);
 }
@@ -751,7 +684,6 @@
 // create forum jump
 $quickjump = '';
 if ($SETTINGS['quickjump_status'] == 'on') {
-    $quickjump = base64_decode($quickjump);
     $quickjump = forumJump();
 }
-?>
\ No newline at end of file
+?>
Index: include/admin.inc.php
===================================================================
--- include/admin.inc.php	(revision 1095)
+++ include/admin.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -34,15 +34,22 @@
     function rename_user($userfrom, $userto) {
         global $db, $lang, $self;
 
-        if ($userfrom == '' || $userto == '') {
-            return $lang['admin_rename_fail'];
+        if (strlen($userto) < 3 || strlen($userto) > 32) {
+            return $lang['username_length_invalid'];
         }
 
-        $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$userfrom'");
+        $dbuserfrom = $db->escape($userfrom);
+        $dbuserto = $db->escape($userto);
+        $dblikeuserfrom = $db->like_escape($userfrom);
+        $dbregexuserfrom = $db->regexp_escape($userfrom);
+        $userfrom = '';
+        $userto = '';
+
+        $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$dbuserfrom'");
         $cUsrFrm = $db->num_rows($query);
         $db->free_result($query);
 
-        $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$userto'");
+        $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$dbuserto'");
         $cUsrTo = $db->num_rows($query);
         $db->free_result($query);
 
@@ -50,75 +57,65 @@
             return $lang['admin_rename_fail'];
         }
 
-        if (!$this->check_restricted($userto)) {
+        if (!$this->check_restricted($dbuserto)) {
             return $lang['restricted'];
         }
 
-        if (strlen($userto) < 3 || strlen($userto) > 32) {
-            return $lang['username_length_invalid'];
-        }
-
         @set_time_limit(180);
-        $db->query("UPDATE ".X_PREFIX."members SET username='$userto' WHERE username='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."buddys SET username='$userto' WHERE username='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."buddys SET buddyname='$userto' WHERE buddyname='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."favorites SET username='$userto' WHERE username='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."forums SET moderator='$userto' WHERE moderator='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."logs SET username='$userto' WHERE username='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."posts SET author='$userto' WHERE author='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."threads SET author='$userto' WHERE author='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."u2u SET msgto='$userto' WHERE msgto='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."u2u SET msgfrom='$userto' WHERE msgfrom='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."u2u SET owner='$userto' WHERE owner='$userfrom'");
-        $db->query("UPDATE ".X_PREFIX."whosonline SET username='$userto' WHERE username='$userfrom'");
+        $db->query("UPDATE ".X_PREFIX."members SET username='$dbuserto' WHERE username='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."buddys SET username='$dbuserto' WHERE username='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."buddys SET buddyname='$dbuserto' WHERE buddyname='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."favorites SET username='$dbuserto' WHERE username='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."forums SET moderator='$dbuserto' WHERE moderator='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."logs SET username='$dbuserto' WHERE username='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."posts SET author='$dbuserto' WHERE author='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."threads SET author='$dbuserto' WHERE author='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET msgto='$dbuserto' WHERE msgto='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET msgfrom='$dbuserto' WHERE msgfrom='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET owner='$dbuserto' WHERE owner='$dbuserfrom'");
+        $db->query("UPDATE ".X_PREFIX."whosonline SET username='$dbuserto' WHERE username='$dbuserfrom'");
 
-        $query = $db->query("SELECT tid, lastpost from ".X_PREFIX."threads WHERE lastpost like '%$userfrom'");
+        $query = $db->query("SELECT tid, lastpost from ".X_PREFIX."threads WHERE lastpost like '%|$dblikeuserfrom|%'");
         while($result = $db->fetch_array($query)) {
-            list($posttime, $lastauthor) = explode("|", $result['lastpost']);
-            if ($lastauthor == $userfrom) {
-                $newlastpost = $posttime . '|' . $userto;
-                $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$newlastpost' WHERE tid='".$result['tid']."'");
-            }
+            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape($result['lastpost']));
+            $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$newlastpost' WHERE tid={$result['tid']}");
         }
         $db->free_result($query);
 
-        $query = $db->query("SELECT ignoreu2u, uid FROM ".X_PREFIX."members WHERE (ignoreu2u REGEXP '(^|(,))()*$userfrom()*((,)|$)')");
+        $query = $db->query("SELECT ignoreu2u, uid FROM ".X_PREFIX."members WHERE (ignoreu2u REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($usr = $db->fetch_array($query)) {
-            $parts = explode(',', $usr['ignoreu2u']);
-            $index = array_search($userfrom, $parts);
-            $parts[$index] = $userto;
+            $parts = explode(',', $db->escape($usr['ignoreu2u']));
+            $index = array_search($dbuserfrom, $parts);
+            $parts[$index] = $dbuserto;
             $parts = implode(',', $parts);
-            $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='".$parts."' WHERE uid='".$usr['uid']."'");
+            $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='$parts' WHERE uid={$usr['uid']}");
         }
         $db->free_result($query);
 
-        $query = $db->query("SELECT moderator, fid FROM ".X_PREFIX."forums WHERE (moderator REGEXP '(^|(,))()*$userfrom()*((,)|$)')");
+        $query = $db->query("SELECT moderator, fid FROM ".X_PREFIX."forums WHERE (moderator REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($list = $db->fetch_array($query)) {
-            $parts = explode(',', $list['moderator']);
-            $index = array_search($userfrom, $parts);
-            $parts[$index] = $userto;
+            $parts = explode(',', $db->escape($list['moderator']));
+            $index = array_search($dbuserfrom, $parts);
+            $parts[$index] = $dbuserto;
             $parts = implode(', ', $parts);
-            $db->query("UPDATE ".X_PREFIX."forums SET moderator='".$parts."' WHERE fid='".$list['fid']."'");
+            $db->query("UPDATE ".X_PREFIX."forums SET moderator='$parts' WHERE fid={$list['fid']}");
         }
         $db->free_result($query);
 
-        $query = $db->query("SELECT userlist, fid FROM ".X_PREFIX."forums WHERE (userlist REGEXP '(^|(,))()*$userfrom()*((,)|$)')");
+        $query = $db->query("SELECT userlist, fid FROM ".X_PREFIX."forums WHERE (userlist REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($list = $db->fetch_array($query)) {
-            $parts = array_unique(array_map('trim', explode(',', $list['userlist'])));
-            $index = array_search($userfrom, $parts);
-            $parts[$index] = $userto;
+            $parts = array_unique(array_map('trim', explode(',', $db->escape($list['userlist']))));
+            $index = array_search($dbuserfrom, $parts);
+            $parts[$index] = $dbuserto;
             $parts = implode(', ', $parts);
-            $db->query("UPDATE ".X_PREFIX."forums SET userlist='".$parts."' WHERE fid='".$list['fid']."'");
+            $db->query("UPDATE ".X_PREFIX."forums SET userlist='$parts' WHERE fid={$list['fid']}");
         }
         $db->free_result($query);
 
-        $query = $db->query("SELECT fid, lastpost FROM ".X_PREFIX."forums WHERE lastpost LIKE '%$userfrom'");
+        $query = $db->query("SELECT fid, lastpost FROM ".X_PREFIX."forums WHERE lastpost LIKE '%|$dblikeuserfrom|%'");
         while($result = $db->fetch_array($query)) {
-            list($posttime, $lastauthor, $lastpid) = explode("|", $result['lastpost']);
-            if ($lastauthor == $userfrom) {
-                $newlastpost = $posttime . '|' . $userto.'|'.$lastpid;
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$newlastpost' WHERE fid='".$result['fid']."'");
-            }
+            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape($result['lastpost']));
+            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$newlastpost' WHERE fid={$result['fid']}");
         }
         $db->free_result($query);
 
@@ -274,6 +271,7 @@
             }
         }
         $db->free_result($query);
+
         return $nameokay;
     }
 }
@@ -342,7 +340,8 @@
     </td>
     <td class="tablerow" align="left" valign="top" width="20%" bgcolor="<?php echo $THEME['altbg2']?>">
     &raquo;&nbsp;<a href="tools.php?action=fixftotals"><?php echo $lang['textfixposts']?></a><br />
-    &raquo;&nbsp;<a href="tools.php?action=fixlastposts"><?php echo $lang['textfixlastposts']?></a><br />
+    &raquo;&nbsp;<a href="tools.php?action=fixlastposts&amp;scope=forumsonly"><?php echo $lang['textfixlastposts'].' - '.$lang['textforums']; ?></a><br />
+    &raquo;&nbsp;<a href="tools.php?action=fixlastposts"><?php echo $lang['textfixlastposts'].' - '.$lang['threads']; ?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=fixmposts"><?php echo $lang['textfixmemposts']?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=fixttotals"><?php echo $lang['textfixthread']?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=fixorphanedthreads"><?php echo $lang['textfixothreads']?></a><br />
Index: include/buddy.inc.php
===================================================================
--- include/buddy.inc.php	(revision 1095)
+++ include/buddy.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -31,13 +31,15 @@
 }
 
 function blistmsg($message, $redirect='', $exit=false) {
-    global $bordercolor, $tablewidth, $borderwidth, $tablespace, $altbg1, $css, $bbname, $lang;
+    global $bordercolor, $tablewidth, $THEME, $tablespace, $altbg1, $css, $bbname, $lang;
     global $charset, $text, $redirectjs;
 
     if ($redirect != '') {
         redirect($redirect, 2);
     }
+
     eval('echo stripslashes("'.template('buddylist_message').'");');
+
     if ($exit) {
         exit();
     }
@@ -58,8 +60,6 @@
         if (empty($buddy) || (strlen(trim($buddy)) == 0)) {
             blistmsg($lang['nobuddyselected'], '', true);
         } else {
-            $buddy = addslashes(checkInput($buddy));
-
             if ($buddy == $xmbuser) {
                 blistmsg($lang['buddywarnaddself']);
             }
@@ -82,11 +82,10 @@
 
 function buddy_edit() {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     $buddys = array();
-
-    $q = $db->query("SELECT buddyname FROM ".X_PREFIX."buddys WHERE username='$xmbuser'") or die($db->error());
+    $q = $db->query("SELECT buddyname FROM ".X_PREFIX."buddys WHERE username='$xmbuser'");
     while($buddy = $db->fetch_array($q)) {
         eval('$buddys[] = "'.template('buddylist_edit_buddy').'";');
     }
@@ -102,25 +101,62 @@
 
 function buddy_delete($delete) {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     foreach($delete as $key=>$buddy) {
-        $buddy = addslashes(checkInput($buddy));
         $db->query("DELETE FROM ".X_PREFIX."buddys WHERE buddyname='$buddy' AND username='$xmbuser'");
     }
 
     blistmsg($lang['buddylistupdated'], 'buddy.php');
 }
 
+/**
+* buddy_addu2u() - Display a list of buddies with their online status
+*
+* @param    none, but takes many globals
+* @return    no return value, but will display a status report or a list of buddies and their online status
+*/
+function buddy_addu2u() {
+    global $db, $lang, $xmbuser, $oToken;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+
+    $buddys = array();
+    $buddys['offline'] = '';
+    $buddys['online'] = '';
+
+    $q = $db->query("SELECT b.buddyname, w.invisible, w.username FROM ".X_PREFIX."buddys b LEFT JOIN ".X_PREFIX."whosonline w ON (b.buddyname=w.username) WHERE b.username='$xmbuser'");
+    if ($db->num_rows($q) == 0) {
+        blistmsg($lang['no_buddies']);
+    } else {
+        while($buddy = $db->fetch_array($q)) {
+            $buddyout = $buddy['buddyname'];
+            $recodename = recodeOut($buddy['buddyname']);
+            if ($buddy['invisible'] == 1) {
+                if (!X_ADMIN) {
+                    eval('$buddys["offline"] .= "'.template('buddy_u2u_off').'";');
+                } else {
+                    eval('$buddys["online"] .= "'.template('buddy_u2u_inv').'";');
+                }
+            } else if ($buddy['username'] != '') {
+                eval('$buddys["online"] .= "'.template('buddy_u2u_on').'";');
+            } else {
+                eval('$buddys["offline"] .= "'.template('buddy_u2u_off').'";');
+            }
+        }
+        eval('echo "'.template('buddy_u2u').'";');
+    }
+}
+
 function buddy_display() {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     $q = $db->query("SELECT b.buddyname, w.invisible, w.username FROM ".X_PREFIX."buddys b LEFT JOIN ".X_PREFIX."whosonline w ON (b.buddyname=w.username) WHERE b.username='$xmbuser'");
     $buddys = array();
     $buddys['offline'] = '';
     $buddys['online'] = '';
     while($buddy = $db->fetch_array($q)) {
+        $recodename = recodeOut($buddy['buddyname']);
         if ($buddy['username'] != '') {
             if ($buddy['invisible'] == 1) {
                 if (!X_ADMIN) {
@@ -139,4 +175,4 @@
     }
     eval('echo stripslashes("'.template('buddylist').'");');
 }
-?>
\ No newline at end of file
+?>
Index: include/captcha.inc.php
===================================================================
--- include/captcha.inc.php	(revision 1095)
+++ include/captcha.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -261,14 +261,21 @@
         }
     }
 
-    function DrawDots() {
+    function DrawDots($colors) {
+        $rmin = 0;
+        $rmax = 255;
+
         for($i = 0; $i < $this->iNumDots; $i++) {
             // allocate color
             if ($this->bUseColor) {
-                $iDotColor = imagecolorallocate($this->oImage, rand(100, 250), rand(100, 250), rand(100, 250));
+                $iDotColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
             } else {
-                $iRandColor = rand(100, 250);
-                $iDotColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                $iRandColor = rand($rmin, $rmax);
+                if (empty($this->aBackgroundImages)) {
+                    $iDotColor = $colors[$iRandColor];
+                } else {
+                    $iDotColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                }
             }
 
             // draw dot
@@ -276,14 +283,27 @@
         }
     }
 
-    function DrawLines() {
+    function DrawLines($bg_lum, $colors) {
+        // Choose a luminosity range that will always be similar to the background color.
+        if ($bg_lum < 128) {
+            $rmin = 0;
+            $rmax = 145;
+        } else {
+            $rmin = 110;
+            $rmax = 255;
+        }
+
         for($i = 0; $i < $this->iNumLines; $i++) {
             // allocate color
             if ($this->bUseColor) {
-                $iLineColor = imagecolorallocate($this->oImage, rand(100, 250), rand(100, 250), rand(100, 250));
+                $iLineColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
             } else {
-                $iRandColor = rand(100, 250);
-                $iLineColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                $iRandColor = rand($rmin, $rmax);
+                if (empty($this->aBackgroundImages)) {
+                    $iLineColor = $colors[$iRandColor];
+                } else {
+                    $iLineColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                }
             }
 
             // draw line
@@ -293,6 +313,7 @@
 
     function GenerateCode() {
         global $db, $onlinetime;
+        $db->query('DELETE FROM '.X_PREFIX.'captchaimages WHERE dateline < '.(time() - 86400));
         // loop through and generate the code letter by letter
         for($i = 0; $i < $this->iNumChars; $i++) {
             if (count($this->aCharSet) >= $this->iNumChars) {
@@ -320,7 +341,6 @@
     function RetrieveCode($imghash) {
         global $db;
         // check imagehash
-        $imghash = checkInput($imghash, '', '', "javascript", false);
         if ($imghash == 'test') {
             $imgCode = 'CaPtChA';
         } else {
@@ -335,7 +355,16 @@
         return $imgCode;
     }
 
-    function DrawCharacters() {
+    function DrawCharacters($bg_lum, $colors) {
+        // Choose a luminosity range that will never conflict with the background color.
+        if ($bg_lum > 127) {
+            $rmin = 0;
+            $rmax = 110;
+        } else {
+            $rmin = 145;
+            $rmax = 255;
+        }
+
         // loop through and write out selected number of characters
         for($i = 0; $i < strlen($this->sCode); $i++) {
             // select random font
@@ -343,18 +372,26 @@
 
             // select random color
             if ($this->bUseColor) {
-               $iTextColor = imagecolorallocate($this->oImage, rand(0, 100), rand(0, 100), rand(0, 100));
+               $iTextColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
                if ($this->bCharShadow) {
                    // shadow color
-                   $iShadowColor = imagecolorallocate($this->oImage, rand(0, 100), rand(0, 100), rand(0, 100));
+                   $iShadowColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
                 }
             } else {
-                $iRandColor = rand(0, 100);
-                $iTextColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                $iRandColor = rand($rmin, $rmax);
+                if (empty($this->aBackgroundImages)) {
+                    $iTextColor = $colors[$iRandColor];
+                } else {
+                    $iTextColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                }
                 if ($this->bCharShadow) {
                     // shadow color
-                    $iRandColor = rand(0, 100);
-                    $iShadowColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                    $iRandColor = rand($rmin, $rmax);
+                    if (empty($this->aBackgroundImages)) {
+                        $iShadowColor = $colors[$iRandColor];
+                    } else {
+                        $iShadowColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                    }
                 }
             }
 
@@ -388,7 +425,7 @@
         header("Content-type: image/$this->sFileType");
         switch($this->sFileType) {
             case 'gif':
-                imagegif($this->oImage);
+                imagegif ($this->oImage);
                 break;
             case 'png':
                 imagepng($this->oImage);
@@ -400,6 +437,13 @@
 
     function Create($imghash) {
         global $THEME;
+        // calculate color components of alternative background color 2 to match theme.
+        $bg_red = hexdec(substr($THEME['altbg2'], 1, 2));
+        $bg_green = hexdec(substr($THEME['altbg2'], 3, 2));
+        $bg_blue = hexdec(substr($THEME['altbg2'], 5, 2));
+        $bg_lum = (max($bg_red, $bg_green, $bg_blue) + min($bg_red, $bg_green, $bg_blue)) >> 1;
+        $colors = array();
+
         // get background image if specified and copy to CAPTCHA
         if (!empty($this->aBackgroundImages)) {
             // create new image
@@ -411,7 +455,7 @@
             $ext = substr($vBackgroundImage, -3);
             switch($ext) {
                 case 'gif':
-                    $oBackgroundImage = imagecreatefromgif($vBackgroundImage);
+                    $oBackgroundImage = imagecreatefromgif ($vBackgroundImage);
                     break;
                 case 'png':
                     $oBackgroundImage = imagecreatefrompng($vBackgroundImage);
@@ -425,20 +469,24 @@
 
             // free memory used to create background image
             imagedestroy($oBackgroundImage);
+        } else if ($this->bUseColor) {
+            $this->oImage = imagecreatetruecolor($this->iWidth, $this->iHeight);
+            $bgcolor = imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
+            imagefill($this->oImage, 0, 0, $bgcolor);
         } else {
             // create new image
             $this->oImage = imagecreate($this->iWidth, $this->iHeight);
+            imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
+            for($i = 1; $i <= 255; $i++) {
+                $colors[$i] = imagecolorallocate($this->oImage, $i, $i, $i);
+            }
+            $colors[0] = $colors[1];
         }
 
-        // allocate alternative background color 2 to match theme.
-        $bg_red = hexdec(substr($THEME['altbg2'], 1, 2));
-        $bg_green = hexdec(substr($THEME['altbg2'], 3, 2));
-        $bg_blue = hexdec(substr($THEME['altbg2'], 5, 2));
-        imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
-        $this->DrawDots();
-        $this->DrawLines();
+        $this->DrawLines($bg_lum, $colors);
+        $this->DrawDots($colors);
         $this->RetrieveCode($imghash);
-        $this->DrawCharacters();
+        $this->DrawCharacters($bg_lum, $colors);
 
         // write out image to file or browser
         $this->WriteFile();
Index: include/functions.inc.php
===================================================================
--- include/functions.inc.php	(revision 1095)
+++ include/functions.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,13 +26,165 @@
  *
  **/
 
+if (!defined('IN_CODE')) {
+    exit("Not allowed to run this file directly.");
+}
+
+//loginUser() is responsible for accepting credentials for new sessions.
+//$xmbuserinput must be html escaped & db escaped username input.
+//$xmbpwinput must be raw password hash input.
+function loginUser($xmbuserinput, $xmbpwinput, $invisible=FALSE, $tempcookie=FALSE) {
+    global $server, $self, $onlineip, $misc, $onlinetime, $db, $cookiepath, $cookiedomain;
+
+    if (elevateUser($xmbuserinput, $xmbpwinput)) {
+        $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ip='$onlineip' && username='xguest123'");
+        $currtime = $onlinetime + (86400*30);
+
+        $dbname = $db->escape($self['username']);
+
+        if ($invisible) {
+            $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$dbname'");
+        } else {
+            $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$dbname'");
+        }
+
+        if ($server == 'Mic') {
+            $misc = '<script>
+                function put_cookie(name, value, expires, path, domain, secure) {
+                    var curCookie = name + "=" + escape(value) +
+                    ((expires) ? "; expires=" + expires.toGMTString() : "") +
+                    ((path) ? "; path=" + path : "") +
+                    ((domain) ? "; domain=" + domain : "") +
+                    ((secure) ? "; secure" : "");
+                    document.cookie = curCookie;
+                }
+
+                var now = new Date();
+                now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
+
+                put_cookie("xmbuser", "'.$self['username'].'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
+                put_cookie("xmbpw", "'.$xmbpwinput.'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
+            </script>';
+        } else {
+            if ($tempcookie) {
+                put_cookie("xmbuser", $self['username'], NULL, $cookiepath, $cookiedomain);
+                put_cookie("xmbpw", $xmbpwinput, NULL, $cookiepath, $cookiedomain);
+            } else {
+                put_cookie("xmbuser", $self['username'], $currtime, $cookiepath, $cookiedomain);
+                put_cookie("xmbpw", $xmbpwinput, $currtime, $cookiepath, $cookiedomain);
+            }
+            $misc = '';
+        }
+        return TRUE;
+    } else {
+        return FALSE;
+    }
+}
+
+//elevateUser() is responsible for authenticating established sessions and setting up session variables.
+//$xmbuserinput must be html escaped & db escaped username input.
+//$xmbpwinput must be raw password hash input.
+function elevateUser($xmbuserinput, $xmbpwinput) {
+    global $xmbuser, $xmbpw, $self, $lang, $db, $charset, $SETTINGS, $onlineip;
+
+    $xmbuser = '';
+    $xmbpw = '';
+    $self = array();
+
+    //Usernames are historically html encoded in the XMB database, as well as in cookies.
+    //$xmbuser is often used as a raw value in queries and should be sql escaped.
+    //$self['username'] is a good alternative for future template use.
+    //$xmbpw was historically abused and will no longer contain a value.
+
+    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuserinput'");
+    if ($db->num_rows($query) == 1) {
+        $self = $db->fetch_array($query); //The self array will remain available, global.
+        if ($self['password'] == $xmbpwinput) {
+            $xmbuser = $db->escape($self['username']);
+        }
+        $self['password'] = '';
+    }
+    $db->free_result($query);
+
+    $xmbuserinput = '';
+    $xmbpwinput = '';
+
+    //Database routine complete.  Now set the role constants.
+
+    if ($xmbuser == '') {
+        $self = array();
+        $role['sadmin'] = false;
+        $role['admin']  = false;
+        $role['smod']   = false;
+        $role['mod']    = false;
+        $role['staff']  = false;
+        if (!defined('X_GUEST')) {
+            define('X_MEMBER', false);
+            define('X_GUEST', true);
+        }
+    } else {
+        if (!defined('X_GUEST')) {
+            define('X_MEMBER', true);
+            define('X_GUEST', false);
+        }
+
+        switch($self['status']) {
+            case 'Super Administrator':
+                $role['sadmin'] = true;
+                $role['admin']  = true;
+                $role['smod']   = true;
+                $role['mod']    = true;
+                $role['staff']  = true;
+                break;
+            case 'Administrator':
+                $role['sadmin'] = false;
+                $role['admin']  = true;
+                $role['smod']   = true;
+                $role['mod']    = true;
+                $role['staff']  = true;
+                break;
+            case 'Super Moderator':
+                $role['sadmin'] = false;
+                $role['admin']  = false;
+                $role['smod']   = true;
+                $role['mod']    = true;
+                $role['staff']  = true;
+                break;
+            case 'Moderator':
+                $role['sadmin'] = false;
+                $role['admin']  = false;
+                $role['smod']   = false;
+                $role['mod']    = true;
+                $role['staff']  = true;
+                break;
+            default:
+                $role['sadmin'] = false;
+                $role['admin']  = false;
+                $role['smod']   = false;
+                $role['mod']    = false;
+                $role['staff']  = false;
+                break;
+        }
+    }
+
+    if (!defined('X_STAFF')) {
+        define('X_SADMIN', $role['sadmin']);
+        define('X_ADMIN', $role['admin']);
+        define('X_SMOD', $role['smod']);
+        define('X_MOD', $role['mod']);
+        define('X_STAFF', $role['staff']);
+    }
+
+    return ($xmbuser != '');
+}
+
 function nav($add=false, $raquo=true) {
     global $navigation;
 
     if (!$add) {
         $navigation = '';
     } else {
-        $navigation .= ($raquo ? ' / ' : ''). $add;
+        $navigation .= ($raquo ? ' &raquo; ' : ''). $add;
     }
 }
 
@@ -101,20 +253,30 @@
     }
 }
 
-function censor($txt, $ignorespaces=false) {
+function censor($txt) {
     global $censorcache;
 
+    $ignorespaces = TRUE;
     if (is_array($censorcache)) {
         if (count($censorcache) > 0) {
+            $prevfind = '';
             foreach($censorcache as $find=>$replace) {
                 if ($ignorespaces === true) {
-                    $txt = str_replace($find, $replace, $txt);
+                    $txt = str_ireplace($find, $replace, $txt);
                 } else {
-                    $txt = preg_replace("#(^|[^a-z])(".preg_quote($find).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+                    if ($prevfind == '') {
+                        $prevfind = $find;
+                    }
+                    $txt = preg_replace("#(^|[^a-z])(".preg_quote($find)."|".preg_quote($prevfind).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+                    $prevfind = $find;
                 }
             }
+            if ($ignorespaces !== true) {
+                $txt = preg_replace("#(^|[^a-z])(".preg_quote($find).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+            }
         }
     }
+
     return $txt;
 }
 
@@ -127,6 +289,7 @@
             $txt = str_replace($code, '<img src="./'.$smdir.'/'.$url.'" style="border:none" alt="'.$code.'" />', $txt);
         }
     }
+
     return $txt;
 }
 
@@ -143,7 +306,9 @@
             $cachedFs[1] = 'px';
         }
     }
+
     $o = ($rel+$cachedFs[0]).$cachedFs[1];
+
     return $o;
 }
 
@@ -170,49 +335,44 @@
 }
 
 function postify($message, $smileyoff='no', $bbcodeoff='no', $allowsmilies='yes', $allowhtml='yes', $allowbbcode='yes', $allowimgcode='yes', $ignorespaces=false, $ismood="no", $wrap="yes") {
-    global $imgdir, $bordercolor, $db, $smdir, $smiliecache, $censorcache, $smiliesnum, $wordsnum, $versionbuild, $lang, $fontsize;
+    global $imgdir, $bordercolor, $db, $smdir, $smiliecache, $censorcache, $smiliesnum, $wordsnum, $versionbuild, $fontsize;
 
-    $message = checkOutput($message, $allowhtml, '', true);
-    $message = censor($message, $ignorespaces);
-
     $bballow = ($allowbbcode == 'yes' || $allowbbcode == 'on') ? (($bbcodeoff != 'off' && $bbcodeoff != 'yes') ? true : false) : false;
     $smiliesallow = ($allowsmilies == 'yes' || $allowsmilies == 'on') ? (($smileyoff != 'off' && $smileyoff != 'yes') ? true : false) : false;
 
     if ($bballow) {
-        $message = stripslashes($message);
-
         if ($ismood == 'yes') {
-            $message = str_replace(array('[quote]', '[/quote]', '[code]', '[/code]', '[list]', '[/list]', '[list=1]', '[list=a]', '[list=A]', '[/list=1]', '[/list=a]', '[/list=A]'), '', $message);
+            $message = str_replace(array('[quote]', '[/quote]', '[code]', '[/code]', '[list]', '[/list]', '[list=1]', '[list=a]', '[list=A]', '[/list=1]', '[/list=a]', '[/list=A]', '[*]'), '_', $message);
         }
 
         $begin = array(
-                0 => '[b]',
-                1 => '[i]',
-                2 => '[u]',
-                3 => '[marquee]',
-                4 => '[blink]',
-                5 => '[strike]',
-                6 => '[quote]',
-                7 => '[code]',
-                8 => '[list]',
-                9 => '[list=1]',
-                10 => '[list=a]',
-                11 => '[list=A]',
+            0 => '[b]',
+            1 => '[i]',
+            2 => '[u]',
+            3 => '[marquee]',
+            4 => '[blink]',
+            5 => '[strike]',
+            6 => '[quote]',
+            7 => '[code]',
+            8 => '[list]',
+            9 => '[list=1]',
+            10 => '[list=a]',
+            11 => '[list=A]',
         );
 
         $end = array(
-                0 => '[/b]',
-                1 => '[/i]',
-                2 => '[/u]',
-                3 => '[/marquee]',
-                4 => '[/blink]',
-                5 => '[/strike]',
-                6 => '[/quote]',
-                7 => '[/code]',
-                8 => '[/list]',
-                9 => '[/list=1]',
-                10 => '[/list=a]',
-                11 => '[/list=A]',
+            0 => '[/b]',
+            1 => '[/i]',
+            2 => '[/u]',
+            3 => '[/marquee]',
+            4 => '[/blink]',
+            5 => '[/strike]',
+            6 => '[/quote]',
+            7 => '[/code]',
+            8 => '[/list]',
+            9 => '[/list=1]',
+            10 => '[/list=a]',
+            11 => '[/list=A]',
         );
 
         foreach($begin as $key=>$value) {
@@ -224,147 +384,47 @@
             }
         }
 
-        $find = array(
-                0 => '[b]',
-                1 => '[/b]',
-                2 => '[i]',
-                3 => '[/i]',
-                4 => '[u]',
-                5 => '[/u]',
-                6 => '[marquee]',
-                7 => '[/marquee]',
-                8 => '[blink]',
-                9 => '[/blink]',
-                10 => '[strike]',
-                11 => '[/strike]',
-                12 => '[quote]',
-                13 => '[/quote]',
-                14 => '[code]',
-                15 => '[/code]',
-                16 => '[list]',
-                17 => '[/list]',
-                18 => '[list=1]',
-                19 => '[list=a]',
-                20 => '[list=A]',
-                21 => '[/list=1]',
-                22 => '[/list=a]',
-                23 => '[/list=A]',
-                24 => '[*]',
-                25 => '<br />'
-        );
-
-        $replace = array(
-                0 => '<strong>',
-                1 => '</strong>',
-                2 => '<em>',
-                3 => '</em>',
-                4 => '<u>',
-                5 => '</u>',
-                6 => '<marquee>',
-                7 => '</marquee>',
-                8 => '<blink>',
-                9 => '</blink>',
-                10 => '<strike>',
-                11 => '</strike>',
-                12 => '</font><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage">',
-                13 => ' </td></tr></table><font class="mediumtxt">',
-                14 => '</font><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr><tr><td class="codemessage">',
-                15 => '</td></tr></table><font class="mediumtxt">',
-                16 => '<ul type="square">',
-                17 => '</ul>',
-                18 => '<ol type="1">',
-                19 => '<ol type="A">',
-                20 => '<ol type="A">',
-                21 => '</ol>',
-                22 => '</ol>',
-                23 => '</ol>',
-                24 => '<li />',
-                25 => '<br />'
-        );
-
-        if ($smiliesallow) {
-            $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
-            for($i = 0; $i < sizeof($messagearray); $i++) {
-                if (sizeof($messagearray) != 1) {
-                    if ($i == 0) {
-                        $messagearray[$i] = $messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i == sizeof($messagearray) - 1) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i];
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i % 2 == 0) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
+        $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
+        for($i = 0; $i < sizeof($messagearray); $i++) {
+            if (sizeof($messagearray) != 1) {
+                if ($i == 0) {
+                    $messagearray[$i] = rawHTMLmessage($messagearray[$i], $allowhtml)."[code]";
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
                     }
+                } else if ($i == sizeof($messagearray) - 1) {
+                    $messagearray[$i] = "[/code]".rawHTMLmessage($messagearray[$i], $allowhtml);
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                    }
+                } else if ($i % 2 == 0) {
+                    $messagearray[$i] = "[/code]".rawHTMLmessage($messagearray[$i], $allowhtml)."[code]";
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                    }
+                } else { // Inside code block
+                    $messagearray[$i] = censor($messagearray[$i]);
+                }
+            } else {
+                $messagearray[0] = rawHTMLmessage($messagearray[0], $allowhtml);
+                if ($smiliesallow) {
+                    $messagearray[0] = bbcode(smile($messagearray[0]), $allowimgcode);
                 } else {
-                    $messagearray[0] = smile($messagearray[0]);
+                    $messagearray[0] = bbcode($messagearray[0], $allowimgcode);
                 }
             }
-            $message = implode("", $messagearray);
         }
-
-        $message = str_replace($find, $replace, $message);
-
-        $patterns = array();
-        $replacements = array();
-
-        $patterns[] = "#\[color=([^\"'<>]*?)\](.*?)\[/color\]#Ssi";
-        $replacements[] = '<span style="color: $1;">$2</span>';
-        $patterns[] = "#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssie";
-        $replacements[] = '"<span style=\"font-size: ".createAbsFSizeFromRel(\'$1\').";\">".stripslashes(\'$2\')."</span>"';
-        $patterns[] = "#\[font=([a-z\r\n\t 0-9]+)\](.*?)\[/font\]#Ssi";
-        $replacements[] = '<span style="font-family: $1;">$2</span>';
-        $patterns[] = "#\[align=(left|center|right|justify)\](.+?)\[/align\]#Ssi";
-        $replacements[] = '<div style="text-align: $1;">$2</div>';
-
-        if ($allowimgcode != 'no' && $allowimgcode != 'off') {
-            if (false == strpos($message, 'javascript:')) {
-                $patterns[] = '#\[img\](http[s]?|ftp[s]?){1}://([:a-z\\./_\-0-9%~]+){1}\[/img\]#Smi';
-                $replacements[] = '<img src="\1://\2\3" border="0" alt="\1://\2\3"/>';
-                $patterns[] = "#\[img=([0-9]*?){1}x([0-9]*?)\](http[s]?|ftp[s]?){1}://([:~a-z\\./0-9_\-%]+){1}(\?[a-z=0-9&_\-;~]*)?\[/img\]#Smi";
-                $replacements[] = '<img width="\1" height="\2" src="\3://\4\5" alt="\3://\4\5" border="0" />';
-                $patterns[] = "#\[flash=([0-9]*?){1}x([0-9]*?)\]([^\"'<>]*?)\[/flash\]#Ssi";
-                $replacements[] = '<object type="application/x-shockwave-flash" data="$3" width="$1" height="$2"><param name="movie" value="$3" /><param name="AllowScriptAccess" value="never" /></object>';
-            }
-        }
-
-        $message = preg_replace_callback('#(^|\s|\()((((http(s?)|ftp(s?))://)|www)[-a-z0-9.]+\.[a-z]{2,4}[^\s()]*)i?#Smi', 'fixUrl', $message);
-
-        $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]*?)\[/url\]#Smi";
-        $replacements[] = '<a href="\1\2" target="_blank">\1\2</a>';
-        $patterns[] = "#\[url\]([^\[\"'<>]*?)\[/url\]#Smi";
-        $replacements[] = '<a href="http://\1" target="_blank">\1</a>';
-        $patterns[] = "#\[url=([a-z]+?://){1}([^\"'<>\[\]]*?)\](.*?)\[/url\]#Smi";
-        $replacements[] = '<a href="\1\2" target="_blank">\3</a>';
-        $patterns[] = "#\[url=([^\[\"'<>]*?)\](.*?)\[/url\]#Smi";
-        $replacements[] = '<a href="http://\1" target="_blank">\2</a>';
-        $patterns[] = "#\[email\]([^\"'<>]*?)\[/email\]#Smi";
-        $replacements[] = '<a href="mailto:\1">\1</a>';
-        $patterns[] = "#\[email=([^\"'<>]*?){1}([^\"]*?)\](.*?)\[/email\]#Smi";
-        $replacements[] = '<a href="mailto:\1\2">\3</a>';
-
-        $message = preg_replace($patterns, $replacements, $message);
-        $message = addslashes($message);
+        $message = implode("", $messagearray);
     } else {
+        $message = rawHTMLmessage($message, $allowhtml);
         if ($smiliesallow) {
-            $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
-            for($i = 0; $i < sizeof($messagearray); $i++) {
-                if (sizeof($messagearray) != 1) {
-                    if ($i == 0) {
-                        $messagearray[$i] = $messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i == sizeof($messagearray) - 1) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i];
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i % 2 == 0) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    }
-                } else {
-                    $messagearray[0] = smile($messagearray[0]);
-                }
-            }
-            $message = implode("", $messagearray);
+            smile($message);
         }
     }
 
@@ -373,18 +433,120 @@
         $message = wordwrap($message, 150, "\n", 1);
         $message = preg_replace('#(\[/?.*)\n(.*\])#mi', '\\1\\2', $message);
     }
+
     $message = preg_replace('#(script|about|applet|activex|chrome):#Sis',"\\1 &#058;",$message);
+
     return $message;
 }
 
-function modcheck($status, $username, $mods) {
+function bbcode($message, $allowimgcode) {
+    global $lang;
 
-    if (X_ADMIN || in_array($status, array('Super Moderator'))) {
-        return 'Moderator';
+    $find = array(
+        0 => '[b]',
+        1 => '[/b]',
+        2 => '[i]',
+        3 => '[/i]',
+        4 => '[u]',
+        5 => '[/u]',
+        6 => '[marquee]',
+        7 => '[/marquee]',
+        8 => '[blink]',
+        9 => '[/blink]',
+        10 => '[strike]',
+        11 => '[/strike]',
+        12 => '[quote]',
+        13 => '[/quote]',
+        14 => '[code]',
+        15 => '[/code]',
+        16 => '[list]',
+        17 => '[/list]',
+        18 => '[list=1]',
+        19 => '[list=a]',
+        20 => '[list=A]',
+        21 => '[/list=1]',
+        22 => '[/list=a]',
+        23 => '[/list=A]',
+        24 => '[*]',
+        25 => '<br />'
+    );
+
+    $replace = array(
+        0 => '<strong>',
+        1 => '</strong>',
+        2 => '<em>',
+        3 => '</em>',
+        4 => '<u>',
+        5 => '</u>',
+        6 => '<marquee>',
+        7 => '</marquee>',
+        8 => '<blink>',
+        9 => '</blink>',
+        10 => '<strike>',
+        11 => '</strike>',
+        12 => '</font><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage">',
+        13 => ' </td></tr></table><font class="mediumtxt">',
+        14 => '</font><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr>'."\n".'<tr><td class="codemessage">',
+        15 => '</td></tr></table><font class="mediumtxt">',
+        16 => '<ul type="square">',
+        17 => '</ul>',
+        18 => '<ol type="1">',
+        19 => '<ol type="A">',
+        20 => '<ol type="A">',
+        21 => '</ol>',
+        22 => '</ol>',
+        23 => '</ol>',
+        24 => '<li />',
+        25 => '<br />'
+    );
+
+    $message = str_replace($find, $replace, $message);
+
+    $patterns = array();
+    $replacements = array();
+
+    $patterns[] = "#\[color=([^\"'<>]*?)\](.*?)\[/color\]#Ssi";
+    $replacements[] = '<span style="color: $1;">$2</span>';
+    $patterns[] = "#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssie";
+    $replacements[] = '"<span style=\"font-size: ".createAbsFSizeFromRel(\'$1\').";\">".stripslashes(\'$2\')."</span>"';
+    $patterns[] = "#\[font=([a-z\r\n\t 0-9]+)\](.*?)\[/font\]#Ssi";
+    $replacements[] = '<span style="font-family: $1;">$2</span>';
+    $patterns[] = "#\[align=(left|center|right|justify)\](.+?)\[/align\]#Ssi";
+    $replacements[] = '<div style="text-align: $1;">$2</div>';
+
+    if ($allowimgcode != 'no' && $allowimgcode != 'off') {
+        if (false == stripos($message, 'javascript:')) {
+            $patterns[] = '#\[img\](http[s]?|ftp[s]?){1}://([:a-z\\./_\-0-9%~]+){1}\[/img\]#Smi';
+            $replacements[] = '<img src="\1://\2\3" border="0" alt="\1://\2\3"/>';
+            $patterns[] = "#\[img=([0-9]*?){1}x([0-9]*?)\](http[s]?|ftp[s]?){1}://([:~a-z\\./0-9_\-%]+){1}(\?[a-z=0-9&_\-;~]*)?\[/img\]#Smi";
+            $replacements[] = '<img width="\1" height="\2" src="\3://\4\5" alt="\3://\4\5" border="0" />';
+        }
     }
 
+    $message = preg_replace_callback('#(^|\s|\()((((http(s?)|ftp(s?))://)|www)[-a-z0-9.]+\.[a-z]{2,4}[^\s()]*)i?#Smi', 'fixUrl', $message);
+
+    $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]*?)\[/url\]#Smi";
+    $replacements[] = '<a href="\1\2" target="_blank">\1\2</a>';
+    $patterns[] = "#\[url\]([^\[\"'<>]*?)\[/url\]#Smi";
+    $replacements[] = '<a href="http://\1" target="_blank">\1</a>';
+    $patterns[] = "#\[url=([a-z]+?://){1}([^\"'<>\[\]]*?)\](.*?)\[/url\]#Smi";
+    $replacements[] = '<a href="\1\2" target="_blank">\3</a>';
+    $patterns[] = "#\[url=([^\[\"'<>]*?)\](.*?)\[/url\]#Smi";
+    $replacements[] = '<a href="http://\1" target="_blank">\2</a>';
+    $patterns[] = "#\[email\]([^\"'<>]*?)\[/email\]#Smi";
+    $replacements[] = '<a href="mailto:\1">\1</a>';
+    $patterns[] = "#\[email=([^\"'<>]*?){1}([^\"]*?)\](.*?)\[/email\]#Smi";
+    $replacements[] = '<a href="mailto:\1\2">\3</a>';
+
+    return preg_replace($patterns, $replacements, $message);
+}
+
+function modcheck($username, $mods) {
+
     $retval = '';
-    if ($status == 'Moderator') {
+    if (X_SMOD) {
+        $retval = 'Moderator';
+    } else if (X_MOD) {
         $username = strtoupper($username);
         $mods = explode(',', $mods);
         foreach($mods as $key=>$moderator) {
@@ -394,60 +556,50 @@
             }
         }
     }
+
     return $retval;
 }
 
-function privfcheck($private, $userlist) {
-    global $self, $xmbuser;
+function modcheckPost($username, $mods, $origstatus) {
+    global $SETTINGS;
+    $retval = modcheck($username, $mods);
 
-    if (X_SADMIN) {
-        return true;
+    if ($retval != '' And $SETTINGS['allowrankedit'] != 'off') {
+        switch($origstatus) {
+            case 'Super Administrator':
+                if (!X_SADMIN) {
+                    $retval = '';
+                }
+                break;
+            case 'Administrator':
+                if (!X_ADMIN) {
+                    $retval = '';
+                }
+                break;
+            case 'Super Moderator':
+                if (!X_SMOD) {
+                    $retval = '';
+                }
+                break;
+            //If member does not have X_MOD then modcheck() returned a null string.  No reason to continue testing.
+        }
     }
 
-    switch($private) {
-        case 4:
-            return false;
-            break;
-        case 3:
-            return X_STAFF;
-            break;
-        case 2:
-            return X_ADMIN;
-            break;
-        case 1:
-            if (trim($userlist) == '') {
-                return true;
-            }
-
-            $user = explode(',', $userlist);
-            $xuser = strtolower($xmbuser);
-            foreach($user as $usr) {
-                $usr = strtolower(trim($usr));
-                if ($usr != '' && $xuser == $usr) {
-                   return true;
-                }
-            }
-            return false;
-            break;
-        default:
-            return false;
-            break;
-    }
-    return false;
+    return $retval;
 }
 
 function forum($forum, $template) {
     global $timecode, $dateformat, $lang, $xmbuser, $self, $lastvisit2, $timeoffset, $hideprivate, $addtime, $oldtopics, $lastvisit;
     global $altbg1, $altbg2, $imgdir, $THEME, $SETTINGS, $index_subforums;
 
-    $forum['name'] = html_entity_decode($forum['name']);
+    $forum['name'] = fnameOut($forum['name']);
     $forum['description'] = html_entity_decode($forum['description']);
 
     if (isset($forum['moderator']) && $forum['lastpost'] != '') {
         $lastpost = explode('|', $forum['lastpost']);
         $dalast = $lastpost[0];
         if ($lastpost[1] != 'Anonymous' && $lastpost[1] != '') {
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         } else {
             $lastpost[1] = $lang['textanonymous'];
         }
@@ -475,12 +627,13 @@
     }
 
     $foruminfo = '';
-    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || privfcheck($forum['private'], $forum['userlist'])) {
+    $perms = checkForumPermissions($forum);
+    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
         if (isset($forum['moderator']) && $forum['moderator'] != '') {
             $moderators = explode(', ', $forum['moderator']);
             $forum['moderator'] = array();
             for($num = 0; $num < count($moderators); $num++) {
-                $forum['moderator'][] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($moderators[$num]).'">'.$moderators[$num].'</a>';
+                $forum['moderator'][] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($moderators[$num]).'">'.$moderators[$num].'</a>';
             }
             $forum['moderator'] = implode(', ', $forum['moderator']);
             $forum['moderator'] = '('.$lang['textmodby'].' '.$forum['moderator'].')';
@@ -490,9 +643,10 @@
         if (count($index_subforums) > 0) {
             for($i=0; $i < count($index_subforums); $i++) {
                 $sub = $index_subforums[$i];
+                $subperms = checkForumPermissions($sub);
                 if ($sub['fup'] == $forum['fid']) {
-                    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || privfcheck($sub['private'], $sub['userlist'])) {
-                        $subforums[] = '<a href="forumdisplay.php?fid='.intval($sub['fid']).'">'.html_entity_decode(stripslashes($sub['name'])).'</a>';
+                    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $subperms[X_PERMS_VIEW] || $subperms[X_PERMS_USERLIST]) {
+                        $subforums[] = '<a href="forumdisplay.php?fid='.intval($sub['fid']).'">'.fnameOut($sub['name']).'</a>';
                     }
                 }
             }
@@ -504,9 +658,11 @@
         } else {
             $subforums = '';
         }
-        eval('$foruminfo = stripslashes("'.template($template).'");');
+        eval('$foruminfo = "'.template($template).'";');
     }
+
     $dalast = '';
+
     return $foruminfo;
 }
 
@@ -570,6 +726,7 @@
     } else if ($strict !== true) {
         return false;
     }
+
     return $multipage;
 }
 
@@ -592,10 +749,11 @@
             $querysmilie = $db->query("SELECT * FROM ".X_PREFIX."smilies WHERE type='smiley' ORDER BY code DESC LIMIT 0, ".$smtotal);
         }
 
-        if (($smilienum = $db->num_rows($querysmilie)) > 0){
+        if (($smilienum = $db->num_rows($querysmilie)) > 0) {
             while($smilie = $db->fetch_array($querysmilie)) {
                 eval('$sms[] = "'.template('functions_smilieinsert_smilie').'";');
             }
+            $db->free_result($querysmilie);
 
             $smilies = '<tr>';
             for($i=0;$i<count($sms);$i++) {
@@ -620,36 +778,23 @@
             $smilieinsert = '';
         }
     }
+
     return $smilieinsert;
 }
 
 function updateforumcount($fid) {
     global $db;
+    $fid = intval($fid);
 
-    $postcount = 0;
-    $threadcount = 0;
-
-    $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE fid='$fid'");
+    $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."posts USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
     $postcount = $db->result($query, 0);
     $db->free_result($query);
 
-    $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."threads WHERE (fid='$fid' AND closed!='moved')");
+    $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."threads USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
     $threadcount = $db->result($query, 0);
     $db->free_result($query);
 
-    $query = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$fid'");
-    while($children = $db->fetch_array($query)) {
-        $chquery1 = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE fid='$children[fid]'");
-        $postcount += $db->result($chquery1, 0);
-        $db->free_result($chquery1);
-
-        $chquery2 = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."threads WHERE fid='$children[fid]' AND closed!='moved'");
-        $threadcount += $db->result($chquery2, 0);
-        $db->free_result($chquery2);
-    }
-    $db->free_result($query);
-
-    $query = $db->query("SELECT t.lastpost FROM ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE (t.fid=f.fid AND f.fid='$fid') OR (t.fid=f.fid AND f.fup='$fid') ORDER BY t.lastpost DESC LIMIT 0, 1");
+    $query = $db->query("SELECT t.lastpost FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."threads AS t USING(fid) WHERE f.fid=$fid OR f.fup=$fid ORDER BY t.lastpost DESC LIMIT 0, 1");
     $lp = $db->fetch_array($query);
     $db->query("UPDATE ".X_PREFIX."forums SET posts='$postcount', threads='$threadcount', lastpost='$lp[lastpost]' WHERE fid='$fid'");
     $db->free_result($query);
@@ -701,9 +846,11 @@
         $cached = true;
         return true;
     }
+
     return false;
 }
 
+/* checkInput() is deprecated */
 function checkInput($input, $striptags='no', $allowhtml='no', $word='', $no_quotes=true) {
     $input = trim($input);
     if ($striptags == 'yes') {
@@ -719,26 +866,12 @@
     }
 
     if ($word != '') {
-        $input = str_replace($word, "_".$word, $input);
+        $input = str_ireplace($word, "_".$word, $input);
     }
+
     return $input;
 }
 
-function checkOutput($output, $allowhtml='no', $word='', $allowEntities=false) {
-    $output = trim($output);
-    if ($allowhtml == 'yes' || $allowhtml == 'on') {
-        $output = htmlspecialchars_decode($output);
-    }
-    if ($word != '') {
-        $output = str_replace($word, "_".$word, $output);
-    }
-
-    if ($allowEntities) {
-        $output = preg_replace('/(&amp;(#[0-9]+);)/Ui', '&$2;', $output);
-    }
-    return $output;
-}
-
 if (!function_exists('htmlspecialchars_decode')) {
     function htmlspecialchars_decode($string, $type=ENT_QUOTES) {
         $array = array_flip(get_html_translation_table(HTML_SPECIALCHARS, $type));
@@ -813,28 +946,6 @@
     return $footerstuff;
 }
 
-function pwverify($pass='', $url, $fid, $showHeader=false) {
-    global $self, $cookiepath, $cookiedomain, $lang;
-
-    if (X_SADMIN) {
-        return true;
-    }
-
-    $pwform = '';
-    if (trim($pass) != '' && $_COOKIE['fidpw'.$fid] != $pass) {
-        if ($_POST['pw'] != $pass) {
-            extract($GLOBALS);
-            eval('$pwform = "'.template('forumdisplay_password').'";');
-            error(((isset($_POST['pw'])) ? $lang['invalidforumpw'] : $lang['forumpwinfo']), $showHeader, '', $pwform, false, true, false, true);
-        } else {
-            put_cookie("fidpw$fid", $pass, (time() + (86400*30)), $cookiepath, $cookiedomain);
-            redirect($url, 0);
-        }
-        exit();
-    }
-    return true;
-}
-
 function redirect($path, $timeout=2, $type=X_REDIRECT_HEADER) {
     if (strpos(urldecode($path), "\n") !== false || strpos(urldecode($path), "\r") !== false) {
         error('Tried to redirect to potentially insecure url.');
@@ -856,95 +967,13 @@
         if ($timeout == 0) {
             header("Location: $path");
         } else {
-            header("Refresh: $timeout; URL=./$path");
+            header("Refresh: $timeout; URL=$path");
         }
     }
+
     return true;
 }
 
-function postperm(& $forums, $type) {
-    global $lang, $self, $whopost1, $whopost2;
-    static $cache;
-
-    if (!isset($forums['postperm'])) {
-        return false;
-    }
-
-    $pperm = explode('|', $forums['postperm']);
-    if (!isset($cache[$forums['fid']])) {
-        switch($pperm[0]) {
-            case 1:
-                $whopost1 = $lang['whocanpost11'];
-                break;
-            case 2:
-                $whopost1 = $lang['whocanpost12'];
-                break;
-            case 3:
-                $whopost1 = $lang['whocanpost13'];
-                break;
-            case 4:
-                $whopost1 = $lang['whocanpost14'];
-                break;
-        }
-
-        switch($pperm[1]) {
-            case 1:
-                $whopost2 = $lang['whocanpost21'];
-                break;
-            case 2:
-                $whopost2 = $lang['whocanpost22'];
-                break;
-            case 3:
-                $whopost2 = $lang['whocanpost23'];
-                break;
-            case 4:
-                $whopost2 = $lang['whocanpost24'];
-                break;
-        }
-        $cache[$forums['fid']] = true;
-    }
-
-    if (X_SADMIN) {
-        return true;
-    }
-
-    $perm = ($type == 'thread') ? $pperm[0] : $pperm[1];
-    switch($forums['private']) {
-        case 1:
-            $fplen = isset($forums['password']) ? strlen($forums['password']) : 0;
-            $fulen = isset($forums['userlist']) ? strlen($forums['userlist']) : 0;
-            if (($fplen > 1 || $fulen > 1) && privfcheck($forums['private'], $forums['userlist'])) {
-                return true;
-            }
-
-            if (!X_STAFF) {
-                if ($perm == 1) {
-                    return true;
-                }
-                break;
-            }
-        case 3:
-            if (!X_ADMIN) {
-                if ($perm == 1 || $perm == 3) {
-                    return true;
-                }
-                break;
-            }
-        case 2:
-            if ($perm < 4) {
-                return true;
-            }
-            break;
-        case 4:
-            return false;
-            break;
-        default:
-            return false;
-            break;
-    }
-    return false;
-}
-
 function get_extension($filename) {
     $a = explode('.', $filename);
     $count = count($a);
@@ -963,6 +992,7 @@
     $filesize = 0;
 
     if ($file['name'] != 'none' && !empty($file['name']) && $attachstatus != 'off' && is_uploaded_file($file['tmp_name'])) {
+        $file['name'] = trim($file['name']);
         if (!isValidFilename($file['name'])) {
             error($lang['invalidFilename'], false, '', '', false, false, false, false);
             return false;
@@ -974,9 +1004,8 @@
             return false;
         } else {
             $attachment = addslashes(fread(fopen($file['tmp_name'], 'rb'), filesize($file['tmp_name'])));
-            $filename = $file['name'];
-            $filetype = $file['type'];
-            $filesize = $file['size'];
+            $filename = addslashes($file['name']);
+            $filetype = addslashes(preg_replace('#[\r\n%]#', '', $file['type']));
 
             if ($filesize == 0) {
                 return false;
@@ -1058,6 +1087,7 @@
     if ($die) {
         exit();
     }
+
     return $return;
 }
 
@@ -1117,6 +1147,7 @@
     if ($die) {
         exit();
     }
+
     return $return;
 }
 
@@ -1131,6 +1162,7 @@
         }
         $new_array[$new_key] = $val;
     }
+
     return $new_array;
 }
 
@@ -1168,6 +1200,7 @@
     foreach($find as $key=>$val) {
         $replace[$key] = '</em><strong>'.$val.'</strong><em>';
     }
+
     return '<em>'.str_replace($find, $replace, $query).'</em>';
 }
 
@@ -1340,6 +1373,7 @@
             if (!$toInHeader) {
                 $additional_headers[] = 'To: '.$to;
             }
+
             $additional_headers = implode("\r\n", $additional_headers);
 
             return $mail->sendMessage($SETTINGS['adminemail'], $to, $message, $additional_headers);
@@ -1393,7 +1427,7 @@
 }
 
 function printGmTime($timestamp=null, $altFormat=null, $altOffset=0) {
-    global $self, $SETTINGS, $timeoffset, $addtime;
+    global $self, $SETTINGS, $timeoffset, $addtime, $timecode;
 
     if ($timestamp === null) {
         $timestamp = time();
@@ -1444,6 +1478,7 @@
            $objArgs[5] += 28;
        }
    }
+
    return call_user_func_array("mktime", $objArgs) + $nOffset;
 }
 
@@ -1467,6 +1502,7 @@
     if ($day > 31 || $day < 1) {
         $day = 1;
     }
+
     return $year.'-'.str_pad($month, 2, 0, STR_PAD_LEFT).'-'.str_pad($day, 2, 0, STR_PAD_LEFT);
 }
 
@@ -1477,6 +1513,7 @@
     if ($num < 1 || $num > 12) {
         $num = 1;
     }
+
     $months = array(
         $lang['textjan'],
         $lang['textfeb'],
@@ -1491,75 +1528,55 @@
         $lang['textnov'],
         $lang['textdec']
     );
+
     return $months[$num-1];
 }
 
 function forumList($selectname='srchfid', $multiple=false, $allowall=true, $currentfid=0) {
-    global $db, $self, $lang;
+    global $db, $self, $lang, $SETTINGS;
 
-    $restrict = array();
-    switch($self['status']) {
-        case 'Member':
-            $restrict[] = "private != '3'";
-        case 'Moderator':
-        case 'Super Moderator':
-            $restrict[] = "private != '2'";
-        case 'Administrator':
-            $restrict[] = "userlist = ''";
-        case 'Super Administrator':
-            break;
-        default:
-            $restrict[] = "private != '3'";
-            $restrict[] = "private != '2'";
-            $restrict[] = "userlist = ''";
-            $restrict[] = "password = ''";
-            break;
-    }
-    $restrict = implode(' AND ', $restrict);
+    $query = $db->query("SELECT f.* FROM ".X_PREFIX."forums f WHERE f.status='on' ORDER BY f.displayorder ASC");
 
-    if ($restrict != '') {
-        $sql = $db->query("SELECT fid, type, name, fup, status, private, userlist, password FROM ".X_PREFIX."forums WHERE $restrict AND status='on' ORDER BY displayorder");
-    } else {
-        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password FROM ".X_PREFIX."forums ORDER BY displayorder");
-    }
-
     $standAloneForums = array();
     $forums = array();
     $categories = array();
     $subforums = array();
-    while($forum = $db->fetch_array($sql)) {
-        $forum['name'] = html_entity_decode($forum['name']);
-        if (!X_SADMIN && $forum['password'] != '') {
-            $fidpw = isset($_COOKIE['fidpw'.$forum['fid']]) ? trim($_COOKIE['fidpw'.$forum['fid']]) : '';
-            if ($forum['password'] !== $fidpw) {
-                continue;
+    while($forum = $db->fetch_array($query)) {
+        $perms = checkForumPermissions($forum);
+        if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $forum['type'] == 'group' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
+            $forum['name'] = fnameOut($forum['name']);
+            if (!X_SADMIN && $forum['password'] != '') {
+                $fidpw = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
+                if ($forum['password'] !== $fidpw) {
+                    continue;
+                }
             }
-        }
 
-        switch($forum['type']) {
-            case 'group':
-                $categories[] = $forum;
-                break;
-            case 'sub':
-                if (!isset($subforums[$forum['fup']])) {
-                    $subforums[$forum['fup']] = array();
-                }
-                $subforums[$forum['fup']][] = $forum;
-                break;
-            case 'forum':
-            default:
-                if ($forum['fup'] == 0) {
-                    $standAloneForums[] = $forum;
-                } else {
-                    if (!isset($forums[$forum['fup']])) {
-                        $forums[$forum['fup']] = array();
+            switch($forum['type']) {
+                case 'group':
+                    $categories[] = $forum;
+                    break;
+                case 'sub':
+                    if (!isset($subforums[$forum['fup']])) {
+                        $subforums[$forum['fup']] = array();
                     }
-                    $forums[$forum['fup']][] = $forum;
-                }
-                break;
+                    $subforums[$forum['fup']][] = $forum;
+                    break;
+                case 'forum':
+                default:
+                    if ($forum['fup'] == 0) {
+                        $standAloneForums[] = $forum;
+                    } else {
+                        if (!isset($forums[$forum['fup']])) {
+                            $forums[$forum['fup']] = array();
+                        }
+                        $forums[$forum['fup']][] = $forum;
+                    }
+                    break;
+            }
         }
     }
-    $db->free_result($sql);
+    $db->free_result($query);
 
     $forumselect = array();
     if (!$multiple) {
@@ -1578,10 +1595,10 @@
     reset($forums);
 
     foreach($standAloneForums as $forum) {
-        $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.stripslashes($forum['name']).'</option>';
+        $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.$forum['name'].'</option>';
         if (isset($subforums[$forum['fid']])) {
             foreach($subforums[$forum['fid']] as $sub) {
-                $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.stripslashes($sub['name']).'</option>';
+                $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
             }
         }
     }
@@ -1589,12 +1606,12 @@
     $forumselect[] = '<option value="0" disabled="disabled">&nbsp;</option>';
     foreach($categories as $group) {
         if (isset($forums[$group['fid']]) && count($forums[$group['fid']]) > 0) {
-            $forumselect[] = '<option value="'.intval($group['fid']).'" disabled="disabled">'.stripslashes($group['name']).'</option>';
+            $forumselect[] = '<option value="'.intval($group['fid']).'" disabled="disabled">'.$group['name'].'</option>';
             foreach($forums[$group['fid']] as $forum) {
-                $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.stripslashes($forum['name']).'</option>';
+                $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.$forum['name'].'</option>';
                 if (isset($subforums[$forum['fid']])) {
                     foreach($subforums[$forum['fid']] as $sub) {
-                        $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.stripslashes($sub['name']).'</option>';
+                        $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
                     }
                 }
             }
@@ -1619,71 +1636,50 @@
 }
 
 function forumJump() {
-    global $db, $self, $lang;
+    global $db, $self, $lang, $SETTINGS;
 
-    $restrict = array();
-    switch($self['status']) {
-        case 'Member':
-            $restrict[] = "private != '3'";
-        case 'Moderator':
-        case 'Super Moderator':
-            $restrict[] = "private != '2'";
-        case 'Administrator':
-            $restrict[] = "userlist = ''";
-        case 'Super Administrator':
-            break;
-        default:
-            $restrict[] = "private != '3'";
-            $restrict[] = "private != '2'";
-            $restrict[] = "userlist = ''";
-            $restrict[] = "password = ''";
-            break;
-    }
-    $restrict = implode(' AND ', $restrict);
+    $query = $db->query("SELECT f.* FROM ".X_PREFIX."forums f WHERE f.status='on' ORDER BY f.displayorder ASC");
 
-    if ($restrict != '') {
-        $sql = $db->query("SELECT fid, type, name, fup, status, private, userlist, password, displayorder FROM ".X_PREFIX."forums WHERE $restrict AND status='on' ORDER BY displayorder");
-    } else {
-        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password, displayorder FROM ".X_PREFIX."forums ORDER BY displayorder");
-    }
-
     $standAloneForums = array();
     $forums = array();
     $categories = array();
     $subforums = array();
-    while($forum = $db->fetch_array($sql)) {
-        $forum['name'] = html_entity_decode($forum['name']);
-        if (!X_SADMIN && $forum['password'] != '') {
-            $fidpw = isset($_COOKIE['fidpw'.$forum['fid']]) ? trim($_COOKIE['fidpw'.$forum['fid']]) : '';
-            if ($forum['password'] !== $fidpw) {
-                continue;
+    while($forum = $db->fetch_array($query)) {
+        $perms = checkForumPermissions($forum);
+        if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $forum['type'] == 'group' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
+            $forum['name'] = fnameOut($forum['name']);
+            if (!X_SADMIN && $forum['password'] != '') {
+                $fidpw = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
+                if ($forum['password'] !== $fidpw) {
+                    continue;
+                }
             }
-        }
 
-        switch($forum['type']) {
-            case 'group':
-                $categories[] = $forum;
-                break;
-            case 'sub':
-                if (!isset($subforums[$forum['fup']])) {
-                    $subforums[$forum['fup']] = array();
-                }
-                $subforums[$forum['fup']][] = $forum;
-                break;
-            case 'forum':
-            default:
-                if ($forum['fup'] == 0) {
-                    $standAloneForums[] = $forum;
-                } else {
-                    if (!isset($forums[$forum['fup']])) {
-                        $forums[$forum['fup']] = array();
+            switch($forum['type']) {
+                case 'group':
+                    $categories[] = $forum;
+                    break;
+                case 'sub':
+                    if (!isset($subforums[$forum['fup']])) {
+                        $subforums[$forum['fup']] = array();
                     }
-                    $forums[$forum['fup']][] = $forum;
-                }
-                break;
+                    $subforums[$forum['fup']][] = $forum;
+                    break;
+                case 'forum':
+                default:
+                    if ($forum['fup'] == 0) {
+                        $standAloneForums[] = $forum;
+                    } else {
+                        if (!isset($forums[$forum['fup']])) {
+                            $forums[$forum['fup']] = array();
+                        }
+                        $forums[$forum['fup']][] = $forum;
+                    }
+                    break;
+            }
         }
     }
-    $db->free_result($sql);
+    $db->free_result($query);
 
     $forumselect = array();
 
@@ -1694,10 +1690,10 @@
     reset($forums);
 
     foreach($standAloneForums as $forum) {
-        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.stripslashes($forum['name']).'</option>';
+        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.$forum['name'].'</option>';
         if (isset($subforums[$forum['fid']])) {
             foreach($subforums[$forum['fid']] as $sub) {
-                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.stripslashes($sub['name']).'</option>';
+                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
             }
         }
     }
@@ -1705,12 +1701,12 @@
     foreach($categories as $group) {
         if (isset($forums[$group['fid']])) {
             $forumselect[] = '<option value="0"></option>';
-            $forumselect[] = '<option value="'.ROOT.'index.php?gid='.intval($group['fid']).'">'.stripslashes($group['name']).'</option>';
+            $forumselect[] = '<option value="'.ROOT.'index.php?gid='.intval($group['fid']).'">'.$group['name'].'</option>';
             foreach($forums[$group['fid']] as $forum) {
-                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.stripslashes($forum['name']).'</option>';
+                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.$forum['name'].'</option>';
                 if (isset($subforums[$forum['fid']])) {
                     foreach($subforums[$forum['fid']] as $sub) {
-                        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.stripslashes($sub['name']).'</option>';
+                        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
                     }
                 }
             }
@@ -1719,4 +1715,82 @@
     $forumselect[] = '</select>';
     return implode("\n", $forumselect);
 }
-?>
\ No newline at end of file
+
+function checkForumPermissions($forum) {
+    // 1. Check Forum Permissions
+    global $self;
+    $status = array(
+        'Super Administrator' => 1,
+        'Administrator'       => 2,
+        'Super Moderator'     => 4,
+        'Moderator'           => 8,
+        'Member'              => 16,
+        ''                    => 32,
+        'Banned'              => (1 << 30));  //$status['Banned'] == 2^30
+
+    // NewPoll,NewThread,NewReply,View,Userlist,Password
+    $ret = array(false, false, false, false, false, false);
+    $pp = explode(',', $forum['postperm']);
+    foreach($pp as $key=>$val) {
+        if (($val & $status[$self['status']]) == $status[$self['status']]) {
+            $ret[$key] = true;
+        }
+    }
+
+    // 2. Check for userlist
+    $userlist = trim($forum['userlist']);
+
+    if (strlen($userlist) > 0) {
+        if (modcheck($self['username'], $forum['moderator']) == "Moderator") {
+            $ret[X_PERMS_USERLIST] = true;
+        } else {
+            $users = explode(',', $userlist);
+            foreach($users as $user) {
+                if (strtolower(trim($user)) == strtolower($self['username'])) {
+                    $ret[X_PERMS_USERLIST] = true;
+                    break;
+                }
+            }
+        }
+    } else {
+        $ret[X_PERMS_USERLIST] = true;
+    }
+
+    // 3.Check for password
+    $pwinput = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
+    if ($forum['password'] != '') {
+        if ($pwinput == $forum['password']) {
+            $ret[X_PERMS_PASSWORD] = true;
+        } else {
+            $ret[X_PERMS_PASSWORD] = false;
+        }
+    } else {
+        $ret[X_PERMS_PASSWORD] = true;
+    }
+
+    return $ret;
+}
+
+function handlePasswordDialog($fid) {
+    global $db, $url, $cookiepath, $cookiedomain;  // function vars
+    global $THEME, $lang, $oToken, $altbg1, $altbg2, $tablewidth, $tablespace, $bordercolor;  // template vars
+
+    $pwform = '';
+    $pwinput = postedVar('pw', '', FALSE, FALSE);
+    $query = $db->query("SELECT password FROM ".X_PREFIX."forums WHERE fid=$fid");
+    if ($pwinput != '' And $db->num_rows($query) == 1) {
+        $pass = $db->result($query, 0);
+
+        if ($pwinput == $pass) {
+            put_cookie('fidpw'.$fid, $pass, (time() + (86400*30)), $cookiepath, $cookiedomain);
+            redirect($url, 0);
+        } else {
+            eval('$pwform = "'.template('forumdisplay_password').'";');
+            error($lang['invalidforumpw'], true, '', $pwform, false, true, false, true);
+        }
+    } else {
+        eval('$pwform = "'.template('forumdisplay_password').'";');
+        error($lang['forumpwinfo'], true, '', $pwform, false, true, false, true);
+    }
+}
+?>
Index: include/global.inc.php
===================================================================
--- include/global.inc.php	(revision 1095)
+++ include/global.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -30,7 +30,7 @@
     exit("Not allowed to run this file directly.");
 }
 
-// This makes XMB compatible with the latest PHP changes (4.2.*) (mainly 4.2.1 and 4.2.2)
+// This is an old compatibility trick, kept in case superglobals are disabled.
 if (!isset($_SERVER)) {
     $_GET = &$HTTP_GET_VARS;
     $_POST = &$HTTP_POST_VARS;
@@ -41,37 +41,15 @@
     $_REQUEST = array_merge($_GET, $_POST, $_COOKIE);
 }
 
-$global = @array(0 => $_GET, 1 => $_POST, 2 => $_ENV, 3=> $_COOKIE, 4=> $_SESSION, 5 => $_SERVER, 6 => $_FILES, 7 => &$_REQUEST);
+$global = @array(0 => $_REQUEST, 1 => $_FILES, 2 => $_SERVER, 3 => $_SESSION, 4 => $_ENV);
 
 // make sure magic_quotes_runtime doesn't kill XMB
 @set_magic_quotes_runtime(0);
-if (get_magic_quotes_gpc() === 0) {
-    foreach($global as $keyg => $valg) {
-        if (is_array($valg)) {
-            foreach($valg as $keya => $vala) {
-                if (is_array($vala)) {
-                    foreach($vala as $keyv => $valv) {
-                        if (gettype($valv) == "string") {
-                            $global[$keyg][$keya][$keyv] = addslashes($valv);
-                        }
-                    }
-                } else if (gettype($vala) == "string") {
-                    $global[$keyg][$keya] = addslashes($vala);
-                }
-            }
-        }
-    }
 
-    foreach($global as $num => $array) {
-        if (is_array($array)) {
-            extract($array, EXTR_OVERWRITE);
-        }
+// force registerglobals
+foreach($global as $num => $array) {
+    if (is_array($array)) {
+        extract($array, EXTR_SKIP);
     }
-} else {
-    foreach($global as $num => $array) {
-        if (is_array($array)) {
-            extract($array, EXTR_OVERWRITE);
-        }
-    }
 }
 ?>
\ No newline at end of file
Index: include/online.inc.php
===================================================================
--- include/online.inc.php	(revision 1095)
+++ include/online.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -35,30 +35,35 @@
     static $restrict, $rset, $fname, $tsub;
 
     if (!$rset) {
-        $modXmbuser = str_replace(array('*', '.', '+'), array('\*', '\.', '\+'), $xmbuser);
-        $restrict = array("(password='')");
-        switch($self['status']) {
-            case 'Member':
-                $restrict[] = 'private = 1';
-                $restrict[] = "(userlist = '' OR userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)')";
-                break;
-            case 'Moderator':
-            case 'Super Moderator':
-                $restrict[] = '(private = 1 OR private = 3)';
-                $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-                break;
-            case 'Administrator':
-                $restrict[] = '(private > 0 AND private < 4)';
-                $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-                break;
-            case 'Super Administrator':
-                break;
-            default:
-                $restrict[] = '(private=1)';
-                $restrict[] = "(userlist='')";
-                break;
+        if (X_SADMIN) {
+            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
+            while($f = $db->fetch_array($q)) {
+                $fids[] = $f['fid'];
+            }
+        } else {
+            $fCache = array();
+            $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
+            while($forum = $db->fetch_array($q)) {
+                $perms = checkForumPermissions($forum);
+                $fCache[$forum['fid']] = $perms;
+
+                if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
+                    if ($forum['type'] == 'sub') {
+                        // also check above forum!
+                        $parentP = $fCache[$forum['fup']];
+                        if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
+                            $fids[] = $forum['fid'];
+                        }
+                    } else {
+                        $fids[] = $forum['fid'];
+                    }
+                }
+            }
         }
-        $restrict = implode(' AND ', $restrict);
+
+        $fids = implode(',', $fids);
+        $restrict = ' f.fid IN('.$fids.')';
+
         $rset = true;
     }
 
@@ -81,7 +86,7 @@
             } else {
                 $query = $db->query("SELECT t.fid, t.subject FROM ".X_PREFIX."forums f, ".X_PREFIX."threads t WHERE $restrict AND f.fid=t.fid AND t.tid='$tid'");
                 while($locate = $db->fetch_array($query)) {
-                    $location = $lang['onlineviewthread'].' '.censor($locate['subject']);
+                    $location = $lang['onlineviewthread'].' '.rawHTMLsubject(stripslashes($locate['subject']));
                     $tsub[$tid] = $locate['subject'];
                 }
                 $db->free_result($query);
Index: include/smtp.inc.php
===================================================================
--- include/smtp.inc.php	(revision 1095)
+++ include/smtp.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -91,6 +91,7 @@
                 return false;
             }
         }
+
         return true;
     }
 
@@ -108,6 +109,7 @@
                 break;
             }
         }
+
         return $lines;
     }
 
@@ -157,6 +159,7 @@
         if (!$this->isOk($this->get())) {
             return false;
         }
+
         return true;
     }
 
Index: include/spelling.inc.php
===================================================================
--- include/spelling.inc.php	(revision 1095)
+++ include/spelling.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -32,8 +32,8 @@
 
 class spelling {
     var $language = '';
-    var $link = 0;
-    var $mode = 0;
+    var $link     = 0;
+    var $mode     = 0;
 
     function spelling($language='en', $mode=PSPELL_NORMAL) {
         global $charset;
@@ -44,7 +44,10 @@
 
         $charset = '';
         $this->language = $language;
-        $this->link = pspell_new($language, '', '', $charset, $mode);
+        @$this->link = pspell_new($language, '', '', $charset, $mode);
+        if ($this->link === FALSE) {
+            error('Failed to open the spelling dictionary for language "'.htmlspecialchars($language, ENT_QUOTES).'"');
+        }
         $this->mode = $mode;
         return true;
     }
@@ -69,7 +72,8 @@
     function check_text($text) {
         $return = array();
 
-        $words = preg_split("/[\W]+/", $text);
+        preg_match_all("/(?i)\\b['a-z]+\\b/", $text, $words);
+        $words = $words[0];
         foreach($words as $word) {
             if (!$this->check_word($word)) {
                 $return[$word] = pspell_suggest($this->link, $word);
Index: include/topicadmin.inc.php
===================================================================
--- include/topicadmin.inc.php	(revision 1095)
+++ include/topicadmin.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -31,30 +31,16 @@
 }
 
 class mod {
-    function mod() {
-        global $self, $xmbuser, $xmbpw, $lang, $action, $oToken;
-
-        if (!X_STAFF && $action != 'votepoll' && $action != 'report') {
-            extract($GLOBALS);
-            error($lang['notpermitted'], false);
-        }
-    }
-
     function statuscheck($fid) {
-        global $self, $xmbuser, $lang, $db, $oToken;
+        global $self, $db;
 
         $query = $db->query("SELECT moderator FROM ".X_PREFIX."forums WHERE fid='$fid'");
+        if ($db->num_rows($query) == 0) {
+            return FALSE;
+        }
         $mods = $db->result($query, 0);
-        $status1 = modcheck($self['status'], $xmbuser, $mods);
 
-        if (X_SMOD || X_ADMIN) {
-            $status1 = 'Moderator';
-        }
-
-        if ($status1 != 'Moderator') {
-            extract($GLOBALS);
-            error($lang['textnoaction'], false);
-        }
+        return (modcheck($self['username'], $mods) == 'Moderator');
     }
 
     function log($user='', $action, $fid, $tid, $reason='') {
@@ -63,7 +49,9 @@
         if ($user == '') {
             $user = $xmbuser;
         }
-        $db->query("REPLACE ".X_PREFIX."logs (tid, username, action, fid, date) VALUES ('$tid', '$user', '$action', '$fid', ".$db->time().")");
+
+        $db->query("INSERT INTO ".X_PREFIX."logs (tid, username, action, fid, date) VALUES ('$tid', '$user', '$action', '$fid', ".$db->time().")");
+
         return true;
     }
 
@@ -79,6 +67,7 @@
                 }
             }
         }
+
         return $tidstr;
     }
 
@@ -91,6 +80,7 @@
                 $tidArr[] = $flip;
             }
         }
+
         return $tidArr;
     }
 }
Index: include/u2u.inc.php
===================================================================
--- include/u2u.inc.php	(revision 1095)
+++ include/u2u.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -30,8 +30,10 @@
     exit("Not allowed to run this file directly.");
 }
 
+define('U2U_FOLDER_COL_SIZE', 32);
+
 function u2u_msg($msg, $redirect) {
-    global $u2uheader, $u2ufooter, $tablewidth, $bordercolor, $tablespace, $borderwidth, $altbg1;
+    global $u2uheader, $u2ufooter, $tablewidth, $bordercolor, $tablespace, $THEME, $altbg1;
 
     if (!empty($redirect)) {
         redirect($redirect);
@@ -41,11 +43,8 @@
 }
 
 function db_u2u_insert($to, $from, $type, $owner, $folder, $subject, $message, $isRead, $isSent) {
-    global $db, $onlinetime, $oToken;
-
-    $subject = checkInput(censor(addslashes($subject)));
-    $message = checkInput(censor(addslashes($message)));
-    $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('".addslashes($to)."', '".addslashes($from)."', '$type', '".addslashes($owner)."', '$folder', '$subject', '$message', '$onlinetime', '$isRead', '$isSent')");
+    global $db, $onlinetime;
+    $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$to', '$from', '$type', '$owner', '$folder', '$subject', '$message', '$onlinetime', '$isRead', '$isSent')");
 }
 
 function u2u_send_multi_recp($msgto, $subject, $message, $u2uid=0) {
@@ -55,35 +54,37 @@
     foreach($recipients as $recp) {
         $errors .= u2u_send_recp($recp, $subject, $message, $u2uid);
     }
+
     return $errors;
 }
 
 function u2u_send_recp($msgto, $subject, $message, $u2uid=0) {
-    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $del, $oToken;
+    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $del, $oToken, $xmbuser;
 
     $del = ('yes' === $del) ? 'yes' : 'no';
     $errors = '';
 
-    $query = $db->query("SELECT username, email, lastvisit, ignoreu2u, emailonu2u, status FROM ".X_PREFIX."members WHERE username='" . trim($msgto) . "'");
+    $query = $db->query("SELECT username, email, lastvisit, ignoreu2u, emailonu2u, status FROM ".X_PREFIX."members WHERE username='$msgto'");
     if ($rcpt = $db->fetch_array($query)) {
         $ilist = array_map('trim', explode(',', $rcpt['ignoreu2u']));
         if (!in_array($self['username'], $ilist) || X_ADMIN) {
             $username = $rcpt['username'];
-            db_u2u_insert($username, $self['username'], 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes');
+            db_u2u_insert($username, $xmbuser, 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes');
             if ($self['saveogu2u'] == 'yes') {
-                db_u2u_insert($username, $self['username'], 'outgoing', $self['username'], 'Outbox', $subject, $message, 'no', 'yes');
+                db_u2u_insert($username, $xmbuser, 'outgoing', $xmbuser, 'Outbox', $subject, $message, 'no', 'yes');
             }
 
             $u2uid = (int) $u2uid;
-            if ($del == 'yes' && $u2uid > 0){
-                   $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$self[username]'");
+            if ($del == 'yes' && $u2uid > 0) {
+                   $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
             }
 
             if ($rcpt['emailonu2u'] == 'yes' && $rcpt['status'] != 'Banned') {
                 $lastvisitcheck = $onlinetime - 600;
                 if ($lastvisitcheck > $rcpt['lastvisit']) {
                     $u2uurl = $SETTINGS['boardurl'] . 'u2u.php';
-                    altMail($rcpt['email'], "$lang[textnewu2uemail]", "$self[username] $lang[textnewu2ubody] \n$u2uurl", "From: $bbname <$adminemail>");
+                    $rawusername = htmlspecialchars_decode($self['username'], ENT_QUOTES);
+                    altMail($rcpt['email'], "$lang[textnewu2uemail]", "$rawusername $lang[textnewu2ubody] \n$u2uurl", "From: $bbname <$adminemail>");
                 }
             }
         } else {
@@ -93,20 +94,23 @@
         $errors = '<br />'.$lang['badrcpt'];
     }
     $db->free_result($query);
+
     return $errors;
 }
 
 function u2u_send($u2uid, $msgto, $subject, $message, $u2upreview) {
-    global $db, $self, $lang, $username, $SETTINGS, $del;
+    global $db, $self, $lang, $xmbuser, $SETTINGS, $del;
     global $u2uheader, $u2ufooter, $u2ucount, $u2uquota, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $cattext, $thewidth;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
     global $forward, $reply, $sendsubmit, $savesubmit, $previewsubmit;
 
+    $dbsubject = $db->escape(addslashes($subject)); //message and subject were historically double-slashed
+    $dbmessage = $db->escape(addslashes($message));
+    $dbto = $db->escape($msgto);
+
     $leftpane = '';
     $del = ($del == 'yes') ? 'yes' : 'no';
-    $msgto = checkInput($msgto, '', '', 'script', false);
-    $subject = strip_tags($subject);
-    $username = checkInput($username, '', '', 'script', false);
+    $username = postedVar('username', 'javascript', TRUE, FALSE, TRUE, 'g'); //username is the param from u2u links on profiles.
 
     if ($self['ban'] == 'u2u' || $self['ban'] == 'both') {
         error($lang['textbanfromu2u'], false, $u2uheader, $u2ufooter, false, true, false, false);
@@ -117,31 +121,36 @@
     }
 
     if (onSubmit('savesubmit')) {
-        // needs to be fixed
-        if (empty($subject) || empty($message)) {
+        // fixed by John Briggs
+        $dbsubject = (empty($dbsubject) ? $db->escape($lang['textnosub']) : $dbsubject);
+
+        if (empty($message)) {
             error($lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
-        db_u2u_insert('', '', 'draft', $self['username'], 'Drafts', $subject, $message, 'yes', 'no');
-        u2u_msg($lang['imsavedmsg'], "u2u.php?folder=Drafts");
+        db_u2u_insert('', '', 'draft', $xmbuser, 'Drafts', $dbsubject, $dbmessage, 'yes', 'no');
+        u2u_msg($lang['imsavedmsg'], 'u2u.php?folder=Drafts');
     }
 
     if (onSubmit('sendsubmit')) {
         $errors = '';
-        // needs to be fixed
-        if (empty($subject) || empty($message)) {
-            error($lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
+        // fixed by John Briggs
+        $dbsubject = (empty($dbsubject) ? $db->escape($lang['textnosub']) : $dbsubject);
+
+        // fixed lang variable use by John Briggs
+        if (empty($message)) {
+            error($lang['u2umsgempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
 
-        if ($db->result($db->query("SELECT count(u2uid) FROM ".X_PREFIX."u2u WHERE msgfrom='$self[username]' AND dateline > ".(time()-$SETTINGS['floodctrl'])), 0) > 0) {
+        if ($db->result($db->query("SELECT count(u2uid) FROM ".X_PREFIX."u2u WHERE msgfrom='$xmbuser' AND dateline > ".(time()-$SETTINGS['floodctrl'])), 0) > 0) {
             error($lang['floodprotect_u2u'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
 
         $u2uid = (int) $_POST['u2uid'];
 
         if (strstr($msgto, ',') && X_STAFF) {
-            $errors = u2u_send_multi_recp($msgto, $subject, $message, $u2uid);
+            $errors = u2u_send_multi_recp($dbto, $dbsubject, $dbmessage, $u2uid);
         } else {
-            $errors = u2u_send_recp($msgto, $subject, $message, $u2uid);
+            $errors = u2u_send_recp($dbto, $dbsubject, $dbmessage, $u2uid);
         }
 
         if (empty($errors)) {
@@ -152,13 +161,13 @@
     }
 
     if ($u2uid > 0) {
-        $query = $db->query("SELECT subject, msgfrom, message FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $query = $db->query("SELECT subject, msgfrom, message FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
         $quote = $db->fetch_array($query);
         if ($quote) {
             if (!isset($previewsubmit)) {
                 $prefixes = array($lang['textre'], $lang['textfwd']);
-                $subject = trim(stripslashes(str_replace($prefixes, '', $quote['subject'])));
-                $message = trim(stripslashes($quote['message']));
+                $subject = str_replace($prefixes, '', $quote['subject']);
+                $message = rawHTMLmessage(stripslashes($quote['message']));  //message and subject were historically double-slashed
                 if ($forward == 'yes') {
                     $subject = $lang['textfwd'].' '.$subject;
                     $message = '[quote][i]'.$lang['origpostedby'].' '.$quote['msgfrom']."[/i]\n".$message.'[/quote]';
@@ -173,13 +182,12 @@
     }
 
     if (isset($previewsubmit)) {
-        $u2usubject = html_entity_decode(checkOutput(censor(checkInput(stripslashes($subject)))));
-        $u2umessage = checkOutput(censor(checkInput(stripslashes($message))));
-        $u2umessage = postify($u2umessage, "no", "", "yes", "no");
-        $username = htmlspecialchars($msgto);
-        $subject = html_entity_decode(htmlspecialchars($subject));
-        $message = html_entity_decode(htmlspecialchars($message));
+        $subject = rawHTMLsubject($subject);
+        $u2usubject = $subject;
+        $u2umessage = postify($message, "no", "", "yes", "no");
+        $message = rawHTMLmessage($message);
         eval('$u2upreview = "'.template('u2u_send_preview').'";');
+        $username = $msgto;
     }
 
     eval('$leftpane = "'.template('u2u_send').'";');
@@ -187,9 +195,9 @@
 }
 
 function u2u_view($u2uid, $folders) {
-    global $db, $dateformat, $timecode, $timeoffset, $addtime, $lang, $self, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $cattext, $thewidth;
-    global $sendoptions, $u2uheader, $u2ufooter;
+    global $db, $dateformat, $timecode, $timeoffset, $addtime, $lang, $self, $oToken, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
+    global $sendoptions, $u2uheader, $u2ufooter, $SETTINGS;
 
     $delchecked = '';
     $leftpane = '';
@@ -201,24 +209,36 @@
         return;
     }
 
-    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+    $query = $db->query("SELECT u.*, m.avatar FROM ".X_PREFIX."u2u AS u LEFT JOIN ".X_PREFIX."members AS m ON u.msgfrom=m.username WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     $u2u = $db->fetch_array($query);
     if ($u2u) {
+        $u2uavatar = '';
         if ($u2u['type'] == 'incoming') {
-            $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid] OR (u2uid=$u2u[u2uid]+1 AND type='outgoing' AND msgto='$self[username]')");
+            $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid] OR (u2uid=$u2u[u2uid]+1 AND type='outgoing' AND msgto='$xmbuser')");
+            if ($SETTINGS['avastatus'] != 'off' And $u2u['avatar'] != '') {
+                $u2uavatar = '<br /><img src="'.$u2u['avatar'].'" />';
+            }
         } else if ($u2u['type'] == 'draft') {
             $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid]");
+            if ($SETTINGS['avastatus'] != 'off' And $self['avatar'] != '') {
+                $u2uavatar = '<br /><img src="'.$self['avatar'].'" />';
+            }
+        } else {
+            if ($SETTINGS['avastatus'] != 'off' And $self['avatar'] != '') {
+                $u2uavatar = '<br /><img src="'.$self['avatar'].'" />';
+            }
         }
 
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
         $u2udate = gmdate($dateformat, $u2u['dateline'] + $adjTime);
         $u2utime = gmdate($timecode, $u2u['dateline'] + $adjTime);
         $u2udateline = $u2udate.' '.$lang['textat'].' '.$u2utime;
-        $u2usubject = html_entity_decode(checkOutput(censor($u2u['subject'])));
-        $u2umessage = html_entity_decode(checkOutput(postify($u2u['message'], 'no', '', 'yes', 'no')));
+        $u2usubject = rawHTMLsubject(stripslashes($u2u['subject'])); //message and subject were historically double-slashed
+        $u2umessage = postify(stripslashes($u2u['message']), 'no', '', 'yes', 'no');
         $u2ufolder = $u2u['folder'];
-        $u2ufrom = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgfrom']).'" target="mainwindow">'.$u2u['msgfrom'].'</a>';
-        $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgto']).'" target="mainwindow">'.$u2u['msgto'].'</a>';
+        $u2ufrom = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgfrom']).'" target="mainwindow">'.$u2u['msgfrom'].'</a>';
+        $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgto']).'" target="mainwindow">'.$u2u['msgto'].'</a>';
+
         if ($u2u['type'] == 'draft') {
             $sendoptions = '<input type="radio" name="mod" value="send" /> '.$lang['textu2u'].'<br />';
             $delchecked = ' checked="checked"';
@@ -227,6 +247,7 @@
         } else {
             $delchecked = ' checked="checked"';
         }
+
         $mtofolder = array();
         $mtofolder[] = '<select name="tofolder">';
         $mtofolder[] = '<option value="">'.$lang['textpickfolder'].'</option>';
@@ -242,14 +263,17 @@
         error($lang['u2uadmin_noperm'], false, $u2uheader, $u2ufooter, false, true, false, false);
     }
     $db->free_result($query);
+
     eval('$leftpane = "'.template('u2u_view').'";');
     return $leftpane;
 }
 
 function u2u_print($u2uid, $eMail = false) {
-    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken;
-    $mailHeader = $mailFooter = '';
+    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken, $xmbuser, $text;
 
+    $mailHeader = '';
+    $mailFooter = '';
+
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
@@ -257,16 +281,17 @@
         return;
     }
 
-    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     $u2u = $db->fetch_array($query);
     $db->free_result($query);
+
     if ($u2u) {
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
         $u2udate = gmdate($dateformat, $u2u['dateline'] +  $adjTime);
         $u2utime = gmdate($timecode, $u2u['dateline'] + $adjTime);
-        $u2udateline = "$u2udate $lang[textat] $u2utime";
-        $u2usubject = html_entity_decode(stripslashes(checkOutput(censor($u2u['subject']))));
-        $u2umessage = postify(html_entity_decode(stripslashes($u2u['message'])), 'no', 'no', 'yes', 'no', 'yes', 'yes', false, "no", "yes");;
+        $u2udateline = $u2udate.' '.$lang['textat'].' '.$u2utime;
+        $u2usubject = rawHTMLsubject(stripslashes($u2u['subject']));  //message and subject were historically double-slashed
+        $u2umessage = postify(stripslashes($u2u['message']), 'no', 'no', 'yes', 'no', 'yes', 'yes', false, "no", "yes");
         $u2ufolder = $u2u['folder'];
         $u2ufrom = $u2u['msgfrom'];
         $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : $u2u['msgto'];
@@ -287,8 +312,7 @@
 }
 
 function u2u_delete($u2uid, $folder) {
-    global $db, $self, $lang;
-    global $u2uheader, $u2ufooter, $oToken;
+    global $db, $self, $lang, $xmbuser, $u2uheader, $u2ufooter, $oToken;
 
     $u2uid = (int) $u2uid;
 
@@ -298,15 +322,16 @@
     }
 
     if ($folder == "Trash") {
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     } else {
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     }
-    u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.$folder);
+
+    u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_mod_delete($folder, $u2u_select) {
-    global $db, $self, $lang, $oToken;
+    global $db, $self, $lang, $oToken, $xmbuser;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -315,15 +340,16 @@
     }
 
     if ($folder == "Trash") {
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid IN($in) AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid IN($in) AND owner='$xmbuser'");
     } else {
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid IN($in) AND owner='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid IN($in) AND owner='$xmbuser'");
     }
-    u2u_msg($lang['imdeletedmsg'], "u2u.php?folder=$folder");
+
+    u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_move($u2uid, $tofolder) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken, $xmbuser;
 
     $u2uid = (int) $u2uid;
 
@@ -338,13 +364,16 @@
         if (!(in_array($tofolder, $folders) || $tofolder == 'Inbox' || $tofolder == 'Outbox' || $tofolder == 'Drafts') || ($tofolder == 'Inbox' && ($type == 'draft' || $type == 'outgoing')) || ($tofolder == 'Outbox' && ($type == 'incoming' || $type == 'draft')) || ($tofolder == 'Drafts' && ($type == 'incoming' || $type == 'outgoing'))) {
             error($lang['textcantmove'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
         }
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid='$u2uid' AND owner='$self[username]'");
-        u2u_msg($lang['textmovesucc'], "u2u.php?folder=$folder");
+
+        $dbfolder = $db->escape($tofolder);
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='$dbfolder' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
+
+        u2u_msg($lang['textmovesucc'], 'u2u.php?folder='.recodeOut($folder));
     }
 }
 
 function u2u_mod_move($tofolder, $u2u_select) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder, $xmbuser;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -358,15 +387,18 @@
     }
 
     if (empty($in)) {
-        error($lang['textcantmove'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+        error($lang['textcantmove'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
         return;
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid IN($in) AND owner='$self[username]'");
-    u2u_msg($lang['textmovesucc'], "u2u.php?folder=$folder");
+
+    $dbfolder = $db->escape($tofolder);
+    $db->query("UPDATE ".X_PREFIX."u2u SET folder='$dbfolder' WHERE u2uid IN($in) AND owner='$xmbuser'");
+
+    u2u_msg($lang['textmovesucc'], 'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_markUnread($u2uid, $folder, $type) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken, $xmbuser;
 
     $u2uid = (int) $u2uid;
 
@@ -381,14 +413,16 @@
     }
 
     if ($type == 'outgoing') {
-        error($lang['textnomur'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+        error($lang['textnomur'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid=$u2uid AND owner='$self[username]'");
-    u2u_msg($lang['textmarkedunread'], "u2u.php?folder=$folder");
+
+    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid=$u2uid AND owner='$xmbuser'");
+
+    u2u_msg($lang['textmarkedunread'], 'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_mod_markUnread($folder, $u2u_select) {
-    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken;
+    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken, $xmbuser;
 
     if (empty($folder)) {
         error($lang['textnofolder'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
@@ -396,7 +430,7 @@
     }
 
     if (empty($u2u_select)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
         return;
     }
 
@@ -412,67 +446,82 @@
     }
 
     if (empty($in)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid IN($in) AND owner='$self[username]'");
-    u2u_msg($lang['textmarkedunread'], "u2u.php?folder=$folder");
+
+    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid IN($in) AND owner='$xmbuser'");
+
+    u2u_msg($lang['textmarkedunread'], 'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_folderSubmit($u2ufolders, $folders) {
-    global $db, $lang, $self, $farray, $oToken;
+    global $db, $lang, $self, $farray, $oToken, $xmbuser;
 
     $error = '';
 
+    //Trim all folder names, remove all duplicates, CI due to absence of explicit column collation.
     $newfolders = explode(',', $u2ufolders);
+    $testarray = array();
     foreach($newfolders as $key => $value) {
         $newfolders[$key] = trim($value);
-        if (empty($newfolders[$key])) {
+        if (empty($newfolders[$key]) Or in_array(strtolower($newfolders[$key]), $testarray) Or in_array(strtolower($newfolders[$key]), array('inbox', 'outbox', 'drafts', 'trash'))) {
             unset($newfolders[$key]);
+        } else if (strlen($newfolders[$key]) > U2U_FOLDER_COL_SIZE) {
+            $newfolders[$key] = substr($newfolders[$key], 0, U2U_FOLDER_COL_SIZE);
+            $testarray[] = strtolower($newfolders[$key]);
+        } else {
+            $testarray[] = strtolower($newfolders[$key]);
         }
     }
 
+    //Prevent deleting non-empty custom folders
     foreach($folders as $value) {
         if (isset($farray[$value]) && $farray[$value] != 0 && !in_array($value, $newfolders) && !in_array($value, array('Inbox', 'Outbox', 'Drafts', 'Trash'))) {
             $newfolders[] = $value;
             $error .= (empty($error)) ? '<br />'.$lang['foldersupdateerror'].' '.$value : ', '.$value;
         }
     }
-    $u2ufolders = checkInput(implode(', ', $newfolders));
-    $db->query("UPDATE ".X_PREFIX."members SET u2ufolders='$u2ufolders' WHERE username='$self[username]'");
+
+    $u2ufolders = $db->escape(implode(', ', $newfolders));
+    $db->query("UPDATE ".X_PREFIX."members SET u2ufolders='$u2ufolders' WHERE username='$xmbuser'");
+
     u2u_msg($lang['foldersupdate'].$error, "u2u.php?folder=Inbox");
 }
 
 function u2u_ignore() {
-    global $ignorelist, $ignoresubmit, $self, $lang, $db, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $thewidth;
+    global $self, $lang, $db, $oToken, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $thewidth;
 
     $leftpane = '';
-    if (isset($ignoresubmit) && isset($ignorelist)) {
-        $self['ignoreu2u'] = htmlspecialchars(checkInput($ignorelist));
-        $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='" . $self['ignoreu2u'] . "' WHERE username='$self[username]'");
+    if (onSubmit('ignoresubmit')) {
+        $ignorelist = postedVar('ignorelist');
+        $self['ignoreu2u'] = $ignorelist;
+        $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='" . $self['ignoreu2u'] . "' WHERE username='$xmbuser'");
         u2u_msg($lang['ignoreupdate'], "u2u.php?action=ignore");
     } else {
-        $self['ignoreu2u'] = checkOutput($self['ignoreu2u']);
         eval('$leftpane = "'.template('u2u_ignore').'";');
     }
+
     return $leftpane;
 }
 
 function u2u_display($folder, $folders) {
-    global $db, $self, $lang;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $thewidth;
+    global $db, $self, $lang, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $thewidth;
     global $addtime, $timeoffset, $dateformat, $timecode, $oToken;
 
     $u2usin = '';
     $u2usout = '';
     $u2usdraft = '';
     $leftpane = '';
+    $folderrecode = recodeOut($folder);
+    $folder = $db->escape($folder);
 
     if (empty($folder)) {
         $folder = "Inbox";
     }
 
-    $query = $db->query("SELECT u.*, w.username, w.invisible FROM ".X_PREFIX."u2u u LEFT JOIN ".X_PREFIX."whosonline w ON (u.msgto=w.username OR u.msgfrom=w.username) AND w.username!='$self[username]' WHERE u.folder='$folder' AND u.owner='$self[username]' ORDER BY dateline DESC");
+    $query = $db->query("SELECT u.*, w.username, w.invisible FROM ".X_PREFIX."u2u u LEFT JOIN ".X_PREFIX."whosonline w ON (u.msgto=w.username OR u.msgfrom=w.username) AND w.username!='$xmbuser' WHERE u.folder='$folder' AND u.owner='$xmbuser' ORDER BY dateline DESC");
     while($u2u = $db->fetch_array($query)) {
         if ($u2u['readstatus'] == 'yes') {
             $u2ureadstatus = $lang['textread'];
@@ -482,11 +531,9 @@
 
         if (empty($u2u['subject'])) {
             $u2u['subject'] = '&laquo;'.$lang['textnosub'].'&raquo;';
-        } else {
-            $u2u['subject'] = html_entity_decode($u2u['subject']);
         }
 
-        $u2usubject = checkOutput(censor($u2u['subject']));
+        $u2usubject = rawHTMLsubject(stripslashes($u2u['subject']));  //message and subject were historically double-slashed
         if ($u2u['type'] == 'incoming') {
             if ($u2u['msgfrom'] == $u2u['username'] || $u2u['msgfrom'] == $self['username']) {
                 if ($u2u['invisible'] == 1) {
@@ -501,7 +548,7 @@
             } else {
                 $online = $lang['textoffline'];
             }
-            $u2usent = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgfrom']).'" target="_blank">'.$u2u['msgfrom'].'</a> ('.$online.')';
+            $u2usent = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgfrom']).'"target="_blank">'.$u2u['msgfrom'].'</a> ('.$online.')';
         } else if ($u2u['type'] == 'outgoing') {
             if ($u2u['msgto'] == $u2u['username'] || $u2u['msgto'] == $self['username']) {
                 if ($u2u['invisible'] == 1) {
@@ -516,28 +563,27 @@
             } else {
                 $online = $lang['textoffline'];
             }
-            $u2usent = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgto']).'" target="_blank">'.$u2u['msgto'].'</a> ('.$online.')';
+            $u2usent = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgto']).'"target="_blank">'.$u2u['msgto'].'</a> ('.$online.')';
         } else if ($u2u['type'] == 'draft') {
             $u2usent = $lang['textu2unotsent'];
         }
 
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
-        $u2udate = gmdate("$dateformat", $u2u['dateline'] + $adjTime);
-        $u2utime = gmdate("$timecode", $u2u['dateline'] + $adjTime);
+        $u2udate = gmdate($dateformat, $u2u['dateline'] + $adjTime);
+        $u2utime = gmdate($timecode, $u2u['dateline'] + $adjTime);
         $u2udateline = "$u2udate $lang[textat] $u2utime";
         switch($u2u['type']) {
             case 'outgoing':
-                $u2us = 'u2usout';
+                eval('$u2usout .= "'.template('u2u_row').'";');
                 break;
             case 'draft':
-                $u2us = 'u2usdraft';
+                eval('$u2usdraft .= "'.template('u2u_row').'";');
                 break;
             case 'incoming':
             default:
-                $u2us = 'u2usin';
+                eval('$u2usin .= "'.template('u2u_row').'";');
                 break;
         }
-        eval('$$u2us .= "'.template('u2u_row').'";');
     }
     $db->free_result($query);
 
@@ -579,12 +625,13 @@
     }
     $mtofolder[] = '</select>';
     $mtofolder = implode("\n", $mtofolder);
+
     eval('$leftpane = "'.template('u2u_main').'";');
     return $leftpane;
 }
 
 function u2u_folderList() {
-    global $db, $self, $lang, $altbg1, $oToken;
+    global $db, $self, $lang, $altbg1, $oToken, $xmbuser;
     global $folder, $folderlist, $folders, $farray; // <--- these are modified in here
 
     $u2ucount = 0;
@@ -595,7 +642,7 @@
     sort($folders);
     $folders = array_merge(array('Inbox' => $lang['textu2uinbox'], 'Outbox' => $lang['textu2uoutbox']), $folders, array('Drafts' => $lang['textu2udrafts'], 'Trash' => $lang['textu2utrash']));
 
-    $query = $db->query("SELECT folder, count(u2uid) as count FROM ".X_PREFIX."u2u WHERE owner='$self[username]' GROUP BY folder ORDER BY folder ASC");
+    $query = $db->query("SELECT folder, count(u2uid) as count FROM ".X_PREFIX."u2u WHERE owner='$xmbuser' GROUP BY folder ORDER BY folder ASC");
     $flist = array();
     while($flist = $db->fetch_array($query)) {
         $farray[$flist['folder']] = $flist['count'];
@@ -605,7 +652,6 @@
 
     $emptytrash = $folderlist = '';
     foreach($folders as $link => $value) {
-        echo ("<!-- $link = $value -->");
         if (is_numeric($link)) {
             $link = $value;
         }
@@ -620,8 +666,10 @@
                 $emptytrash = ' (<a href="u2u.php?action=emptytrash">'.$lang['textemptytrash'].'</a>)';
             }
         }
+        $link = recodeOut($link);
         eval('$folderlist .= "'.template('u2u_folderlink').'";');
     }
+
     return $u2ucount;
 }
 ?>
\ No newline at end of file
Index: include/validate.inc.php
===================================================================
--- include/validate.inc.php	(revision 1095)
+++ include/validate.inc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -33,7 +33,7 @@
 /**
 * CSRF protection class. Call this to obtain and test a page token.
 *
-* In XMB 1.9.8, each user has a single token per page no matter which destination
+* From XMB 1.9.8, each user has a single token per page no matter which destination
 * action. These should be used for all actions. XMB 2.0 will extend this to include
 * unique tokens per action, making it much harder for attackers to spoof any particular
 * action.
@@ -121,6 +121,7 @@
         // This old token has been used - prevent reuse
         $this->sessionToken = false;
         $this->pageToken = false;
+
         return true;
     }
 }
@@ -151,6 +152,7 @@
             $emailValid = true;
         }
     }
+
     return $emailValid;
 }
 
@@ -166,6 +168,7 @@
     if (!$retval) {
         $retval = (isset($_GET[$submitname]) && !empty($_GET[$submitname]));
     }
+
     return($retval);
 }
 
@@ -180,31 +183,189 @@
     return (!onSubmit($submitname));
 }
 
-/**
-* Retrieve a POST variable and sanitizes it
-*
-* @param   string   $varname   name of the variable in $_POST
-* @param   boolean   $striptags   do a striptags to remove HTML tags
-* @param   boolean   $quotes   do a htmlspecialchars to sanitize input for XSS
-* @return   string   the "safe" string if the variable is available, empty otherwise
-*/
-function formVar($varname, $striptags = true, $quotes = false) {
-    $retval = '';
-    if (isset($_POST[$varname]) && $_POST[$varname] !== '') {
-        $retval = trim($_POST[$varname]);
-        if ($striptags) {
-            $retval = strip_tags($retval);
+// postedVar is an all-purpose function for retrieving and sanitizing user input.
+// This is the preferred function as of version 1.9.8 SP3.
+function postedVar($varname, $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE, $sourcearray='p') {
+    $foundvar = FALSE;
+    switch($sourcearray) {
+        case 'p':
+            if (isset($_POST[$varname])) {
+                $retval = $_POST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'g':
+            if (isset($_GET[$varname])) {
+                $retval = $_GET[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'c':
+            if (isset($_COOKIE[$varname])) {
+                $retval = $_COOKIE[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'r':
+        default:
+            if (isset($_REQUEST[$varname])) {
+                $retval = $_REQUEST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+    }
+
+    if ($foundvar) {
+        if (get_magic_quotes_gpc()) {
+            $retval = stripslashes($retval);
         }
 
-        if ($quotes) {
-            $retval = htmlspecialchars($retval, ENT_QUOTES);
-        } else {
-            $retval = htmlspecialchars($retval, ENT_NOQUOTES);
+        if ($word != '') {
+            $retval = str_ireplace($word, "_".$word, $retval);
         }
+
+        if ($htmlencode) {
+            if ($quoteencode) {
+                $retval = htmlspecialchars($retval, ENT_QUOTES);
+            } else {
+                $retval = htmlspecialchars($retval, ENT_NOQUOTES);
+            }
+        }
+
+        if ($dbescape) {
+            $retval = $GLOBALS['db']->escape($retval);
+        }
+    } else {
+        $retval = '';
     }
+
     return $retval;
 }
 
+function postedArray($varname, $type = 'string', $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE) {
+    $arrayItems = array();
+    // Convert a single or comma delimited list to an array
+    if (isset($_POST[$varname]) && !is_array($_POST[$varname])) {
+        if (strpos($_POST[$varname], ',') !== false) {
+            $_POST[$varname] = explode(',', $_POST[$varname]);
+        } else {
+            $_POST[$varname] = array($_POST[$varname]);
+        }
+    }
+
+    if (isset($_POST[$varname]) && is_array($_POST[$varname]) && count($_POST[$varname]) > 0) {
+        $arrayItems = $_POST[$varname];
+        foreach($arrayItems as $item => $theObject) {
+            $theObject = & $arrayItems[$item];
+            switch($type) {
+                case 'int':
+                    $theObject = intval($theObject);
+                    break;
+                case 'string':
+                default:
+                    if (get_magic_quotes_gpc()) {
+                        $theObject = stripslashes($theObject);
+                    }
+
+                    if ($word != '') {
+                        $theObject = str_ireplace($word, "_".$word, $theObject);
+                    }
+
+                    if ($htmlencode) {
+                        if ($quoteencode) {
+                            $theObject = htmlspecialchars($theObject, ENT_QUOTES);
+                        } else {
+                            $theObject = htmlspecialchars($theObject, ENT_NOQUOTES);
+                        }
+                    }
+
+                    if ($dbescape) {
+                        $theObject = $GLOBALS['db']->escape($theObject);
+                    }
+                    break;
+            }
+            unset($theObject);
+        }
+   }
+
+   return $arrayItems;
+}
+
+function recodeOut($rawstring) {
+    return rawurlencode(htmlspecialchars_decode($rawstring, ENT_QUOTES));
+}
+
+function recodeJavaOut($rawstring) {
+    return rawurlencode(rawurlencode(htmlspecialchars_decode($rawstring, ENT_QUOTES)));
+}
+
+function cdataOut($rawstring) {
+    return htmlspecialchars($rawstring, ENT_NOQUOTES);
+}
+
+function attrOut($rawstring, $word='') { //Never safe for STYLE attributes.
+    $retval = $rawstring;
+    if ($word != '') {
+        $retval = str_ireplace($word, "_".$word, $retval);
+    }
+    return htmlspecialchars($retval, ENT_QUOTES);
+}
+
+function rawHTMLmessage($rawstring, $allowhtml='no') {
+    if ($allowhtml == 'yes') {
+        return censor(htmlspecialchars_decode($rawstring, ENT_NOQUOTES));
+    } else {
+        return censor(decimalEntityDecode($rawstring));
+    }
+}
+
+function rawHTMLsubject($rawstring) { //Per the design of version 1.9.9, subjects are only allowed decimal entity references and no other HTML.
+    return censor(decimalEntityDecode($rawstring));
+}
+
+function decimalEntityDecode($rawstring) {
+    $currPos = 0;
+    while(($currPos = strpos($rawstring, '&amp;#', $currPos)) !== FALSE) {
+        $tempPos = strpos($rawstring, ';', $currPos + 6);
+        $entLen = $tempPos - ($currPos + 6);
+        if ($entLen >= 3 And $entLen <= 5) {
+            $entNum = substr($rawstring, $currPos + 6, $entLen);
+            if (is_numeric($entNum)) {
+                if (intval($entNum) >= 160 And intval($entNum) <= 65533) {
+                    $rawstring = str_replace("&amp;#$entNum;", "&#$entNum;", $rawstring);
+                }
+            }
+        }
+        $currPos++;
+    }
+
+    return $rawstring;
+}
+
+// fnameOut is intended to take the raw db value of a forum's name and convert it to the standard HTML version used throughout XMB.
+//   This function must not be used for any other purpose.
+//   Forum names historically used double-slashed db values and default (ENT_COMPAT) quote decoding.
+function fnameOut($rawstring) {
+    return htmlspecialchars_decode(stripslashes($rawstring), ENT_COMPAT);
+}
+
+if (!function_exists('stripos')) {
+    function stripos($haystack, $needle, $offset = 0) {
+        return strpos(strtolower($haystack), strtolower($needle), $offset);
+    }
+}
+
+if (!function_exists('str_ireplace')) {
+    function str_ireplace($search, $replace, $subject) {
+        $ipos = 0;
+        while(($ipos = stripos($subject, $search, $ipos)) !== FALSE) {
+            $subject = substr($subject, 0, $ipos).$replace.substr($subject, $ipos + strlen($search));
+            $ipos += strlen($replace);
+        }
+        return $subject;
+    }
+}
+
 /**
 * Retrieve the contents of an array from a POST
 *
@@ -221,6 +382,7 @@
 * @param   string   $type   'string' or 'int' to specify what needs to be done to the values
 * @return   array   the array found for $varname, empty otherwise
 */
+/* formArray() is deprecated */
 function formArray($varname, $striptags = true, $quotes = false, $type = 'string') {
     $arrayItems = array();
     // Convert a single or comma delimited list to an array
@@ -255,43 +417,53 @@
             unset($theObject);
         }
     }
+
     return $arrayItems;
 }
 
 /**
-* Retrieve a GET variable and sanitize it
+* Retrieve a gpc integer and sanitize it
 *
-* @param   string   $varname   name of the variable in $_GET
-* @param   boolean   $striptags   do a striptags to remove HTML tags
-* @param   boolean   $quotes   do a htmlspecialchars to sanitize input for XSS
-* @return   string   the "safe" string if the variable is available, empty otherwise
+* @param   string   $varname   name of the variable in a superglobal array such as $_GET
+* @param   string   $sourcearray   abbreviation of the superglobal name, g for $_GET by default
+* @return   integer   the "safe" integer if the variable is available, zero otherwise
 */
-function getVar($varname, $striptags = true, $quotes = true) {
-    $retval = '';
-    if (isset($_GET[$varname]) && $_GET[$varname] !== '') {
-        $retval = urldecode(trim($_GET[$varname]));
-        if ($striptags) {
-            $retval = strip_tags($retval);
-        }
+function getInt($varname, $sourcearray='g') {
+    $foundvar = FALSE;
+    switch($sourcearray) {
+        case 'g':
+            if (isset($_GET[$varname])) {
+                $retval = $_GET[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'p':
+            if (isset($_POST[$varname])) {
+                $retval = $_POST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'c':
+            if (isset($_COOKIE[$varname])) {
+                $retval = $_COOKIE[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'r':
+        default:
+            if (isset($_REQUEST[$varname])) {
+                $retval = $_REQUEST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+    }
 
-        if ($quotes) {
-            $retval = htmlspecialchars($retval, ENT_QUOTES);
-        }
+    if ($foundvar And is_numeric($retval)) {
+        $retval = intval($retval);
+    } else {
+        $retval = 0;
     }
-    return $retval;
-}
 
-/**
-* Retrieve a GET integer and sanitize it
-*
-* @param   string   $varname   name of the variable in $_GET
-* @return   integer   the "safe" integer if the variable is available, zero otherwise
-*/
-function getInt($varname) {
-    $retval = 0;
-    if (isset($_GET[$varname]) && is_numeric($_GET[$varname])) {
-        $retval = (int) $_GET[$varname];
-    }
     return $retval;
 }
 
@@ -316,7 +488,15 @@
 * @return   mixed   the value of $varname, false otherwise
 */
 function getRequestVar($varname) {
-    return (isset($_REQUEST[$varname])) ? $_REQUEST[$varname] : false;
+    if (isset($_REQUEST[$varname])) {
+        if (get_magic_quotes_gpc()) {
+            return $_REQUEST[$varname];
+        } else {
+            return addslashes($_REQUEST[$varname]);
+        }
+    } else {
+        return FALSE;
+    }
 }
 
 /**
@@ -355,30 +535,19 @@
         return false;
     }
 
-    $retval = $_POST[$varname];
+    $retval = array();
+    $formval = $_POST[$varname];
+
     if ($doCount) {
         if (count($retval) == 1) {
             $retval = array($retval);
         }
     }
 
-    foreach($retval as $bits => $value) {
-        $value = intval($value);
+    foreach($formval as $value) {
+        $retval[] = intval($value);
     }
-    return $retval;
-}
 
-/**
-* Sanitizes a integer
-*
-* @param   string   $varname   name of the variable
-* @return   integer   the "safe" integer if available, zero otherwise
-*/
-function valInt($varname) {
-    $retval = 0;
-    if (isset($varname) && is_numeric($varname)) {
-        $retval = (int) $varname;
-    }
     return $retval;
 }
 
@@ -460,18 +629,6 @@
     return(($varname == $compare) ? 'checked="checked"' : '');
 }
 
-/**
-* Clean up some HTML
-*
-* @param   array   $matches   matches from preg_replace_callback in checkInput()
-* @return   string   the "safe" string
-*/
-function cleanHtml($matches) {
-    $string = htmlentities($matches[0], ENT_QUOTES);
-    return $string;
-}
-
-
 function encode_ip($dotquad_ip) {
     $ip_sep = explode('.', $dotquad_ip);
     return sprintf('%02x%02x%02x%02x', $ip_sep[0], $ip_sep[1], $ip_sep[2], $ip_sep[3]);
@@ -491,6 +648,7 @@
         }
     }
     natcasesort($lfs);
+
     return '<select name="langfilenew">'.implode("\n", $lfs).'</select>';
 }
 
@@ -506,10 +664,11 @@
             }
         }
     }
+
     return false;
 }
 
 function isValidFilename($filename) {
-    return preg_match('#^[^:\\/?*<>|]+$#', trim($filename));
+    return preg_match("#^[\\w\\^\\-\\#\\] `~!@$&()_+=[{};',.]*$#", trim($filename));
 }
-?>
\ No newline at end of file
+?>
Index: index.php
===================================================================
--- index.php	(revision 1095)
+++ index.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'index.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -55,25 +57,27 @@
         if (strlen(trim($news[$i])) == 0) {
             continue;
         }
-        $news[$i] = postify($news[$i], 'no', 'no', 'yes', 'no', 'yes', 'yes', false, 'yes', 'no');
-        $news[$i] = str_replace('\"', '"', addslashes($news[$i]));
+
+        $news[$i] = str_replace('\"', '"', addslashes(postify($news[$i], 'no', 'no', 'yes', 'yes', 'yes', 'yes', false, 'yes', 'no')));
         $contents .= "\tcontents[$i]='$news[$i]';\n";
     }
     eval('$ticker = "'.template('index_ticker').'";');
 }
 
-$gid = getInt('gid');
-if ($gid) {
-    $gid = (int) $gid;
+$gid = 0;
+if (onSubmit('gid')) {
+    $gid = getInt('gid');
     $SETTINGS['tickerstatus'] = 'off';
     $SETTINGS['whosonlinestatus'] = 'off';
     $SETTINGS['index_stats'] = 'off';
-    $query = $db->query("SELECT name FROM ".X_PREFIX."forums WHERE fid='$gid' AND type='group' LIMIT 1");
+    $query = $db->query("SELECT name FROM ".X_PREFIX."forums WHERE fid=$gid AND type='group' AND status='on' LIMIT 1");
+    if ($db->num_rows($query) != 1) {
+        header('HTTP/1.1 404 Not Found');
+        error($lang['textnocat']);
+    }
     $cat = $db->fetch_array($query);
     $db->free_result($query);
-    nav(html_entity_decode(stripslashes($cat['name'])));
-} else {
-    $gid = 0;
+    nav(fnameOut($cat['name']));
 }
 
 eval('echo "'.template('header').'";');
@@ -101,7 +105,7 @@
     }
     $db->free_result($query);
 
-    $memhtml = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastmember['username']).'"><strong>'.$lastmember['username'].'</strong></a>.';
+    $memhtml = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastmember['username']).'"><strong>'.$lastmember['username'].'</strong></a>.';
     eval($lang['evalindexstats']);
     eval('$statsbar = "'.template('index_stats').'";');
 }
@@ -187,7 +191,7 @@
                 $show_inv_key = true;
             }
 
-            $memtally[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($online['username']).'">'.$pre.''.$online['username'].''.$suff.'</a>';
+            $memtally[] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($online['username']).'">'.$pre.''.$online['username'].''.$suff.'</a>';
             $num++;
         }
 
@@ -206,19 +210,24 @@
         if ($SETTINGS['onlinetoday_status'] == 'on') {
             $datecut = $onlinetime - (3600 * 24);
             if (X_ADMIN) {
-                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' ORDER BY lastvisit DESC LIMIT 0, $onlinetodaycount");
+                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' ORDER BY lastvisit DESC");
             } else {
-                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' AND invisible!=1 ORDER BY lastvisit DESC LIMIT 0, $onlinetodaycount");
+                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' AND invisible!=1 ORDER BY lastvisit DESC");
             }
 
-            $todaymembersnum = 0;
+            $todaymembersnum = $db->num_rows($query);
             $todaymembers = array();
             $pre = $suff = '';
+            $x = 0;
             while($memberstoday = $db->fetch_array($query)) {
-                $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
-                $suff = '</span>';
-                $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
-                ++$todaymembersnum;
+                if ($x <= $onlinetodaycount) {
+                    $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
+                    $suff = '</span>';
+                    $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
+                    $x++;
+                } else {
+                    continue;
+                }
             }
             $todaymembers = implode(', ', $todaymembers);
             $db->free_result($query);
@@ -235,7 +244,7 @@
     }
 
     if ($SETTINGS['catsonly'] == 'on') {
-        $fquery = $db->query("SELECT name as cat_name, fid as cat_fid FROM ".X_PREFIX."forums WHERE type='group' ORDER BY displayorder ASC");
+        $fquery = $db->query("SELECT name as cat_name, fid as cat_fid FROM ".X_PREFIX."forums WHERE type='group' AND status='on' ORDER BY displayorder ASC");
     } else {
         $fquery = $db->query("SELECT f.*, c.name as cat_name, c.fid as cat_fid FROM ".X_PREFIX."forums f LEFT JOIN ".X_PREFIX."forums c ON (f.fup=c.fid) WHERE (c.type='group' AND f.type='forum' AND c.status='on' AND f.status='on') OR (f.type='forum' AND f.fup='' AND f.status='on') ORDER BY c.displayorder ASC, f.displayorder ASC");
     }
@@ -244,7 +253,8 @@
     $fquery = $db->query("SELECT f.*, c.name as cat_name, c.fid as cat_fid FROM ".X_PREFIX."forums f LEFT JOIN ".X_PREFIX."forums c ON (f.fup=c.fid) WHERE (c.type='group' AND f.type='forum' AND c.status='on' AND f.status='on' AND f.fup='$gid') ORDER BY c.displayorder ASC, f.displayorder ASC");
 }
 
-$indexBarTop = $indexBar = $forumlist = $spacer = '';
+$indexBarTop = $indexBar = $forumlist =  $spacer = '';
+$forumarray = array();
 $catLessForums = $lastcat = 0;
 
 if ($SETTINGS['space_cats'] == 'on') {
@@ -267,15 +277,19 @@
 if ($SETTINGS['showsubforums'] == 'on') {
     $index_subforums = array();
     if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
-        $query = $db->query("SELECT fid, fup, name, private, userlist FROM ".X_PREFIX."forums WHERE status='on' AND type='sub' ORDER BY fup, displayorder");
+        $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE status='on' AND type='sub' ORDER BY fup, displayorder");
         while($queryrow = $db->fetch_array($query)) {
-            $index_subforums[] = $queryrow;
+            $subperms = checkForumPermissions($queryrow);
+            if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || ($subperms[X_PERMS_VIEW] && $subperms[X_PERMS_USERLIST])) {
+                $index_subforums[] = $queryrow;
+            }
         }
         $db->free_result($query);
     }
 }
 
 while($thing = $db->fetch_array($fquery)) {
+
     if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
         $cforum = forum($thing, "index_forum");
     } else {
@@ -287,8 +301,12 @@
     }
 
     if ($lastcat != $thing['cat_fid'] && ($SETTINGS['catsonly'] == 'on' || (!empty($cforum) && $SETTINGS['catsonly'] != 'on'))) {
+        if ($forumlist != '') {
+            $forumarray[] = $forumlist;
+            $forumlist = '';
+        }
         $lastcat = $thing['cat_fid'];
-        $thing['cat_name'] = html_entity_decode($thing['cat_name']);
+        $thing['cat_name'] = fnameOut($thing['cat_name']);
         eval('$forumlist .= "'.template('index_category').'";');
         if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
             $forumlist .= $indexBar;
@@ -298,9 +316,13 @@
     if (!empty($cforum)) {
         $forumlist .= $cforum;
     }
+
 }
 
-if (empty($forumlist)) {
+$forumarray[] = $forumlist;
+$forumlist = implode($spacer, $forumarray);
+
+if ($forumlist == '') {
     eval('$forumlist = "'.template('index_noforum').'";');
 }
 $db->free_result($fquery);
@@ -312,5 +334,5 @@
 eval('$index = "'.template('index').'";');
 end_time();
 eval('$footer = "'.template('footer').'";');
-echo stripslashes($index.$footer);
-?>
\ No newline at end of file
+echo $index.$footer;
+?>
Index: js/admin.js
===================================================================
--- js/admin.js	(revision 1095)
+++ js/admin.js	(working copy)
@@ -40,4 +40,26 @@
             el.checked=false;
         }
     }
-}
\ No newline at end of file
+}
+
+function addUserDel(uid, member, e) {
+    if (e.checked) {
+        delmem[uid] = member;
+    } else {
+        delmem[uid] = '';
+    }
+}
+
+function confirmUserDel(message) {
+    var members = '';
+    for (var i = 0; i < delmem.length; i++) {
+        if (delmem[i] != null && delmem[i] != '') {
+            members = members + delmem[i] + "\n";
+        }
+    }
+    if (members != null && members != '') {
+        return window.confirm(message + "\n\n" + members);
+    } else {
+        return true;
+    }
+}
Index: js/bbcodefns-mozilla.js
===================================================================
--- js/bbcodefns-mozilla.js	(revision 1095)
+++ js/bbcodefns-mozilla.js	(working copy)
@@ -117,15 +117,17 @@
             }
         } else {
             text = prompt(bbcode_prompt_email_email, 'user@example.com');
-            while(text.length == 0 || text.match(/(.+)@(.+)/) == null) {
-                text = prompt(bbcode_prompt_email_error, text);
-            }
+            if (text != null) {
+                while(text.length == 0 || text.match(/(.+)@(.+)/) == null) {
+                    text = prompt(bbcode_prompt_email_error, text);
+                }
 
-            desc = prompt(bbcode_prompt_link_desc, '');
-            if (desc.length == 0) {
-                AddText('[email]', '[/email]', text, messageElement);
-            } else {
-                AddText('[email='+text+']', '[/email]', desc, messageElement);
+                desc = prompt(bbcode_prompt_link_desc, '');
+                if (desc.length == 0) {
+                    AddText('[email]', '[/email]', text, messageElement);
+                } else {
+                    AddText('[email='+text+']', '[/email]', desc, messageElement);
+                }
             }
         }
     }
@@ -206,7 +208,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_bold, 'Text');
-            AddText('[b]', '[/b]', text, messageElement);
+            if (text != null) {
+                AddText('[b]', '[/b]', text, messageElement);
+            }
         }
     }
 }
@@ -230,7 +234,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_italic, 'Text');
-            AddText('[i]', '[/i]', text, messageElement);
+            if (text != null) {
+                AddText('[i]', '[/i]', text, messageElement);
+            }
         }
     }
 }
@@ -254,7 +260,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_underline, 'Text');
-            AddText('[u]', '[/u]', text, messageElement);
+            if (text != null) {
+                AddText('[u]', '[/u]', text, messageElement);
+            }
         }
     }
 }
@@ -278,7 +286,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_center, 'Text');
-            AddText('[align=center]', '[/align]', text, messageElement);
+            if (text != null) {
+                AddText('[align=center]', '[/align]', text, messageElement);
+            }
         }
     }
 }
@@ -302,7 +312,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_image, 'http://www.example.com/image.jpg');
-            AddText('[img]', '[/img]', text, messageElement);
+            if (text != null) {
+                AddText('[img]', '[/img]', text, messageElement);
+            }
         }
     }
 }
@@ -326,7 +338,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_quote, 'lorem ipsum');
-            AddText("\r\n"+'[quote]'+"\r\n", '[/quote]'+"\r\n", text, messageElement);
+            if (text != null) {
+                AddText("\r\n"+'[quote]'+"\r\n", '[/quote]'+"\r\n", text, messageElement);
+            }
         }
     }
 }
@@ -350,7 +364,9 @@
             }
         } else {
             text = prompt(bbcode_prompt_code, 'lorem ipsum');
-            AddText("\r\n"+'[code]', '[/code]'+"\r\n", text, messageElement);
+            if (text != null) {
+                AddText("\r\n"+'[code]', '[/code]'+"\r\n", text, messageElement);
+            }
         }
     }
 }
@@ -420,15 +436,17 @@
                 }
             } else {
                 var url = prompt(bbcode_prompt_link_url, 'http://www.example.com');
-                while(url.length == 0 || url.match(URL_REGEXP_GOES_HERE) == null) {
-                    url = prompt(bbcode_prompt_link_url_error, url);
-                }
+                if (url != null) {
+                    while(url.length == 0 || url.match(URL_REGEXP_GOES_HERE) == null) {
+                        url = prompt(bbcode_prompt_link_url_error, url);
+                    }
 
-                var desc = prompt(bbcode_prompt_link_desc, fetchSelection(messageElement));
-                if (desc == fetchSelection(messageElement)) {
-                    wrapText('[url='+url+']', '[/url]', messageElement);
-                } else {
-                    AddText('[url='+url+']', '[/url]', desc, messageElement);
+                    var desc = prompt(bbcode_prompt_link_desc, fetchSelection(messageElement));
+                    if (desc == fetchSelection(messageElement)) {
+                        wrapText('[url='+url+']', '[/url]', messageElement);
+                    } else {
+                        AddText('[url='+url+']', '[/url]', desc, messageElement);
+                    }
                 }
             }
         } else {
@@ -505,18 +523,20 @@
         } else {
             var returnStr = '';
             var type      = prompt(bbcode_prompt_list_start, '');
-            var cType     = type.toLowerCase();
-            while(cType != '' && cType != 'a' && cType != '1' && cType != null) {
-                type = prompt(bbcode_prompt_list_error, type);
-                var cType = type.toLowerCase();
-            }
-            var endStr = '[list'+((type == '' || type == null) ? ']' : '='+type+']');
+            if (type != null) {
+                var cType     = type.toLowerCase();
+                while(cType != '' && cType != 'a' && cType != '1' && cType != null) {
+                    type = prompt(bbcode_prompt_list_error, type);
+                    var cType = type.toLowerCase();
+                }
+                var endStr = '[list'+((type == '' || type == null) ? ']' : '='+type+']');
 
-            while('' != (returnStr = prompt(bbcode_prompt_list_end, ''))) {
-                endStr += '[*]'+returnStr+"\r\n";
+                while('' != (returnStr = prompt(bbcode_prompt_list_end, ''))) {
+                    endStr += '[*]'+returnStr+"\r\n";
+                }
+                endStr += '[/list'+((type == '' || type == null) ? ']' : '='+type+']');
+                AddText('', '', endStr, messageElement);
             }
-            endStr += '[/list'+((type == '' || type == null) ? ']' : '='+type+']');
-            AddText('', '', endStr, messageElement);
         }
     }
 }
@@ -527,4 +547,4 @@
 
 function loadEls() {
     messageElement = document.getElementById("message");
-}
\ No newline at end of file
+}
Index: js/header.js
===================================================================
--- js/header.js	(revision 1095)
+++ js/header.js	(working copy)
@@ -50,4 +50,31 @@
     AddText('', '', theicon, messageElement)
 }
 
-self.name = 'mainwindow';
\ No newline at end of file
+function avatarCheck(input, max_size) {
+    var image = new Image();
+    image.onload = function() {
+        var avatarCheck = document.getElementById('avatarCheck');
+        var isValid = document.getElementById('newavatarcheck');
+        max_size = max_size.split("x");
+
+        if (input.value == "") {
+            avatarCheck.innerHTML = "";
+            isValid.value = "no";
+        } else if (image.width == 0 || image.height == 0) {
+            isValid.value = "no";
+            avatarCheck.style.color = "#ff0000";
+            avatarCheck.innerHTML = "Invalid: Invalid Image";
+        } else if ((image.width > max_size[0] && max_size[0] != 0) || (image.height > max_size[1] && max_size[1] != 0)) {
+            isValid.value = "no";
+            avatarCheck.style.color = "#ff0000";
+            avatarCheck.innerHTML = "Invalid: Image Too Large (Max Size = " + max_size[0] + "x" + max_size[1] + ")";
+        } else {
+            avatarCheck.style.color = "#00ff00";
+            isValid.value = "yes";
+            avatarCheck.innerHTML = "Valid Image";
+        }
+    }
+    image.src = input.value;
+}
+
+self.name = 'mainwindow';
Index: js/u2uheader.js
===================================================================
--- js/u2uheader.js	(revision 1095)
+++ js/u2uheader.js	(working copy)
@@ -41,16 +41,10 @@
 }
 
 function aBook() {
-    if (aBookOpen == true) {
-        aBookLink.close();
-        aBookOpen = false;
+    if (typeof sendMode === "undefined" || sendMode != true) {
+        aBookLink = window.open('buddy.php', 'aBook', "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=450,height=400");
     } else {
-        if (typeof sendMode === "undefined" || sendMode != true) {
-            aBookLink = window.open('buddy.php', 'aBook', "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=450,height=400");
-        } else {
-            aBookLink = window.open('buddy.php?action=add2u2u', 'aBook', "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=450,height=400");
-        }
-        aBookOpen = true;
+        aBookLink = window.open('buddy.php?action=add2u2u', 'aBook', "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=450,height=400");
     }
     return false;
-}
\ No newline at end of file
+}
Index: lang/English.lang.php
===================================================================
--- lang/English.lang.php	(revision 1095)
+++ lang/English.lang.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2 SP1 SP1
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -159,7 +159,7 @@
 $lang['bbcode_prompt_quote'] = "Please enter the text you want quoted.";
 $lang['bbcode_prompt_size'] = "Please enter the text to be size ";
 $lang['bbcode_prompt_underline'] = "Please enter the text that should be underlined.";
-$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [email] mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [flash=200x100]http://www.macromedia.com/flash.swf[/flash] &nbsp; (Flash Movie)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
+$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [email] mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
 $lang['bbcodeoff'] = "Turn BBCode off?";
 $lang['bbinsert'] = "Auto BB Code Inserter:";
 $lang['bbname'] = "Forum Name:";
@@ -215,7 +215,7 @@
 $lang['closethreadmsg'] = "Thank you, the topic has been closed/ opened. You are now being forwarded back to the thread list.";
 $lang['complete_threadprune'] = "Thank you, the topic has been pruned. You are now being forwarded back to the thread list";
 $lang['confirmDeletePosts'] = "You are about to delete all this user's posts. Are you sure you wish to continue?";
-$lang['confirmDeleteUser'] = "By checking this checkbox, you mark this user to be deleted. If you are sure you wish to delete this user, press Ok, otherwise, press Cancel";
+$lang['confirmDeleteUser'] = "The following members will be deleted:";
 $lang['coppaagree'] = "I Agree That I Am 13 or Above";
 $lang['coppastatus'] = "COPPA Compliancy Status:";
 $lang['copythread'] = "Copy Thread";
@@ -245,7 +245,6 @@
 $lang['deletethreadmsg'] = "Thank you, the topic has been deleted. You are now being forwarded back to the thread list.";
 $lang['desc'] = "Descending";
 $lang['developedby'] = "Developed By";
-$lang['disclaimer'] = "Notice!\\n\\nThe above tools have been working in test environments. However, we advise board owners that this should not be the only form of backup procedure. For alternative methods, please check the Support forums at http://www.xmbforum.com/.";
 $lang['dotfolders'] = "'dot' Folders:<br /><span class=\"smalltxt\">Do you want to show dots on folders for the users that have posted in them?</span>";
 $lang['doublee'] = "Allow duplicate mails?";
 $lang['dump_attachments'] = "Dump Attachments";
@@ -263,13 +262,12 @@
 $lang['emailpw'] = "Your password has been reset, and details sent to your e-mail address on record.";
 $lang['emailrestricted'] = "Sorry, this e-mail address cannot be used to register on these forums.";
 $lang['emailverify'] = "E-mail verification (e-mail random password)?";
-$lang['emptythreadmsg'] = "Thank you, the thread has been emptied. You are now being forwarded back to the (emptied) thread.";
+$lang['emptythreadmsg'] = "Thank you, the thread has been emptied. You are now being forwarded back to the thread list.";
 $lang['Enable_Page_load'] = "Enable Page-loadtimes";
 $lang['Enable_PHP_SQL'] = "Enable PHP/SQL Calculation";
 $lang['Enable_Queries'] = "Enable Queries";
 $lang['Enable_Server_Load'] = "Enable Server Load";
 $lang['error'] = "Error";
-$lang['error_chmod_attach_dir'] = "attachments directory (\"./attachments\") should be chmodded to 777 so XMB can write to it.";
 $lang['errormovingthreads'] = "You did not select target forum or subforum. Please go back and try again.";
 $lang['evalbestmember'] = '$lang["bestmember"] = "Member of the Day is <strong>$membesthtml</strong> with <strong>$bestmemberpost</strong> posts";';
 $lang['evalindexstats'] = '$lang["indexstats"] = "<strong>$threads</strong> topics / <strong>$posts</strong> posts / <strong>$members</strong> members";';
@@ -317,6 +315,7 @@
 $lang['forgotpw'] = "Forgot password?";
 $lang['forumjumpselect'] = "Select A Forum";
 $lang['forumpruned'] = "Forum successfully pruned";
+$lang['forumpermissions'] = 'Forum Permissions:';
 $lang['forumpw'] = "Password:<br /><span class=\"smalltxt\">(leave blank for none)</span>";
 $lang['forumpwinfo'] = "This forum is password protected. To view this forum you need to enter the correct password below.";
 $lang['found'] = "Found";
@@ -346,10 +345,11 @@
 $lang['invalidforumpw'] = "The password you entered is invalid.";
 $lang['invalidip'] = "Invalid IP Address Format";
 $lang['invalidFilename'] = "Invalid Filename";
+$lang['invalidtid'] = "Thread cannot be merged.  Invalid Thread ID (tid)";
 $lang['invertselection'] = "Invert Selection";
 $lang['ipwarning'] = "<br /><strong>Warning!</strong> Your IP Address is on the list. You'll be permanently banned if you log out.";
 $lang['key'] = 'Key: ';
-$lang['last50today'] = "$onlinetodaycount Members Who Have Visited Today (if applicable)";
+$lang['last50today'] = "Last $onlinetodaycount Members Who Have Visited Today (if applicable)";
 $lang['lastactive'] = "Last active:";
 $lang['lastreply1'] = "on";
 $lang['lastsadmin'] = "You just tried to de-admin the last remaining Super Administrator. This is a dangerous thing to do. Once de-admin'd, it is not possible anymore to reset one's status back to Super Administrator";
@@ -381,7 +381,7 @@
 $lang['memposts'] = "Posts";
 $lang['message'] = "Message";
 $lang['mergethreadmsg'] = "Thank you, the topics have been merged. You are now being forwarded back to the thread list.";
-$lang['mergewithmsg'] = "TID of the topic to be merged with:<br /><span class=\"smalltxt\">viewthread.php?tid=48, the tid would be 48</span>";
+$lang['mergewithmsg'] = "TID of the topic to be merged and deleted:<br /><span class=\"smalltxt\">viewthread.php?tid=48, the tid would be 48</span>";
 $lang['misconlinetoday'] = "The following ";
 $lang['misconlinetoday2'] = " members have visited $bbname today...";
 $lang['month1'] = "a month";
@@ -412,7 +412,7 @@
 $lang['no_poll'] = "This is not a poll!";
 $lang['no_templates'] = "templates.xmb was not found.";
 $lang['noadminsession'] = "No Administration Login Session Found.";
-$lang['noadminsession2'] = "Welcome to the administration control panel for XMB 1.9, currently running $bbname.";
+$lang['noadminsession2'] = "Welcome to the administration control panel, currently running $bbname.";
 $lang['noadminsession3'] = "Please enter your username and password which currently has administration status.";
 $lang['noadminsession4'] = "If you still have issues logging in, please contact the board <strong><a href=\"mailto:$adminemail?subject=Admin Login Failure At $bbname\">webmaster</a></strong>";
 $lang['noban'] = "Nothing";
@@ -544,6 +544,7 @@
 $lang['repair'] = 'Repair Tables';
 $lang['replace'] = "Replace";
 $lang['replacedby'] = "Replace with";
+$lang['replies'] = 'Replies';
 $lang['replymsg'] = "Thank you, your post has been submitted. You are now being forwarded to your post.";
 $lang['reportmessage'] = "The following post has been reported by a user, please inspect it:";
 $lang['reportmsg'] = "Thank you, the post has been reported. You are now being forwarded back to the thread page";
@@ -731,15 +732,15 @@
 $lang['textfaqans16'] = "Smilies are the little faces to the right of the input for message. They display graphical faces instead of simply a <strong>:)</strong>.<br />Here is a list of current supported smilies:";
 $lang['textfaqans17'] = "You can create a poll by visiting the forum you want to post the poll in and click on Start Poll. The screen following after you click the button is just like a normal new thread page but has an extra box for Poll Answers. You should enter one answer per line.<br /><br />You can vote on polls in threads by visiting the thread with the poll in it and selecting the option you want to vote for, then clicking the submit button. You can only vote on a poll once, so once you vote, you cant change your mind.<br /><br />The Administrator could have disabled this option for each forum.";
 $lang['textfaqans19'] = "Most of the time the answer is no, but ask your Admin.";
-$lang['textfaqans2'] = "Yes. XMB uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
+$lang['textfaqans2'] = "Yes. $bbname uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
 $lang['textfaqans21'] = "You can logout by clicking Logout at the top of the page. When you logout the cookies that store your username and password will be removed and you will become a Guest or Anonymous user.";
 $lang['textfaqans3'] = "To add a signature to your posts you have to log into your <a href=\"memcp.php\">profile</a> and insert into the signature text box the signature you wish to use.<br /><br />BB Code and HTML maybe turned off or on. This can effect what you can insert into your signature.";
 $lang['textfaqans4'] = "Again in your <a href=\"memcp.php\">profile</a> there is a place for an 'Avatar' and avatar is the image under your name. Check with your Admin about the size of your avatar, it's usually considered common courtesy to use one under 150 pixels wide.";
 $lang['textfaqans5'] = "If you have forgotten your password, do not worry. Head over to the <a href=\"misc.php?action=lostpw\">lost password section</a> and fill in the form and your password will be e-mailed to you.";
-$lang['textfaqans6'] = "U2U means User to User. It is a simple messaging client that you can use to send messages to fellow members on this board. You can check your U2U inbox by <a href=\"#\" onclick=\"Popup('u2u.php', 'Window', 700, 450);\">clicking here</a> or going to your <a href=\"memcp.php\">profile</a>.<br /><br />The board administrator might have disabled this function for certain users.";
+$lang['textfaqans6'] = "U2U means User to User. It is a simple messaging client that you can use to send messages to fellow members on this board. You can check your U2U inbox by <a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">clicking here</a> or going to your <a href=\"memcp.php\">profile</a>.<br /><br />The board administrator might have disabled this function for certain users.";
 $lang['textfaqans7'] = "There is a button that says 'Login' in the menu at the top, clicking this button will take you to the login page, where you can login. Here you simply input your username, and your password, click the login button, and that's it!";
 $lang['textfaqans8'] = "By clicking on the 'Search' button in the menu. Then inputting what you wish to search for, you can restrict where you search with the drop down lists.";
-$lang['textfaqans9'] = "First click on the <a href=\"#\" onclick=\"Popup('u2u.php', 'Window', 700, 450);\">U2U</a> button in the menu, another smaller window will pop-up, from there you can access the 'Send a U2U' screen, by clicking on it at the top. Place the users name in the 'To' field, and then insert a subject and a message and click 'Send'. ";
+$lang['textfaqans9'] = "First click on the <a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">U2U</a> button in the menu, another smaller window will pop-up, from there you can access the 'Send a U2U' screen, by clicking on it at the top. Place the users name in the 'To' field, and then insert a subject and a message and click 'Send'. ";
 $lang['textfaqextra'] = "Extra";
 $lang['textfaqstatus'] = "FAQ Status:";
 $lang['textfavorites'] = "Favorites";
@@ -784,7 +785,7 @@
 $lang['textillegalquery'] = "The query you used is not allowed.";
 $lang['textimgcode'] = "IMG Code";
 $lang['textimgcodeis'] = "[img] Code is";
-$lang['textimportsubmit'] = "Import Theme into XMB";
+$lang['textimportsubmit'] = "Import Theme into $bbname";
 $lang['textimporttheme'] = "Import Theme:";
 $lang['textinforum'] = "in forum:";
 $lang['textinthread'] = "In Thread:";
@@ -819,9 +820,9 @@
 $lang['textmem'] = "Member";
 $lang['textmemberlist'] = "Member List";
 $lang['textmembers'] = "Members";
-$lang['textmemberstoday'] = " members have already visited the site today";
+$lang['textmemberstoday'] = " members have visited the site today";
 $lang['textmembersupdate'] = "Members updated successfully!";
-$lang['textmembertoday'] = " member has already visited the site today ";
+$lang['textmembertoday'] = " member has visited the site today ";
 $lang['textmemliststatus'] = "Member List Status:";
 $lang['textmergethread'] = "Merge Thread";
 $lang['textmesperday'] = "messages per day";
@@ -905,7 +906,7 @@
 $lang['textpostread'] = "Posting &amp; Reading Messages";
 $lang['textpostreply'] = "Post Reply";
 $lang['textposts'] = "Posts:";
-$lang['textpowered'] = "powered by XMB";
+$lang['textpowered'] = "Powered By XMB";
 $lang['textppp'] = "Posts Per Page:";
 $lang['textpreview'] = "Preview Post";
 $lang['textpreviewu2u'] = "Preview U2U";
@@ -985,9 +986,9 @@
 $lang['texttabletext'] = "Table Text Color:";
 $lang['texttext'] = "Text Color:";
 $lang['texttheme'] = "Theme:";
-$lang['textthemefile'] = "XMB Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
-$lang['textthemeimportfail'] = "The theme could not be imported into XMB.";
-$lang['textthemeimportsuccess'] = "The theme has successfully been imported into XMB.";
+$lang['textthemefile'] = "$bbname Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
+$lang['textthemeimportfail'] = "The theme could not be imported into $bbname.";
+$lang['textthemeimportsuccess'] = "The theme has successfully been imported into $bbname.";
 $lang['textthemename'] = "Theme Name:";
 $lang['texttime'] = "Time:";
 $lang['texttimeformat'] = "Time Format:";
@@ -1045,8 +1046,10 @@
 $lang['theme_already_exists'] = "A theme with this name already exists!";
 $lang['themes'] = "Themes";
 $lang['themeupdate'] = "Themes updated successfully!";
+$lang['threads'] = 'Threads';
 $lang['tickercontents'] = "News In Newsticker:";
 $lang['tickername'] = "News &amp; Updates";
+$lang['tidnoexist'] = "Thread cannot be merged.  Thread ($othertid) does not exist";
 $lang['timemsg'] = "Processed in";
 $lang['timezone1'] = "(GMT -12:00) Eniwetok, Kwajalein";
 $lang['timezone10'] = "(GMT -3:30) Newfoundland";
@@ -1105,7 +1108,8 @@
 $lang['u2ublocked'] = "The would-be recipient of this U2U has blocked you, so you can't send this message.";
 $lang['u2udump'] = "Clear All U2Us";
 $lang['u2udump_confirm'] = 'Are you sure you want to Delete all u2u\'s?';
-$lang['u2uempty'] = 'The U2U you are trying to save is empty';
+$lang['u2uempty'] = 'The U2U you are trying to save is empty.';
+$lang['u2umsgempty'] = 'The U2U you are trying to send is empty.';
 $lang['u2unotloggedin'] = "You must be logged in or registered to use U2U";
 $lang['u2uquota'] = "U2U Quota:";
 $lang['u2ureachedquota'] = "You have reached the U2U quota limit. You must delete some u2us before you can send any";
@@ -1123,6 +1127,7 @@
 $lang['verificationnote'] = "Please enter the text contained within the image into the textbox below it. This process is used to prevent automated bots.";
 $lang['viaemail'] = 'Via E-mail';
 $lang['viau2u'] = 'Via U2U';
+$lang['view'] = 'View';
 $lang['viewcompleteinbox'] = "View Complete Inbox";
 $lang['viewresults'] = "View Results";
 $lang['votemsg'] = "Thank you, your vote has been submitted. You are now being forwarded back to the thread";
@@ -1141,12 +1146,11 @@
 $lang['whocanpost23'] = "Administrators and Moderators can reply.";
 $lang['whocanpost24'] = "no replies are allowed.";
 $lang['whoodump_confirm'] = 'Are you sure you want to empty the whosonline?';
-$lang['whopostop1'] = "Who Can Post New Topics?";
-$lang['whopostop2'] = "Who Can Post Replies?";
 $lang['whosoneval'] = '$lang["whosonmsg"] = "There are currently $guestn, $membern and $hiddenn browsing $bbname";';
 $lang['whosonline'] = "Who's Online";
 $lang['whosonline_on'] = "Who's online in index status:";
 $lang['whosonlinetoday'] = "Who's Online Today";
 $lang['whoview'] = "Who Can View This Forum?";
+$lang['xmb'] = "XMB";
 $lang['xmbgroup'] = "The XMB Group";
 ?>
\ No newline at end of file
Index: member.php
===================================================================
--- member.php	(revision 1095)
+++ member.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'member.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -47,7 +49,7 @@
 
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'reg':
         nav($lang['textregister']);
@@ -81,7 +83,7 @@
             redirect('member.php?action=reg', 0);
         } else {
             eval('echo "'.template('header').'";');
-            eval('echo stripslashes("'.template('member_coppa').'");');
+            eval('echo "'.template('member_coppa').'";');
         }
         break;
 
@@ -119,8 +121,8 @@
         if (noSubmit('regsubmit')) {
             eval('echo "'.template('header').'";');
             if ($SETTINGS['bbrules'] == 'on' && noSubmit('rulesubmit')) {
-                $SETTINGS['bbrulestxt'] = nl2br(stripslashes(stripslashes($SETTINGS['bbrulestxt'])));
-                eval('echo stripslashes("'.template('member_reg_rules').'");');
+                $SETTINGS['bbrulestxt'] = nl2br($SETTINGS['bbrulestxt']);
+                eval('echo "'.template('member_reg_rules').'";');
             } else {
                 $currdate = gmdate($timecode, $onlinetime+ ($addtime * 3600));
                 eval($lang['evaloffset']);
@@ -134,6 +136,7 @@
                 }
                 $themelist[] = '</select>';
                 $themelist = implode("\n", $themelist);
+                $db->free_result($query);
 
                 $langfileselect = createLangFileSelect($SETTINGS['langfile']);
 
@@ -315,31 +318,31 @@
                         eval('$captcharegcheck = "'.template('member_reg_captcha').'";');
                     }
                 }
-                eval('echo stripslashes("'.template('member_reg').'");');
+                eval('echo "'.template('member_reg').'";');
             }
         } else {
-            $find = array('<', '>', '|', '"', '[', ']', '\\', ',', '@', '\'');
-            $username = formVar('username');
-            foreach($find as $needle) {
-                if (false !== strpos($username, $needle)) {
-                    error($lang['restricted']);
-                }
+            if ($_POST['username'] != preg_replace('#[\]\'\x00-\x1F\x7F<>\\\\|"[,@]#', '', $_POST['username'])) {
+                error($lang['restricted']);
             }
 
+            $username = postedVar('username', '', TRUE, FALSE);
+
             if (strlen($username) < 3 || strlen($username) > 32) {
                 error($lang['username_length_invalid']);
             }
 
+            $username = postedVar('username');
+
             if ($SETTINGS['ipreg'] != 'off') {
                 $time = $onlinetime-86400;
-                $query = $db->query("SELECT uid FROM ".X_PREFIX."members WHERE regip='$onlineip' AND regdate >= '$time'");
+                $query = $db->query("SELECT uid FROM ".X_PREFIX."members WHERE regip='$onlineip' AND regdate >= $time");
                 if ($db->num_rows($query) >= 1) {
                     error($lang['reg_today']);
                 }
                 $db->free_result($query);
             }
 
-            $email = addslashes(formVar('email'));
+            $email = postedVar('email', 'javascript', TRUE, TRUE, TRUE);
             if ($SETTINGS['doublee'] == 'off' && false !== strpos($email, "@")) {
                 $email1 = ", email";
                 $email2 = "OR email='$email'";
@@ -354,17 +357,19 @@
                 error($lang['alreadyreg']);
             }
 
-            $password = formVar('password');
             if ($SETTINGS['emailcheck'] == 'on') {
                 $password = '';
                 $chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz";
                 mt_srand((double)microtime() * 1000000);
-                for($get = strlen($chars); $i < 8; $i++) {
+                $get = strlen($chars) - 1;
+                for($i = 0; $i < 8; $i++) {
                     $password .= $chars[mt_rand(0, $get)];
                 }
                 $password2 = $password;
+                } else {
+                $password = $_POST['password'];
+                $password2 = $_POST['password2'];
             }
-            $password2 = trim($password2);
 
             if ($password != $password2) {
                 error($lang['pwnomatch']);
@@ -374,45 +379,29 @@
             $efail = false;
             $query = $db->query("SELECT * FROM ".X_PREFIX."restricted");
             while($restriction = $db->fetch_array($query)) {
+                $t_username = $username;
+                $t_email = $email;
                 if ($restriction['case_sensitivity'] == 1) {
-                    if ($restriction['partial'] == 1) {
-                        if (strpos($username, $restriction['name']) !== false) {
-                            $fail = true;
-                        }
+                    $t_username = strtolower($t_username);
+                    $t_email = strtolower($t_email);
+                    $restriction['name'] = strtolower($restriction['name']);
+                }
 
-                        if (strpos($email, $restriction['name']) !== false) {
-                            $efail = true;
-                        }
-                    } else {
-                        if ($username == $restriction['name']) {
-                            $fail = true;
-                        }
+                if ($restriction['partial'] == 1) {
+                    if (strpos($t_username, $restriction['name']) !== false) {
+                        $fail = true;
+                    }
 
-                        if ($email == $restriction['name']) {
-                            $efail = true;
-                        }
+                    if (strpos($t_email, $restriction['name']) !== false) {
+                        $efail = true;
                     }
                 } else {
-                    $t_username = strtolower($username);
-                    $t_email = strtolower($email);
-                    $restriction['name'] = strtolower($restriction['name']);
+                    if ($t_username == $restriction['name']) {
+                        $fail = true;
+                    }
 
-                    if ($restriction['partial'] == 1) {
-                        if (strpos($t_username, $restriction['name']) !== false) {
-                            $fail = true;
-                        }
-
-                        if (strpos($t_email, $restriction['name']) !== false) {
-                            $efail = true;
-                        }
-                    } else {
-                        if ($t_username == $restriction['name']) {
-                            $fail = true;
-                        }
-
-                        if ($t_email == $restriction['name']) {
-                            $efail = true;
-                        }
+                    if ($t_email == $restriction['name']) {
+                        $efail = true;
                     }
                 }
             }
@@ -442,20 +431,22 @@
                 require ROOT.'include/captcha.inc.php';
                 $Captcha = new Captcha(250, 50);
                 if ($Captcha->bCompatible !== false) {
-                    $imghash = addslashes($imghash);
-                    $imgcode = addslashes($imgcode);
+                    $imghash = postedVar('imghash', '', FALSE, TRUE);
+                    $imgcode = postedVar('imgcode', '', FALSE, FALSE);
                     if ($Captcha->ValidateCode($imgcode, $imghash) !== true) {
                         error($lang['captchaimageinvalid']);
                     }
                 }
             }
 
-            $langfilenew = getLangFileNameFromHash(formVar('langfilenew'));
-            if (!$langfilenew) {
+            $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
+            $langfilenew = getLangFileNameFromHash($langfilenew);
+            if ($langfilenew === FALSE) {
                 $langfilenew = $SETTINGS['langfile'];
             } else {
                 $langfilenew = basename($langfilenew);
             }
+            $langfilenew = $db->escape($langfilenew);
 
             $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members");
             $count1 = $db->result($query,0);
@@ -463,7 +454,7 @@
 
             $self['status'] = ($count1 != 0) ? 'Member' : 'Super Administrator';
 
-            $timeoffset1 = formInt('timeoffset1');
+            $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
             $thememem = formInt('thememem');
             $tpp = formInt('tpp');
             $ppp = formInt('ppp');
@@ -477,63 +468,51 @@
             $day = formInt('day');
             $bday = iso8601_date($year, $month, $day);
 
-            $dateformatnew = formVar('dateformatnew');
-            if (strlen($dateformatnew) == 0) {
+            $dateformatnew = postedVar('dateformatnew', '', FALSE, TRUE);
+            $dateformattest = attrOut($dateformatnew, 'javascript');  // NEVER allow attribute-special data in the date format because it can be unescaped using the date() parser.
+            if (strlen($dateformatnew) == 0 Or $dateformatnew != $dateformattest) {
                 $dateformatnew = $SETTINGS['dateformat'];
-            } else {
-                $dateformatnew = (intval($dateformatnew) > 0 ? $SETTINGS['dateformat'] : checkInput($dateformatnew, '', '', 'javascript', true)); // Temporary validation of dateformat - if it contains numbers we assume the date is incorrect (blacklist approach) and therefore use the default dateformat otherwise we proceed to validation of input.
             }
+            unset($dateformattest);
 
             $timeformatnew = formInt('timeformatnew');
-            $timeformatnew = $timeformatnew ? checkInput($timeformatnew, '', '', 'script', true) : $SETTINGS['timeformat'];
-            $avatar = formVar('avatar');
-            $avatar = $avatar ? checkInput($avatar, '', '', 'javascript', false) : '';
-            $avatar = $avatar ? checkInput($avatar, '', '', 'php', false) : '';
-            $location = formVar('location');
-            $location = $location ? checkInput($location, '', '', "javascript", false) : '';
-            $icq = formVar('icq');
-            $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
-            $yahoo = formVar('yahoo');
-            $yahoo = $yahoo ? checkInput($yahoo, '', '', 'javascript', false) : '';
-            $aim = formVar('aim');
-            $aim = $aim ? checkInput($aim, '', '', 'javascript', false) : '';
-            $msn = formVar('msn');
-            $msn = $msn ? checkInput($msn, '', '', 'javascript', false) : '';
-            $email = formVar('email');
-            $email = $email ? checkInput($email, '', '', 'javascript', false) : '';
-            $site = formVar('site');
-            $site = $site ? checkInput($site, '', '', 'javascript', false) : '';
-            $bio = isset($_POST['bio']) ? checkInput($_POST['bio'], '', '', 'javascript', false) : '';
-            $mood = isset($_POST['mood']) ? checkInput($_POST['mood'], 'no', 'no', 'javascript', false) : '';
-            $sig = isset($_POST['sig']) ? checkInput($_POST['sig'], '', $SETTINGS['sightml'], '', false) : '';
+            if ($timeformatnew != 12 And $timeformatnew != 24) {
+                $timeformatnew = $SETTINGS['timeformat'];
+            }
 
-            $avatar = addslashes($avatar);
-            $location = addslashes($location);
-            $yahoo = addslashes($yahoo);
-            $aim = addslashes($aim);
-            $msn = addslashes($msn);
-            $email = addslashes($email);
-            $site = addslashes($site);
-            $bio = addslashes($bio);
-            $mood = addslashes($mood);
-            $sig = addslashes($sig);
+            $password = md5($password);
 
-            $password = md5(trim($password));
+            if ($SETTINGS['regoptional'] == 'off') {
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+            } else {
+                $avatar = postedVar('avatar', 'javascript', TRUE, TRUE, TRUE);
+                $avatarcheck = postedVar('newavatarcheck');
+                $location = postedVar('location', 'javascript', TRUE, TRUE, TRUE);
+                $icq = postedVar('icq', '', FALSE, FALSE);
+                $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
+                $yahoo = postedVar('yahoo', 'javascript', TRUE, TRUE, TRUE);
+                $aim = postedVar('aim', 'javascript', TRUE, TRUE, TRUE);
+                $msn = postedVar('msn', 'javascript', TRUE, TRUE, TRUE);
+                $site = postedVar('site', 'javascript', TRUE, TRUE, TRUE);
+                $bio = postedVar('bio', 'javascript', TRUE, TRUE, TRUE);
+                $mood = postedVar('mood', 'javascript', TRUE, TRUE, TRUE);
+                $sig = postedVar('sig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-            $max_size = explode('x', $SETTINGS['max_avatar_size']);
-            if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-                $size = @getimagesize($avatar);
-                if ($size === false ) {
+                $max_size = explode('x', $SETTINGS['max_avatar_size']);
+                if (ini_get('allow_url_fopen')) {
+                    if ($max_size[0] > 0 && $max_size[1] > 0) {
+                        $size = @getimagesize($_POST['avatar']);
+                        if ($size === false) {
+                            $avatar = '';
+                        } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
+                            error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                        }
+                    }
+                } else if ($newavatarcheck == "no") {
                     $avatar = '';
-                } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
-                    error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
                 }
-            }
 
-            if ($SETTINGS['regoptional'] == 'on') {
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]',  '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp,  '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, 0, '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
-            } else {
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '$avatar', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, 0, '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]', '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
             }
 
             if ($SETTINGS['notifyonreg'] != 'off') {
@@ -563,8 +542,10 @@
             }
 
             if ($SETTINGS['emailcheck'] == 'on') {
-                altMail($email, $lang['textyourpw'], $lang['textyourpwis']." \n\n$username\n$password2", "From: $bbname <$adminemail>");
+                $username = $_POST['username'];
+                altMail($email, '['.$bbname.'] '.$lang['textyourpw'], "{$lang['textyourpwis']} \n\n{$lang['textusername']} $username\n{$lang['textpassword']} $password2", "From: $bbname <$adminemail>");
             } else {
+                $username = postedVar('username', '', TRUE, FALSE);
                 $currtime = $onlinetime + (86400*30);
                 put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
                 put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
@@ -577,8 +558,8 @@
         break;
 
     case 'viewpro':
-        $member = getVar('member');
-        if (!$member) {
+        $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
+        if ($member == '') {
             error($lang['nomember']);
         } else {
             $memberinfo = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$member'"));
@@ -596,7 +577,7 @@
                 eval('echo "'.template('header').'";');
 
                 $daysreg = ($onlinetime - $memberinfo['regdate']) / (24*3600);
-                if ($daysreg > 1 ) {
+                if ($daysreg > 1) {
                     $ppd = $memberinfo['postnum'] / $daysreg;
                     $ppd = round($ppd, 2);
                 } else {
@@ -629,12 +610,7 @@
                 }
 
                 if ($memberinfo['avatar'] != '') {
-                    if (false !== ($pos = strpos($memberinfo['avatar'], ',')) && substr($memberinfo['avatar'], $pos-4, 4) == '.swf') {
-                        $flashavatar = explode(',', $memberinfo['avatar']);
-                        $memberinfo['avatar'] = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-                    } else {
-                        $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                    }
+                    $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
                 }
 
                 if ($rank['avatarrank'] || $memberinfo['avatar']) {
@@ -678,9 +654,9 @@
                     $percent = round($percent, 2);
                 }
 
-                $memberinfo['bio'] = stripslashes(censor($memberinfo['bio']));
+                $memberinfo['bio'] = censor($memberinfo['bio']);
                 $memberinfo['bio'] = nl2br($memberinfo['bio']);
-                $encodeuser = rawurlencode($memberinfo['username']);
+                $encodeuser = recodeOut($memberinfo['username']);
 
                 $emailblock = '';
                 if ($memberinfo['showemail'] == 'yes') {
@@ -694,7 +670,6 @@
                 }
 
                 if ($memberinfo['mood'] != '') {
-                    $memberinfo['mood'] = censor($memberinfo['mood']);
                     $memberinfo['mood'] = postify($memberinfo['mood'], 'no', 'no', 'yes', 'no', 'yes', 'no', true, 'yes');
                 } else {
                     $memberinfo['mood'] = '';
@@ -702,9 +677,12 @@
 
                 $memberinfo['location'] = censor($memberinfo['location']);
                 $memberinfo['aim'] = censor($memberinfo['aim']);
+                $memberinfo['aimrecode'] = recodeOut($memberinfo['aim']);
                 $memberinfo['icq'] = ($memberinfo['icq'] > 0) ? $memberinfo['icq'] : '';
                 $memberinfo['yahoo'] = censor($memberinfo['yahoo']);
+                $memberinfo['yahoorecode'] = recodeOut($memberinfo['yahoo']);
                 $memberinfo['msn'] = censor($memberinfo['msn']);
+                $memberinfo['msnrecode'] = recodeOut($memberinfo['msn']);
 
                 if ($memberinfo['bday'] === iso8601_date(0,0,0)) {
                     $memberinfo['bday'] = $lang['textnone'];
@@ -712,61 +690,54 @@
                     $memberinfo['bday'] = gmdate($dateformat, gmmktime(12,0,0,substr($memberinfo['bday'],5,2),substr($memberinfo['bday'],8,2),substr($memberinfo['bday'],0,4)));
                 }
 
-                $modXmbuser = str_replace(array('*', '.', '+'), array('\*', '\.', '\+'), $xmbuser);
-                $restrict = array("(password='')");
-                switch($self['status']) {
-                    case 'Member':
-                        $restrict[] = 'private = 1';
-                        $restrict[] = "(userlist = '' OR userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)')";
+                // Forum most active in
+                $found = false;
+                $query = $db->query("SELECT f.userlist, f.password, f.postperm, f.name, p.fid, COUNT(DISTINCT p.pid) as posts FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f ON p.fid=f.fid WHERE p.author='$member' AND f.status='on' GROUP BY p.fid ORDER BY posts DESC");
+                while($f = $db->fetch_array($query)) {
+                    $pp = checkForumPermissions($f);
+                    if ($pp[X_PERMS_VIEW] && $pp[X_PERMS_USERLIST] && $pp[X_PERMS_PASSWORD]) {
+                        $forum = $f;
+                        $found = true;
                         break;
-                    case 'Moderator':
-                    case 'Super Moderator':
-                        $restrict[] = '(private = 1 OR private = 3)';
-                        $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-                        break;
-                    case 'Administrator':
-                        $restrict[] = '(private > 0 AND private < 4)';
-                        $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-                        break;
-                    case 'Super Administrator':
-                        break;
-                    default:
-                        $restrict[] = '(private=1)';
-                        $restrict[] = "(userlist='')";
-                        break;
+                    }
                 }
-                $restrict = implode(' AND ', $restrict);
 
-                $query = $db->query("SELECT f.name, p.fid, COUNT(DISTINCT p.pid) as posts FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f ON p.fid=f.fid WHERE $restrict AND p.author='$member' GROUP BY p.fid ORDER BY posts DESC LIMIT 1");
-                $forum = $db->fetch_array($query);
-                $db->free_result($query);
-
-                if (!($forum['posts'] > 0)) {
+                if (!$found || $forum['posts'] < 1) {
                     $topforum = $lang['textnopostsyet'];
                 } else if ($memberinfo['postnum'] <= 0) {
                     $topforum = $lang['textnopostsyet'];
                 } else {
-                    $forum['fid'] = intval($forum['fid']);
-                    $topforum = "<a href=\"forumdisplay.php?fid=$forum[fid]\">".html_entity_decode($forum['name'])."</a> ($forum[posts] $lang[memposts]) [".round(($forum['posts']/$memberinfo['postnum'])*100, 1)."% of total posts]";
+                    $topforum = "<a href=\"./forumdisplay.php?fid=$forum[fid]\">$forum[name]</a> ($forum[posts] $lang[memposts]) [".round(($forum['posts']/$memberinfo['postnum'])*100, 1)."% $lang[textoftotposts]]";
                 }
 
-                $query = $db->query("SELECT t.tid, t.subject, p.dateline, p.pid FROM (".X_PREFIX."posts p, ".X_PREFIX."threads t) LEFT JOIN ".X_PREFIX."forums f ON p.fid=f.fid WHERE $restrict AND p.author='$member' AND p.tid=t.tid ORDER BY p.dateline DESC LIMIT 1");
-                if ($post = $db->fetch_array($query)) {
-                    $posts = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$post[tid]' AND pid < '$post[pid]'"), 0)+1;
+                // Last post
+                $lpfound = false;
+                $pq = $db->query("SELECT t.tid, t.subject, p.dateline, p.pid, f.fid, f.postperm, f.password, f.userlist FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE p.fid=f.fid AND p.author='$memberinfo[username]' AND p.tid=t.tid AND f.status='on' ORDER BY p.dateline DESC");
+                while($post = $db->fetch_array($pq)) {
+                    $pp = checkForumPermissions($post);
+                    if (!($pp[X_PERMS_VIEW] && $pp[X_PERMS_USERLIST] && $pp[X_PERMS_PASSWORD])) {
+                        continue;
+                    }
+                    $lpfound = true;
+                    $posts = $db->result($db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid='$post[tid]' AND pid < '$post[pid]'"), 0)+1; // +1 is faster than doing <= !
                     validatePpp();
+
                     $page = quickpage($posts, $ppp);
+
                     $lastpostdate = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
                     $lastposttime = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
+
                     $lastposttext = $lastpostdate.' '.$lang['textat'].' '.$lastposttime;
-                    $post['subject'] = censor($post['subject']);
-                    $lastpost = '<a href="viewthread.php?tid='.intval($post['tid']).'&amp;page='.$page.'#pid'.intval($post['pid']).'">'.html_entity_decode($post['subject']).'</a> ('.$lastposttext.')';
-                    $db->free_result($query);
-                } else {
+                    $post['subject'] = rawHTMLsubject(stripslashes($post['subject']));
+                    $lastpost = "<a href=\"./viewthread.php?tid=$post[tid]&amp;page=$page#pid$post[pid]\">$post[subject]</a> ($lastposttext)";
+                    break;
+                }
+                if (!$lpfound) {
                     $lastpost = $lang['textnopostsyet'];
                 }
 
-                $lang['searchusermsg'] = str_replace('*USER*', $memberinfo['username'], $lang['searchusermsg']);
-                eval('echo stripslashes("'.template('member_profile').'");');
+                $lang['searchusermsg'] = str_replace('*USER*', recodeOut($memberinfo['username']), $lang['searchusermsg']);
+                eval('echo "'.template('member_profile').'";');
             }
         }
         break;
Index: memcp.php
===================================================================
--- memcp.php	(revision 1095)
+++ memcp.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
- * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * eXtreme MessageBoard
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'memcp.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -55,7 +57,7 @@
 
 $favs = $buddys = NULL;
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'profile':
         nav('<a href="memcp.php">'.$lang['textusercp'].'</a>');
@@ -75,10 +77,10 @@
 }
 
 function makenav($current) {
-    global $bordercolor, $tablewidth, $borderwidth, $tablespacing, $altbg1, $altbg2, $lang;
+    global $THEME, $bordercolor, $tablewidth, $tablespacing, $altbg1, $altbg2, $lang;
     ?>
     <table cellpadding="0" cellspacing="0" border="0" bgcolor="<?php echo $bordercolor?>" width="<?php echo $tablewidth?>" align="center"><tr><td>
-    <table cellpadding="4" cellspacing="1" border="0" width="100%">
+    <table cellpadding="4" cellspacing="<?php echo $THEME['borderwidth']?>" border="0" width="100%">
     <tr align="center" class="tablerow">
     <?php
     if ($current == '') {
@@ -105,8 +107,8 @@
         echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=favorites\">" .$lang['textfavorites']. "</a></td>";
     }
 
-    echo "<td bgcolor=\"$altbg2\" width=\"20%\" class=\"ctrtablerow\"><a href=\"#\" onclick=\"Popup('u2u.php', 'Window', 700, 450);\">" .$lang['textu2umessenger']. "</a></td>";
-    echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"#\" onclick=\"Popup('buddy.php?', 'Window', 450, 400);\">" .$lang['textbuddylist']. "</a></td>";
+    echo "<td bgcolor=\"$altbg2\" width=\"20%\" class=\"ctrtablerow\"><a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">" .$lang['textu2umessenger']. "</a></td>";
+    echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"buddy.php\" onclick=\"Popup(this.href, 'Window', 450, 400); return false;\">" .$lang['textbuddylist']. "</a></td>";
     echo "<td bgcolor=\"$altbg2\" width=\"10%\" class=\"ctrtablerow\"><a href=\"faq.php\">" .$lang['helpbar']. "</a></td>";
     ?>
     </tr>
@@ -289,15 +291,15 @@
 
         $langfileselect = createLangFileSelect($member['langfile']);
 
-        $day = substr($member['bday'], 8, 2);
-        $month = substr($member['bday'], 5, 2);
+        $day = intval(substr($member['bday'], 8, 2));
+        $month = intval(substr($member['bday'], 5, 2));
         $year = substr($member['bday'], 0, 4);
 
-        $sel0 = $sel1 = $sel2 = $sel3 = $sel4 = $sel5 = $sel6 = '';
-        $sel7 = $sel8 = $sel9 = $sel10 = $sel11 = $sel12 = '';
+        for($i = 0; $i <= 12; $i++) {
+            $sel[$i] = '';
+        }
+        $sel[$month] = $selHTML;
 
-        ${'sel'.(int)$month} = $selHTML;
-
         $dayselect = array();
         $dayselect[] = '<select name="day">';
         $dayselect[] = '<option value="">&nbsp;</option>';
@@ -350,22 +352,11 @@
         }
 
         $member['icq'] = ($member['icq'] > 0) ? $member['icq'] : '';
-        eval('echo stripslashes("'.template('memcp_profile').'");');
+        eval('echo "'.template('memcp_profile').'";');
     }
 
     if (onSubmit('editsubmit')) {
-        reset($self);
-        $member = $self;
-
-        if (!$member['username']) {
-            error($lang['badname'], false);
-        }
-
-        if ($xmbpw != $member['password']) {
-            error($lang['textpwincorrect'], false);
-        }
-
-        $newemail = formVar('newemail');
+        $newemail = postedVar('newemail', '', FALSE, FALSE);
         if ($newemail && (!$newemail || isset($_GET['newemail']))) {
             $auditaction = $_SERVER['REQUEST_URI'];
             $aapos = strpos($auditaction, "?");
@@ -377,8 +368,8 @@
             die("Hack atttempt recorded in audit logs.");
         }
 
-        $newpassword = formVar('newpassword');
-        $newpasswordcf = formVar('newpasswordcf');
+        $newpassword = postedVar('newpassword', '', FALSE, FALSE);
+        $newpasswordcf = postedVar('newpasswordcf', '', FALSE, FALSE);
         if ($newpassword && (!$newpassword || isset($_GET['newpassword']))) {
             $auditaction = $_SERVER['REQUEST_URI'];
             $aapos = strpos($auditaction, "?");
@@ -390,28 +381,32 @@
             die("Hack atttempt recorded in audit logs.");
         }
 
-        $langfilenew = formVar('langfilenew');
+        $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
         $fileNameHash = getLangFileNameFromHash($langfilenew);
         if ($fileNameHash === false) {
             $langfilenew = $SETTINGS['langfile'];
         } else {
             $langfilenew = basename($fileNameHash);
         }
+        $langfilenew = $db->escape($langfilenew);
 
         $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
         $thememem = formInt('thememem');
         $tppnew = isset($_POST['tppnew']) ? (int) $_POST['tppnew'] : $SETTINGS['topicperpage'];
         $pppnew = isset($_POST['pppnew']) ? (int) $_POST['pppnew'] : $SETTINGS['postperpage'];
 
-        $dateformatnew = formVar('dateformatnew');
-        if (strlen($dateformatnew) == 0) {
+        $dateformatnew = postedVar('dateformatnew', '', FALSE, TRUE);
+        $dateformattest = attrOut($dateformatnew, 'javascript');  // NEVER allow attribute-special data in the date format because it can be unescaped using the date() parser.
+        if (strlen($dateformatnew) == 0 Or $dateformatnew != $dateformattest) {
             $dateformatnew = $SETTINGS['dateformat'];
-        } else {
-            $dateformatnew = $dateformatnew ? checkInput($dateformatnew, '', '', 'script', true) : $SETTINGS['dateformat'];
         }
+        unset($dateformattest);
 
         $timeformatnew = formInt('timeformatnew');
-        $timeformatnew = isset($timeformatnew) ? checkInput($timeformatnew, '', '', 'script', true) : $SETTINGS['timeformat'];
+        if ($timeformatnew != 12 And $timeformatnew != 24) {
+            $timeformatnew = $SETTINGS['timeformat'];
+        }
+
         $saveogu2u = formYesNo('saveogu2u');
         $emailonu2u = formYesNo('emailonu2u');
         $useoldu2u = formYesNo('useoldu2u');
@@ -422,27 +417,54 @@
         $month = formInt('month');
         $day = formInt('day');
         $bday = iso8601_date($year, $month, $day);
-        $newavatar = formVar('newavatar');
-        $avatar = $newavatar ? checkInput($newavatar, 'no', 'no', 'javascript', false) : '';
-        $avatar = checkInput($newavatar, 'no', 'no', 'php', false);
-        $newlocation = formVar('newlocation');
-        $location = $newlocation ? checkInput($newlocation, 'no', 'no', 'javascript', false) : '';
-        $newicq = formVar('newicq');
-        $icq = ($newicq && is_numeric($newicq) && $newicq > 0) ? $newicq : 0;
-        $newyahoo = formVar('newyahoo');
-        $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'no', 'javascript', false) : '';
-        $newaim = formVar('newaim');
-        $aim = $newaim ? checkInput($newaim, 'no', 'no', 'javascript', false) : '';
-        $newmsn = formVar('newmsn');
-        $msn = $newmsn ? checkInput($newmsn, 'no', 'no', 'javascript', false) : '';
-        $newemail = formVar('newemail');
-        $email = $newemail ? checkInput($newemail, 'no', 'no', 'javascript', false) : '';
-        $newsite = formVar('newsite');
-        $site = $newsite ? checkInput($newsite, 'no', 'no', 'javascript', false) : '';
-        $bio = isset($_POST['newbio']) ? checkInput($_POST['newbio'], 'no', 'no', 'javascript', false) : '';
-        $mood = isset($_POST['newmood']) ? checkInput($_POST['newmood'], 'no', 'no', 'javascript', false) : '';
-        $sig = isset($_POST['newsig']) ? checkInput($_POST['newsig'], '', $SETTINGS['sightml'], '', false) : '';
+        $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+        $newavatarcheck = postedVar('newavatarcheck');
+        $location = postedVar('newlocation', 'javascript', TRUE, TRUE, TRUE);
+        $icq = postedVar('newicq', '', FALSE, FALSE);
+        $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
+        $yahoo = postedVar('newyahoo', 'javascript', TRUE, TRUE, TRUE);
+        $aim = postedVar('newaim', 'javascript', TRUE, TRUE, TRUE);
+        $msn = postedVar('newmsn', 'javascript', TRUE, TRUE, TRUE);
+        $email = postedVar('newemail', 'javascript', TRUE, TRUE, TRUE);
+        $site = postedVar('newsite', 'javascript', TRUE, TRUE, TRUE);
+        $bio = postedVar('newbio', 'javascript', TRUE, TRUE, TRUE);
+        $mood = postedVar('newmood', 'javascript', TRUE, TRUE, TRUE);
+        $sig = postedVar('newsig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
+        if ($SETTINGS['doublee'] == 'off' && false !== strpos($email, "@")) {
+            $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE email = '$email' AND username != '$xmbuser'");
+            $count1 = $db->result($query,0);
+            $db->free_result($query);
+            if ($count1 != 0) {
+                error($lang['alreadyreg']);
+            }
+        }
+
+        $efail = false;
+        $query = $db->query("SELECT * FROM ".X_PREFIX."restricted");
+        while($restriction = $db->fetch_array($query)) {
+            $t_email = $email;
+            if ($restriction['case_sensitivity'] == 1) {
+                $t_email = strtolower($t_email);
+                $restriction['name'] = strtolower($restriction['name']);
+            }
+
+            if ($restriction['partial'] == 1) {
+                if (strpos($t_email, $restriction['name']) !== false) {
+                    $efail = true;
+                }
+            } else {
+                if ($t_email == $restriction['name']) {
+                    $efail = true;
+                }
+            }
+        }
+        $db->free_result($query);
+
+        if ($efail) {
+            error($lang['emailrestricted']);
+        }
+
         if ($SETTINGS['resetsigs'] == 'on') {
             if (strlen(trim($self['sig'])) == 0) {
                 if (strlen($sig) > 0) {
@@ -455,38 +477,31 @@
             }
         }
 
-        $avatar = addslashes($avatar);
-        $location = addslashes($location);
-        $yahoo = addslashes($yahoo);
-        $aim = addslashes($aim);
-        $msn = addslashes($msn);
-        $email = addslashes($email);
-        $site = addslashes($site);
-        $bio = addslashes($bio);
-        $mood = addslashes($mood);
-        $sig = addslashes($sig);
-
         $max_size = explode('x', $SETTINGS['max_avatar_size']);
-        if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-            $size = @getimagesize($avatar);
-            if ($size === false ) {
-                $avatar = '';
-            } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
-                error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+        if (ini_get('allow_url_fopen')) {
+            if ($max_size[0] > 0 && $max_size[1] > 0) {
+                $size = @getimagesize($_POST['newavatar']);
+                if ($size === false) {
+                    $avatar = '';
+                } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
+                    error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+                }
             }
+        } else if ($newavatarcheck == "no") {
+            $avatar = '';
         }
 
-        if ($newpassword != '' || $newpasswordcf != '' ) {
-            if ($newpassword != $newpasswordcf ) {
+        if ($_POST['newpassword'] != '' || $_POST['newpasswordcf'] != '') {
+            if ($_POST['newpassword'] != $_POST['newpasswordcf']) {
                 error($lang['pwnomatch'], false);
             }
 
-            $newpassword = md5(trim($newpassword));
+            $newpassword = md5($_POST['newpassword']);
 
             $pwtxt = "password='$newpassword',";
 
             $currtime = $onlinetime - (86400*30);
-            put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
+            put_cookie("xmbuser", $self['username'], $currtime, $cookiepath, $cookiedomain);
             put_cookie("xmbpw", $newpassword, $currtime, $cookiepath, $cookiedomain);
         } else {
             $pwtxt = '';
@@ -494,8 +509,7 @@
 
         $db->query("UPDATE ".X_PREFIX."members SET $pwtxt email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u' WHERE username='$xmbuser'");
 
-        echo '<center><span class="mediumtxt">'.$lang['usercpeditpromsg'].'</span></center>';
-        redirect('memcp.php', 2.5, X_REDIRECT_JS);
+        message($lang['usercpeditpromsg'], false, '', '', 'memcp.php', true, false, true);
     }
 } else if ($action == 'favorites') {
     eval('echo "'.template('header').'";');
@@ -516,8 +530,7 @@
         }
 
         $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ('$favadd', '$xmbuser', 'favorite')");
-        echo '<center><span class="mediumtxt">'.$lang['favaddedmsg'].'</span></center>';
-        redirect('memcp.php?action=favorites', 2, X_REDIRECT_JS);
+        message($lang['favaddedmsg'], false, '', '', 'memcp.php?action=favorites', true, false, true);
     }
 
     if (!$favadd && noSubmit('favsubmit')) {
@@ -529,15 +542,15 @@
             $query2 = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
             $forum = $db->fetch_array($query2);
             $db->free_result($query2);
-            $forum['name'] = html_entity_decode($forum['name']);
+            $forum['name'] = fnameOut($forum['name']);
 
             $lastpost = explode('|', $fav['lastpost']);
             $dalast = $lastpost[0];
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
             $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
             $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
             $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
-            $fav['subject'] = stripslashes(censor($fav['subject']));
+            $fav['subject'] = rawHTMLsubject(stripslashes($fav['subject']));
 
             if ($fav['icon'] != '') {
                 $fav['icon'] = '<img src="'.$smdir.'/'.$fav['icon'].'" alt="" border="0" />';
@@ -558,7 +571,7 @@
             eval('$favs = "'.template('memcp_favs_none').'";');
         }
         $db->free_result($query);
-        eval('echo stripslashes("'.template('memcp_favs').'");');
+        eval('echo "'.template('memcp_favs').'";');
     }
 
     if (!$favadd && onSubmit('favsubmit')) {
@@ -569,8 +582,7 @@
         }
         $db->free_result($query);
 
-        echo '<center><span class="mediumtxt">'.$lang['favsdeletedmsg'].'</span></center>';
-        redirect('memcp.php?action=favorites', 2, X_REDIRECT_JS);
+        message($lang['favsdeletedmsg'], false, '', '', 'memcp.php?action=favorites', true, false, true);
     }
 } else if ($action == 'subscriptions') {
     eval('echo "'.template('header').'";');
@@ -586,15 +598,15 @@
             $query2 = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
             $forum = $db->fetch_array($query2);
             $db->free_result($query2);
-            $forum['name'] = html_entity_decode($forum['name']);
+            $forum['name'] = fnameOut($forum['name']);
 
             $lastpost = explode('|', $fav['lastpost']);
             $dalast = $lastpost[0];
-            $lastpost['1'] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost['1'] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
             $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
             $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
             $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
-            $fav['subject'] = stripslashes(censor($fav['subject']));
+            $fav['subject'] = rawHTMLsubject(stripslashes($fav['subject']));
 
             if ($fav['icon'] != '') {
                 $fav['icon'] = '<img src="'.$smdir.'/'.$fav['icon'].'" alt="" border="0" />';
@@ -614,7 +626,7 @@
             eval('$subscriptions = "'.template('memcp_subscriptions_none').'";');
         }
         $db->free_result($query);
-        eval('echo stripslashes("'.template('memcp_subscriptions').'");');
+        eval('echo "'.template('memcp_subscriptions').'";');
     } else if ($subadd && noSubmit('subsubmit')) {
         $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."favorites WHERE tid='$subadd' AND username='$xmbuser' AND type='subscription'");
         if ($db->result($query,0) == 1) {
@@ -622,8 +634,7 @@
             error($lang['subonlistmsg'], false);
         } else {
             $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ('$subadd', '$xmbuser', 'subscription')");
-            echo '<center><span class="mediumtxt">'.$lang['subaddedmsg'].'</span></center>';
-            redirect('memcp.php?action=subscriptions', 2, X_REDIRECT_JS);
+            message($lang['subaddedmsg'], false, '', '', 'memcp.php?action=subscriptions', true, false, true);
         }
     } else if (!$subadd && onSubmit('subsubmit')) {
         $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND type='subscription'");
@@ -632,8 +643,7 @@
             $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND tid='$delete' AND type='subscription'");
         }
         $db->free_result($query);
-        echo '<center><span class="mediumtxt">'.$lang['subsdeletedmsg'].'</span></center>';
-        redirect('memcp.php?action=subscriptions', 2, X_REDIRECT_JS);
+        message($lang['subsdeletedmsg'], false, '', '', 'memcp.php?action=subscriptions', true, false, true);
     }
 } else {
     eval('echo "'.template('header').'";');
@@ -646,6 +656,7 @@
     $buddys['online'] = '';
     if (X_ADMIN) {
         while($buddy = $db->fetch_array($q)) {
+            $recodename = recodeOut($buddy['buddyname']);
             if (strlen($buddy['username']) > 0) {
                 if ($buddy['invisible'] == 1) {
                    $buddystatus = $lang['hidden'];
@@ -682,16 +693,10 @@
     if ($member['avatar'] == '') {
         $member['avatar'] = '';
     } else {
-        if (false !== ($pos = strpos($member['avatar'], ',')) && substr($member['avatar'], $pos-4, 4) == '.swf') {
-            $flashavatar = explode(',',$member['avatar']);
-            $member['avatar'] = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-        } else {
-            $member['avatar'] = '<img src="'.$member['avatar'].'" border="0" alt="'.$lang['altavatar'].'" />';
-        }
+        $member['avatar'] = '<img src="'.$member['avatar'].'" border="0" alt="'.$lang['altavatar'].'" />';
     }
 
     if ($member['mood'] != '') {
-        $member['mood'] = censor($member['mood']);
         $member['mood'] = postify($member['mood'], 'no', 'no', 'yes', 'no', 'yes', 'no', true, 'yes');
     } else {
         $member['mood'] = '';
@@ -706,7 +711,7 @@
         $posttime = gmdate($timecode, $message['dateline'] + $tmOffset);
         $senton = $postdate.' '.$lang['textat'].' '.$posttime;
 
-        $message['subject'] = html_entity_decode($message['subject']);
+        $message['subject'] = rawHTMLsubject(stripslashes($message['subject']));
         if ($message['subject'] == '') {
             $message['subject'] = '&laquo;'.$lang['textnosub'].'&raquo;';
         }
@@ -716,7 +721,6 @@
         } else {
             $read = $lang['textunread'];
         }
-        $message['subject'] = stripslashes(censor($message['subject']));
         eval('$messages .= "'.template('memcp_home_u2u_row').'";');
     }
 
@@ -733,15 +737,15 @@
         $query = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
         $forum = $db->fetch_array($query);
         $db->free_result($query);
-        $forum['name'] = html_entity_decode($forum['name']);
+        $forum['name'] = fnameOut($forum['name']);
 
         $lastpost = explode('|', $fav['lastpost']);
         $dalast = $lastpost[0];
-        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
         $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
         $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
-        $fav['subject'] = stripslashes(censor($fav['subject']));
+        $fav['subject'] = rawHTMLsubject(stripslashes($fav['subject']));
 
         if ($fav['icon'] != '') {
             $fav['icon'] = '<img src="'.$smdir.'/'.$fav['icon'].'" alt="" border="0" />';
@@ -755,7 +759,7 @@
         eval('$favs = "'.template('memcp_home_favs_none').'";');
     }
     $db->free_result($query2);
-    eval('echo stripslashes("'.template('memcp_home').'");');
+    eval('echo "'.template('memcp_home').'";');
 }
 
 end_time();
Index: misc.php
===================================================================
--- misc.php	(revision 1095)
+++ misc.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'misc.php');
+
 require 'header.php';
 require ROOT.'include/online.inc.php';
 
@@ -65,7 +67,7 @@
 smcwcache();
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'login':
         nav($lang['textlogin']);
@@ -110,55 +112,11 @@
 
         if (noSubmit('loginsubmit')) {
             eval('$misc = "'.template('misc_login').'";');
-            $misc = stripslashes($misc);
         } else {
-            $password = md5(formVar('password'));
-            $username = addslashes(formVar('username'));
-            $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$username' AND password='$password'");
-            if ($query && $db->num_rows($query) == 1) {
-                $member = $db->fetch_array($query);
-                $db->free_result($query);
-                $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ip='$onlineip' && username='xguest123'");
-                $currtime = $onlinetime + (86400*30);
-                $username = $member['username'];
-
-                if (formInt('hide')) {
-                    $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$username'");
-                } else {
-                    $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$username'");
-                }
-
-                if ($server == 'Mic') {
-                    $misc = '<script>
-                        function put_cookie(name, value, expires, path, domain, secure) {
-                            var curCookie = name + "=" + escape(value) +
-                            ((expires) ? "; expires=" + expires.toGMTString() : "") +
-                            ((path) ? "; path=" + path : "") +
-                            ((domain) ? "; domain=" + domain : "") +
-                            ((secure) ? "; secure" : "");
-                            document.cookie = curCookie;
-                        }
-
-                        var now = new Date();
-                        now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
-
-                        put_cookie("xmbuser", "'.$username.'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
-                        put_cookie("xmbpw", "'.$password.'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
-
-                        window.location="index.php";
-                    </script>';
-                } else {
-                    $secure = formYesNo('secure');
-                    if ($secure == 'yes') {
-                        put_cookie("xmbuser", $username);
-                        put_cookie("xmbpw", $password);
-                    } else {
-                        put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-                        put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
-                    }
-
+            $password = '';
+            if (loginUser(postedVar('username'), md5($_POST['password']), (formInt('hide') == 1), (formYesNo('secure') == 'yes'))) {
+                if ($server != 'Mic') {
                     redirect('index.php', 0);
-                    $misc = '';
                 }
             } else {
                 eval('echo "'.template('header').'";');
@@ -179,14 +137,12 @@
         $currtime = $onlinetime - (86400*30);
         $query = $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE username='$xmbuser'");
 
-        put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-        put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
         put_cookie("xmbuser", '', 0, $cookiepath, $cookiedomain);
         put_cookie("xmbpw", '', 0, $cookiepath, $cookiedomain);
 
         foreach($_COOKIE as $key=>$val) {
             if (preg_match('#^fidpw([0-9]+)$#', $key)) {
-                put_cookie($key, '');
+                put_cookie($key, '', 0, $cookiepath, $cookiedomain);
             }
         }
 
@@ -194,7 +150,7 @@
         break;
 
     case 'search':
-        if ($SETTINGS['searchstatus'] == 'off') {
+        if ($SETTINGS['searchstatus'] != 'on') {
             eval('echo "'.template('header').'";');
             eval('echo "'.template('misc_feature_notavailable').'";');
             end_time();
@@ -202,51 +158,47 @@
             exit();
         }
 
-        $srchfrom = intval(getRequestVar('srchfrom'));
-        $srchtxt = addslashes(getRequestVar('srchtxt'));
-        $srchuname = addslashes(getRequestVar('srchuname'));
-        $srchfid = formArray('srchfid');
-        if (empty($srchfid)) {
-            $srchfid[] = 'all';
-        }
-
-        $filter_distinct = getRequestVar('filter_distinct');
-        $filter_distinct = valYesNo($filter_distinct);
-
-        $page = getInt('page');
-        if ($page < 1) {
-            $page = 1;
-        }
-
-        validatePpp();
-
-        $searchresults = '';
-
-        if (noSubmit('searchsubmit')) {
-            $forumselect = forumList('srchfid[]', true, true);
+        if (!isset($searchsubmit) && !isset($page)) {
+            $forumselect = forumList('srchfid', FALSE, TRUE);
             eval('$search = "'.template('misc_search').'";');
-            $misc = stripslashes($search);
+            $misc = $search;
         } else {
-            if (!$srchuname && !$srchtxt || (strlen($srchuname) < 3 && strlen($srchtxt) < 3)) {
+            if (!isset($filter_distinct) || $filter_distinct != 'yes') {
+                $filter_distinct = '';
+            }
+            $srchtxt = postedVar('srchtxt', '', FALSE, FALSE, FALSE, 'r');
+            $srchuname = postedVar('srchuname', '', TRUE, TRUE, FALSE, 'r');
+            $rawsrchuname = postedVar('srchuname', '', FALSE, FALSE, FALSE, 'r');
+            $filter_distinct = postedVar('filter_distinct', '', FALSE, FALSE, FALSE, 'r');
+            if (strlen($srchuname) < 3 && (empty($srchtxt) || strlen($srchtxt) < 3)) {
                 error($lang['nosearchq']);
             }
 
-            if (!$srchuname || strlen($srchuname) < 3) {
+            if (strlen($srchuname) < 3) {
                 $srchuname = '';
             }
 
-            if (!$srchtxt || strlen($srchtxt) < 3) {
-                $srchtxt = '';
-            }
+            if ($searchsubmit || $page) {
+                validatePpp();
 
-            if (onSubmit('searchsubmit')) {
-                $offset = ($page-1) * $ppp;
-                $start = $offset;
-                $end = $ppp;
+                $searchresults = '';
 
-                $sql = "SELECT p.*, t.tid AS ttid, t.subject AS tsubject, f.fup AS fup, f.type AS type, f.fid, f.private AS fprivate, f.userlist AS fuserlist, f.password AS password FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON f.fid=t.fid WHERE p.tid=t.tid";
+                if (!isset($page)) {
+                    $page = 1;
+                    $offset = 0;
+                    $start = 0;
+                } else {
+                    if ($page < 1) {
+                        $page = 1;
+                    }
 
-                if ($srchfrom == 0) {
+                    $offset = ($page-1) * ($ppp);
+                    $start = $offset;
+                }
+
+                $sql = "SELECT COUNT(p.tid), p.*, t.tid AS ttid, t.subject AS tsubject, f.fid, f.postperm, f.userlist, f.password FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON  f.fid=t.fid WHERE p.tid=t.tid";
+
+                if (!isset($srchfrom) Or $srchfrom == 0) {
                     $srchfrom = $onlinetime;
                     $srchfromold = 0;
                 } else {
@@ -254,164 +206,73 @@
                 }
 
                 $ext = array();
-
                 $srchfrom = $onlinetime - (int) $srchfrom;
-                if ($srchtxt) {
-                    $srchtxtsq = addslashes(str_replace(array('%', '_'), array('\%', '\_'), $srchtxt));
-                    $sql .= " AND (p.message LIKE '%$srchtxtsq%' OR p.subject LIKE '%$srchtxtsq%' OR t.subject LIKE '%$srchtxtsq')";
-                    $ext[] = 'srchtxt='.$srchtxt;
+                if (!empty($srchtxt)) {
+                    $srchtxtsq = explode(' ', $srchtxt);
+                    $sql .= ' AND (';
+                    foreach($srchtxtsq as $stxt) {
+                        $dblikebody = $db->like_escape(addslashes(cdataOut($stxt)));  //Messages are historically double-slashed.
+                        $dblikesub = $db->like_escape(addslashes(attrOut($stxt)));
+                        $sqlsrch[] = "p.message LIKE '%$dblikebody%' OR p.subject LIKE '%$dblikesub%'";
+                    }
+
+                    $sql .= implode(') AND (', $sqlsrch);
+                    $sql .= ')';
+                    $ext[] = 'srchtxt='.rawurlencode($srchtxt);
                 }
 
-                if ($srchuname != '') {
-                    $sql .= " AND p.author='".addslashes($srchuname)."'";
-                    $ext[] = 'srchuname='.$srchuname;
+                if ($srchuname != "") {
+                    $sql .= " AND p.author='$srchuname'";
+                    $ext[] = 'srchuname='.rawurlencode($rawsrchuname);
                 }
 
-                $all = false;
-                $strsql = '';
-                if (!empty($srchfid)) {
-                    foreach($srchfid as $dummy=>$fid) {
-                        if ($fid == 'all') {
-                            $all = true;
-                            break;
-                        }
-                        $strsql .= "'".intval($fid)."', ";
+                if (isset($srchfid)) {
+                    if ($srchfid != "all" && $srchfid != "") {
+                        $sql .= " AND p.fid='".(int)$srchfid."'";
+                        $ext[] = 'srchfid='.((int) $srchfid);
                     }
-                    $strsql = substr($strsql, 0, -2);
                 }
 
-                if ($all == false) {
-                    $sql .= " AND p.fid IN ($strsql)";
-                    $ext[] = 'srchfid IN ('.$strsql.')';
-                }
-
                 if ($srchfrom) {
                     $sql .= " AND p.dateline >= '$srchfrom'";
-                    $ext[] = 'srchfrom'.((int)$srchfromold);
+                    $ext[] = 'srchfrom='.((int) $srchfromold);
                 }
 
-                $sql .=" GROUP BY dateline ORDER BY dateline DESC LIMIT $start,$end";
-                $pagenum = $page + 1;
+                $sql .=" GROUP BY dateline ORDER BY dateline DESC LIMIT $start, $ppp";
+                if (!isset($page) || $page < 1) {
+                    $pagenum = 2;
+                } else {
+                    $pagenum = $page+1;
+                }
 
                 $querysrch = $db->query($sql);
+                $results = 0;
                 $results = $db->num_rows($querysrch);
 
-                if ($srchuname) {
-                    $srchtxt = '\0';
-                }
+                $temparray = array();
+                $searchresults = '';
 
-                if ($filter_distinct == 'yes') {
-                    $temparray = array();
-                    $searchresults = '';
-                    while($post = $db->fetch_array($querysrch)) {
-                        $fidpw = isset($_COOKIE['fidpw'.$post['fid']]) ? $_COOKIE['fidpw'.$post['fid']] : '';
-                        $authorization = privfcheck($post['fprivate'], $post['fuserlist']);
-                        if (($post['password'] != '' && $post['password'] != $fidpw) && !X_SADMIN) {
-                            continue;
-                        }
+                $forumCache = array();
+                while($post = $db->fetch_array($querysrch)) {
+                    $forumPerms = array();
 
-                        if (isset($post['type']) && $post['type'] == 'sub') {
-                            $query = $db->query("SELECT private, userlist, name, fid FROM ".X_PREFIX."forums WHERE fid='$post[fup]'");
-                            $fup = $db->fetch_array($query);
-                            if (!privfcheck($fup['private'], $fup['userlist'])) {
-                                continue;
-                            }
-                            $db->free_result($query);
-                        }
-
-                        if ($authorization) {
-                            if (!array_key_exists($post['ttid'], $temparray)) {
-                                $tid = $post['ttid'];
-                                $temparray[$tid] = true;
-
-                                if ($post['status'] == 'Banned') {
-                                    $post['message'] = $lang['bannedpostmsg'];
-                                }
-
-                                $message = $post['message'];
-
-                                $srchtxt = str_replace(array('_ ', ' _','% ', ' %'), '', $srchtxt);
-                                $position = strpos($message, $srchtxt, 0);
-
-                                $show_num = 100;
-                                $msg_leng = strlen($message);
-
-                                if ($position <= $show_num) {
-                                    $min = 0;
-                                    $add_pre = '';
-                                } else {
-                                    $min = $position - $show_num;
-                                    $add_pre = '...';
-                                }
-
-                                if (($msg_leng - $position) <= $show_num) {
-                                    $max = $msg_leng;
-                                    $add_post = '';
-                                } else {
-                                    $max = $position + $show_num;
-                                    $add_post = '...';
-                                }
-
-                                $show = substr($message, $min, $max);
-                                $show = preg_replace("/($srchtxt)/i", '<strong><em>\\0</em></strong>', $show);
-                                $show = postify($show, 'no', 'yes', 'yes', 'no', 'no', 'no');
-
-                                $date = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-                                $time = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-                                $poston = $date.' '.$lang['textat'].' '.$time;
-                                $postby = $post['author'];
-
-                                $post['tsubject'] = html_entity_decode(stripslashes(censor($post['tsubject'])));
-                                if (trim($post['subject']) == '') {
-                                    $post['subject'] = $post['tsubject'];
-                                } else {
-                                    $post['subject'] = html_entity_decode($post['subject']);
-                                }
-
-                                $post['subject'] = censor($post['subject']);
-
-                                if ($post['posts'] > $ppp) {
-                                    $pbefore = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = '".$post['ttid']."' AND pid < '".$post['pid']."'"), 0);
-                                    $page = ceil(($pbefore+1)/$ppp);
-                                } else {
-                                    $page = 1;
-                                }
-                                eval('$searchresults .= "'.template('misc_search_results_row').'";');
-                            }
-                        }
+                    if (isset($forumCache[$post['fid']])) {
+                        $forumPerms = $forumCache[$post['fid']];
+                    } else {
+                        $forumPerms = checkForumPermissions($post);
+                        $forumCache[$post['fid']] = $forumPerms;
                     }
-                    $db->free_result($querysrch);
-                } else {
-                    while($post = $db->fetch_array($querysrch)) {
-                        $fidpw = isset($_COOKIE['fidpw'.$post['fid']]) ? $_COOKIE['fidpw'.$post['fid']] : '';
-                        $authorization = privfcheck($post['fprivate'], $post['fuserlist']);
 
-                        if (($post['password'] != '' && $post['password'] != $fidpw) && !X_SADMIN) {
-                            continue;
-                        }
-
-                        if (isset($post['type']) && $post['type'] == 'sub') {
-                            $query = $db->query("SELECT private, userlist, name, fid FROM ".X_PREFIX."forums WHERE fid='$post[fup]'");
-                            $fup = $db->fetch_array($query);
-                            if (!privfcheck($fup['private'], $fup['userlist'])) {
-                                continue;
-                            }
-                            $db->free_result($query);
-                        }
-
-                        if ($authorization) {
+                    if ($forumPerms[X_PERMS_VIEW] && $forumPerms[X_PERMS_USERLIST] && $forumPerms[X_PERMS_PASSWORD]) {
+                        if ($filter_distinct != 'yes' Or !array_key_exists($post['ttid'], $temparray)) {
                             $tid = $post['ttid'];
-                            if ($post['status'] == 'Banned') {
-                                $post['message'] = $lang['bannedpostmsg'];
-                            }
+                            $temparray[$tid] = true;
+                            $message = stripslashes($post['message']);
 
-                            $message = $post['message'];
-
-                            $srchtxt = str_replace(array('_ ', ' _','% ', ' %'), '', $srchtxt);
-
-                            $position = 0;
-                            if (!empty($srchtxt)) {
-                                $position = strpos($message, $srchtxt, 0);
+                            if (empty($srchtxt)) {
+                                $position = 0;
+                            } else {
+                                $position = stripos($message, cdataOut($srchtxtsq[0]), 0);
                             }
 
                             $show_num = 100;
@@ -433,44 +294,43 @@
                                 $add_post = '...';
                             }
 
-                            $show = substr($message, $min, $max);
-                            $show = preg_replace("/($srchtxt)/i", '<strong><em>\\0</em></strong>', $show);
+                            if (trim($post['subject']) == '') {
+                                $post['subject'] = $post['tsubject'];
+                            }
+
+                            $show = substr($message, $min, $max - $min);
+                            $post['subject'] = stripslashes($post['subject']);
+                            if (!empty($srchtxt)) {
+                                foreach($srchtxtsq as $stxt) {
+                                    $show = str_ireplace(cdataOut($stxt), '<b><i>'.cdataOut($stxt).'</i></b>', $show);
+                                    $post['subject'] = str_ireplace(attrOut($stxt), '<i>'.attrOut($stxt).'</i>', $post['subject']);
+                                }
+                            }
+
                             $show = postify($show, 'no', 'yes', 'yes', 'no', 'no', 'no');
+                            $post['subject'] = rawHTMLsubject($post['subject']);
 
                             $date = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
                             $time = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
+
                             $poston = $date.' '.$lang['textat'].' '.$time;
                             $postby = $post['author'];
-
-                            $post['tsubject'] = stripslashes(censor($post['tsubject']));
-                            if (trim($post['subject']) == '') {
-                                $post['subject'] = html_entity_decode($post['tsubject']);
-                            } else {
-                                $post['tsubject'] = html_entity_decode($post['subject']);
-                            }
-
-                            if ($post['posts'] > $ppp) {
-                                $pbefore = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = '".$post['ttid']."' AND pid < '".$post['pid']."'"), 0);
-                                $page = ceil(($pbefore+1)/$ppp);
-                            } else {
-                                $page = 1;
-                            }
                             eval('$searchresults .= "'.template('misc_search_results_row').'";');
                         }
                     }
-                    $db->free_result($querysrch);
                 }
             }
 
             if ($results == 0) {
                 eval('$searchresults = "'.template('misc_search_results_none').'";');
             } else if ($results == $ppp) {
-                $ext = htmlspecialchars(implode('&', $ext));
+                // create a string containing the stuff to search for
+                $ext = implode('&', $ext);
                 eval('$nextlink = "'.template('misc_search_nextlink').'";');
             }
 
             eval('$search = "'.template('misc_search_results').'";');
-            $misc = stripslashes($search);
+            $misc = $search;
         }
         break;
 
@@ -485,15 +345,14 @@
 
         if (noSubmit('lostpwsubmit')) {
             eval('$misc = "'.template('misc_lostpw').'";');
-            $misc = stripslashes($misc);
         } else {
-            $username = addslashes(formVar('username'));
-            $email = addslashes(formVar('email'));
+            $username = postedVar('username');
+            $email = postedVar('email');
             $query = $db->query("SELECT username, email, pwdate FROM ".X_PREFIX."members WHERE username='$username' AND email='$email'");
             $member = $db->fetch_array($query);
             $db->free_result($query);
 
-            $time = $onlinetime-86400;
+            $time = $onlinetime - 86400;
             if ($member['pwdate'] > $time) {
                 error($lang['lostpw_in24hrs']);
             }
@@ -505,15 +364,16 @@
             $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';
             $newpass = '';
             mt_srand((double)microtime() * 1000000);
-            $max = mt_rand(8, 12);
-            for ($get=strlen($chars), $i=0; $i < $max; $i++) {
+            $get = strlen($chars) - 1;
+            for($i = 0; $i < 13; $i++) {
                 $newpass .= $chars[mt_rand(0, $get)];
             }
-            $newmd5pass = md5(trim($newpass));
+            $newmd5pass = md5($newpass);
 
             $db->query("UPDATE ".X_PREFIX."members SET password='$newmd5pass', pwdate='".$onlinetime."' WHERE username='$member[username]' AND email='$member[email]'");
 
-            altMail($member['email'], '['.$bbname.'] '.$lang['textyourpw'], $lang['textyourpwis']."\n\n".$member['username']."\n".$newpass, "From: ".$bbname." <".$adminemail.">");
+            $emailuname = htmlspecialchars_decode($member['username'], ENT_QUOTES);
+            altMail($member['email'], '['.$bbname.'] '.$lang['textyourpw'], "{$lang['textyourpwis']} \n\n{$lang['textusername']} $emailuname\n{$lang['textpassword']} $newpass", "From: $bbname <$adminemail>");
 
             $misc .= '<span class="mediumtxt"><center>'.$lang['emailpw'].'</span></center><br />';
             $misc .= '<script>function redirect() {window.location.replace("index.php");}setTimeout("redirect();", 1250);</script>';
@@ -572,7 +432,7 @@
             }
 
             if (X_SADMIN && $online['username'] != 'xguest123' && $online['username'] != $lang['textguest1']) {
-                $online['username'] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($online['username']).'">'.$username.'</a>'.$hidden;
+                $online['username'] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($online['username']).'">'.$username.'</a>'.$hidden;
             } else {
                 $online['username'] = $username;
             }
@@ -591,7 +451,6 @@
             eval('$misc = "'.template('misc_online').'";');
         }
 
-        $misc = stripslashes($misc);
         break;
 
     case 'onlinetoday':
@@ -616,7 +475,7 @@
         while($memberstoday = $db->fetch_array($query)) {
             $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
             $suff = '</span>';
-            $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
+            $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff. '</a>';
             ++$todaymembersnum;
         }
         $todaymembers = implode(', ', $todaymembers);
@@ -628,16 +487,15 @@
             $memontoday = $todaymembersnum.$lang['textmemberstoday'];
         }
         eval('$misc = "'.template('misc_online_today').'";');
-        $misc = stripslashes($misc);
         break;
 
     case 'list':
-        $order = getVar('order');
-        $desc = getVar('desc');
+        $order = postedVar('order', '', FALSE, FALSE, FALSE, 'g');
+        $desc = postedVar('desc', '', FALSE, FALSE, FALSE, 'g');
         $page = getInt('page');
-        $srchmem = formVar('srchmem');
-        $srchemail = formVar('srchemail');
-        $srchip = formVar('srchip');
+        $dblikemem = $db->like_escape(postedVar('srchmem', '', TRUE, FALSE));
+        $dblikeemail = $db->like_escape(postedVar('srchemail', '', TRUE, FALSE, TRUE));
+        $dblikeip = $db->like_escape(postedVar('srchip', '', TRUE, FALSE));
 
         if ($SETTINGS['memliststatus'] == 'off') {
             eval('echo "'.template('header').'";');
@@ -647,7 +505,7 @@
             exit();
         }
 
-        if (!$desc || strtolower($desc) != 'desc') {
+        if (strtolower($desc) != 'desc') {
             $desc = 'asc';
         }
 
@@ -660,7 +518,7 @@
             $page = 1;
         }
 
-        if (!$order || ($order != 'username' && $order != 'postnum' && $order != 'status')) {
+        if ($order != 'username' && $order != 'postnum' && $order != 'status') {
             $orderby = "uid";
             $order = 'uid';
         } else if ($order == 'status') {
@@ -670,8 +528,8 @@
         }
 
         if (!X_ADMIN) {
-            $srchip = '';
-            $srchemail = '';
+            $dblikeip = '';
+            $dblikeemail = '';
             $misc_mlist_template = 'misc_mlist';
             $where = array();
         } else {
@@ -681,31 +539,34 @@
 
         $ext = array('&order='.$order);
 
-        if ($srchemail) {
+        if ($dblikeemail != '') {
             if (!X_SADMIN) {
-                $where[] = " email LIKE '%".$srchemail."%'";
+                $where[] = " email LIKE '%$dblikeemail%'";
                 $where[] = " showemail='yes'";
             } else {
-                $where[] = " email LIKE '%".$srchemail."%'";
+                $where[] = " email LIKE '%$dblikeemail%'";
             }
-            $ext[] = 'srchemail='.$srchemail;
-            $srchemail = htmlspecialchars($srchemail);
+            $ext[] = 'srchemail='.rawurlencode(postedVar('srchemail', '', FALSE, FALSE));
+            $srchemail = postedVar('srchemail', 'javascript', TRUE, FALSE, TRUE);
+            /* Warning: $srchemail is used for template output */
         } else {
             $srchemail = '';
         }
 
-        if ($srchip) {
-            $where[] = " regip LIKE '%".$srchip."%'";
-            $ext[] = 'srchip='.$srchip;
-            $srchip = htmlspecialchars($srchip);
+        if ($dblikeip != '') {
+            $where[] = " regip LIKE '%$dblikeip%'";
+            $ext[] = 'srchip='.rawurlencode(postedVar('srchip', '', FALSE, FALSE));
+            $srchip = postedVar('srchip', 'javascript', TRUE, FALSE, TRUE);
+            /* Warning: $srchip is used for template output */
         } else {
             $srchip = '';
         }
 
-        if ($srchmem) {
-            $where[] = " username LIKE '%".addslashes(str_replace(array('%', '_'), array('\%', '\_'), $srchmem))."%'";
-            $ext[] = 'srchmem='.$srchmem;
-            $srchmem = htmlspecialchars($srchmem);
+        if ($dblikemem != '') {
+            $where[] = " username LIKE '%$dblikemem%'";
+            $ext[] = 'srchmem='.rawurlencode(postedVar('srchmem', '', FALSE, FALSE));
+            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE);
+            /* Warning: $srchmem is used for template output */
         } else {
             $srchmem = '';
         }
@@ -716,7 +577,7 @@
         $querymem = $db->query("SELECT * FROM ".X_PREFIX."members WHERE $q ORDER BY $orderby $desc LIMIT $start_limit, $memberperpage");
         $num = $db->result($db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE $q"), 0);
 
-        $ext = htmlspecialchars(implode('&amp;', $ext));
+        $ext = implode('&amp;', $ext);
 
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
 
@@ -749,7 +610,7 @@
                     $member['location'] = '';
                 }
 
-                $memurl = rawurlencode($member['username']);
+                $memurl = recodeOut($member['username']);
                 if ($order == 'status') {
                     if ($oldst != $member['status']) {
                         $oldst = $member['status'];
@@ -781,7 +642,7 @@
             $ascdesc = $lang['desc'];
         }
         eval('$memlist = "'.template($misc_mlist_template).'";');
-        $misc = stripslashes($memlist);
+        $misc = $memlist;
         break;
 
     case 'smilies':
@@ -801,7 +662,7 @@
     case 'captchaimage':
         require ROOT.'include/captcha.inc.php';
         $oPhpCaptcha = new Captcha(250, 50);
-        $imagehash = getVar('imagehash');
+        $imagehash = postedVar('imagehash', '', FALSE, TRUE, FALSE, 'g');
         $oPhpCaptcha->Create($imagehash);
         exit();
         break;
@@ -814,5 +675,5 @@
 eval('$header = "'.template('header').'";');
 end_time();
 eval('$footer = "'.template('footer').'";');
-echo stripslashes($header.$misc.$footer);
+echo $header.$misc.$footer;
 ?>
\ No newline at end of file
Index: post.php
===================================================================
--- post.php	(revision 1095)
+++ post.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,18 +26,10 @@
  *
  **/
 
+define('X_SCRIPT', 'post.php');
+
 require 'header.php';
 
-function bbcodeinsert() {
-    global $imgdir, $bbinsert, $altbg1, $altbg2, $lang, $SETTINGS, $spelling_lang;
-
-    $bbcode = '';
-    if ($SETTINGS['bbinsert'] == 'on') {
-        eval('$bbcode = "'.template('functions_bbcodeinsert').'";');
-    }
-    return $bbcode;
-}
-
 loadtemplates(
 'post_captcha',
 'post_notloggedin',
@@ -60,69 +52,144 @@
 
 eval('$css = "'.template('css').'";');
 
-smcwcache();
+if (X_GUEST) {
+    eval('$loggedin = "'.template('post_notloggedin').'";');
+} else {
+    eval('$loggedin = "'.template('post_loggedin').'";');
+}
 
-$pid = getRequestInt('pid');
-$tid = getRequestInt('tid');
-$fid = getRequestInt('fid');
-$posterror = false;
+if ($self['ban'] == "posts" || $self['ban'] == "both") {
+    error($lang['textbanfrompost']);
+}
 
-validatePpp();
-
-$thread = array();
-$threadname = '';
-
-if ($tid) {
-    $query = $db->query("SELECT fid, subject FROM ".X_PREFIX."threads WHERE tid='$tid' LIMIT 1");
-    if ($db->num_rows($query) == 1) {
-        $thread = $db->fetch_array($query);
-        $db->free_result($query);
-        $threadname = html_entity_decode(stripslashes(htmlspecialchars($thread['subject'])));
-        $fid = (int) $thread['fid'];
-    } else {
+//Validate $pid, $tid, $fid, and $repquote
+$fid = -1;
+$tid = -1;
+$pid = -1;
+$repquote = -1;
+if ($action == 'edit') {
+    $pid = getRequestInt('pid');
+    $query = $db->query("SELECT f.*, t.tid FROM ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) LEFT JOIN ".X_PREFIX."forums AS f ON f.fid=t.fid WHERE p.pid=$pid");
+    if ($db->num_rows($query) != 1) {
         error($lang['textnothread']);
     }
+    $forum = $db->fetch_array($query);
+    $db->free_result($query);
+    $fid = $forum['fid'];
+    $tid = $forum['tid'];
+} else if ($action == 'reply') {
+    $tid = getRequestInt('tid');
+    $repquote = getInt('repquote');
+    $query = $db->query("SELECT f.* FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."forums AS f USING (fid) WHERE t.tid=$tid");
+    if ($db->num_rows($query) != 1) {
+        error($lang['textnothread']);
+    }
+    $forum = $db->fetch_array($query);
+    $db->free_result($query);
+    $fid = $forum['fid'];
+} else if ($action == 'newthread') {
+    $fid = getRequestInt('fid');
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
+    if ($db->num_rows($query) != 1) {
+        error($lang['textnoforum']);
+    }
+    $forum = $db->fetch_array($query);
+    $db->free_result($query);
+} else {
+    error($lang['textnoaction']);
 }
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
-$forums = $db->fetch_array($query);
-$db->free_result($query);
-$forums['name'] = stripslashes($forums['name']);
+if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    error($lang['textnoforum']);
+}
 
-if (($fid == 0 && $tid == 0) || (!isset($forums['type']) && $forums['type'] != 'forum' && $forums['type'] != 'sub' && $forums['fid'] != $fid)) {
-    $posterror = $lang['textnoforum'];
+smcwcache();
+
+if ($tid > 0) {
+    $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid=$tid");
+    if ($db->num_rows($query) != 1) {
+        error($lang['textnothread']);
+    }
+    $thread = $db->fetch_array($query);
+    $db->free_result($query);
+    $threadname = rawHTMLsubject(stripslashes($thread['subject']));
+} else {
+    $thread = array();
+    $threadname = '';
 }
 
-if (isset($forums['type']) && $forums['type'] == 'forum') {
-    nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode(stripslashes($forums['name'])).'</a>');
+//Warning! These variables are used for template output.
+$captchapostcheck = '';
+$dissubject = '';
+$message = '';
+$message1 = '';
+$preview = '';
+$spelling_lang = '';
+$spelling_submit1 = '';
+$spelling_submit2 = '';
+$subject = '';
+$suggestions = '';
+if (X_GUEST) {
+    $username = 'Anonymous';
 } else {
-    if (!isset($forums['fup']) || !is_numeric($forums['fup'])) {
-        $posterror = $lang['textnoforum'];
-    } else {
-        $query = $db->query("SELECT name, fid FROM ".X_PREFIX."forums WHERE fid='$forums[fup]'");
-        $fup = $db->fetch_array($query);
-        nav('<a href="forumdisplay.php?fid='.intval($fup['fid']).'">'.html_entity_decode(stripslashes($fup['name'])).'</a>');
-        nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode(stripslashes($forums['name'])).'</a>');
-    }
+    $username = $xmbuser;
 }
 
-$attachfile = '';
-if (isset($forums['attachstatus']) && $forums['attachstatus'] != 'off') {
-    eval('$attachfile = "'.template("post_attachmentbox").'";');
+validatePpp();
+
+$poll = postedVar('poll', '', FALSE, FALSE, FALSE, 'g');
+if ($poll != 'yes') {
+    $poll = '';
 }
 
-if (X_GUEST) {
-    eval('$loggedin = "'.template('post_notloggedin').'";');
+// check permissions on this forum (and top forum if it's a sub?)
+$perms = checkForumPermissions($forum);
+if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+    error($lang['privforummsg']);
+} else if (!$perms[X_PERMS_PASSWORD]) {
+    handlePasswordDialog($fid);
+}
+
+// check posting permissions specifically
+if ($action == 'newthread') {
+    if (($poll == '' && !$perms[X_PERMS_THREAD]) || ($poll == 'yes' && !$perms[X_PERMS_POLL])) {
+        error($lang['textnoaction']);
+    }
+} else if ($action == 'reply') {
+    if (!$perms[X_PERMS_REPLY]) {
+        error($lang['textnoaction']);
+    }
+} else if ($action == 'edit') {
+    // let's allow edits for now, we'll check for permissions later on in the script (due to need for $orig['author'])
 } else {
-    eval('$loggedin = "'.template('post_loggedin').'";');
+    error($lang['textnoaction']);
 }
 
-if ($self['ban'] == "posts" || $self['ban'] == "both") {
-    error($lang['textbanfrompost']);
+$fup = array();
+if ($forum['type'] == 'sub') {
+    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+
+    // prevent access to subforum when upper forum can't be viewed.
+    $fupPerms = checkForumPermissions($fup);
+    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST] || !$fupPerms[X_PERMS_PASSWORD]) {
+        error($lang['privforummsg']);     // do not show password-dialog here; it makes the situation too complicated
+    } else if ($fup['fup'] > 0) {
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+    }
+    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+} else if ($forum['fup'] > 0) { // 'forum' in a 'group'
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+    nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 }
+nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forum['name']).'</a>');
 
-if ($self['status'] == "Banned") {
-    error($lang['bannedmessage']);
+$attachfile = '';
+if (isset($forum['attachstatus']) && $forum['attachstatus'] == 'on') {
+    eval('$attachfile = "'.template("post_attachmentbox").'";');
 }
 
 $listed_icons = 0;
@@ -131,7 +198,6 @@
     $captchapostcheck = '';
     if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
         require ROOT.'include/captcha.inc.php';
-        $Captcha = new Captcha(250, 50);
     }
 
     $querysmilie = $db->query("SELECT url, code FROM ".X_PREFIX."smilies WHERE type='picon'");
@@ -156,33 +222,11 @@
     $usesig = 'no';
 }
 
-$chkInputHTML = 'no';
-$chkInputTags = 'no';
-if (isset($forums['allowhtml']) && $forums['allowhtml'] == 'yes') {
-    $chkInputHTML = 'yes';
-    $chkInputTags = 'no';
-}
+$allowimgcode = (isset($forum['allowimgcode']) && $forum['allowimgcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowhtml = (isset($forum['allowhtml']) && $forum['allowhtml'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowsmilies = (isset($forum['allowsmilies']) && $forum['allowsmilies'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowbbcode = (isset($forum['allowbbcode']) && $forum['allowbbcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
 
-$allowimgcode = (isset($forums['allowimgcode']) && $forums['allowimgcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowhtml = ($chkInputHTML == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowsmilies = (isset($forums['allowsmilies']) && $forums['allowsmilies'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowbbcode = (isset($forums['allowbbcode']) && $forums['allowbbcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$pperm['type'] = (isset($action) && $action == 'newthread') ? 'thread' : 'reply';
-
-if (!postperm($forums, $pperm['type'])) {
-    error($lang['privforummsg']);
-}
-
-if (X_GUEST && isset($forums['guestposting']) && $forums['guestposting'] == 'on') {
-    $guestpostingmsg = $lang['guestpostingonmsg'];
-} else {
-    $guestpostingmsg = '';
-}
-
-if ($posterror) {
-    error($posterror);
-}
-
 if (isset($smileyoff) && $smileyoff == 'yes') {
     $smileoffcheck = $cheHTML;
 } else {
@@ -239,28 +283,8 @@
     $closecheck = '';
 }
 
-$repquote = isset($repquote) ? (int) $repquote : 0;
-if (isset($poll)) {
-    if ($poll != 'yes') {
-        $poll = '';
-    } else {
-        $poll = 'yes';
-    }
-} else {
-    $poll = '';
-}
-
-pwverify($forums['password'], 'post.php?action='.$action.'&fid='.$fid.'&tid='.$tid.'&repquote='.$repquote.'&poll='.$poll, $fid);
-
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
-$forum = $db->fetch_array($query);
-$db->free_result($query);
-$authorization = privfcheck($forum['private'], $forum['userlist']);
-if (!$authorization) {
-    error($lang['privforummsg']);
-}
-
-if (!empty($posticon)) {
+$posticon = postedVar('posticon', 'javascript', TRUE, TRUE, TRUE);
+if ($posticon != '') {
     $thread['icon'] = (file_exists($smdir.'/'.$posticon)) ? "<img src=\"$smdir/$posticon\" />" : '';
     $icons = str_replace('<input type="radio" name="posticon" value="'.$posticon.'" />', '<input type="radio" name="posticon" value="'.$posticon.'" checked="checked" />', $icons);
 } else {
@@ -268,20 +292,23 @@
     $icons = str_replace('<input type="radio" name="posticon" value="" />', '<input type="radio" name="posticon" value="" checked="checked" />', $icons);
 }
 
+$messageinput = postedVar('message', '', TRUE, FALSE);  //postify() is responsible for DECODING if html is allowed.
+
 if ($SETTINGS['spellcheck'] == 'on') {
     $spelling_submit1 = '<input type="hidden" name="subaction" value="spellcheck" /><input type="submit" class="submit" name="spellchecksubmit" value="'.$lang['checkspelling'].'" />';
     $spelling_lang = '<select name="language"><option value="en" selected="selected">English</option></select>';
     if (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit))) {
-        if (!$updates_submit) {
-            $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-            $message = checkInput($message, $chkInputTags, $chkInputHTML, '', true);
+        if (isset($language) && !isset($updates_submit)) {
             require ROOT.'include/spelling.inc.php';
             $spelling = new spelling($language);
-            $problems = $spelling->check_text($message);
+            $problems = $spelling->check_text(postedVar('message', '', FALSE, FALSE));  //Use raw value so we're not checking entity names.
             if (count($problems) > 0) {
-                foreach($problems as $orig=>$new) {
+                $suggest = array();
+                foreach($problems as $raworig=>$new) {
+                    $orig = cdataOut($raworig);
                     $mistake = array();
-                    foreach($new as $suggestion) {
+                    foreach($new as $rawsuggestion) {
+                        $suggestion = attrOut($rawsuggestion);
                         eval('$mistake[] = "'.template('spelling_suggestion_new').'";');
                     }
                     $mistake = implode("\n", $mistake);
@@ -292,67 +319,32 @@
                 $spelling_submit2 = '<input type="submit" class="submit" name="updates_submit" value="'.$lang['replace'].'" />';
             } else {
                 eval('$suggestions = "'.template('spelling_suggestion_no').'";');
-                $spelling_submit2 = '';
             }
         } else {
+            $old_words = postedArray('old_words', 'string', '', TRUE, FALSE);
             foreach($old_words as $word) {
-                $message = str_replace($word, ${'replace_'.$word}, $message);
+                $replacement = postedVar('replace_'.$word, '', TRUE, FALSE);
+                $messageinput = str_replace($word, $replacement, $messageinput);
             }
-            $spelling_submit2 = '';
         }
-    } else {
-        $suggestions = '';
-        $spelling_submit2 = '';
     }
-} else {
-    $spelling_submit1 = '';
-    $spelling_submit2 = '';
-    $spelling_lang = '';
-    $suggestions = '';
 }
 
-if (isset($topicsubmit)) {
-    if (!isset($subject) || trim($subject) == '') {
-        $preview = error($lang['textnosubject'], false, '', '<br /><br />', false, false, true, false);
-        $error = true;
-        unset($topicsubmit);
-        if (isset($previewpost)) {
-            unset($previewpost);
-        }
-    } else {
-        $preview = '';
-        $error = false;
-    }
-} else {
-    $error = false;
-}
-
 $bbcodeinsert = bbcodeinsert();
 $smilieinsert = smilieinsert();
 
+//Allow sanitized message to pass-through to template in case of: #1 preview, #2 post error
+$subject = rawHTMLsubject(postedVar('subject', 'javascript', TRUE, FALSE, TRUE));  //per viewthread design of version 1.9.9, HTML is never allowed in subjects.
+$message = rawHTMLmessage($messageinput);
+
 if (isset($previewpost)) {
     $currtime = $onlinetime;
     $date = gmdate($dateformat, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
     $time = gmdate($timecode, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
     $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
-
-    $subject = html_entity_decode(checkInput($subject, $chkInputTags, $chkInputHTML, '', false));
-    $message = html_entity_decode(checkInput($message, $chkInputTags, $chkInputHTML, '', true));
-    $message1 = postify($message, $smileyoff, $bbcodeoff, $forums['allowsmilies'], $forums['allowhtml'], $forums['allowbbcode'], $forums['allowimgcode']);
-    $dissubject = censor($subject);
-
-    if ($pid > 0) {
-        eval('$preview = stripslashes("'.template('post_preview').'");');
-    } else {
-        eval('$preview = "'.template('post_preview').'";');
-    }
-} else if ($error) {
-    $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-    $message = checkInput($message, $chkInputTags, $chkInputHTML, '', true);
-} else {
-    $preview = '';
-    $subject = (isset($subject) ? $subject : '');
-    $message = (isset($message) ? $message : '');
+    $dissubject = $subject;
+    $message1 = postify($messageinput, $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+    eval('$preview = "'.template('post_preview').'";');
 }
 
 switch($action) {
@@ -360,419 +352,382 @@
         nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
         nav($lang['textreply']);
 
-        $priv = privfcheck($forums['private'], $forums['userlist']);
-        if (!isset($replysubmit) || !$replysubmit) {
-            if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
-                if ($Captcha->bCompatible !== false) {
-                    $imghash = $Captcha->GenerateCode();
-                    eval('$captchapostcheck = "'.template('post_captcha').'";');
-                }
-            }
+        if ($SETTINGS['subject_in_title'] == 'on') {
+            $threadSubject = '- '.$threadname;
+        }
 
-            $posts = '';
-            eval('echo "'.template('header').'";');
+        eval('echo "'.template('header').'";');
 
-            if (X_STAFF) {
-                $closeoption = '<br /><input type="checkbox" name="closetopic" value="yes" '.$closecheck.' /> '.$lang['closemsgques'].'<br />';
+        $replyvalid = onSubmit('replysubmit'); // This new flag will indicate a message was submitted and successful.
+
+        //Check all replying permissions for this $tid.
+        if (!X_SADMIN And $thread['closed'] != '') {
+            if ($replyvalid) {
+                softerror($lang['closedmsg']);
             } else {
-                $closeoption = '';
+                error($lang['closedmsg']);
             }
+            $replyvalid = FALSE;
+        }
 
-            if (isset($repquote) && ($repquote = (int) $repquote)) {
-                $query = $db->query("SELECT p.message, p.fid, p.author, f.private AS fprivate, f.userlist AS fuserlist, f.password AS fpassword FROM ".X_PREFIX."posts p, ".X_PREFIX."forums f WHERE p.pid=$repquote AND f.fid=p.fid");
-                $thaquote = $db->fetch_array($query);
-                $db->free_result($query);
-                $quotefid = $thaquote['fid'];
-                $pass = trim($thaquote['fpassword']);
+        if ($replyvalid) {
+            if (X_GUEST) { // Anonymous posting is allowed, and was checked in forum perms at top of file.
+                $password = '';
+                if (strlen(postedVar('username')) > 0 And isset($_POST['password'])) {
+                    if (loginUser(postedVar('username'), md5($_POST['password']))) {
+                        if ($self['status'] == "Banned") {
+                            softerror($lang['bannedmessage']);
+                            $replyvalid = FALSE;
+                        } else if ($self['ban'] == "posts" || $self['ban'] == "both") {
+                            softerror($lang['textbanfrompost']);
+                            $replyvalid = FALSE;
+                        } else {
+                            $username = $xmbuser;
 
-                if (!X_ADMIN && trim($pass) != '' && $_COOKIE['fidpw'.$quotefid] != $pass) {
-                   error($lang['privforummsg'], false);
-                }
+                            // check permissions on this forum (and top forum if it's a sub?)
+                            $perms = checkForumPermissions($forum);
+                            if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+                                softerror($lang['privforummsg']);
+                                $topicvalid = FALSE;
+                            } else if (!$perms[X_PERMS_REPLY]) {
+                                softerror($lang['textnoaction']);
+                                $topicvalid = FALSE;
+                            }
 
-                $authorization = privfcheck($thaquote['fprivate'], $thaquote['fuserlist']);
-                if (!$authorization) {
-                    error($lang['privforummsg'], false);
-                }
-                $message = html_entity_decode("[quote][i]$lang[origpostedby] $thaquote[author][/i]\n$thaquote[message] [/quote]");
-            }
-
-            $querytop = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
-            $replynum = $db->result($querytop, 0);
-            if ($replynum >= $ppp) {
-                $threadlink = 'viewthread.php?fid='.$fid.'&tid='.$tid;
-                eval($lang['evaltrevlt']);
-                eval('$posts .= "'.template('post_reply_review_toolong').'";');
-            } else {
-                $thisbg = $altbg1;
-                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC");
-                while($post = $db->fetch_array($query)) {
-                    $date = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-                    $time = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-                    $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
-
-                    if ($post['icon'] != '') {
-                        $post['icon'] = '<img src="'.$smdir.'/'.$post['icon'].'" alt="'.$lang['altpostmood'].'" border="0" />';
+                            if ($forum['type'] == 'sub') {
+                                // prevent access to subforum when upper forum can't be viewed.
+                                $fupPerms = checkForumPermissions($fup);
+                                if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+                                    softerror($lang['privforummsg']);
+                                    $topicvalid = FALSE;
+                                }
+                            }
+                        }
                     } else {
-                        $post['icon'] = '<img src="'.$imgdir.'/default_icon.gif" alt="[*]" border="0" />';
+                        softerror($lang['textpw1']);
+                        $replyvalid = FALSE;
                     }
-
-                    $post['message'] = postify($post['message'], $post['smileyoff'], $post['bbcodeoff'], $forums['allowsmilies'], $forums['allowhtml'], $forums['allowbbcode'], $forums['allowimgcode']);
-                    eval('$posts .= "'.template('post_reply_review_post').'";');
-                    if ($thisbg == $altbg2) {
-                        $thisbg = $altbg1;
-                    } else {
-                        $thisbg = $altbg2;
+                } else if ($SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
+                    $Captcha = new Captcha(250, 50);
+                    if ($Captcha->bCompatible !== false) {
+                        $imghash = $db->escape($imghash);
+                        if ($Captcha->ValidateCode($imgcode, $imghash) !== TRUE) {
+                            softerror($lang['captchaimageinvalid']);
+                            $replyvalid = FALSE;
+                        }
                     }
+                    unset($Captcha);
                 }
-                $db->free_result($query);
             }
-            $db->free_result($querytop);
+        }
 
-            $attachfile = '';
-            if (isset($forums['attachstatus']) && $forums['attachstatus'] == 'on') {
-                eval('$attachfile = "'.template('post_attachmentbox').'";');
+        if ($replyvalid) {
+            $attachedfile = FALSE;
+            if (isset($_FILES['attach'])) {
+                $attachedfile = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize']);
             }
-            eval('echo stripslashes("'.template('post_reply').'");');
-        } else {
-            if (!$subject && !$message) {
-                error($lang['postnothing']);
-            }
 
-            if (X_MEMBER && empty($username) && empty($password)) {
-                $username = $xmbuser;
-                $password = $xmbpw;
+            if (strlen(postedVar('subject')) == 0 && strlen($messageinput) == 0 && $attachedfile === FALSE) {
+                softerror($lang['postnothing']);
+                $replyvalid = FALSE;
             }
+        }
 
-            if (!empty($username) && !empty($password)) {
-                if (X_GUEST) {
-                    $username = trim($username);
-                    $password = md5(trim($password));
-                }
-
-                $q = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$username'");
-                if ($db->num_rows($q) != 1) {
-                    $db->free_result($q);
-                    error($lang['badname']);
-                } else {
-                    $self = $db->fetch_array($q);
-                    if ($password != $self['password']) {
-                        error($lang['textpw1']);
-                    }
-                    $username = $self['username'];
-                    $db->free_result($q);
-                }
-
-                if ($self['status'] == "Banned") {
-                    error($lang['bannedmessage']);
-                }
-
-                $currtime = $onlinetime + (86400*30);
-                put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-                put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
-
-                if ($self['ban'] == 'posts' || $self['ban'] == 'both') {
-                    error($lang['textbanfrompost']);
-                }
-            } else {
-                if (X_GUEST) {
-                    $username = 'Anonymous';
-                } else {
-                    $username = $xmbuser;
-                }
-            }
-
-            if ($username == 'Anonymous' && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
-                if ($Captcha->bCompatible !== false) {
-                    $imghash = addslashes($imghash);
-                    $imgcode = addslashes($imgcode);
-                    if ($Captcha->ValidateCode($imgcode, $imghash) !== true) {
-                        error($lang['captchaimageinvalid']);
-                    }
-                }
-            }
-
-            if ($forums['guestposting'] != 'on' && $username == 'Anonymous') {
-                error($lang['textnoguestposting']);
-            }
-
-            $pperm = explode('|', $forums['postperm']);
-            if ($pperm[1] == 2 && !X_ADMIN) {
-                error($lang['postpermerr']);
-            } else if ($pperm[1] == 3 && !X_STAFF) {
-                error($lang['postpermerr']);
-            } else if ($pperm[1] == 4) {
-                error($lang['postpermerr']);
-            }
-
-            if (isset($posticon) && $posticon != "") {
+        if ($replyvalid) {
+            if ($posticon != '') {
                 $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
-                if (!$db->result($query, 0)) {
-                    $db->free_result($query);
-                    exit();
+                if ($db->num_rows($query) == 0) {
+                    $posticon = '';
+                    softerror($lang['error']);
+                    $replyvalid = FALSE;
                 }
-            } else {
-                $posticon = '';
+                $db->free_result($query);
             }
+        }
 
-            $query = $db->query("SELECT lastpost, type, fup FROM ".X_PREFIX."forums WHERE fid='$fid'");
-            $for = $db->fetch_array($query);
-            $db->free_result($query);
-            $last = $for['lastpost'];
-
-            if ($last != '') {
-                $lastpost = explode('|', $last);
+        if ($replyvalid) {
+            if ($forum['lastpost'] != '') {
+                $lastpost = explode('|', $forum['lastpost']);
                 $rightnow = $onlinetime - $floodctrl;
                 if ($rightnow <= $lastpost[0] && $username == $lastpost[1]) {
                     $floodlink = "<a href=\"viewthread.php?fid=$fid&tid=$tid\">Click here</a>";
-                    error($lang['floodprotect'].' '.$floodlink.' '.$lang['tocont']);
+                    softerror($lang['floodprotect'].' '.$floodlink.' '.$lang['tocont']);
+                    $replyvalid = FALSE;
                 }
             }
+        }
 
+        if ($replyvalid) {
             if ($usesig != "yes") {
                 $usesig = "no";
             }
 
-            $subject = addslashes($subject);
-            $message = addslashes($message);
+            $thatime = $onlinetime;
+            $dbmessage = $db->escape(addslashes($messageinput)); //The message column is historically double-quoted.
+            $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
+            $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ($fid, $tid, '$username', '$dbmessage', '$dbsubject', ".$db->time(time()).", '$posticon', '$usesig', '$onlineip', '$bbcodeoff', '$smileyoff')");
+            $pid = $db->insert_id();
 
-            $query = $db->query("SELECT closed, topped FROM ".X_PREFIX."threads WHERE fid='$fid' AND tid='$tid'");
-            $closed1 = $db->fetch_array($query);
-            $db->free_result($query);
-            $closed = $closed1['closed'];
-            if ($closed == 'yes' && !X_STAFF) {
-                error($lang['closedmsg']);
-            } else {
-                $thatime = $onlinetime;
-                $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-                $message = checkInput($message, $chkInputTags, $chkInputHTML, '', true);
-                $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ($fid, $tid, '$username', '$message', '$subject', ".$db->time(time()).", '$posticon', '$usesig', '$onlineip', '$bbcodeoff', '$smileyoff')");
-                $pid = $db->insert_id();
+            if ((X_STAFF) && $closetopic == 'yes') {
+                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
+            }
 
-                if ((X_STAFF) && $closetopic == 'yes') {
-                    $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
-                }
+            $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$thatime|$username|$pid', replies=replies+1 WHERE tid=$tid");
 
-                $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$thatime|$username|$pid', replies=replies+1 WHERE (tid='$tid' AND fid='$fid') OR closed='moved|$tid'");
+            $where = "WHERE fid=$fid";
+            if ($forum['type'] == 'sub') {
+                $where .= " OR fid={$forum['fup']}";
+            }
+            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', posts=posts+1 $where");
+            unset($where);
 
-                if ($for['type'] == 'sub') {
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', posts=posts+1 WHERE fid='$for[fup]'");
-                }
+            $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+1 WHERE username='$username'");
 
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', posts=posts+1 WHERE fid='$fid'");
-                $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+1 WHERE username='$username'");
+            $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE pid <= $pid AND tid='$tid'");
+            $posts = $db->result($query,0);
+            $db->free_result($query);
 
-                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE pid <= $pid AND tid='$tid'");
-                $posts = $db->result($query,0);
-                $db->free_result($query);
+            if ($posts > $ppp) {
+                $topicpages = quickpage($posts, $ppp);
+            } else {
+                $topicpages = 1;
+            }
 
-                if ($posts > $ppp) {
-                    $topicpages = quickpage($posts, $ppp);
-                } else {
-                    $topicpages = 1;
+            $date = $db->result($db->query("SELECT dateline FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid < $pid ORDER BY pid ASC LIMIT 1"), 0);
+            $subquery = $db->query("SELECT m.email, m.lastvisit, m.ppp, m.status FROM ".X_PREFIX."favorites f LEFT JOIN ".X_PREFIX."members m ON (m.username=f.username) WHERE f.type='subscription' AND f.tid='$tid' AND f.username!= '$username'");
+            while($subs = $db->fetch_array($subquery)) {
+                if ($subs['status'] == 'banned' || $subs['lastvisit'] < $date) {
+                    continue;
                 }
 
-                $date = $db->result($db->query("SELECT dateline FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid < $pid ORDER BY pid ASC LIMIT 1"), 0);
-                $subquery = $db->query("SELECT m.email, m.lastvisit, m.ppp, m.status FROM ".X_PREFIX."favorites f LEFT JOIN ".X_PREFIX."members m ON (m.username=f.username) WHERE f.type='subscription' AND f.tid='$tid' AND f.username!= '$username'");
-                while($subs = $db->fetch_array($subquery)) {
-                    if ($subs['status'] == 'banned' || $subs['lastvisit'] < $date) {
-                        continue;
-                    }
-
-                    if ($subs['ppp'] < 1) {
-                        $subs['ppp'] = $posts;
-                    }
-
-                    $topicpages = quickpage($posts, $subs['ppp']);
-                    $threadurl = $SETTINGS['boardurl'] . 'viewthread.php?tid='.$tid.'&page='.$topicpages.'#pid'.$pid;
-                    altMail($subs['email'], $lang['textsubsubject'].' '.$threadname, $username.' '.$lang['textsubbody']." \n".$threadurl, "From: $bbname <$adminemail>");
+                if ($subs['ppp'] < 1) {
+                    $subs['ppp'] = $posts;
                 }
-                $db->free_result($subquery);
 
-                if (isset($emailnotify) && $emailnotify == 'yes') {
-                    $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid='$tid' AND username='$xmbuser' AND type='subscription'");
-                    if ($db->num_rows($query) < 1) {
-                        $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ($tid, '$username', 'subscription')");
-                    }
-                    $db->free_result($query);
-                }
+                $topicpages = quickpage($posts, $subs['ppp']);
+                $threadurl = $SETTINGS['boardurl'] . 'viewthread.php?tid='.$tid.'&page='.$topicpages.'#pid'.$pid;
+                $rawsubject = htmlspecialchars_decode($threadname, ENT_QUOTES);
+                altMail($subs['email'], $lang['textsubsubject'].' '.$rawsubject, $username.' '.$lang['textsubbody']." \n".$threadurl, "From: $bbname <$adminemail>");
+            }
+            $db->free_result($subquery);
 
-                eval('echo "'.template('header').'";');
-
-                if (isset($_FILES['attach']) && ($attachedfile = get_attached_file($_FILES['attach'], $forums['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
-                    $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$filetype', '$filesize', '$attachedfile', 0)");
+            if (isset($emailnotify) && $emailnotify == 'yes') {
+                $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid='$tid' AND username='$username' AND type='subscription'");
+                if ($db->num_rows($query) < 1) {
+                    $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ($tid, '$username', 'subscription')");
                 }
+                $db->free_result($query);
             }
 
-            if (X_MEMBER) {
-                $currtime = $onlinetime + (86400*30);
-                put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-                put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
+            if ($attachedfile != FALSE) {
+                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$filetype', '$filesize', '$attachedfile', 0)");
             }
 
             $topicpages = quickpage($posts, $ppp);
             message($lang['replymsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
         }
-        break;
 
-    case 'newthread':
-        $priv = privfcheck($forums['private'], $forums['userlist']);
-        if (isset($poll) && $poll == 'yes') {
-            nav($lang['textnewpoll']);
-        } else {
-            nav($lang['textpostnew']);
-        }
-
-        if (!isset($topicsubmit) || !$topicsubmit) {
+        if (!$replyvalid) {
             if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
+                $Captcha = new Captcha(250, 50);
                 if ($Captcha->bCompatible !== false) {
                     $imghash = $Captcha->GenerateCode();
                     eval('$captchapostcheck = "'.template('post_captcha').'";');
                 }
+                unset($Captcha);
             }
 
-            eval('echo "'.template('header').'";');
+            $posts = '';
 
-            $status1 = modcheck($self['status'], $xmbuser, $forums['moderator']);
-            if ($self['status'] == "Super Moderator") {
-                $status1 = "Moderator";
-            }
-
             if (X_STAFF) {
-                $topoption = '<br /><input type="checkbox" name="toptopic" value="yes" '.$topcheck.' /> '.$lang['topmsgques'];
                 $closeoption = '<br /><input type="checkbox" name="closetopic" value="yes" '.$closecheck.' /> '.$lang['closemsgques'].'<br />';
             } else {
-                $topoption = '';
                 $closeoption = '';
             }
 
-            if (!isset($spelling_submit2)) {
-                $spelling_submit2 = '';
-            }
+            if (isset($repquote) && ($repquote = (int) $repquote)) {
+                $query = $db->query("SELECT p.message, p.fid, p.author, f.postperm, f.userlist, f.password FROM ".X_PREFIX."posts p, ".X_PREFIX."forums f WHERE p.pid=$repquote AND f.fid=p.fid");
+                $thaquote = $db->fetch_array($query);
+                $db->free_result($query);
+                $quotefid = $thaquote['fid'];
 
-            if (isset($poll) && $poll == 'yes' && $forums['pollstatus'] != 'off') {
-                if (!isset($pollanswers)){
-                    $pollanswers = '';
+                $quoteperms = checkForumPermissions($thaquote);
+                if ($quoteperms[X_PERMS_VIEW] And $quoteperms[X_PERMS_USERLIST]) {
+                    $message = "[quote][i]{$lang['origpostedby']} {$thaquote['author']}[/i]\n".rawHTMLmessage(stripslashes($thaquote['message']))." [/quote]"; //Messages are historically double-quoted.
                 }
-                eval('echo stripslashes("'.template('post_newpoll').'");');
-            } else {
-                eval('echo stripslashes("'.template('post_newthread').'");');
             }
-        } else {
-            if (!empty($username) && !empty($password)) {
-                if (X_GUEST) {
-                    $password = md5(trim($password));
-                }
 
-                $username = trim($username);
-                $q = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$username'");
-                if ($db->num_rows($q) != 1) {
-                    $db->free_result($q);
-                    error($lang['badname']);
-                } else {
-                    $self = $db->fetch_array($q);
-                    if ($password != $self['password']) {
-                        error($lang['textpw1']);
+            $querytop = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
+            $replynum = $db->result($querytop, 0);
+            if ($replynum >= $ppp) {
+                $threadlink = 'viewthread.php?fid='.$fid.'&tid='.$tid;
+                eval($lang['evaltrevlt']);
+                eval('$posts .= "'.template('post_reply_review_toolong').'";');
+            } else {
+                $thisbg = $altbg1;
+                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC");
+                while($post = $db->fetch_array($query)) {
+                    $date = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
+                    $time = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
+                    $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
+
+                    if ($post['icon'] != '') {
+                        $post['icon'] = '<img src="'.$smdir.'/'.$post['icon'].'" alt="'.$lang['altpostmood'].'" border="0" />';
+                    } else {
+                        $post['icon'] = '<img src="'.$imgdir.'/default_icon.gif" alt="[*]" border="0" />';
                     }
-                    $username = $self['username'];
-                    $db->free_result($q);
-                }
 
-                if ($self['status'] == "Banned") {
-                    error($lang['bannedmessage']);
+                    $post['message'] = postify(stripslashes($post['message']), $post['smileyoff'], $post['bbcodeoff'], $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+                    eval('$posts .= "'.template('post_reply_review_post').'";');
+                    if ($thisbg == $altbg2) {
+                        $thisbg = $altbg1;
+                    } else {
+                        $thisbg = $altbg2;
+                    }
                 }
+                $db->free_result($query);
+            }
+            $db->free_result($querytop);
 
-                $currtime = $onlinetime + (86400*30);
-                put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-                put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
-
-                if ($self['ban'] == "posts" || $self['ban'] == "both") {
-                    error($lang['textbanfrompost']);
-                }
-            } else {
-                if (X_GUEST) {
-                    $username = "Anonymous";
-                } else {
-                    $username = $xmbuser;
-                }
+            $rawperms = explode(',', $forum['postperm']);
+            if ($rawperms[X_PERMS_REPLY] == 32) { // Member posting is not allowed, do not request credentials!
+                $loggedin = '';
             }
 
-            if ($username == 'Anonymous' && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
-                if ($Captcha->bCompatible !== false) {
-                    $imghash = addslashes($imghash);
-                    $imgcode = addslashes($imgcode);
-                    if ($Captcha->ValidateCode($imgcode, $imghash) !== true) {
-                        error($lang['captchaimageinvalid']);
+            eval('echo "'.template('post_reply').'";');
+        }
+        break;
+
+    case 'newthread':
+        if ($poll == 'yes') {
+            nav($lang['textnewpoll']);
+        } else {
+            nav($lang['textpostnew']);
+        }
+
+        if ($SETTINGS['subject_in_title'] == 'on') {
+            $threadSubject = '- '.$dissubject;
+        }
+
+        eval('echo "'.template('header').'";');
+
+        $pollanswers = postedVar('pollanswers', '', TRUE, FALSE);
+        $topicvalid = onSubmit('topicsubmit'); // This new flag will indicate a message was submitted and successful.
+
+        if ($topicvalid) {
+            if (X_GUEST) { // Anonymous posting is allowed, and was checked in forum perms at top of file.
+                $password = '';
+                if (strlen(postedVar('username')) > 0 And isset($_POST['password'])) {
+                    if (loginUser(postedVar('username'), md5($_POST['password']))) {
+                        if ($self['status'] == "Banned") {
+                            softerror($lang['bannedmessage']);
+                            $topicvalid = FALSE;
+                        } else if ($self['ban'] == "posts" || $self['ban'] == "both") {
+                            softerror($lang['textbanfrompost']);
+                            $topicvalid = FALSE;
+                        } else {
+                            $username = $xmbuser;
+
+                            // check permissions on this forum (and top forum if it's a sub?)
+                            $perms = checkForumPermissions($forum);
+                            if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+                                softerror($lang['privforummsg']);
+                                $topicvalid = FALSE;
+                            } else if (($poll == '' && !$perms[X_PERMS_THREAD]) || ($poll == 'yes' && !$perms[X_PERMS_POLL])) {
+                                softerror($lang['textnoaction']);
+                                $topicvalid = FALSE;
+                            }
+
+                            if ($forum['type'] == 'sub') {
+                                // prevent access to subforum when upper forum can't be viewed.
+                                $fupPerms = checkForumPermissions($fup);
+                                if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+                                    softerror($lang['privforummsg']);
+                                    $topicvalid = FALSE;
+                                }
+                            }
+                        }
+                    } else {
+                        softerror($lang['textpw1']);
+                        $topicvalid = FALSE;
                     }
+                } else if ($SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
+                    $Captcha = new Captcha(250, 50);
+                    if ($Captcha->bCompatible !== false) {
+                        $imghash = $db->escape($imghash);
+                        if ($Captcha->ValidateCode($imgcode, $imghash) !== TRUE) {
+                            softerror($lang['captchaimageinvalid']);
+                            $topicvalid = FALSE;
+                        }
+                    }
+                    unset($Captcha);
                 }
             }
+        }
 
-            if ($forums['guestposting'] != 'on' && $username == 'Anonymous') {
-                error($lang['textnoguestposting']);
+        if ($topicvalid) {
+            if (strlen(postedVar('subject')) == 0) {
+                softerror($lang['textnosubject']);
+                $topicvalid = FALSE;
             }
+        }
 
-            $pperm = explode('|', $forums['postperm']);
-
-            if ($pperm[0] == 2 && !X_ADMIN) {
-                error($lang['postpermerr']);
-            } else if ($pperm[0] == 3 && !X_STAFF) {
-                error($lang['postpermerr']);
-            } else if ($pperm[0] == 4) {
-                error($lang['postpermerr']);
+        if ($topicvalid) {
+            if ($posticon != '') {
+                $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
+                if ($db->num_rows($query) == 0) {
+                    $posticon = '';
+                    softerror($lang['error']);
+                    $topicvalid = FALSE;
+                }
+                $db->free_result($query);
             }
+        }
 
-            $query = $db->query("SELECT lastpost, type, fup FROM ".X_PREFIX."forums WHERE fid='$fid'");
-            $for = $db->fetch_array($query);
-            $db->free_result($query);
-
-            if ($for['lastpost'] != '') {
-                $lastpost = explode('|', $for['lastpost']);
+        if ($topicvalid) {
+            if ($forum['lastpost'] != '') {
+                $lastpost = explode('|', $forum['lastpost']);
                 $rightnow = $onlinetime - $floodctrl;
                 if ($rightnow <= $lastpost[0] && $username == $lastpost[1]) {
-                    error($lang['floodprotect'].' '.$floodlink.' '.$lang['tocont']);
+                    softerror($lang['floodprotect']);
+                    $topicvalid = FALSE;
                 }
             }
+        }
 
-            if (isset($posticon) && $posticon != '') {
-                $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
-                if (!$db->result($query, 0)) {
-                    $db->free_result($query);
-                    exit();
+        if ($topicvalid) {
+            if ($poll == 'yes') {
+                $pollopts = explode("\n", $pollanswers);
+                $pnumnum = count($pollopts);
+
+                if ($pnumnum < 2) {
+                    softerror($lang['too_few_pollopts']);
+                    $topicvalid = FALSE;
                 }
-            } else {
-                $posticon = '';
             }
+        }
 
+        if ($topicvalid) {
             $thatime = $onlinetime;
 
-            $subject = addslashes($subject);
-            $message = addslashes($message);
-
-            $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-            $message = checkInput($message, $chkInputTags, $chkInputHTML, '', true);
-
-            $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$subject', '$posticon', '$thatime|$username', 0, 0, '$username', '', 0)");
+            $dbmessage = $db->escape(addslashes($messageinput)); //The message column is historically double-quoted.
+            $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
+            $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$dbsubject', '$posticon', '$thatime|$username', 0, 0, '$username', '', 0)");
             $tid = $db->insert_id();
 
-            $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ($fid, $tid, '$username', '$message', '$subject', ".$db->time($thatime).", '$posticon', '$usesig', '$onlineip', '$bbcodeoff', '$smileyoff')");
+            $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ($fid, $tid, '$username', '$dbmessage', '$dbsubject', ".$db->time($thatime).", '$posticon', '$usesig', '$onlineip', '$bbcodeoff', '$smileyoff')");
             $pid = $db->insert_id();
 
             $db->query("UPDATE ".X_PREFIX."threads SET lastpost=concat(lastpost, '|".$pid."') WHERE tid='$tid'");
 
-            if (isset($forum['type']) && $forum['type'] == 'sub') {
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', threads=threads+1, posts=posts+1 WHERE fid='$for[fup]'");
+            $where = "WHERE fid=$fid";
+            if ($forum['type'] == 'sub') {
+                $where .= " OR fid={$forum['fup']}";
             }
+            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', threads=threads+1, posts=posts+1 $where");
+            unset($where);
 
-            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$thatime|$username|$pid', threads=threads+1, posts=posts+1 WHERE fid='$fid'");
-
-            if (X_MEMBER && isset($pollanswers) && isset($forums['pollstatus']) && $forums['pollstatus'] != 'off') {
-                $pollanswers = checkInput($pollanswers);
-                $pollopts = explode("\n", $pollanswers);
-                $pnumnum = count($pollopts);
-
-                if ($pnumnum < 2 && $pollanswers != '') {
-                    error($lang['too_few_pollopts']);
-                }
-
+            if ($poll == 'yes') {
                 $query = $db->query("SELECT vote_id, topic_id FROM ".X_PREFIX."vote_desc WHERE topic_id='$tid'");
                 if ($query) {
                     $vote_id = $db->fetch_array($query);
@@ -785,11 +740,12 @@
                 }
                 $db->free_result($query);
 
-                $db->query("INSERT INTO ".X_PREFIX."vote_desc (topic_id, vote_text) VALUES ($tid, '$subject')");
+                $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
+                $db->query("INSERT INTO ".X_PREFIX."vote_desc (topic_id, vote_text) VALUES ($tid, '$dbsubject')");
                 $vote_id =  $db->insert_id();
                 $i = 1;
                 foreach($pollopts as $p) {
-                    $p = addslashes($p);
+                    $p = $db->escape($p);
                     $db->query("INSERT INTO ".X_PREFIX."vote_results (vote_id, vote_option_id, vote_option_text, vote_result) VALUES ($vote_id, $i, '$p', 0)");
                     $i++;
                 }
@@ -797,7 +753,7 @@
             }
 
             if (isset($emailnotify) && $emailnotify == 'yes') {
-                $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid='$tid' AND username='$xmbuser' AND type='subscription'");
+                $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid='$tid' AND username='$username' AND type='subscription'");
                 $thread = $db->fetch_array($query);
                 $db->free_result($query);
                 if (!$thread) {
@@ -805,7 +761,7 @@
                 }
             }
 
-            $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+1 WHERE username like '$username'");
+            $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+1 WHERE username='$username'");
 
             if ((X_STAFF) && $toptopic == 'yes') {
                 $db->query("UPDATE ".X_PREFIX."threads SET topped='1' WHERE tid='$tid' AND fid='$fid'");
@@ -815,9 +771,12 @@
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
             }
 
-            eval('echo "'.template('header').'";');
+            $attachedfile = FALSE;
+            if (isset($_FILES['attach'])) {
+                $attachedfile = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize']);
+            }
 
-            if (isset($_FILES['attach']) && ($attachedfile = get_attached_file($_FILES['attach'], $forums['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
+            if ($attachedfile !== FALSE) {
                 $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$filetype', '$filesize', '$attachedfile', 0)");
             }
 
@@ -828,26 +787,184 @@
             $topicpages = quickpage($posts, $ppp);
             message($lang['postmsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
         }
+
+        if (!$topicvalid) {
+            if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
+                $Captcha = new Captcha(250, 50);
+                if ($Captcha->bCompatible !== false) {
+                    $imghash = $Captcha->GenerateCode();
+                    eval('$captchapostcheck = "'.template('post_captcha').'";');
+                }
+                unset($Captcha);
+            }
+
+            if (X_STAFF) {
+                $topoption = '<br /><input type="checkbox" name="toptopic" value="yes" '.$topcheck.' /> '.$lang['topmsgques'];
+                $closeoption = '<br /><input type="checkbox" name="closetopic" value="yes" '.$closecheck.' /> '.$lang['closemsgques'].'<br />';
+            } else {
+                $topoption = '';
+                $closeoption = '';
+            }
+
+            if (!isset($spelling_submit2)) {
+                $spelling_submit2 = '';
+            }
+
+            $rawperms = explode(',', $forum['postperm']);
+            if ($rawperms[X_PERMS_THREAD] == 32) { // Member posting is not allowed, do not request credentials!
+                $loggedin = '';
+            }
+
+            if (isset($poll) && $poll == 'yes') {
+                eval('echo "'.template('post_newpoll').'";');
+            } else {
+                eval('echo "'.template('post_newthread').'";');
+            }
+        }
         break;
 
     case 'edit':
-        nav('<a href="viewthread.php?tid='.$tid.'">'.html_entity_decode($threadname).'</a>');
+        nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
         nav($lang['texteditpost']);
 
-        if (!isset($editsubmit)) {
-            eval('echo "'.template('header').'";');
-            $queryextra = $db->query("SELECT f.* FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f ON (f.fid=p.fid) WHERE p.tid='$tid' AND p.pid='$pid'");
-            $forum = $db->fetch_array($queryextra);
-            $db->free_result($queryextra);
+        if ($SETTINGS['subject_in_title'] == 'on') {
+            $threadSubject = '- '.$threadname;
+        }
 
-            $authorization = privfcheck($forum['private'], $forum['userlist']);
-            if (!$authorization) {
-                $header = '';
-                error($lang['privforummsg']);
+        eval('echo "'.template('header').'";');
+
+        $editvalid = onSubmit('editsubmit'); // This new flag will indicate a message was submitted and successful.
+
+        //Check all editing permissions for this $pid.  Based on viewthread design, forum Moderators can always edit, $orig['author'] can edit open threads only.
+        $query = $db->query("SELECT p.author as author, m.status as status, p.subject as subject FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON p.author=m.username WHERE pid=$pid");
+        $orig = $db->fetch_array($query);
+        $db->free_result($query);
+
+        $status1 = modcheckPost($self['username'], $forum['moderator'], $orig['status']);
+
+        if ($status1 != 'Moderator' And ($self['username'] != $orig['author'] Or $thread['closed'] != '')) {
+            if ($editvalid) {
+                softerror($lang['noedit']);
+            } else {
+                error($lang['noedit']);
             }
+            $editvalid = FALSE;
+        }
 
-            if (isset($previewpost) || (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit)))) {
-                $postinfo = array("usesig"=>$usesig, "bbcodeoff"=>$bbcodeoff, "smileyoff"=>$smileyoff, "message"=>$message, "subject"=>$subject, 'icon'=>$posticon);
+        if ($editvalid) {
+            if ($posticon != '') {
+                $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
+                if ($db->num_rows($query) == 0) {
+                    $posticon = '';
+                    softerror($lang['error']);
+                    $editvalid = FALSE;
+                }
+                $db->free_result($query);
+            }
+        }
+
+        if ($editvalid) {
+            $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline LIMIT 1");
+            $isfirstpost = $db->fetch_array($query);
+            $db->free_result($query);
+
+            if ((strlen(postedVar('subject')) == 0 && $pid == $isfirstpost['pid']) && !(isset($delete) && $delete == 'yes')) {
+                softerror($lang['textnosubject']);
+                $editvalid = FALSE;
+            }
+        }
+
+        if ($editvalid) {
+            $threaddelete = 'no';
+
+            $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
+            if ($isfirstpost['pid'] == $pid && !(isset($delete) && $delete == 'yes')) {
+                $db->query("UPDATE ".X_PREFIX."threads SET icon='$posticon', subject='$dbsubject' WHERE tid='$tid'");
+            }
+
+            if ($SETTINGS['editedby'] == 'on') {
+                $messageinput .= "\n\n[".$lang['textediton'].' '.gmdate($dateformat).' '.$lang['textby']." $username]";
+            }
+
+            $dbmessage = $db->escape(addslashes($messageinput)); //The subject and message columns are historically double-quoted.
+            $db->query("UPDATE ".X_PREFIX."posts SET message='$dbmessage', usesig='$usesig', bbcodeoff='$bbcodeoff', smileyoff='$smileyoff', icon='$posticon', subject='$dbsubject' WHERE pid='$pid'");
+
+            if (isset($_FILES['attach']) && ($file = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
+                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attach[type]', '$filesize', '$file', 0)");
+            }
+
+            if (isset($attachment) && is_array($attachment)) {
+                switch($attachment['action']) {
+                    case 'replace':
+                        if (isset($_FILES['attachment_replace']) && ($file = get_attached_file($_FILES['attachment_replace'], $forum['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
+                            $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
+                            $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attachment_replace[type]', '$filesize', '$file', 0)");
+                        }
+                        break;
+                    case 'rename':
+                        $rename = trim(postedVar('attach_name', '', FALSE, FALSE));
+                        if (isValidFilename($rename)) {
+                            $dbrename = $db->escape($rename);
+                            $db->query("UPDATE ".X_PREFIX."attachments SET filename='$dbrename' WHERE pid=$pid");
+                        }
+                        break;
+                    case 'delete':
+                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
+                        break;
+                    default:
+                        break;
+                }
+            }
+
+            if (isset($delete) && $delete == 'yes' && !($isfirstpost['pid'] == $pid)) {
+                $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($orig['author'])."'");
+                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
+                updatethreadcount($tid);
+                updateforumcount($fid);
+            } else if (isset($delete) && $delete == 'yes' && $isfirstpost['pid'] == $pid) {
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid'");
+                $numrows = $db->num_rows($query);
+                $db->free_result($query);
+
+                if ($numrows == 1) {
+                    $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid'");
+                    while($result = $db->fetch_array($query)) {
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($result['author'])."'");
+                    }
+                    $db->free_result($query);
+                    $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$tid'");
+                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid='$tid'");
+                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid'");
+                    $threaddelete = 'yes';
+                }
+
+                if ($numrows > 1) {
+                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($orig['author'])."'");
+                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
+                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET subject='".$db->escape($orig['subject'])."' WHERE tid='$tid' ORDER BY dateline ASC LIMIT 1");
+                    $threaddelete = 'no';
+                }
+                updatethreadcount($tid);
+                updateforumcount($fid);
+            }
+
+            if ($threaddelete != 'yes') {
+                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE pid <= '$pid' AND tid='$tid' AND fid='$fid'");
+                $posts = $db->result($query,0);
+                $db->free_result($query);
+                $topicpages = quickpage($posts, $ppp);
+                message($lang['editpostmsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
+            } else {
+                message($lang['editpostmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            }
+        }
+
+        if (!$editvalid) {
+            $subjectinput = postedVar('subject', 'javascript', TRUE, FALSE, TRUE);
+            if (onSubmit('editsubmit') || isset($previewpost) || (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit)))) {
+                $postinfo = array("usesig"=>$usesig, "bbcodeoff"=>$bbcodeoff, "smileyoff"=>$smileyoff, "message"=>$messageinput, "subject"=>$subjectinput, 'icon'=>$posticon);
                 $query = $db->query("SELECT filename, filesize, downloads FROM ".X_PREFIX."attachments WHERE pid='$pid' AND tid='$tid'");
                 if ($db->num_rows($query) > 0) {
                     $postinfo = array_merge($postinfo, $db->fetch_array($query));
@@ -857,14 +974,18 @@
                 $query = $db->query("SELECT a.filename, a.filesize, a.downloads, p.* FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."attachments a  ON (a.pid=p.pid) WHERE p.pid='$pid' AND p.tid='$tid' AND p.fid=".$forum['fid']);
                 $postinfo = $db->fetch_array($query);
                 $db->free_result($query);
+                $postinfo['message'] = stripslashes($postinfo['message']); //Messages are historically double-quoted.
+                $postinfo['subject'] = stripslashes($postinfo['subject']);
             }
 
+            //update
             if (isset($postinfo['filesize'])) {
                 $postinfo['filesize'] = number_format($postinfo['filesize'], 0, '.', ',');
             }
 
-            $postinfo['subject'] = html_entity_decode($postinfo['subject']);
-            $postinfo['message'] = html_entity_decode(stripslashes($postinfo['message']));
+            if (isset($postinfo['filename'])) {
+                $postinfo['filename'] = attrOut($postinfo['filename']);
+            }
 
             if ($postinfo['bbcodeoff'] == 'yes') {
                 $offcheck1 = $cheHTML;
@@ -899,205 +1020,15 @@
             }
             $db->free_result($querysmilie);
 
-            $postinfo['subject'] = stripslashes($postinfo['subject']);
-            $postinfo['subject'] = str_replace('"', "&quot;", $postinfo['subject']);
+            $postinfo['message'] = rawHTMLmessage($postinfo['message']);
+            $postinfo['subject'] = rawHTMLsubject($postinfo['subject']);
 
-            if (!X_SADMIN) {
-                $postinfo['subject'] = censor($postinfo['subject']);
-            }
-
-            $message = $postinfo['message'];
-            $subject = $postinfo['subject'];
-
-            if (isset($previewpost)) {
-                $message = censor($message);
-            }
-
             if (isset($postinfo['filename']) && $postinfo['filename'] != '') {
                 eval('$attachment = "'.template('post_edit_attachment').'";');
             } else {
                 $attachment = $attachfile;
             }
             eval('echo "'.template('post_edit').'";');
-        } else {
-            if (X_GUEST) {
-                $username = trim($username);
-                $password = md5(trim($password));
-            }
-
-            $q = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$username'");
-            if ($db->num_rows($q) != 1) {
-                error($lang['badname']);
-                $db->free_result($q);
-            } else {
-                $self = $db->fetch_array($q);
-                if ($password != $self['password']) {
-                    error($lang['textpw1']);
-                }
-                $username = $self['username'];
-                $db->free_result($q);
-            }
-
-            if ($self['status'] == "Banned") {
-                error($lang['bannedmessage']);
-            }
-
-            $currtime = $onlinetime + (86400*30);
-            put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-            put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
-            if ($self['ban'] == "posts" || $self['ban'] == "both") {
-                error($lang['textbanfrompost']);
-            }
-
-            $date = gmdate($dateformat);
-            if ($SETTINGS['editedby'] == 'on') {
-                $message .= "\n\n[$lang[textediton] $date $lang[textby] $username]";
-            }
-
-            $subject = addslashes($subject);
-
-            $status1 = modcheck($self['status'], $username, $forums['moderator']);
-            if ($self['status'] == "Super Moderator") {
-                $status1 = "Moderator";
-            }
-
-            if (isset($posticon) && $posticon != "") {
-                $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
-                if (!$db->result($query, 0)) {
-                    $db->free_result($query);
-                    exit();
-                }
-            } else {
-                $posticon = '';
-            }
-
-            $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline LIMIT 1");
-            $isfirstpost = $db->fetch_array($query);
-            $db->free_result($query);
-
-            if ((trim($subject) == '' && $pid == $isfirstpost['pid']) && !(isset($delete) && $delete == 'yes')) {
-                error($lang['textnosubject']);
-            }
-
-            $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-            $message = checkInput($message, $chkInputTags, $chkInputHTML, '', true);
-            $posticon = htmlspecialchars($posticon);
-
-            $query = $db->query("SELECT p.author as author, m.status as status, p.subject as subject FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON p.author=m.username WHERE pid='$pid' AND tid='$tid' AND fid='$fid'");
-            $orig = $db->fetch_array($query);
-            $db->free_result($query);
-
-            $message = addslashes($message);
-
-            if ((X_STAFF && $status1 == 'Moderator') || $username == $orig['author']) {
-                if ($SETTINGS['allowrankedit'] != 'off') {
-                    switch($orig['status']) {
-                        case 'Super Administrator':
-                            if (!X_SADMIN && $xmbuser != $orig['author']) {
-                                error($lang['noedit']);
-                            }
-                            break;
-                        case 'Administrator':
-                            if (!X_ADMIN && $xmbuser != $orig['author']) {
-                                error($lang['noedit']);
-                            }
-                            break;
-                        case 'Super Moderator':
-                            if ((!X_ADMIN && $self['status'] != 'Super Moderator') && $xmbuser != $orig['author']) {
-                                error($lang['noedit']);
-                            }
-                            break;
-                        case 'Moderator':
-                            if ((!X_ADMIN && $self['status'] != 'Moderator') && $xmbuser != $orig['author']) {
-                                error($lang['noedit']);
-                            }
-                            break;
-                    }
-                }
-
-                if ($isfirstpost['pid'] == $pid && !(isset($delete) && $delete == 'yes')) {
-                    $db->query("UPDATE ".X_PREFIX."threads SET icon='$posticon', subject='$subject' WHERE tid='$tid'");
-                }
-
-                $threaddelete = 'no';
-                eval('echo "'.template('header').'";');
-
-                $db->query("UPDATE ".X_PREFIX."posts SET message='$message', usesig='$usesig', bbcodeoff='$bbcodeoff', smileyoff='$smileyoff', icon='$posticon', subject='$subject' WHERE pid='$pid'");
-
-                if (isset($_FILES['attach']) && ($file = get_attached_file($_FILES['attach'], $forums['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
-                    $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attach[type]', '$filesize', '$file', 0)");
-                }
-
-                if (isset($attachment) && is_array($attachment)) {
-                    switch($attachment['action']) {
-                        case 'replace':
-                            if (isset($_FILES['attachment_replace']) && ($file = get_attached_file($_FILES['attachment_replace'], $forums['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
-                                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attachment_replace[type]', '$filesize', '$file', 0)");
-                            }
-                            break;
-                        case 'rename':
-                            $name = basename($attach_name);
-                            if (strlen(trim($name)) > 2 || preg_match('#^[^a-z0-9]+$#', $name) == 1) {
-                                break;
-                            } else {
-                                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$name' WHERE pid='$pid'");
-                            }
-                            break;
-                        case 'delete':
-                            $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                            break;
-                        default:
-                            break;
-                    }
-                }
-
-                if (isset($delete) && $delete == 'yes' && !($isfirstpost['pid'] == $pid)) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$orig[author]'");
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
-                    updatethreadcount($tid);
-                    updateforumcount($fid);
-                } else if (isset($delete) && $delete == 'yes' && $isfirstpost['pid'] == $pid) {
-                    $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                    $numrows = $db->num_rows($query);
-                    $db->free_result($query);
-
-                    if ($numrows == 1) {
-                        $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                        while($result = $db->fetch_array($query)) {
-                            $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$result[author]'");
-                        }
-                        $db->free_result($query);
-                        $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$tid'");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid='$tid'");
-                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                        $threaddelete = 'yes';
-                    }
-
-                    if ($numrows > 1) {
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$orig[author]'");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
-                        $db->query("UPDATE ".X_PREFIX."posts SET subject='$orig[subject]' WHERE tid='$tid' ORDER BY dateline ASC LIMIT 1");
-                        $threaddelete = 'no';
-                    }
-                    updatethreadcount($tid);
-                    updateforumcount($fid);
-                }
-            } else {
-                error($lang['noedit']);
-            }
-
-            if ($threaddelete != 'yes') {
-                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE pid <= '$pid' AND tid='$tid' AND fid='$fid'");
-                $posts = $db->result($query,0);
-                $db->free_result($query);
-                $topicpages = quickpage($posts, $ppp);
-                message($lang['editpostmsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
-            } else {
-                message($lang['editpostmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
-            }
         }
         break;
 
@@ -1108,4 +1039,18 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+
+function bbcodeinsert() {
+    global $imgdir, $bbinsert, $altbg1, $altbg2, $lang, $SETTINGS, $spelling_lang;
+
+    $bbcode = '';
+    if ($SETTINGS['bbinsert'] == 'on') {
+        eval('$bbcode = "'.template('functions_bbcodeinsert').'";');
+    }
+    return $bbcode;
+}
+
+function softerror($msg) {
+    error($msg, FALSE, '', '', FALSE, FALSE, FALSE, FALSE);
+}
+?>
Index: stats.php
===================================================================
--- stats.php	(revision 1095)
+++ stats.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'stats.php');
+
 require 'header.php';
 
 nav($lang['altstats']);
@@ -42,76 +44,34 @@
     error($lang['fnasorry3'], false);
 }
 
-$modXmbuser = str_replace(array('*', '.', '+'), array('\*', '\.', '\+'), $xmbuser);
-$restrict = array("(f.password='')");
-switch($self['status']) {
-    case 'Member':
-        $restrict[] = 'f.private = 1';
-        $restrict[] = "(f.userlist = '' OR f.userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)')";
-        break;
-    case 'Moderator':
-    case 'Super Moderator':
-        $restrict[] = '(f.private = 1 OR f.private = 3)';
-        $restrict[] = "(if ((f.private=1 AND f.userlist != ''), if ((f.userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-        break;
-    case 'Administrator':
-        $restrict[] = '(f.private > 0 AND f.private < 4)';
-        $restrict[] = "(if ((f.private=1 AND f.userlist != ''), if ((f.userlist REGEXP '(^|(,))([:space:])*$modXmbuser([:space:])*((,)|$)'), 1, 0), 1))";
-        break;
-    case 'Super Administrator':
-        break;
-    default:
-        $restrict[] = '(f.private=1)';
-        $restrict[] = "(f.userlist='')";
-        break;
-}
-
-$fids = array();
-if (!X_SADMIN) {
-    $q = $db->query("SELECT fid, fup, type FROM ".X_PREFIX."forums f WHERE f.status='on' AND ".implode(' AND ', $restrict));
+if (X_SADMIN) {
+    $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
     while($f = $db->fetch_array($q)) {
-        if (isset($f['type']) && $f['type'] == 'sub') {
-            $query = $db->query("SELECT private, userlist, name, fid FROM ".X_PREFIX."forums WHERE fid='$f[fup]'");
-            $fup = $db->fetch_array($query);
-            if (privfcheck($fup['private'], $fup['userlist'])) {
-                $fids[] = $f['fid'];
-            }
-            $db->free_result($query);
-        } else {
-            $fids[] = $f['fid'];
-        }
+        $fids[] = $f['fid'];
     }
-    $db->free_result($q);
+} else {
+    $fCache = array();
+    $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
+    while($forum = $db->fetch_array($q)) {
+        $perms = checkForumPermissions($forum);
+        $fCache[$forum['fid']] = $perms;
 
-    if (X_MEMBER) {
-        $r2 = array();
-        foreach($_COOKIE as $key=>$val) {
-            if (preg_match('#^fidpw([0-9]+)$#', $key, $fetch)) {
-                $r2[] = '(fid="'.$fetch[1].'" AND password="'.addslashes($val).'")';
+        if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
+            if ($forum['type'] == 'sub') {
+                // also check above forum!
+                $parentP = $fCache[$forum['fup']];
+                if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
+                    $fids[] = $forum['fid'];
+                }
+            } else {
+                $fids[] = $forum['fid'];
             }
         }
-
-        if (count($r2) > 0) {
-            $r = implode(' OR ', $r2);
-            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE $r");
-            while($f = $db->fetch_array($q)) {
-                $fids[] = $f['fid'];
-            }
-            $db->free_result($q);
-        }
     }
 }
 
-if (X_SADMIN) {
-    $restrict = '(1=1)';
-} else {
-    $fids = implode(',', $fids);
-    if ($fids == '') {
-         $restrict = '(1=2)';
-    } else {
-         $restrict = 'fid IN('.$fids.')';
-    }
-}
+$fids = implode(',', $fids);
+$restrict = ' fid IN ('.$fids.')';
 
 $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members UNION ALL SELECT COUNT(tid) FROM ".X_PREFIX."threads UNION ALL SELECT COUNT(pid) FROM ".X_PREFIX."posts");
 $members = $db->result($query, 0);
@@ -184,9 +144,8 @@
 $viewmost = array();
 $query = $db->query("SELECT views, tid, subject FROM ".X_PREFIX."threads WHERE $restrict GROUP BY tid ORDER BY views DESC LIMIT 5");
 while($views = $db->fetch_array($query)) {
-    $views['subject'] = shortenString(stripslashes($views['subject']), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
-    $views['subject'] = stripslashes(censor(checkOutput($views['subject'], 'no', '', true)));
-    $viewmost[] = '<a href="viewthread.php?tid='.intval($views['tid']).'">'.html_entity_decode($views['subject']).'</a> ('.$views['views'].')';
+    $views['subject'] = shortenString(rawHTMLsubject(stripslashes($views['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+    $viewmost[] = '<a href="viewthread.php?tid='.intval($views['tid']).'">'.$views['subject'].'</a> ('.$views['views'].')';
 }
 $viewmost = implode('<br />', $viewmost);
 $db->free_result($query);
@@ -195,9 +154,8 @@
 $replymost = array();
 $query = $db->query("SELECT replies, tid, subject FROM ".X_PREFIX."threads WHERE $restrict GROUP BY tid ORDER BY replies DESC LIMIT 5");
 while($reply = $db->fetch_array($query)) {
-    $reply['subject'] = shortenString(stripslashes($reply['subject']), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
-    $reply['subject'] = stripslashes(censor(checkOutput($reply['subject'], 'no', '', true)));
-    $replymost[] = '<a href="viewthread.php?tid='.intval($reply['tid']).'">'.html_entity_decode($reply['subject']).'</a> ('.$reply['replies'].')';
+    $reply['subject'] = shortenString(rawHTMLsubject(stripslashes($reply['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+    $replymost[] = '<a href="viewthread.php?tid='.intval($reply['tid']).'">'.$reply['subject'].'</a> ('.$reply['replies'].')';
 }
 $replymost = implode('<br />', $replymost);
 $db->free_result($query);
@@ -210,17 +168,16 @@
     $lpdate = gmdate($dateformat, $last['lastpost'] + $adjTime);
     $lptime = gmdate($timecode, $last['lastpost'] + $adjTime);
     $thislast = $lang['lpoststats'].' '.$lang['lastreply1'].' '.$lpdate.' '.$lang['textat'].' '.$lptime;
-    $last['subject'] = shortenString(stripslashes($last['subject']), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
-    $last['subject'] = stripslashes(censor(checkOutput($last['subject'], 'no', '', true)));
-    $latest[] = '<a href="viewthread.php?tid='.intval($last['tid']).'">'.html_entity_decode($last['subject']).'</a> ('.$thislast.')';
+    $last['subject'] = shortenString(rawHTMLsubject(stripslashes($last['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+    $latest[] = '<a href="viewthread.php?tid='.intval($last['tid']).'">'.$last['subject'].'</a> ('.$thislast.')';
 }
 $latest = implode('<br />', $latest);
 $db->free_result($query);
 
 // Get most popular forum
-$query = $db->query("SELECT posts, threads, fid, name FROM ".X_PREFIX."forums WHERE $restrict AND type='sub' OR type='forum' ORDER BY posts DESC LIMIT 0, 1");
+$query = $db->query("SELECT posts, threads, fid, name FROM ".X_PREFIX."forums WHERE $restrict AND (type='sub' OR type='forum') AND status='on' ORDER BY posts DESC LIMIT 0, 1");
 $pop = $db->fetch_array($query);
-$popforum = '<a href="forumdisplay.php?fid='.intval($pop['fid']).'"><strong>'.stripslashes(html_entity_decode($pop['name'])).'</strong></a>';
+$popforum = '<a href="forumdisplay.php?fid='.intval($pop['fid']).'"><strong>'.fnameOut($pop['name']).'</strong></a>';
 $db->free_result($query);
 
 // Get amount of posts per day
@@ -239,7 +196,7 @@
     $bestmemberpost = 'No';
 } else {
     if ($info['Total'] != 0) {
-        $membesthtml = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($bestmember).'"><strong>'.$bestmember.'</strong></a>';
+        $membesthtml = '<a href="member.php?action=viewpro&amp;member='.recodeOut($bestmember).'"><strong>'.$bestmember.'</strong></a>';
         $bestmemberpost = $info['Total'];
         $eval = $lang['evalbestmember'];
     }
@@ -263,8 +220,8 @@
 eval($lang['evalstats14']);
 eval($lang['evalstats15']);
 
-eval('echo stripslashes("'.template('feature_statistics').'");');
+eval('echo "'.template('feature_statistics').'";');
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
+?>
\ No newline at end of file
Index: templates.xmb
===================================================================
--- templates.xmb	(revision 1095)
+++ templates.xmb	(working copy)
@@ -1,10 +1,10 @@
 admintool_editprofile|#*XMB TEMPLATE*#|
-<form method="post" action="editprofile.php?user=$user" name="reg">
+<form method="post" action="editprofile.php?user=$userrecode" name="reg">
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
@@ -14,7 +14,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textemail]</td>
-<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /><br /><a href="http://www.network-tools.com/default.asp?prog=validate&amp;Netnic=whois.arin.net&amp;host=$member[email]" target="_blank">$lang[adminverifyemail]</a></td>
+<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /><br /><a href="http://network-tools.com/default.asp?prog=validate&amp;host=$member[email]" target="_blank">$lang[adminverifyemail]</a></td>
 </tr>
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[optional]</strong></font></td>
@@ -71,19 +71,19 @@
 <td bgcolor="$altbg1" width="22%">$lang[textbday]</td>
 <td bgcolor="$altbg2">
 <select name="month">
-<option value="0" $sel0>&nbsp;</option>
-<option value="1" $sel1>$lang[textjan]</option>
-<option value="2" $sel2>$lang[textfeb]</option>
-<option value="3" $sel3>$lang[textmar]</option>
-<option value="4" $sel4>$lang[textapr]</option>
-<option value="5" $sel5>$lang[textmay]</option>
-<option value="6" $sel6>$lang[textjun]</option>
-<option value="7" $sel7>$lang[textjul]</option>
-<option value="8" $sel8>$lang[textaug]</option>
-<option value="9" $sel9>$lang[textsep]</option>
-<option value="10" $sel10>$lang[textoct]</option>
-<option value="11" $sel11>$lang[textnov]</option>
-<option value="12" $sel12>$lang[textdec]</option>
+<option value="" $sel[0]>&nbsp;</option>
+<option value="1" $sel[1]>$lang[textjan]</option>
+<option value="2" $sel[2]>$lang[textfeb]</option>
+<option value="3" $sel[3]>$lang[textmar]</option>
+<option value="4" $sel[4]>$lang[textapr]</option>
+<option value="5" $sel[5]>$lang[textmay]</option>
+<option value="6" $sel[6]>$lang[textjun]</option>
+<option value="7" $sel[7]>$lang[textjul]</option>
+<option value="8" $sel[8]>$lang[textaug]</option>
+<option value="9" $sel[9]>$lang[textsep]</option>
+<option value="10" $sel[10]>$lang[textoct]</option>
+<option value="11" $sel[11]>$lang[textnov]</option>
+<option value="12" $sel[12]>$lang[textdec]</option>
 </select>
 $dayselect
 <input type="text" name="year" size="4" value="$year" />
@@ -119,7 +119,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[editprofile_minfo]</td>
-<td bgcolor="$altbg2"><strong>$lang[editprofile_userid]</strong> $member[uid]<br />$lang[editprofile_lastlogin] $lastlogdate<br />$lang[editprofile_regdate] $registerdate<br />$lang[editprofile_regip] <a href="http://www.nwtools.com/default.asp?prog=network&host=$member[regip]" target="_blank">$member[regip]</a></td>
+<td bgcolor="$altbg2"><strong>$lang[editprofile_userid]</strong> $member[uid]<br />$lang[editprofile_lastlogin] $lastlogdate<br />$lang[editprofile_regdate] $registerdate<br />$lang[editprofile_regip] <a href="http://network-tools.com/default.asp?prog=whois&host=$member[regip]" target="_blank">$member[regip]</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[editprosearch]</td>
@@ -141,12 +141,13 @@
 <meta http-equiv="Content-Type" content="text/html; charset=$charset" />
 $css
 <title>$bbname - $lang[textpowered]</title>
+<script language="JavaScript" type="text/javascript" src="./js/popup.js"></script>
 </head>
 <body text="$text">
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><strong><font color="$cattext">$lang[textbuddylist]</font></strong></td>
 </tr>
@@ -175,7 +176,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="ctrtablerow" bgcolor="$altbg1"><font class="mediumtxt"><a href="buddy.php?action=edit">$lang[editbuddylist]</a></font></td>
 </tr>
@@ -188,14 +189,14 @@
 
 |#*XMB TEMPLATE FILE*#|buddylist_buddy_offline|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="75%">$buddy[buddyname]</td>
-<td bgcolor="$altbg1">$lang[textoffline]</td>
+<td bgcolor="$altbg1" width="75%"><a href="member.php?action=viewpro&amp;member=$recodename">{$buddy['buddyname']}</a></td>
+<td bgcolor="$altbg1"><a href="u2u.php?action=send&amp;username=$recodename" onclick="Popup(this.href, 'Window', 700, 450); return false;">$lang[textoffline]</a></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|buddylist_buddy_online|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="75%">$buddy[buddyname]</td>
-<td bgcolor="$altbg1">$buddystatus</td>
+<td bgcolor="$altbg1" width="75%"><a href="member.php?action=viewpro&amp;member=$recodename">{$buddy['buddyname']}</a></td>
+<td bgcolor="$altbg1"><a href="u2u.php?action=send&amp;username=$recodename" onclick="Popup(this.href, 'Window', 700, 450); return false;">$buddystatus</a></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|buddylist_edit|#*XMB TEMPLATE*#|
@@ -213,7 +214,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="buddy.php?action=delete">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[editbuddylist]</font></strong></td>
 </tr>
@@ -236,7 +237,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="buddy.php?action=add">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[addtoaddresses]</font></strong></td>
 </tr>
@@ -280,7 +281,7 @@
 <table cellspacing="2" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="ctrtablerow" bgcolor="$altbg1"><font class="mediumtxt">$message$redirectjs</font></td>
 </tr>
@@ -304,7 +305,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="95%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header">$lang[textbuddylist]</td>
 </tr>
@@ -334,6 +335,24 @@
 </body>
 </html>
 
+|#*XMB TEMPLATE FILE*#|buddy_u2u_inv|#*XMB TEMPLATE*#|
+<tr class="tablerow" >
+<td bgcolor="$altbg1" width="75%"><input type="checkbox" name="users" value="$buddyout" /> <a href="member.php?action=viewpro&amp;member=$recodename">$buddyout</a></td>
+<td bgcolor="$altbg1">$lang[hidden]</td>
+</tr>
+
+|#*XMB TEMPLATE FILE*#|buddy_u2u_off|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="75%"><input type="checkbox" name="users" value="$buddyout" /> <a href="member.php?action=viewpro&amp;member=$recodename">$buddyout</a></td>
+<td bgcolor="$altbg1">$lang[textoffline]</td>
+</tr>
+
+|#*XMB TEMPLATE FILE*#|buddy_u2u_on|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="75%"><input type="checkbox" name="users" value="$buddyout" /> <a href="member.php?action=viewpro&amp;member=$recodename">$buddyout</a></td>
+<td bgcolor="$altbg1">$lang[textonline]</td>
+</tr>
+
 |#*XMB TEMPLATE FILE*#|css|#*XMB TEMPLATE*#|
 <style type="text/css">
 /*<![CDATA[*/
@@ -623,7 +642,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[error]</strong></font></td>
 </tr>
@@ -641,7 +660,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[noadminsession]</strong></font></td>
 </tr>
@@ -674,7 +693,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=usermaint"><font color="$cattext"><strong>$lang[textuserman]</strong></font></a></td>
 </tr>
@@ -698,7 +717,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=using"><font color="$cattext"><strong>$lang[textuseboa]</strong></font></a></td>
 </tr>
@@ -723,7 +742,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=messages"><font color="$cattext"><strong>$lang[textpostread]</strong></font></a></td>
 </tr>
@@ -750,7 +769,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textbbrules]</strong></font></td>
 </tr>
@@ -766,7 +785,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textpostread]</strong></font></td>
 </tr>
@@ -792,7 +811,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq11]</strong></font></td>
 </tr>
@@ -807,7 +826,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a> $lang[textfaq12]</strong></font></td>
 </tr>
@@ -822,7 +841,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a> $lang[textfaq13]</strong></font></td>
 </tr>
@@ -837,7 +856,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a> $lang[textfaq14]</strong></font></td>
 </tr>
@@ -852,7 +871,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a> $lang[textfaq15]</strong></font></td>
 </tr>
@@ -867,7 +886,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a> $lang[textfaq17]</strong></font></td>
 </tr>
@@ -876,7 +895,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="50%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td width="25%">$lang[textsmiliecode]</td>
 <td width="75%">$lang[smiliepreview]</td>
@@ -896,7 +915,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="7"></a> $lang[textfaq19]</strong></font></td>
 </tr>
@@ -911,7 +930,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="8"></a> $lang[textfaq18]</strong></font></td>
 </tr>
@@ -934,7 +953,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textuserman]</strong></font></td>
 </tr>
@@ -958,7 +977,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq1]</strong></font></td>
 </tr>
@@ -973,7 +992,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a>$lang[textfaq2]</strong></font></td>
 </tr>
@@ -988,7 +1007,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a>$lang[textfaq3]</strong></font></td></tr>
 <tr>
@@ -1002,7 +1021,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a>$lang[textfaq4]</strong></font></td>
 </tr>
@@ -1017,7 +1036,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a>$lang[textfaq5]</strong></font></td>
 </tr>
@@ -1032,7 +1051,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a>$lang[textfaq6]</strong></font></td>
 </tr>
@@ -1048,7 +1067,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textuseboa]</strong></font></td>
 </tr>
@@ -1073,7 +1092,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq7]</strong></font></td>
 </tr>
@@ -1088,7 +1107,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a>$lang[textfaq16]</strong></font></td>
 </tr>
@@ -1103,7 +1122,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a>$lang[textfaq8]</strong></font></td>
 </tr>
@@ -1118,7 +1137,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a>$lang[textfaq9]</strong></font></td>
 </tr>
@@ -1133,7 +1152,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a>$lang[textfaq10]</strong></font></td>
 </tr>
@@ -1148,7 +1167,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a> $lang[textfaq20]</strong></font></td>
 </tr>
@@ -1163,7 +1182,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="7"></a> $lang[textfaq21]</strong></font></td>
 </tr>
@@ -1175,7 +1194,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="50%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="2" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="2" width="100%">
 $rankrows
 </table>
 </td>
@@ -1199,7 +1218,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textstats]</strong></font></td>
 </tr>
@@ -1258,7 +1277,7 @@
 
 |#*XMB TEMPLATE FILE*#|footer|#*XMB TEMPLATE*#|
 <br />
-<table cellspacing="$borderwidth" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
 <table width="100%" cellspacing="0" cellpadding="0">
@@ -1275,7 +1294,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="ctrtablerow">
 <td bgcolor="$altbg2">
 <font class="smalltxt">
@@ -1321,7 +1340,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header" align="center">
 <td width="4%">&nbsp;</td>
@@ -1340,13 +1359,13 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center" style="margin-top: 3px">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center" style="margin-top: 3px">
 <tr>
 <td class="post" align="right">&nbsp;$newtopiclink$newpolllink</td>
 </tr>
 </table>
 <br />
-<table width="$tablewidth" align="center"><tr>
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center"><tr>
 <td class="tablerow"><img src="$imgdir/red_folder.gif" alt="$lang[altredfolder]" />&nbsp;$lang[opennew] (&nbsp;
 <img src="$imgdir/hot_red_folder.gif" alt="$lang[althotredfolder]" />&nbsp;$lang[hottopic]&nbsp;)<br />
 <img src="./images/pixel.gif" width="1" height="4" alt="*" /><br/>
@@ -1369,7 +1388,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header" align="center">
 <td width="4%"><a href="cp.php?action=forum&amp;fdetails=$forum[fid]"><img src="./images/admin/editforumsets.gif" border="0" alt="$lang[alteditsettings]" /></a></td>
@@ -1417,13 +1436,13 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center" style="margin-top: 3px">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center" style="margin-top: 3px">
 <tr>
 <td class="post" align="right">&nbsp;$newtopiclink$newpolllink</td>
 </tr>
 </table>
 <br />
-<table width="$tablewidth" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="tablerow">
 <img src="$imgdir/red_folder.gif" alt="$lang[altredfolder]" />&nbsp;$lang[opennew] (&nbsp;
@@ -1469,7 +1488,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textpassword]</td>
 <td bgcolor="$altbg2"><input type="password" name="pw" size="25" /> <br /></td>
@@ -1524,7 +1543,7 @@
 |#*XMB TEMPLATE FILE*#|forumdisplay_subforums|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%" align="center">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%" align="center">
 <tr class="header">
 <td width="4%">&nbsp;</td>
 <td width="58%">$lang[textforum]</td>
@@ -1724,7 +1743,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="1" cellpadding="6" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="6" width="100%">
 <tr>
 <td width="74%" $topbgcode>
 <table border="0" width="100%" cellpadding="0" cellspacing="0">
@@ -1754,7 +1773,7 @@
 </table>
 <table cellspacing="0" cellpadding="1" border="0" width="$tablewidth" align="center">
 <tr>
-<td><table width="100%" cellspacing="0" cellpadding="2" align="center">
+<td><table width="100%" cellspacing="0" cellpadding="$tablespace" align="center">
 <tr>
 <td class="nav"> <a href="index.php">$bbname</a> $navigation</td>
 <td align="right">$quickjump</td>
@@ -1772,7 +1791,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%" align="center">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%" align="center">
 $indexBarTop
 $forumlist
 </table>
@@ -1783,7 +1802,6 @@
 $statsbar
 
 |#*XMB TEMPLATE FILE*#|index_category|#*XMB TEMPLATE*#|
-$spacer
 <tr>
 <td colspan="5" class="category"><a href="index.php?gid=$thing[cat_fid]"><font color="$cattext"><strong>$thing[cat_name]</strong></font></a></td>
 </tr>
@@ -1806,7 +1824,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 
 |#*XMB TEMPLATE FILE*#|index_forum|#*XMB TEMPLATE*#|
 <tr>
@@ -1842,7 +1860,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td align="left" class="category"><font color="$cattext"><strong>$lang[textstats]:</strong></font></td>
 <td align="left" class="category"><font color="$cattext"><strong>$lang[key]</strong></font></td>
@@ -1875,7 +1893,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td class="category"><strong><font color="$cattext">$lang[tickername] [<a id="tickertoggle" href="javascript:tickertoggle();">&nbsp;</a>]</font></strong></td>
 </tr>
@@ -1895,7 +1913,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[welcomeunregnotify]</strong></font></td>
 </tr>
@@ -1926,7 +1944,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" bgcolor="$bordercolor" align="center">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="3"><table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr class="tablerow">
@@ -1938,8 +1956,8 @@
 </tr>
 <tr class="ctrtablerow" bgcolor="$altbg2">
 <td width="33%"><a href="memcp.php"><strong>$lang[textusercp]</strong></a></td>
-<td width="33%"><a href="#" onclick="Popup('u2u.php','Window', 700, 450);"><strong>$lang[textu2umessenger]</strong></a></td>
-<td width="33%"><a href="#" onclick="Popup('buddy.php', 'Window', 450, 400);"><strong>$lang[launchbuddylist]</strong></a></td>
+<td width="33%"><a href="u2u.php" onclick="Popup(this.href,'Window', 700, 450); return false;"><strong>{$lang['textu2umessenger']}</strong></a></td>
+<td width="33%"><a href="buddy.php" onclick="Popup(this.href, 'Window', 450, 400); return false;"><strong>{$lang['launchbuddylist']}</strong></a></td>
 </tr>
 </table>
 </td>
@@ -1955,7 +1973,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="2" class="category">
 <a href="misc.php?action=online"><strong><font color="$cattext">$lang[whosonline]</font></strong></a><font color="$cattext"> - $memonmsg</font>
@@ -1994,6 +2012,9 @@
 $todaymembers&nbsp;
 </td>
 </tr>
+<tr>
+<td bgcolor="$altbg1" colspan="2" class="mediumtxt">$memontoday</td>
+</tr>
 
 |#*XMB TEMPLATE FILE*#|member_coppa|#*XMB TEMPLATE*#|
 <form method="post" action="member.php?action=reg">
@@ -2001,7 +2022,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textcoppa]</strong></font></td>
 </tr>
@@ -2021,13 +2042,13 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textprofor] $member</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textusername]</td>
-<td bgcolor="$altbg2">$memberinfo[username] <small>(<a href="#" onclick="Popup('u2u.php?action=send&amp;username=$encodeuser', 'Window', 700, 450);">$lang[textu2u]</a>)&nbsp;&nbsp;(<a href="javascript:Popup('buddy.php?action=add&amp;buddys=$memberinfo[username]', 'Window', 450, 400);">$lang[addtobuddies]</a>)</small></td>
+<td bgcolor="$altbg2">{$memberinfo['username']} <small>(<a href="u2u.php?action=send&amp;username=$encodeuser" onclick="Popup(this.href, 'Window', 700, 450); return false;">{$lang['textu2u']}</a>)&nbsp;&nbsp;(<a href="buddy.php?action=add&amp;buddys=$encodeuser" onclick="Popup(this.href, 'Window', 450, 400); return false;">{$lang['addtobuddies']}</a>)</small></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textregistered]</td>
@@ -2052,7 +2073,7 @@
 <br />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[memcp_otherinfo]</strong></font></td>
 </tr>
@@ -2063,7 +2084,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textaim]</td>
-<td bgcolor="$altbg2"><a href="aim:goim?screenname=$memberinfo[aim]&amp;message=Hi+$memberinfo[aim].+Are+you+there+I+got+your+aim+name+from+a+message+board.">$memberinfo[aim]</a></td>
+<td bgcolor="$altbg2"><a href="aim:goim?screenname={$memberinfo['aimrecode']}&amp;message=Hi+{$memberinfo['aimrecode']}.+Are+you+there+I+got+your+aim+name+from+a+message+board.">{$memberinfo['aim']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[texticq]</td>
@@ -2071,11 +2092,11 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textyahoo]</td>
-<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/$memberinfo[yahoo]" target="_blank">$memberinfo[yahoo]</a></td>
+<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/{$memberinfo['yahoorecode']}" target="_blank">{$memberinfo['yahoo']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textmsn]</td>
-<td bgcolor="$altbg2"><a href="http://members.msn.com/$memberinfo[msn]" target="_blank">$memberinfo[msn]</a></td>
+<td bgcolor="$altbg2"><a href="http://members.msn.com/{$memberinfo['msnrecode']}" target="_blank">{$memberinfo['msn']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textlocation]</td>
@@ -2109,7 +2130,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[memcp_otheroptions]</strong></font></td>
 </tr>
@@ -2133,7 +2154,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textregister] - $lang[required]</strong></font></td>
 </tr>
@@ -2277,8 +2298,12 @@
 
 |#*XMB TEMPLATE FILE*#|member_reg_avatarurl|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg1">$lang[textavatarurl]</td>
-<td bgcolor="$altbg2"><input type="text" name="avatar" size="25" /></td>
+<td bgcolor="$altbg1" width="22%">$lang[textavatarurl]</td>
+<td bgcolor="$altbg2">
+<input type="hidden" name="newavatarcheck" id="newavatarcheck" value="no" />
+<input type="text" name="newavatar" size="25" onblur="avatarCheck(this, '$SETTINGS[max_avatar_size]')" />
+<p id="avatarCheck" style="display: inline;"></p>
+</td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_reg_captcha|#*XMB TEMPLATE*#|
@@ -2348,7 +2373,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[registerrulestitle]</strong></font></td>
 </tr>
@@ -2373,7 +2398,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="6" class="category" align="center" $catbgcode><strong><font color="$cattext">$lang[textfavorites]</font></strong></td>
 </tr>
@@ -2417,7 +2442,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg1">
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
@@ -2425,7 +2450,7 @@
 <td align="center" colspan="2" style="padding-bottom: 3px"><font class="mediumtxt">$lang[usercpwelcome]</font></td>
 </tr>
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="6" class="category"><font color="$cattext">$lang[textbriefsummary] $self[username] - [$self[status]]</font></td>
 </tr>
@@ -2478,7 +2503,7 @@
 <td valign="top">
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textbuddylist]</strong></font></td>
 </tr>
@@ -2496,7 +2521,7 @@
 </td>
 </tr>
 <tr>
-<td class="ctrtablerow" bgcolor="$altbg2"><strong><a href="#" onclick="Popup('buddy.php', 'Window', 450, 400);">$lang[launchbuddylist]</a></strong></td>
+<td class="ctrtablerow" bgcolor="$altbg2"><strong><a href="buddy.php" onclick="Popup(this.href, 'Window', 450, 400); return false;">{$lang['launchbuddylist']}</a></strong></td>
 </tr>
 </table>
 </td>
@@ -2507,7 +2532,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="4"><font color="$cattext"><strong>$lang[textlatestu2us]</strong></font></td>
 </tr>
@@ -2519,7 +2544,7 @@
 </tr>
 $messages
 <tr>
-<td colspan="4" class="header" valign="top"><a href="#" onclick ="Popup('u2u.php','Window', 700, 450);">[$lang[viewcompleteinbox]]</a></td>
+<td colspan="4" class="header" valign="top"><a href="u2u.php" onclick="Popup(this.href,'Window', 700, 450); return false;">{$lang['viewcompleteinbox']}</a></td>
 </tr>
 </table>
 </td>
@@ -2529,7 +2554,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="5"><font color="$cattext"><strong>$lang[textlatestfavs]</strong></font></td>
 </tr>
@@ -2570,7 +2595,7 @@
 
 |#*XMB TEMPLATE FILE*#|memcp_home_u2u_row|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg2"><a href="#" onclick="Popup('u2u.php?action=view&amp;u2uid=$message[u2uid]', 'Window', 700, 450);">$message[subject]</a></td>
+<td bgcolor="$altbg2"><a href="u2u.php?action=view&amp;u2uid={$message['u2uid']}" onclick="Popup(this.href, 'Window', 700, 450); return false;">{$message['subject']}</a></td>
 <td bgcolor="$altbg1">$message[msgfrom]</td>
 <td bgcolor="$altbg2">$senton</td>
 <td bgcolor="$altbg2">$read</td>
@@ -2582,7 +2607,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
@@ -2652,19 +2677,19 @@
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textbday]</td>
 <td bgcolor="$altbg2"><select name="month">
-<option value="" $sel0>&nbsp;</option>
-<option value="1" $sel1>$lang[textjan]</option>
-<option value="2" $sel2>$lang[textfeb]</option>
-<option value="3" $sel3>$lang[textmar]</option>
-<option value="4" $sel4>$lang[textapr]</option>
-<option value="5" $sel5>$lang[textmay]</option>
-<option value="6" $sel6>$lang[textjun]</option>
-<option value="7" $sel7>$lang[textjul]</option>
-<option value="8" $sel8>$lang[textaug]</option>
-<option value="9" $sel9>$lang[textsep]</option>
-<option value="10" $sel10>$lang[textoct]</option>
-<option value="11" $sel11>$lang[textnov]</option>
-<option value="12" $sel12>$lang[textdec]</option>
+<option value="" $sel[0]>&nbsp;</option>
+<option value="1" $sel[1]>$lang[textjan]</option>
+<option value="2" $sel[2]>$lang[textfeb]</option>
+<option value="3" $sel[3]>$lang[textmar]</option>
+<option value="4" $sel[4]>$lang[textapr]</option>
+<option value="5" $sel[5]>$lang[textmay]</option>
+<option value="6" $sel[6]>$lang[textjun]</option>
+<option value="7" $sel[7]>$lang[textjul]</option>
+<option value="8" $sel[8]>$lang[textaug]</option>
+<option value="9" $sel[9]>$lang[textsep]</option>
+<option value="10" $sel[10]>$lang[textoct]</option>
+<option value="11" $sel[11]>$lang[textnov]</option>
+<option value="12" $sel[12]>$lang[textdec]</option>
 </select>
 $dayselect
 <input type="text" name="year" size="4" value="$year" /></td>
@@ -2768,7 +2793,11 @@
 |#*XMB TEMPLATE FILE*#|memcp_profile_avatarurl|#*XMB TEMPLATE*#|
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textavatarurl]</td>
-<td bgcolor="$altbg2"><input type="text" name="newavatar" size="25" value="$member[avatar]" /></td>
+<td bgcolor="$altbg2">
+<input type="hidden" name="newavatarcheck" id="newavatarcheck" value="yes" />
+<input type="text" name="newavatar" size="25" value="$member[avatar]" onblur="avatarCheck(this, '$SETTINGS[max_avatar_size]')" />
+<p id="avatarCheck" style="display: inline;"></p>
+</td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|memcp_subscriptions|#*XMB TEMPLATE*#|
@@ -2777,7 +2806,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="6" class="category" align="center" $catbgcode><strong><font color="$cattext">$lang[textsubscriptions]</font></strong></td>
 </tr>
@@ -2822,7 +2851,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[message]</strong></font></td>
 </tr>
@@ -2838,7 +2867,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
@@ -2855,7 +2884,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
@@ -2874,7 +2903,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textlogin]</strong></font></td>
 </tr>
@@ -2906,7 +2935,7 @@
 |#*XMB TEMPLATE FILE*#|misc_login_incorrectdetails|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2"><font color="$cattext"><strong>$lang[textlogin_incorrect]</strong></font></td>
 </tr>
@@ -2925,7 +2954,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textlostpw]</strong></font></td>
 </tr>
@@ -2953,7 +2982,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
@@ -2974,7 +3003,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="7" class="category"><font color="$cattext"><strong>$lang[textmemberlist]</strong></font></td>
 </tr>
@@ -3003,7 +3032,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
@@ -3024,7 +3053,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="7" class="category"><font color="$cattext"><strong>$lang[textmemberlist]</strong></font></td>
 </tr>
@@ -3085,7 +3114,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="3">
 <font color="$cattext"><strong>$lang[whosonline]</strong></font> <font color="$cattext"><strong>-</strong></font> <a href="javascript:history.go(0)"><strong><font color="$cattext">$lang[refreshpage]</font></strong></a>
@@ -3108,7 +3137,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="4">
 <font color="$cattext"><strong>$lang[whosonline]</strong></font> <font color="$cattext"><strong>-</strong></font> <a href="javascript:history.go(0)"><strong><font color="$cattext">$lang[refreshpage]</font></strong></a>
@@ -3151,9 +3180,9 @@
 <td align="center" width="10%">$onlinetime</td>
 <td>$online[location]</td>
 <td align="center">
-<a href="http://www.nwtools.com/default.asp?prog=network&host=$online[ip]" target="_blank" />W</a>
-<a href="http://www.nwtools.com/default.asp?prog=trace&host=$online[ip]" target="_blank" />T</a>
-<a href="http://www.nwtools.com/default.asp?prog=lookup&host=$online[ip]" target="_blank">L</a>
+<a href="http://network-tools.com/default.asp?prog=whois&host=$online[ip]" target="_blank" />W</a>
+<a href="http://network-tools.com/default.asp?prog=trace&host=$online[ip]" target="_blank" />T</a>
+<a href="http://network-tools.com/default.asp?prog=lookup&host=$online[ip]" target="_blank">L</a>
 <a href="http://www.networldmap.com/TryIt.htm?GetLocation&amp;Template=demo.htm&amp;ipaddress=$online[ip]" target="_blank">M</a> $online[ip]</a></td>
 </tr>
 
@@ -3164,7 +3193,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%" align="center">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><strong><font color="$cattext">$lang[misconlinetoday] $todaymembersnum $lang[misconlinetoday2]</font></strong></td>
 </tr>
@@ -3186,7 +3215,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
 </tr>
@@ -3207,12 +3236,12 @@
 <td bgcolor="$altbg2">
 <select name="srchfrom">
 <option value="86400">$lang[day1]</option>
-<option value="604800" $selHTML>$lang[aweek]</option>
+<option value="604800">$lang[aweek]</option>
 <option value="2592000">$lang[month1]</option>
 <option value="7948800">$lang[month3]</option>
 <option value="15897600">$lang[month6]</option>
 <option value="31536000">$lang[lastyear]</option>
-<option value="0">$lang[beginning]</option>
+<option value="0" $selHTML>$lang[beginning]</option>
 </select>
 </td>
 </tr>
@@ -3238,7 +3267,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="3"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
 </tr>
@@ -3257,7 +3286,7 @@
 
 |#*XMB TEMPLATE FILE*#|misc_search_results_row|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg1"><strong><a href="viewthread.php?tid=$post[ttid]&amp;page=$page#pid$post[pid]">$post[tsubject]</a></strong><br />$add_pre $show $add_post</td>
+<td bgcolor="$altbg1"><strong><a href="viewthread.php?tid={$post['ttid']}&amp;goto=search&amp;pid={$post['pid']}">{$post['subject']}</a></strong><br />$add_pre $show $add_post</td>
 <td bgcolor="$altbg1">$poston<br />$lang[textby]: $postby</td>
 </tr>
 
@@ -3310,12 +3339,10 @@
 $preview
 <form method="post" name="input" action="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$pid" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpost]</strong></font></td>
 </tr>
@@ -3337,10 +3364,10 @@
 <td bgcolor="$altbg2" class="tablerow">
 <table width="100%">
 <tr>
-<td width="70%">
-<textarea rows="12" cols="65" name="message" id="message"  onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$postinfo[message]</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$postinfo[message]</textarea></td>
 $smilieinsert
 </tr>
+<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $offcheck2 /> $lang[textdissmileys]<br />
@@ -3399,19 +3426,13 @@
 $preview
 <form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostnew]</strong></font></td>
 </tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[whocanpost]</td>
-<td bgcolor="$altbg2"><span class="smalltxt">$whopost1 $lang[and] $whopost2 $guestpostingmsg</span></td>
-</tr>
 $loggedin
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textsubject]</td>
@@ -3459,24 +3480,13 @@
 $preview
 <form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid" enctype="multipart/form-data" >
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostnew]</strong></font></td>
 </tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[whocanpost]</td>
-<td bgcolor="$altbg2">
-<span class="smalltxt">
-$whopost1 $lang[and] $whopost2 <br />
-$guestpostingmsg
-</span>
-</td>
-</tr>
 $loggedin
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textsubject]</td>
@@ -3496,9 +3506,10 @@
 <td class="tablerow" bgcolor="$altbg2">
 <table width="100%">
 <tr>
-<td width="70%"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
 $smilieinsert
 </tr>
+<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $smileoffcheck /> $lang[textdissmileys]<br />
@@ -3532,7 +3543,7 @@
 |#*XMB TEMPLATE FILE*#|post_preview|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpreview]</strong></font></td>
 </tr>
@@ -3553,18 +3564,12 @@
 $preview
 <form method="post" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostreply]</strong></font></td>
 </tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[whocanpost]</td>
-<td bgcolor="$altbg2"><span class="smalltxt">$whopost1 $lang[and] $whopost2$guestpostingmsg</span></td>
-</tr>
 $loggedin
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textsubject]</td>
@@ -3582,9 +3587,10 @@
 $lang[textimgcodeis] $allowimgcode</span></td>
 <td class="tablerow" bgcolor="$altbg2"><table width="100%">
 <tr>
-<td width="70%"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
 $smilieinsert
 </tr>
+<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $smileoffcheck /> $lang[textdissmileys]<br />
@@ -3607,7 +3613,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="1" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texttopicreview]</strong></font></td>
 </tr>
@@ -3638,7 +3644,7 @@
 <table border="0" cellpadding="0" cellspacing="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><font class="mediumtxt" color="$cattext"><strong>$lang[spellingchecker]</strong></font></td>
 </tr>
@@ -3670,7 +3676,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><font class="mediumtxt" color="$cattext"><strong>$lang[spellingchecker]</strong></font></td>
 </tr>
@@ -3690,7 +3696,7 @@
 <tr class="ctrtablerow">
 <td bgcolor="$altbg1" width="50%"><strong>$orig</strong></td>
 <td bgcolor="$altbg1" width="50%"><input type="hidden" name="old_words[]" value="$orig" />
-<select type="radio" name="replace_$orig">
+<select name="replace_$orig">
 <option value="$orig">--IGNORE--</option>
 $mistake
 </select>
@@ -3703,7 +3709,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="8" class="category"><font color="$cattext"><strong>$lang[navtodaysposts]</strong></font></td>
 </tr>
@@ -3763,9 +3769,9 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textbumpthread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textbumpthread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3786,9 +3792,9 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[copythread]:</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[copythread]:</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3812,9 +3818,9 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textdeletethread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textdeletethread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3834,9 +3840,9 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textemptythread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textemptythread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3857,9 +3863,9 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textmergethread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textmergethread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3884,9 +3890,9 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textmovemethod1]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textmovemethod1]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3919,9 +3925,9 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textclosethread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textclosethread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -3936,37 +3942,14 @@
 </table>
 </form>
 
-|#*XMB TEMPLATE FILE*#|topicadmin_report|#*XMB TEMPLATE*#|
-<form method="post" name="input" action="topicadmin.php?action=report">
-<input type="hidden" name="token" value="$oToken->newToken" />
-<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
-<tr>
-<td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
-<tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textreportpost]</strong></font></td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" valign="top" width="19%">$lang[textreason]</td>
-<td bgcolor="$altbg2"><textarea rows="9" cols="45" name="reason"></textarea>
-</tr>
-<tr>
-<td colspan="2" class="ctrtablerow" bgcolor="$altbg2"><input type="hidden" name="tid" value="$tid" /><input type="hidden" name="fid" value="$fid" /><input type="hidden" name="pid" value="$pid" /><input type="submit" class="submit" name="reportsubmit" value="$lang[textreportpost]" /></td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</form>
-
 |#*XMB TEMPLATE FILE*#|topicadmin_split|#*XMB TEMPLATE*#|
 <form method="post" action="topicadmin.php?action=split">
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textsplitthread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textsplitthread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -4007,9 +3990,9 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textprunethread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textprunethread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -4040,9 +4023,9 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class ="category" colspan="2"><font color="$cattext"><strong>$lang[texttopthread]</strong></font></td>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[texttopthread]</strong></font></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[loggedinuser]</td>
@@ -4065,7 +4048,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[textfolders]</font></strong></td>
 </tr>
@@ -4088,7 +4071,7 @@
 |#*XMB TEMPLATE FILE*#|u2u_drafts|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="5"><strong><font color="$cattext">$lang[textu2uprevsaved]</font></strong></td>
 </tr>
@@ -4117,7 +4100,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><strong><font color="$cattext">$lang[folderlist]</font></strong></td>
 </tr>
@@ -4160,7 +4143,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="0" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="0" width="100%">
 <tr>
 <td>
 <table border="0" cellspacing="0" cellpadding="$tablespace" width="100%">
@@ -4168,7 +4151,7 @@
 <td align="center" bgcolor="$altbg1" width="20%"><a href="u2u.php"><img src="$imgdir/inbox.gif" alt="$lang[textu2uinbox]" border="0" /><br />$lang[textu2uinbox]</a></td>
 <td align="center" bgcolor="$altbg1" width="20%"><a href="u2u.php?folder=Outbox"><img src="$imgdir/outbox.gif" alt="$lang[textu2uoutbox]" border="0" /><br />$lang[textu2uoutbox]</a></td>
 <td align="center" bgcolor="$altbg1" width="20%"><a href="u2u.php?action=send"><img src="$imgdir/newu2u.gif"  alt="$lang[textsendu2u]" border="0" /><br />$lang[textsendu2u]</a></td>
-<td align="center" bgcolor="$altbg1" width="20%"><a href="#" onclick="javascript:aBook();return false;"><img src="$imgdir/address.gif"  alt="$lang[textu2uaddressbook]" border="0" /><br />$lang[textu2uaddressbook]</a></td>
+<td align="center" bgcolor="$altbg1" width="20%"><a href="buddy.php" onclick="javascript:aBook();return false;"><img src="$imgdir/address.gif"  alt="$lang[textu2uaddressbook]" border="0" /><br />$lang[textu2uaddressbook]</a></td>
 <td align="center" bgcolor="$altbg1" width="20%"><a href="u2u.php?action=ignore"><img src="$imgdir/locku2u.gif"  alt="$lang[ignorelist]" border="0" /><br />$lang[ignorelist]</a></td>
 </tr>
 </table>
@@ -4186,7 +4169,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[ignorelist]</font></strong></td>
 </tr>
@@ -4207,7 +4190,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="5" class="category"><font color="$cattext">$lang[textu2uincoming]</font></td>
 </tr>
@@ -4232,7 +4215,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor" align="left">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg2"><a href="u2u.php" onclick="setCheckboxes('u2u_main', true); return false;">$lang[checkall]</a> -
 <a href="u2u.php" onclick="setCheckboxes('u2u_main', false); return false;">$lang[uncheckall]</a> -
@@ -4262,7 +4245,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td width="100%" class="tablerow" bgcolor="$altbg1">$msg</td>
 </tr>
@@ -4277,7 +4260,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" align="center">
 <a href="u2u.php">$lang[textu2uinbox]</a> -
@@ -4299,7 +4282,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="5" class="category"><strong><font color="$cattext">$lang[textu2uoutgoing]</font></strong></td>
 </tr>
@@ -4361,7 +4344,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="mediumtxt" bgcolor="$altbg1">
 <div align="center">$lang[uqinfo]</div>
@@ -4377,7 +4360,7 @@
 <tr class="tablerow">
 <td bgcolor="$altbg1" align="center"><input type="checkbox" name="u2u_select[]" value="$u2u[u2uid]" /><input type="hidden" name="type$u2u[u2uid]" value="$u2u[type]" /></td>
 <td bgcolor="$altbg2">$u2ureadstatus</td>
-<td bgcolor="$altbg1"><a href="u2u.php?action=view&amp;folder=$folder&amp;u2uid=$u2u[u2uid]">$u2usubject</a></td>
+<td bgcolor="$altbg1"><a href="u2u.php?action=view&amp;folder=$folderrecode&amp;u2uid=$u2u[u2uid]">$u2usubject</a></td>
 <td bgcolor="$altbg2">$u2usent</td>
 <td bgcolor="$altbg1">$u2udateline</td>
 </tr>
@@ -4398,7 +4381,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td width="100%" colspan="2" class="category" align="center"><strong><font color="$cattext">$lang[textu2u]</font></strong></td>
 </tr>
@@ -4431,7 +4414,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2">$lang[textsubject] $u2usubject</td>
 </tr>
@@ -4449,7 +4432,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2">$lang[textsubject] $u2usubject</td>
 </tr>
@@ -4469,8 +4452,8 @@
 <td bgcolor="$altbg1" class="tablerow" width="15%">$lang[textsent]</td>
 <td bgcolor="$altbg2" class="smalltxt">$u2udateline</td>
 </tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="15%">$lang[textmessage]</td>
+<tr class="tablerow" valign="top">
+<td bgcolor="$altbg1" width="15%">$lang[textmessage]$u2uavatar</td>
 <td bgcolor="$altbg2">$u2umessage</td>
 </tr>
 </table>
@@ -4487,7 +4470,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="u2u.php?action=modif">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext">$lang[textu2uoptions]</font></td>
 </tr>
@@ -4513,7 +4496,7 @@
 
 |#*XMB TEMPLATE FILE*#|viewthread|#*XMB TEMPLATE*#|
 $poll
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="smalltxt"><a href="viewthread.php?fid=$fid&amp;tid=$tid&amp;action=printable">$lang[textprintver]</a> | <a href="memcp.php?action=subscriptions&amp;subadd=$tid">$lang[textsubscribe]</a> | <a href="memcp.php?action=favorites&amp;favadd=$tid">$lang[textaddfav]</a></td>
 <td class="post" align="right" valign="bottom">&nbsp;$newtopiclink$newpolllink$replylink</td>
@@ -4522,7 +4505,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header">
 <td width="18%">$lang[textauthor] </td>
@@ -4534,7 +4517,7 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="post" align="right" style="padding-top: 3px">$newtopiclink$newpolllink$replylink</td>
 </tr>
@@ -4583,12 +4566,12 @@
 <a href="post.php?action=newthread&amp;fid=$fid"><img src="$imgdir/newtopic.gif" border="0" alt="$lang[altpostnewthread]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_poll|#*XMB TEMPLATE*#|
-<form method="post" name="poll" action="topicadmin.php?action=votepoll&amp;fid=$fid&amp;tid=$tid">
+<form method="post" name="poll" action="vtmisc.php?action=votepoll&amp;fid=$fid&amp;tid=$tid">
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="3"><font color="$cattext"><strong>$lang[textpoll] $thread[subject] $results</strong></font></td>
 </tr>
@@ -4623,7 +4606,7 @@
 |#*XMB TEMPLATE FILE*#|viewthread_post|#*XMB TEMPLATE*#|
 <tr bgcolor="$thisbg">
 <td rowspan="3" valign="top" class="tablerow" style="width: 18%;">
-<font class="mediumtxt"><strong>$post[author]</strong></font>
+<a href="./member.php?action=viewpro&amp;member=$encodename"><font class="mediumtxt"><strong>$post[author]</strong></font></a>
 <br />
 <div class="smalltxt"><a name="pid$post[pid]"></a>
 $showtitle
@@ -4720,7 +4703,7 @@
 <a href="member.php?action=viewpro&amp;member=$encodename"><img src="$imgdir/profile.gif" border="0" alt="$lang[altviewprofile]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_report|#*XMB TEMPLATE*#|
-<a href="topicadmin.php?action=report&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]"><img src="$imgdir/report.gif" border="0" alt="$lang[altreportpost]" /></a>
+<a href="vtmisc.php?action=report&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]"><img src="$imgdir/report.gif" border="0" alt="$lang[altreportpost]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_repquote|#*XMB TEMPLATE*#|
 <a href="post.php?action=reply&amp;fid=$fid&amp;tid=$tid&amp;repquote=$post[pid]"><img src="$imgdir/quote.gif" border="0" alt="$lang[altquote]" /></a>
@@ -4740,7 +4723,7 @@
 <a href="$post[site]" target="_blank"><img src="$imgdir/site.gif" border="0" alt="$lang[altvisitsite]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_u2u|#*XMB TEMPLATE*#|
-<a href="#pid$post[pid]" onclick="Popup('u2u.php?action=send&amp;username=$encodename', 'Window', 700, 500);"><img src="$imgdir/u2u.gif" border="0" alt="$lang[altu2umember]" /></a>
+<a href="u2u.php?action=send&amp;username=$encodename" onclick="Popup(this.href, 'Window', 700, 500); return false;"><img src="$imgdir/u2u.gif" border="0" alt="{$lang['altu2umember']}" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_yahoo|#*XMB TEMPLATE*#|
 <a href="http://profiles.yahoo.com/$post[yahoo]" target="_blank"><img src="$imgdir/yahoo.gif" alt="" border="0" /></a>
@@ -4797,20 +4780,17 @@
 <table width="$tablewidth" border="0" align="center" cellpadding="0" cellspacing="0" bgcolor="$bordercolor">
 <tr>
 <td><input type="hidden" name="subject" value="" />
-<table width="100%" border="0" cellpadding="$tablespace" cellspacing="1">
+<table width="100%" border="0" cellpadding="$tablespace" cellspacing="{$THEME['borderwidth']}">
 <tr bgcolor="$altbg1">
 <td colspan="3" class="category"><div align="left"><font color="$cattext"><strong>&nbsp;&raquo;&nbsp;$lang[quickreply]</strong>&nbsp;- [$lang[loggedin] <strong>$self[username]</strong>]</font></div></td>
 </tr>
 $captchapostcheck
-<tr bgcolor="$altbg1" class="quickreply">
-<td colspan="3" class="tablerow"><div align="left"><strong>&nbsp;&raquo;</strong>&nbsp;$whopost2</div></td>
-</tr>
 <tr class="quickreply">
 <td width="8%" height="101" bgcolor="$altbg1" class="tablerow"> <div align="left"><span class="smalltxt">$lang[texthtmlis] $allowhtml<br />
 $lang[textsmiliesare] $allowsmilies<br />
 $lang[textbbcodeis] $allowbbcode<br />
 $lang[textimgcodeis] $allowimgcode</span><hr /></div><div align="center">
-$smilies<br /><a href="#qreply" onclick="Popup('misc.php?action=smilies', 'Window', 175, 250);">[$lang[moresmilies]]</a></div></td>
+$smilies<br /><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 200, 250); return false;">{$lang['moresmilies']}</a></div></td>
 <td bgcolor="$altbg2" width="56%" class="tablerow"> <div align="center"><textarea rows="10" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);" style="width: 100%;"></textarea></div></td>
 <td width="20%" height="101" bgcolor="$altbg2" class="tablerow"> <div align="center">
 <table width="100%" border="0" class="tablerow" cellspacing="0" cellpadding="0">
@@ -4855,4 +4835,27 @@
 |#*XMB TEMPLATE FILE*#|viewthread_reply|#*XMB TEMPLATE*#|
 <a href="./post.php?action=reply&amp;fid=$fid&amp;tid=$tid"><img src="$imgdir/reply.gif" border="0" alt="$lang[textpostreply]" /></a>
 
-|#*XMB TEMPLATE FILE*#|
\ No newline at end of file
+|#*XMB TEMPLATE FILE*#|vtmisc_report|#*XMB TEMPLATE*#|
+<form method="post" name="input" action="vtmisc.php?action=report">
+<input type="hidden" name="token" value="$oToken->newToken" />
+<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
+<tr>
+<td bgcolor="$bordercolor">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
+<tr>
+<td class="category" colspan="2"><font color="$cattext"><strong>$lang[textreportpost]</strong></font></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" valign="top" width="19%">$lang[textreason]</td>
+<td bgcolor="$altbg2"><textarea rows="9" cols="45" name="reason"></textarea>
+</tr>
+<tr>
+<td colspan="2" class="ctrtablerow" bgcolor="$altbg2"><input type="hidden" name="tid" value="$tid" /><input type="hidden" name="fid" value="$fid" /><input type="hidden" name="pid" value="$pid" /><input type="submit" class="submit" name="reportsubmit" value="$lang[textreportpost]" /></td>
+</tr>
+</table>
+</td>
+</tr>
+</table>
+</form>
+
+|#*XMB TEMPLATE FILE*#|
Index: today.php
===================================================================
--- today.php	(revision 1095)
+++ today.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'today.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -49,73 +51,33 @@
 $daysold = (isset($daysold) && is_numeric($daysold) ? (int) $daysold : 1);
 $srchfrom = $onlinetime - (86400 * $daysold);
 
-$modXmbuser = str_replace(array('*', '.', '+'), array('\*', '\.', '\+'), $xmbuser);
-$restrict = array("(password='')");
-switch($self['status']) {
-    case 'Member':
-        $restrict[] = 'private = 1';
-        $restrict[] = "(userlist = '' OR userlist REGEXP '(^|(,))( )*$modXmbuser( )*((,)|$)')";
-        break;
-    case 'Moderator':
-    case 'Super Moderator':
-        $restrict[] = '(private = 1 OR private = 3)';
-        $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))( )*$modXmbuser( )*((,)|$)'), 1, 0), 1))";
-        break;
-    case 'Administrator':
-        $restrict[] = '(private > 0 AND private < 4)';
-        $restrict[] = "(if ((private=1 AND userlist != ''), if ((userlist REGEXP '(^|(,))( )*$modXmbuser( )*((,)|$)'), 1, 0), 1))";
-        break;
-    case 'Super Administrator':
-        break;
-    default:
-        $restrict[] = '(private=1)';
-        $restrict[] = "(userlist='')";
-        break;
-}
-$restrict = implode(' AND ', $restrict);
-
 $fids = array();
 $tids = array();
 $fup = array();
+
 if (X_SADMIN) {
-    $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status='on'");
+    $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
     while($f = $db->fetch_array($q)) {
         $fids[] = $f['fid'];
     }
-    $db->free_result($q);
 } else {
-    $q = $db->query("SELECT fid, type, fup FROM ".X_PREFIX."forums WHERE status='on' AND $restrict");
-    while($f = $db->fetch_array($q)) {
-        if (isset($f['type']) && $f['type'] == 'sub') {
-            $query = $db->query("SELECT private, userlist, name, fid FROM ".X_PREFIX."forums WHERE fid='$f[fup]'");
-            $fup = $db->fetch_array($query);
-            if (privfcheck($fup['private'], $fup['userlist'])) {
-                $fids[] = $f['fid'];
-            }
-            $db->free_result($query);
-        } else {
-            $fids[] = $f['fid'];
-        }
-    }
-    $db->free_result($q);
+    $fCache = array();
+    $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
+    while($forum = $db->fetch_array($q)) {
+        $perms = checkForumPermissions($forum);
+        $fCache[$forum['fid']] = $perms;
 
-    if (X_MEMBER) {
-        // let's add fids for passworded forums that the user can access
-        $r2 = array();
-        foreach($_COOKIE as $key=>$val) {
-            if (preg_match('#^fidpw([0-9]+)$#', $key, $fetch)) {
-                $r2[] = '(fid="' . $fetch[1] . '" AND password="'.addslashes($val).'")';
+        if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
+            if ($forum['type'] == 'sub') {
+                // also check above forum!
+                $parentP = $fCache[$forum['fup']];
+                if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
+                    $fids[] = $forum['fid'];
+                }
+            } else {
+                $fids[] = $forum['fid'];
             }
         }
-
-        if (count($r2) > 0) {
-            $r = implode(' OR ', $r2);
-            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE $r");
-            while($f = $db->fetch_array($q)) {
-                $fids[] = $f['fid'];
-            }
-            $db->free_result($q);
-        }
     }
 }
 
@@ -125,7 +87,7 @@
 
 $fids = implode(', ', $fids);
 
-$query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE lastpost >= '$srchfrom' AND fid IN($fids)");
+$query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE lastpost >= '$srchfrom' AND fid IN ($fids)");
 $results = $db->num_rows($query);
 while($t = $db->fetch_array($query)) {
     $tids[] = $t['tid'];
@@ -171,17 +133,18 @@
         eval('$multipage = "'.template('today_multipage').'";');
     }
 
-    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN($tids) ORDER BY t.lastpost DESC LIMIT $start_limit, $tpp");
+    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN ($tids) ORDER BY t.lastpost DESC LIMIT $start_limit, $tpp");
     $today_row = array();
     $tmOffset = ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600);
     while($thread = $db->fetch_array($query)) {
-        $thread['subject'] = shortenString(stripslashes($thread['subject']), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
-        $thread['name'] = stripslashes($thread['name']);
+        $thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+        $thread['name'] = fnameOut($thread['name']);
 
         if ($thread['author'] == $lang['textanonymous']) {
             $authorlink = $thread['author'];
         } else {
-            $authorlink = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($thread['author']).'">'.$thread['author'].'</a>';
+            $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
+
         }
 
         $lastpost = explode('|', $thread['lastpost']);
@@ -189,7 +152,7 @@
         $lastPid = $lastpost[2];
 
         if ($lastpost[1] != $lang['textanonymous']) {
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         }
 
         $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
@@ -211,7 +174,7 @@
         $oldtopics = isset($oldtopics) ? $oldtopics : '';
         if (($oT = strpos($oldtopics, '|'.$lastPid.'|')) === false && $thread['replies'] >= $SETTINGS['hottopic'] && $lastvisit < $dalast) {
             $folder = '<img src="'.$imgdir.'/hot_red_folder.gif" alt="'.$lang['althotredfolder'].'" border="0" />';
-        } else if ( $lastvisit < $dalast && $oT === false) {
+        } else if ($lastvisit < $dalast && $oT === false) {
             $folder = '<img src="'.$imgdir.'/red_folder.gif" alt="'.$lang['altredfolder'].'" border="0" />';
         }
 
@@ -241,17 +204,13 @@
             $pagelinks = $multipage2 = '';
         }
 
-        $thread['subject'] = checkOutput($thread['subject'], 'no', '', true);
-        $thread['subject'] = censor($thread['subject']);
-        $thread['subject'] = addslashes($thread['subject']);
-        $thread['name'] = html_entity_decode($thread['name']);
         eval('$today_row[] = "'.template('today_row').'";');
     }
     $rows = implode("\n", $today_row);
     $db->free_result($query);
 }
 
-eval('echo stripslashes("'.template('today').'");');
+eval('echo "'.template('today').'";');
 
 end_time();
 eval('echo "'.template('footer').'";');
Index: tools.php
===================================================================
--- tools.php	(revision 1095)
+++ tools.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'tools.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
@@ -53,7 +55,7 @@
 
 displayAdminPanel();
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 switch($action) {
     case 'fixftotals':
@@ -126,53 +128,11 @@
         break;
 
     case 'fixlastposts':
-        $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE (fup='0' OR fup='') AND type='forum'");
-        while($loner = $db->fetch_array($q)) {
-            $lastpost = array();
-            $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$loner[fid]'");
-            while($sub = $db->fetch_array($subq)) {
-                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
-                if ($db->num_rows($pq) > 0) {
-                    $curr = $db->fetch_array($pq);
-                    $lastpost[] = $curr;
-                    $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-                } else {
-                    $lp = '';
-                }
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
-                $db->free_result($pq);
-            }
-            $db->free_result($subq);
-
-            $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$loner[fid]' ORDER BY pid DESC LIMIT 1");
-            if ($db->num_rows($pq) > 0) {
-                $lastpost[] = $db->fetch_array($pq);
-            }
-            $db->free_result($pq);
-
-            if (count($lastpost) == 0) {
-                $lastpost = '';
-            } else {
-                $top = 0;
-                $mkey = -1;
-                foreach($lastpost as $key => $v) {
-                    if ($v['dateline'] > $top) {
-                        $mkey = $key;
-                        $top = $v['dateline'];
-                    }
-                }
-                $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
-            }
-            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$loner[fid]'");
-        }
-        $db->free_result($q);
-
-        $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
-        while($cat = $db->fetch_array($q)) {
-            $fq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup='$cat[fid]'");
-            while($forum = $db->fetch_array($fq)) {
+        if (postedVar('scope', '', FALSE, FALSE, FALSE, 'g') == 'forumsonly') {
+            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE (fup='0' OR fup='') AND type='forum'");
+            while($loner = $db->fetch_array($q)) {
                 $lastpost = array();
-                $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$forum[fid]'");
+                $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$loner[fid]'");
                 while($sub = $db->fetch_array($subq)) {
                     $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
                     if ($db->num_rows($pq) > 0) {
@@ -182,12 +142,12 @@
                     } else {
                         $lp = '';
                     }
+                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
                     $db->free_result($pq);
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
                 }
                 $db->free_result($subq);
 
-                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$forum[fid]' ORDER BY pid DESC LIMIT 1");
+                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$loner[fid]' ORDER BY pid DESC LIMIT 1");
                 if ($db->num_rows($pq) > 0) {
                     $lastpost[] = $db->fetch_array($pq);
                 }
@@ -206,27 +166,82 @@
                     }
                     $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
                 }
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$forum[fid]'");
+                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$loner[fid]'");
             }
-            $db->free_result($fq);
-        }
-        $db->free_result($q);
+            $db->free_result($q);
 
-        $q = $db->query("SELECT tid FROM ".X_PREFIX."threads");
-        while($thread = $db->fetch_array($q)) {
-            $lastpost = array();
-            $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$thread[tid]' ORDER BY pid DESC LIMIT 1");
-            if ($db->num_rows($pq) > 0) {
-                $curr = $db->fetch_array($pq);
-                $lastpost[] = $curr;
-                $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-            } else {
-                $lp = '';
+            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
+            while($cat = $db->fetch_array($q)) {
+                $fq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup='$cat[fid]'");
+                while($forum = $db->fetch_array($fq)) {
+                    $lastpost = array();
+                    $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$forum[fid]'");
+                    while($sub = $db->fetch_array($subq)) {
+                        $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
+                        if ($db->num_rows($pq) > 0) {
+                            $curr = $db->fetch_array($pq);
+                            $lastpost[] = $curr;
+                            $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
+                        } else {
+                            $lp = '';
+                        }
+                        $db->free_result($pq);
+                        $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
+                    }
+                    $db->free_result($subq);
+
+                    $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$forum[fid]' ORDER BY pid DESC LIMIT 1");
+                    if ($db->num_rows($pq) > 0) {
+                        $lastpost[] = $db->fetch_array($pq);
+                    }
+                    $db->free_result($pq);
+
+                    if (count($lastpost) == 0) {
+                        $lastpost = '';
+                    } else {
+                        $top = 0;
+                        $mkey = -1;
+                        foreach($lastpost as $key => $v) {
+                            if ($v['dateline'] > $top) {
+                                $mkey = $key;
+                                $top = $v['dateline'];
+                            }
+                        }
+                        $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
+                    }
+                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$forum[fid]'");
+                }
+                $db->free_result($fq);
             }
-            $db->free_result($pq);
-            $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$lp' WHERE tid='$thread[tid]'");
+            $db->free_result($q);
+
+        } else { // Update all threads using as few queries as possible
+            $newsql = 'SELECT t.tid, t.lastpost, p.author, p.dateline, p.pid '
+                    . 'FROM '.X_PREFIX.'threads AS t '
+                    . 'LEFT JOIN '.X_PREFIX.'posts AS p ON t.tid=p.tid '
+                    . 'INNER JOIN ('
+                    . '    SELECT MAX(pid) AS lastpid '
+                    . '    FROM '.X_PREFIX.'posts '
+                    . '    GROUP BY tid'
+                    . ') AS query2 ON p.pid=query2.lastpid';
+
+            $lpquery = $db->query($newsql);
+
+            while($thread = $db->fetch_array($lpquery)) {
+                if ($thread['pid'] !== NULL) {
+                    $lp = $thread['dateline'].'|'.$thread['author'].'|'.$thread['pid'];
+                } else {
+                    $lp = '';
+                }
+
+                if ($thread['lastpost'] != $lp) {
+                    $lp = $db->escape($lp);
+                    $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$lp' WHERE tid={$thread['tid']}");
+                }
+            }
+            $db->free_result($lpquery);
         }
-        $db->free_result($q);
+
         nav($lang['tools']);
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['tool_completed'].' - '.$lang['tool_lastpost'].'</td></tr></table></table>';
         end_time();
@@ -281,11 +296,11 @@
             $i = 0;
             $q = $db->query("SELECT aid, pid FROM ".X_PREFIX."attachments");
             while($a = $db->fetch_array($q)) {
-                $result = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE pid='$a[pid]'");
-                if ($db->num_rows($result) == 0) {
-                    $db->free_result($result);
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid='$a[aid]'");
-                    $i++;
+               $result = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE pid={$a['pid']}");
+                  if ($db->num_rows($result) == 0) {
+                  $db->free_result($result);
+                  $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid={$a['aid']}");
+                  $i++;
                 }
             }
             $db->free_result($q);
@@ -306,7 +321,7 @@
 
     case 'u2udump':
         if (noSubmit('yessubmit')) {
-            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['whoodump_confirm'].'<br /><form action="tools.php?action=u2udump" method="post"><input type="submit" name="yessubmit" value="'.$lang['textyes'].'" /> - <input type="submit" name="yessubmit" value="'.$lang['textno'].'" /></form></td></tr>';
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['u2udump_confirm'].'<br /><form action="tools.php?action=u2udump" method="post"><input type="submit" name="yessubmit" value="'.$lang['textyes'].'" /> - <input type="submit" name="yessubmit" value="'.$lang['textno'].'" /></form></td></tr>';
         } else if ($lang['textyes'] == $yessubmit) {
             $db->query("TRUNCATE ".X_PREFIX."u2u");
             nav($lang['tools']);
Index: topicadmin.php
===================================================================
--- topicadmin.php	(revision 1095)
+++ topicadmin.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,14 +26,22 @@
  *
  **/
 
+define('X_SCRIPT', 'topicadmin.php');
+
 require 'header.php';
 require ROOT.'include/topicadmin.inc.php';
 
 $_tid = isset($_POST['tid']) ? $_POST['tid'] : (isset($_GET['tid']) ? $_GET['tid'] : 0);
-$fid = isset($_POST['fid']) && is_numeric($_POST['fid']) ? (int) $_POST['fid'] : (isset($_GET['fid']) && is_numeric($_GET['fid']) ? (int) $_GET['fid'] : 0);
+$fid = getInt('fid', 'p');
+if ($fid == 0) {
+    $fid = getInt('fid');
+}
 $pid = getInt('pid');
 $othertid = formInt('othertid');
-$action = isset($_POST['action']) && !empty($_POST['action']) ? $_POST['action'] : (isset($_GET['action']) && !empty($_GET['action']) ? $_GET['action'] : '');
+$action = postedVar('action');
+if ($action == '') {
+    $action = postedVar('action', '', TRUE, TRUE, FALSE, 'g');
+}
 
 if (is_array($_tid)) {
     $tids = array_unique(array_map('intval', $_tid));
@@ -51,7 +59,6 @@
 } else {
     $tid = (int) $_tid;
 }
-$kill = false;
 
 loadtemplates(
 'topicadmin_delete',
@@ -62,12 +69,10 @@
 'topicadmin_split_row',
 'topicadmin_split',
 'topicadmin_merge',
-'topicadmin_report',
 'topicadmin_empty',
 'topicadmin_threadprune_row',
 'topicadmin_threadprune',
-'topicadmin_copy',
-'misc_feature_notavailable'
+'topicadmin_copy'
 );
 
 eval('$css = "'.template('css').'";');
@@ -75,36 +80,58 @@
 if ($tid && !is_array($tid) && false === strstr($tid, ',')) {
     $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
     $thread = $db->fetch_array($query);
-    $threadname = html_entity_decode(stripslashes($thread['subject']));
-    $fid = $thread['fid'];
+    $db->free_result($query);
+    $threadname = rawHTMLsubject(stripslashes($thread['subject']));
+    $fid = (int)$thread['fid'];
 } else {
-    $threadSubject = '';
+    $threadname = '';
 }
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
+$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid AND status='on'");
 $forums = $db->fetch_array($query);
-$forums['name'] = stripslashes($forums['name']);
+$db->free_result($query);
 
-if ($fid == 0) {
-    $kill = true;
-} else if (isset($forums['type']) && $forums['type'] == 'forum') {
-    nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode($forums['name'].'</a>'));
-    if (isset($thread['subject'])) {
-        nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
-    }
-} else if (isset($forums['type']) && $forums['type'] == 'sub') {
-    $query = $db->query("SELECT name, fid FROM ".X_PREFIX."forums WHERE fid='$forums[fup]'");
+if (($forums['type'] != 'forum' && $forums['type'] != 'sub') || $forums['status'] != 'on') {
+    error($lang['textnoforum']);
+}
+
+// Check for authorization to be here in the first place
+$perms = checkForumPermissions($forums);
+if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+    error($lang['privforummsg']);
+} else if (!$perms[X_PERMS_PASSWORD]) {
+    handlePasswordDialog($fid);
+}
+
+$fup = array();
+if ($forums['type'] == 'sub') {
+    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forums['fup']}");
     $fup = $db->fetch_array($query);
-    $fup['name'] = stripslashes($fup['name']);
-    nav('<a href="forumdisplay.php?fid='.intval($fup['fid']).'">'.html_entity_decode($fup['name']).'</a>');
-    nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode($forums['name']).'</a>');
-    if (isset($threadname)) {
-        nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
+    $db->free_result($query);
+
+    // prevent access to subforum when upper forum can't be viewed.
+    $fupPerms = checkForumPermissions($fup);
+    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+        error($lang['privforummsg']);
+    } else if (!$fupPerms[X_PERMS_PASSWORD]) {
+        handlePasswordDialog($fup['fid']);
+    } else if ($fup['fup'] > 0) {
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
     }
-} else {
-    $kill = true;
+    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+} else if ($forums['fup'] > 0) { // 'forum' in a 'group'
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forums['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+    nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 }
+nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forums['name']).'</a>');
+if (isset($thread['subject'])) {
+    nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
+}
 
+$kill = FALSE;
+
 switch($action) {
     case 'delete':
         nav($lang['textdeletethread']);
@@ -133,9 +160,6 @@
     case 'bump':
         nav($lang['textbumpthread']);
         break;
-    case 'report':
-        nav($lang['textreportpost']);
-        break;
     case 'split':
         nav($lang['textsplitthread']);
         break;
@@ -148,34 +172,35 @@
     case 'empty':
         nav($lang['textemptythread']);
         break;
-    case 'votepoll':
-        nav($lang['textvote']);
-        break;
     default:
-        $kill = true;
+        $kill = TRUE;
         break;
 }
 
+$mod = new mod();
+$kill |= !X_STAFF || !$mod->statuscheck($fid);
+
 if ($kill) {
     error($lang['notpermitted']);
 }
 
+if ($SETTINGS['subject_in_title'] == 'on') {
+    $threadSubject = '- '.$threadname;
+}
+
 eval('echo "'.template('header').'";');
 
-$mod = new mod();
-
 switch($action) {
     case 'delete':
-        $mod->statuscheck($fid);
         if (noSubmit('deletesubmit')) {
             $tid = $mod->create_tid_string($tid);
-            eval('echo stripslashes("'.template('topicadmin_delete').'");');
+            eval('echo "'.template('topicadmin_delete').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid'");
                 while($result = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$result[author]'");
+                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($result['author'])."'");
                 }
                 $db->free_result($query);
 
@@ -186,21 +211,22 @@
 
                 $db->query("DELETE FROM ".X_PREFIX."threads WHERE closed='moved|$tid'");
 
-                if (isset($forums['type']) && $forums['type'] == 'sub') {
-                    updateforumcount($fup['fup']);
+                if ($forums['type'] == 'sub') {
+                    updateforumcount($fup['fid']);
                 }
                 updateforumcount($fid);
 
                 $mod->log($xmbuser, $action, $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['deletethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['deletethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'close':
-        $mod->statuscheck($fid);
         $query = $db->query("SELECT closed FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+        if ($db->num_rows($query) == 0) {
+            error($lang['textnothread'], FALSE);
+        }
         $closed = $db->result($query, 0);
         $db->free_result($query);
 
@@ -210,7 +236,7 @@
             } else if ($closed == '') {
                 $lang['textclosethread'] = $lang['textclosethread'];
             }
-            eval('echo stripslashes("'.template('topicadmin_openclose').'");');
+            eval('echo "'.template('topicadmin_openclose').'";');
         } else {
             if ($closed == 'yes') {
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid='$tid' AND fid='$fid'");
@@ -221,108 +247,105 @@
             $act = ($closed != '') ? 'open' : 'close';
             $mod->log($xmbuser, $act, $fid, $tid);
 
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'f_close':
-        $mod->statuscheck($fid);
         if (noSubmit('closesubmit')) {
             $tid = $mod->create_tid_string($tid);
-            eval('echo stripslashes("'.template('topicadmin_openclose').'");');
+            eval('echo "'.template('topicadmin_openclose').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
                 $mod->log($xmbuser, 'close', $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'f_open':
-        $mod->statuscheck($fid);
         if (noSubmit('closesubmit')) {
             $tid = $mod->create_tid_string($tid);
             $lang['textclosethread'] = $lang['textopenthread'];
-            eval('echo stripslashes("'.template('topicadmin_openclose').'");');
+            eval('echo "'.template('topicadmin_openclose').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid='$tid' AND fid='$fid'");
                 $mod->log($xmbuser, 'open', $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'move':
-        $mod->statuscheck($fid);
         if (noSubmit('movesubmit')) {
             $tid = $mod->create_tid_string($tid);
             $forumselect = forumList('moveto', false, false, $fid);
-            eval('echo stripslashes("'.template('topicadmin_move').'");');
+            eval('echo "'.template('topicadmin_move').'";');
         } else {
             $moveto = formInt('moveto');
-            if ($moveto) {
-                $query = $db->query("SELECT type FROM ".X_PREFIX."forums WHERE fid=$moveto");
-                $forumtype = $db->result($query, 0);
-                $db->free_result($query);
+            $query = $db->query("SELECT type, fup FROM ".X_PREFIX."forums WHERE fid=$moveto");
+            if ($db->num_rows($query) == 0) {
+                error($lang['textnoforum'], FALSE);
+            }
+            $movetorow = $db->fetch_array($query);
 
-                if($forumtype == 'group') {
-                    echo '<center><span class="mediumtxt">'.$lang['errormovingthreads'].'</span></center>';
-                    end_time();
-                    eval('echo "'.template('footer').'";');
-                    exit();
-                }
+            if ($movetorow['type'] == 'group') {
+                error($lang['errormovingthreads'], FALSE);
+            }
 
-                $tids = $mod->create_tid_array($tid);
-                foreach($tids AS $tid) {
-                    if ($type == "normal") {
-                        $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid'");
-                        $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid'");
-                    } else {
-                        $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
-                        $info = $db->fetch_array($query);
+            $tids = $mod->create_tid_array($tid);
+            foreach($tids AS $tid) {
+                if ($type == "normal") {
+                    $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid'");
+                } else {
+                    $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
+                    $info = $db->fetch_array($query);
+                    $db->free_result($query);
 
-                        $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ('$info[fid]', '$info[subject]', '', '$info[lastpost]', 0, 0, '$info[author]', 'moved|$info[tid]', '$info[topped]')");
-                        $ntid = $db->insert_id();
+                    $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ({$info['fid']}, '".$db->escape($info['subject'])."', '', '".$db->escape($info['lastpost'])."', 0, 0, '".$db->escape($info['author'])."', 'moved|{$info['tid']}', '{$info['topped']}')");
+                    $ntid = $db->insert_id();
 
-                        $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ('$info[fid]', '$ntid', '$info[author]', '$info[tid]', '$info[subject]', 0, '', '', '', '', '')");
-                        $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
-                        $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
-                    }
-                    updatethreadcount($tid);
-                    $f = "$fid -> $moveto";
-                    $mod->log($xmbuser, $action, $moveto, $tid);
+                    $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ({$info['fid']}, '$ntid', '".$db->escape($info['author'])."', '{$info['tid']}', '".$db->escape($info['subject'])."', 0, '', '', '', '', '')");
+                    $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
                 }
-            } else {
-                echo '<center><span class="mediumtxt">'.$lang['errormovingthreads'].'</span></center>';
-                end_time();
-                eval('echo "'.template('footer').'";');
-                exit();
+                updatethreadcount($tid);
+                $f = "$fid -> $moveto";
+                $mod->log($xmbuser, $action, $moveto, $tid);
             }
 
-            if (isset($forums['type']) && $forums['type'] == "sub") {
-                updateforumcount($fup['fup']);
+            if ($forums['type'] == 'sub') {
+                updateforumcount($fup['fid']);
             }
+            if ($movetorow['type'] == 'sub') {
+                if ($movetorow['fup'] != $fup['fid']) {
+                    updateforumcount($movetorow['fup']);
+                }
+            }
             updateforumcount($fid);
             updateforumcount($moveto);
 
-            echo '<center><span class="mediumtxt">'.$lang['movethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['movethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'top':
-        $mod->statuscheck($fid);
         if (noSubmit('topsubmit')) {
             if (!is_array($tid)) {
                 $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+                if ($db->num_rows($query) == 0) {
+                    $db->free_result($query);
+                    error($lang['textnothread'], FALSE);
+                }
                 $topped = $db->result($query, 0);
+                $db->free_result($query);
                 if ($topped == 1) {
                     $lang['texttopthread'] = $lang['textuntopthread'];
                 }
@@ -330,12 +353,17 @@
                 $lang['texttopthread'] = $lang['texttopthread'].' / '.$lang['textuntopthread'];
             }
             $tid = $mod->create_tid_string($tid);
-            eval('echo stripslashes("'.template('topicadmin_topuntop').'");');
+            eval('echo "'.template('topicadmin_topuntop').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+                if ($db->num_rows($query) == 0) {
+                    $db->free_result($query);
+                    error($lang['textnothread'], FALSE);
+                }
                 $topped = $db->result($query, 0);
+                $db->free_result($query);
 
                 if ($topped == 1) {
                     $db->query("UPDATE ".X_PREFIX."threads SET topped='0' WHERE tid='$tid' AND fid='$fid'");
@@ -347,24 +375,23 @@
                 $mod->log($xmbuser, $act, $fid, $tid);
             }
 
-            echo '<center><span class="mediumtxt">'.$lang['topthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['topthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'getip':
-        $mod->statuscheck($fid);
         if ($pid) {
             $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE pid='$pid'");
         } else {
             $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
         }
         $ipinfo = $db->fetch_array($query);
+        $db->free_result($query);
         ?>
         <form method="post" action="cp.php?action=ipban">
         <table cellspacing="0" cellpadding="0" border="0" width="60%" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="header" colspan="3"><?php echo $lang['textgetip']?></td>
         </tr>
@@ -375,10 +402,10 @@
             $ip = explode('.', $ipinfo['useip']);
             $query = $db->query("SELECT * FROM ".X_PREFIX."banned WHERE (ip1='$ip[0]' OR ip1='-1') AND (ip2='$ip[1]' OR ip2='-1') AND (ip3='$ip[2]' OR ip3='-1') AND (ip4='$ip[3]' OR ip4='-1')");
             $result = $db->fetch_array($query);
-
+            $db->free_result($query);
             if ($result) {
                 $buttontext = $lang['textunbanip'];
-                for ($i=1; $i<=4; ++$i) {
+                for($i=1; $i<=4; ++$i) {
                     $j = "ip$i";
                     if ($result[$j] == -1) {
                         $result[$j] = "*";
@@ -398,7 +425,7 @@
                 echo "<input type=\"hidden\" name=\"delete$result[id]\" value=\"$result[id]\" />";
             } else {
                 $buttontext = $lang['textbanip'];
-                for ($i=1; $i<=4; ++$i) {
+                for($i=1; $i<=4; ++$i) {
                     $j = $i - 1;
                     echo "<input type=\"hidden\" name=\"newip$i\" value=\"$ip[$j]\" />";
                 }
@@ -413,61 +440,69 @@
         break;
 
     case 'bump':
-        $mod->statuscheck($fid);
         if (noSubmit('bumpsubmit')) {
             $tid = $mod->create_tid_string($tid);
-            eval('echo stripslashes("'.template('topicadmin_bump').'");');
+            eval('echo "'.template('topicadmin_bump').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $pid = $db->result($db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid DESC LIMIT 1"), 0);
-                $db->query("UPDATE ".X_PREFIX."threads SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE tid='$tid' AND fid='$fid'");
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE fid='$fid'");
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid DESC LIMIT 1");
+                if ($db->num_rows($query) == 1) {
+                    $pid = $db->result($query, 0);
 
-                $mod->log($xmbuser, $action, $fid, $tid);
+                    $db->query("UPDATE ".X_PREFIX."threads SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE tid=$tid AND fid=$fid");
+                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE fid=$fid");
+
+                    $mod->log($xmbuser, $action, $fid, $tid);
+                }
+                $db->free_result($query);
             }
-            echo '<center><span class="mediumtxt">'.$lang['bumpthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['bumpthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'empty':
-        $mod->statuscheck($fid);
         if (noSubmit('emptysubmit')) {
             $tid = $mod->create_tid_string($tid);
-            eval('echo stripslashes("'.template('topicadmin_empty').'");');
+            eval('echo "'.template('topicadmin_empty').'";');
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $pid = $db->result($db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid ASC LIMIT 1"), 0);
-                $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid!='$pid'");
-                while($result = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$result[author]'");
-                }
-                $db->free_result($query);
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid ASC LIMIT 1");
+                if ($db->num_rows($query) == 1) {
+                    $pid = $db->result($query, 0);
+                    $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
+                    while($result = $db->fetch_array($query)) {
+                        $dbauthor = $db->escape($result['author']);
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
+                    }
 
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid!='$pid'");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
+                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
+                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid=$tid");
 
-                updatethreadcount($tid);
-                $mod->log($xmbuser, $action, $fid, $tid);
+                    updatethreadcount($tid); //Also updates lastpost
+                    $mod->log($xmbuser, $action, $fid, $tid);
+                }
+                $db->free_result($query);
             }
-            if (isset($forums['type']) && $forums['type'] == 'sub') {
-                updateforumcount($fup['fup']);
+            if ($forums['type'] == 'sub') {
+                updateforumcount($fup['fid']);
             }
             updateforumcount($fid);
 
-            echo '<center><span class="mediumtxt">'.$lang['emptythreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['emptythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'split':
-        $mod->statuscheck($fid);
         if (noSubmit('splitsubmit')) {
             $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
+            if ($db->num_rows($query) == 0) {
+                error($lang['textnothread'], FALSE);
+            }
             $replies = $db->result($query, 0);
-
+            $db->free_result($query);
             if ($replies == 0) {
                 error($lang['cantsplit'], false);
             }
@@ -481,89 +516,82 @@
                 $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, "", "", X_PREFIX."words", X_PREFIX."forums", X_PREFIX."smilies");
                 eval('$posts .= "'.template('topicadmin_split_row').'";');
             }
-            eval('echo stripslashes("'.template('topicadmin_split').'");');
+            $db->free_result($query);
+            eval('echo "'.template('topicadmin_split').'";');
         } else {
-            $subject = formVar('subject');
+            $subject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));  // Subjects are historically double-quoted
             if ($subject == '') {
                 error($lang['textnosubject'], false);
             }
-            $subject = addslashes($subject);
 
-            $chkInputHTML = 'no';
-            $chkInputTags = 'no';
-            if (isset($forums['allowhtml']) && $forums['allowhtml'] == 'yes') {
-                $chkInputHTML = 'yes';
-                $chkInputTags = 'no';
-            }
-            $subject = checkInput($subject, $chkInputTags, $chkInputHTML, '', false);
-
             $threadcreated = false;
             $firstmove = false;
-            $query = $db->query("SELECT subject, pid FROM ".X_PREFIX."posts WHERE tid='$tid'");
+            $query = $db->query("SELECT pid, author, dateline, subject FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC");
+            $movecount = 0;
             while($post = $db->fetch_array($query)) {
-                $move = "move".$post['pid'];
-                $move = isset($_POST[$move]) ? $_POST[$move] : '';
-                $thatime = $onlinetime;
-                if (!$threadcreated) {
-                    $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$subject', '', '$thatime|$xmbuser', 0, 0, '$xmbuser', '', 0)");
-                    $newtid = $db->insert_id();
-                    $threadcreated = true;
-                }
+                $move = getInt('move'.$post['pid'], 'p');
+                if ($move == $post['pid']) {
+                    if (!$threadcreated) {
+                        $thatime = $onlinetime;
+                        $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$subject', '', '$thatime|$xmbuser', 0, 0, '".$db->escape($post['author'])."', '', 0)");
+                        $newtid = $db->insert_id();
+                        $threadcreated = true;
+                    }
 
-                if (!empty($move)) {
                     $newsub = '';
                     if (!$firstmove) {
                         $newsub = ", subject='$subject'";
                         $firstmove = true;
                     }
-                    $db->query("UPDATE ".X_PREFIX."posts SET tid=$newtid $newsub WHERE pid='$move'");
-                    $db->query("UPDATE ".X_PREFIX."attachments SET tid=$newtid WHERE pid='$move'");
-                    $db->query("UPDATE ".X_PREFIX."threads SET replies=replies+1 WHERE tid='$newtid'");
-                    $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET tid=$newtid $newsub WHERE pid=$move");
+                    $db->query("UPDATE ".X_PREFIX."attachments SET tid=$newtid WHERE pid=$move");
+                    $lastpost = $post['dateline'].'|'.$db->escape($post['author']).'|'.$post['pid'];
+                    $movecount++;
+                } else {
+                    $oldlastpost = $post['dateline'].'|'.$db->escape($post['author']).'|'.$post['pid'];
                 }
             }
+            $db->query("UPDATE ".X_PREFIX."threads SET replies=$movecount-1, lastpost='$lastpost' WHERE tid='$newtid'");
+            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-$movecount, lastpost='$oldlastpost' WHERE tid='$tid'");
+            $db->free_result($query);
 
-            $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$newtid' ORDER BY dateline ASC LIMIT 0,1");
-            $firstauthor = $db->result($query, 0);
-            $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid=$newtid ORDER BY dateline DESC LIMIT 0,1");
-            $lastpost = $db->fetch_array($query);
-            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]', replies=replies-1 WHERE tid=$newtid");
-
-            $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC LIMIT 0,1");
-            $firstauthor = $db->result($query, 0);
-            $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0,1");
-            $lastpost = $db->fetch_array($query);
-            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]' WHERE tid='$tid'");
-
             $mod->log($xmbuser, $action, $fid, $tid);
 
-            echo '<center><span class="mediumtxt">'.$lang['splitthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            if ($forums['type'] == 'sub') {
+                updateforumcount($fup['fid']);
+            }
+            updateforumcount($fid);
+
+            message($lang['splitthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'merge':
-        $mod->statuscheck($fid);
+        $tid = intval($tid);
         if (noSubmit('mergesubmit')) {
-            eval('echo stripslashes("'.template('topicadmin_merge').'");');
+            eval('echo "'.template('topicadmin_merge').'";');
         } else {
-            if ($tid == $othertid) {
-                error($lang['cannotmergesamethread']);
+            if ($othertid == 0) {
+                error($lang['invalidtid'], false);
+            } else if ($tid == $othertid) {
+                error($lang['cannotmergesamethread'], false);
             }
 
-            $queryadd1 = $db->query("SELECT replies, fid FROM ".X_PREFIX."threads WHERE tid='$othertid'");
-            $queryadd2 = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
-            $replyadd = $db->result($queryadd1, 0, 'replies');
-            $otherfid = $db->result($queryadd1, 0, 'fid');
-            $replyadd2 = $db->result($queryadd2, 0);
-            $replyadd++;
-            $replyadd = $replyadd + $replyadd2;
+            $queryadd1 = $db->query("SELECT t.replies, t.fid, f.type, f.fup FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."forums AS f USING(fid) WHERE t.tid='$othertid'");
 
+            if ($db->num_rows($queryadd1) == 0) {
+                $db->free_result($queryadd1);
+                error($lang['tidnoexist'], false);
+            }
+            $otherthread = $db->fetch_array($queryadd1);
+            $db->free_result($queryadd1);
+            $replyadd = $otherthread['replies'];
+            $otherfid = $otherthread['fid'];
+
             $db->query("UPDATE ".X_PREFIX."posts SET tid='$tid', fid='$fid' WHERE tid='$othertid'");
             $db->query("UPDATE ".X_PREFIX."attachments SET tid='$tid' WHERE tid='$othertid'");
 
             $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$othertid'");
-            $db->query("UPDATE ".X_PREFIX."forums SET threads = threads-1 WHERE fid='$otherfid'");
 
             $query = $db->query("SELECT * FROM ".X_PREFIX."favorites WHERE tid='$othertid' OR tid='$tid'");
             if ($db->num_rows($query) == 2) {
@@ -571,24 +599,39 @@
             } else {
                 $db->query("UPDATE ".X_PREFIX."favorites SET tid='$tid' WHERE tid='$othertid'");
             }
+            $db->free_result($query);
 
             $query = $db->query("SELECT subject, author, icon FROM ".X_PREFIX."posts WHERE tid='$tid' OR tid='$othertid' ORDER BY pid ASC LIMIT 1");
             $thread = $db->fetch_array($query);
+            $db->free_result($query);
             $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0, 1");
             $lastpost = $db->fetch_array($query);
-            $db->query("UPDATE ".X_PREFIX."threads SET replies='$replyadd', subject='$thread[subject]', icon='$thread[icon]', author='$thread[author]', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]' WHERE tid='$tid'");
+            $db->free_result($query);
+            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies+'$replyadd', subject='".$db->escape($thread['subject'])."', icon='{$thread['icon']}', author='".$db->escape($thread['author'])."', lastpost='{$lastpost['dateline']}|".$db->escape($lastpost['author'])."|{$lastpost['pid']}' WHERE tid='$tid'");
 
             $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
 
-            echo '<center><span class="mediumtxt">'.$lang['mergethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            if ($forums['type'] == 'sub') {
+                updateforumcount($fup['fid']);
+            }
+            if ($otherthread['type'] == 'sub') {
+                if ($otherthread['fup'] != $fup['fid']) {
+                    updateforumcount($otherthread['fup']);
+                }
+            }
+            updateforumcount($fid);
+            updateforumcount($otherfid);
+
+            message($lang['mergethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'threadprune':
-        $mod->statuscheck($fid);
         if (noSubmit('threadprunesubmit')) {
             $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
+            if ($db->num_rows($query) == 0) {
+                error($lang['textnothread'], FALSE);
+            }
             $replies = $db->result($query, 0);
             $db->free_result($query);
 
@@ -626,17 +669,18 @@
                 }
                 $db->free_result($query);
             }
-            eval('echo stripslashes("'.template('topicadmin_threadprune').'");');
+            eval('echo "'.template('topicadmin_threadprune').'";');
         } else {
             if (X_SADMIN || $SETTINGS['allowrankedit'] == 'off') {
                 $query = $db->query("SELECT author, pid, message FROM ".X_PREFIX."posts WHERE tid='$tid'");
                 while($post = $db->fetch_array($query))    {
                     $move = "move".$post['pid'];
-                    $move = isset($_POST[$move]) ? $_POST[$move] : '';
+                    $move = getInt($move, 'p');
                     if (!empty($move)) {
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='{$post['author']}'");
-                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$move'");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$move'");
+                        $dbauthor = $db->escape($post['author']);
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
+                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid=$move");
+                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid=$move");
                         $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
                     }
                 }
@@ -649,11 +693,12 @@
                         continue;
                     }
                     $move = "move".$post['pid'];
-                    $move = isset($_POST[$move]) ? $_POST[$move] : '';
+                    $move = getInt($move, 'p');
                     if (!empty($move)) {
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='{$post['author']}'");
-                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$move'");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$move'");
+                        $dbauthor = $db->escape($post['author']);
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
+                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid=$move");
+                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid=$move");
                         $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
                     }
                 }
@@ -661,208 +706,106 @@
             }
 
             $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC LIMIT 0,1");
-            $firstauthor = $db->result($query, 0);
+            $firstauthor = $db->escape($db->result($query, 0));
             $db->free_result($query);
 
             $query = $db->query("SELECT pid, author, dateline FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0,1");
             $lastpost = $db->fetch_array($query);
             $db->free_result($query);
 
-            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]' WHERE tid='$tid'");
+            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|".$db->escape($lastpost['author'])."|$lastpost[pid]' WHERE tid='$tid'");
 
-            if (isset($forums['type']) && $forums['type'] == 'sub') {
-                $query= $db->query("SELECT fup FROM ".X_PREFIX."forums WHERE fid=$fid LIMIT 1");
-                $fup = $db->fetch_array($query);
-                $db->free_result($query);
-                updateforumcount($fid);
-                updateforumcount($fup['fup']);
-            } else {
-                updateforumcount($fid);
+            if ($forums['type'] == 'sub') {
+                updateforumcount($fup['fid']);
             }
+            updateforumcount($fid);
 
             $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
 
-            echo '<center><span class="mediumtxt">'.$lang['complete_threadprune'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['complete_threadprune'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'copy':
-        $mod->statuscheck($fid);
         if (noSubmit('copysubmit')) {
             $tid = $mod->create_tid_string($tid);
             $forumselect = forumList('newfid', false, false);
-            eval('echo stripslashes("'.template('topicadmin_copy').'");');
+            eval('echo "'.template('topicadmin_copy').'";');
         } else {
             if (!formInt('newfid')) {
                 error($lang['privforummsg'], false);
             }
 
-            $mod->statuscheck($newfid);
+            $newfid = getRequestInt('newfid');
+            
+            $query = $db->query("SELECT type, fup FROM ".X_PREFIX."forums WHERE fid=$newfid");
+            if ($db->num_rows($query) != 1) {
+                error($lang['textnoforum'], FALSE);
+            }
+            $otherforum = $db->fetch_array($query);
+            $db->free_result($query);
+
+            if (!$mod->statuscheck($newfid)) {
+                error($lang['notpermitted'], false);
+            }
+
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $thread = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'"));
-                foreach($thread as $key=>$val) {
-                    switch($key) {
-                        case 'tid':
-                            unset($thread[$key]);
-                            break;
-                        case 'fid':
-                            $thread['fid'] = $newfid;
-                            break;
-                        default:
-                            break;
-                    }
-                }
 
+                $thread['fid'] = $newfid;
+                unset($thread['tid']);
+
                 $cols = array();
                 $vals = array();
 
-                reset($thread);
                 foreach($thread as $key=>$val) {
-                    if (trim($key) == '') {
-                        continue;
-                    }
-
-                    if ($key == 'subject') {
-                        //$val = '[COPY] '.$val;
-                        $val = $val;
-                    }
                     $cols[] = $key;
-                    $vals[] = addslashes($val);
+                    $vals[] = $db->escape($val);
                 }
-                reset($thread);
                 $columns = implode(', ', $cols);
                 $values  = "'".implode("', '", $vals)."'";
 
-                $db->query("INSERT INTO ".X_PREFIX."threads ($columns) VALUES ($values)") or die($db->error());
+                $db->query("INSERT INTO ".X_PREFIX."threads ($columns) VALUES ($values)");
 
                 $newtid = $db->insert_id();
-                $cols = array();
-                $vals = array();
 
                 $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid ASC");
                 while($post = $db->fetch_array($query)) {
+                    $oldPid = $post['pid'];
                     $post['fid'] = $newfid;
                     $post['tid'] = $newtid;
-
-                    $oldPid = $post['pid'];
-
                     unset($post['pid']);
-                    reset($post);
 
+                    $cols = array();
+                    $vals = array();
+
                     foreach($post as $key=>$val) {
                         $cols[] = $key;
-                        $vals[] = $val;
+                        $vals[] = $db->escape($val);
                     }
                     $columns = implode(', ', $cols);
                     $values  = "'".implode("', '", $vals)."'";
 
-                    $cols = array();
-                    $vals = array();
-
-                    $db->query("INSERT INTO ".X_PREFIX."posts ($columns) VALUES ($values)") or die($db->error());
+                    $db->query("INSERT INTO ".X_PREFIX."posts ($columns) VALUES ($values)");
                     $newpid = $db->insert_id();
 
                     $db->query("INSERT INTO ".X_PREFIX."attachments (`tid`,`pid`,`filename`,`filetype`,`filesize`,`attachment`,`downloads`) SELECT '$newtid','$newpid',`filename`,`filetype`,`filesize`,`attachment`,`downloads` FROM ".X_PREFIX."attachments WHERE pid='$oldPid'");
                 }
 
                 $mod->log($xmbuser, $action, $fid, $tid);
-            }
-            echo '<center><span class="mediumtxt">'.$lang['copythreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
-        }
-        break;
-
-    case 'report':
-        if ($SETTINGS['reportpost'] == 'off') {
-            eval('echo "'.template('misc_feature_notavailable').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit;
-        }
-
-        if (noSubmit('reportsubmit')) {
-            eval('echo stripslashes("'.template('topicadmin_report').'");');
-        } else {
-            $postcount = $db->result($db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'"), 0);
-            $query = $db->query("SELECT moderator FROM ".X_PREFIX."forums WHERE fid='$fid'");
-            $query2 = $db->query("SELECT username FROM ".X_PREFIX."members WHERE status='Super Administrator' OR status='Administrator' OR status='Super Moderator'");
-            $mods = explode(", ", $db->result($query, 0));
-            while($usr = $db->fetch_array($query2)) {
-                $mods[] = $usr['username'];
-            }
-            $sent = 0;
-            $time = $onlinetime;
-            foreach($mods as $key=>$mod) {
-                $mod = trim($mod);
-                $q = $db->query("SELECT ppp FROM ".X_PREFIX."members WHERE username='$mod'");
-                if ($db->num_rows($q) == 0) {
-                    continue;
+                
+                if ($otherforum['type'] == 'sub') {
+                    updateforumcount($otherforum['fup']);
                 }
-                $page = quickpage($postcount, $db->result($q, 0));
-
-                $posturl = $SETTINGS['boardurl']."viewthread.php?tid=$tid&page=$page#pid$pid";
-                $reason = formVar('reason');
-                $message = $lang['reportmessage'].' '.$posturl."\n\n".$lang['reason'].' '.$reason;
-
-                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$mod', '$self[username]', 'incoming', '$mod', 'Inbox', '$lang[reportsubject]', '$message', ".$db->time($time).", 'no', 'yes')");
-                $sent++;
+                updateforumcount($newfid);
             }
-            echo "<center><span class=\"mediumtxt\">$lang[reportmsg]</span></center>";
-            $page = quickpage($postcount, $self['tpp']);
-            redirect('viewthread.php?tid='.$tid.'&page='.$page.'#pid'.$pid, 2, X_REDIRECT_JS);
-        }
-        break;
 
-    case 'votepoll':
-        // Are we logged in? Only members can vote in polls (otherwise vote stuffing is trivial)
-        if (!X_MEMBER) {
-            error($lang['notloggedin'], false);
+            message($lang['copythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
-
-        // User voted in poll related to thread $tid. The vote option is contained in $postopnum
-        $postopnum = formInt('postopnum');
-        if ($postopnum === 0) {
-            error($lang['pollvotenotselected'], false);
-        }
-
-        // Does a poll exist for this thread?
-        $query = $db->query("SELECT vote_id FROM ".X_PREFIX."vote_desc WHERE topic_id='$tid'");
-        if ($query === false) {
-            error($lang['pollvotenotselected'], false);
-        }
-
-        $vote_id = $db->fetch_array($query);
-        $vote_id = (int) $vote_id['vote_id'];
-        $db->free_result($query);
-
-        // does the poll option exist?
-        $vote_result = $db->result($db->query("SELECT COUNT(vote_option_id) FROM ".X_PREFIX."vote_results WHERE vote_id='$vote_id' AND vote_option_id='$postopnum'"), 0);
-        if ($vote_result != 1) {
-            error($lang['pollvotenotselected'], false);
-        }
-
-        // Has the user voted on this poll before?
-        $voted = $db->result($db->query("SELECT COUNT(vote_id) FROM ".X_PREFIX."vote_voters WHERE vote_id='$vote_id' AND vote_user_id='$self[uid]'"), 0);
-        if ($voted === 1) {
-            error($lang['alreadyvoted'], false);
-        }
-
-        // Okay, the user is about to vote
-        $db->query("INSERT INTO ".X_PREFIX."vote_voters (vote_id, vote_user_id, vote_user_ip) VALUES ('$vote_id', '$self[uid]', '".encode_ip($onlineip)."')");
-        $db->query("UPDATE ".X_PREFIX."vote_results SET vote_result=vote_result+1 WHERE vote_id='$vote_id' AND vote_option_id='$postopnum'");
-
-        if ($tid > 0) {
-            echo '<center><span class="mediumtxt">'.$lang['votemsg'].'</span></center>';
-            redirect('viewthread.php?tid='.$tid, 2, X_REDIRECT_JS);
-        } else {
-            echo '<center><span class="mediumtxt">'.$lang['votemsg'].'</span></center>';
-            redirect('index.php', 2, X_REDIRECT_JS);
-        }
         break;
 }
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: u2u.php
===================================================================
--- u2u.php	(revision 1095)
+++ u2u.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'u2u.php');
+
 require 'header.php';
 require ROOT.'include/u2u.inc.php';
 
@@ -57,8 +59,8 @@
 
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
-$sendmode = (isset($action) && $action == 'send') ? "true" : "false";
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
+$sendmode = ($action == 'send') ? "true" : "false";
 
 eval('$u2uheader = "'.template('u2u_header').'";');
 eval('$u2ufooter = "'.template('u2u_footer').'";');
@@ -68,24 +70,26 @@
     exit;
 }
 
-$folder = formVar('folder');
-if (!$folder) {
-    $folder = getVar('folder');
+$folder = postedVar('folder', '', TRUE, FALSE, TRUE);
+if ($folder == '') {
+    $folder = postedVar('folder', '', TRUE, FALSE, TRUE, 'g');
 }
 
+$tofolder = postedVar('tofolder', '', TRUE, FALSE, TRUE);
+
 $folderlist = '';
 $folders = '';
 $farray = array();
-if ($folder && (!$action || $action == 'mod' || $action == 'view')) {
-    $folder = checkInput($folder, true);
+if ($folder != '' && ($action == '' || $action == 'mod' || $action == 'view')) {
+    //$folder = checkInput($folder, true);
 } else {
     $folder = 'Inbox';
 }
 
-$u2ucount = u2u_folderList();
+$u2ucount = u2u_folderList(); //Sets several global vars
 $u2uid = getInt('u2uid');
 if (!$u2uid) {
-    $u2uid = formVar('u2uid');
+    $u2uid = postedVar('u2uid');
 }
 
 $thewidth = ($self['useoldu2u'] == 'yes') ? $tablewidth : '100%';
@@ -95,7 +99,7 @@
 
 switch($action) {
     case 'modif':
-        $mod = formVar('mod');
+        $mod = postedVar('mod', '', FALSE, FALSE);
         switch($mod) {
             case 'send':
                 if ($u2uid > 0) {
@@ -143,16 +147,14 @@
         }
         break;
     case 'mod':
-        $modaction = formVar('modaction');
+        $modaction = postedVar('modaction', '', FALSE, FALSE);
         $u2u_select = getFormArrayInt('u2u_select');
-        $delete = formVar('delete');
-        $move = formVar('move');
-        $tofolder = formVar('tofolder');
-        $markunread = formVar('markunread');
+        $tofolder = postedVar('tofolder', '', TRUE, FALSE);
+        $folder_url = recodeOut($folder);
         switch($modaction) {
             case 'delete':
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
                 }
                 u2u_mod_delete($folder, $u2u_select);
                 break;
@@ -162,26 +164,26 @@
                 }
 
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
                     return;
                 }
                 u2u_mod_move($tofolder, $u2u_select);
                 break;
             case 'markunread':
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
                 }
                 u2u_mod_markUnread($folder, $u2u_select);
                 break;
             default:
-                error($lang['testnothingchos'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
+                error($lang['testnothingchos'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
                 break;
         }
         break;
     case 'send':
-        $msgto = formVar('msgto');
-        $subject = formVar('subject');
-        $message = formVar('message');
+        $msgto = postedVar('msgto', 'javascript', TRUE, FALSE, TRUE);
+        $subject = postedVar('subject', 'javascript', TRUE, FALSE, TRUE);
+        $message = postedVar('message', '', TRUE, FALSE);
         $leftpane = u2u_send($u2uid, $msgto, $subject, $message, $u2upreview);
         break;
     case 'view':
@@ -192,10 +194,9 @@
         break;
     case 'folders':
         if (onSubmit('folderssubmit')) {
-            $u2ufolders = formVar('u2ufolders');
+            $u2ufolders = postedVar('u2ufolders', 'javascript', TRUE, FALSE, TRUE);
             u2u_folderSubmit($u2ufolders, $folders);
         } else {
-            $self['u2ufolders'] = checkOutput($self['u2ufolders']);
             eval('$leftpane = "'.template('u2u_folders').'";');
         }
         break;
@@ -203,7 +204,7 @@
         $leftpane = u2u_ignore();
         break;
     case 'emptytrash':
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE folder='Trash' AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE folder='Trash' AND owner='$xmbuser'");
         u2u_msg($lang['texttrashemptied'], 'u2u.php');
         break;
     default:
@@ -227,5 +228,5 @@
 }
 eval('$u2uquotabar = "'.template('u2u_quotabar').'";');
 $tu2u = ($self['useoldu2u'] == 'yes') ? 'u2u_old' : 'u2u';
-eval('echo stripslashes("'.template($tu2u).'");');
+eval('echo "'.template($tu2u).'";');
 ?>
\ No newline at end of file
Index: viewthread.php
===================================================================
--- viewthread.php	(revision 1095)
+++ viewthread.php	(working copy)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.10 Karl
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'viewthread.php');
+
 require 'header.php';
 
 validatePpp();
@@ -34,8 +36,8 @@
 $tid = getInt('tid');
 $fid = getInt('fid');
 $page = getInt('page');
-$goto = getVar('goto');
-$action = getVar('action');
+$goto = postedVar('goto', '', FALSE, FALSE, FALSE, 'g');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($goto == 'lastpost') {
     if ($pid > 0) {
@@ -48,6 +50,7 @@
         $db->free_result($query);
 
         if ($posts == 0) {
+            header('HTTP/1.1 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
@@ -57,6 +60,7 @@
         $db->free_result($query);
 
         if ($posts == 0) {
+            header('HTTP/1.1 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
@@ -84,9 +88,24 @@
         $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
         $posts = $db->result($query, 0);
         $db->free_result($query);
+    } else {
+        header('HTTP/1.1 404 Not Found');
+        eval('$css = "'.template('css').'";');
+        error($lang['textnothread']);
     }
     $page = quickpage($posts, $ppp);
     redirect("viewthread.php?tid=$tid&page=$page#pid$pid", 0);
+
+} else if ($goto == 'search') {
+    $tidtest = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = $tid AND pid = $pid"), 0);
+    if ($tidtest == 0) {
+        header('HTTP/1.1 404 Not Found');
+        eval('$css = "'.template('css').'";');
+        error($lang['textnothread']);
+    }
+    $pbefore = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = $tid AND pid < $pid"), 0);
+    $page = quickpage(($pbefore+1), $ppp);
+    redirect("viewthread.php?tid=$tid&page=$page#pid$pid", 0);
 }
 
 loadtemplates(
@@ -134,9 +153,10 @@
 $notexist = false;
 $notexist_txt = $posts = '';
 
-$query = $db->query("SELECT fid, subject, replies, closed, topped, lastpost FROM ".X_PREFIX."threads WHERE tid='$tid'");
-if ($tid == 0 || $db->num_rows($query) != 1) {
+$query = $db->query("SELECT fid, subject, replies, closed, topped, lastpost FROM ".X_PREFIX."threads WHERE tid=$tid");
+if ($db->num_rows($query) != 1) {
     $db->free_result($query);
+    header('HTTP/1.1 404 Not Found');
     error($lang['textnothread']);
 }
 
@@ -150,8 +170,7 @@
     }
 }
 
-$thread['subject'] = shortenString($thread['subject'], 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
-$thread['subject'] = checkOutput($thread['subject'], 'no', '', true);
+$thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
 
 $thislast = explode('|', $thread['lastpost']);
 $lastPid = isset($thislast[2]) ? $thislast[2] : 0;
@@ -163,40 +182,52 @@
     put_cookie('oldtopics', $oldtopics, $expire, $cookiepath, $cookiedomain, null, X_SET_HEADER);
 }
 
-$thread['subject'] = censor($thread['subject']);
-$fid = (int) $thread['fid'];
+$fid = $thread['fid'];
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
+$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
 $forum = $db->fetch_array($query);
+$db->free_result($query);
 
-if ((!isset($forum['type']) && $forum['type'] != 'forum' && $forum['type'] != 'sub') || $db->num_rows($query) != 1) {
-    $db->free_result($query);
+if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
     error($lang['textnoforum']);
 }
-$db->free_result($query);
 
-$authorization = true;
-if (isset($forum['type']) && $forum['type'] == 'sub') {
-    $query = $db->query("SELECT name, fid, private, userlist FROM ".X_PREFIX."forums WHERE fid='$forum[fup]'");
+$perms = checkForumPermissions($forum);
+if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+    error($lang['privforummsg']);
+} else if (!$perms[X_PERMS_PASSWORD]) {
+    handlePasswordDialog($fid);
+}
+
+$fup = array();
+if ($forum['type'] == 'sub') {
+    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
     $fup = $db->fetch_array($query);
     $db->free_result($query);
-    $authorization = privfcheck($fup['private'], $fup['userlist']);
-}
 
-if (!$authorization || !privfcheck($forum['private'], $forum['userlist'])) {
-    $threadSubject = '';
-    error($lang['privforummsg']);
+    // prevent access to subforum when upper forum can't be viewed.
+    $fupPerms = checkForumPermissions($fup);
+    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+        error($lang['privforummsg']);
+    } else if (!$fupPerms[X_PERMS_PASSWORD]) {
+        handlePasswordDialog($fup['fid']);
+    } else if ($fup['fup'] > 0) {
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+    }
+    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
+} else if ($forum['fup'] > 0) { // 'forum' in a 'group'
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+    nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
 }
+nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forum['name']).'</a>');
+nav($thread['subject']);
 
-if (isset($forum['type']) && $forum['type'] == 'forum') {
-    nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode(stripslashes($forum['name'])).'</a>');
-    nav(checkOutput(stripslashes($thread['subject']), 'no', '', true));
-} else {
-    if (isset($forum['type']) && $forum['type'] == 'sub') {
-        nav('<a href="forumdisplay.php?fid='.intval($fup['fid']).'">'.html_entity_decode(stripslashes($fup['name'])).'</a>');
-        nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode(stripslashes($forum['name'])).'</a>');
-        nav(checkOutput(stripslashes($thread['subject']), 'no', '', true));
-    }
+if ($SETTINGS['subject_in_title'] == 'on') {
+    $threadSubject = '- '.$thread['subject'];
 }
 
 $allowimgcode = ($forum['allowimgcode'] == 'yes') ? $lang['texton']:$lang['textoff'];
@@ -243,20 +274,15 @@
 $usesig = false;
 $replylink = $quickreply = '';
 
-$status1 = modcheck($self['status'], $xmbuser, $forum['moderator']);
+$status1 = modcheck($self['username'], $forum['moderator']);
 
-if (!$action) {
+if ($action == '') {
     if (X_MEMBER && $self['sig'] != '') {
         $usesig = true;
     }
 
     eval('echo "'.template('header').'";');
 
-    pwverify($forum['password'], 'viewthread.php?tid='.$tid, $fid);
-
-    $ppthread = postperm($forum, 'thread');
-    $ppreply  = postperm($forum, 'reply');
-
     $usesigcheck = $usesig ? 'checked="checked"' : '';
 
     $captchapostcheck = '';
@@ -279,34 +305,29 @@
         }
         $closeopen = $lang['textopenthread'];
     } else {
-        if (X_MEMBER || X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] == 'on') {
-            $closeopen = $lang['textclosethread'];
+        $closeopen = $lang['textclosethread'];
+        if ($perms[X_PERMS_REPLY]) {
             eval('$replylink = "'.template('viewthread_reply').'";');
             $quickreply = '';
             if ($SETTINGS['quickreply_status'] == 'on') {
                 eval('$quickreply = "'.template('viewthread_quickreply').'";');
             }
+        } else {
+            $replylink = '';
+            $quickreply = '';
         }
     }
 
-    if (!$ppthread) {
-        $newtopiclink = $newpolllink = '';
-        if (!$ppreply || (X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] != 'on')) {
-            $replylink = $quickreply = '';
-        }
+    if ($perms[X_PERMS_THREAD]) {
+        eval('$newtopiclink = "'.template('viewthread_newtopic').'";');
     } else {
-        if (X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] != 'on') {
-            $newtopiclink = $newpolllink = '';
-        } else {
-            eval('$newtopiclink = "'.template('viewthread_newtopic').'";');
-            if (isset($forum['pollstatus']) && $forum['pollstatus'] != 'off') {
-                eval('$newpolllink = "'.template('viewthread_newpoll').'";');
-            }
-        }
+        $newtopiclink = '';
+    }
 
-        if (!$ppreply || (X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] != 'on')) {
-            $replylink = $quickreply = '';
-        }
+    if ($perms[X_PERMS_POLL]) {
+        eval('$newpolllink = "'.template('viewthread_newpoll').'";');
+    } else {
+        $newpolllink = '';
     }
 
     $topuntop = ($thread['topped'] == 1) ? $lang['textuntopthread'] : $lang['texttopthread'];
@@ -357,7 +378,7 @@
     }
     $db->free_result($query);
 
-    if ($vote_id > 0 && isset($forum['pollstatus']) && $forum['pollstatus'] != 'off') {
+    if ($vote_id > 0 && $perms[X_PERMS_POLL]) {
         if (X_MEMBER) {
             $query = $db->query("SELECT COUNT(vote_id) AS cVotes FROM ".X_PREFIX."vote_voters WHERE vote_id='$vote_id' AND vote_user_id=".intval($self['uid']));
             if ($query) {
@@ -460,7 +481,7 @@
                 eval('$site = "'.template('viewthread_post_site').'";');
             }
 
-            $encodename = rawurlencode($post['author']);
+            $encodename = recodeOut($post['author']);
 
             $icq = '';
             if ($post['icq'] != '' && $post['icq'] > 0) {
@@ -469,16 +490,19 @@
 
             $aim = '';
             if ($post['aim'] != '') {
+                $post['aim'] = recodeOut($post['aim']);
                 eval('$aim = "'.template('viewthread_post_aim').'";');
             }
 
             $msn = '';
             if ($post['msn'] != '') {
+                $post['msn'] = recodeOut($post['msn']);
                 eval('$msn = "'.template('viewthread_post_msn').'";');
             }
 
             $yahoo = '';
             if ($post['yahoo'] != '') {
+                $post['yahoo'] = recodeOut($post['yahoo']);
                 eval('$yahoo = "'.template('viewthread_post_yahoo').'";');
             }
 
@@ -531,17 +555,11 @@
             $avatar = '';
             if ($SETTINGS['avastatus'] == 'on' || $SETTINGS['avastatus'] == 'list') {
                 if ($post['avatar'] != '' && $allowavatars != "no") {
-                    if (false !== ($pos = strpos($post['avatar'], ',')) && substr($post['avatar'], $pos-4, 4) == '.swf') {
-                        $flashavatar = explode(',',$post['avatar']);
-                        $avatar = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-                    } else {
-                        $avatar = '<img src="'.$post['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                    }
+                    $avatar = '<img src="'.$post['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
                 }
             }
 
             if ($post['mood'] != '') {
-                $post['mood'] = censor($post['mood']);
                 $mood = '<strong>'.$lang['mood'].'</strong> '.postify($post['mood'], 'no', 'no', 'yes', 'no', 'yes', 'no', true, 'yes');
             } else {
                 $mood = '';
@@ -572,6 +590,7 @@
             $u2u = '';
             $location = '';
             $mood = '';
+            $encodename = '';
         }
 
         $ip = '';
@@ -580,10 +599,8 @@
         }
 
         $repquote = '';
-        if (X_ADMIN || $status1 == 'Moderator' || ($thread['closed'] != 'yes')) {
-            if (X_MEMBER || (X_GUEST && isset($forum['guestposting']) && $forum['guestposting'] == 'on')) {
-                eval('$repquote = "'.template('viewthread_post_repquote').'";');
-            }
+        if ($perms[X_PERMS_REPLY] && $thread['closed'] != 'yes') {
+            eval("\$repquote = \"".template('viewthread_post_repquote')."\";");
         }
 
         $reportlink = '';
@@ -592,20 +609,21 @@
         }
 
         if ($post['subject'] != '') {
-            $post['subject'] = censor($post['subject']).'<br />';
-            $post['subject'] = checkOutput($post['subject'], 'no', '', true);
+            $post['subject'] = rawHTMLsubject(stripslashes($post['subject'])).'<br />';
         }
 
         $edit = '';
-        if (X_ADMIN || $status1 == 'Moderator' || ($thread['closed'] != 'yes' && $post['author'] == $xmbuser)) {
+        if (modcheckPost($self['username'], $forum['moderator'], $post['status']) == 'Moderator' || ($thread['closed'] != 'yes' && $post['author'] == $xmbuser)) {
             eval('$edit = "'.template('viewthread_post_edit').'";');
         }
 
         $bbcodeoff = $post['bbcodeoff'];
         $smileyoff = $post['smileyoff'];
-        $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+        $post['message'] = postify(stripslashes($post['message']), $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
 
         if ($post['filename'] != '' && $forum['attachstatus'] != 'off') {
+            $post['filename'] = attrOut($post['filename']);
+            $post['filetype'] = attrOut($post['filetype']);
             $attachsize = $post['filesize'];
             if ($attachsize >= 1073741824) {
                 $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
@@ -658,12 +676,11 @@
     if ('Moderator' == $status1) {
         eval('$modoptions = "'.template('viewthread_modoptions').'";');
     }
-    eval('echo stripslashes("'.template('viewthread').'");');
+    eval('echo "'.template('viewthread').'";');
     end_time();
     eval('echo "'.template('footer').'";');
     exit();
 } else if ($action == 'attachment' && $forum['attachstatus'] != 'off' && $pid > 0 && $tid > 0) {
-    pwverify($forum['password'], 'viewthread.php?tid='.$tid, $fid, true);
     $query = $db->query("SELECT * FROM ".X_PREFIX."attachments WHERE pid='$pid' and tid='$tid'");
     $file = $db->fetch_array($query);
     $db->free_result($query);
@@ -675,13 +692,12 @@
     }
 
     $type = strtolower($file['filetype']);
-    $name = str_replace(' ', '_', $file['filename']);
     $size = (int) $file['filesize'];
     $type = ($type == 'text/html') ? 'text/plain' : $type;
 
     header("Content-type: $type");
     header("Content-length: $size");
-    header("Content-Disposition: attachment; filename=$name");
+    header("Content-Disposition: attachment; filename=\"{$file['filename']}\"");
     header("Content-Description: XMB Attachment");
     header("Cache-Control: public; max-age=604800");
     header("Expires: 604800");
@@ -689,7 +705,6 @@
     echo $file['attachment'];
     exit();
 } else if ($action == 'printable') {
-    pwverify($forum['password'], 'viewthread.php?tid='.$tid, $fid, true);
     $querypost = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE fid='$fid' AND tid='$tid' ORDER BY pid");
     $posts = '';
     $tmoffset = ($timeoffset * 3600) + ($addtime * 3600);
@@ -697,10 +712,9 @@
         $date = gmdate($dateformat, $post['dateline'] + $tmoffset);
         $time = gmdate($timecode, $post['dateline'] + $tmoffset);
         $poston = "$date $lang[textat] $time";
-        $post['message'] = stripslashes($post['message']);
         $bbcodeoff = $post['bbcodeoff'];
         $smileyoff = $post['smileyoff'];
-        $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+        $post['message'] = postify(stripslashes($post['message']), $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
         eval('$posts .= "'.template('viewthread_printable_row').'";');
     }
     $db->free_result($querypost);
Index: vtmisc.php
===================================================================
--- vtmisc.php	(revision 0)
+++ vtmisc.php	(revision 0)
@@ -0,0 +1,205 @@
+<?php
+/**
+ * eXtreme Message Board
+ * XMB 1.9.10 Karl
+ *
+ * Developed And Maintained By The XMB Group
+ * Copyright (c) 2001-2008, The XMB Group
+ * http://www.xmbforum.com
+ *
+ * Sponsored By iEntry, Inc.
+ * Copyright (c) 2007, iEntry, Inc.
+ * http://www.ientry.com
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ *
+ **/
+
+define('X_SCRIPT', 'vtmisc.php');
+
+require 'header.php';
+
+eval('$css = "'.template('css').'";');
+
+if (!X_MEMBER) {
+    error($lang['notpermitted']);
+}
+
+loadtemplates(
+'vtmisc_report',
+'misc_feature_notavailable'
+);
+
+//Validate $action, $pid, $tid, and $fid
+$fid = -1;
+$tid = -1;
+$pid = -1;
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g'); //Forms did not include the action
+if ($action == 'report') {
+    $pid = getRequestInt('pid');
+    $query = $db->query("SELECT f.*, t.tid, t.subject FROM ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) LEFT JOIN ".X_PREFIX."forums AS f ON f.fid=t.fid WHERE p.pid=$pid");
+    if ($db->num_rows($query) != 1) {
+        error($lang['textnothread']);
+    }
+    $forum = $db->fetch_array($query);
+    $db->free_result($query);
+    $fid = $forum['fid'];
+    $tid = $forum['tid'];
+} else if ($action == 'votepoll') {
+    $tid = getRequestInt('tid');
+    $query = $db->query("SELECT f.*, t.subject FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."forums AS f USING (fid) WHERE t.tid=$tid");
+    if ($db->num_rows($query) != 1) {
+        error($lang['textnothread']);
+    }
+    $forum = $db->fetch_array($query);
+    $db->free_result($query);
+    $fid = $forum['fid'];
+} else {
+    error($lang['textnoaction']);
+}
+
+if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    error($lang['textnoforum']);
+}
+
+// check permissions on this forum
+$perms = checkForumPermissions($forum);
+if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+    error($lang['privforummsg']);
+} else if (!$perms[X_PERMS_PASSWORD]) {
+    handlePasswordDialog($fid);
+}
+
+$fup = array();
+if ($forum['type'] == 'sub') {
+    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+
+    // prevent access to subforum when upper forum can't be viewed.
+    $fupPerms = checkForumPermissions($fup);
+    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+        error($lang['privforummsg']);
+    } else if (!$fupPerms[X_PERMS_PASSWORD]) {
+        handlePasswordDialog($fup['fid']);
+    } else if ($fup['fup'] > 0) {
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+    }
+    nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
+} else if ($forum['fup'] > 0) { // 'forum' in a 'group'
+    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
+    $fup = $db->fetch_array($query);
+    $db->free_result($query);
+    nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
+    unset($fup);
+}
+nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forum['name']).'</a>');
+if ($tid > 0) {
+    $subject = shortenString(rawHTMLsubject(stripslashes($forum['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
+    nav('<a href="viewthread.php?tid='.$tid.'">'.$subject.'</a>');
+    unset($subject);
+}
+
+if ($SETTINGS['subject_in_title'] == 'on') {
+    $threadSubject = '- '.rawHTMLsubject(stripslashes($forum['subject']));
+}
+
+if ($action == 'report') {
+    nav($lang['textreportpost']);
+    eval('echo "'.template('header').'";');
+
+    if ($SETTINGS['reportpost'] == 'off') {
+        eval('echo "'.template('misc_feature_notavailable').'";');
+        end_time();
+        eval('echo "'.template('footer').'";');
+        exit;
+    }
+
+    if (noSubmit('reportsubmit')) {
+        eval('echo "'.template('vtmisc_report').'";');
+    } else {
+        $query = $db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid=$tid");
+        $postcount = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+        $db->free_result($query);
+
+        $modquery = $db->query("SELECT username, ppp FROM ".X_PREFIX."members WHERE status='Super Administrator' OR status='Administrator' OR status='Super Moderator'");
+        while($modusr = $db->fetch_array($modquery)) {
+            $mod = $db->escape($modusr['username']);
+            $page = quickpage($postcount, $modusr['ppp']);
+
+            $posturl = $SETTINGS['boardurl']."viewthread.php?tid=$tid&page=$page#pid$pid";
+            $reason = postedVar('reason', '', TRUE, FALSE);
+            $message = $lang['reportmessage'].' '.$posturl."\n\n".$lang['reason'].' '.$reason;
+            $message = $db->escape(addslashes($message)); //Messages are historically double-slashed.
+            $subject = $db->escape(addslashes($lang['reportsubject']));
+            $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$mod', '$xmbuser', 'incoming', '$mod', 'Inbox', '$subject', '$message', ".$db->time($onlinetime).", 'no', 'yes')");
+        }
+        $db->free_result($modquery);
+
+        $page = quickpage($postcount, $tpp);
+        message($lang['reportmsg'], false, '', '', 'viewthread.php?tid='.$tid.'&page='.$page.'#pid'.$pid, true, false, true);
+    }
+
+} else if ($action == 'votepoll') {
+    nav($lang['textvote']);
+    eval('echo "'.template('header').'";');
+
+    // User voted in poll related to thread $tid. The vote option is contained in $postopnum
+    $postopnum = formInt('postopnum');
+    if ($postopnum === 0) {
+        error($lang['pollvotenotselected'], false);
+    }
+
+    // Does a poll exist for this thread?
+    $tid = intval($tid);
+    $query = $db->query("SELECT vote_id FROM ".X_PREFIX."vote_desc WHERE topic_id=$tid");
+    if ($query === false) {
+        error($lang['pollvotenotselected'], false);
+    }
+
+    $vote_id = $db->fetch_array($query);
+    $vote_id = $vote_id['vote_id'];
+    $db->free_result($query);
+
+    // does the poll option exist?
+    $query = $db->query("SELECT COUNT(vote_option_id) FROM ".X_PREFIX."vote_results WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
+    $vote_result = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+    $db->free_result($query);
+    if ($vote_result != 1) {
+        error($lang['pollvotenotselected'], false);
+    }
+
+    // Has the user voted on this poll before?
+    $query = $db->query("SELECT COUNT(vote_id) FROM ".X_PREFIX."vote_voters WHERE vote_id=$vote_id AND vote_user_id={$self['uid']}");
+    $voted = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+    $db->free_result($query);
+    if ($voted === 1) {
+        error($lang['alreadyvoted'], false);
+    }
+
+    // Okay, the user is about to vote
+    $db->query("INSERT INTO ".X_PREFIX."vote_voters (vote_id, vote_user_id, vote_user_ip) VALUES ($vote_id, {$self['uid']}, '".encode_ip($onlineip)."')");
+    $db->query("UPDATE ".X_PREFIX."vote_results SET vote_result=vote_result+1 WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
+
+    if ($tid > 0) {
+        message($lang['votemsg'], false, '', '', 'viewthread.php?tid='.$tid, true, false, true);
+    } else {
+        message($lang['votemsg'], false, '', '', 'index.php', true, false, true);
+    }
+}
+
+end_time();
+eval('echo "'.template('footer').'";');
+?>
\ No newline at end of file
