Index: buddy.php
===================================================================
--- buddy.php	(revision 1746)
+++ buddy.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -31,6 +30,8 @@
 require 'header.php';
 require ROOT.'include/buddy.inc.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates(
 'buddy_u2u_inv',
 'buddy_u2u_off',
@@ -47,7 +48,8 @@
 eval('$css = "'.template('css').'";');
 
 if (X_GUEST) {
-    error($lang['u2unotloggedin']);
+    redirect("{$full_url}misc.php?action=login", 0);
+    exit;
 }
 
 $action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
@@ -77,4 +79,4 @@
         buddy_display();
         break;
 }
-?>
\ No newline at end of file
+?>
Index: config.php
===================================================================
--- config.php	(revision 1746)
+++ config.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,30 +26,31 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
 // Database connection settings
-    $dbname         = 'DB_NAME'; // Name of your database
-    $dbuser         = 'DB_USER'; // Username used to access it
-    $dbpw           = 'DB_PW';   // Password used to access it
-    $dbhost         = 'DB_HOST'; // Database host, usually 'localhost'
-    $database       = 'DB_TYPE'; // Database type, currently only mysql is supported.
-    $pconnect       = 0;         // Persistent connection, 1 = on, 0 = off, use if 'too many connections'-errors appear
+    $dbname         = 'DB/NAME';   // Name of your database
+    $dbuser         = 'DB/USER';   // Username used to access it
+    $dbpw           = 'DB/PW';     // Password used to access it
+    $dbhost         = 'localhost'; // Database host, usually 'localhost'
+    $database       = 'mysql';     // Database type, currently only mysql is supported.
+    $pconnect       = 0;           // Persistent connection, 1 = on, 0 = off, use if 'too many connections'-errors appear
 
 // Table Settings
-    $tablepre       = 'TABLEPRE'; // Table-pre
+    $tablepre       = 'TABLE/PRE'; // XMB will prefix each table name with the string you specify here.  'xmb_' is a common choice.
 
-// Path-settings
-    // In full_path, put the full URL you see when you go to your boards, WITHOUT the filename though!!
-    // And please, don't forget the / at the end...
+// Address settings
+    // In full_url, put the full URL you see when you go to your boards, WITHOUT the filename though!!
+    // And please, remember to add the / at the end...
     $full_url       = 'FULLURL';
 
 // Other settings
     // There are situations where you don't want to see the <!-- template start: index -->...<!-- template end: index -->
     // tags around each template. In those cases, change the following to false, or true to turn it back on.
     // Default value: false;
-    $comment_output = COMMENTOUTPUT;
+    $comment_output = FALSE;
 
     // Alternative mailer
     // some hosts prevent the direct use of sendmail, which php uses to send out emails by default.
@@ -60,7 +60,7 @@
     //                     (does not require a username/password/host/port)
     // 'socket_SMTP'    => a connection to the SMTP server trough sockets. Requires the username,
     //                     password, host and port values to be entered correctly to work.
-    $mailer['type']     = 'MAILER_TYPE';
+    $mailer['type']     = 'default';
 
     // mailer-options (for socket_SMTP only, currently)
     $mailer['username'] = 'MAILER_USER';
@@ -97,29 +97,26 @@
      * this might shut a few users out, so you can turn it off by changing the $ipcheck variable to 'off'
      ****************
      * The allow_spec_q variable specifies if Special queries (eg. USE database and SHOW DATABASES) are allowed.
-     * By default, they are not, meaning $allow_spec_q = false;
+     * By default, they are not, meaning $allow_spec_q = FALSE;
      * To allow them, change $allow_spec_q to true ($allow_spec_q = true;)
      ****************
      * The show_full_info variable lets you decide wether to show the Build and Alpha/Beta/SP markings in the HTML or not.
      * Change the value to true to show them, or false to turn them off.
-     * Default = true;
+     * Default = TRUE;
      ****************/
 
-    $ipcheck        = 'IPCHECK';
-    $allow_spec_q   = SPECQ;
-    $show_full_info = SHOWFULLINFO;
+    $ipcheck        = 'off';
+    $allow_spec_q   = FALSE;
+    $show_full_info = TRUE;
 
-// Resolving serveral modes (currently, 2)
 // Debug-mode
     /*
     / To turn on DEBUG mode (you can then see ALL queries done at the bottom of each screen (except buddy-list & u2u)
     / just uncomment this variable. These queries are ONLY visible to the user currently loading that page
     / and ONLY visible to Super Administrators
-    /
-    / SECURITY NOTICE: DO NOT COMMENT OUT UNLESS YOU KNOW WHAT YOU'RE DOING!
     */
-    define('DEBUG', false);
-    // define('DEBUG', true);
+    define('DEBUG', FALSE);
+    // define('DEBUG', TRUE);
     //
     /*
     / Comment first line and uncomment second line to use debug mode (1.9+ only). Only one define can be
@@ -127,10 +124,11 @@
     */
     //
     /*
-    / To allow everyone to see debug errors (in the case of registration errors or the like), comment first
-    / line and uncomment second line.  DEBUG queries will not be shown.
-    / ****  DEBUG MUST BE SET TO TRUE  ****
+    / To enable logging of all MySQL errors (necessary in the case of registration, login, or captcha errors), comment first
+    / line and uncomment second line.  Note the log file will be visible to the public unless it is protected
+    / by your web server configuration.  The file name will be 'error_log' unless you change the PHP configuration.
+    / If the chmod settings of this directory prevent file Write then the log will not be created.
     */
-    define('DEBUG_ALL', false);
-    // define('DEBUG_ALL', true);
-?>
\ No newline at end of file
+    define('LOG_MYSQL_ERRORS', FALSE);
+    // define('LOG_MYSQL_ERRORS', TRUE);
+?>
Index: cp.php
===================================================================
--- cp.php	(revision 1746)
+++ cp.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -31,6 +30,8 @@
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates('error_nologinsession');
 
 nav($lang['textcp']);
@@ -59,7 +60,13 @@
 $action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($action == "settings") {
-    if (noSubmit('settingsubmit')) {
+    if (noSubmit('settingsubmit1')
+    And noSubmit('settingsubmit2')
+    And noSubmit('settingsubmit3')
+    And noSubmit('settingsubmit4')
+    And noSubmit('settingsubmit5')
+    And noSubmit('settingsubmit6')
+    And noSubmit('settingsubmit7')) {
         $langfileselect = createLangFileSelect($SETTINGS['langfile']);
 
         $themelist = array();
@@ -175,6 +182,9 @@
         $captchapostOn = $captchapostOff = '';
         settingHTML('captcha_post_status', $captchapostOn, $captchapostOff);
 
+        $captchasearchOn = $captchasearchOff = '';
+        settingHTML('captcha_search_status', $captchasearchOn, $captchasearchOff);
+
         $captchacodecaseOn = $captchacodecaseOff = '';
         settingHTML('captcha_code_casesensitive', $captchacodecaseOn, $captchacodecaseOff);
 
@@ -202,14 +212,8 @@
         $onlinetoday_statuson = $onlinetoday_statusoff = '';
         settingHTML('onlinetoday_status', $onlinetoday_statuson, $onlinetoday_statusoff);
 
-        $avataron = $avataroff = $avatarlist = '';
-        if ($SETTINGS['avastatus'] == 'on') {
-            $avataron = $selHTML;
-        } else if ($avastatus == 'list') {
-            $avatarlist = $selHTML;
-        } else {
-            $avataroff = $selHTML;
-        }
+        $remoteimageson = $remoteimagesoff = '';
+        settingHTML('attach_remote_images', $remoteimageson, $remoteimagesoff);
 
         $check12 = $check24 = '';
         if ($SETTINGS['timeformat'] == 24) {
@@ -279,9 +283,9 @@
         }
 
         $avchecked[0] = $avchecked[1] = $avchecked[2] = false;
-        if (!empty($avatarlist)) {
+        if ($SETTINGS['avastatus'] == 'list') {
             $avchecked[1] = true;
-        } else if (!empty($avataroff)) {
+        } else if ($SETTINGS['avastatus'] == 'off') {
             $avchecked[2] = true;
         } else {
             $avchecked[0] = true;
@@ -405,33 +409,42 @@
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
+        <span class="smalltxt">
+        <a href="#1"><?php echo $lang['admin_main_settings1']; ?></a><br />
+        <a href="#2"><?php echo $lang['admin_main_settings2']; ?></a><br />
+        <a href="#3"><?php echo $lang['admin_main_settings3']; ?></a><br />
+        <a href="#4"><?php echo $lang['admin_main_settings4']; ?></a><br />
+        <a href="#5"><?php echo $lang['admin_main_settings5']; ?></a><br />
+        <a href="#8"><?php echo $lang['admin_main_settings8']; ?></a><br />
+        <a href="#6"><?php echo $lang['admin_main_settings6']; ?></a><br />
+        <a href="#7"><?php echo $lang['admin_main_settings7']; ?></a><br />
+        </span>
         <form method="post" action="cp.php?action=settings">
         <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
         <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings1']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="1" />&raquo;&nbsp;<?php echo $lang['admin_main_settings1']?></font></strong></td>
         </tr>
         <?php
         printsetting2($lang['textsitename'], 'sitenamenew', $SETTINGS['sitename'], 50);
         printsetting2($lang['bbname'], 'bbnamenew', $SETTINGS['bbname'], 50);
         printsetting2($lang['textsiteurl'], 'siteurlnew', $SETTINGS['siteurl'], 50);
-        printsetting2($lang['textboardurl'], 'boardurlnew', $SETTINGS['boardurl'], 50);
         printsetting2($lang['adminemail'], 'adminemailnew', $SETTINGS['adminemail'], 50);
         printsetting1($lang['textbbrules'], 'bbrulesnew', $ruleson, $rulesoff);
         ?>
         <?php
-        printsetting4($lang['textbbrulestxt'], 'bbrulestxtnew', $SETTINGS['bbrulestxt'], 5, 50);
+        printsetting4($lang['textbbrulestxt'], 'bbrulestxtnew', cdataOut($SETTINGS['bbrulestxt']), 5, 50);
         printsetting1($lang['textbstatus'], 'bbstatusnew', $onselect, $offselect);
         printsetting4($lang['textbboffreason'], 'bboffreasonnew', $SETTINGS['bboffreason'], 5, 50);
         printsetting1($lang['gzipcompression'], 'gzipcompressnew', $gzipcompresson, $gzipcompressoff);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit1" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings2']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="2" />&raquo;&nbsp;<?php echo $lang['admin_main_settings2']?></font></strong></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textlanguage']?></td>
@@ -453,11 +466,11 @@
         <?php
         printsetting2($lang['dateformat'], 'dateformatnew', $SETTINGS['dateformat'], 20);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit2" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings3']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="3" />&raquo;&nbsp;<?php echo $lang['admin_main_settings3']?></font></strong></td>
         </tr>
         <?php
         printsetting1($lang['textsearchstatus'], 'searchstatusnew', $searchon, $searchoff);
@@ -469,11 +482,11 @@
         printsetting1($lang['coppastatus'], 'coppanew', $coppaon, $coppaoff);
         printsetting1($lang['reportpoststatus'], 'reportpostnew', $reportposton, $reportpostoff);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit3" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings4']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="4" />&raquo;&nbsp;<?php echo $lang['admin_main_settings4']?></font></strong></td>
         </tr>
         <?php
         printsetting1($lang['showsubforums'], 'showsubforumsnew', $showsubson, $showsubsoff);
@@ -492,13 +505,12 @@
         printsetting2($lang['smcols'], 'smcolsnew', ((int)$SETTINGS['smcols']), 5);
         printsetting1($lang['dotfolders'], 'dotfoldersnew', $dotfolderson, $dotfoldersoff);
         printsetting1($lang['editedby'], 'editedbynew', $editedbyon, $editedbyoff);
-        printsetting1($lang['attachimginpost'], 'attachimgpostnew', $attachimgposton, $attachimgpostoff);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit3" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings5']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="5" />&raquo;&nbsp;<?php echo $lang['admin_main_settings5']?></font></strong></td>
         </tr>
         <?php
         printsetting1($lang['reg_on'], 'reg_on', $regon, $regoff);
@@ -516,55 +528,96 @@
         printsetting1($lang['doublee'], 'doubleenew', $doubleeon, $doubleeoff);
         printsetting2($lang['pruneusers'], 'pruneusersnew', ((int)$SETTINGS['pruneusers']), 3);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit4" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings6']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="8" />&raquo;&nbsp;<?php echo $lang['admin_main_settings8']?></font></strong></td>
         </tr>
         <?php
+        $max_image_sizes = explode('x', $SETTINGS['max_image_size']);
+        $max_thumb_sizes = explode('x', $SETTINGS['max_thumb_size']);
+        for($i=0; $i<=4; $i++) {
+            $urlformatchecked[$i] = ($SETTINGS['file_url_format'] == $i + 1);
+        }
+        for($i=0; $i<=1; $i++) {
+            $subdirchecked[$i] = ($SETTINGS['files_subdir_format'] == $i + 1);
+        }
+        printsetting2($lang['textfilesperpost'], 'filesperpostnew', ((int)$SETTINGS['filesperpost']), 3);
+        printsetting2($lang['max_attachment_size'], 'maxAttachSize', ((int)$SETTINGS['maxattachsize']), 12);
+        printsetting2($lang['textfilessizew'], 'max_image_size_w_new', $max_image_sizes[0], 5);
+        printsetting2($lang['textfilessizeh'], 'max_image_size_h_new', $max_image_sizes[1], 5);
+        printsetting2($lang['textfilesthumbw'], 'max_thumb_size_w_new', $max_thumb_sizes[0], 5);
+        printsetting2($lang['textfilesthumbh'], 'max_thumb_size_h_new', $max_thumb_sizes[1], 5);
+        if (!ini_get('allow_url_fopen')) {
+            printsetting5($lang['attachimginpost'], $lang['no_url_fopen']);
+        } else {
+            printsetting1($lang['attachimginpost'], 'attachimgpostnew', $attachimgposton, $attachimgpostoff);
+        }
+        printsetting1($lang['textremoteimages'], 'remoteimages', $remoteimageson, $remoteimagesoff);
+        printsetting2($lang['textfilespath'], 'filespathnew', $SETTINGS['files_storage_path'], 50);
+        printsetting2($lang['textfilesminsize'], 'filesminsizenew', ((int)$SETTINGS['files_min_disk_size']), 7);
+        printsetting3($lang['textfilessubdir'], 'filessubdirnew', array($lang['textfilessubdir1'], $lang['textfilessubdir2']), array('1', '2'), $subdirchecked, false);
+        printsetting3($lang['textfilesurlpath'], 'filesurlpathnew', array($lang['textfilesurlpath1'], $lang['textfilesurlpath2'], $lang['textfilesurlpath3'], $lang['textfilesurlpath4'], $lang['textfilesurlpath5']), array('1', '2', '3', '4', '5'), $urlformatchecked, false);
+        printsetting2($lang['textfilesbase'], 'filesbasenew', $SETTINGS['files_virtual_url'], 50);
+        ?>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit5" value="<?php echo $lang['textsubmitchanges']?>" /></td>
+        </tr>
+        <tr class="category">
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="6" />&raquo;&nbsp;<?php echo $lang['admin_main_settings6']?></font></strong></td>
+        </tr>
+        <?php
         printsetting2($lang['texthottopic'], 'hottopicnew', ((int)$SETTINGS['hottopic']), 3);
         printsetting1($lang['bbinsert'], 'bbinsertnew', $bbinserton, $bbinsertoff);
         printsetting1($lang['smileyinsert'], 'smileyinsertnew', $smileyinserton, $smileyinsertoff);
         printsetting3($lang['footer_options'], 'new_footer_options', $names, $values, $checked);
-        printsetting2($lang['max_attachment_size'], 'maxAttachSize', ((int)$SETTINGS['maxattachsize']), 8);
         printsetting3($lang['defaultTimezoneDesc'], 'def_tz_new', array($lang['timezone1'], $lang['timezone2'], $lang['timezone3'], $lang['timezone4'], $lang['timezone5'], $lang['timezone6'], $lang['timezone7'], $lang['timezone8'], $lang['timezone9'], $lang['timezone10'], $lang['timezone11'], $lang['timezone12'], $lang['timezone13'], $lang['timezone14'], $lang['timezone15'], $lang['timezone16'], $lang['timezone17'], $lang['timezone18'], $lang['timezone19'], $lang['timezone20'], $lang['timezone21'], $lang['timezone22'], $lang['timezone23'], $lang['timezone24'], $lang['timezone25'], $lang['timezone26'], $lang['timezone27'], $lang['timezone28'], $lang['timezone29'], $lang['timezone30'], $lang['timezone31'], $lang['timezone32'], $lang['timezone33']), array('-12', '-11', '-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3.5', '-3', '-2', '-1', '0', '1', '2', '3', '3.5', '4', '4.5', '5', '5.5', '5.75', '6', '6.5', '7', '8', '9', '9.5', '10', '11', '12', '13'), array($timezone1, $timezone2, $timezone3, $timezone4, $timezone5, $timezone6, $timezone7, $timezone8, $timezone9, $timezone10, $timezone11, $timezone12, $timezone13, $timezone14, $timezone15, $timezone16, $timezone17, $timezone18, $timezone19, $timezone20, $timezone21, $timezone22, $timezone23, $timezone24, $timezone25, $timezone26, $timezone27, $timezone28, $timezone29, $timezone30, $timezone31, $timezone32, $timezone33), false);
         printsetting2($lang['addtime'], 'addtimenew', $SETTINGS['addtime'], 3);
         printsetting1($lang['sigbbcode'], 'sigbbcodenew', $sigbbcodeon, $sigbbcodeoff);
         printsetting1($lang['sightml'], 'sightmlnew', $sightmlon, $sightmloff);
-        printsetting2($lang['max_avatar_size_w'], 'max_avatar_size_w_new', $max_avatar_sizes[0], 4);
-        printsetting2($lang['max_avatar_size_h'], 'max_avatar_size_h_new', $max_avatar_sizes[1], 4);
+        if (!ini_get('allow_url_fopen')) {
+            printsetting5($lang['max_avatar_size_w'], $lang['no_url_fopen']);
+        } else {
+            printsetting2($lang['max_avatar_size_w'], 'max_avatar_size_w_new', $max_avatar_sizes[0], 4);
+            printsetting2($lang['max_avatar_size_h'], 'max_avatar_size_h_new', $max_avatar_sizes[1], 4);
+        }
         printsetting1($lang['what_tickerstatus'], 'tickerstatusnew', $tickerstatuson, $tickerstatusoff);
         printsetting2($lang['what_tickerdelay'], 'tickerdelaynew', ((int)$SETTINGS['tickerdelay']), 5);
         printsetting4($lang['tickercontents'], 'tickercontentsnew', $SETTINGS['tickercontents'], 5, 50);
         ?>
-        <tr class="tablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2">&nbsp;</td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit6" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         <tr class="category">
-        <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings7']?></font></strong></td>
+        <td colspan="2"><strong><font color="<?php echo $cattext?>"><a name="7" />&raquo;&nbsp;<?php echo $lang['admin_main_settings7']?></font></strong></td>
         </tr>
         <?php
-        printsetting1($lang['captchastatus'], 'captchanew', $captchaOn, $captchaOff);
-        printsetting1($lang['captcharegstatus'], 'captcharegnew', $captcharegOn, $captcharegOff);
-        printsetting1($lang['captchapoststatus'], 'captchapostnew', $captchapostOn, $captchapostOff);
-        printsetting2($lang['captchacharset'], 'captchacharsetnew', $SETTINGS['captcha_code_charset'], 50);
-        printsetting2($lang['captchacodelength'], 'captchacodenew', ((int)$SETTINGS['captcha_code_length']), 3);
-        printsetting1($lang['captchacodecase'], 'captchacodecasenew', $captchacodecaseOn, $captchacodecaseOff);
-        printsetting1($lang['captchacodeshadow'], 'captchacodeshadownew', $captchacodeshadowOn, $captchacodeshadowOff);
-        printsetting2($lang['captchaimagetype'], 'captchaimagetypenew', $SETTINGS['captcha_image_type'], 5);
-        printsetting2($lang['captchaimagewidth'], 'captchaimagewidthnew', ((int)$SETTINGS['captcha_image_width']), 5);
-        printsetting2($lang['captchaimageheight'], 'captchaimageheightnew', ((int)$SETTINGS['captcha_image_height']), 5);
-        printsetting2($lang['captchaimagebg'], 'captchaimagebgnew', $SETTINGS['captcha_image_bg'], 50);
-        printsetting2($lang['captchaimagedots'], 'captchaimagedotsnew', ((int)$SETTINGS['captcha_image_dots']), 3);
-        printsetting2($lang['captchaimagelines'], 'captchaimagelinesnew', ((int)$SETTINGS['captcha_image_lines']), 3);
-        printsetting2($lang['captchaimagefonts'], 'captchaimagefontsnew', $SETTINGS['captcha_image_fonts'], 50);
-        printsetting2($lang['captchaimageminfont'], 'captchaimageminfontnew', ((int)$SETTINGS['captcha_image_minfont']), 3);
-        printsetting2($lang['captchaimagemaxfont'], 'captchaimagemaxfontnew', ((int)$SETTINGS['captcha_image_maxfont']), 3);
-        printsetting1($lang['captchaimagecolor'], 'captchaimagecolornew', $captchaimagecolorOn, $captchaimagecolorOff);
+        if (DEBUG) {
+            printsetting5($lang['captchastatus'], $lang['captchaindebug']);
+        } else {
+            printsetting1($lang['captchastatus'], 'captchanew', $captchaOn, $captchaOff);
+            printsetting1($lang['captcharegstatus'], 'captcharegnew', $captcharegOn, $captcharegOff);
+            printsetting1($lang['captchapoststatus'], 'captchapostnew', $captchapostOn, $captchapostOff);
+            printsetting1($lang['captchasearchstatus'], 'captchasearchnew', $captchasearchOn, $captchasearchOff);
+            printsetting2($lang['captchacharset'], 'captchacharsetnew', $SETTINGS['captcha_code_charset'], 50);
+            printsetting2($lang['captchacodelength'], 'captchacodenew', ((int)$SETTINGS['captcha_code_length']), 3);
+            printsetting1($lang['captchacodecase'], 'captchacodecasenew', $captchacodecaseOn, $captchacodecaseOff);
+            printsetting1($lang['captchacodeshadow'], 'captchacodeshadownew', $captchacodeshadowOn, $captchacodeshadowOff);
+            printsetting2($lang['captchaimagetype'], 'captchaimagetypenew', $SETTINGS['captcha_image_type'], 5);
+            printsetting2($lang['captchaimagewidth'], 'captchaimagewidthnew', ((int)$SETTINGS['captcha_image_width']), 5);
+            printsetting2($lang['captchaimageheight'], 'captchaimageheightnew', ((int)$SETTINGS['captcha_image_height']), 5);
+            printsetting2($lang['captchaimagebg'], 'captchaimagebgnew', $SETTINGS['captcha_image_bg'], 50);
+            printsetting2($lang['captchaimagedots'], 'captchaimagedotsnew', ((int)$SETTINGS['captcha_image_dots']), 3);
+            printsetting2($lang['captchaimagelines'], 'captchaimagelinesnew', ((int)$SETTINGS['captcha_image_lines']), 3);
+            printsetting2($lang['captchaimagefonts'], 'captchaimagefontsnew', $SETTINGS['captcha_image_fonts'], 50);
+            printsetting2($lang['captchaimageminfont'], 'captchaimageminfontnew', ((int)$SETTINGS['captcha_image_minfont']), 3);
+            printsetting2($lang['captchaimagemaxfont'], 'captchaimagemaxfontnew', ((int)$SETTINGS['captcha_image_maxfont']), 3);
+            printsetting1($lang['captchaimagecolor'], 'captchaimagecolornew', $captchaimagecolorOn, $captchaimagecolorOff);
+        }
         ?>
         <tr class="ctrtablerow">
-        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit" value="<?php echo $lang['textsubmitchanges']?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" name="settingsubmit7" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         </table>
         </td>
@@ -578,19 +631,17 @@
         $sitenamenew = postedVar('sitenamenew');
         $bbnamenew = postedVar('bbnamenew');
         $siteurlnew = postedVar('siteurlnew');
-        $boardurlnew = postedVar('boardurlnew');
         $adminemailnew = postedVar('adminemailnew');
         $bbrulesnew = formOnOff('bbrulesnew');
-        $bbrulestxtnew = postedVar('bbrulestxtnew');
+        $bbrulestxtnew = postedVar('bbrulestxtnew', '', FALSE);
         $bbstatusnew = formOnOff('bbstatusnew');
         $bboffreasonnew = postedVar('bboffreasonnew');
         $gzipcompressnew = formOnOff('gzipcompressnew');
 
-        $langfilenew = getLangFileNameFromHash($langfilenew);
-        if (!$langfilenew) {
+        $langfilenew = postedVar('langfilenew');
+        $result = $db->query("SELECT devname FROM ".X_PREFIX."lang_base WHERE devname='$langfilenew'");
+        if ($db->num_rows($result) == 0) {
             $langfilenew = $SETTINGS['langfile'];
-        } else {
-            $langfilenew = basename($langfilenew);
         }
 
         $themenew = formInt('themenew');
@@ -638,7 +689,7 @@
         $bbinsertnew = formOnOff('bbinsertnew');
         $smileyinsertnew = formOnOff('smileyinsertnew');
 
-        $new_footer_options = formArray('new_footer_options');
+        $new_footer_options = postedArray('new_footer_options');
         if (!empty($new_footer_options)) {
             $footer_options = implode('-', $new_footer_options);
         } else {
@@ -656,23 +707,6 @@
         $tickerdelaynew = formInt('tickerdelaynew');
         $tickercontentsnew = postedVar('tickercontentsnew');
         $maxDayReg = formInt('maxDayReg');
-        $captchanew = formOnOff('captchanew');
-        $captcharegnew = formOnOff('captcharegnew');
-        $captchapostnew = formOnOff('captchapostnew');
-        $captchacharsetnew = postedVar('captchacharsetnew');
-        $captchacodenew = formInt('captchacodenew');
-        $captchacodecasenew = formOnOff('captchacodecasenew');
-        $captchacodeshadownew = formOnOff('captchacodeshadownew');
-        $captchaimagetypenew = postedVar('captchaimagetypenew');
-        $captchaimagewidthnew = formInt('captchaimagewidthnew');
-        $captchaimageheightnew = formInt('captchaimageheightnew');
-        $captchaimagebgnew = postedVar('captchaimagebgnew');
-        $captchaimagedotsnew = formInt('captchaimagedotsnew');
-        $captchaimagelinesnew = formInt('captchaimagelinesnew');
-        $captchaimagefontsnew = postedVar('captchaimagefontsnew');
-        $captchaimageminfontnew = formInt('captchaimageminfontnew');
-        $captchaimagemaxfontnew = formInt('captchaimagemaxfontnew');
-        $captchaimagecolornew = formOnOff('captchaimagecolornew');
         $showsubforumsnew = formOnOff('showsubforumsnew');
         $max_avatar_size = $max_avatar_size_w_new.'x'.$max_avatar_size_h_new;
         $regoptionalnew = formOnOff('regoptionalnew');
@@ -681,8 +715,22 @@
         $index_statsnew = formOnOff('index_statsnew');
         $onlinetodaycountnew = formInt('onlinetodaycountnew');
         $onlinetoday_statusnew = formOnOff('onlinetoday_statusnew');
+        
+        $filespathnew = postedVar('filespathnew');
+        $filesbasenew = postedVar('filesbasenew');
+        $filesminsizenew = formInt('filesminsizenew');
+        $filesperpostnew = formInt('filesperpostnew');
+        $filesurlpathnew = formInt('filesurlpathnew');
+        $filessubdirnew = formInt('filessubdirnew');
+        $max_image_size_w_new = formInt('max_image_size_w_new');
+        $max_image_size_h_new = formInt('max_image_size_h_new');
+        $max_thumb_size_w_new = formInt('max_thumb_size_w_new');
+        $max_thumb_size_h_new = formInt('max_thumb_size_h_new');
+        $max_image_size = $max_image_size_w_new.'x'.$max_image_size_h_new;
+        $max_thumb_size = $max_thumb_size_w_new.'x'.$max_thumb_size_h_new;
+        $remoteimages = formOnOff('remoteimages');
 
-        $db->query("UPDATE ".X_PREFIX."settings SET
+        $sql = "UPDATE ".X_PREFIX."settings SET
             langfile='$langfilenew',
             bbname='$bbnamenew',
             postperpage='$postperpagenew',
@@ -709,7 +757,6 @@
             avastatus='$avastatusnew',
             u2uquota='$u2uquotanew',
             gzipcompress='$gzipcompressnew',
-            boardurl='$boardurlnew',
             coppa='$coppanew',
             timeformat='$timeformatnew',
             adminemail='$adminemailnew',
@@ -745,9 +792,49 @@
             ipreg='$ipReg',
             maxdayreg='$maxDayReg',
             maxattachsize='$maxAttachSize',
+            showsubforums='$showsubforumsnew',
+            regoptional='$regoptionalnew',
+            quickreply_status='$quickreply_statusnew',
+            quickjump_status='$quickjump_statusnew',
+            index_stats='$index_statsnew',
+            onlinetodaycount='$onlinetodaycountnew',
+            onlinetoday_status='$onlinetoday_statusnew',
+            attach_remote_images='$remoteimages',
+            files_min_disk_size='$filesminsizenew',
+            files_storage_path='$filespathnew',
+            files_subdir_format='$filessubdirnew',
+            file_url_format='$filesurlpathnew',
+            files_virtual_url='$filesbasenew',
+            filesperpost='$filesperpostnew',
+            max_image_size='$max_image_size',
+            max_thumb_size='$max_thumb_size'
+        ";
+        
+        if (!DEBUG) {
+            $captchanew = formOnOff('captchanew');
+            $captcharegnew = formOnOff('captcharegnew');
+            $captchapostnew = formOnOff('captchapostnew');
+            $captchasearchnew = formOnOff('captchasearchnew');
+            $captchacharsetnew = postedVar('captchacharsetnew');
+            $captchacodenew = formInt('captchacodenew');
+            $captchacodecasenew = formOnOff('captchacodecasenew');
+            $captchacodeshadownew = formOnOff('captchacodeshadownew');
+            $captchaimagetypenew = postedVar('captchaimagetypenew');
+            $captchaimagewidthnew = formInt('captchaimagewidthnew');
+            $captchaimageheightnew = formInt('captchaimageheightnew');
+            $captchaimagebgnew = postedVar('captchaimagebgnew');
+            $captchaimagedotsnew = formInt('captchaimagedotsnew');
+            $captchaimagelinesnew = formInt('captchaimagelinesnew');
+            $captchaimagefontsnew = postedVar('captchaimagefontsnew');
+            $captchaimageminfontnew = formInt('captchaimageminfontnew');
+            $captchaimagemaxfontnew = formInt('captchaimagemaxfontnew');
+            $captchaimagecolornew = formOnOff('captchaimagecolornew');
+
+            $sql .= ",
             captcha_status='$captchanew',
             captcha_reg_status='$captcharegnew',
             captcha_post_status='$captchapostnew',
+            captcha_search_status='$captchasearchnew',
             captcha_code_charset='$captchacharsetnew',
             captcha_code_length='$captchacodenew',
             captcha_code_casesensitive='$captchacodecasenew',
@@ -761,15 +848,11 @@
             captcha_image_fonts='$captchaimagefontsnew',
             captcha_image_minfont='$captchaimageminfontnew',
             captcha_image_maxfont='$captchaimagemaxfontnew',
-            captcha_image_color='$captchaimagecolornew',
-            showsubforums='$showsubforumsnew',
-            regoptional='$regoptionalnew',
-            quickreply_status='$quickreply_statusnew',
-            quickjump_status='$quickjump_statusnew',
-            index_stats='$index_statsnew',
-            onlinetodaycount='$onlinetodaycountnew',
-            onlinetoday_status='$onlinetoday_statusnew'
-        ");
+            captcha_image_color='$captchaimagecolornew'
+            ";
+        }
+        
+        $db->query($sql);
 
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textsettingsupdate'].'</td></tr>';
     }
@@ -892,7 +975,7 @@
             }
             foreach($groups as $moveforum) { //Groups and grouped forum options.
                 echo "<option value=\"$moveforum[fid]\">".stripslashes($moveforum['name'])."</option>";
-                if (!isset($subs[$forum['fid']])) {
+                if (isset($forums[$moveforum['fid']]) And !isset($subs[$forum['fid']])) {
                     foreach($forums[$moveforum['fid']] as $moveforum) {
                         echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
                     }
@@ -930,8 +1013,10 @@
                     }
                     foreach($groups as $moveforum) { //Groups and grouped forum options.
                         echo '<option value="'.$moveforum['fid'].'">'.stripslashes($moveforum['name']).'</option>';
-                        foreach($forums[$moveforum['fid']] as $moveforum) {
-                            echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                        if (isset($forums[$moveforum['fid']])) {
+                            foreach($forums[$moveforum['fid']] as $moveforum) {
+                                echo "<option value=\"$moveforum[fid]\"> &nbsp; &raquo; ".stripslashes($moveforum['name'])."</option>";
+                            }
                         }
                     }
                     ?>
@@ -1165,7 +1250,10 @@
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textdesc']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="descnew"><?php echo $forum['description']; ?></textarea></td>
+        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="descnew">
+<?php // Linefeed required here - Do not edit!
+        echo $forum['description'];
+        ?></textarea></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>" valign="top"><?php echo $lang['textallow']?></td>
@@ -1185,16 +1273,6 @@
         <tr class="tablerow">
         <td style="background-color: <?php echo $THEME['altbg1']?>"><?php echo $lang['forumpermissions']?></td>
         <td style="background-color: <?php echo $THEME['altbg2']?>"><table style="width: 100%; text-align: center;">
-        <?php
-        $perms = explode(',', $forum['postperm']);
-        $statusList = array(
-            'Super Administrator'   => 1,
-            'Administrator'         => 2,
-            'Super Moderator'       => 4,
-            'Moderator'             => 8,
-            'Member'                => 16,
-            'guest'                 => 32);
-         ?>
         <tr>
             <td class="tablerow" style="width: 25ex;">&nbsp;</td>
             <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['polls'];   ?></td>
@@ -1203,21 +1281,24 @@
             <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: center;"><?php echo $lang['view'];    ?></td>
         </tr>
         <?php
-        foreach($statusList as $key=>$val) {
-            if (!X_SADMIN and $key == 'Super Administrator') {
-                $disabled = 'disabled="disabled"';
-            } else {
-                $disabled = '';
+        $perms = explode(',', $forum['postperm']);
+        foreach($status_enum as $key=>$val) {
+            if ($key != '' And $val <= $status_enum['Guest']) {
+                if (!X_SADMIN and $key == 'Super Administrator') {
+                    $disabled = 'disabled="disabled"';
+                } else {
+                    $disabled = '';
+                }
+                ?>
+                <tr class="tablerow">
+                    <td class="category" style="color: <?php echo $THEME['cattext']; ?>; font-weight: bold; text-align: right;"><?php echo $lang[$status_translate[$val]]; ?></td>
+                    <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[<?php echo X_PERMS_RAWPOLL; ?>][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_RAWPOLL]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                    <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[<?php echo X_PERMS_RAWTHREAD; ?>][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_RAWTHREAD]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                    <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[<?php echo X_PERMS_RAWREPLY; ?>][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_RAWREPLY]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                    <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[<?php echo X_PERMS_RAWVIEW; ?>][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_RAWVIEW]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
+                </tr>
+                <?php
             }
-            ?>
-            <tr class="tablerow">
-                <td class="category" style="color: <?php echo $THEME['cattext']?>; font-weight: bold; text-align: right;"><?php echo ucwords($key);?></td>
-                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[0][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_POLL]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
-                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[1][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_THREAD]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
-                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[2][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_REPLY]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
-                <td class="altbg1 ctrtablerow"><input type="checkbox" name="permsNew[3][]" value="<?php echo $val;?>" <?php echo ((($perms[X_PERMS_VIEW]&$val) == $val) ? 'checked="checked"' : ''); ?> <?php echo $disabled;?> /></td>
-            </tr>
-            <?php
         }
         ?>
         </table></td>
@@ -1225,7 +1306,10 @@
 
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['textuserlist']?></td>
-        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="userlistnew"><?php echo $forum['userlist']?></textarea></td>
+        <td bgcolor="<?php echo $altbg2?>"><textarea rows="4" cols="30" name="userlistnew">
+<?php // Linefeed required here - Do not edit!
+        echo $forum['userlist'];
+        ?></textarea></td>
         </tr>
         <tr class="tablerow">
         <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['forumpw']?></td>
@@ -1248,73 +1332,77 @@
         <?php
     } else if (onSubmit('forumsubmit') && !$fdetails) {
         $queryforum = $db->query("SELECT fid, type, fup FROM ".X_PREFIX."forums WHERE type='forum' OR type='sub'");
-        $db->query("DELETE FROM ".X_PREFIX."forums WHERE name=''");
         while($forum = $db->fetch_array($queryforum)) {
             $displayorder = formInt('displayorder'.$forum['fid']);
-            $self['status'] = formOnOff('status'.$forum['fid']);
+            $forum['status'] = formOnOff('status'.$forum['fid']);
             $name = addslashes(htmlspecialchars(postedVar('name'.$forum['fid'], 'javascript', FALSE), ENT_COMPAT)); //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
             $delete = formInt('delete'.$forum['fid']);
             $moveto = formInt('moveto'.$forum['fid']);
 
+            $dsuccess = FALSE;
             if ($delete == $forum['fid']) {
-                $db->query("DELETE FROM ".X_PREFIX."forums WHERE (type='forum' OR type='sub') AND fid=$delete");
-                $querythread = $db->query("SELECT tid, author FROM ".X_PREFIX."threads WHERE fid=$delete");
-                while($thread = $db->fetch_array($querythread)) {
-                    $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$thread[tid]'");
-                    $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$thread[tid]'");
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$thread[author]'");
-                    $querypost = $db->query("SELECT pid, author FROM ".X_PREFIX."posts WHERE tid='$thread[tid]'");
-                    while($post = $db->fetch_array($querypost)) {
-                        $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$post[pid]'");
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$post[author]'");
-                    }
-                    $db->free_result($querypost);
+                if ($db->num_rows($db->query('SELECT tid FROM '.X_PREFIX.'threads WHERE fid='.$forum['fid'])) > 0) {
+                    $dsuccess = FALSE;
+                } elseif ($db->num_rows($db->query('SELECT fid FROM '.X_PREFIX.'forums WHERE fup='.$forum['fid'])) > 0) {
+                    $dsuccess = FALSE;
+                } elseif ($db->num_rows($db->query('SELECT pid FROM '.X_PREFIX.'posts WHERE fid='.$forum['fid'])) > 0) {
+                    $dsuccess = FALSE;
+                } else {
+                    $db->query("DELETE FROM ".X_PREFIX."forums WHERE (type='forum' OR type='sub') AND fid=".$forum['fid']);
+                    $dsuccess = TRUE;
                 }
-                $db->free_result($querythread);
+                if (!$dsuccess) {
+                    message($lang['deleteaborted'].'<br />'.$lang['forumnotempty'], FALSE, '', '', FALSE, FALSE, FALSE, FALSE);
+                }
             }
-            $settype = '';
-            if ($forum['fup'] != $moveto And $moveto != $forum['fid'] And $forum['type'] != 'group') { //Forum is being moved
-                if ($moveto == 0) {
-                    $settype = ", type='forum', fup=0";
-                } else {
-                    $query = $db->query("SELECT type FROM ".X_PREFIX."forums WHERE fid=$moveto");
-                    if ($frow = $db->fetch_array($query)) {
-                        if ($frow['type'] == 'group') {
-                            $settype = ", type='forum', fup=$moveto";
-                        } else if ($frow['type'] == 'forum') {
-                            if ($forum['type'] == 'sub') {
-                                $settype = ", fup=$moveto";
-                            } else if ($forum['type'] == 'forum') { //Make sure the admin didn't try to demote a parent
-                                $query2 = $db->query("SELECT COUNT(*) AS subcount FROM ".X_PREFIX."forums WHERE fup={$forum['fid']}");
-                                $frow = $db->fetch_array($query2);
-                                $db->free_result($query2);
-                                if ($frow['subcount'] == 0) {
-                                    $settype = ", type='sub', fup=$moveto";
+            
+            if (!$dsuccess) {
+                $settype = '';
+                if ($forum['fup'] != $moveto And $moveto != $forum['fid'] And $forum['type'] != 'group') { //Forum is being moved
+                    if ($moveto == 0) {
+                        $settype = ", type='forum', fup=0";
+                    } else {
+                        $query = $db->query("SELECT type FROM ".X_PREFIX."forums WHERE fid=$moveto");
+                        if ($frow = $db->fetch_array($query)) {
+                            if ($frow['type'] == 'group') {
+                                $settype = ", type='forum', fup=$moveto";
+                            } else if ($frow['type'] == 'forum') {
+                                if ($forum['type'] == 'sub') {
+                                    $settype = ", fup=$moveto";
+                                } else if ($forum['type'] == 'forum') { //Make sure the admin didn't try to demote a parent
+                                    $query2 = $db->query("SELECT COUNT(*) AS subcount FROM ".X_PREFIX."forums WHERE fup={$forum['fid']}");
+                                    $frow = $db->fetch_array($query2);
+                                    $db->free_result($query2);
+                                    if ($frow['subcount'] == 0) {
+                                        $settype = ", type='sub', fup=$moveto";
+                                    }
                                 }
                             }
                         }
+                        $db->free_result($query);
                     }
-                    $db->free_result($query);
                 }
+                $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='{$forum['status']}'$settype WHERE fid='".$forum['fid']."'");
             }
-            $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='$self[status]'$settype WHERE fid='".$forum['fid']."'");
         }
 
         $querygroup = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
         while($group = $db->fetch_array($querygroup)) {
             $name = addslashes(htmlspecialchars(postedVar('name'.$group['fid'], 'javascript', FALSE), ENT_COMPAT));  //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
             $displayorder = formInt('displayorder'.$group['fid']);
-            $self['status'] = formOnOff('status'.$group['fid']);
+            $group['status'] = formOnOff('status'.$group['fid']);
             $delete = formInt('delete'.$group['fid']);
 
             if ($delete == $group['fid']) {
                 $query = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup=$delete");
-                while($forum = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."forums SET fup=0 WHERE type='forum' AND fup=$delete");
+                if ($db->num_rows($query) > 0) {
+                    message($lang['deleteaborted'].'<br />'.$lang['forumnotempty'], FALSE, '', '', FALSE, FALSE, FALSE, FALSE);
+                } else {
+                    $db->query("DELETE FROM ".X_PREFIX."forums WHERE type='group' AND fid=$delete");
                 }
-                $db->query("DELETE FROM ".X_PREFIX."forums WHERE type='group' AND fid=$delete");
+            } else {
+                $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=$displayorder, status='{$group['status']}' WHERE fid={$group['fid']}");
             }
-            $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='".$self['status']."' WHERE fid='".$group['fid']."'");
         }
 
         $newgname = addslashes(htmlspecialchars(postedVar('newgname', 'javascript', FALSE), ENT_COMPAT));  //Forum names are historically double-slashed.  We also have an unusual situation where ENT_COMPAT is the XMB standard.
@@ -1354,8 +1442,8 @@
         $passwordnew = postedVar('passwordnew', '', FALSE, TRUE);
         $delete = formInt('delete');
 
+        $overrule = array(0,0,0,0);
         if (!X_SADMIN) {
-            $overrule = array(0,0,0,0);
             $forum = $db->fetch_array($db->query("SELECT postperm FROM ".X_PREFIX."forums WHERE fid=$fdetails"));
             $parts = explode(',', $forum['postperm']);
             foreach($parts as $p=>$v) {
@@ -1364,13 +1452,11 @@
                     $overrule[$p] = 1;
                 }
             }
-        } else {
-            $overrule = array(0,0,0,0);
         }
 
         $perms = array(0,0,0,0);
-        foreach($permsNew as $key=>$val) {
-            $perms[$key] = array_sum($val);
+        foreach($_POST['permsNew'] as $key=>$val) {
+            $perms[$key] = array_sum($_POST['permsNew'][$key]);
             $perms[$key] |= $overrule[$key];
         }
         $perms = implode(',', $perms);
@@ -1388,12 +1474,29 @@
             attachstatus='$attachstatusnew',
             password='$passwordnew'
             WHERE fid='$fdetails'"
-       );
+        );
 
+        $dsuccess = TRUE;
         if ($delete) {
-            $db->query("DELETE FROM ".X_PREFIX."forums WHERE fid=$delete");
+            if ($delete == $fdetails) {
+                if ($db->num_rows($db->query('SELECT tid FROM '.X_PREFIX.'threads WHERE fid='.$fdetails)) > 0) {
+                    $dsuccess = FALSE;
+                } elseif ($db->num_rows($db->query('SELECT fid FROM '.X_PREFIX.'forums WHERE fup='.$fdetails)) > 0) {
+                    $dsuccess = FALSE;
+                } elseif ($db->num_rows($db->query('SELECT pid FROM '.X_PREFIX.'posts WHERE fid='.$fdetails)) > 0) {
+                    $dsuccess = FALSE;
+                } else {
+                    $db->query("DELETE FROM ".X_PREFIX."forums WHERE (type='forum' OR type='sub') AND fid=".$fdetails);
+                    $dsuccess = TRUE;
+                }
+                if (!$dsuccess) {
+                    message($lang['deleteaborted'].'<br />'.$lang['forumnotempty'], FALSE, '', '', FALSE, FALSE, FALSE, FALSE);
+                }
+            }
         }
-        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textforumupdate'].'</td></tr>';
+        if ($dsuccess) {
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textforumupdate'].'</td></tr>';
+        }
     }
 }
 
@@ -1455,7 +1558,7 @@
         </tr>
         <?php
     } else {
-        $mod = formArray('mod');
+        $mod = postedArray('mod');
         if (is_array($mod)) {
             foreach($mod as $fid=>$mods) {
                 $db->query("UPDATE ".X_PREFIX."forums SET moderator='$mods' WHERE fid='$fid'");
@@ -1467,6 +1570,41 @@
 
 if ($action == "members") {
     $members = postedVar('members', '', FALSE, FALSE, FALSE, 'g');
+
+    $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE);
+    $srchemail = postedVar('srchemail', 'javascript', TRUE, FALSE, TRUE);
+    $srchip = postedVar('srchip', 'javascript', TRUE, FALSE, TRUE);
+    $srchstatus = postedVar('srchstatus', 'javascript', TRUE, TRUE, TRUE);
+    $dblikemem = $db->like_escape($srchmem);
+    $dblikeemail = $db->like_escape($srchemail);
+    $dblikeip = $db->like_escape($srchip);
+
+    $where = array();
+
+    if ($srchmem != '') {
+        $where[] = "username LIKE '%$dblikemem%' ";
+    }
+    if ($srchemail != '') {
+        $where[] = "email LIKE '%$dblikeemail%' ";
+    }
+    if ($srchip != '') {
+        $where[] = "regip LIKE '%$dblikeip%' ";
+    }
+    if ($srchstatus != '') {
+        if ($srchstatus == 'Pending') {
+            $where[] = "lastvisit = 0 ";
+        } else {
+            $where[] = "status = '$srchstatus' ";
+        }
+    }
+
+    if (count($where) == 0) {
+        $where = '';
+    } else {
+        $where = 'WHERE '.implode('AND ', $where);
+    }
+
+
     if (noSubmit('membersubmit')) {
         if (!$members) {
             ?>
@@ -1485,10 +1623,18 @@
             <td bgcolor="<?php echo $altbg2?>"><input type="text" name="srchmem" /></td>
             </tr>
             <tr class="tablerow">
+            <td bgcolor="<?php echo $altbg1?>" width="22%"><?php echo $lang['textsrchemail']?></td>
+            <td bgcolor="<?php echo $altbg2?>"><input type="text" name="srchemail" /></td>
+            </tr>
+            <tr class="tablerow">
+            <td bgcolor="<?php echo $altbg1?>" width="22%"><?php echo $lang['textsrchip']?></td>
+            <td bgcolor="<?php echo $altbg2?>"><input type="text" name="srchip" /></td>
+            </tr>
+            <tr class="tablerow">
             <td bgcolor="<?php echo $altbg1?>" width="22%"><?php echo $lang['textwithstatus']?></td>
             <td bgcolor="<?php echo $altbg2?>">
             <select name="srchstatus">
-            <option value="0"><?php echo $lang['anystatus']?></option>
+            <option value=""><?php echo $lang['anystatus']?></option>
             <option value="Super Administrator"><?php echo $lang['superadmin']?></option>
             <option value="Administrator"><?php echo $lang['textadmin']?></option>
             <option value="Super Moderator"><?php echo $lang['textsupermod']?></option>
@@ -1530,58 +1676,51 @@
             <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textbanfrom']?></font></strong></td>
             </tr>
             <?php
-            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE);
-            $dblikemem = $db->like_escape($srchmem);
-            $srchstatus = postedVar('srchstatus');
-            if ($srchstatus == '0') {
-                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' ORDER BY username");
-            } else if ($srchstatus == "Pending") {
-                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE lastvisit=0 ORDER BY username");
-            } else {
-                $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND status='$srchstatus' ORDER BY username");
-            }
+            
+            $query = $db->query("SELECT * FROM ".X_PREFIX."members $where ORDER BY username");
 
-            $sadminselect = $adminselect = $smodselect = '';
-            $modselect = $memselect = $banselect = '';
-            $noban = $u2uban = $postban = $bothban = '';
             while($member = $db->fetch_array($query)) {
+                $sadminselect = $adminselect = $smodselect = '';
+                $modselect = $memselect = $banselect = '';
+                $noban = $u2uban = $postban = $bothban = '';
+
                 switch($member['status']) {
-                    case 'Super Administrator':
-                        $sadminselect = $selHTML;
-                        break;
-                    case 'Administrator':
-                        $adminselect = $selHTML;
-                        break;
-                    case 'Super Moderator':
-                        $smodselect = $selHTML;
-                        break;
-                    case 'Moderator':
-                        $modselect = $selHTML;
-                        break;
-                    case 'Member':
-                        $memselect = $selHTML;
-                        break;
-                    case 'Banned':
-                        $banselect = $selHTML;
-                        break;
-                    default:
-                        $memselect = $selHTML;
-                        break;
+                case 'Super Administrator':
+                    $sadminselect = $selHTML;
+                    break;
+                case 'Administrator':
+                    $adminselect = $selHTML;
+                    break;
+                case 'Super Moderator':
+                    $smodselect = $selHTML;
+                    break;
+                case 'Moderator':
+                    $modselect = $selHTML;
+                    break;
+                case 'Member':
+                    $memselect = $selHTML;
+                    break;
+                case 'Banned':
+                    $banselect = $selHTML;
+                    break;
+                default:
+                    $memselect = $selHTML;
+                    break;
                 }
 
                 switch($member['ban']) {
-                    case 'u2u':
-                        $u2uban = $selHTML;
-                        break;
-                    case 'posts':
-                        $postban = $selHTML;
-                        break;
-                    case 'both':
-                        $bothban = $selHTML;
-                        break;
-                    default:
-                        $noban = $selHTML;
-                        break;
+                case 'u2u':
+                    $u2uban = $selHTML;
+                    break;
+                case 'posts':
+                    $postban = $selHTML;
+                    break;
+                case 'both':
+                    $bothban = $selHTML;
+                    break;
+                default:
+                    $noban = $selHTML;
+                    break;
                 }
 
                 if ($member['lastvisit'] == 0) {
@@ -1592,7 +1731,10 @@
                 ?>
                 <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
                 <td align="center"><input type="checkbox" name="delete<?php echo $member['uid']?>" onclick="addUserDel(<?php echo $member['uid']?>, '<?php echo $member['username']?>', this)" value="<?php echo $member['uid']?>" /></td>
-                <td><a href="member.php?action=viewpro&amp;member=<?php echo recodeOut($member['username']);?>"><?php echo $member['username']?></a>
+                <td><a href="member.php?action=viewpro&amp;member=<?php echo recodeOut($member['username']); ?>"><?php echo $member['username']?></a>
+                <?php if (X_SADMIN) { ?>
+                <br /><a href="editprofile.php?user=<?php echo recodeOut($member['username']); ?>"><strong><?php echo $lang['admin_edituseraccount']; ?></strong></a>
+                <?php } ?>
                 <br /><a href="javascript:confirmAction('<?php echo addslashes($lang['confirmDeletePosts']);?>', 'cp.php?action=deleteposts&amp;member=<?php echo recodeJavaOut($member['username'])?>', false);"><strong><?php echo $lang['cp_deleteposts']?></strong></a><?php echo $pending ?>
                 </td>
                 <td><input type="text" size="12" name="pw<?php echo $member['uid']?>"></td>
@@ -1605,7 +1747,7 @@
                 <option value="Member" <?php echo $memselect?>><?php echo $lang['textmem']?></option>
                 <option value="Banned" <?php echo $banselect?>><?php echo $lang['textbanned']?></option>
                 </select></td>
-                <td><input type="text" size="16" name="cusstatus<?php echo $member['uid']?>" value="<?php echo htmlspecialchars(stripslashes($member['customstatus']))?>" /></td>
+                <td><input type="text" size="16" name="cusstatus<?php echo $member['uid']?>" value="<?php echo attrOut($member['customstatus']); ?>" /></td>
                 <td><select name="banstatus<?php echo $member['uid']?>">
                 <option value="" <?php echo $noban?>><?php echo $lang['noban']?></option>
                 <option value="u2u" <?php echo $u2uban?>><?php echo $lang['banu2u']?></option>
@@ -1614,13 +1756,16 @@
                 </select></td>
                 </tr>
                 <?php
-                $sadminselect = $adminselect = $smodselect = '';
-                $modselect = $memselect = $banselect = '';
-                $noban = $u2uban = $postban = $bothban = '';
             }
             ?>
             <tr>
-            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7"><input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']?>" onclick="return confirmUserDel('<?php echo $lang['confirmDeleteUser']?>');" /><input type="hidden" name="srchmem" value="<?php echo $srchmem?>" /><input type="hidden" name="srchstatus" value="<?php echo $srchstatus?>" /></td>
+            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7">
+             <input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']; ?>" onclick="return confirmUserDel('<?php echo $lang['confirmDeleteUser']; ?>');" />
+             <input type="hidden" name="srchmem" value="<?php echo $srchmem; ?>" />
+             <input type="hidden" name="srchemail" value="<?php echo $srchemail; ?>" />
+             <input type="hidden" name="srchip" value="<?php echo $srchip; ?>" />
+             <input type="hidden" name="srchstatus" value="<?php echo $srchstatus; ?>" />
+            </td>
             </tr>
             </table>
             </td>
@@ -1632,68 +1777,45 @@
             <?php
         }
     } else if (onSubmit('membersubmit')) {
-        $query = $db->query("SELECT MIN(`uid`) FROM `" . X_PREFIX. "members` WHERE `status`='Super Administrator'");
+        $query = $db->query("SELECT MIN(uid) FROM ".X_PREFIX."members WHERE status='Super Administrator'");
         $sa_uid = $db->result($query, 0);
         $db->free_result($query);
 
-        $dblikemem = $db->like_escape(postedVar('srchmem', '', TRUE, FALSE));
-        $srchstatus = postedVar('srchstatus');
-        if ($srchstatus == '0') {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%'");
-        } else if ($srchstatus == "Pending") {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND lastvisit = 0");
-        } else {
-            $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$dblikemem%' AND status='$srchstatus'");
-        }
+        $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members $where");
 
         while($mem = $db->fetch_array($query)) {
-            $to['status'] = "status".$mem['uid'];
-            $to['status'] = isset($_POST[$to['status']]) ? $_POST[$to['status']] : '';
-
-            if (trim($to['status']) == '') {
-                $to['status'] = 'Member';
-            }
-
             $origstatus = $mem['status'];
-            $banstatus = "banstatus".$mem['uid'];
-            $banstatus =  isset($_POST[$banstatus]) ? $_POST[$banstatus] : '';
-            $cusstatus = "cusstatus".$mem['uid'];
-            $cusstatus =  isset($_POST[$cusstatus]) ? $_POST[$cusstatus] : '';
-            $pw = "pw" . $mem['uid'];
-            $pw = isset($_POST[$pw]) ? $_POST[$pw] : '';
-            $postnum = "postnum".$mem['uid'];
-            $postnum = isset($_POST[$postnum]) ? $_POST[$postnum] : '';
-            $delete = "delete".$mem['uid'];
-            $delete = isset($_POST[$delete]) ? $_POST[$delete] : '';
-
-            if ($pw != "") {
-                $newpw = md5(trim($pw));
-            } else {
-                $newpw = $mem['password'];
+            $status = postedVar('status'.$mem['uid']);
+            if ($status == '') {
+                $status = 'Member';
             }
-            $queryadd = " , password='$newpw'";
 
-            if (!X_SADMIN && ($origstatus == "Super Administrator" || $to['status'] == "Super Administrator")) {
+            if (!X_SADMIN && ($origstatus == "Super Administrator" || $status == "Super Administrator")) {
                 continue;
             }
 
-            if ($origstatus == 'Super Administrator' && $to['status'] != 'Super Administrator') {
-                if ($db->result($db->query("SELECT count(uid) FROM ".X_PREFIX."members WHERE status='Super Administrator'"), 0) == 1) {
-                    error($lang['lastsadmin'], false, '</td></tr></table></td></tr></table><br />');
+            $banstatus = postedVar('banstatus'.$mem['uid']);
+            $cusstatus = postedVar('cusstatus'.$mem['uid'], '', FALSE);
+            $postnum = getInt('postnum'.$mem['uid'], 'p');
+            $delete = getInt('delete'.$mem['uid'], 'p');
+
+            $queryadd = '';
+            if (isset($_POST['pw'.$mem['uid']])) {
+                if ($_POST['pw'.$mem['uid']] != '') {
+                    $newpw = md5($_POST['pw'.$mem['uid']]);
+                    $queryadd = ", password='$newpw' ";
                 }
             }
 
-            if ($delete != "" && $delete != $self['uid'] && $delete != $sa_uid) {
-                $db->query("DELETE FROM ".X_PREFIX."members WHERE uid='$delete'");
-                $db->query("UPDATE ".X_PREFIX."whosonline SET username='Anonymous' WHERE username='".$mem['username']."'");
+            if ($delete == $mem['uid'] && $delete != $self['uid'] && $delete != $sa_uid) {
+                $dbname = $db->escape_var($mem['username']);
+                $db->query("DELETE FROM ".X_PREFIX."members WHERE uid=$delete");
+                $db->query("DELETE FROM ".X_PREFIX."buddys WHERE username='$dbname'");
+                $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$dbname'");
+                $db->query("DELETE FROM ".X_PREFIX."u2u WHERE owner='$dbname'");
+                $db->query("UPDATE ".X_PREFIX."whosonline SET username='xguest123' WHERE username='$dbname'");
             } else {
-                if (strpos($pw, '"') !== false || strpos($pw, "'") !== false) {
-                    $lang['textmembersupdate'] = $mem['username'].': '.$lang['textpwincorrect'];
-                } else {
-                    $newcustom = addslashes($cusstatus);
-                    $db->query("UPDATE ".X_PREFIX."members SET ban='$banstatus', status='$to[status]', postnum='$postnum', customstatus='$newcustom'$queryadd WHERE uid='$mem[uid]'");
-                    $newpw="";
-                }
+                $db->query("UPDATE ".X_PREFIX."members SET ban='$banstatus', status='$status', postnum='$postnum', customstatus='$cusstatus'$queryadd WHERE uid={$mem['uid']}");
             }
         }
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['textmembersupdate'].'</td></tr>';
@@ -1701,135 +1823,174 @@
 }
 
 if ($action == "ipban") {
-    if (noSubmit('ipbansubmit')) {
-        ?>
-        <tr bgcolor="<?php echo $altbg2?>">
-        <td align="center">
-        <form method="post" action="cp.php?action=ipban">
-        <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
-        <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
-        <tr class="category">
-        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
-        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textip']?>:</font></strong></td>
-        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textipresolve']?>:</font></strong></td>
-        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textadded']?></font></strong></td>
-        </tr>
-        <?php
-        $query = $db->query("SELECT * FROM ".X_PREFIX."banned ORDER BY dateline");
-        while($ipaddress = $db->fetch_array($query)) {
-            for($i=1; $i<=4; ++$i) {
-                $j = "ip" . $i;
-                if ($ipaddress[$j] == -1) {
-                    $ipaddress[$j] = "*";
+    if ($SETTINGS['ip_banning'] == 'on') {
+        if (noSubmit('ipbansubmit') And noSubmit('ipbandisable')) {
+            ?>
+            <tr bgcolor="<?php echo $altbg2?>">
+            <td align="center">
+            <form method="post" action="cp.php?action=ipban">
+            <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
+            <tr><td bgcolor="<?php echo $bordercolor?>">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <tr class="category">
+            <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
+            <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textip']?>:</font></strong></td>
+            <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textadded']?></font></strong></td>
+            </tr>
+            <?php
+            $query = $db->query("SELECT * FROM ".X_PREFIX."banned ORDER BY dateline");
+            while($ipaddress = $db->fetch_array($query)) {
+                for($i=1; $i<=4; ++$i) {
+                    $j = "ip" . $i;
+                    if ($ipaddress[$j] == -1) {
+                        $ipaddress[$j] = "*";
+                    }
                 }
+                $ipdate = gmdate($dateformat, $ipaddress['dateline'] + ($timeoffset * 3600) + ($addtime * 3600)) . " $lang[textat] " . gmdate("$timecode", $ipaddress['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
+                $theip = "$ipaddress[ip1].$ipaddress[ip2].$ipaddress[ip3].$ipaddress[ip4]";
+                ?>
+                <tr class="tablerow" bgcolor="<?php echo $altbg1?>">
+                <td><input type="checkbox" name="delete[<?php echo $ipaddress['id']?>]" value="1" /></td>
+                <td><?php echo $theip?></td>
+                <td><?php echo $ipdate?></td>
+                </tr>
+                <?php
             }
-            $ipdate = gmdate($dateformat, $ipaddress['dateline'] + ($timeoffset * 3600) + ($addtime * 3600)) . " $lang[textat] " . gmdate("$timecode", $ipaddress['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-            $theip = "$ipaddress[ip1].$ipaddress[ip2].$ipaddress[ip3].$ipaddress[ip4]";
+
+            $ips = explode(".", $onlineip);
+            $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE (ip1='$ips[0]' OR ip1='-1') AND (ip2='$ips[1]' OR ip2='-1') AND (ip3='$ips[2]' OR ip3='-1') AND (ip4='$ips[3]' OR ip4='-1')");
+            $result = $db->fetch_array($query);
+            if ($result) {
+                $warning = $lang['ipwarning'];
+            } else {
+                $warning = '';
+            }
             ?>
-            <tr class="tablerow" bgcolor="<?php echo $altbg1?>">
-            <td><input type="checkbox" name="delete[<?php echo $ipaddress['id']?>]" value="1" /></td>
-            <td><?php echo $theip?></td>
-            <td><?php echo @gethostbyaddr($theip)?></td>
-            <td><?php echo $ipdate?></td>
+            <tr bgcolor="<?php echo $altbg2?>">
+            <td colspan="4" class="tablerow" bgcolor="<?php echo $altbg2?>"><?php echo $lang['textnewip']?>
+            <input type="text" name="newip1" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip2" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip3" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip4" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" /></td>
             </tr>
+            </table>
+            </td>
+            </tr>
+            </table>
+            <br />
+            <span class="smalltxt"><?php echo $lang['currentip']?> <strong><?php echo $onlineip?></strong><?php echo $warning?><br /><?php echo $lang['multipnote']?></span><br />
+            <br /><div align="center">
+            <input type="submit" class="submit" name="ipbansubmit" value="<?php echo $lang['textsubmitchanges']; ?>" />
+            <input type="submit" class="submit" name="ipbandisable" value="<?php echo $lang['ipbandisable']; ?>" />
+            </div>
+            </form>
+            </td>
+            </tr>
             <?php
-        }
-
-        $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE (ip1='$ips[0]' OR ip1='-1') AND (ip2='$ips[1]' OR ip2='-1') AND (ip3='$ips[2]' OR ip3='-1') AND (ip4='$ips[3]' OR ip4='-1')");
-        $result = $db->fetch_array($query);
-        if ($result) {
-            $warning = $lang['ipwarning'];
+        } elseif (onSubmit('ipbandisable')) {
+            $db->query('UPDATE '.X_PREFIX.'settings SET ip_banning="off"');
+            echo '<tr bgcolor="'.$altbg2.'"><td class="ctrtablerow">'.$lang['textipupdate'].'</td></tr>';
         } else {
-            $warning = '';
-        }
-        ?>
-        <tr bgcolor="<?php echo $altbg2?>">
-        <td colspan="4" class="tablerow" bgcolor="<?php echo $altbg2?>"><?php echo $lang['textnewip']?>
-        <input type="text" name="newip1" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip2" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip3" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" />.<input type="text" name="newip4" size="3" maxlength="3" bgcolor="<?php echo $altbg2?>" /></td>
-        </tr>
-        </table>
-        </td>
-        </tr>
-        </table>
-        <br />
-        <span class="smalltxt"><?php echo $lang['currentip']?> <strong><?php echo $onlineip?></strong><?php echo $warning?><br /><?php echo $lang['multipnote']?></span><br />
-        <br /><div align="center"><input type="submit" class="submit" name="ipbansubmit" value="<?php echo $lang['textsubmitchanges']?>" /></div>
-        </form>
-        </td>
-        </tr>
-        <?php
-    } else {
-        $newip = array();
-        $newip[] = (is_numeric(postedVar('newip1')) Or postedVar('newip1') == '*') ? trim(postedVar('newip1')) : '0' ;
-        $newip[] = (is_numeric(postedVar('newip2')) Or postedVar('newip2') == '*') ? trim(postedVar('newip2')) : '0' ;
-        $newip[] = (is_numeric(postedVar('newip3')) Or postedVar('newip3') == '*') ? trim(postedVar('newip3')) : '0' ;
-        $newip[] = (is_numeric(postedVar('newip4')) Or postedVar('newip4') == '*') ? trim(postedVar('newip4')) : '0' ;
-        $delete = postedArray('delete', 'int');
+            $newip = array();
+            $newip[] = (is_numeric(postedVar('newip1')) Or postedVar('newip1') == '*') ? trim(postedVar('newip1')) : '0' ;
+            $newip[] = (is_numeric(postedVar('newip2')) Or postedVar('newip2') == '*') ? trim(postedVar('newip2')) : '0' ;
+            $newip[] = (is_numeric(postedVar('newip3')) Or postedVar('newip3') == '*') ? trim(postedVar('newip3')) : '0' ;
+            $newip[] = (is_numeric(postedVar('newip4')) Or postedVar('newip4') == '*') ? trim(postedVar('newip4')) : '0' ;
+            $delete = postedArray('delete', 'int');
 
-        if ($delete) {
-            $dels = array();
-            foreach($delete as $id => $del) {
-                if ($del == 1) {
-                    $dels[] = $id;
+            if ($delete) {
+                $dels = array();
+                foreach($delete as $id => $del) {
+                    if ($del == 1) {
+                        $dels[] = $id;
+                    }
                 }
-            }
 
-            if (count($dels) > 0) {
-                $dels = implode(',', $dels);
-                $db->query("DELETE FROM ".X_PREFIX."banned WHERE id IN ($dels)");
+                if (count($dels) > 0) {
+                    $dels = implode(',', $dels);
+                    $db->query("DELETE FROM ".X_PREFIX."banned WHERE id IN ($dels)");
+                }
             }
-        }
-        $self['status'] = $lang['textipupdate'];
+            $self['status'] = $lang['textipupdate'];
 
-        if ($newip[0] != '0' || $newip[1] != '0' || $newip[2] != '0' || $newip[3] != '0') {
-            $invalid = 0;
-            for($i=0; $i<=3 && !$invalid; ++$i) {
-                if ($newip[$i] == "*") {
-                    $ip[$i+1] = -1;
-                } else if (intval($newip[$i]) >=0 And intval($newip[$i]) <= 255) {
-                    $ip[$i+1] = intval($newip[$i]);
-                } else {
-                    $invalid = 1;
+            if ($newip[0] != '0' || $newip[1] != '0' || $newip[2] != '0' || $newip[3] != '0') {
+                $invalid = 0;
+                for($i=0; $i<=3 && !$invalid; ++$i) {
+                    if ($newip[$i] == "*") {
+                        $ip[$i+1] = -1;
+                    } else if (intval($newip[$i]) >=0 And intval($newip[$i]) <= 255) {
+                        $ip[$i+1] = intval($newip[$i]);
+                    } else {
+                        $invalid = 1;
+                    }
                 }
-            }
 
-            if ($invalid) {
-                $self['status'] = $lang['invalidip'];
-            } else {
-                if ($ip[1] == '-1' && $ip[2] == '-1' && $ip[3] == '-1' && $ip[4] == '-1') {
-                    $self['status'] = $lang['impossiblebanall'];
+                if ($invalid) {
+                    $self['status'] = $lang['invalidip'];
                 } else {
-                    $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE (ip1='$ip[1]' OR ip1='-1') AND (ip2='$ip[2]' OR ip2='-1') AND (ip3='$ip[3]' OR ip3='-1') AND (ip4='$ip[4]' OR ip4='-1')");
-                    $result = $db->fetch_array($query);
-                    if ($result) {
-                        $self['status'] = $lang['existingip'];
+                    if ($ip[1] == '-1' && $ip[2] == '-1' && $ip[3] == '-1' && $ip[4] == '-1') {
+                        $self['status'] = $lang['impossiblebanall'];
                     } else {
-                        $query = $db->query("INSERT INTO ".X_PREFIX."banned (ip1, ip2, ip3, ip4, dateline) VALUES ('$ip[1]', '$ip[2]', '$ip[3]', '$ip[4]', $onlinetime)");
+                        $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE (ip1='$ip[1]' OR ip1='-1') AND (ip2='$ip[2]' OR ip2='-1') AND (ip3='$ip[3]' OR ip3='-1') AND (ip4='$ip[4]' OR ip4='-1')");
+                        $result = $db->fetch_array($query);
+                        if ($result) {
+                            $self['status'] = $lang['existingip'];
+                        } else {
+                            $query = $db->query("INSERT INTO ".X_PREFIX."banned (ip1, ip2, ip3, ip4, dateline) VALUES ('$ip[1]', '$ip[2]', '$ip[3]', '$ip[4]', $onlinetime)");
+                        }
                     }
                 }
             }
+            echo '<tr bgcolor="'.$altbg2.'"><td class="ctrtablerow">'.$self['status'].'</td></tr>';
         }
-        echo '<tr bgcolor="'.$altbg2.'"><td class="ctrtablerow">'.$self['status'].'</td></tr>';
+    } else {
+        if (noSubmit('ipbanenable')) {
+            ?>
+            <tr bgcolor="<?php echo $altbg2?>">
+            <td align="center">
+            <form method="post" action="cp.php?action=ipban">
+            <div align="center">
+            <input type="submit" class="submit" name="ipbanenable" value="<?php echo $lang['ipbanenable']; ?>" />
+            </div>
+            </form>
+            </td>
+            </tr>
+            <?php
+        } else {
+            $db->query('UPDATE '.X_PREFIX.'settings SET ip_banning="on"');
+            echo '<tr bgcolor="'.$altbg2.'"><td class="ctrtablerow">'.$lang['textipupdate'].'</td></tr>';
+        }
     }
 }
 
 if ($action == "deleteposts") {
+    require('include/attach-admin.inc.php');
     $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
     $countquery = $db->query("SELECT tid, COUNT(*) AS postcount FROM ".X_PREFIX."posts WHERE author='$member' GROUP BY tid");
-    //Critical: Do not alias tables in the next query.  MySQL 4.0 and MySQL 4.1 use mutually incompatible syntax.
-    $db->query("DELETE ".X_PREFIX."attachments, ".X_PREFIX."posts FROM ".X_PREFIX."posts LEFT JOIN ".X_PREFIX."attachments USING(pid) WHERE author='$member'");
+    deleteAttachmentsByUser($member);
+    $db->query("DELETE FROM ".X_PREFIX."posts WHERE author='$member'");
     $db->query("UPDATE ".X_PREFIX."members SET postnum = 0 WHERE username='$member'");
     while($threads = $db->fetch_array($countquery)) {
         $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-{$threads['postcount']} WHERE tid='{$threads['tid']}'");
     }
-    $countquery = $db->query("SELECT t.tid, COUNT(p.pid) AS postcount FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."posts AS p USING (tid) WHERE t.author='$member' GROUP BY t.tid");
+    
+    // Delete Empty Threads
+    // This will also delete thread redirectors where the redirect's author is $member
+    $tids = array();
+    $movedids = array();
+    $countquery = $db->query("SELECT t.tid FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."posts AS p USING (tid) WHERE t.author='$member' GROUP BY t.tid HAVING COUNT(p.pid) = 0");
     while($threads = $db->fetch_array($countquery)) {
-        if ($threads['postcount'] == 0) { //This will also delete thread redirectors where the redirect's author is $member
-            $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='{$threads['tid']}'");
-            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='{$threads['tid']}'");
-        }
+        $tids[] = $threads['tid'];
+        $movedids[] = 'moved|'.$threads['tid'];
     }
+    if (count($tids) > 0) {
+        $tids = implode(', ', $tids);
+        $movedids = implode("', '", $movedids);
+        $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN ($tids) OR closed IN ('$movedids')");
+        $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid IN ($tids)");
+        $db->query("DELETE FROM d, r, v "
+                 . "USING ".X_PREFIX."vote_desc AS d "
+                 . "LEFT JOIN ".X_PREFIX."vote_results AS r ON r.vote_id = d.vote_id "
+                 . "LEFT JOIN ".X_PREFIX."vote_voters AS v  ON v.vote_id = d.vote_id "
+                 . "WHERE d.topic_id IN ($tids)");
+    }
 }
 
 if ($action == "upgrade") {
@@ -1840,8 +2001,12 @@
     if (onSubmit('upgradesubmit')) {
         $upgrade = postedVar('upgrade', '', FALSE, FALSE);
         if (isset($_FILES['sql_file'])) {
-            $add = get_attached_file($_FILES['sql_file'], 'on');
-            if ($add !== false) {
+            require('include/attach.inc.php');
+            $filename = '';
+            $filetype = '';
+            $filesize = 0;
+            $add = get_attached_file('sql_file', $filename, $filetype, $filesize, FALSE);
+            if ($add !== FALSE) {
                 $upgrade .= $add;
             }
         }
@@ -1865,8 +2030,14 @@
             }
 
             if ($explode[$num] != '') {
-                $query = $db->query($explode[$num]." -- Injected by $xmbuser using cp.php", true);
+                $query = $db->query($explode[$num]." -- Injected by $xmbuser using cp.php");
 
+                if (is_bool($query)) {
+                    $numfields = 1;
+                } else {
+                    $numfields = $db->num_fields($query);
+                }
+
                 echo '<br />';
                 ?>
                 <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
@@ -1874,10 +2045,10 @@
                 <td bgcolor="<?php echo $bordercolor?>">
                 <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
                 <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-                <td colspan="<?php echo $db->num_fields($query)?>"><strong><?php echo $lang['upgraderesults']?></strong>&nbsp;<?php echo $explode[$num]?>
+                <td colspan="<?php echo $numfields; ?>"><strong><?php echo $lang['upgraderesults']?></strong>&nbsp;<?php echo cdataOut($explode[$num]); ?>
                 <?php
                 $xn = strtoupper($explode[$num]);
-                if (strpos($xn, 'SELECT') !== false || strpos($xn, 'SHOW') !== false || strpos($xn, 'EXPLAIN') !== false || strpos($xn, 'DESCRIBE') !== false) {
+                if (!is_bool($query)) {
                     dump_query($query, true);
                 } else {
                     $selq=false;
@@ -1951,6 +2122,7 @@
 
 if ($action == "search") {
     if (onSubmit('searchsubmit')) {
+        smcwcache();
         $userip = postedVar('userip');
         $postip = postedVar('postip');
         $dblikeprofile = $db->like_escape(postedVar('profileword', '', TRUE, FALSE));
@@ -2050,7 +2222,7 @@
         ?>
         <br />
         <br />
-        <div align="center"><br /><input type="submit" class="submit" name="searchsubmit" value="Search now" /><br /><br /></div>
+        <div align="center"><br /><input type="submit" class="submit" name="searchsubmit" value="<?php echo $lang['cpsearch']; ?>" /><br /><br /></div>
         </td>
         </tr>
         </table>
@@ -2066,4 +2238,4 @@
 echo '</table></td></tr></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: cp2.php
===================================================================
--- cp2.php	(revision 1746)
+++ cp2.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -31,6 +30,8 @@
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates('error_nologinsession');
 eval('$css = "'.template('css').'";');
 
@@ -70,10 +71,22 @@
         }
         $name = str_replace(' ', '+', $themebits['name']);
         header("Content-Type: application/x-ms-download");
-        header("Content-Disposition: filename=${name}-theme.xmb");
+        header("Content-Disposition: filename=\"$name-theme.xmb\"");
         echo implode("\r\n", $contents);
         exit();
     }
+    if ($action == "lang" && $download) {
+        require('include/translation.inc.php');
+        $devname = '';
+        $contents = exportTranslation($download, $devname);
+        if ($contents === FALSE) {
+            error($lang['generic_missing']);
+        }
+        header("Content-Type: application/x-ms-download");
+        header("Content-Disposition: filename=\"$devname.lang.php\"");
+        echo $contents;
+        exit();
+    }
 }
 
 nav($lang['textcp']);
@@ -213,10 +226,315 @@
             $db->query("INSERT INTO ".X_PREFIX."restricted (`name`, `case_sensitivity`, `partial`) VALUES ('$newname', '$newcase', '$newpartial')");
         }
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['restrictedupdate'].'</td></tr>';
-        redirect('cp2.php?action=restrictions', 2);
+        redirect($full_url.'cp2.php?action=restrictions', 2);
     }
 }
 
+// Management for Translation Database
+if ($action == 'lang') {
+    if (noSubmit('importsubmit') And noSubmit('edit') And noSubmit('editsubmit') And noSubmit('detail') And noSubmit('deletesubmit')) {
+        // Default screen: Language List, Options to Install, Uninstall, and Export.
+        ?>
+        <tr bgcolor="<?php echo $altbg2?>">
+        <td align="center">
+        <form method="POST" action="cp2.php?action=lang" name="theme_main">
+        <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
+        <tr>
+        <td bgcolor="<?php echo $bordercolor?>">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <tr class="category">
+        <td align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
+        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textlanguage']; ?></font></strong></td>
+        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['translation_name']; ?></font></strong></td>
+        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['numberusing']?></font></strong></td>
+        </tr>
+        <?php
+
+        $query = $db->query("SELECT b.devname, b.langid, t.cdata, COUNT(m.uid) AS cnt "
+                          . "FROM ".X_PREFIX."lang_base AS b "
+                          . "LEFT JOIN ".X_PREFIX."lang_text AS t USING (langid) "
+                          . "INNER JOIN ".X_PREFIX."lang_keys AS k USING (phraseid) "
+                          . "LEFT JOIN ".X_PREFIX."members AS m ON m.langfile = b.devname "
+                          . "WHERE k.langkey='language' "
+                          . "GROUP BY b.langid, b.devname, t.cdata ORDER BY b.devname ASC");
+
+        while($themeinfo = $db->fetch_array($query)) {
+            $themeid = $themeinfo['langid'];
+            $members = $themeinfo['cnt'];
+            if ($themeinfo['devname'] == $langfile Or $themeinfo['devname'] == $SETTINGS['langfile']) {
+                $disabledelete = ' disabled="disabled"';
+            } else {
+                $disabledelete = '';
+            }
+
+            ?>
+            <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
+            <td align="center"><input type="checkbox" name="lang_delete[]" value="<?php echo $themeinfo['langid']?>"<?php echo $disabledelete; ?> /></td>
+            <td><input type="text" name="langname[<?php echo $themeinfo['langid']?>]" value="<?php echo $themeinfo['cdata']?>" readonly="readonly" /></td>
+            <td>
+            <input type="text" name="devname[<?php echo $themeinfo['langid']?>]" value="<?php echo $themeinfo['devname']?>" readonly="readonly" />
+            <a href="cp2.php?action=lang&amp;detail=<?php echo $themeinfo['langid']?>">
+            <?php echo $lang['textdetails']?></a>
+            -
+            <a href="cp2.php?action=lang&amp;download=<?php echo $themeinfo['langid']?>">
+            <?php echo $lang['textdownload']?>
+            </a>
+            </td>
+            <td><?php echo $members?></td>
+            </tr>
+            <?php
+        }
+        ?>
+        <tr bgcolor="<?php echo $altbg2?>">
+        <td colspan="4"><img src="./images/pixel.gif" alt="" /></td>
+        </tr>
+        <tr>
+        <td colspan="4" bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><input type="submit" name="deletesubmit" value="<?php echo $lang['textsubmitchanges']?>" class="submit" /></td>
+        </tr>
+        </table>
+        </td>
+        </tr>
+        </table>
+        </form>
+        <br />
+
+
+        <form method="post" action="cp2.php?action=lang">
+        <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
+        <tr>
+        <td bgcolor="<?php echo $bordercolor?>">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <tr class="category">
+        <td align="center"><strong><font color="<?php echo $cattext?>"><?php echo "{$lang['textedit']} - $langfile"?></font></strong></td>
+        </tr>
+        <tr>
+        <td bgcolor="<?php echo $altbg2?>" class="tablerow">
+        <?php
+        $query = $db->query("SELECT * FROM ".X_PREFIX."lang_keys ORDER BY langkey");
+        echo '<select name="phraseid"><option value="default">'.$lang['translation_select'].'</option>';
+        while($template = $db->fetch_array($query)) {
+            echo '<option value="'.$template['phraseid'].'">'.$template['langkey']."</option>\r\n";
+        }
+        echo '</select>&nbsp;&nbsp;';
+        $db->free_result($query);
+        ?>
+        </td>
+        </tr>
+        <tr>
+        <td bgcolor="<?php echo $altbg2?>" class="tablerow">
+        <input type="submit" class="submit" name="edit" value="<?php echo $lang['textedit']?>" />&nbsp;
+        </td>
+        </tr>
+        </table>
+        </td>
+        </tr>
+        </table>
+        </form>
+
+
+        <br />
+        <form method="post" action="cp2.php?action=lang" enctype="multipart/form-data">
+        <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
+        <tr>
+        <td bgcolor="<?php echo $bordercolor?>">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <tr class="category">
+        <td colspan="2" align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['translation_import']; ?></font></strong></td>
+        </tr>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['generic_file']; ?></td>
+        <td bgcolor="<?php echo $altbg2?>"><input name="themefile" type="file" /></td>
+        </tr>
+        <tr>
+        <td bgcolor="<?php echo $altbg2?>" class="tablerow" align="center" colspan="2"><input type="submit" class="submit" name="importsubmit" value="<?php echo $lang['translation_import']; ?>" /></td>
+        </tr>
+        </table>
+        </td>
+        </tr>
+        </table>
+        </form>
+        </td>
+        </tr>
+        <?php
+    }
+
+    if (onSubmit('importsubmit') && isset($_FILES['themefile']['tmp_name'])) { // Handle upload of new translation file.
+
+        // Retrieve uploaded file
+        require('include/attach.inc.php');
+        $filename = '';
+        $filetype = '';
+        $filesize = 0;
+        $upload = get_attached_file('themefile', $filename, $filetype, $filesize, FALSE);
+        if ($upload === FALSE) {
+            error($lang['langimportfail'], FALSE);
+        }
+
+        // Install uploaded file
+        require('include/translation.inc.php');
+        $result = installNewTranslation($upload);
+        
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>';
+        if ($result) {
+            echo $lang['langimportsuccess'];
+        } else {
+            echo $lang['langimportfail'];
+        }
+        echo '</td></tr>';
+    }
+    
+    if (onSubmit('edit') && noSubmit('editsubmit')) {
+        $phraseid = getInt('phraseid', 'r');
+        $result = $db->query("SELECT * FROM ".X_PREFIX."lang_keys WHERE phraseid=$phraseid");
+        if ($db->num_rows($result) == 0) {
+            error($lang['generic_missing'], FALSE);
+        }
+        $row = $db->fetch_array($result);
+        $langkey = $row['langkey'];
+
+        $result = $db->query("SELECT t.cdata "
+                           . "FROM ".X_PREFIX."lang_text AS t "
+                           . "LEFT JOIN ".X_PREFIX."lang_base AS b USING (langid) "
+                           . "WHERE t.phraseid=$phraseid AND b.devname='$langfile'");
+        if ($db->num_rows($result) == 1) {
+            $row = $db->fetch_array($result);
+            $value = cdataOut($row['cdata']); //Escape for use in the form field.
+        } else {
+            $value = '';
+        }
+        
+        ?>
+        <tr bgcolor="<?php echo $altbg2?>">
+        <td align="center">
+        <form method="post" action="cp2.php?action=lang">
+        <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
+        <tr>
+        <td bgcolor="<?php echo $bordercolor?>">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <tr class="category">
+        <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['translations']; ?></font></strong></td>
+        </tr>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td><?php echo $lang['translation_phrase'].':'; ?>&nbsp;<strong><?php echo "$langkey ($langfile)"; ?></strong></td>
+        </tr>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg1?>">
+        <td><textarea cols="100" rows="15" name="templatenew">
+<?php // Linefeed required here - Do not edit!
+        echo $value;
+        ?></textarea></td>
+        </tr>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td>
+         <input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" />
+         <input type="hidden" name="phraseid" value="<?php echo $phraseid; ?>">
+        </td>
+        </tr>
+        </table>
+        </td>
+        </tr>
+        </table>
+        </form>
+        </td>
+        </tr>
+        <?php
+
+    }
+
+    if (onSubmit('editsubmit')) {
+        require('include/translation.inc.php');
+
+        $phraseid = getInt('phraseid', 'p');
+        $newvalue = postedVar('templatenew', '', FALSE); // HTML is always allowed in translations.
+
+        if (!setLangValue($phraseid, $newvalue)) {
+            error($lang['generic_missing'], FALSE);
+        }
+
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['translation_update'].'</td></tr>';
+        redirect($full_url.'cp2.php?action=lang', 2, X_REDIRECT_JS);
+    }
+
+    if (onSubmit('detail')) {
+        $langid = getInt('detail');
+        
+        $result = $db->query("SELECT devname FROM ".X_PREFIX."lang_base WHERE langid='$langid'");
+        if ($db->num_rows($result) == 0) {
+            error($lang['generic_missing'], FALSE);
+        }
+        $row = $db->fetch_array($result);
+        $db->free_result($result);
+        $devname = $row['devname'];
+        
+        $db->query("UPDATE ".X_PREFIX."members SET langfile='$devname' WHERE username='$xmbuser'");
+
+        $query = "SELECT k.langkey, k.phraseid, COUNT(t.cdata) AS phrasecount "
+               . "FROM ".X_PREFIX."lang_keys AS k "
+               . "CROSS JOIN ".X_PREFIX."lang_base AS b "
+               . "LEFT JOIN ".X_PREFIX."lang_text AS t USING (phraseid, langid) "
+               . "WHERE b.langid=$langid "
+               . "GROUP BY k.phraseid, k.langkey ORDER BY k.langkey";
+        $query = $db->query($query);
+
+        ?>
+        <tr bgcolor="<?php echo $altbg2?>">
+        <td align="center">
+        <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
+        <tr>
+        <td bgcolor="<?php echo $bordercolor?>">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <tr class="category">
+        <td align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['translation_phrase']; ?></font></strong></td>
+        <td colspan="2" align="center"><strong><font color="<?php echo $cattext?>"><?php echo $devname; ?></font></strong></td>
+        </tr>
+        <?php
+
+        while($row = $db->fetch_array($query)) {
+            $langkey = $row['langkey'];
+
+            ?>
+            <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
+            <td><?php echo $langkey; ?></td>
+            <?php if ($row['phrasecount'] == 0) { ?>
+            <td></td>
+            <td><a href="cp2.php?action=lang&amp;edit=edit&amp;phraseid=<?php echo $row['phraseid']; ?>"><?php echo $lang['textnewcode']; ?></a></td>
+            </tr>
+            <?php } else { ?>
+            <td><a href="cp2.php?action=lang&amp;edit=edit&amp;phraseid=<?php echo $row['phraseid']; ?>"><?php echo $lang['textedit']; ?></a></td>
+            <td></td>
+            </tr>
+            <?php }
+        }
+        ?>
+        </table>
+        </td>
+        </tr>
+        </table>
+        </td>
+        </tr>
+        <?php
+    }
+
+    if (onSubmit('deletesubmit')) {
+        $theme_delete = postedArray('lang_delete', 'int');
+        $result = $db->query("SELECT langid FROM ".X_PREFIX."lang_base WHERE devname='$langfile' OR devname='{$SETTINGS['langfile']}'");
+        $lockIDs = array();
+        while($row = $db->fetch_array($result)) {
+            $lockIDs[] = $row['langid'];
+        }
+
+        if ($theme_delete) {
+            foreach($theme_delete as $deleteid) {
+                if (!in_array($deleteid, $lockIDs)) {
+                    $db->query("DELETE FROM ".X_PREFIX."lang_text WHERE langid=$deleteid");
+                    $db->query("DELETE FROM ".X_PREFIX."lang_base WHERE langid=$deleteid");
+                }
+            }
+            $db->query('OPTIMIZE TABLE '.X_PREFIX.'lang_text');
+        }
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['translation_delete'].'</td></tr>';
+    }
+}
+
 if ($action == 'themes') {
     $single = '';
     $single_str = postedVar('single', '', FALSE, FALSE, FALSE, 'g');
@@ -253,18 +571,15 @@
 
             if ($themeinfo['themeid'] == $SETTINGS['theme']) {
                 $members = ($themeMem[$themeid]+$themeMem[0]);
+                $disable = 'disabled="disabled"';
             } else {
                 $members = $themeMem[$themeid];
+                $disable = '';
             }
 
-            if ($themeinfo['themeid'] == $theme) {
-                $checked = 'checked="checked"';
-            } else {
-                $checked = 'checked="unchecked"';
-            }
             ?>
             <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-            <td align="center"><input type="checkbox" name="theme_delete[]" value="<?php echo $themeinfo['themeid']?>" /></td>
+            <td align="center"><input type="checkbox" name="theme_delete[]" value="<?php echo $themeinfo['themeid']?>" <?php echo $disable; ?> /></td>
             <td>
             <input type="text" name="theme_name[<?php echo $themeinfo['themeid']?>]" value="<?php echo $themeinfo['name']?>" />
             <a href="cp2.php?action=themes&amp;single=<?php echo $themeinfo['themeid']?>">
@@ -323,7 +638,7 @@
         <td bgcolor="<?php echo $altbg2?>"><input name="themefile" type="file" /></td>
         </tr>
         <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="tablerow" align="center" colspan="2"><input type="submit" class="submit" name="importsubmit" value="<?php echo $lang['textimportsubmit']?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>" class="tablerow" align="center" colspan="2"><input type="submit" class="submit" name="importsubmit" value="<?php echo $lang['textimporttheme']; ?>" /></td>
         </tr>
         </table>
         </td>
@@ -335,8 +650,11 @@
         <?php
     }
 
-    if (onSubmit('importsubmit') && isset($themefile['tmp_name'])) {
-        $themebits = readFileAsINI($themefile['tmp_name']);
+    if (onSubmit('importsubmit') && isset($_FILES['themefile']['tmp_name'])) {
+        if (!is_uploaded_file($_FILES['themefile']['tmp_name'])) {
+            error($lang['textthemeimportfail'], FALSE);
+        }
+        $themebits = readFileAsINI($_FILES['themefile']['tmp_name']);
         $start = "INSERT INTO ".X_PREFIX."themes";
 
         $keysql = array();
@@ -345,16 +663,16 @@
             if ($key == 'themeid') {
                 $val = '';
             } else if ($key == 'name') {
-                $name = $val;
+                $dbname = $db->escape_var($val);
             }
-            $keysql[] = $key;
-            $valsql[] = "'$val'";
+            $keysql[] = $db->escape_var($key);
+            $valsql[] = "'".$db->escape_var($val)."'";
         }
 
         $keysql = implode(', ', $keysql);
         $valsql = implode(', ', $valsql);
 
-        $query = $db->query("SELECT COUNT(themeid) FROM ".X_PREFIX."themes WHERE name='".addslashes($name)."'");
+        $query = $db->query("SELECT COUNT(themeid) FROM ".X_PREFIX."themes WHERE name='$dbname'");
         if ($db->result($query, 0) > 0) {
             error($lang['theme_already_exists'], false, '</td></tr></table></td></tr></table>');
         }
@@ -370,8 +688,8 @@
         }
         echo '</td></tr>';
     } else if (onSubmit('themesubmit')) {
-        $theme_delete = formArray('theme_delete');
-        $theme_name = formArray('theme_name');
+        $theme_delete = postedArray('theme_delete', 'int');
+        $theme_name = postedArray('theme_name', 'string', 'javascript', TRUE, TRUE, TRUE);
 
         $number_of_themes = $db->result($db->query("SELECT count(themeid) FROM ".X_PREFIX."themes"), 0);
 
@@ -381,14 +699,11 @@
 
         if ($theme_delete) {
             foreach($theme_delete as $themeid) {
-                $otherid = $db->result($db->query("SELECT themeid FROM ".X_PREFIX."themes WHERE themeid != '$themeid' ORDER BY rand() LIMIT 1"), 0);
-                $db->query("UPDATE ".X_PREFIX."members SET theme='$otherid' WHERE theme='$themeid'");
-                $db->query("UPDATE ".X_PREFIX."forums SET theme=0 WHERE theme='$themeid'");
-
-                if ($SETTINGS['theme'] == $themeid) {
-                    $db->query("UPDATE ".X_PREFIX."settings SET theme='$otherid'");
+                if ($themeid != $SETTINGS['theme']) {
+                    $db->query("UPDATE ".X_PREFIX."members SET theme=0 WHERE theme='$themeid'");
+                    $db->query("UPDATE ".X_PREFIX."forums SET theme=0 WHERE theme='$themeid'");
+                    $db->query("DELETE FROM ".X_PREFIX."themes WHERE themeid='$themeid'");
                 }
-                $db->query("DELETE FROM ".X_PREFIX."themes WHERE themeid='$themeid'");
             }
         }
 
@@ -503,6 +818,10 @@
         <td colspan="2"><input type="text"  value="<?php echo $themestuff['imgdir']?>" name="imgdirnew" /></td>
         </tr>
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
+        <td><?php echo $lang['imgdiradm']?></td>
+        <td colspan="2"><input type="text"  value="<?php echo $themestuff['admdir']?>" name="admdirnew" /></td>
+        </tr>
+        <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['smdir']?></td>
         <td colspan="2"><input type="text"  value="<?php echo $themestuff['smdir']?>" name="smdirnew" /></td>
         </tr>
@@ -607,8 +926,12 @@
         <td><input type="text" name="imgdirnew" value="images" /></td>
         </tr>
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
+        <td><?php echo $lang['imgdiradm']?></td>
+        <td><input type="text" name="admdirnew" value="images/admin" /></td>
+        </tr>
+        <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['smdir']?></td>
-        <td><input type="text" name="smdirnew" value="images" /></td>
+        <td><input type="text" name="smdirnew" value="images/smilies" /></td>
         </tr>
         <tr class="ctrtablerow">
         <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="newtheme" value="true" /></td>
@@ -642,9 +965,10 @@
         $fsizenew = postedVar('fsizenew');
         $boardlogonew = postedVar('boardlogonew');
         $imgdirnew = postedVar('imgdirnew');
+        $admdirnew = postedVar('admdirnew');
         $smdirnew = postedVar('smdirnew');
 
-        $db->query("UPDATE ".X_PREFIX."themes SET name='$namenew', bgcolor='$bgcolornew', altbg1='$altbg1new', altbg2='$altbg2new', link='$linknew', bordercolor='$bordercolornew', header='$headernew', headertext='$headertextnew', top='$topnew', catcolor='$catcolornew', tabletext='$tabletextnew', text='$textnew', borderwidth='$borderwidthnew', tablewidth='$tablewidthnew', tablespace='$tablespacenew', fontsize='$fsizenew', font='$fnew', boardimg='$boardlogonew', imgdir='$imgdirnew', smdir='$smdirnew', cattext='$cattextnew' WHERE themeid='$orig'");
+        $db->query("UPDATE ".X_PREFIX."themes SET name='$namenew', bgcolor='$bgcolornew', altbg1='$altbg1new', altbg2='$altbg2new', link='$linknew', bordercolor='$bordercolornew', header='$headernew', headertext='$headertextnew', top='$topnew', catcolor='$catcolornew', tabletext='$tabletextnew', text='$textnew', borderwidth='$borderwidthnew', tablewidth='$tablewidthnew', tablespace='$tablespacenew', fontsize='$fsizenew', font='$fnew', boardimg='$boardlogonew', imgdir='$imgdirnew', smdir='$smdirnew', cattext='$cattextnew', admdir='$admdirnew' WHERE themeid='$orig'");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
     } else if ($single_str == "submit" && $newtheme) {
         $namenew = postedVar('namenew');
@@ -667,9 +991,10 @@
         $fsizenew = postedVar('fsizenew');
         $boardlogonew = postedVar('boardlogonew');
         $imgdirnew = postedVar('imgdirnew');
+        $admdirnew = postedVar('admdirnew');
         $smdirnew = postedVar('smdirnew');
 
-        $db->query("INSERT INTO ".X_PREFIX."themes (name, bgcolor, altbg1, altbg2, link, bordercolor, header, headertext, top, catcolor, tabletext, text, borderwidth, tablewidth, tablespace, font, fontsize, boardimg, imgdir, smdir, cattext) VALUES('$namenew', '$bgcolornew', '$altbg1new', '$altbg2new', '$linknew', '$bordercolornew', '$headernew', '$headertextnew', '$topnew', '$catcolornew', '$tabletextnew', '$textnew', '$borderwidthnew', '$tablewidthnew', '$tablespacenew', '$fnew', '$fsizenew', '$boardlogonew', '$imgdirnew', '$smdirnew', '$cattextnew')");
+        $db->query("INSERT INTO ".X_PREFIX."themes (name, bgcolor, altbg1, altbg2, link, bordercolor, header, headertext, top, catcolor, tabletext, text, borderwidth, tablewidth, tablespace, font, fontsize, boardimg, imgdir, smdir, cattext, admdir) VALUES('$namenew', '$bgcolornew', '$altbg1new', '$altbg2new', '$linknew', '$bordercolornew', '$headernew', '$headertextnew', '$topnew', '$catcolornew', '$tabletextnew', '$textnew', '$borderwidthnew', '$tablewidthnew', '$tablespacenew', '$fnew', '$fsizenew', '$boardlogonew', '$imgdirnew', '$smdirnew', '$cattextnew', '$admdirnew')");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
     }
 }
@@ -765,16 +1090,16 @@
         </tr>
         <?php
     } else {
-        $smdelete = formArray('smdelete');
-        $smcode = formArray('smcode');
-        $smurl = formArray('smurl');
+        $smdelete = postedArray('smdelete', 'int');
+        $smcode = postedArray('smcode', 'string', 'javascript', TRUE, TRUE, TRUE);
+        $smurl = postedArray('smurl', 'string', 'javascript', TRUE, TRUE, TRUE);
 
         $newcode = postedVar('newcode');
         $newurl1 = postedVar('newurl1');
         $autoinsertsmilies = formInt('autoinsertsmilies');
 
-        $pidelete = formArray('pidelete');
-        $piurl = formArray('piurl');
+        $pidelete = postedArray('pidelete', 'int');
+        $piurl = postedArray('piurl', 'string', 'javascript', TRUE, TRUE, TRUE);
 
         $newurl2 = postedVar('newurl2');
         $autoinsertposticons = formInt('autoinsertposticons');
@@ -997,7 +1322,7 @@
             ?>
             <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
             <td class="tablerow" align="center"><input type="checkbox" name="delete[<?php echo $rank['id']?>]" value="<?php echo $rank['id']?>" <?php echo $staff_disable?> /></td>
-            <td class="tablerow" align="left"><input type="text" name="title[<?php echo $rank['id']?>]" value="<?php echo $rank['title']?>" <?php echo $staff_disable?>/></td>
+            <td class="tablerow" align="left"><input type="text" name="title[<?php echo $rank['id']?>]" value="<?php echo attrOut($rank['title']); ?>" <?php echo $staff_disable?>/></td>
             <td class="tablerow"><input type="text" name="posts[<?php echo $rank['id']?>]" value="<?php echo $rank['posts']?>" <?php echo $staff_disable?> size="5" /></td>
             <td class="tablerow"><input type="text" name="stars[<?php echo $rank['id']?>]" value="<?php echo $rank['stars']?>" size="4" /></td>
             <td class="tablerow"><select name="allowavatars[<?php echo $rank['id']?>]">
@@ -1031,18 +1356,18 @@
         </tr>
         <?php
     } else {
-        $id = formArray('id');
-        $delete = formArray('delete');
-        $title = formArray('title');
-        $posts = formArray('posts');
-        $stars = formArray('stars');
-        $allowavatars = formArray('allowavatars');
-        $avaurl = formArray('avaurl');
-        $newtitle = postedVar('newtitle');
+        $id = postedArray('id', 'int');
+        $delete = postedArray('delete', 'int');
+        $title = postedArray('title', 'string', '', FALSE);
+        $posts = postedArray('posts', 'int');
+        $stars = postedArray('stars', 'int');
+        $allowavatars = postedArray('allowavatars', 'yesno');
+        $avaurl = postedArray('avaurl', 'string', 'javascript', TRUE, TRUE, TRUE);
+        $newtitle = postedVar('newtitle', '', FALSE);
         $newposts = formInt('newposts');
         $newstars = formInt('newstars');
         $newallowavatars = formYesNo('newallowavatars');
-        $newavaurl = postedVar('newavaurl');
+        $newavaurl = postedVar('newavaurl', 'javascript', TRUE, TRUE, TRUE);
 
         $query = $db->query("SELECT * FROM ".X_PREFIX."ranks");
         $staffranks = array();
@@ -1147,7 +1472,7 @@
         $wait = formInt('wait');
 
         if ($newscopy != 'yes') {
-            $tome = 'AND NOT username=\''.$xmbuser.'\'';
+            $tome = "AND NOT username='$xmbuser'";
         } else {
             $tome = '';
         }
@@ -1166,22 +1491,23 @@
 
         if ($sendvia == "u2u") {
             while($memnews = $db->fetch_array($query)) {
-                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('".addslashes($memnews['username'])."', '$xmbuser', 'incoming', '".addslashes($memnews['username'])."', 'Inbox', '$newssubject', '$newsmessage', '" . time() . "', 'no', 'yes')");
+                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('".$db->escape_var($memnews['username'])."', '$xmbuser', 'incoming', '".$db->escape_var($memnews['username'])."', 'Inbox', '$newssubject', '$newsmessage', '" . time() . "', 'no', 'yes')");
             }
+            echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[newslettersubmit]</td></tr>";
         } else {
-            $newssubject = stripslashes(stripslashes($newssubject));
-            $newsmessage = stripslashes(stripslashes($newsmessage));
+            $rawnewssubject = postedVar('newssubject', '', FALSE, FALSE);
+            $rawnewsmessage = postedVar('newsmessage', '', FALSE, FALSE);
+            $rawuser = htmlspecialchars_decode($self['username'], ENT_QUOTES);
+            $headers = array();
             $headers[] = "From: $bbname <$adminemail>";
-            $headers[] = "X-Sender: <$adminemail>";
             $headers[] = 'X-Mailer: PHP';
-            $headers[] = 'X-AntiAbuse: Board servername - '.$bbname;
-            $headers[] = 'X-AntiAbuse: Username - '.$xmbuser;
-            $headers[] = 'X-Priority: 2';
-            $headers[] = "Return-Path: <$adminemail>";
+            $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+            $headers[] = 'X-AntiAbuse: Username - '.$rawuser;
             $headers[] = 'Content-Type: text/plain; charset='.$charset;
             $headers = implode("\r\n", $headers);
 
             $i = 0;
+            $total = 0;
             @ignore_user_abort(1);
             @set_time_limit(0);
             @ob_implicit_flush(1);
@@ -1191,13 +1517,19 @@
                     sleep(3);
                     $i = 0;
                 } else {
+                    if ($total % 250 == 0) {
+                        error_log("XMB Notice: $total newsletter e-mails transmitted by $rawuser");
+                    }
                     $i++;
                 }
 
-                altMail($memnews['email'], '['.$bbname.'] '.$newssubject, $newsmessage, $headers);
+                $rawemail = htmlspecialchars_decode($memnews['email'], ENT_QUOTES);
+                altMail($rawemail, '['.$bbname.'] '.$rawnewssubject, $rawnewsmessage, $headers);
+                $total++;
             }
+            error_log("XMB Notice: $total newsletter e-mails transmitted by $rawuser");
+            echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[newslettersubmit] {$lang['textsent']} $total</td></tr>";
         }
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[newslettersubmit]</td></tr>";
     }
 }
 
@@ -1311,12 +1643,12 @@
         </tr>
         <?php
     } else {
-        $pruneByDate = formArray('pruneByDate');
-        $pruneByPosts = formArray('pruneByPosts');
+        $pruneByDate = postedArray('pruneByDate');
+        $pruneByPosts = postedArray('pruneByPosts');
         $pruneFrom = postedVar('pruneFrom', '', FALSE, FALSE);
         $pruneFromList = postedArray('pruneFromList', 'int');
         $pruneFromFid = postedVar('pruneFromFid', '', FALSE, FALSE);
-        $pruneType = formArray('pruneType');
+        $pruneType = postedArray('pruneType', 'int');
 
         $queryWhere = array();
         // let's check what to prune first
@@ -1401,6 +1733,7 @@
         }
 
         if (count($queryWhere) > 0) {
+            require('include/attach-admin.inc.php');
             $tids = array();
             $queryWhere = implode(' AND ', $queryWhere);
             $q = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE ".$queryWhere);
@@ -1409,15 +1742,28 @@
                     $tids[] = $t['tid'];
                 }
                 $tids = implode(',', $tids);
+                deleteMultiThreadAttachments($tids); // Must delete attachments before posts!
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN ($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."favorites WHERE IN ($tids)");
+
+                $db->query("DELETE FROM d, r, v "
+                         . "USING ".X_PREFIX."vote_desc AS d "
+                         . "LEFT JOIN ".X_PREFIX."vote_results AS r ON r.vote_id = d.vote_id "
+                         . "LEFT JOIN ".X_PREFIX."vote_voters AS v  ON v.vote_id = d.vote_id "
+                         . "WHERE d.topic_id IN ($tids)");
+
                 $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN ($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN ($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid IN ($tids)");
             }
         } else {
-            $db->query("TRUNCATE TABLE ".X_PREFIX."threads");
             $db->query("TRUNCATE TABLE ".X_PREFIX."attachments");
             $db->query("TRUNCATE TABLE ".X_PREFIX."posts");
+            $db->query("TRUNCATE TABLE ".X_PREFIX."favorites");
+            $db->query("TRUNCATE TABLE ".X_PREFIX."vote_results");
+            $db->query("TRUNCATE TABLE ".X_PREFIX."vote_voters");
+            $db->query("TRUNCATE TABLE ".X_PREFIX."vote_desc");
+            $db->query("TRUNCATE TABLE ".X_PREFIX."threads");
             $db->query("UPDATE ".X_PREFIX."members SET postnum=0");
+            $db->query("UPDATE ".X_PREFIX."forums SET posts=0, threads=0, lastpost=''");
         }
         echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[forumpruned]</td></tr>";
     }
@@ -1445,11 +1791,11 @@
         <tr>
         <td bgcolor="<?php echo $altbg2?>" class="tablerow">
         <?php
-        $query = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name");
+        $query = $db->query("SELECT id, name FROM ".X_PREFIX."templates ORDER BY name");
         echo '<select name="tid"><option value="default">'.$lang['selecttemplate'].'</option>';
         while($template = $db->fetch_array($query)) {
             if (!empty($template['name'])) {
-                echo '<option value="'.intval($template['id']).'">'.stripslashes($template['name']).'</option>\r\n';
+                echo '<option value="'.intval($template['id']).'">'.$template['name']."</option>\r\n";
             }
         }
         echo '</select>&nbsp;&nbsp;';
@@ -1507,23 +1853,26 @@
         if (!file_exists('./templates.xmb')) {
             error($lang['no_templates'], false, '</td></tr></table></td></tr></table><br />');
         }
+
+        $templates = explode("|#*XMB TEMPLATE FILE*#|", file_get_contents(ROOT.'templates.xmb'));
+
         $db->query("TRUNCATE ".X_PREFIX."templates");
 
-        $filesize=filesize('templates.xmb');
-        $fp=fopen('templates.xmb','r');
-        $templatesfile=fread($fp,$filesize);
-        fclose($fp);
-
-        $templates = explode("|#*XMB TEMPLATE FILE*#|", $templatesfile);
-        while(list($key,$val) = each($templates)) {
+        $values = array();
+        foreach($templates as $val) {
             $template = explode("|#*XMB TEMPLATE*#|", $val);
-            $template[1] = isset($template[1]) ? addslashes($template[1]) : '';
-            $db->query("INSERT INTO ".X_PREFIX."templates (name, template) VALUES ('".addslashes($template[0])."', '".addslashes($template[1])."')");
+            $template[1] = isset($template[1]) ? addslashes(ltrim($template[1])) : '';
+            $values[] = "('".$db->escape_var($template[0])."', '".$db->escape_var($template[1])."')";
         }
+        unset($templates);
+        if (count($values) > 0) {
+            $values = implode(', ', $values);
+            $db->query("INSERT INTO ".X_PREFIX."templates (name, template) VALUES $values");
+        }
 
         $db->query("DELETE FROM ".X_PREFIX."templates WHERE name=''");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesrestoredone'].'</td></tr>';
-        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
+        redirect($full_url.'cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('edit') && noSubmit('editsubmit')) {
@@ -1549,10 +1898,13 @@
         $db->free_result($query);
         ?>
         <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
-        <td><?php echo $lang['templatename']?>&nbsp;<strong><?php echo stripslashes($template['name'])?></strong></td>
+        <td><?php echo $lang['templatename']?>&nbsp;<strong><?php echo $template['name']; ?></strong></td>
         </tr>
         <tr class="ctrtablerow" bgcolor="<?php echo $altbg1?>">
-        <td><textarea cols="100" rows="30" name="templatenew"><?php echo stripslashes(htmlspecialchars($template['template']))?></textarea></td>
+        <td><textarea cols="100" rows="30" name="templatenew">
+<?php // Linefeed required here - Do not edit!
+        echo cdataOut(stripslashes($template['template']));
+        ?></textarea></td>
         </tr>
         <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
         <td><input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></strong></td>
@@ -1570,8 +1922,8 @@
     if (onSubmit('editsubmit')) {
         $tid = postedVar('tid', '', FALSE, FALSE, FALSE, 'g');
         $namenew = postedVar('namenew');
-        //Templates are double-slashed so that they can be eval'd as raw strings.
-        $templatenew = $db->escape(getRequestVar('templatenew'));
+        //Templates are historically double-slashed.
+        $templatenew = $db->escape(addslashes(postedVar('templatenew', '', FALSE, FALSE)));
 
         if ($tid == 'new') {
             if (!$namenew) {
@@ -1589,7 +1941,7 @@
             $db->query("UPDATE ".X_PREFIX."templates SET template='$templatenew' WHERE id=$tid");
         }
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesupdate'].'</td></tr>';
-        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
+        redirect($full_url.'cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('delete')) {
@@ -1628,10 +1980,11 @@
         $tid = getInt('tid', 'r');
         $db->query("DELETE FROM ".X_PREFIX."templates WHERE id=$tid");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesdelete'].'</td></tr>';
-        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
+        redirect($full_url.'cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('new')) {
+        $newtemplatename = postedVar('newtemplatename', 'javascript', TRUE, FALSE, TRUE);
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1722,15 +2075,16 @@
     }
 
     if (onSubmit('searchsubmit')) {
+        require('include/attach.inc.php');
         $dblikefilename = $db->like_escape(postedVar('filename', '', FALSE, FALSE));
         $author = postedVar('author');
         $forumprune = postedVar('forumprune');
         $forumprune = $forumprune == 'all' ? '' : intval($forumprune);
-        $sizeless = formInt('sizeless');
-        $sizemore = formInt('sizemore');
-        $dlcountless = formInt('dlcountless');
-        $dlcountmore = formInt('dlcountmore');
-        $daysold = formInt('daysold');
+        $sizeless = formInt('sizeless', FALSE);
+        $sizemore = formInt('sizemore', FALSE);
+        $dlcountless = formInt('dlcountless', FALSE);
+        $dlcountmore = formInt('dlcountmore', FALSE);
+        $daysold = formInt('daysold', FALSE);
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1743,10 +2097,10 @@
         <td class="category" colspan="6"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textattachsearchresults']?></strong></font></td>
         </tr>
         <tr>
-        <td class="header" width="4%" align="center">?</td>
         <td class="header" width="25%"><?php echo $lang['textfilename']?></td>
-        <td class="header" width="29%"><?php echo $lang['textauthor']?></td>
+        <td class="header" width="19%"><?php echo $lang['textauthor']?></td>
         <td class="header" width="27%"><?php echo $lang['textinthread']?></td>
+        <td class="header" width="10%"><?php echo $lang['textlocation']?></td>
         <td class="header" width="10%"><?php echo $lang['textfilesize']?></td>
         <td class="header" width="5%"><?php echo $lang['textdownloads']?></td>
         </tr>
@@ -1754,71 +2108,141 @@
         $restriction = '';
         $orderby = '';
 
-        if ($forumprune) {
-            $restriction .= "AND t.fid=$forumprune ";
-        }
-
-        if ($daysold) {
-            $datethen = $onlinetime - (86400 * $daysold);
-            $restriction .= "AND p.dateline <= $datethen ";
-            $orderby = ' ORDER BY p.dateline ASC';
-        }
-
-        if ($author) {
-            $restriction .= "AND p.author = '$author' ";
-            $orderby = ' ORDER BY p.author ASC';
-        }
-
         if ($dblikefilename != '') {
             $restriction .= "AND a.filename LIKE '%$dblikefilename%' ";
         }
 
-        if ($sizeless) {
+        if ($sizeless !== '') {
             $restriction .= "AND a.filesize < $sizeless ";
             $orderby = ' ORDER BY a.filesize DESC';
         }
 
-        if ($sizemore) {
+        if ($sizemore !== '') {
             $restriction .= "AND a.filesize > $sizemore ";
             $orderby = ' ORDER BY a.filesize DESC';
         }
 
-        if ($dlcountless) {
+        if ($dlcountless !== '') {
             $restriction .= "AND a.downloads < $dlcountless ";
             $orderby = ' ORDER BY a.downloads DESC';
         }
 
-        if ($dlcountmore) {
+        if ($dlcountmore !== '') {
             $restriction .= "AND a.downloads > $dlcountmore ";
             $orderby = ' ORDER BY a.downloads DESC ';
         }
+        
+        $restriction2 = 'WHERE b.parentid!=0 '.$restriction;
 
-        $query = $db->query("SELECT a.aid, a.pid, a.filename, LENGTH(a.attachment) AS rowsize, a.downloads, p.author, p.tid, t.fid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a LEFT JOIN ".X_PREFIX."posts p USING (pid) LEFT JOIN ".X_PREFIX."threads t ON t.tid=p.tid LEFT JOIN ".X_PREFIX."forums f ON f.fid=t.fid WHERE 1=1 $restriction $orderby");
+        if ($forumprune) {
+            $restriction .= "AND t.fid=$forumprune ";
+        }
+
+        if ($daysold !== '') {
+            $datethen = $onlinetime - (86400 * $daysold);
+            $restriction .= "AND p.dateline <= $datethen ";
+            $orderby = ' ORDER BY p.dateline ASC';
+        }
+
+        if ($author) {
+            $restriction .= "AND p.author = '$author' ";
+            $orderby = ' ORDER BY p.author ASC';
+        }
+
+        $restriction1 = 'WHERE a.parentid=0 '.$restriction;
+
+        $query2 = $db->query("SELECT b.aid, b.pid, b.parentid, b.filename, b.filesize, b.downloads, b.subdir FROM ".X_PREFIX."attachments AS b "
+                           . "LEFT JOIN ".X_PREFIX."attachments AS a ON a.aid=b.parentid $restriction2");
+        
+        $query = $db->query("SELECT a.aid, a.pid, a.filename, a.filesize, a.downloads, a.subdir, p.author, p.tid, t.fid, t.subject AS tsubject, f.name AS fname, m.username "
+                          . "FROM ".X_PREFIX."attachments a "
+                          . "LEFT JOIN ".X_PREFIX."posts p USING (pid) "
+                          . "LEFT JOIN ".X_PREFIX."threads t ON t.tid=p.tid "
+                          . "LEFT JOIN ".X_PREFIX."forums f ON f.fid=t.fid "
+                          . "LEFT JOIN ".X_PREFIX."members m ON a.uid=m.uid $restriction1 $orderby");
+        $diskpath = getFullPathFromSubdir('');
+        if ($diskpath !== FALSE) {
+            $diskpath = is_dir($diskpath);
+        }
         while($attachment = $db->fetch_array($query)) {
-            $attachsize = $attachment['rowsize'];
-            if ($attachsize >= 1073741824) {
-                $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
-            } else if ($attachsize >= 1048576) {
-                $attachsize = round($attachsize / 1048576 * 100) / 100 . "mb";
-            } else if ($attachsize >= 1024) {
-                $attachsize = round($attachsize / 1024 * 100) / 100 . "kb";
-            } else {
-                $attachsize = $attachsize . "b";
-            }
+            $attachsize = getSizeFormatted($attachment['filesize']);
 
             $attachment['tsubject'] = stripslashes($attachment['tsubject']); //old databases were double-slashed
-            $attachment['fname'] = stripslashes($attachment['fname']);
+            $attachment['fname'] = fnameOut($attachment['fname']);
             $attachment['filename'] = attrOut($attachment['filename'], 'javascript');
+            $movelink = '';
+            $newthumblink = '';
+            if ($attachment['subdir'] == '') {
+                $attachment['subdir'] = 'DB';
+                if ($diskpath) {
+                    $movelink = '<a href="cp2.php?action=movetodisk_attachment&amp;aid='.$attachment['aid'].'&amp;pid='.$attachment['pid'].'">'.$lang['movetodisk'].'</a>';
+                }
+            } else {
+                $attachment['subdir'] = '/'.$attachment['subdir'].'/';
+                if ($diskpath) {
+                    $movelink = '<a href="cp2.php?action=movetodb_attachment&amp;aid='.$attachment['aid'].'&amp;pid='.$attachment['pid'].'">'.$lang['movetodb'].'</a>';
+                }
+            }
+            if ($attachment['pid'] == 0) {
+                $attachment['author'] = $attachment['username'];
+                $downloadlink = '';
+            } else {
+                $downloadlink = '<a href="'.getAttachmentURL($attachment['aid'], $attachment['pid'], $attachment['filename']).'" target="_blank">'.$lang['textdownload'].'</a>';
+                if (function_exists('imagecreatetruecolor')) {
+                    $newthumblink = '<a href="cp2.php?action=regeneratethumbnail&amp;aid='.$attachment['aid'].'&amp;pid='.$attachment['pid'].'">'.$lang['regeneratethumbnail'].'</a>';
+                }
+            }
+            $deletelink = '<a href="cp2.php?action=delete_attachment&amp;aid='.$attachment['aid'].'&amp;pid='.$attachment['pid'].'">'.$lang['deletebutton'].'</a>';
             ?>
             <tr>
-            <td bgcolor="<?php echo $altbg1?>" class="tablerow" align="center" valign="middle"><a href="cp2.php?action=delete_attachment&amp;aid=<?php echo $attachment['aid']?>">Delete</a>
-            <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><input type="text" name="filename<?php echo $attachment['aid']?>" value="<?php echo $attachment['filename']?>"><br /><span class="smalltxt"><a href="viewthread.php?action=attachment&amp;tid=<?php echo $attachment['tid']?>&amp;pid=<?php echo $attachment['pid']?>" target="_blank"><?php echo $lang['textdownload']?></a></td>
+            <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><input type="text" name="filename<?php echo $attachment['aid']?>" value="<?php echo $attachment['filename']?>">
+                <br /><span class="smalltxt"><?php echo $downloadlink; ?> - <?php echo $movelink; ?> - <?php echo $newthumblink; ?> - <?php echo $deletelink; ?></span></td>
             <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><?php echo $attachment['author']?></td>
-            <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><a href="viewthread.php?tid=<?php echo $attachment['tid']?>"><?php echo $attachment['tsubject']?></a><br /><span class="smalltxt"><?php echo $lang['textinforum']?> <a href="forumdisplay.php?fid=<?php echo $attachment['fid']?>"><?php echo $attachment['fname']?></a></span></td>
+            <?php if ($attachment['pid'] == 0) { ?>
+                <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"></td>
+            <?php } else { ?>
+                <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><a href="viewthread.php?tid=<?php echo $attachment['tid']?>"><?php echo $attachment['tsubject']?></a><br /><span class="smalltxt"><?php echo $lang['textinforum']?> <a href="forumdisplay.php?fid=<?php echo $attachment['fid']?>"><?php echo $attachment['fname']?></a></span></td>
+            <?php } ?>
+            <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $attachment['subdir']?></td>
             <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $attachsize?></td>
             <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $attachment['downloads']?></td>
             </tr>
             <?php
+            if ($db->num_rows($query2) > 0) {
+                $db->data_seek($query2, 0);
+            }
+            while($child = $db->fetch_array($query2)) {
+                if ($child['parentid'] == $attachment['aid'] And substr($child['filename'], -10) == '-thumb.jpg') {
+                    $attachsize = getSizeFormatted($child['filesize']);
+                    $movelink = '';
+                    if ($child['subdir'] == '') {
+                        $child['subdir'] = 'DB';
+                        if ($diskpath) {
+                            $movelink = '<a href="cp2.php?action=movetodisk_attachment&amp;aid='.$child['aid'].'&amp;pid='.$child['pid'].'">'.$lang['movetodisk'].'</a>';
+                        }
+                    } else {
+                        $child['subdir'] = '/'.$child['subdir'].'/';
+                        if ($diskpath) {
+                            $movelink = '<a href="cp2.php?action=movetodb_attachment&amp;aid='.$child['aid'].'&amp;pid='.$child['pid'].'">'.$lang['movetodb'].'</a>';
+                        }
+                    }
+                    if ($child['pid'] == 0) {
+                        $downloadlink = $lang['thumbnail'];
+                    } else {
+                        $downloadlink = '<a href="'.getAttachmentURL($child['aid'], $child['pid'], $child['filename']).'" target="_blank">'.$lang['thumbnail'].'</a>';
+                    }
+                    ?>
+                        <tr>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"><span class="smalltxt"><?php echo $downloadlink; ?> - <?php echo $movelink; ?></span></td>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"></td>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top"></td>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $child['subdir']?></td>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $attachsize?></td>
+                        <td bgcolor="<?php echo $altbg2?>" class="tablerow" valign="top" align="center"><?php echo $child['downloads']?></td>
+                        </tr>
+                    <?php
+                }
+            }
         }
         ?>
         <tr>
@@ -1835,21 +2259,21 @@
     }
 
     if (onSubmit('deletesubmit')) {
-        $filelist = '';
+        require('include/attach.inc.php');
+        $filelist = array();
         foreach($_POST as $postedname => $rawvalue) {
             if (substr($postedname, 0, 8) == 'filename' And is_numeric($fileaid = substr($postedname, 8))) {
-                $filelist .= $fileaid.', ';
+                $filelist[] = $fileaid;
             }
         }
-        $filelist = substr($filelist, 0, -2);
+        $filelist = implode(', ', $filelist);
 
-        $query = $db->query("SELECT a.aid, a.filename FROM ".X_PREFIX."attachments a WHERE a.aid IN ($filelist)");
+        $query = $db->query("SELECT aid, pid, filename FROM ".X_PREFIX."attachments WHERE aid IN ($filelist)");
         while($attachment = $db->fetch_array($query)) {
             $afilename = "filename" . $attachment['aid'];
             $postedvalue = trim(postedVar($afilename, '', FALSE, FALSE));
-            if ($attachment['filename'] != $postedvalue And isValidFilename($postedvalue)) {
-                $dbrename = $db->escape($postedvalue);
-                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$dbrename' WHERE aid={$attachment['aid']}");
+            if ($attachment['filename'] != $postedvalue) {
+                renameAttachment($attachment['aid'], $attachment['pid'], $postedvalue);
             }
         }
         echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[textattachmentsupdate]</td></tr>";
@@ -1867,8 +2291,8 @@
     <td bgcolor="<?php echo $bordercolor?>">
     <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
-    <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
-    <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
+    <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textusername']; ?>:</font></strong></td>
+    <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['texttime']; ?></font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">URL:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Action:</font></strong></td>
     </tr>
@@ -1882,6 +2306,8 @@
     $old = (($page-1)*100);
     $current = ($page*100);
 
+    $firstpage = '';
+    $lastpage = '';
     $prevpage = '';
     $nextpage = '';
     $random_var = '';
@@ -1989,11 +2415,11 @@
     <td bgcolor="<?php echo $bordercolor?>">
     <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
-    <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
-    <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
+    <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textusername']; ?>:</font></strong></td>
+    <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['texttime']; ?></font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">URL:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Action:</font></strong></td>
-    <td><strong><font color="<?php echo $cattext?>">Ip:</font></strong></td>
+    <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textip']; ?>:</font></strong></td>
     </tr>
     <?php
     $count = $db->result($db->query("SELECT count(fid) FROM ".X_PREFIX."logs WHERE (fid='0' AND tid='0')"), 0);
@@ -2004,7 +2430,9 @@
 
     $old = (($page-1)*100);
     $current = ($page*100);
+
     $firstpage = '';
+    $lastpage = '';
     $prevpage = '';
     $nextpage = '';
     $random_var = '';
@@ -2097,12 +2525,38 @@
 }
 
 if ($action == "delete_attachment") {
+    require('include/attach.inc.php');
     $aid = getInt('aid');
-    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid=$aid");
+    $pid = getInt('pid');
+    deleteAttachment($aid, $pid);
     echo "<p align=\"center\">Deleted ...</br>";
 }
 
+if ($action == "movetodb_attachment") {
+    require('include/attach-admin.inc.php');
+    $aid = getInt('aid');
+    $pid = getInt('pid');
+    moveAttachmentToDB($aid, $pid);
+    echo "<p align=\"center\">Moved ...</br>";
+}
+
+if ($action == "movetodisk_attachment") {
+    require('include/attach-admin.inc.php');
+    $aid = getInt('aid');
+    $pid = getInt('pid');
+    moveAttachmentToDisk($aid, $pid);
+    echo "<p align=\"center\">Moved ...</br>";
+}
+
+if ($action == "regeneratethumbnail") {
+    require('include/attach-admin.inc.php');
+    $aid = getInt('aid');
+    $pid = getInt('pid');
+    regenerateThumbnail($aid, $pid);
+    echo "<p align=\"center\">Done ...</br>";
+}
+
 echo '</table></td></tr></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: db/mysql.php
===================================================================
--- db/mysql.php	(revision 1746)
+++ db/mysql.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,18 +26,14 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
-/**
-* MySQL 3.x, and 4.0 database access.
-*
-* Unless you have updated client libraries or turned on backwards compatible authentication
-* this class is not compatible with MySQL 4.1 or later (which includes MySQL 5.0)
-*
-* For generic access to MySQL databases, use this class.
-* Must be instantiated before first use.
-*/
+define('SQL_NUM', MYSQL_NUM);
+define('SQL_BOTH', MYSQL_BOTH);
+define('SQL_ASSOC', MYSQL_ASSOC);
+
 class dbstuff {
     var $querynum   = 0;
     var $querylist  = array();
@@ -47,6 +42,7 @@
     var $db         = '';
     var $duration   = 0;
     var $timer      = 0;
+    var $errcallb   = 'xmb_mysql_error';
 
     function connect($dbhost="localhost", $dbuser, $dbpw, $dbname, $pconnect=0, $force_db=false) {
 
@@ -61,7 +57,8 @@
             echo 'A connection to the Database could not be established.<br />';
             echo 'Please check your username, password, database name and host.<br />';
             echo 'Also make sure <i>config.php</i> is rightly configured!<br /><br />';
-            $this->panic();
+            $sql = '';
+            $this->panic($sql);
         }
 
         unset($GLOBALS['dbhost'], $GLOBALS['dbuser'], $GLOBALS['dbpw']);
@@ -72,6 +69,7 @@
     function select_db($database, $force=true) {
         if ($force) {
             if (!mysql_select_db($database, $this->link)) {
+                header('HTTP/1.0 500 Internal Server Error');
                 exit('Could not locate database "'.$database.'". Please make sure it exists before trying again!');
                 return false;
             }
@@ -119,57 +117,118 @@
     }
 
     function free_result($query) {
-        return mysql_free_result($query);
+        set_error_handler($this->errcallb);
+        $return = mysql_free_result($query);
+        restore_error_handler();
+        return $return;
     }
 
     function fetch_array($query, $type=SQL_ASSOC) {
+        set_error_handler($this->errcallb);
         $array = mysql_fetch_array($query, $type);
+        restore_error_handler();
         return $array;
     }
 
     function field_name($query, $field) {
-        return mysql_field_name($query, $field);
+        set_error_handler($this->errcallb);
+        $return = mysql_field_name($query, $field);
+        restore_error_handler();
+        return $return;
     }
 
-    function panic($sql = '') {
+    function panic(&$sql) {
+        if (!headers_sent()) {
+            header('HTTP/1.0 500 Internal Server Error');
+        }
 
-        if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
-            // Check that we actually made a connection
-            if ($this->link === FALSE) {
-                $error = mysql_error();
-                $errno = mysql_errno();
-            } else {
-                $error = mysql_error($this->link);
-                $errno = mysql_errno($this->link);
+        // Check that we actually made a connection
+        if ($this->link === FALSE) {
+            $error = mysql_error();
+            $errno = mysql_errno();
+        } else {
+            $error = mysql_error($this->link);
+            $errno = mysql_errno($this->link);
+        }
+
+    	if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
+            require_once(ROOT.'include/validate.inc.php');
+			echo '<pre>MySQL encountered the following error: '.cdataOut($error)."(errno = ".$errno.")\n<br />";
+            if ($sql != '') {
+                echo 'In the following query: <em>'.cdataOut($sql);
             }
-
-            echo '<pre>MySQL encountered the following error: '.cdataOut($error)."(errno = ".$errno.")\n<br />".'In the following query: <em>'.cdataOut($sql).'</em></pre>';
+            echo '</em></pre>';
         } else {
-            echo '<pre>The system has failed to process your request. If you\'re an administrator, please set the DEBUG flag to true in config.php.</pre>';
+            echo "<pre>The system has failed to process your request. If you're an administrator, please set the DEBUG flag to true in config.php.</pre>";
+    	}
+        if (LOG_MYSQL_ERRORS) {
+            $log = "MySQL encountered the following error:\n$error\n(errno = $errno)\n";
+            if ($sql != '') {
+                $log .= "In the following query:\n$sql";
+            }
+            if (!ini_get('log_errors')) {
+                ini_set('log_errors', TRUE);
+                ini_set('error_log', 'error_log');
+            }
+            error_log($log);
         }
         exit;
     }
 
+    /**
+     * Can be used to make any expression query-safe, but see next function.
+     *
+     * Example: $db->query('UPDATE a SET b = "'.$db->escape("Hello, my name is $rawinput").'"');
+     *
+     * @param string $rawstring
+     * @return string
+     */
     function escape($rawstring) {
-        return mysql_real_escape_string($rawstring, $this->link);
+        set_error_handler($this->errcallb);
+        $return = mysql_real_escape_string($rawstring, $this->link);
+        restore_error_handler();
+        return $return;
     }
+    
+    /**
+     * Preferred for performance when escaping any string variable.
+     *
+     * Example: $db->query('UPDATE a SET b = "Hello, my name is '.$db->escape_var($rawinput).'"');
+     *
+     * @param string $rawstring
+     * @return string
+     */
+    function escape_var(&$rawstring) {
+        set_error_handler($this->errcallb);
+        $return = mysql_real_escape_string($rawstring, $this->link);
+        restore_error_handler();
+        return $return;
+    }
 
     function like_escape($rawstring) {
-        return str_replace(array('%', '_'), array('\%', '\_'), mysql_real_escape_string($rawstring, $this->link));
+        set_error_handler($this->errcallb);
+        $return = str_replace(array('%', '_'), array('\%', '\_'), mysql_real_escape_string($rawstring, $this->link));
+        restore_error_handler();
+        return $return;
     }
 
     function regexp_escape($rawstring) {
-        return mysql_real_escape_string(preg_quote($rawstring), $this->link);
+        set_error_handler($this->errcallb);
+        $return = mysql_real_escape_string(preg_quote($rawstring), $this->link);
+        restore_error_handler();
+        return $return;
     }
 
-    function query($sql, $overwriteErrorPerms=false) {
+    function query($sql) {
         $this->start_timer();
         $query = mysql_query($sql, $this->link);
         if ($query == false) {
             $this->panic($sql);
         }
         $this->querynum++;
-        $this->querylist[] = $sql;
+    	if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
+            $this->querylist[] = $sql;
+        }
         $this->querytimes[] = $this->stop_timer();
         return $query;
     }
@@ -181,7 +240,9 @@
             $this->panic($sql);
         }
         $this->querynum++;
-        $this->querylist[] = $sql;
+    	if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
+            $this->querylist[] = $sql;
+        }
         $this->querytimes[] = $this->stop_timer();
         return $query;
     }
@@ -200,28 +261,53 @@
     }
 
     function result($query, $row, $field=NULL) {
+        set_error_handler($this->errcallb);
         $query = mysql_result($query, $row, $field);
+        restore_error_handler();
         return $query;
     }
 
     function num_rows($query) {
+        set_error_handler($this->errcallb);
         $query = mysql_num_rows($query);
+        restore_error_handler();
         return $query;
     }
 
     function num_fields($query) {
-        return mysql_num_fields($query);
+        set_error_handler($this->errcallb);
+        $return = mysql_num_fields($query);
+        restore_error_handler();
+        return $return;
     }
 
     function insert_id() {
+        set_error_handler($this->errcallb);
         $id = mysql_insert_id($this->link);
+        restore_error_handler();
         return $id;
     }
 
     function fetch_row($query) {
+        set_error_handler($this->errcallb);
         $query = mysql_fetch_row($query);
+        restore_error_handler();
         return $query;
     }
+    
+    function data_seek($query, $row) {
+        set_error_handler($this->errcallb);
+        $return = mysql_data_seek($query, $row);
+        restore_error_handler();
+        return $return;
+    }
+    
+    function affected_rows() {
+        set_error_handler($this->errcallb);
+        $return = mysql_affected_rows($this->link);
+        restore_error_handler();
+        return $return;
+    }
 
     function time($time=NULL) {
         if ($time === NULL) {
@@ -246,7 +332,45 @@
     }
 }
 
-define('SQL_NUM', MYSQL_NUM);
-define('SQL_BOTH', MYSQL_BOTH);
-define('SQL_ASSOC', MYSQL_ASSOC);
-?>
\ No newline at end of file
+/**
+ * Proper error reporting for abstracted mysql_* function calls.
+ *
+ * @param int $errno
+ * @param string $errstr
+ * @author Robert Chapin (miqrogroove)
+ */
+function xmb_mysql_error($errno, $errstr) {
+    $output = '';
+    {
+        $trace = debug_backtrace();
+        if (isset($trace[2]['function'])) { // Catch MySQL error
+            $depth = 2;
+        } else { // Catch syntax error
+            $depth = 1;
+        }
+        $functionname = $trace[$depth]['function'];
+        $filename = $trace[$depth]['file'];
+        $linenum = $trace[$depth]['line'];
+        $output = "MySQL encountered the following error: $errstr in \$db->{$functionname}() called by {$filename} on line {$linenum}";
+        unset($trace, $functionname, $filename, $linenum);
+    }
+
+    if (!headers_sent()) {
+        header('HTTP/1.0 500 Internal Server Error');
+    }
+	if (DEBUG And (!defined('X_SADMIN') Or X_SADMIN)) {
+        require_once(ROOT.'include/validate.inc.php');
+		echo "<pre>".cdataOut($output)."</pre>";
+    } else {
+        echo "<pre>The system has failed to process your request. If you're an administrator, please set the DEBUG flag to true in config.php.</pre>";
+	}
+    if (LOG_MYSQL_ERRORS) {
+        if (!ini_get('log_errors')) {
+            ini_set('log_errors', TRUE);
+            ini_set('error_log', 'error_log');
+        }
+        error_log($output);
+    }
+    exit;
+}
+?>
Index: editprofile.php
===================================================================
--- editprofile.php	(revision 1746)
+++ editprofile.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -41,21 +40,54 @@
 
 eval('$css = "'.template('css').'";');
 
-eval('echo "'.template('header').'";');
+eval('$header = "'.template('header').'";');
 
+if (X_GUEST) {
+    redirect("{$full_url}misc.php?action=login", 0);
+    exit;
+}
+
 if (!X_SADMIN) {
-    error($lang['superadminonly'], false);
+    error($lang['superadminonly']);
 }
 
 $user = postedVar('user', '', TRUE, TRUE, FALSE, 'g');
 
 $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$user'");
 if ($db->num_rows($query) != 1) {
-    error($lang['nomember'], false);
+    error($lang['nomember']);
 }
 $member = $db->fetch_array($query);
 
 if (noSubmit('editsubmit')) {
+    $sadminselect = $adminselect = $smodselect = '';
+    $modselect = $memselect = $banselect = '';
+    switch($member['status']) {
+    case 'Super Administrator':
+        $sadminselect = $selHTML;
+        break;
+    case 'Administrator':
+        $adminselect = $selHTML;
+        break;
+    case 'Super Moderator':
+        $smodselect = $selHTML;
+        break;
+    case 'Moderator':
+        $modselect = $selHTML;
+        break;
+    case 'Member':
+        $memselect = $selHTML;
+        break;
+    case 'Banned':
+        $banselect = $selHTML;
+        break;
+    default:
+        $memselect = $selHTML;
+        break;
+    }
+
+    $custout = attrOut($member['customstatus']);
+
     $checked = '';
     if ($member['showemail'] == 'yes') {
         $checked = $cheHTML;
@@ -87,7 +119,9 @@
     }
 
     $registerdate = gmdate($dateformat, $member['regdate'] + ($addtime * 3600) + ($timeoffset * 3600));
-    $lastlogdate = gmdate($timecode, $member['lastvisit'] + ($addtime * 3600) + ($timeoffset * 3600));
+    $lastvisitdate = gmdate($dateformat, $member['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
+    $lastvisittime = gmdate($timecode, $member['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
+    $lastlogdate = $lastvisitdate.' '.$lang['textat'].' '.$lastvisittime;
 
     $currdate = gmdate($timecode, $onlinetime + ($addtime * 3600));
     eval($lang['evaloffset']);
@@ -131,6 +165,20 @@
     $dayselect[] = '</select>';
     $dayselect = implode("\n", $dayselect);
 
+    $u2uasel0 = $u2uasel1 = $u2uasel2 = '';
+    switch($member['u2ualert']) {
+        case 2:
+            $u2uasel2 = $selHTML;
+            break;
+        case 1:
+            $u2uasel1 = $selHTML;
+            break;
+        case 0:
+        default:
+            $u2uasel0 = $selHTML;
+            break;
+    }
+
     $check12 = $check24 = '';
     if ($member['timeformat'] == 24) {
         $check24 = $cheHTML;
@@ -158,9 +206,9 @@
     if ($SETTINGS['avastatus'] == 'list')  {
         $avatars = '<option value="" />'.$lang['textnone'].'</option>';
         $dir1 = opendir(ROOT.'images/avatars');
-        while($avatar1 = readdir($dir1)) {
-            if (is_file(ROOT.'images/avatars/'.$avatar1)) {
-                $avatars .= '<option value="'.ROOT.'images/avatars/'.$avatar1.'" />'.$avatar1.'</option>';
+        while($avFile = readdir($dir1)) {
+            if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
+                $avatars .= '<option value="./images/avatars/'.$avFile.'" />'.$avFile.'</option>';
             }
         }
         $avatars = str_replace('value="'.$member['avatar'].'"', 'value="'.$member['avatar'].'" selected="selected"', $avatars);
@@ -175,16 +223,15 @@
 
     $userrecode = recodeOut($member['username']);
 
-    eval('echo "'.template('admintool_editprofile').'";');
+    eval('$editpage = "'.template('admintool_editprofile').'";');
 } else {
-    $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
-    $langfilenew = getLangFileNameFromHash($langfilenew);
-    if ($langfilenew === false) {
+    $status = postedVar('status');
+    $cusstatus = postedVar('cusstatus', '', FALSE);
+    $langfilenew = postedVar('langfilenew');
+    $result = $db->query("SELECT devname FROM ".X_PREFIX."lang_base WHERE devname='$langfilenew'");
+    if ($db->num_rows($result) == 0) {
         $langfilenew = $SETTINGS['langfile'];
-    } else {
-        $langfilenew = basename($langfilenew);
     }
-    $langfilenew = $db->escape($langfilenew);
 
     $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
     $thememem = formInt('thememem');
@@ -209,12 +256,11 @@
     $invisible = formInt('newinv');
     $showemail = formYesNo('newshowemail');
     $newsletter = formYesNo('newnewsletter');
+    $u2ualert = formInt('u2ualert');
     $year = formInt('year');
     $month = formInt('month');
     $day = formInt('day');
     $bday = iso8601_date($year, $month, $day);
-    $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
-    $newavatarcheck = postedVar('newavatarcheck');
     $location = postedVar('newlocation', 'javascript', TRUE, TRUE, TRUE);
     $icq = postedVar('newicq', '', FALSE, FALSE);
     $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
@@ -227,31 +273,63 @@
     $mood = postedVar('newmood', 'javascript', TRUE, TRUE, TRUE);
     $sig = postedVar('newsig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-    $max_size = explode('x', $SETTINGS['max_avatar_size']);
-    if (ini_get('allow_url_fopen')) {
-        if ($max_size[0] > 0 && $max_size[1] > 0) {
-            $size = @getimagesize($_POST['newavatar']);
-            if ($size === false) {
-                $avatar = '';
-            } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
-                error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+    if ($SETTINGS['avastatus'] == 'on') {
+        $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+        $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+
+        $newavatarcheck = postedVar('newavatarcheck');
+
+        $max_size = explode('x', $SETTINGS['max_avatar_size']);
+
+        if (preg_match('#^(http|ftp)://[:a-z\\./_\-0-9%~]+(\?[a-z=0-9&_\-;~]*)?$#Smi', $rawavatar) == 0) {
+            $avatar = '';
+        } elseif (ini_get('allow_url_fopen')) {
+            if ($max_size[0] > 0 And $max_size[1] > 0 And strlen($rawavatar) > 0) {
+                $size = @getimagesize($rawavatar);
+                if ($size === FALSE) {
+                    $avatar = '';
+                } elseif ((($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) && !X_SADMIN) {
+                    error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                }
             }
+        } elseif ($newavatarcheck == "no") {
+            $avatar = '';
         }
-    } else if ($newavatarcheck == "no") {
+        unset($rawavatar);
+    } elseif ($SETTINGS['avastatus'] == 'list') {
+        $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+        $dirHandle = opendir(ROOT.'images/avatars');
+        $filefound = FALSE;
+        while($avFile = readdir($dirHandle)) {
+            if ($rawavatar == './images/avatars/'.$avFile) {
+                if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
+                    $filefound = TRUE;
+                }
+            }
+        }
+        closedir($dirHandle);
+        unset($rawavatar);
+        if ($filefound) {
+            $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+        } else {
+            $avatar = '';
+        }
+    } else {
         $avatar = '';
     }
 
-    $db->query("UPDATE ".X_PREFIX."members SET email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u' WHERE username='$user'");
+    $db->query("UPDATE ".X_PREFIX."members SET status='$status', customstatus='$cusstatus', email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u', u2ualert=$u2ualert WHERE username='$user'");
     $newpassword = $_POST['newpassword'];
     if ($newpassword) {
         $newpassword = md5($newpassword);
         $db->query("UPDATE ".X_PREFIX."members SET password='$newpassword' WHERE username='$user'");
     }
 
-    echo '<div align="center"><span class="mediumtxt">'.$lang['adminprofilechange'].'</span></div>';
-    redirect('cp.php', 2, X_REDIRECT_JS);
+    $editpage = '<div align="center"><span class="mediumtxt">'.$lang['adminprofilechange'].'</span></div>';
+    redirect($full_url.'cp.php', 2, X_REDIRECT_JS);
 }
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$editpage.$footer;
+?>
Index: faq.php
===================================================================
--- faq.php	(revision 1746)
+++ faq.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -33,6 +32,7 @@
 $page = postedVar('page', '', FALSE, FALSE, FALSE, 'g');
 
 if ($SETTINGS['faqstatus'] == 'off' && $page != 'forumrules') {
+    header('HTTP/1.0 403 Forbidden');
     loadtemplates('misc_feature_notavailable');
     eval('$css = "'.template('css').'";');
     nav('<a href="faq.php">'.$lang['textfaq']. '</a>');
@@ -48,11 +48,13 @@
 
 switch($page) {
     case 'usermaint':
+        setCanonicalLink("faq.php?page=$page");
         loadtemplates('faq_usermaint');
         nav($lang['textuserman']);
         eval('$faq = "'.template('faq_usermaint').'";');
         break;
     case 'using':
+        setCanonicalLink("faq.php?page=$page");
         loadtemplates('faq_using_rankrow', 'faq_using');
         nav($lang['textuseboa']);
         $stars = $rankrows   = '';
@@ -66,6 +68,7 @@
         eval('$faq = "'.template('faq_using').'";');
         break;
     case 'messages':
+        setCanonicalLink("faq.php?page=$page");
         loadtemplates('faq_messages_smilierow', 'faq_messages');
         $smilierows = NULL;
         nav($lang['textpostread']);
@@ -77,6 +80,7 @@
         eval('$faq = "'.template('faq_messages').'";');
         break;
     case 'forumrules':
+        setCanonicalLink("faq.php?page=$page");
         loadtemplates('faq_forumrules');
         nav();
         nav($lang['textbbrules']);
@@ -88,6 +92,7 @@
         eval('$faq = "'.template('faq_forumrules').'";');
         break;
     default:
+        setCanonicalLink('faq.php');
         loadtemplates('faq');
         eval('$faq = "'.template('faq').'";');
         break;
@@ -98,4 +103,4 @@
 end_time();
 eval('$footer = "'.template('footer').'";');
 echo stripslashes($header.$faq.$footer);
-?>
\ No newline at end of file
+?>
Index: forumdisplay.php
===================================================================
--- forumdisplay.php	(revision 1746)
+++ forumdisplay.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -34,7 +33,6 @@
 'forumdisplay',
 'forumdisplay_admin',
 'forumdisplay_sortby',
-'forumdisplay_invalidforum',
 'forumdisplay_multipage',
 'forumdisplay_multipage_admin',
 'forumdisplay_newpoll',
@@ -53,54 +51,78 @@
 smcwcache();
 
 eval('$css = "'.template('css').'";');
+eval($lang['hottopiceval']);
 
-$tid = getInt('tid');
 $fid = getInt('fid');
-$page = getInt('page');
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
-$forum = $db->fetch_array($query);
-$db->free_result($query);
+$forum = getForum($fid);
 
 if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoforum']);
 }
 
 $perms = checkForumPermissions($forum);
-if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
-    error($lang['privforummsg']);
+if (!$perms[X_PERMS_VIEW]) {
+    if (X_GUEST) {
+        redirect("{$full_url}misc.php?action=login", 0);
+        exit;
+    } else {
+        error($lang['privforummsg']);
+    }
 } else if (!$perms[X_PERMS_PASSWORD]) {
     handlePasswordDialog($fid);
 }
 
 $fup = array();
 if ($forum['type'] == 'sub') {
-    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
-
+    $fup = getForum($forum['fup']);
     // prevent access to subforum when upper forum can't be viewed.
     $fupPerms = checkForumPermissions($fup);
-    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
-        error($lang['privforummsg']);
+    if (!$fupPerms[X_PERMS_VIEW]) {
+        if (X_GUEST) {
+            redirect("{$full_url}misc.php?action=login", 0);
+            exit;
+        } else {
+            error($lang['privforummsg']);
+        }
     } else if (!$fupPerms[X_PERMS_PASSWORD]) {
         handlePasswordDialog($fup['fid']);
     } else if ($fup['fup'] > 0) {
-        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+        $fupup = getForum($fup['fup']);
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fupup['name']).'</a>');
+        unset($fupup);
     }
     nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 } else if ($forum['fup'] > 0) { // 'forum' in a 'group'
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
+    $fup = getForum($forum['fup']);
     nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 }
 nav(fnameOut($forum['name']));
 
-eval('echo "'.template('header').'";');
+if ($SETTINGS['subject_in_title'] == 'on') {
+    $threadSubject = '- '.fnameOut($forum['name']);
+}
 
+// Search-link
+$searchlink = makeSearchLink($forum['fid']);
+
+validateTpp();
+validatePpp();
+
+$threadcount = $db->result($db->query("SELECT COUNT(tid) FROM ".X_PREFIX."threads WHERE fid=$fid"), 0);
+
+// Perform automatic maintenance
+if ($forum['type'] == 'sub' And $forum['threads'] != $threadcount) {
+    updateforumcount($fid);
+}
+
+$mpage = multipage($threadcount, $tpp, 'forumdisplay.php?fid='.$fid);
+
+eval('$header = "'.template('header').'";');
+
 if ($perms[X_PERMS_POLL]) {
     eval('$newpolllink = "'.template('forumdisplay_newpoll').'";');
 } else {
@@ -113,22 +135,19 @@
     $newtopiclink = '';
 }
 
+$index_subforums = array();
 $subforums = '';
 if ($forum['type'] == 'forum') {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE type='sub' AND fup=$fid AND status='on' ORDER BY displayorder");
-    if ($db->num_rows($query) != 0) {
-        $forumlist = '';
-        while($sub = $db->fetch_array($query)) {
-            $perms = checkForumPermissions($sub);
-            if ($perms[X_PERMS_VIEW] And $perms[X_PERMS_USERLIST]) {
-                $forumlist .= forum($sub, "forumdisplay_subforum");
-            }
+    $forumlist = '';
+    $permitted = permittedForums(forumCache(), 'forum');
+    foreach($permitted as $sub) {
+        if ($sub['type'] == 'sub' And $sub['fup'] == $fid) {
+            $forumlist .= forum($sub, "forumdisplay_subforum", $index_subforums);
         }
-        if ($forumlist != '') {
-            eval('$subforums .= "'.template('forumdisplay_subforums').'";');
-        }
-        $db->free_result($query);
     }
+    if ($forumlist != '') {
+        eval('$subforums .= "'.template('forumdisplay_subforums').'";');
+    }
 }
 
 $t_extension = get_extension($lang['toppedprefix']);
@@ -151,17 +170,6 @@
         break;
 }
 
-validateTpp();
-validatePpp();
-
-$max_page = (int) ($forum['threads'] / $tpp) + 1;
-if ($page && $page >= 1 && $page <= $max_page) {
-    $start_limit = ($page-1) * $tpp;
-} else {
-    $start_limit = 0;
-    $page = 1;
-}
-
 $cusdate = formInt('cusdate');
 if ($cusdate) {
     $cusdate = $onlinetime - $cusdate;
@@ -194,7 +202,7 @@
     $db->free_result($query);
 }
 
-$querytop = $db->query("SELECT t.* FROM ".X_PREFIX."threads t WHERE t.fid='$fid' $cusdate ORDER BY topped $ascdesc, lastpost $ascdesc LIMIT $start_limit, $tpp");
+$querytop = $db->query("SELECT t.*, m.uid FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."members AS m ON t.author=m.username WHERE t.fid='$fid' $cusdate ORDER BY topped $ascdesc, lastpost $ascdesc LIMIT {$mpage['start']}, $tpp");
 while($thread = $db->fetch_array($querytop)) {
     if ($thread['icon'] != '' && file_exists($smdir.'/'.$thread['icon'])) {
         $thread['icon'] = '<img src="'.$smdir.'/'.$thread['icon'].'" alt="'.$thread['icon'].'" border="0" />';
@@ -203,14 +211,14 @@
     }
 
     if ($thread['topped'] == 1) {
-        $topimage = '<img src="./images/admin/untop.gif" alt="'.$lang['textuntopthread'].'" border="0" />';
+        $topimage = '<img src="'.$admdir.'/untop.gif" alt="'.$lang['textuntopthread'].'" border="0" />';
     } else {
-        $topimage = '<img src="./images/admin/top.gif" alt="'.$lang['alttopthread'].'" border="0" />';
+        $topimage = '<img src="'.$admdir.'/top.gif" alt="'.$lang['alttopthread'].'" border="0" />';
     }
 
     $thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
 
-    if ($thread['author'] == $lang['textanonymous']) {
+    if ($thread['author'] == $lang['textanonymous'] Or is_null($thread['uid'])) {
         $authorlink = $thread['author'];
     } else {
         $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
@@ -221,7 +229,7 @@
     $lastpost = explode('|', $thread['lastpost']);
     $dalast = trim($lastpost[0]);
 
-    if ($lastpost[1] != $lang['textanonymous']) {
+    if ($lastpost[1] != 'Anonymous') {
         $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut(trim($lastpost[1])).'">'.trim($lastpost[1]).'</a>';
     } else {
         $lastpost[1] = $lang['textanonymous'];
@@ -285,13 +293,12 @@
         $prefix = $lang['toppedprefix'].' '.$prefix;
     }
 
-    $postnum = $thread['replies']+1;
-    if ($postnum > $ppp) {
-        $pagelinks = multi($postnum, $ppp, 0, 'viewthread.php?tid='.intval($thread['tid']));
-        $multipage2 = '(<small>'.$pagelinks.'</small>)';
-    } else {
-        $pagelinks = $multipage2 = '';
+    $mpurl = 'viewthread.php?tid='.$thread['tid'];
+    $multipage2 = multi(1, quickpage($thread['replies']+1, $ppp), $mpurl, FALSE);
+    if (strlen($multipage2) != 0) {
+        $multipage2 = "(<small>$multipage2</small>)";
     }
+    unset($mpurl);
 
     eval('$threadlist .= "'.template($forumdisplay_thread).'";');
 
@@ -341,10 +348,8 @@
 
 eval('$sortby = "'.template('forumdisplay_sortby').'";');
 
-$mpurl = 'forumdisplay.php?fid='.$fid;
-if (($multipage = multi($topicsnum, $tpp, $page, $mpurl)) === false) {
-    $multipage = '';
-} else {
+$multipage =& $mpage['html'];
+if (strlen($mpage['html']) != 0) {
     if ($status1 == 'Moderator') {
         eval('$multipage = "'.template('forumdisplay_multipage_admin').'";');
     } else {
@@ -353,11 +358,17 @@
 }
 
 if ($status1 == 'Moderator') {
-    eval('echo "'.template('forumdisplay_admin').'";');
+    if (X_ADMIN) {
+        $fadminlink = '<a href="cp.php?action=forum&amp;fdetails='.$forum['fid'].'" title="'.$lang['alteditsettings'].'"><img src="'.$admdir.'/editforumsets.gif" border="0" /></a>';
+    } else {
+        $fadminlink = '';
+    }
+    eval('$forumdisplay = "'.template('forumdisplay_admin').'";');
 } else {
-    eval('echo "'.template('forumdisplay').'";');
+    eval('$forumdisplay = "'.template('forumdisplay').'";');
 }
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$forumdisplay.$footer;
+?>
Index: header.php
===================================================================
--- header.php	(revision 1746)
+++ header.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -26,299 +25,360 @@
  *
  **/
 
+
+/* Front Matter */
+
 if (!defined('X_SCRIPT')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
-
+if (!defined('ROOT')) define('ROOT', './');
 error_reporting(E_ALL&~E_NOTICE);
+define('IN_CODE', TRUE);
+require ROOT.'include/global.inc.php';
 
-define('IN_CODE', true);
-define('X_CACHE_GET', 1);
-define('X_CACHE_PUT', 2);
-define('X_SET_HEADER', 1);
-define('X_SET_JS', 2);
-define('X_SHORTEN_SOFT', 1);
-define('X_SHORTEN_HARD', 2);
 
-// permissions constants
-define('X_PERMS_POLL', 0);
-define('X_PERMS_THREAD', 1);
-define('X_PERMS_REPLY', 2);
-define('X_PERMS_VIEW', 3);
-define('X_PERMS_USERLIST', 4);
-define('X_PERMS_PASSWORD', 5);
+/* Global Constants and Initialized Values */
 
-if (!defined('ROOT')) {
-    define('ROOT', './');
-}
-
-// Resolve Server specific issues
+$versioncompany = 'The XMB Group';
+$versionshort = '1.9.11';
+$versiongeneral = 'XMB 1.9.11';
+$copyright = '2001-2009';
+$alpha = '';
+$beta = '';
+$gamma = '';
+$service_pack = '';
+$versionbuild = 20090228;
+$mtime = explode(" ", microtime());
+$starttime = $mtime[1] + $mtime[0];
+$onlinetime = time();
+$time = $onlinetime;
+$selHTML = 'selected="selected"';
+$cheHTML = 'checked="checked"';
 $server = substr($_SERVER['SERVER_SOFTWARE'], 0, 3);
-switch($server) {
-    case 'Aby': // Abyss web server
-        $protocol = (getenv('HTTPS') == 'off') ? ('http://') : ('https://');
-        $query = (getenv('QUERY_STRING')) ? ('?'.getenv('QUERY_STRING')) : ('');
-        $url = $protocol.getenv('SERVER_NAME').getenv('SCRIPT_NAME').$query;
-        break;
-    default: // includes Apache and IIS using module and CGI forms
-        $url = $_SERVER['REQUEST_URI'];
-}
+$url = $_SERVER['REQUEST_URI'];
+$onlineip = $_SERVER['REMOTE_ADDR'];
 
-// Required Files - XMB (Version/Patch File) Configuration File, Database Settings File
-require ROOT.'include/global.inc.php';
-require ROOT.'include/validate.inc.php';
-
-// Initialising certain key variables. These are default values, please don't change them!
+$canonical_link = '';
 $cookiepath = '';
 $cookiedomain = '';
-$mtime = explode(" ", microtime());
-$starttime = $mtime[1] + $mtime[0];
-$onlinetime = time();
 $bbcodescript = '';
+$database = '';
 $threadSubject = '';
-$user = (isset($user)) ? $user : '';
-$SETTINGS = array();
-$THEME = array();
-$links = array();
-$lang = array();
-$plugname = array();
-$plugadmin = array();
-$plugurl = array();
-$plugimg = array();
-$footerstuff = array();
-$mailer = array();
-$selHTML = 'selected="selected"';
-$cheHTML = 'checked="checked"';
 $filesize = 0;
 $filename = '';
 $filetype = '';
-$quickjump = '';
+$full_url = '';
+$navigation = '';
 $newu2umsg = '';
 $othertid = '';
+$pluglink = '';
+$quickjump = '';
+$searchlink = '';
+$smiliesnum = 0;
+$status = '';
+$wordsnum = 0;
+$xmbuser = '';
+$xmbpw = '';
 
-define('COMMENTOUTPUT', false);
-define('MAXATTACHSIZE', 256000);
-define('IPREG', 'on');
-define('IPCHECK', 'off');
-define('SPECQ', false);
-define('SHOWFULLINFO', false);
+$SETTINGS = array();
+$THEME = array();
+$censorcache = array();
+$footerstuff = array();
+$links = '';
+$lang = array();
+$mailer = array();
+$plugadmin = array();
+$plugimg = array();
+$plugname = array();
+$plugurl = array();
+$smiliecache = array();
+$tables = array(
+'attachments',
+'banned',
+'buddys',
+'captchaimages',
+'favorites',
+'forums',
+'lang_base',
+'lang_keys',
+'lang_text',
+'logs',
+'members',
+'posts',
+'ranks',
+'restricted',
+'settings',
+'smilies',
+'templates',
+'themes',
+'threads',
+'u2u',
+'whosonline',
+'words',
+'vote_desc',
+'vote_results',
+'vote_voters'
+);
 
-require ROOT.'config.php';
+define('X_CACHE_GET', 1);
+define('X_CACHE_PUT', 2);
+define('X_REDIRECT_HEADER', 1);
+define('X_REDIRECT_JS', 2);
+define('X_SET_HEADER', 1);
+define('X_SET_JS', 2);
+define('X_SHORTEN_SOFT', 1);
+define('X_SHORTEN_HARD', 2);
+// permissions constants
+define('X_PERMS_COUNT', 4); //Number of raw bit sets stored in postperm setting.
+// indexes used in permissions arrays
+define('X_PERMS_RAWPOLL', 0);
+define('X_PERMS_RAWTHREAD', 1);
+define('X_PERMS_RAWREPLY', 2);
+define('X_PERMS_RAWVIEW', 3);
+define('X_PERMS_POLL', 40);
+define('X_PERMS_THREAD', 41);
+define('X_PERMS_REPLY', 42);
+define('X_PERMS_VIEW', 43); //View is now = Rawview || Userlist
+define('X_PERMS_USERLIST', 44);
+define('X_PERMS_PASSWORD', 45);
+// status string to bit field assignments
+$status_enum = array(
+'Super Administrator' => 1,
+'Administrator'       => 2,
+'Super Moderator'     => 4,
+'Moderator'           => 8,
+'Member'              => 16,
+'Guest'               => 32,
+''                    => 32,
+'Reserved-Future-Use' => 64,
+'Banned'              => (1 << 30)
+); //$status['Banned'] == 2^30
+// status bit to $lang key assignments
+$status_translate = array(
+1         => 'superadmin',
+2         => 'textadmin',
+4         => 'textsupermod',
+8         => 'textmod',
+16        => 'textmem',
+32        => 'textguest1',
+(1 << 30) => 'textbanned'
+);
 
-if (!defined('DEBUG')) {
-    define('DEBUG', FALSE);
+// discover the most likely browser
+// so we can use bbcode specifically made for it
+$browser = 'opera'; // default to opera
+if (isset($_SERVER['HTTP_USER_AGENT'])) {
+    if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'Gecko') && false === strpos($_SERVER['HTTP_USER_AGENT'], 'Safari')) {
+        $browser = 'mozilla';
+    }
+    if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'Opera')) {
+        $browser = 'opera';
+    }
+    if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE')) {
+        $browser = 'ie';
+    }
 }
+define('IS_MOZILLA', ($browser == 'mozilla'));
+define('IS_OPERA', ($browser == 'opera'));
+define('IS_IE', ($browser == 'ie'));
 
-if (DEBUG) {
-    error_reporting(E_ALL | E_STRICT);
-}
+assertEmptyOutputStream('header.php or global.inc.php');
 
-if (headers_sent()) {
-    if (DEBUG) {
-        headers_sent($filepath, $linenum);
-        exit(cdataOut("Error: XMB failed to start due to file corruption.  Please inspect $filepath at line number $linenum."));
-    } else {
-        exit("Error: XMB failed to start.  Set DEBUG to TRUE in config.php to see file system details.");
-    }
-}
 
-// Initialise pre-set Variables
-// These strings can be pulled for use on any page as header is required by all XMB pages
-$versioncompany = 'The XMB Group';
-+$versionshort = 'XMB 1.9.10';
-+$versiongeneral = 'XMB 1.9.10 Karl';
-$copyright = '2001-2008';
-if ($show_full_info) {
+/* Load the Configuration Created by Install */
+
+require ROOT.'config.php';
+assertEmptyOutputStream('config.php');
+
+if (!$show_full_info) {
+    $versionshort = '';
+    $versiongeneral = 'XMB';
     $alpha = '';
     $beta = '';
     $gamma = '';
     $service_pack = '';
-    $versionbuild = 20080609;
-    $versionlong = 'Powered by '.$versiongeneral.' '.$alpha.$beta.$gamma.$service_pack.''.(DEBUG === true ? ' (Debug Mode)' : '');
+    $versionbuild = '[HIDDEN]';
 } else {
-    $alpha = '';
-    $beta = '';
-    $gamma = '';
-    $service_pack = '';
-    $versionbuild = '[HIDDEN]';
-    $versionlong = 'Powered by XMB'.(DEBUG === true ? ' (Debug Mode)' : '');
+    $versiongeneral .= ' ';
 }
+$versionlong = 'Powered by '.$versiongeneral.$alpha.$beta.$gamma.$service_pack;
 
-// discover the most likely browser
-// so we can use bbcode specifically made for it
-// this allows the use of various nice new features in eg mozilla
-// while others are available via IE and/or opera
-$browser = 'opera'; // default to opera for now
-if (!isset($_SERVER['HTTP_USER_AGENT'])) {
-    $_SERVER['HTTP_USER_AGENT'] = '';
+if (!defined('DEBUG')) {
+    define('DEBUG', FALSE);
+} elseif (DEBUG) {
+    require(ROOT.'include/debug.inc.php');
+    assertEmptyOutputStream('debug.inc.php');
 }
-
-if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'Gecko') && false === strpos($_SERVER['HTTP_USER_AGENT'], 'Safari')) {
-    define('IS_MOZILLA', true);
-    $browser = 'mozilla';
+if (!defined('LOG_MYSQL_ERRORS')) {
+    define('LOG_MYSQL_ERRORS', FALSE);
 }
 
-if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'Opera')) {
-    define('IS_OPERA', true);
-    $browser = 'opera';
+$config_array = array(
+'dbname' => 'DB/NAME',
+'dbuser' => 'DB/USER',
+'dbpw' => 'DB/PW',
+'dbhost' => 'DB_HOST',
+'database' => 'DB_TYPE',
+'tablepre' => 'TABLE/PRE',
+'full_url' => 'FULLURL',
+'ipcheck' => 'IPCHECK',
+'allow_spec_q' => 'SPECQ',
+'show_full_info' => 'SHOWFULLINFO',
+'comment_output' => 'COMMENTOUTPUT'
+);
+foreach($config_array as $key => $value) {
+    if (${$key} === $value) {
+        header('HTTP/1.0 500 Internal Server Error');
+        exit('Configuration Problem: XMB noticed that your config.php has not been fully configured.<br />The $'.$key.' has not been configured correctly.<br /><br />Please configure config.php before continuing.<br />Refresh the browser after uploading the new config.php (when asked if you want to resubmit POST data, click the \'OK\'-button).');
+    }
 }
+unset($config_array);
 
-if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE')) {
-    define('IS_IE', true);
-    $browser = 'ie';
-}
 
-if (!defined('IS_MOZILLA')) {
-    define('IS_MOZILLA', false);
-}
+/* Validate URL Configuration and Security */
 
-if (!defined('IS_OPERA')) {
-    define('IS_OPERA', false);
-}
+if (empty($full_url)) {
+    header('HTTP/1.0 500 Internal Server Error');
+    exit('<b>ERROR: </b><i>Please fill the $full_url variable in your config.php!</i>');
+} else {
+    $array = parse_url($full_url);
 
-if (!defined('IS_IE')) {
-    define('IS_IE', false);
-}
+    $cookiesecure = ($array['scheme'] == 'https');
 
-if (!file_exists(ROOT.'db/'.$database.'.php')) {
-    die('Error: XMB is not installed, or is configured incorrectly. <a href="install/index.php">Click Here to install XMB</a>');
-}
-require ROOT.'db/'.$database.'.php';
-$oToken = new page_token();
-$oToken->init();
-require ROOT.'include/functions.inc.php';
+    $cookiedomain = $array['host'];
+    if (strpos($cookiedomain, '.') === FALSE || preg_match("/^([0-9]{1,3}\.){3}[0-9]{1,3}$/", $cookiedomain)) {
+        $cookiedomain = '';
+    } elseif (substr($cookiedomain, 0, 4) === 'www.') {
+        $cookiedomain = substr($cookiedomain, 3);
+    }
 
-// initialize navigation
-$navigation = '';
-nav();
+    if (!isset($array['path'])) {
+        $array['path'] = '/';
+    }
+    $cookiepath = $array['path'];
 
-// Cache-control
-header("Cache-Control: no-store, no-cache, must-revalidate");  // HTTP/1.1
-header("Cache-Control: post-check=0, pre-check=0", false);
-header("Pragma: no-cache");
-
-// Fix annoying bug in windows... *sigh*
-$action = isset($action) ? $action : '';
-if ($action != 'attachment' && !($action == 'templates' && isset($download)) && !($action == 'themes' && isset($download))) {
-    header("Content-type: text/html");
+    if (DEBUG) {
+        debugURLsettings($cookiesecure, $cookiedomain, $cookiepath);
+    }
+    unset($array);
 }
 
-// Security checks
-if (file_exists('./install/') && !@rmdir('./install/')) {
-    exit('<h1>Error:</h1><br />The installation files ("./install/") have been found on the server, but could not be removed. Please remove them as soon as possible. If you have not yet installed XMB, please do so at this time. Just <a href="./install/index.php">click here</a>.');
+// Common XSS Protection: XMB disallows '<' and unencoded ':/' in all URLs.
+if (X_SCRIPT != 'search.php') {
+    $url_check = Array('%3c', '<', ':/');
+    foreach($url_check as $name) {
+        if (strpos(strtolower($url), $name) !== FALSE) {
+            header('HTTP/1.0 403 Forbidden');
+            exit('403 Forbidden - URL rejected by XMB');
+        }
+    }
+    unset($url_check);
 }
 
-if (file_exists('./cplogfile.php') && !@unlink('./cplogfile.php')) {
-    exit('<h1>Error:</h1><br />The old logfile ("./cplogfile.php") has been found on the server, but could not be removed. Please remove it as soon as possible.');
+// Check for double-slash problems in REQUEST_URI
+if (substr($url, 0, strlen($cookiepath)) != $cookiepath Or substr($url, strlen($cookiepath), 1) == '/') {
+    $fixed_url = str_replace('//', '/', $url);
+    if (substr($fixed_url, 0, strlen($cookiepath)) != $cookiepath Or substr($fixed_url, strlen($cookiepath), 1) == '/' Or $fixed_url != preg_replace('/[^\x20-\x7e]/', '', $fixed_url)) {
+        header('HTTP/1.0 404 Not Found');
+        exit('XMB detected an invalid URL.  Set DEBUG to TRUE in config.php to see diagnostic details.');
+    } else {
+        $fixed_url = $full_url.substr($fixed_url, strlen($cookiepath));
+        header('HTTP/1.0 301 Moved Permanently');
+        header("Location: $fixed_url");
+        exit('XMB detected an invalid URL');
+    }
 }
 
-if (file_exists('./fixhack.php') && !@unlink('./fixhack.php')) {
-    exit('<h1>Error:</h1><br />The hack repair tool ("./fixhack.php") has been found on the server, but could not be removed. Please remove it as soon as possible.');
-}
 
-if (file_exists('./Upgrade/') && !@rmdir('./Upgrade/')) {
-    exit('<h1>Error:</h1><br />The upgrade tool ("./Upgrade/") has been found on the server, but could not be removed. Please remove it as soon as possible.');
+/* Assert Additional Security */
+
+if (file_exists('./install/')) {
+    header('HTTP/1.0 500 Internal Server Error');
+    exit('<h1>Error:</h1><br />The installation files ("./install/") have been found on the server. Please remove them as soon as possible. If you have not yet installed XMB, please do so at this time. Just <a href="./install/index.php">click here</a>.');
 }
-
-if (file_exists('./upgrade/') && !@rmdir('./upgrade/')) {
+if (file_exists('./Upgrade/') && !@rmdir('./Upgrade/') Or file_exists('./upgrade/') && !@rmdir('./upgrade/')) {
+    header('HTTP/1.0 503 Service Unavailable');
+    header('Retry-After: 3600');
     exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade/") has been found on the server, but could not be removed. Please remove it as soon as possible.');
 }
-
 if (file_exists('./upgrade.php') And X_SCRIPT != 'upgrade.php') {
-    if (!@unlink('./upgrade.php')) {
-        exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade.php") has been found on the server, but could not be removed. Please remove it as soon as possible.');
-    }
+    header('HTTP/1.0 503 Service Unavailable');
+    header('Retry-After: 3600');
+    exit('<h1>Error:</h1><br />The upgrade tool ("./upgrade.php") has been found on the server. Please remove it as soon as possible.');
 }
 
-// Checks the format of the URL, blocks if necessary....
-if (eregi("\?[0-9]+$", $url)) {
-    exit("Invalid String Format, Please Check Your URL");
-}
-
-// Get visitors IP address (which is usually their transparent proxy)
-// DO NOT USE HTTP_CLIENT_IP or HTTP_X_FORWARDED_FOR as these can (and are) forged by attackers. ajv
-$onlineip = '';
-if (isset($_SERVER['REMOTE_ADDR'])) {
-    $onlineip = $_SERVER['REMOTE_ADDR'];
-}
-
 //Checks the IP-format, if it's not a IPv4, nor a IPv6 type, it will be blocked, safe to remove....
 if ($ipcheck == 'on') {
     if (!eregi("^([0-9]{1,3}\.){3}[0-9]{1,3}$", $onlineip) && !eregi("^([a-z,0-9]{0,4}:){5}[a-z,0-9]{0,4}$", $onlineip)&& !stristr($onlineip, ':::::')) {
+        header('HTTP/1.0 403 Forbidden');
         exit("Access to this website is currently not possible as your hostname/IP appears suspicous.");
     }
 }
 
-// Load Objects, and such
-$tables = array(
-    'attachments',
-    'banned',
-    'buddys',
-    'captchaimages',
-    'favorites',
-    'forums',
-    'logs',
-    'members',
-    'posts',
-    'ranks',
-    'restricted',
-    'settings',
-    'smilies',
-    'templates',
-    'themes',
-    'threads',
-    'u2u',
-    'whosonline',
-    'words',
-    'vote_desc',
-    'vote_results',
-    'vote_voters'
-);
 
-// Secured table prefix constant
-define('X_PREFIX', $tablepre);
+/* Load Common Files and Establish Database Connection */
 
+define('X_PREFIX', $tablepre); // Secured table prefix constant
+
+require ROOT.'db/'.$database.'.php';
+assertEmptyOutputStream('db/'.$database.'.php');
+
+require ROOT.'include/validate.inc.php';
+assertEmptyOutputStream('validate.inc.php');
+
+require ROOT.'include/functions.inc.php';
+assertEmptyOutputStream('functions.inc.php');
+
 $db = new dbstuff;
 $db->connect($dbhost, $dbuser, $dbpw, $dbname, $pconnect);
 
-// Checks for various variables in the URL, if any of them is found, script is halted
-$url_check = Array('status=', 'xmbuser=', 'xmbpw=', '%3cscript');
-foreach($url_check as $name) {
-    if (strpos(strtolower($url), $name)) {
-        $auditaction = $_SERVER['REQUEST_URI'];
-        $aapos = strpos($auditaction, "?");
-        if ($aapos !== false) {
-            $auditaction = substr($auditaction, $aapos + 1);
-        }
-        $auditaction = $db->escape("$onlineip|#|ATTACK: $auditaction");
-        audit($xmbuser, $auditaction, 0, 0);
-        exit("Attack logged.");
-    }
+// Make all settings global, and put them in the $SETTINGS[] array
+$squery = $db->query("SELECT * FROM ".X_PREFIX."settings");
+foreach($db->fetch_array($squery) as $key => $val) {
+    $$key = $val;
+    $SETTINGS[$key] = $val;
 }
+$db->free_result($squery);
 
-// Load a few constants
-define('XMB_VERSION', $versiongeneral);
-define('XMB_BUILD', $versionbuild);
-define('X_REDIRECT_HEADER', 1);
-define('X_REDIRECT_JS', 2);
+if ($postperpage < 5) {
+    $postperpage = 30;
+}
 
-// Create cookie-settings
-if (!isset($full_url) || empty($full_url) || $full_url == 'FULLURL') {
-    exit('<b>ERROR: </b><i>Please fill the $full_url variable in your config.php!</i>');
-} else {
-    $array = parse_url($full_url);
-    if (substr($array['host'], 0, 9) == 'localhost' || preg_match("/^([0-9]{1,3}\.){3}[0-9]{1,3}$/i", $array['host'])) {
-        $cookiedomain  = '';
-    } else {
-        $cookiedomain = str_replace('www', '', $array['host']);
-    }
+if ($topicperpage < 5) {
+    $topicperpage = 30;
+}
 
-    if (!isset($array['path'])) {
-        $array['path'] = '/';
-    }
-    $cookiepath = $array['path'];
+if ($memberperpage < 5) {
+    $memberperpage = 30;
 }
 
+if ($onlinetodaycount < 5) {
+    $onlinetodaycount = 30;
+}
+
+// Validate maxattachsize with PHP configuration.
+$inimax = phpShorthandValue('upload_max_filesize');
+if ($inimax < $SETTINGS['maxattachsize']) {
+    $SETTINGS['maxattachsize'] = $inimax;
+}
+unset($inimax);
+
+
+/* Set Global HTTP Headers */
+
+if (X_SCRIPT != 'files.php') {
+    header("Cache-Control: no-store, no-cache, must-revalidate");  // HTTP/1.1
+    header("Cache-Control: post-check=0, pre-check=0", false);
+    header("Pragma: no-cache");
+}
+
+// Fix annoying bug in windows... *sigh*
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
+if ($action != 'attachment' && !($action == 'templates' && isset($download)) && !($action == 'themes' && isset($download))) {
+    header("Content-type: text/html");
+}
+
 // Update last visit cookies
 $xmblva = getInt('xmblva', 'c'); // Last visit
 $xmblvb = getInt('xmblvb', 'c'); // Duration of this visit (considered to be up to 600 seconds)
@@ -335,151 +395,126 @@
 put_cookie('xmblvb', $thetime, ($onlinetime + 600), $cookiepath, $cookiedomain); // lvb =
 
 $lastvisit = $thetime;
-$lastvisit2 = $lastvisit - 540;
 
 if (isset($oldtopics)) {
     put_cookie('oldtopics', $oldtopics, ($onlinetime+600), $cookiepath, $cookiedomain);
 }
 
-// Make all settings global, and put them in the $SETTINGS[] array
-$squery = $db->query("SELECT * FROM ".X_PREFIX."settings");
-foreach($db->fetch_array($squery) as $key => $val) {
-    $$key = $val;
-    $SETTINGS[$key] = $val;
-}
-$db->free_result($squery);
 
-if ($postperpage < 5) {
-    $postperpage = 30;
+/* Authorize User, Set Up Session, and Load Language Translation */
+
+$serror = '';
+
+// Check if the client is ip-banned
+if ($SETTINGS['ip_banning'] == 'on') {
+    $ips = explode(".", $onlineip);
+    $query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE ((ip1='$ips[0]' OR ip1='-1') AND (ip2='$ips[1]' OR ip2='-1') AND (ip3='$ips[2]' OR ip3='-1') AND (ip4='$ips[3]' OR ip4='-1')) AND NOT (ip1='-1' AND ip2='-1' AND ip3='-1' AND ip4='-1')");
+    $result = $db->num_rows($query);
+    $db->free_result($query);
+    if ($result > 0) {
+        // Block all non-admins
+        $serror = 'ip';
+    }
 }
 
-if ($topicperpage < 5) {
-    $topicperpage = 30;
+// Check if the board is offline
+if ($SETTINGS['bbstatus'] == 'off' And $serror == '') {
+    if (($action == 'login' Or $action == 'lostpw') And X_SCRIPT == 'misc.php') {
+        // Allow login
+    } elseif ($SETTINGS['regstatus'] == 'on' And ($action == 'reg' Or $action == 'coppa' Or $action == 'captchaimage') And (X_SCRIPT == 'misc.php' Or X_SCRIPT == 'member.php')) {
+        // Allow registration
+    } else {
+        // Block all non-admins
+        $serror = 'bstatus';
+    }
 }
 
-if ($memberperpage < 5) {
-    $memberperpage = 30;
+// Check if the board is set to 'reg-only'
+if ($SETTINGS['regviewonly'] == 'on' And $serror == '') {
+    if (($action == 'login' Or $action == 'lostpw') And X_SCRIPT == 'misc.php') {
+        // Allow login
+    } elseif ($SETTINGS['regstatus'] == 'on' And ($action == 'reg' Or $action == 'coppa' Or $action == 'captchaimage') And (X_SCRIPT == 'misc.php' Or X_SCRIPT == 'member.php')) {
+        // Allow registration
+    } else {
+        // Block all guests
+        $serror = 'guest';
+    }
 }
 
-if ($onlinetodaycount < 5) {
-    $onlinetodaycount = 30;
+$uinput = postedVar('xmbuser', '', FALSE, TRUE, FALSE, 'c');
+$pinput = postedVar('xmbpw', '', FALSE, FALSE, FALSE, 'c');
+if (!elevateUser($uinput, $pinput, FALSE, $serror)) {
+    // Delete cookies when authentication fails.
+    if ($uinput != '') {
+        put_cookie("xmbuser", '', 0, $cookiepath, $cookiedomain);
+        put_cookie("xmbpw", '', 0, $cookiepath, $cookiedomain);
+    }
 }
+unset($uinput, $pinput);
 
-// Get the user-vars, and make them semi-global
 
-elevateUser(postedVar('xmbuser', '', FALSE, TRUE, FALSE, 'c'), postedVar('xmbpw', '', FALSE, FALSE, FALSE, 'c'));
+/* Set Up HTML Templates and Themes */
 
-
-if (X_MEMBER) {
-    $langfile = ($self['langfile'] == "" || !file_exists("lang/{$self['langfile']}.lang.php")) ? $SETTINGS['langfile'] : $self['langfile'];
-    $timeoffset = $self['timeoffset'];
-    $themeuser = $self['theme'];
-    $status = $self['status'];
-    $tpp = $self['tpp'];
-    $ppp = $self['ppp'];
-    $memtime = $self['timeformat'];
-    $memdate = $self['dateformat'];
-    $sig = $self['sig'];
-    $invisible = $self['invisible'];
-    $time = $onlinetime;
-    $db->query("UPDATE ".X_PREFIX."members SET lastvisit=".$db->time($onlinetime)." WHERE username='$xmbuser'");
+// Create a base element so that links aren't broken if scripts are accessed using unexpected paths.
+// XMB expects all links to be relative to $full_url + script name + query string.
+$querystring = strstr($url, '?');
+if ($querystring === FALSE) {
+    $querystring = '';
+}
+$querystring = preg_replace('/[^\x20-\x7e]/', '', $querystring);
+if ($url == $cookiepath) {
+    $baseelement = '<base href="'.$full_url.'" />';
 } else {
-    $langfile = $SETTINGS['langfile'];
-    $timeoffset = $SETTINGS['def_tz'];
-    $themeuser = '';
-    $status = 'member';
-    $tpp = $SETTINGS['topicperpage'];
-    $ppp = $SETTINGS['postperpage'];
-    $memtime = '';
-    $memdate = '';
-    $sig = '';
-    $invisible = 0;
-    $time = $onlinetime;
-    $self['ban'] = '';
-    $self['sig'] = '';
-    $self['status'] = '';
-    $self['username'] = '';
+    $baseelement = '<base href="'.$full_url.X_SCRIPT.attrOut($querystring).'" />';
 }
 
-if ($memtime == '') {
-    if ($timeformat == 24) {
-        $timecode = "H:i";
+// login/logout links
+if (X_MEMBER) {
+    if (X_ADMIN) {
+        $cplink = ' - <a href="cp.php">'.$lang['textcp'].'</a>';
     } else {
-        $timecode = "h:i A";
+        $cplink = '';
     }
-} else {
-    if ($memtime == 24) {
-        $timecode = "H:i";
-    } else {
-        $timecode = "h:i A";
-    }
-}
-
-// Load a language file
-if (file_exists(ROOT.'lang/'.$langfile.'.lang.php')) {
-    require ROOT.'lang/'.$langfile.'.lang.php';
-} else {
-    require ROOT.'lang/English.lang.php';
-}
-
-// Checks for the possibility to register
-$reglink = '';
-if ($SETTINGS['regstatus'] == 'on' && X_GUEST) {
-    $reglink = '- <a href="member.php?action=coppa">'.$lang['textregister'].'</a>';
-}
-
-// Creates login/logout links
-if (X_MEMBER) {
     $loginout = '<a href="misc.php?action=logout">'.$lang['textlogout'].'</a>';
     $memcp = '<a href="memcp.php">'.$lang['textusercp'].'</a>';
-    $onlineuser = $xmbuser;
-    $cplink = '';
     $u2ulink = "<a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['banu2u']}</a> - ";
-    if (X_ADMIN) {
-        $cplink = ' - <a href="cp.php">'.$lang['textcp'].'</a>';
-    }
     $notify = $lang['loggedin'].' <a href="member.php?action=viewpro&amp;member='.recodeOut($xmbuser).'">'.$xmbuser.'</a><br />['.$loginout.' - '.$u2ulink.''.$memcp.''.$cplink.']';
+
+    // Update lastvisit in the header shown
+    $theTime = $xmblva + ($self['timeoffset'] * 3600) + ($SETTINGS['addtime'] * 3600);
+    $lastdate = gmdate($dateformat, $theTime);
+    $lasttime = gmdate($timecode, $theTime);
+    $lastvisittext = $lang['lastactive'].' '.$lastdate.' '.$lang['textat'].' '.$lasttime;
 } else {
+    // Checks for the possibility to register
+    if ($SETTINGS['regstatus'] == 'on') {
+        $reglink = '- <a href="member.php?action=coppa">'.$lang['textregister'].'</a>';
+    } else {
+        $reglink = '';
+    }
     $loginout = '<a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-    $onlineuser = 'xguest123';
-    $self['status'] = '';
     $notify = $lang['notloggedin'].' ['.$loginout.' '.$reglink.']';
+    $lastvisittext = '';
 }
 
-// Checks if the timeformat has been set, if not, use default
-if ($memdate == '') {
-    $dateformat = $dateformat;
-} else {
-    $dateformat = $memdate;
-}
-
-$dformatorig = $dateformat;
-$dateformat = str_replace(array('mm', 'MM', 'dd', 'DD', 'yyyy', 'YYYY', 'yy', 'YY'), array('n', 'n', 'j', 'j', 'Y', 'Y', 'y', 'y'), $dateformat);
-
 // Get themes, [fid, [tid]]
-if (isset($tid) && is_numeric($tid) && $action != 'templates') {
+$fid = getInt('fid', 'r');
+$tid = getInt('tid', 'r');
+if ($tid > 0 && $action != 'templates') {
     $query = $db->query("SELECT f.fid, f.theme FROM ".X_PREFIX."forums f RIGHT JOIN ".X_PREFIX."threads t USING (fid) WHERE t.tid=$tid");
     $locate = $db->fetch_array($query);
     $db->free_result($query);
     $fid = $locate['fid'];
     $forumtheme = $locate['theme'];
- } else if (isset($fid) && is_numeric($fid)) {
-    $q = $db->query("SELECT theme FROM ".X_PREFIX."forums WHERE fid=$fid");
-    if ($db->num_rows($q) === 1) {
-        $forumtheme = $db->result($q, 0);
-        $db->free_result($q);
+} else if ($fid > 0) {
+    $forum = getForum($fid);
+    if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+        $forumtheme = 0;
     } else {
-        $forumtheme = 0;
+        $forumtheme = $forum['theme'];
     }
 }
 
-$wollocation = $db->escape($url);
-$newtime = $onlinetime - 600;
-
-// clear out old entries and guests
-$db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ((ip='$onlineip' && username='xguest123') OR (username='$xmbuser') OR (time < '$newtime'))");
-$db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
-
 // Check what theme to use
 if ((int) $themeuser > 0) {
     $theme = (int) $themeuser;
@@ -499,11 +534,10 @@
     }
     $THEME[$key] = $val;
 }
-$imgdir = './'.$imgdir;
 $db->free_result($query);
 
 // additional CSS to load?
-if (file_exists($imgdir.'/theme.css')) {
+if (file_exists(ROOT.$imgdir.'/theme.css')) {
     $cssInclude = '<style type="text/css">'."\n"."@import url('".$imgdir."/theme.css');"."\n".'</style>';
 } else {
     $cssInclude = '';
@@ -545,7 +579,7 @@
     if (!isset($l['scheme']) || !isset($l['host'])) {
         $boardimg = $imgdir.'/'.$boardimg;
     }
-    $logo = '<a href="index.php"><img src="'.$boardimg.'" alt="'.$bbname.'" border="0" /></a>';
+    $logo = '<a href="./"><img src="'.$boardimg.'" alt="'.$bbname.'" border="0" /></a>';
 }
 
 // Font stuff...
@@ -554,136 +588,156 @@
 $font1 = $fontedit-1 . $fontsuf;
 $font3 = $fontedit+2 . $fontsuf;
 
-// Update lastvisit in the header shown
-if (isset($lastvisit) && X_MEMBER) {
-    $theTime = $xmblva + ($timeoffset * 3600) + ($addtime * 3600);
-    $lastdate = gmdate($dateformat, $theTime);
-    $lasttime = gmdate($timecode, $theTime);
-    $lastvisittext = $lang['lastactive'].' '.$lastdate.' '.$lang['textat'].' '.$lasttime;
-} else {
-    $lastvisittext = '';
-}
+// Set Extra Theme Keys
+$THEME['bgcode'] = $bgcode;
+$THEME['font1'] = $font1;
+$THEME['font3'] = $font3;
 
-// Checks for various settings
-if (empty($action)) {
-    $action = NULL;
-}
 
-// Gzip-compression
-if ($SETTINGS['gzipcompress'] == "on" && $action != "attachment") {
-    if (($res = @ini_get('zlib.output_compression')) === 1) {
-        // leave it
-    } else if ($res === false) {
-        // ini_get not supported. So let's just leave it
-    } else {
-        if (function_exists('gzopen')) {
-            $r = @ini_set('zlib.output_compression', 'On');
-            $r2 = @ini_set('zlib.output_compression_level', '3');
-            if (!$r || !$r2) {
-                ob_start('ob_gzhandler');
-            }
+/* Theme Ready.  Make pretty errors. */
+
+switch ($serror) {
+case 'ip':
+    if (!X_ADMIN) {
+        header('HTTP/1.0 403 Forbidden');
+        error($lang['bannedmessage']);
+    }
+    break;
+case 'bstatus':
+    if (!X_ADMIN) {
+        header('HTTP/1.0 503 Service Unavailable');
+        header('Retry-After: 3600');
+        if ($bboffreason != '') {
+            message(nl2br($bboffreason));
         } else {
-            ob_start('ob_gzhandler');
+            message($lang['textbstatusdefault']);
         }
     }
+    break;
+case 'guest':
+    if (X_GUEST) {
+        if ($SETTINGS['regstatus'] == 'on') {
+            $message = $lang['reggedonly'].' '.$reglink.' '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
+        } else {
+            $message = $lang['reggedonly'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
+        }
+        message($message);
+    }
+    break;
 }
 
-// Search-link
-if ($SETTINGS['searchstatus'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_search.gif" alt="'.$lang['altsearch'].'" border="0" /> <a href="misc.php?action=search"><font class="navtd">'.$lang['textsearch'].'</font></a>';
-}
 
-// Faq-link
-if ($SETTINGS['faqstatus'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_faq.gif" alt="'.$lang['altfaq'].'" border="0" /> <a href="faq.php"><font class="navtd">'.$lang['textfaq'].'</font></a>';
-}
+/* Finish HTML Templates */
 
-// Memberlist-link
-if ($SETTINGS['memliststatus'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_memberslist.gif" alt="'.$lang['altmemberlist'].'" border="0" /> <a href="misc.php?action=list"><font class="navtd">'.$lang['textmemberlist'].'</font></a>';
-}
+if ((X_ADMIN Or $SETTINGS['bbstatus'] == 'on') And (X_MEMBER Or $SETTINGS['regviewonly'] == 'off')) {
 
-// Today's posts-link
-if ($SETTINGS['todaysposts'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_todaysposts.gif" alt="'.$lang['alttodayposts'].'" border="0" /> <a href="today.php"><font class="navtd">'.$lang['navtodaysposts'].'</font></a>';
-}
+    $links = array();
 
-// Stats-link
-if ($SETTINGS['stats'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_stats.gif" alt="'.$lang['altstats'].'" border="0" /> <a href="stats.php"><font class="navtd">'.$lang['navstats'].'</font></a>';
-}
+    // Search-link
+    $searchlink = makeSearchLink();
 
-// 'Forum Rules'-link
-if ($SETTINGS['bbrules'] == 'on') {
-    $links[] = '<img src="'.$imgdir.'/top_bbrules.gif" alt="'.$lang['altrules'].'" border="0" /> <a href="faq.php?page=forumrules"><font class="navtd">'.$lang['textbbrules'].'</font></a>';
-}
+    // Faq-link
+    if ($SETTINGS['faqstatus'] == 'on') {
+        $links[] = '<img src="'.$imgdir.'/top_faq.gif" alt="'.$lang['altfaq'].'" border="0" /> <a href="faq.php"><font class="navtd">'.$lang['textfaq'].'</font></a>';
+    }
 
-$links = implode(' &nbsp; ', $links);
+    // Memberlist-link
+    if ($SETTINGS['memliststatus'] == 'on') {
+        $links[] = '<img src="'.$imgdir.'/top_memberslist.gif" alt="'.$lang['altmemberlist'].'" border="0" /> <a href="misc.php?action=list"><font class="navtd">'.$lang['textmemberlist'].'</font></a>';
+    }
 
-// Show all plugins
-$pluglinks = array();
-foreach($plugname as $plugnum => $item) {
-    if (!empty($plugurl[$plugnum]) && !empty($plugname[$plugnum])) {
-        if (trim($plugimg[$plugnum]) != '') {
-            $img = '&nbsp;<img src="'.$plugimg[$plugnum].'" border="0" />&nbsp;';
-        } else {
-            $img = '';
-        }
+    // Today's posts-link
+    if ($SETTINGS['todaysposts'] == 'on') {
+        $links[] = '<img src="'.$imgdir.'/top_todaysposts.gif" alt="'.$lang['alttodayposts'].'" border="0" /> <a href="today.php"><font class="navtd">'.$lang['navtodaysposts'].'</font></a>';
+    }
 
-        if ($plugadmin[$plugnum] != true || X_ADMIN) {
-            $pluglinks[] = $img.'<a href="'.$plugurl[$plugnum].'"><font class="navtd">'.$plugname[$plugnum].'</font></a>&nbsp;';
+    // Stats-link
+    if ($SETTINGS['stats'] == 'on') {
+        $links[] = '<img src="'.$imgdir.'/top_stats.gif" alt="'.$lang['altstats'].'" border="0" /> <a href="stats.php"><font class="navtd">'.$lang['navstats'].'</font></a>';
+    }
+
+    // 'Forum Rules'-link
+    if ($SETTINGS['bbrules'] == 'on') {
+        $links[] = '<img src="'.$imgdir.'/top_bbrules.gif" alt="'.$lang['altrules'].'" border="0" /> <a href="faq.php?page=forumrules"><font class="navtd">'.$lang['textbbrules'].'</font></a>';
+    }
+
+    $links = implode(' &nbsp; ', $links);
+
+    // Show all plugins
+    $pluglinks = array();
+    foreach($plugname as $plugnum => $item) {
+        if (!empty($plugurl[$plugnum]) && !empty($plugname[$plugnum])) {
+            if (trim($plugimg[$plugnum]) != '') {
+                $img = '&nbsp;<img src="'.$plugimg[$plugnum].'" border="0" alt="'.$plugname[$plugnum].'" />&nbsp;';
+            } else {
+                $img = '';
+            }
+
+            if ($plugadmin[$plugnum] != true || X_ADMIN) {
+                $pluglinks[] = $img.'<a href="'.$plugurl[$plugnum].'"><font class="navtd">'.$plugname[$plugnum].'</font></a>&nbsp;';
+            }
         }
     }
-}
 
-if (count($pluglinks) == 0) {
-    $pluglink = '';
-} else {
-    $pluglink = implode('&nbsp;', $pluglinks);
-}
+    if (count($pluglinks) == 0) {
+        $pluglink = '';
+    } else {
+        $pluglink = implode('&nbsp;', $pluglinks);
+    }
 
-// If the board is offline, display an appropriate message
-if ($SETTINGS['bbstatus'] == 'off' && !(X_ADMIN) && X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php') {
-    eval('$css = "'.template('css').'";');
-    message(nl2br(stripslashes($bboffreason)));
-}
+    // create forum jump
+    if ($SETTINGS['quickjump_status'] == 'on') {
+        $quickjump = forumJump();
+    }
 
-// If the board is set to 'reg-only' use, check if someone is logged in, and if not display a message
-if ($SETTINGS['regviewonly'] == 'on' && X_GUEST) {
-    if (($action != 'reg' && $action != 'login' && $action != 'lostpw' && $action != 'coppa' && $action != 'captchaimage') || (X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php')) {
-        $message = $lang['reggedonly'].' <a href="member.php?action=coppa">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-        eval('$css = "'.template('css').'";');
-        message($message);
+    // check for new u2u's
+    if (X_MEMBER) {
+        $query = $db->query("SELECT COUNT(*) FROM ".X_PREFIX."u2u WHERE owner='$xmbuser' AND folder='Inbox' AND readstatus='no'");
+        $newu2unum = $db->result($query, 0);
+        $db->free_result($query);
+        if ($newu2unum > 0) {
+            $newu2umsg = "<a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['newu2u1']} $newu2unum {$lang['newu2u2']}</a>";
+            // Popup Alert
+            if ($self['u2ualert'] == 2 Or ($self['u2ualert'] == 1 And X_SCRIPT == 'index.php')) {
+                $newu2umsg .= '<script language="JavaScript" type="text/javascript">function u2uAlert() { ';
+                if ($newu2unum == 1) {
+                    $newu2umsg .= 'u2uAlertMsg = "'.$lang['newu2u1'].' '.$newu2unum.$lang['u2ualert5'].'"; ';
+                } else {
+                    $newu2umsg .= 'u2uAlertMsg = "'.$lang['newu2u1'].' '.$newu2unum.$lang['u2ualert6'].'"; ';
+                }
+                $newu2umsg .= "if (confirm(u2uAlertMsg)) { Popup('u2u.php', 'testWindow', 700, 450); } } setTimeout('u2uAlert();', 10);</script>";
+            }
+        }
     }
 }
 
-// Check if the user is ip-banned
-$ips = explode(".", $onlineip);
-// also disable 'ban all'-possibility
-$query = $db->query("SELECT id FROM ".X_PREFIX."banned WHERE ((ip1='$ips[0]' OR ip1='-1') AND (ip2='$ips[1]' OR ip2='-1') AND (ip3='$ips[2]' OR ip3='-1') AND (ip4='$ips[3]' OR ip4='-1')) AND NOT (ip1='-1' AND ip2='-1' AND ip3='-1' AND ip4='-1')");
-$result = $db->num_rows($query);
-$db->free_result($query);
 
-// don't *ever* ban a (super-)admin!
-if (($self['status'] == 'Banned' || $result > 0) && !(X_ADMIN || (X_SCRIPT == 'misc.php' && $action == 'logout'))) {
-    eval('$css = "'.template('css').'";');
-    error($lang['bannedmessage']);
-}
+/* Perform HTTP Connection Maintenance */
 
-// if the user is registered, check for new u2u's
-$newu2umsg = '';
-if (X_MEMBER) {
-    $query = $db->query("SELECT COUNT(readstatus) FROM ".X_PREFIX."u2u WHERE owner='$xmbuser' AND folder='Inbox' AND readstatus='no'");
-    $newu2unum = $db->result($query, 0);
-    if ($newu2unum > 0) {
-        $newu2umsg = "<a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['newu2u1']} $newu2unum {$lang['newu2u2']}</a>";
+assertEmptyOutputStream('header.php');
+
+// Gzip-compression
+if ($SETTINGS['gzipcompress'] == 'on'
+ && $action != 'captchaimage'
+ && X_SCRIPT != 'files.php'
+ && !DEBUG) {
+    if (($res = @ini_get('zlib.output_compression')) === 1) {
+        // leave it
+    } else if ($res === false) {
+        // ini_get not supported. So let's just leave it
+    } else {
+        if (function_exists('gzopen')) {
+            $r = @ini_set('zlib.output_compression', 'On');
+            $r2 = @ini_set('zlib.output_compression_level', '3');
+            if (!$r || !$r2) {
+                ob_start('ob_gzhandler');
+            }
+        } else {
+            ob_start('ob_gzhandler');
+        }
     }
-    $db->free_result($query);
 }
 
-// create forum jump
-$quickjump = '';
-if ($SETTINGS['quickjump_status'] == 'on') {
-    $quickjump = forumJump();
-}
+assertEmptyOutputStream('header.php');
+return;
 ?>
Index: include/admin.inc.php
===================================================================
--- include/admin.inc.php	(revision 1746)
+++ include/admin.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
@@ -38,8 +38,8 @@
             return $lang['username_length_invalid'];
         }
 
-        $dbuserfrom = $db->escape($userfrom);
-        $dbuserto = $db->escape($userto);
+        $dbuserfrom = $db->escape_var($userfrom);
+        $dbuserto = $db->escape_var($userto);
         $dblikeuserfrom = $db->like_escape($userfrom);
         $dbregexuserfrom = $db->regexp_escape($userfrom);
         $userfrom = '';
@@ -75,16 +75,9 @@
         $db->query("UPDATE ".X_PREFIX."u2u SET owner='$dbuserto' WHERE owner='$dbuserfrom'");
         $db->query("UPDATE ".X_PREFIX."whosonline SET username='$dbuserto' WHERE username='$dbuserfrom'");
 
-        $query = $db->query("SELECT tid, lastpost from ".X_PREFIX."threads WHERE lastpost like '%|$dblikeuserfrom|%'");
-        while($result = $db->fetch_array($query)) {
-            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape($result['lastpost']));
-            $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$newlastpost' WHERE tid={$result['tid']}");
-        }
-        $db->free_result($query);
-
         $query = $db->query("SELECT ignoreu2u, uid FROM ".X_PREFIX."members WHERE (ignoreu2u REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($usr = $db->fetch_array($query)) {
-            $parts = explode(',', $db->escape($usr['ignoreu2u']));
+            $parts = explode(',', $db->escape_var($usr['ignoreu2u']));
             $index = array_search($dbuserfrom, $parts);
             $parts[$index] = $dbuserto;
             $parts = implode(',', $parts);
@@ -94,7 +87,7 @@
 
         $query = $db->query("SELECT moderator, fid FROM ".X_PREFIX."forums WHERE (moderator REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($list = $db->fetch_array($query)) {
-            $parts = explode(',', $db->escape($list['moderator']));
+            $parts = explode(',', $db->escape_var($list['moderator']));
             $index = array_search($dbuserfrom, $parts);
             $parts[$index] = $dbuserto;
             $parts = implode(', ', $parts);
@@ -104,7 +97,7 @@
 
         $query = $db->query("SELECT userlist, fid FROM ".X_PREFIX."forums WHERE (userlist REGEXP '(^|(,))()*$dbregexuserfrom()*((,)|$)')");
         while($list = $db->fetch_array($query)) {
-            $parts = array_unique(array_map('trim', explode(',', $db->escape($list['userlist']))));
+            $parts = array_unique(array_map('trim', explode(',', $db->escape_var($list['userlist']))));
             $index = array_search($dbuserfrom, $parts);
             $parts[$index] = $dbuserto;
             $parts = implode(', ', $parts);
@@ -114,160 +107,45 @@
 
         $query = $db->query("SELECT fid, lastpost FROM ".X_PREFIX."forums WHERE lastpost LIKE '%|$dblikeuserfrom|%'");
         while($result = $db->fetch_array($query)) {
-            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape($result['lastpost']));
+            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape_var($result['lastpost']));
             $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$newlastpost' WHERE fid={$result['fid']}");
         }
         $db->free_result($query);
 
-        $this->fix_last_posts();
+        $query = $db->query("SELECT tid, lastpost FROM ".X_PREFIX."threads WHERE lastpost LIKE '%|$dblikeuserfrom|%'");
+        while($result = $db->fetch_array($query)) {
+            $newlastpost = str_replace("|$dbuserfrom|", "|$dbuserto|", $db->escape_var($result['lastpost']));
+            $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$newlastpost' WHERE tid={$result['tid']}");
+        }
+        $db->free_result($query);
 
         return (($self['username'] == $userfrom) ? $lang['admin_rename_warn_self'] : '') . $lang['admin_rename_success'];
     }
 
-    function fix_last_posts() {
-        global $db;
-
-        $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE (fup='0' OR fup='') AND type='forum'");
-        while($loner = $db->fetch_array($q)) {
-            $lastpost = array();
-            $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup = '$loner[fid]'");
-            while($sub = $db->fetch_array($subq)) {
-                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
-                if ($db->num_rows($pq) > 0) {
-                    $curr = $db->fetch_array($pq);
-                    $lastpost[] = $curr;
-                    $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-                } else {
-                    $lp = '';
-                }
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
-                $db->free_result($pq);
-            }
-            $db->free_result($subq);
-
-            $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$loner[fid]' ORDER BY pid DESC LIMIT 1");
-            if ($db->num_rows($pq) > 0) {
-                $lastpost[] = $db->fetch_array($pq);
-            }
-            $db->free_result($pq);
-
-            if (count($lastpost) == 0) {
-                $lastpost = '';
-            } else {
-                $top = 0;
-                $mkey = -1;
-                foreach($lastpost as $key => $v) {
-                    if ($v['dateline'] > $top) {
-                        $mkey = $key;
-                        $top = $v['dateline'];
-                    }
-                }
-                $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
-            }
-            $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$loner[fid]'");
-        }
-        $db->free_result($q);
-
-        $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
-        while($cat = $db->fetch_array($q)) {
-            $fq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup='$cat[fid]'");
-            while($forum = $db->fetch_array($fq)) {
-                $lastpost = array();
-                $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$forum[fid]'");
-                while($sub = $db->fetch_array($subq)) {
-                    $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
-                    if ($db->num_rows($pq) > 0) {
-                        $curr = $db->fetch_array($pq);
-                        $lastpost[] = $curr;
-                        $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-                    } else {
-                        $lp = '';
-                    }
-                    $db->free_result($pq);
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
-                }
-                $db->free_result($subq);
-
-                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$forum[fid]' ORDER BY pid DESC LIMIT 1");
-                if ($db->num_rows($pq) > 0) {
-                    $lastpost[] = $db->fetch_array($pq);
-                }
-                $db->free_result($pq);
-
-                if (count($lastpost) == 0) {
-                    $lastpost = '';
-                } else {
-                    $top = 0;
-                    $mkey = -1;
-                    foreach($lastpost as $key => $v) {
-                        if ($v['dateline'] > $top) {
-                            $mkey = $key;
-                            $top = $v['dateline'];
-                        }
-                    }
-                    $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
-                }
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$forum[fid]'");
-            }
-            $db->free_result($fq);
-        }
-        $db->free_result($q);
-
-        $q = $db->query("SELECT tid FROM ".X_PREFIX."threads");
-        while($thread = $db->fetch_array($q)) {
-            $lastpost = array();
-            $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$thread[tid]' ORDER BY pid DESC LIMIT 1");
-            if ($db->num_rows($pq) > 0) {
-                $curr = $db->fetch_array($pq);
-                $lastpost[] = $curr;
-                $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-            } else {
-                $lp = '';
-            }
-            $db->free_result($pq);
-            $db->query("UPDATE ".X_PREFIX."threads SET lastpost = '$lp' WHERE tid = '$thread[tid]'");
-        }
-        $db->free_result($q);
-        return true;
-    }
-
     function check_restricted($userto) {
         global $db;
 
         $nameokay = true;
 
-        $find = array('<', '>', '|', '"', '[', ']', '\\', ',', '@', '\'');
-        foreach($find as $needle) {
-            if (false !== strpos($userto, $needle)) {
-                return false;
-            }
+        if ($userto != preg_replace('#[\]\'\x00-\x1F\x7F<>\\\\|"[,@]#', '', $userto)) {
+            return false;
         }
 
         $query = $db->query("SELECT * FROM ".X_PREFIX."restricted");
         while($restriction = $db->fetch_array($query)) {
-            if ($restriction['case_sensitivity'] == 1) {
-                if ($restriction['partial'] == 1) {
-                    if (strpos($userto, $restriction['name']) !== false) {
-                        $nameokay = false;
-                    }
-                } else {
-                    if ($userto == $restriction['name']) {
-                        $nameokay = false;
-                    }
-                }
-            } else {
+            if ($restriction['case_sensitivity'] == 0) {
                 $t_username = strtolower($userto);
                 $restriction['name'] = strtolower($restriction['name']);
+            }
 
-                if ($restriction['partial'] == 1) {
-                    if (strpos($t_username, $restriction['name']) !== false) {
-                        $nameokay = false;
-                    }
-                } else {
-                    if ($t_username == $restriction['name']) {
-                        $nameokay = false;
-                    }
+            if ($restriction['partial'] == 1) {
+                if (strpos($t_username, $restriction['name']) !== false) {
+                    $nameokay = false;
                 }
+            } else {
+                if ($t_username == $restriction['name']) {
+                    $nameokay = false;
+                }
             }
         }
         $db->free_result($query);
@@ -324,6 +202,7 @@
     &raquo;&nbsp;<a href="cp2.php?action=smilies"><?php echo $lang['smilies']?></a><br />
     &raquo;&nbsp;<a href="cp2.php?action=templates"><?php echo $lang['templates']?></a><br />
     &raquo;&nbsp;<a href="cp2.php?action=themes"><?php echo $lang['themes']?></a><br />
+    &raquo;&nbsp;<a href="cp2.php?action=lang"><?php echo $lang['translations']?></a><br />
     </td>
     </tr>
     <tr class="ctrcategory">
@@ -346,6 +225,8 @@
     &raquo;&nbsp;<a href="tools.php?action=fixttotals"><?php echo $lang['textfixthread']?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=fixorphanedthreads"><?php echo $lang['textfixothreads']?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=fixorphanedattachments"><?php echo $lang['textfixoattachments']?></a><br />
+    &raquo;&nbsp;<a href="tools.php?action=fixorphanedpolls"><?php echo $lang['textfixopolls']?></a><br />
+    &raquo;&nbsp;<a href="tools.php?action=fixorphanedposts"><?php echo $lang['textfixoposts']?></a><br />
     &raquo;&nbsp;<a href="tools.php?action=updatemoods"><?php echo $lang['textfixmoods']?></a><br />
     </td>
     <td class="tablerow" align="left" valign="top" width="20%" bgcolor="<?php echo $THEME['altbg2']?>">
@@ -382,7 +263,7 @@
     }
 }
 
-function printsetting1($setname, $varname, $check1, $check2) {
+function printsetting1(&$setname, $varname, &$check1, &$check2) {
     global $lang, $THEME;
 
     ?>
@@ -398,7 +279,7 @@
     <?php
 }
 
-function printsetting2($setname, $varname, $value, $size) {
+function printsetting2(&$setname, $varname, $value, $size) {
     global $THEME;
 
     ?>
@@ -409,7 +290,7 @@
     <?php
 }
 
-function printsetting3($setname, $boxname, $varnames, $values, $checked, $multi=true) {
+function printsetting3(&$setname, $boxname, $varnames, $values, $checked, $multi=true) {
     global $THEME, $selHTML;
 
     foreach($varnames as $key=>$val) {
@@ -428,14 +309,78 @@
     <?php
 }
 
-function printsetting4($settingDesc, $name, $value, $rows=5, $cols=50) {
+function printsetting4(&$settingDesc, $name, $value, $rows=5, $cols=50) {
     global $THEME;
 
     ?>
     <tr class="tablerow">
     <td bgcolor="<?php echo $THEME['altbg1']?>" valign="top"><?php echo $settingDesc?></td>
-    <td bgcolor="<?php echo $THEME['altbg2']?>"><textarea rows="<?php echo $rows; ?>" name="<?php echo $name; ?>" cols="<?php echo $cols; ?>"><?php echo $value?></textarea></td>
+    <td bgcolor="<?php echo $THEME['altbg2']?>"><textarea rows="<?php echo $rows; ?>" name="<?php echo $name; ?>" cols="<?php echo $cols; ?>">
+<?php // Linefeed required here - Do not edit!
+    echo $value;
+    ?></textarea></td>
     </tr>
     <?php
 }
-?>
\ No newline at end of file
+
+function printsetting5(&$settingDesc, &$errorMsg) {
+    global $THEME;
+
+    ?>
+    <tr class="tablerow">
+    <td bgcolor="<?php echo $THEME['altbg1']?>" valign="top"><?php echo $settingDesc; ?></td>
+    <td bgcolor="<?php echo $THEME['altbg2']?>"><?php echo $errorMsg; ?></td>
+    </tr>
+    <?php
+}
+
+function readFileAsINI(&$filename) {
+    $lines = file($filename);
+    foreach($lines as $line_num => $line) {
+        $temp = explode("=",$line);
+        if ($temp[0] != 'dummy') {
+            $key = trim($temp[0]);
+            $val = trim($temp[1]);
+            $thefile[$key] = $val;
+        }
+    }
+    return $thefile;
+}
+
+function dump_query($resource, $header=true) {
+    global $altbg2, $altbg1, $db, $cattext;
+    if (!$db->error()) {
+        $count = $db->num_fields($resource);
+        if ($header) {
+            ?>
+            <tr class="category" bgcolor="<?php echo $altbg2?>" align="center">
+            <?php
+            for($i=0;$i<$count;$i++) {
+                echo '<td align="left">';
+                echo '<strong><font color='.$cattext.'>'.$db->field_name($resource, $i).'</font></strong>';
+                echo '</td>';
+            }
+            echo '</tr>';
+        }
+
+        while($a = $db->fetch_array($resource, SQL_NUM)) {
+            ?>
+            <tr bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
+            <?php
+            for($i=0;$i<$count;$i++) {
+                echo '<td align="left">';
+
+                if (trim($a[$i]) == '') {
+                    echo '&nbsp;';
+                } else {
+                    echo nl2br(cdataOut($a[$i]));
+                }
+                echo '</td>';
+            }
+            echo '</tr>';
+        }
+    } else {
+        error($db->error());
+    }
+}
+?>
Index: include/buddy.inc.php
===================================================================
--- include/buddy.inc.php	(revision 1746)
+++ include/buddy.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit('Not allowed to run this file directly.');
 }
 
@@ -46,7 +46,7 @@
 }
 
 function buddy_add($buddys) {
-    global $db, $lang, $xmbuser, $oToken;
+    global $db, $lang, $xmbuser, $oToken, $full_url;
 
     if (!is_array($buddys)) {
         $buddys = array($buddys);
@@ -73,7 +73,7 @@
                     blistmsg($lang['nomember']);
                 } else {
                     $db->query("INSERT INTO ".X_PREFIX."buddys (buddyname, username) VALUES ('$buddy', '$xmbuser')");
-                    blistmsg($buddy.' '.$lang['buddyaddedmsg'], 'buddy.php');
+                    blistmsg($buddy.' '.$lang['buddyaddedmsg'], $full_url.'buddy.php');
                 }
             }
         }
@@ -100,14 +100,14 @@
 }
 
 function buddy_delete($delete) {
-    global $db, $lang, $xmbuser, $oToken;
+    global $db, $lang, $xmbuser, $oToken, $full_url;
     global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     foreach($delete as $key=>$buddy) {
         $db->query("DELETE FROM ".X_PREFIX."buddys WHERE buddyname='$buddy' AND username='$xmbuser'");
     }
 
-    blistmsg($lang['buddylistupdated'], 'buddy.php');
+    blistmsg($lang['buddylistupdated'], $full_url.'buddy.php');
 }
 
 /**
Index: include/captcha.inc.php
===================================================================
--- include/captcha.inc.php	(revision 1746)
+++ include/captcha.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -26,7 +25,57 @@
  *
  **/
 
-// class defaults
+if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
+    exit ("Not allowed to run this file directly.");
+}
+
+
+/***************************************************************/
+/* PhpCaptcha - A visual and audio CAPTCHA generation library
+
+  Software License Agreement (BSD License)
+
+  Copyright (C) 2005-2006, Edward Eliot.
+  All rights reserved.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions are met:
+
+     * Redistributions of source code must retain the above copyright
+       notice, this list of conditions and the following disclaimer.
+     * Redistributions in binary form must reproduce the above copyright
+       notice, this list of conditions and the following disclaimer in the
+       documentation and/or other materials provided with the distribution.
+     * Neither the name of Edward Eliot nor the names of its contributors
+       may be used to endorse or promote products derived from this software
+       without specific prior written permission of Edward Eliot.
+
+  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER AND CONTRIBUTORS "AS IS" AND ANY
+  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY
+  DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+  Last Updated:  18th April 2006                               */
+/***************************************************************/
+
+/************************ Documentation ************************/
+/*
+
+Documentation is available at http://www.ejeliot.com/pages/2
+
+*/
+/************************ Default Options **********************/
+
+
+// class defaults - change to effect globally
+
 define('CAPTCHA_WIDTH', $SETTINGS['captcha_image_width']);
 define('CAPTCHA_HEIGHT', $SETTINGS['captcha_image_width']);
 define('CAPTCHA_NUM_CHARS', $SETTINGS['captcha_code_length']);
@@ -42,10 +91,10 @@
 define('CAPTCHA_USE_COLOR', $SETTINGS['captcha_image_color'] == 'on' ? true : false);
 define('CAPTCHA_FILE_TYPE', $SETTINGS['captcha_image_type']);
 
-if (!defined('IN_CODE')) {
-    exit ("Not allowed to run this file directly.");
-}
+/************************ End Default Options **********************/
 
+// don't edit below this line (unless you want to change the class!)
+
 class Captcha {
     var $oImage;
     var $aFonts;
@@ -64,7 +113,9 @@
     var $bUseColor;
     var $sFileType;
     var $sCode = '';
+    // XMB Members
     var $bCompatible;
+    var $bPoison;
 
     function Captcha($iWidth = CAPTCHA_WIDTH, $iHeight = CAPTCHA_HEIGHT) {
         // get parameters
@@ -82,6 +133,8 @@
         $this->SetFileType(CAPTCHA_FILE_TYPE);
         $this->SetWidth($iWidth);
         $this->SetHeight($iHeight);
+        // Initialize XMB Members
+        $this->bPoison = FALSE;
         $this->CheckCompatibility();
     }
 
@@ -105,10 +158,6 @@
         $this->CalculateSpacing();
     }
 
-    function SetNumDots($iNumDots) {
-        $this->iNumDots = $iNumDots;
-    }
-
     function SetNumLines($iNumLines) {
         $this->iNumLines = $iNumLines;
     }
@@ -117,6 +166,10 @@
         $this->bCharShadow = $bCharShadow;
     }
 
+    //function SetOwnerText($sOwnerText) {  // Not used in XMB
+    //   $this->sOwnerText = $sOwnerText;
+    //}
+
     function SetCharSet($vCharSet) {
         // check for input type
         if (is_array($vCharSet)) {
@@ -152,94 +205,14 @@
         }
     }
 
-    function SetFonts($vFonts) {
-        // check for input type
-        if (is_array($vFonts)) {
-            $aFonts = $vFonts;
-        } else {
-            if ($vFonts != '') {
-                // split items on commas
-                $aFonts = explode(',', $vFonts);
-            } else {
-                $aFonts = array('fonts');
-            }
-        }
-
-        // initialise array
-        $this->aFonts = array();
-
-        // loop through items
-        foreach($aFonts as $sCurrentItem) {
-            if (is_dir($sCurrentItem)) {
-                $dir = opendir($sCurrentItem);
-                while($file = readdir($dir)) {
-                    if (false !== strpos($file, '.ttf')) {
-                        $this->aFonts[] = $sCurrentItem . '/' . $file;
-                    }
-                }
-            } else {
-                if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.ttf')) {
-                    $this->aFonts[] = $sCurrentItem;
-                } else if (is_file($sCurrentItem . '.ttf')) {
-                    $this->aFonts[] = $sCurrentItem . '.ttf';
-                } else if (is_file('./fonts/' . $sCurrentItem) && false !== strpos($sCurrentItem, '.ttf')) {
-                    $this->aFonts[] = './fonts/' .$sCurrentItem;
-                } else if (is_file('./fonts/' .$sCurrentItem . '.ttf')) {
-                    $this->aFonts[] = './fonts/' . $sCurrentItem . '.ttf';
-                }
-            }
-        }
-    }
-
     function CaseInsensitive($bCaseInsensitive) {
         $this->bCaseInsensitive = $bCaseInsensitive;
     }
 
-    function SetBackgroundImages($vBackgroundImages) {
-        // check for input type
-        if (is_array($vBackgroundImages)) {
-            $aBackgroundImages = $vBackgroundImages;
-        } else {
-            if ($vBackgroundImages != '') {
-                // split items on commas
-                $aBackgroundImages = explode(',', $vBackgroundImages);
-            } else {
-                $aBackgroundImages = array();
-            }
-        }
+    //function SetBackgroundImages($vBackgroundImages) {  // Replaced, See Below
+    //   $this->vBackgroundImages = $vBackgroundImages;
+    //}
 
-        // initialise array
-        $this->aBackgroundImages = array();
-
-        // loop through items
-        foreach($aBackgroundImages as $sCurrentItem) {
-            if (is_dir($sCurrentItem)) {
-                $dir = opendir($sCurrentItem);
-                while($file = readdir($dir)) {
-                    if (false !== strpos($file, '.png')) {
-                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
-                    } else if (false !== strpos($file, '.gif')) {
-                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
-                    } else if (false !== strpos($file, '.jpg')) {
-                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
-                    } else if (false !== strpos($file, '.jpeg')) {
-                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
-                    }
-                }
-            } else {
-                if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.png')) {
-                    $this->aBackgroundImages[] = $sCurrentItem;
-                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.gif')) {
-                    $this->aBackgroundImages[] = $sCurrentItem;
-                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.jpg')) {
-                    $this->aBackgroundImages[] = $sCurrentItem;
-                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.jpeg')) {
-                    $this->aBackgroundImages[] = $sCurrentItem;
-                }
-            }
-        }
-    }
-
     function SetMinFontSize($iMinFontSize) {
         $this->iMinFontSize = $iMinFontSize;
     }
@@ -261,30 +234,8 @@
         }
     }
 
-    function DrawDots($colors) {
-        $rmin = 0;
-        $rmax = 255;
-
-        for($i = 0; $i < $this->iNumDots; $i++) {
-            // allocate color
-            if ($this->bUseColor) {
-                $iDotColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
-            } else {
-                $iRandColor = rand($rmin, $rmax);
-                if (empty($this->aBackgroundImages)) {
-                    $iDotColor = $colors[$iRandColor];
-                } else {
-                    $iDotColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
-                }
-            }
-
-            // draw dot
-            imagesetpixel($this->oImage, rand(0, $this->iWidth), rand(0, $this->iHeight), $iDotColor);
-        }
-    }
-
     function DrawLines($bg_lum, $colors) {
-        // Choose a luminosity range that will always be similar to the background color.
+        //XMB chooses a lightness range that will always be similar to the background color.
         if ($bg_lum < 128) {
             $rmin = 0;
             $rmax = 145;
@@ -295,11 +246,11 @@
 
         for($i = 0; $i < $this->iNumLines; $i++) {
             // allocate color
-            if ($this->bUseColor) {
+            if ($this->bUseColor) {  // XMB forces true color mode to prevent palette overflow.
                 $iLineColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
             } else {
                 $iRandColor = rand($rmin, $rmax);
-                if (empty($this->aBackgroundImages)) {
+                if (empty($this->aBackgroundImages)) {  // XMB pre-allocates all greyscales to prevent palette overflow.
                     $iLineColor = $colors[$iRandColor];
                 } else {
                     $iLineColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
@@ -311,9 +262,28 @@
         }
     }
 
+    //function DrawOwnerText() {  // Not used in XMB
+    //   // allocate owner text colour
+    //   $iBlack = imagecolorallocate($this->oImage, 0, 0, 0);
+    //   // get height of selected font
+    //   $iOwnerTextHeight = imagefontheight(2);
+    //   // calculate overall height
+    //   $iLineHeight = $this->iHeight - $iOwnerTextHeight - 4;
+    //
+    //   // draw line above text to separate from CAPTCHA
+    //   imageline($this->oImage, 0, $iLineHeight, $this->iWidth, $iLineHeight, $iBlack);
+    //
+    //   // write owner text
+    //   imagestring($this->oImage, 2, 3, $this->iHeight - $iOwnerTextHeight - 3, $this->sOwnerText, $iBlack);
+    //
+    //   // reduce available height for drawing CAPTCHA
+    //   $this->iHeight = $this->iHeight - $iOwnerTextHeight - 5;
+    //}
+
     function GenerateCode() {
-        global $db, $onlinetime;
-        $db->query('DELETE FROM '.X_PREFIX.'captchaimages WHERE dateline < '.(time() - 86400));
+        // reset code
+        $this->sCode = '';
+
         // loop through and generate the code letter by letter
         for($i = 0; $i < $this->iNumChars; $i++) {
             if (count($this->aCharSet) >= $this->iNumChars) {
@@ -325,8 +295,10 @@
             }
         }
 
-        // save code in DB and return image hash.
+        // XMB saves code in DB and returns hashed code.
+        global $db, $onlinetime;
         $time = $onlinetime;
+        $this->bPoison = TRUE;
 
         if ($this->bCaseInsensitive) {
             $imagehash = md5(strtoupper($this->sCode));
@@ -334,29 +306,13 @@
             $imagehash = md5($this->sCode);
         }
 
+        $db->query('DELETE FROM '.X_PREFIX.'captchaimages WHERE dateline < '.(time() - 86400));
         $db->query("INSERT INTO ".X_PREFIX."captchaimages (imagehash, imagestring, dateline) VALUES ('$imagehash', '$this->sCode', '$time')");
         return $imagehash;
     }
 
-    function RetrieveCode($imghash) {
-        global $db;
-        // check imagehash
-        if ($imghash == 'test') {
-            $imgCode = 'CaPtChA';
-        } else {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."captchaimages WHERE imagehash='$imghash'");
-            $captchaimage = $db->fetch_array($query);
-            $db->free_result($query);
-            $imgCode = $captchaimage['imagestring'];
-        }
-
-        // reset code
-        $this->sCode = $imgCode;
-        return $imgCode;
-    }
-
     function DrawCharacters($bg_lum, $colors) {
-        // Choose a luminosity range that will never conflict with the background color.
+        // XMB chooses a lightness range that will never conflict with the background color.
         if ($bg_lum > 127) {
             $rmin = 0;
             $rmax = 110;
@@ -373,13 +329,14 @@
             // select random color
             if ($this->bUseColor) {
                $iTextColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
+               
                if ($this->bCharShadow) {
                    // shadow color
                    $iShadowColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
                 }
             } else {
                 $iRandColor = rand($rmin, $rmax);
-                if (empty($this->aBackgroundImages)) {
+                if (empty($this->aBackgroundImages)) {  // XMB pre-allocates all greyscales to prevent palette overflow.
                     $iTextColor = $colors[$iRandColor];
                 } else {
                     $iTextColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
@@ -387,7 +344,7 @@
                 if ($this->bCharShadow) {
                     // shadow color
                     $iRandColor = rand($rmin, $rmax);
-                    if (empty($this->aBackgroundImages)) {
+                    if (empty($this->aBackgroundImages)) {  // XMB pre-allocates all greyscales to prevent palette overflow.
                         $iShadowColor = $colors[$iRandColor];
                     } else {
                         $iShadowColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
@@ -411,18 +368,25 @@
 
             // write text to image
             imagefttext($this->oImage, $iFontSize, $iAngle, $iX, $iY, $iTextColor, $sCurrentFont, $this->sCode[$i], array());
+            
             if ($this->bCharShadow) {
                 $iOffsetAngle = rand(-30, 30);
+                
                 $iRandOffsetX = rand(-5, 5);
                 $iRandOffsetY = rand(-5, 5);
+                
                 imagefttext($this->oImage, $iFontSize, $iOffsetAngle, $iX + $iRandOffsetX, $iY + $iRandOffsetY, $iShadowColor, $sCurrentFont, $this->sCode[$i], array());
             }
         }
     }
 
     function WriteFile() {
+        // Explicitly re-run XMB's output stream check, and do not rely on the DEBUG constant.
+        assertEmptyOutputStream('misc.php (?) before the call to Captcha::WriteFile()', FALSE);
+
         // tell browser that data is jpeg
         header("Content-type: image/$this->sFileType");
+        
         switch($this->sFileType) {
             case 'gif':
                 imagegif ($this->oImage);
@@ -437,7 +401,10 @@
 
     function Create($imghash) {
         global $THEME;
-        // calculate color components of alternative background color 2 to match theme.
+
+        $this->bPoison = TRUE;
+
+        // XMB calculates the color components of alternative background color 2 to match theme.
         $bg_red = hexdec(substr($THEME['altbg2'], 1, 2));
         $bg_green = hexdec(substr($THEME['altbg2'], 3, 2));
         $bg_blue = hexdec(substr($THEME['altbg2'], 5, 2));
@@ -470,11 +437,12 @@
             // free memory used to create background image
             imagedestroy($oBackgroundImage);
         } else if ($this->bUseColor) {
+            // XMB forces true color mode to prevent palette overflow.
             $this->oImage = imagecreatetruecolor($this->iWidth, $this->iHeight);
             $bgcolor = imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
             imagefill($this->oImage, 0, 0, $bgcolor);
         } else {
-            // create new image
+            // XMB pre-allocates all greyscales to prevent palette overflow.
             $this->oImage = imagecreate($this->iWidth, $this->iHeight);
             imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
             for($i = 1; $i <= 255; $i++) {
@@ -496,15 +464,32 @@
         return true;
     }
 
-    // call this method statically
+
+    /* end Edward Eliot code */
+    /***************************************************************/
+    // All remaining functions are maintained for use with XMB.
+
+
     function ValidateCode($sUserCode, $imghash) {
         global $db;
 
-        if ($imghash == 'test') {
-            return false;
+        if ($this->bPoison) {
+            return FALSE;
         }
 
+        if (strlen($sUserCode) != CAPTCHA_NUM_CHARS Or $imghash == 'test') {
+            $this->bPoison = TRUE;
+            return FALSE;
+        }
+
         $this->RetrieveCode($imghash);
+
+        if ($this->bPoison) {
+            return FALSE;
+        }
+
+        $this->bPoison = TRUE;
+
         if ($this->bCaseInsensitive) {
             $sUserCode = strtoupper($sUserCode);
             $this->sCode = strtoupper($this->sCode);
@@ -513,20 +498,160 @@
         if ($sUserCode == $this->sCode) {
             // clear to prevent re-use
             $db->query("DELETE FROM ".X_PREFIX."captchaimages WHERE imagehash='$imghash'");
-            return true;
+            if ($db->affected_rows() === 1) {
+                return TRUE;
+            }
         }
-        return false;
+        return FALSE;
     }
 
+    function SetNumDots($iNumDots) {
+        $this->iNumDots = $iNumDots;
+    }
+
+    function SetFonts($vFonts) {
+        // check for input type
+        if (is_array($vFonts)) {
+            $aFonts = $vFonts;
+        } else {
+            if ($vFonts != '') {
+                // split items on commas
+                $aFonts = explode(',', $vFonts);
+            } else {
+                $aFonts = array('fonts');
+            }
+        }
+
+        // initialise array
+        $this->aFonts = array();
+
+        // loop through items
+        foreach($aFonts as $sCurrentItem) {
+            if (is_dir($sCurrentItem)) {
+                $dir = opendir($sCurrentItem);
+                while($file = readdir($dir)) {
+                    if (false !== strpos($file, '.ttf')) {
+                        $this->aFonts[] = $sCurrentItem . '/' . $file;
+                    }
+                }
+            } else {
+                if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.ttf')) {
+                    $this->aFonts[] = $sCurrentItem;
+                } else if (is_file($sCurrentItem . '.ttf')) {
+                    $this->aFonts[] = $sCurrentItem . '.ttf';
+                } else if (is_file('./fonts/' . $sCurrentItem) && false !== strpos($sCurrentItem, '.ttf')) {
+                    $this->aFonts[] = './fonts/' .$sCurrentItem;
+                } else if (is_file('./fonts/' .$sCurrentItem . '.ttf')) {
+                    $this->aFonts[] = './fonts/' . $sCurrentItem . '.ttf';
+                }
+            }
+        }
+    }
+
+    function SetBackgroundImages($vBackgroundImages) {
+        // check for input type
+        if (is_array($vBackgroundImages)) {
+            $aBackgroundImages = $vBackgroundImages;
+        } else {
+            if ($vBackgroundImages != '') {
+                // split items on commas
+                $aBackgroundImages = explode(',', $vBackgroundImages);
+            } else {
+                $aBackgroundImages = array();
+            }
+        }
+
+        // initialise array
+        $this->aBackgroundImages = array();
+
+        // loop through items
+        foreach($aBackgroundImages as $sCurrentItem) {
+            if (is_dir($sCurrentItem)) {
+                $dir = opendir($sCurrentItem);
+                while($file = readdir($dir)) {
+                    if (false !== strpos($file, '.png')) {
+                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
+                    } else if (false !== strpos($file, '.gif')) {
+                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
+                    } else if (false !== strpos($file, '.jpg')) {
+                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
+                    } else if (false !== strpos($file, '.jpeg')) {
+                        $this->aBackgroundImages[] = $sCurrentItem . '/' . $file;
+                    }
+                }
+            } else {
+                if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.png')) {
+                    $this->aBackgroundImages[] = $sCurrentItem;
+                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.gif')) {
+                    $this->aBackgroundImages[] = $sCurrentItem;
+                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.jpg')) {
+                    $this->aBackgroundImages[] = $sCurrentItem;
+                } else if (is_file($sCurrentItem) && false !== strpos($sCurrentItem, '.jpeg')) {
+                    $this->aBackgroundImages[] = $sCurrentItem;
+                }
+            }
+        }
+    }
+
+    function DrawDots($colors) {
+        $rmin = 0;
+        $rmax = 255;
+
+        for($i = 0; $i < $this->iNumDots; $i++) {
+            // allocate color
+            if ($this->bUseColor) {
+                $iDotColor = imagecolorallocate($this->oImage, rand($rmin, $rmax), rand($rmin, $rmax), rand($rmin, $rmax));
+            } else {
+                $iRandColor = rand($rmin, $rmax);
+                if (empty($this->aBackgroundImages)) {
+                    $iDotColor = $colors[$iRandColor];
+                } else {
+                    $iDotColor = imagecolorallocate($this->oImage, $iRandColor, $iRandColor, $iRandColor);
+                }
+            }
+
+            // draw dot
+            imagesetpixel($this->oImage, rand(0, $this->iWidth), rand(0, $this->iHeight), $iDotColor);
+        }
+    }
+
+    function RetrieveCode($imghash) {
+        global $db;
+        // check imagehash
+        if ($imghash == 'test') {
+            $imgCode = 'CaPtChA';
+        } else {
+            $query = $db->query("SELECT * FROM ".X_PREFIX."captchaimages WHERE imagehash='$imghash'");
+            if ($db->num_rows($query) !== 1) {
+                $bPoison = TRUE;
+                return FALSE;
+            }
+            $captchaimage = $db->fetch_array($query);
+            $db->free_result($query);
+            $imgCode = $captchaimage['imagestring'];
+        }
+
+        // reset code
+        $this->sCode = $imgCode;
+        return $imgCode;
+    }
+
     function CheckCompatibility() {
         // check for required gd functions
         if ($this->bCompatible === false) {
+            $this->bPoison = TRUE;
             return false;
-        } else if (!function_exists('imagecreate') || !function_exists("image$this->sFileType") || ($this->aBackgroundImages != '' && !function_exists('imagecreatetruecolor'))) {
+        } else if (!function_exists('imagecreate')
+                || !function_exists("image$this->sFileType")
+                || !function_exists('imagecreatetruecolor')
+                || !function_exists('imageftbbox')
+                || !function_exists('imagefttext')) {
             $this->bCompatible = false;
+            $this->bPoison = TRUE;
             return false;
         } else if (empty($this->aFonts)) {
             $this->bCompatible = false;
+            $this->bPoison = TRUE;
             return false;
         } else {
             $this->bCompatible = true;
@@ -534,4 +659,4 @@
         }
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/functions.inc.php
===================================================================
--- include/functions.inc.php	(revision 1746)
+++ include/functions.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,65 +26,65 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
-//loginUser() is responsible for accepting credentials for new sessions.
-//$xmbuserinput must be html escaped & db escaped username input.
-//$xmbpwinput must be raw password hash input.
-function loginUser($xmbuserinput, $xmbpwinput, $invisible=FALSE, $tempcookie=FALSE) {
-    global $server, $self, $onlineip, $misc, $onlinetime, $db, $cookiepath, $cookiedomain;
+/**
+ * Responsible for accepting credentials for new sessions.
+ *
+ * @param  string $xmbuserinput Must be html escaped & db escaped username input.
+ * @param  string $xmbpwinput   Must be raw password hash input.
+ * @param  bool   $invisible    Optional.
+ * @param  bool   $tempcookie   Optional.
+ * @return bool
+ */
+function loginUser($xmbuserinput, $xmbpwinput, $invisible=NULL, $tempcookie=FALSE) {
+    global $server, $self, $onlineip, $onlinetime, $db, $cookiepath, $cookiedomain, $cookiesecure;
 
-    if (elevateUser($xmbuserinput, $xmbpwinput)) {
-        $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ip='$onlineip' && username='xguest123'");
-        $currtime = $onlinetime + (86400*30);
+    if (elevateUser($xmbuserinput, $xmbpwinput, $invisible)) {
+        $dbname = $db->escape_var($self['username']);
 
-        $dbname = $db->escape($self['username']);
+        if (!is_null($invisible)) {
+            if ($invisible And $self['invisible'] == 0) {
+                $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$dbname'");
+                $self['invisible'] = 1;
+            } elseif (!$invisible And $self['invisible'] == 1) {
+                $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$dbname'");
+                $self['invisible'] = 0;
+            }
+        }
 
-        if ($invisible) {
-            $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$dbname'");
+        if ($tempcookie) {
+            $currtime = 0;
         } else {
-            $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$dbname'");
+            $currtime = $onlinetime + (86400*30);
         }
 
         if ($server == 'Mic') {
-            $misc = '<script>
-                function put_cookie(name, value, expires, path, domain, secure) {
-                    var curCookie = name + "=" + escape(value) +
-                    ((expires) ? "; expires=" + expires.toGMTString() : "") +
-                    ((path) ? "; path=" + path : "") +
-                    ((domain) ? "; domain=" + domain : "") +
-                    ((secure) ? "; secure" : "");
-                    document.cookie = curCookie;
-                }
-
-                var now = new Date();
-                now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
-
-                put_cookie("xmbuser", "'.$self['username'].'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
-                put_cookie("xmbpw", "'.$xmbpwinput.'", now, "'.$cookiepath.'", "'.$cookiedomain.'");
-            </script>';
+            $setusing = X_SET_JS;
         } else {
-            if ($tempcookie) {
-                put_cookie("xmbuser", $self['username'], NULL, $cookiepath, $cookiedomain);
-                put_cookie("xmbpw", $xmbpwinput, NULL, $cookiepath, $cookiedomain);
-            } else {
-                put_cookie("xmbuser", $self['username'], $currtime, $cookiepath, $cookiedomain);
-                put_cookie("xmbpw", $xmbpwinput, $currtime, $cookiepath, $cookiedomain);
-            }
-            $misc = '';
+            $setusing = X_SET_HEADER;
         }
+        put_cookie("xmbuser", $self['username'], $currtime, $cookiepath, $cookiedomain, $cookiesecure, $setusing);
+        put_cookie("xmbpw", $xmbpwinput, $currtime, $cookiepath, $cookiedomain, $cookiesecure, $setusing);
         return TRUE;
     } else {
         return FALSE;
     }
 }
 
-//elevateUser() is responsible for authenticating established sessions and setting up session variables.
-//$xmbuserinput must be html escaped & db escaped username input.
-//$xmbpwinput must be raw password hash input.
-function elevateUser($xmbuserinput, $xmbpwinput) {
-    global $xmbuser, $xmbpw, $self, $lang, $db, $charset, $SETTINGS, $onlineip;
+/**
+ * Responsible for authenticating established sessions and setting up session variables.
+ *
+ * @param  string $xmbuserinput Must be html escaped & db escaped username input.
+ * @param  string $xmbpwinput Must be raw password hash input.
+ * @param  int    $force_inv Optional.
+ * @param  string $serror Optional. Informs this function if any session errors occurred before authenticating.
+ * @return bool
+ */
+function elevateUser($xmbuserinput, $xmbpwinput, $force_inv=FALSE, $serror = '') {
+    global $xmbuser, $xmbpw, $self, $db, $SETTINGS, $status_enum;
 
     $xmbuser = '';
     $xmbpw = '';
@@ -96,88 +95,207 @@
     //$self['username'] is a good alternative for future template use.
     //$xmbpw was historically abused and will no longer contain a value.
 
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuserinput'");
-    if ($db->num_rows($query) == 1) {
-        $self = $db->fetch_array($query); //The self array will remain available, global.
-        if ($self['password'] == $xmbpwinput) {
-            $xmbuser = $db->escape($self['username']);
+    if (strlen($xmbuserinput) >= 3) {
+        $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuserinput'");
+        if ($db->num_rows($query) == 1) {
+            $self = $db->fetch_array($query); //The self array will remain available, global.
+            if ($serror == 'ip' And $self['status'] != 'Super Administrator' And $self['status'] != 'Administrator') {
+                // User is IP-Banned
+            } elseif ($self['password'] == $xmbpwinput) {
+                $xmbuser = $db->escape_var($self['username']);
+            }
+            $self['password'] = '';
         }
-        $self['password'] = '';
+        $db->free_result($query);
     }
-    $db->free_result($query);
 
     $xmbuserinput = '';
     $xmbpwinput = '';
 
-    //Database routine complete.  Now set the role constants.
+    //Database routine complete.  Now set the user status constants.
 
-    if ($xmbuser == '') {
-        $self = array();
-        $role['sadmin'] = false;
-        $role['admin']  = false;
-        $role['smod']   = false;
-        $role['mod']    = false;
-        $role['staff']  = false;
-        if (!defined('X_GUEST')) {
-            define('X_MEMBER', false);
-            define('X_GUEST', true);
+    if ($xmbuser != '') {
+        // Initialize the new translation system
+        if (X_SCRIPT != 'upgrade.php') {
+            if (!loadLang($self['langfile'])) {
+                if (!loadLang($SETTINGS['langfile'])) {
+                    require_once(ROOT.'include/translation.inc.php');
+                    langPanic();
+                }
+            }
         }
+
+        if ($self['status'] == 'Banned') {
+            $xmbuser = '';
+            $self = array();
+            $self['status'] = 'Banned';
+            if (!defined('X_GUEST')) {
+                define('X_MEMBER', FALSE);
+                define('X_GUEST', TRUE);
+            }
+        } else {
+            if (!defined('X_GUEST')) {
+                define('X_MEMBER', TRUE);
+                define('X_GUEST', FALSE);
+            }
+            $db->query("UPDATE ".X_PREFIX."members SET lastvisit=".$db->time(time())." WHERE username='$xmbuser'");
+        }
     } else {
-        if (!defined('X_GUEST')) {
-            define('X_MEMBER', true);
-            define('X_GUEST', false);
+        if (X_SCRIPT != 'upgrade.php') {
+            if (!loadLang($SETTINGS['langfile'])) {
+                require_once(ROOT.'include/translation.inc.php');
+                langPanic();
+            }
         }
 
-        switch($self['status']) {
-            case 'Super Administrator':
-                $role['sadmin'] = true;
-                $role['admin']  = true;
-                $role['smod']   = true;
-                $role['mod']    = true;
-                $role['staff']  = true;
-                break;
-            case 'Administrator':
-                $role['sadmin'] = false;
-                $role['admin']  = true;
-                $role['smod']   = true;
-                $role['mod']    = true;
-                $role['staff']  = true;
-                break;
-            case 'Super Moderator':
-                $role['sadmin'] = false;
-                $role['admin']  = false;
-                $role['smod']   = true;
-                $role['mod']    = true;
-                $role['staff']  = true;
-                break;
-            case 'Moderator':
-                $role['sadmin'] = false;
-                $role['admin']  = false;
-                $role['smod']   = false;
-                $role['mod']    = true;
-                $role['staff']  = true;
-                break;
-            default:
-                $role['sadmin'] = false;
-                $role['admin']  = false;
-                $role['smod']   = false;
-                $role['mod']    = false;
-                $role['staff']  = false;
-                break;
+        $self = array();
+        $self['status'] = '';
+        if (!defined('X_GUEST')) {
+            define('X_MEMBER', FALSE);
+            define('X_GUEST', TRUE);
         }
     }
 
+    // Enumerate status
+    if (isset($status_enum[$self['status']])) {
+        $int_status = $status_enum[$self['status']];
+    } else {
+        $int_status = $status_enum['Member']; // If $self['status'] contains an unknown value, default to Member.
+    }
+
     if (!defined('X_STAFF')) {
-        define('X_SADMIN', $role['sadmin']);
-        define('X_ADMIN', $role['admin']);
-        define('X_SMOD', $role['smod']);
-        define('X_MOD', $role['mod']);
-        define('X_STAFF', $role['staff']);
+        define('X_SADMIN', ($self['status'] == 'Super Administrator'));
+        define('X_ADMIN', ($int_status <= $status_enum['Administrator']));
+        define('X_SMOD', ($int_status <= $status_enum['Super Moderator']));
+        define('X_MOD', ($int_status <= $status_enum['Moderator']));
+        define('X_STAFF', X_MOD);
     }
 
+    // Set more globals
+    global $timeoffset, $themeuser, $status, $tpp, $ppp, $memtime, $dateformat,
+           $sig, $invisible, $timecode, $dformatorig, $onlineuser;
+
+    if ($xmbuser != '') {
+        $timeoffset = $self['timeoffset'];
+        $themeuser = $self['theme'];
+        $status = $self['status'];
+        $tpp = $self['tpp'];
+        $ppp = $self['ppp'];
+        $memtime = $self['timeformat'];
+        if ($self['dateformat'] != '') {
+            $dateformat = $self['dateformat'];
+        }
+        $sig = $self['sig'];
+        $invisible = $self['invisible'];
+        $onlineuser = $xmbuser;
+    } else {
+        $timeoffset = $SETTINGS['def_tz'];
+        $themeuser = '';
+        $status = 'member';
+        $tpp = $SETTINGS['topicperpage'];
+        $ppp = $SETTINGS['postperpage'];
+        $memtime = $SETTINGS['timeformat'];
+        $sig = '';
+        $invisible = 0;
+        $onlineuser = 'xguest123';
+        $self['ban'] = '';
+        $self['sig'] = '';
+        $self['uid'] = 0;
+        $self['username'] = '';
+    }
+    
+    if ($force_inv === TRUE) {
+        $invisible = 1;
+    }
+
+    if ($memtime == 24) {
+        $timecode = "H:i";
+    } else {
+        $timecode = "h:i A";
+    }
+
+    $dformatorig = $dateformat;
+    $dateformat = str_replace(array('mm', 'MM', 'dd', 'DD', 'yyyy', 'YYYY', 'yy', 'YY'), array('n', 'n', 'j', 'j', 'Y', 'Y', 'y', 'y'), $dateformat);
+
+    // Save This Session
+    if (X_ADMIN Or $serror == '' Or $serror == 'guest' And X_MEMBER) {
+        global $onlineip, $onlinetime, $url;
+
+        $wollocation = $db->escape_var($url);
+        $newtime = $onlinetime - 600;
+        $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ((ip='$onlineip' && username='xguest123') OR (username='$xmbuser') OR (time < '$newtime'))");
+        $db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
+    }
+    
     return ($xmbuser != '');
 }
 
+/**
+ * Uses the new translation database to populate the old $lang and $langfile variables.
+ *
+ * @param string $devname Name specified by XMB for internal use (usually written in English).
+ * @return bool
+ */
+function loadLang($devname = "English") {
+    global $charset, $db, $lang, $langfile;
+
+    $devname = $db->escape_var($devname);
+
+    // Query The Translation Database
+    $sql = 'SELECT k.langkey, t.cdata '
+         . 'FROM '.X_PREFIX.'lang_keys AS k'
+         . ' LEFT JOIN '.X_PREFIX.'lang_text AS t USING (phraseid)'
+         . ' INNER JOIN '.X_PREFIX.'lang_base AS b USING (langid)'
+         . "WHERE b.devname = '$devname'";
+    $result = $db->query($sql);
+
+    // Load the $lang array.
+    if ($db->num_rows($result) > 0) {
+        $langfile = $devname;
+        $lang = array();
+        while($row = $db->fetch_array($result)) {
+            $lang[$row['langkey']] = $row['cdata'];
+        }
+        $db->free_result($result);
+        $charset = $lang['charset'];
+        return TRUE;
+    } else {
+        return FALSE;
+    }
+}
+
+/**
+ * Uses the new translation database to retrieve a single phrase in all available languages.
+ *
+ * @param array $langkeys Of strings, used as the $lang array key.
+ * @return array Associative indexes lang_base.devname and lang_keys.langkey.
+ */
+function loadPhrases($langkeys) {
+    global $db;
+
+    $csv = "'".implode("', '", $langkeys)."'";
+
+    // Query The Translation Database
+    $sql = 'SELECT b.devname, t.cdata, k.langkey '
+         . 'FROM '.X_PREFIX.'lang_base AS b'
+         . ' LEFT JOIN '.X_PREFIX.'lang_text AS t USING (langid)'
+         . ' INNER JOIN '.X_PREFIX.'lang_keys AS k USING (phraseid)'
+         . "WHERE k.langkey IN ($csv)";
+    $result = $db->query($sql);
+
+    // Load the $lang array.
+    if ($db->num_rows($result) > 0) {
+        $phrases = array();
+        while($row = $db->fetch_array($result)) {
+            $phrases[$row['devname']][$row['langkey']] = $row['cdata'];
+        }
+        $db->free_result($result);
+        return $phrases;
+    } else {
+        return FALSE;
+    }
+}
+
 function nav($add=false, $raquo=true) {
     global $navigation;
 
@@ -191,18 +309,20 @@
 function template($name) {
     global $db, $comment_output;
 
+    $name = $db->escape_var($name);
+
     if (($template = templatecache(X_CACHE_GET, $name)) === false) {
         $query = $db->query("SELECT template FROM ".X_PREFIX."templates WHERE name='$name'");
         if ($db->num_rows($query) == 1) {
             if (X_SADMIN && DEBUG) {
-                trigger_error('Efficiency Notice: The template `'.$name.'` was not preloaded.', E_USER_NOTICE);
+                trigger_error('Efficiency Notice: The template "'.$name.'" was not preloaded.', E_USER_NOTICE);
             }
             $gettemplate = $db->fetch_array($query);
             templatecache(X_CACHE_PUT, $name, $gettemplate['template']);
             $template = $gettemplate['template'];
         } else {
             if (X_SADMIN && DEBUG) {
-                trigger_error('Efficiency Warning: The template `'.$name.'` could not be found.', E_USER_WARNING);
+                trigger_error('Efficiency Warning: The template "'.$name.'" could not be found.', E_USER_WARNING);
             }
         }
         $db->free_result($query);
@@ -280,7 +400,7 @@
     return $txt;
 }
 
-function smile($txt) {
+function smile(&$txt) {
     global $smiliesnum, $smiliecache, $smdir;
 
     if ($smiliesnum > 0) {
@@ -290,59 +410,17 @@
         }
     }
 
-    return $txt;
+    return TRUE;
 }
 
-function createAbsFSizeFromRel($rel) {
-    global $fontsize;
-    static $cachedFs;
-
-    if (!is_array($cachedFs) || count($cachedFs) != 2) {
-        preg_match('#([0-9]+)([a-z]+)?#i', $fontsize, $res);
-        $cachedFs[0] = $res[1];
-        $cachedFs[1] = $res[2];
-
-        if (empty($cachedFs[1])) {
-            $cachedFs[1] = 'px';
-        }
-    }
-
-    $o = ($rel+$cachedFs[0]).$cachedFs[1];
-
-    return $o;
-}
-
-function fixUrl($matches) {
-    $fullurl = '';
-    if (!empty($matches[2])) {
-        if ($matches[3] != 'www') {
-            $fullurl = $matches[2];
-        } else {
-            $fullurl = 'http://'.$matches[2];
-        }
-    }
-
-    $fullurl = strip_tags($fullurl);
-
-    $shorturl = '';
-    if (strlen($fullurl) > 80) {
-        $shorturl = substr($fullurl, 0, 80);
-        $shorturl = substr_replace($shorturl, '...', 77, 3);
-        return ' [url='.$fullurl.']'.$shorturl.'[/url]';
-    } else {
-        return ' <a href="'.$fullurl.'" target="_blank">'.$fullurl.'</a>';
-    }
-}
-
 function postify($message, $smileyoff='no', $bbcodeoff='no', $allowsmilies='yes', $allowhtml='yes', $allowbbcode='yes', $allowimgcode='yes', $ignorespaces=false, $ismood="no", $wrap="yes") {
-    global $imgdir, $bordercolor, $db, $smdir, $smiliecache, $censorcache, $smiliesnum, $wordsnum, $versionbuild, $fontsize;
 
     $bballow = ($allowbbcode == 'yes' || $allowbbcode == 'on') ? (($bbcodeoff != 'off' && $bbcodeoff != 'yes') ? true : false) : false;
     $smiliesallow = ($allowsmilies == 'yes' || $allowsmilies == 'on') ? (($smileyoff != 'off' && $smileyoff != 'yes') ? true : false) : false;
 
     if ($bballow) {
         if ($ismood == 'yes') {
-            $message = str_replace(array('[quote]', '[/quote]', '[code]', '[/code]', '[list]', '[/list]', '[list=1]', '[list=a]', '[list=A]', '[/list=1]', '[/list=a]', '[/list=A]', '[*]'), '_', $message);
+            $message = str_replace(array('[rquote=', '[quote]', '[/quote]', '[code]', '[/code]', '[list]', '[/list]', '[list=1]', '[list=a]', '[list=A]', '[/list=1]', '[/list=a]', '[/list=A]', '[*]'), '_', $message);
         }
 
         $begin = array(
@@ -384,63 +462,80 @@
             }
         }
 
+        // Balance [rquote] tags.
+        $rquotecount1 = 0;
+        $rquotecount2 = 0;
+        $pattern = "@\\[rquote=(\\d+)&(?:amp;)?tid=(\\d+)&(?:amp;)?author=(.+?)]@si";
+        $rquotecount1 = preg_match_all($pattern, $message, $matches);
+        $pattern = "@\\[/rquote]@si";
+        $rquotecount2 = preg_match_all($pattern, $message, $matches);
+        $rquotecount1 -= $rquotecount2;
+        if ($rquotecount1 > 0) {
+            $message .= str_repeat('[/rquote]', $rquotecount1);
+        } elseif ($rquotecount1 < 0) {
+            $message = preg_replace('@\\[/rquote]@si', '[/ rquote]', $message, -$rquotecount1);
+        }
+
         $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
         for($i = 0; $i < sizeof($messagearray); $i++) {
             if (sizeof($messagearray) != 1) {
                 if ($i == 0) {
                     $messagearray[$i] = rawHTMLmessage($messagearray[$i], $allowhtml)."[code]";
                     if ($smiliesallow) {
-                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
-                    } else {
-                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                        smile($messagearray[$i]);
                     }
+                    bbcode($messagearray[$i], $allowimgcode);
                 } else if ($i == sizeof($messagearray) - 1) {
                     $messagearray[$i] = "[/code]".rawHTMLmessage($messagearray[$i], $allowhtml);
                     if ($smiliesallow) {
-                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
-                    } else {
-                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                        smile($messagearray[$i]);
                     }
+                    bbcode($messagearray[$i], $allowimgcode);
                 } else if ($i % 2 == 0) {
                     $messagearray[$i] = "[/code]".rawHTMLmessage($messagearray[$i], $allowhtml)."[code]";
                     if ($smiliesallow) {
-                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
-                    } else {
-                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                        smile($messagearray[$i]);
                     }
+                    bbcode($messagearray[$i], $allowimgcode);
                 } else { // Inside code block
                     $messagearray[$i] = censor($messagearray[$i]);
                 }
             } else {
                 $messagearray[0] = rawHTMLmessage($messagearray[0], $allowhtml);
                 if ($smiliesallow) {
-                    $messagearray[0] = bbcode(smile($messagearray[0]), $allowimgcode);
-                } else {
-                    $messagearray[0] = bbcode($messagearray[0], $allowimgcode);
+                    smile($messagearray[0]);
                 }
+                bbcode($messagearray[0], $allowimgcode);
             }
         }
         $message = implode("", $messagearray);
+
+        $message = nl2br($message);
+
+        $messagearray = preg_split("#<!-- nobr -->|<!-- /nobr -->#", $message);
+        for($i = 0; $i < sizeof($messagearray); $i++) {
+            if ($i % 2 == 0) {
+                $messagearray[$i] = wordwrap($messagearray[$i], 150, "\n", TRUE);
+            } // else inside nobr block
+        }
+        $message = implode("", $messagearray);
+
     } else {
         $message = rawHTMLmessage($message, $allowhtml);
         if ($smiliesallow) {
             smile($message);
         }
+        $message = nl2br($message);
+        $message = wordwrap($message, 150, "\n", TRUE);
     }
 
-    $message = nl2br($message);
-    if ($wrap == "yes") {
-        $message = wordwrap($message, 150, "\n", 1);
-        $message = preg_replace('#(\[/?.*)\n(.*\])#mi', '\\1\\2', $message);
-    }
-
     $message = preg_replace('#(script|about|applet|activex|chrome):#Sis',"\\1 &#058;",$message);
 
     return $message;
 }
 
-function bbcode($message, $allowimgcode) {
-    global $lang;
+function bbcode(&$message, $allowimgcode) {
+    global $lang, $imgdir;
 
     $find = array(
         0 => '[b]',
@@ -467,8 +562,7 @@
         21 => '[/list=1]',
         22 => '[/list=a]',
         23 => '[/list=A]',
-        24 => '[*]',
-        25 => '<br />'
+        24 => '[*]'
     );
 
     $replace = array(
@@ -484,9 +578,9 @@
         9 => '</blink>',
         10 => '<strike>',
         11 => '</strike>',
-        12 => '</font><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage">',
+        12 => '</font> <!-- nobr --><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage"><!-- /nobr -->',
         13 => ' </td></tr></table><font class="mediumtxt">',
-        14 => '</font><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr>'."\n".'<tr><td class="codemessage">',
+        14 => '</font> <!-- nobr --><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr><tr><td class="codemessage"><!-- /nobr -->',
         15 => '</td></tr></table><font class="mediumtxt">',
         16 => '<ul type="square">',
         17 => '</ul>',
@@ -496,8 +590,7 @@
         21 => '</ol>',
         22 => '</ol>',
         23 => '</ol>',
-        24 => '<li />',
-        25 => '<br />'
+        24 => '<li />'
     );
 
     $message = str_replace($find, $replace, $message);
@@ -505,46 +598,179 @@
     $patterns = array();
     $replacements = array();
 
-    $patterns[] = "#\[color=([^\"'<>]*?)\](.*?)\[/color\]#Ssi";
+    $patterns[] = "@\\[rquote=(\\d+)&(?:amp;)?tid=(\\d+)&(?:amp;)?author=(.+?)]@si";
+    $replacements[] = '</font> <!-- nobr --><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].' <a href="viewthread.php?tid=$2&amp;goto=search&amp;pid=$1" rel="nofollow">'.$lang['origpostedby'].' $3 &nbsp;<img src="'.$imgdir.'/lastpost.gif" border="0" alt="" style="vertical-align: middle;" /></a></td></tr><tr><td class="quotemessage"><!-- /nobr -->';
+    $patterns[] = "@\\[/rquote]@si";
+    $replacements[] = ' </td></tr></table><font class="mediumtxt">';
+
+    $patterns[] = "@\[color=(White|Black|Red|Yellow|Pink|Green|Orange|Purple|Blue|Beige|Brown|Teal|Navy|Maroon|LimeGreen|aqua|fuchsia|gray|silver|lime|olive)\](.*?)\[/color\]@Ssi";
     $replacements[] = '<span style="color: $1;">$2</span>';
-    $patterns[] = "#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssie";
-    $replacements[] = '"<span style=\"font-size: ".createAbsFSizeFromRel(\'$1\').";\">".stripslashes(\'$2\')."</span>"';
+    $patterns[] = "@\[color=#([\\da-f]{3,6})\](.*?)\[/color\]@Ssi";
+    $replacements[] = '<span style="color: #$1;">$2</span>';
+    $patterns[] = "@\[color=rgb\\(([\\s]*[\\d]{1,3}%?[\\s]*,[\\s]*[\\d]{1,3}%?[\\s]*,[\\s]*[\\d]{1,3}%?[\\s]*)\\)\](.*?)\[/color\]@Ssi";
+    $replacements[] = '<span style="color: rgb($1);">$2</span>';
     $patterns[] = "#\[font=([a-z\r\n\t 0-9]+)\](.*?)\[/font\]#Ssi";
     $replacements[] = '<span style="font-family: $1;">$2</span>';
-    $patterns[] = "#\[align=(left|center|right|justify)\](.+?)\[/align\]#Ssi";
+    $patterns[] = "#\[align=(left|center|right|justify)\](.*?)\[/align\]#Ssi";
     $replacements[] = '<div style="text-align: $1;">$2</div>';
+    $patterns[] = "@\\[pid=(\\d+)&amp;tid=(\\d+)](.*?)\\[/pid]@si";
+    $replacements[] = '<a <!-- nobr -->href="viewthread.php?tid=$2&amp;goto=search&amp;pid=$1"><strong><!-- /nobr -->$3</strong> &nbsp;<img src="'.$imgdir.'/lastpost.gif" border="0" alt="" style="vertical-align: middle;" /></a>';
 
     if ($allowimgcode != 'no' && $allowimgcode != 'off') {
         if (false == stripos($message, 'javascript:')) {
             $patterns[] = '#\[img\](http[s]?|ftp[s]?){1}://([:a-z\\./_\-0-9%~]+){1}\[/img\]#Smi';
-            $replacements[] = '<img src="\1://\2\3" border="0" alt="\1://\2\3"/>';
+            $replacements[] = '<img <!-- nobr -->src="\1://\2\3"<!-- /nobr --> border="0" alt="" />';
             $patterns[] = "#\[img=([0-9]*?){1}x([0-9]*?)\](http[s]?|ftp[s]?){1}://([:~a-z\\./0-9_\-%]+){1}(\?[a-z=0-9&_\-;~]*)?\[/img\]#Smi";
-            $replacements[] = '<img width="\1" height="\2" src="\3://\4\5" alt="\3://\4\5" border="0" />';
+            $replacements[] = '<img width="\1" height="\2" <!-- nobr -->src="\3://\4\5"<!-- /nobr --> alt="" border="0" />';
         }
     }
 
     $message = preg_replace_callback('#(^|\s|\()((((http(s?)|ftp(s?))://)|www)[-a-z0-9.]+\.[a-z]{2,4}[^\s()]*)i?#Smi', 'fixUrl', $message);
 
-    $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]*?)\[/url\]#Smi";
-    $replacements[] = '<a href="\1\2" target="_blank">\1\2</a>';
-    $patterns[] = "#\[url\]([^\[\"'<>]*?)\[/url\]#Smi";
-    $replacements[] = '<a href="http://\1" target="_blank">\1</a>';
+    //[url]http://www.example.com/[/url]
+    $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]{0,60}?)\[/url\]#Smi";  //Match only if length is <= 60 chars
+    $replacements[] = '<a <!-- nobr -->href="\1\2" onclick="window.open(this.href); return false;"><!-- /nobr -->\1\2</a>';
+    $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>\[\]]{60})([^\"'<>]*?)\[/url\]#Smi";  //Match only if length is >= 60 chars
+    $replacements[] = ' <!-- nobr --><a href="\1\2\3" onclick="window.open(this.href); return false;">\1\2...</a><!-- /nobr --> ';
+
+    //[url]www.example.com[/url]
+    $patterns[] = "#\[url\]([^\[\"'<>]{0,60}?)\[/url\]#Smi";  //Match only if length is <= 60 chars
+    $replacements[] = '<a <!-- nobr -->href="http://\1" onclick="window.open(this.href); return false;"><!-- /nobr -->\1</a>';
+    $patterns[] = "#\[url\]([^\"'<>\[\]]{60})([^\"'<>]*?)\[/url\]#Smi";  //Match only if length is >= 60 chars
+    $replacements[] = ' <!-- nobr --><a href="http://\1\2" onclick="window.open(this.href); return false;">\1...</a><!-- /nobr --> ';
+
+    //[url=http://www.example.com]Lorem Ipsum[/url]
     $patterns[] = "#\[url=([a-z]+?://){1}([^\"'<>\[\]]*?)\](.*?)\[/url\]#Smi";
-    $replacements[] = '<a href="\1\2" target="_blank">\3</a>';
+    $replacements[] = '<a <!-- nobr -->href="\1\2" onclick="window.open(this.href); return false;"><!-- /nobr -->\3</a>';
+
+    //[url=www.example.com]Lorem Ipsum[/url]
     $patterns[] = "#\[url=([^\[\"'<>]*?)\](.*?)\[/url\]#Smi";
-    $replacements[] = '<a href="http://\1" target="_blank">\2</a>';
+    $replacements[] = '<a <!-- nobr -->href="http://\1" onclick="window.open(this.href); return false;"><!-- /nobr -->\2</a>';
+
     $patterns[] = "#\[email\]([^\"'<>]*?)\[/email\]#Smi";
     $replacements[] = '<a href="mailto:\1">\1</a>';
     $patterns[] = "#\[email=([^\"'<>]*?){1}([^\"]*?)\](.*?)\[/email\]#Smi";
     $replacements[] = '<a href="mailto:\1\2">\3</a>';
 
-    return preg_replace($patterns, $replacements, $message);
+    $message = preg_replace($patterns, $replacements, $message);
+
+    $message = preg_replace_callback("#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssi", 'bbcodeSizeTags', $message);
+
+    return TRUE;
 }
 
-function modcheck($username, $mods) {
+function fixUrl($matches) {
+    $fullurl = '';
+    if (!empty($matches[2])) {
+        if ($matches[3] != 'www') {
+            $fullurl = $matches[2];
+        } else {
+            $fullurl = 'http://'.$matches[2];
+        }
+    }
 
+    $fullurl = strip_tags($fullurl);
+
+    return $matches[1].'[url]'.$fullurl.'[/url]';
+}
+
+/**
+ * Replaces createAbsFSizeFromRel() to eliminate the /e in size bbcode regex.
+ *
+ * @since 1.9.11 Alpha Three
+ */
+function bbcodeSizeTags($matches) {
+    global $fontsize;
+    static $cachedFs;
+
+    if (!is_array($cachedFs) || count($cachedFs) != 2) {
+        preg_match('#([0-9]+)([a-z]+)?#i', $fontsize, $res);
+        $cachedFs[0] = $res[1];
+        $cachedFs[1] = $res[2];
+
+        if (empty($cachedFs[1])) {
+            $cachedFs[1] = 'px';
+        }
+    }
+
+    $o = ($matches[1]+$cachedFs[0]).$cachedFs[1];
+
+    $html = "<span style=\"font-size: $o;\">{$matches[2]}</span>";
+
+    return $html;
+}
+
+/**
+ * Processes tags like [file]1234[/file]
+ *
+ * Caller must include attach.inc.php, query the attachments table,
+ * and load the needed templates.
+ *
+ * @param string $message Read/Write Variable.  Returns the processed HTML.
+ * @param array  $files   Read-Only Variable.  Contains the result rows from an attachment query.
+ * @param int    $pid     Pass zero when in newthread or reply preview.
+ * @param bool   $bBBcodeOnForThisPost
+ */
+function bbcodeFileTags(&$message, &$files, $pid, $bBBcodeOnForThisPost) {
+    global $lang, $SETTINGS;
+    
+    $pid = intval($pid);
+    $count = 0;
+    $seperator = '';
+    foreach($files as $attach) {
+        $post = array();
+        $post['filename'] = attrOut($attach['filename']);
+        $post['filetype'] = attrOut($attach['filetype']);
+        $post['fileurl'] = getAttachmentURL($attach['aid'], $pid, $attach['filename']);
+        $attachsize = getSizeFormatted($attach['filesize']);
+
+        $post['filedims'] = '';
+        $output = '';
+        $prefix = '';
+        $extention = strtolower(get_extension($post['filename']));
+        if ($SETTINGS['attachimgpost'] == 'on' && ($extention == 'jpg' || $extention == 'jpeg' || $extention == 'jpe' || $extention == 'gif' || $extention == 'png' || $extention == 'bmp')) {
+            if (intval($attach['thumbid'] > 0)) {
+                $post['thumburl'] = getAttachmentURL($attach['thumbid'], $pid, $attach['thumbname']);
+                $result = explode('x', $attach['thumbsize']);
+                $post['filedims'] = 'width="'.$result[0].'px" height="'.$result[1].'px"';
+                eval('$output = "'.template('viewthread_post_attachmentthumb').'";');
+            } else {
+                if ($attach['img_size'] != '') {
+                    $result = explode('x', $attach['img_size']);
+                    $post['filedims'] = 'width="'.$result[0].'px" height="'.$result[1].'px"';
+                }
+                eval('$output = "'.template('viewthread_post_attachmentimage').'";');
+            }
+            $seperator = '';
+        } else {
+            $downloadcount = $attach['downloads'];
+            if ($downloadcount == '') {
+                $downloadcount = 0;
+            }
+            eval('$output = "'.template('viewthread_post_attachment').'";');
+            if ($seperator == '') {
+                $prefix = "<br /><br />";
+            }
+            $seperator = "<br /><br />";
+        }
+        if ($count == 0) {
+            $prefix = "<br /><br />";
+        }
+        $matches = 0;
+        if ($bBBcodeOnForThisPost) {
+            $message = preg_replace('@\\[file]'.$attach['aid'].'\\[/file]@', $output, $message, 1, $matches);
+        }
+        if ($matches == 0) {
+            $message .= $prefix.$output.$seperator; // Do we need some sort of a seperator template here?
+            $count++;
+        }
+    }
+}
+
+function modcheck($username, $mods, $override=X_SMOD) {
+
     $retval = '';
-    if (X_SMOD) {
+    if ($override) {
         $retval = 'Moderator';
     } else if (X_MOD) {
         $username = strtoupper($username);
@@ -560,7 +786,7 @@
     return $retval;
 }
 
-function modcheckPost($username, $mods, $origstatus) {
+function modcheckPost(&$username, &$mods, &$origstatus) {
     global $SETTINGS;
     $retval = modcheck($username, $mods);
 
@@ -588,9 +814,11 @@
     return $retval;
 }
 
-function forum($forum, $template) {
-    global $timecode, $dateformat, $lang, $xmbuser, $self, $lastvisit2, $timeoffset, $hideprivate, $addtime, $oldtopics, $lastvisit;
-    global $altbg1, $altbg2, $imgdir, $THEME, $SETTINGS, $index_subforums;
+// As of version 1.9.11, function forum() is not responsible for any permissions checking.
+// Caller should use permittedForums() or getStructuredForums() instead of querying for the parameters.
+function forum($forum, $template, $index_subforums) {
+    global $timecode, $dateformat, $lang, $timeoffset, $oldtopics, $lastvisit;
+    global $altbg1, $altbg2, $imgdir, $THEME, $SETTINGS;
 
     $forum['name'] = fnameOut($forum['name']);
     $forum['description'] = html_entity_decode($forum['description']);
@@ -627,104 +855,174 @@
     }
 
     $foruminfo = '';
-    $perms = checkForumPermissions($forum);
-    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
-        if (isset($forum['moderator']) && $forum['moderator'] != '') {
-            $moderators = explode(', ', $forum['moderator']);
-            $forum['moderator'] = array();
-            for($num = 0; $num < count($moderators); $num++) {
-                $forum['moderator'][] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($moderators[$num]).'">'.$moderators[$num].'</a>';
-            }
-            $forum['moderator'] = implode(', ', $forum['moderator']);
-            $forum['moderator'] = '('.$lang['textmodby'].' '.$forum['moderator'].')';
+
+    if (isset($forum['moderator']) && $forum['moderator'] != '') {
+        $moderators = explode(', ', $forum['moderator']);
+        $forum['moderator'] = array();
+        for($num = 0; $num < count($moderators); $num++) {
+            $forum['moderator'][] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($moderators[$num]).'">'.$moderators[$num].'</a>';
         }
+        $forum['moderator'] = implode(', ', $forum['moderator']);
+        $forum['moderator'] = '('.$lang['textmodby'].' '.$forum['moderator'].')';
+    }
 
-        $subforums = array();
-        if (count($index_subforums) > 0) {
-            for($i=0; $i < count($index_subforums); $i++) {
-                $sub = $index_subforums[$i];
-                $subperms = checkForumPermissions($sub);
-                if ($sub['fup'] == $forum['fid']) {
-                    if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $subperms[X_PERMS_VIEW] || $subperms[X_PERMS_USERLIST]) {
-                        $subforums[] = '<a href="forumdisplay.php?fid='.intval($sub['fid']).'">'.fnameOut($sub['name']).'</a>';
-                    }
-                }
+    $subforums = array();
+    if (count($index_subforums) > 0) {
+        for($i=0; $i < count($index_subforums); $i++) {
+            $sub = $index_subforums[$i];
+            if ($sub['fup'] == $forum['fid']) {
+                $subforums[] = '<a href="forumdisplay.php?fid='.intval($sub['fid']).'">'.fnameOut($sub['name']).'</a>';
             }
         }
+    }
 
-        if (!empty($subforums)) {
-            $subforums = implode(', ', $subforums);
-            $subforums = '<br /><strong>'.$lang['textsubforums'].'</strong> '.$subforums;
-        } else {
-            $subforums = '';
-        }
-        eval('$foruminfo = "'.template($template).'";');
+    if (!empty($subforums)) {
+        $subforums = implode(', ', $subforums);
+        $subforums = '<br /><strong>'.$lang['textsubforums'].'</strong> '.$subforums;
+    } else {
+        $subforums = '';
     }
+    eval('$foruminfo = "'.template($template).'";');
 
     $dalast = '';
 
     return $foruminfo;
 }
 
-function multi($num, $perpage, $page, $mpurl, $strict = false) {
-    $multipage = $GLOBALS['lang']['textpages'];
+/**
+ * Handles most of the I/O tasks to create a collection of numbered pages
+ * from an ordered collection of items.
+ *
+ * Caller must echo the returned html directly or in a template variable.
+ *
+ * @param int $num Total number of items in the collection.
+ * @param int $perpage Number of items to display on each page.
+ * @param string $baseurl Relative URL of the first page in the collection.
+ * @param mixed $canonical Optional. Specify FALSE if the $baseurl param is not a canonical URL. Specify a Relative URL string to override $baseurl.
+ * @return array Associative indexes: 'html' the link bar string, 'start' the LIMIT int used in queries.
+ */
+function multipage($num, $perpage, $baseurl, $canonical = TRUE) {
+    global $cookiepath, $full_url, $lang, $url;
+    
+    // Initialize
+    $return = array();
+    $page = getInt('page');
+    $max_page = quickpage(intval($num), intval($perpage));
+    if ($canonical === TRUE) $canonical =& $baseurl;
 
-    $pages = quickpage($num, $perpage);
+    // Calculate the LIMIT start number for queries
+    if ($page > 1 && $page <= $max_page) {
+        $return['start'] = ($page-1) * $perpage;
+        if ($canonical !== FALSE) setCanonicalLink($canonical.((strpos($baseurl, '?') !== FALSE) ? '&amp;' : '?').'page='.$page);
+    } elseif ($page == 0 And !isset($_GET['page'])) {
+        $return['start'] = 0;
+        $page = 1;
+        if ($canonical !== FALSE) setCanonicalLink($canonical);
+    } elseif ($page == 1) {
+        $newurl = preg_replace('/[^\x20-\x7e]/', '', $url);
+        $newurl = str_replace('&page=1', '', $newurl);
+        $newurl = substr($full_url, 0, -strlen($cookiepath)).$newurl;
+        header('HTTP/1.0 301 Moved Permanently');
+        header('Location: '.$newurl);
+        exit;
+    } else {
+        header('HTTP/1.0 404 Not Found');
+        error($lang['generic_missing']);
+    }
+    
+    // Generate the multipage link bar.
+    $return['html'] = multi($page, $max_page, $baseurl);
+    
+    return $return;
+}
 
-    if ($pages > 1) {
-        if ($page == 0) {
-            if ($pages < 4) {
-                $to = $pages;
-            } else {
-                $to = 3;
-            }
-        } else if ($page == $pages) {
-            $to = $pages;
-        } else if ($page == $pages-1) {
-            $to = $page+1;
-        } else if ($page == $pages-2) {
-            $to = $page+2;
+/**
+ * Generates an HTML page-selection bar for any collection of numbered pages.
+ *
+ * The link to each page in the collection will have the "page" variable added
+ * to its query string, except for page number one.
+ *
+ * @param int $page Current page number, must be >= 1.
+ * @param int $lastpage Total number of pages in the collection.
+ * @param string $mpurl Read-Only Variable. Relative URL of the first page in the collection.
+ * @param bool $isself FALSE indicates the page bar will be displayed on a page that is not part of the collection.
+ * @return string Null string if the $lastpage parameter was <= 1 or $page was invalid.
+ */
+function multi($page, $lastpage, &$mpurl, $isself = TRUE) {
+    global $lang;
+
+    $multipage = $lang['textpages'];
+
+    if ($page >= 1 And $lastpage > 1 And $page <= $lastpage) {
+        if ($page >= $lastpage - 3) {
+            $to = $lastpage;
         } else {
-            $to = $page+3;
+            $to = $page + 3;
         }
 
-        if ($page >= 0 && $page <= 3) {
+        if ($page <= 4) {
             $from = 1;
         } else {
             $from = $page - 3;
         }
-
+        
         $to--;
         $from++;
 
         $string = (strpos($mpurl, '?') !== false) ? '&amp;' : '?';
-        if (1 != $page) {
-            $multipage .= '&nbsp;&nbsp;<u><a href="'.$mpurl.$string.'page=1">1</a></u>';
-            if (2 < $from) {
-                $multipage .= '&nbsp;&nbsp;..';
+
+        // Link to first page
+        $multipage .= "\n";
+        if ($page != 1 Or !$isself) {
+            $extra = '';
+            if ($isself) {
+                $extra = ' rel="start"';
             }
+            $multipage .= '&nbsp;<u><a href="'.$mpurl.'"'.$extra.'>1</a></u>';
+            if ($from > 2) {
+                $multipage .= "\n&nbsp;..";
+            }
         } else {
-            $multipage .= '&nbsp;&nbsp;<strong>1</strong>';
+            $multipage .= '&nbsp;<strong>1</strong>';
         }
 
+        // Link to current page and up to 2 prev and 2 next pages.
+        $multipage .= "\n";
         for($i = $from; $i <= $to; $i++) {
             if ($i != $page) {
-                $multipage .= '&nbsp;&nbsp;<u><a href="'.$mpurl.$string.'page='.$i.'">'.$i.'</a></u>';
+                $extra = '';
+                if ($isself) {
+                    if ($i == $page - 1) {
+                        $extra = ' rel="prev"';
+                    } else if ($i == $page + 1) {
+                        $extra = ' rel="next"';
+                    }
+                    if ($page == 1) {
+                        $extra .= ' rev="start"';
+                    }
+                }
+                $multipage .= '&nbsp;<u><a href="'.$mpurl.$string.'page='.$i.'"'.$extra.'>'.$i.'</a></u>';
             } else {
-                $multipage .= '&nbsp;&nbsp;<strong>'.$i.'</strong>';
+                $multipage .= '&nbsp;<strong>'.$i.'</strong>';
             }
+            $multipage .= "\n";
         }
 
-        if ($pages != $page) {
-            if (($pages - 1) > $to) {
-                $multipage .= '&nbsp;&nbsp;..';
+        // Link to last page
+        if ($lastpage != $page) {
+            if (($lastpage - 1) > $to) {
+                $multipage .= "&nbsp;..\n";
             }
-            $multipage .= '&nbsp;&nbsp;<u><a href="'.$mpurl.$string.'page='.$pages.'">'.$pages.'</a></u>';
+            $extra = '';
+            if ($isself And $page == 1) {
+                $extra = ' rev="start"';
+            }
+            $multipage .= '&nbsp;<u><a href="'.$mpurl.$string.'page='.$lastpage.'"'.$extra.'>'.$lastpage.'</a></u>';
         } else {
-            $multipage .= '&nbsp;&nbsp;<strong>'.$pages.'</strong>';
+            $multipage .= '&nbsp;<strong>'.$lastpage.'</strong>';
         }
-    } else if ($strict !== true) {
-        return false;
+    } else {
+        $multipage = '';
     }
 
     return $multipage;
@@ -734,49 +1032,57 @@
     return ((($things > 0) && ($thingsperpage > 0) && ($things > $thingsperpage)) ? ceil($things / $thingsperpage) : 1);
 }
 
-function smilieinsert() {
-    global $imgdir, $smdir, $db, $smileyinsert, $smcols, $smtotal;
+function smilieinsert($type='normal') {
+    global $imgdir, $smdir, $db, $SETTINGS, $smiliesnum, $smiliecache;
 
+    $counter = 0;
     $sms = array();
-    $smilienum = 0;
     $smilies = '';
     $smilieinsert = '';
+    
+    if ($type == 'normal') {
+        $smcols = intval($SETTINGS['smcols']);
+        $smtotal = intval($SETTINGS['smtotal']);
+    } elseif ($type == 'quick') {
+        $smcols = 4;
+        $smtotal = 16;
+    } elseif ($type == 'full') {
+        $smcols = intval($SETTINGS['smcols']);
+        $smtotal = 0;
+    }
 
-    if ($smileyinsert == 'on' && $smcols != '') {
-        if ($smtotal == 0) {
-            $querysmilie = $db->query("SELECT * FROM ".X_PREFIX."smilies WHERE type='smiley' ORDER BY code DESC");
-        } else {
-            $querysmilie = $db->query("SELECT * FROM ".X_PREFIX."smilies WHERE type='smiley' ORDER BY code DESC LIMIT 0, ".$smtotal);
+    if ($SETTINGS['smileyinsert'] == 'on' And $smcols > 0 And $smiliesnum > 0) {
+        foreach($smiliecache as $key=>$val) {
+            $smilie['code'] = $key;
+            $smilie['url'] = $val;
+            eval('$sms[] = "'.template('functions_smilieinsert_smilie').'";');
+            if ($smtotal > 0) {
+                $counter++;
+                if ($counter >= $smtotal) {
+                    break;
+                }
+            }
         }
 
-        if (($smilienum = $db->num_rows($querysmilie)) > 0) {
-            while($smilie = $db->fetch_array($querysmilie)) {
-                eval('$sms[] = "'.template('functions_smilieinsert_smilie').'";');
-            }
-            $db->free_result($querysmilie);
-
-            $smilies = '<tr>';
-            for($i=0;$i<count($sms);$i++) {
-                $smilies .= $sms[$i];
-                if (($i+1)%$smcols == 0) {
-                    $smilies .= '</tr>';
-                    if (($i+1) < $smtotal) {
-                        $smilies .= '<tr>';
-                    }
+        $smilies = '<tr>';
+        for($i=0;$i<count($sms);$i++) {
+            $smilies .= $sms[$i];
+            if (($i+1)%$smcols == 0) {
+                $smilies .= '</tr>';
+                if (($i+1) < $smtotal) {
+                    $smilies .= '<tr>';
                 }
             }
+        }
 
-            if ($smilienum%$smcols > 0) {
-                $left = $smcols-($smilienum%$smcols);
-                for($i=0;$i<$left;$i++) {
-                    $smilies .= '<td>&nbsp;</td>';
-                }
-                $smilies .= '</tr>';
+        if ($smtotal%$smcols > 0) {
+            $left = $smcols-($smtotal%$smcols);
+            for($i=0;$i<$left;$i++) {
+                $smilies .= '<td />';
             }
-            eval('$smilieinsert = "'.template('functions_smilieinsert').'";');
-        } else {
-            $smilieinsert = '';
+            $smilies .= '</tr>';
         }
+        eval('$smilieinsert = "'.template('functions_smilieinsert').'";');
     }
 
     return $smilieinsert;
@@ -786,31 +1092,42 @@
     global $db;
     $fid = intval($fid);
 
-    $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."posts USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
+    $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."forums AS f INNER JOIN ".X_PREFIX."posts USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
     $postcount = $db->result($query, 0);
     $db->free_result($query);
 
-    $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."threads USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
+    $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."forums AS f INNER JOIN ".X_PREFIX."threads USING(fid) WHERE f.fid=$fid OR f.fup=$fid");
     $threadcount = $db->result($query, 0);
     $db->free_result($query);
 
     $query = $db->query("SELECT t.lastpost FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."threads AS t USING(fid) WHERE f.fid=$fid OR f.fup=$fid ORDER BY t.lastpost DESC LIMIT 0, 1");
     $lp = $db->fetch_array($query);
-    $db->query("UPDATE ".X_PREFIX."forums SET posts='$postcount', threads='$threadcount', lastpost='$lp[lastpost]' WHERE fid='$fid'");
+    $lastpost = $db->escape_var($lp['lastpost']);
+    $db->query("UPDATE ".X_PREFIX."forums SET posts='$postcount', threads='$threadcount', lastpost='$lastpost' WHERE fid='$fid'");
     $db->free_result($query);
 }
 
 function updatethreadcount($tid) {
     global $db;
+    $tid = intval($tid);
 
     $query = $db->query("SELECT tid FROM ".X_PREFIX."posts WHERE tid='$tid'");
     $replycount = $db->num_rows($query);
     $db->free_result($query);
     $replycount--;
-    $query = $db->query("SELECT dateline, author, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 1");
+    $query = $db->query("SELECT dateline, author, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC, pid DESC LIMIT 1");
     $lp = $db->fetch_array($query);
     $db->free_result($query);
+    $query = $db->query("SELECT date, username FROM ".X_PREFIX."logs WHERE tid='$tid' AND action='bump' ORDER BY date DESC LIMIT 1");
+    if ($db->num_rows($query) == 1) {
+        $lb = $db->fetch_array($query);
+        $lp['dateline'] = $lb['date'];
+        $lp['author'] = $lb['username'];
+    }
+    $db->free_result($query);
     $lastpost = $lp['dateline'].'|'.$lp['author'].'|'.$lp['pid'];
+    $lastpost = $db->escape_var($lastpost);
+
     $db->query("UPDATE ".X_PREFIX."threads SET replies='$replycount', lastpost='$lastpost' WHERE tid='$tid'");
 }
 
@@ -850,28 +1167,6 @@
     return false;
 }
 
-/* checkInput() is deprecated */
-function checkInput($input, $striptags='no', $allowhtml='no', $word='', $no_quotes=true) {
-    $input = trim($input);
-    if ($striptags == 'yes') {
-        $input = strip_tags($input);
-    }
-
-    if ($allowhtml != 'yes' && $allowhtml != 'on') {
-        if ($no_quotes) {
-            $input = htmlspecialchars($input, ENT_NOQUOTES);
-        } else {
-            $input = htmlspecialchars($input, ENT_QUOTES);
-        }
-    }
-
-    if ($word != '') {
-        $input = str_ireplace($word, "_".$word, $input);
-    }
-
-    return $input;
-}
-
 if (!function_exists('htmlspecialchars_decode')) {
     function htmlspecialchars_decode($string, $type=ENT_QUOTES) {
         $array = array_flip(get_html_translation_table(HTML_SPECIALCHARS, $type));
@@ -879,16 +1174,8 @@
     }
 }
 
-if (!function_exists('htmlentities_decode')) {
-    function htmlentities_decode($string, $type=ENT_QUOTES) {
-        $array = array_flip(get_html_translation_table(HTML_ENTITIES, $type));
-        return strtr($string, $array);
-    }
-}
-
 function end_time() {
-    global $footerstuff, $starttime, $SETTINGS;
-    extract($GLOBALS);
+    global $db, $footerstuff, $lang, $starttime, $SETTINGS;
 
     $mtime2 = explode(' ', microtime());
     $endtime = $mtime2[1] + $mtime2[0];
@@ -931,14 +1218,7 @@
     }
 
     if (X_SADMIN && DEBUG) {
-        $stuff = array();
-        $stuff[] = '<table cols="2" style="width: 97%;"><tr><td style="width: 2em;">#</td><td style="width: 8em;">Duration:</td><td>Query:</td></tr>';
-        foreach($db->querylist as $key=>$val) {
-            $val = mysql_syn_highlight($val);
-            $stuff[] = '<tr><td><strong>'.++$key.'.</strong></td><td>'.number_format($db->querytimes[$key-1], 8).'</td><td>'.$val.'</td></tr>';
-        }
-        $stuff[] = '</table>';
-        $footerstuff['querydump'] = implode("\n", $stuff);
+        $footerstuff['querydump'] = printAllQueries();
     } else {
         $footerstuff['querydump'] = '';
     }
@@ -951,10 +1231,7 @@
         error('Tried to redirect to potentially insecure url.');
     }
 
-    session_write_close();
-
-    $type = (headers_sent() || $type == X_REDIRECT_JS) ? X_REDIRECT_JS : X_REDIRECT_HEADER;
-    if ($type == X_REDIRECT_JS) {
+    if (headers_sent() Or $type == X_REDIRECT_JS) {
         ?>
         <script language="javascript" type="text/javascript">
         function redirect() {
@@ -965,7 +1242,9 @@
         <?php
     } else {
         if ($timeout == 0) {
+            header('HTTP/1.0 302 Found');
             header("Location: $path");
+            exit;
         } else {
             header("Refresh: $timeout; URL=$path");
         }
@@ -974,7 +1253,7 @@
     return true;
 }
 
-function get_extension($filename) {
+function get_extension(&$filename) {
     $a = explode('.', $filename);
     $count = count($a);
     if ($count == 1) {
@@ -984,40 +1263,6 @@
     }
 }
 
-function get_attached_file($file, $attachstatus, $max_size=1000000) {
-    global $lang, $filename, $filetype, $filesize;
-
-    $filename = '';
-    $filetype = '';
-    $filesize = 0;
-
-    if ($file['name'] != 'none' && !empty($file['name']) && $attachstatus != 'off' && is_uploaded_file($file['tmp_name'])) {
-        $file['name'] = trim($file['name']);
-        if (!isValidFilename($file['name'])) {
-            error($lang['invalidFilename'], false, '', '', false, false, false, false);
-            return false;
-        }
-
-        $filesize = intval(filesize($file['tmp_name'])); // fix bad filesizes
-        if ($file['size'] > $max_size) {
-            error($lang['attachtoobig'], false, '', '', false, false, false, false);
-            return false;
-        } else {
-            $attachment = addslashes(fread(fopen($file['tmp_name'], 'rb'), filesize($file['tmp_name'])));
-            $filename = addslashes($file['name']);
-            $filetype = addslashes(preg_replace('#[\r\n%]#', '', $file['type']));
-
-            if ($filesize == 0) {
-                return false;
-            } else {
-                return $attachment;
-            }
-        }
-    } else {
-        return false;
-    }
-}
-
 function ServerLoad() {
     if ($stats = @exec('uptime')) {
         $parts = explode(',', $stats);
@@ -1032,10 +1277,10 @@
 }
 
 function error($msg, $showheader=true, $prepend='', $append='', $redirect=false, $die=true, $return_as_string=false, $showfooter=true) {
-    global $footerstuff, $lang, $navigation;
+    global $footerstuff, $navigation; // Used by nav() and end_time()
 
     if (isset($GLOBALS)) {
-        extract($GLOBALS);
+        extract($GLOBALS, EXTR_SKIP);
     }
 
     $args = func_get_args();
@@ -1051,7 +1296,9 @@
 
     $header = $footer = $return = '';
 
-    nav($lang['error']);
+    if ($showheader) {
+        nav($lang['error']);
+    }
 
     end_time();
 
@@ -1092,10 +1339,10 @@
 }
 
 function message($msg, $showheader=true, $prepend='', $append='', $redirect=false, $die=true, $return_as_string=false, $showfooter=true) {
-    global $footerstuff, $lang, $navigation;
+    global $footerstuff, $navigation; // Used by nav() and end_time()
 
     if (isset($GLOBALS)) {
-        extract($GLOBALS);
+        extract($GLOBALS, EXTR_SKIP);
     }
 
     $args = func_get_args();
@@ -1111,7 +1358,9 @@
 
     $header = $footer = $return = '';
 
-    nav($lang['message']);
+    if ($showheader) {
+        nav($lang['message']);
+    }
 
     end_time();
 
@@ -1151,128 +1400,26 @@
     return $return;
 }
 
-function array_keys2keys($array, $translator) {
-    $new_array = array();
-
-    foreach($array as $key=>$val) {
-        if (isset($translator[$key])) {
-            $new_key = $translator[$key];
-        } else {
-            $new_key = $key;
-        }
-        $new_array[$new_key] = $val;
-    }
-
-    return $new_array;
-}
-
-function mysql_syn_highlight($query) {
-    global $tables, $tablepre;
-
-    $find = array();
-    $replace = array();
-
-    foreach($tables as $name) {
-        $find[] = $tablepre.$name;
-    }
-
-    $find[] = 'SELECT';
-    $find[] = 'UPDATE';
-    $find[] = 'DELETE';
-    $find[] = 'INSERT INTO ';
-    $find[] = ' WHERE ';
-    $find[] = ' ON ';
-    $find[] = ' FROM ';
-    $find[] = ' GROUP BY ';
-    $find[] = 'ORDER BY ';
-    $find[] = ' LEFT JOIN ';
-    $find[] = ' IN ';
-    $find[] = ' SET ';
-    $find[] = ' AS ';
-    $find[] = '(';
-    $find[] = ')';
-    $find[] = ' ASC';
-    $find[] = ' DESC';
-    $find[] = ' AND ';
-    $find[] = ' OR ';
-    $find[] = ' NOT';
-
-    foreach($find as $key=>$val) {
-        $replace[$key] = '</em><strong>'.$val.'</strong><em>';
-    }
-
-    return '<em>'.str_replace($find, $replace, $query).'</em>';
-}
-
-function dump_query($resource, $header=true) {
-    global $altbg2, $altbg1, $db, $cattext;
-    if (!$db->error()) {
-        $count = $db->num_fields($resource);
-        if ($header) {
-            ?>
-            <tr class="category" bgcolor="<?php echo $altbg2?>" align="center">
-            <?php
-            for($i=0;$i<$count;$i++) {
-                echo '<td align="left">';
-                echo '<strong><font color='.$cattext.'>'.$db->field_name($resource, $i).'</font></strong>';
-                echo '</td>';
-            }
-            echo '</tr>';
-        }
-
-        while($a = $db->fetch_array($resource, SQL_NUM)) {
-            ?>
-            <tr bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
-            <?php
-            for($i=0;$i<$count;$i++) {
-                echo '<td align="left">';
-
-                if (trim($a[$i]) == '') {
-                    echo '&nbsp;';
-                } else {
-                    echo nl2br($a[$i]);
-                }
-                echo '</td>';
-            }
-            echo '</tr>';
-        }
-    } else {
-        error($db->error());
-    }
-}
-
-function put_cookie($name, $value=null, $expire=null, $path=null, $domain=null, $secure=null, $setVia=X_SET_HEADER) {
-
+function put_cookie($name, $value=null, $expire=0, $path=null, $domain=null, $secure=FALSE, $setVia=X_SET_HEADER) {
     if (!headers_sent() && $setVia != X_SET_JS) {
         return setcookie($name, $value, $expire, $path, $domain, $secure);
     } else {
-        if ($expire >= 0) {
+        if ($expire > 0) {
             $expire = gmdate('r', $expire);
         } else {
-            $expire = null;
+            $expire = '';
         }
         ?>
         <script type="text/javascript">
-        function setcookie(name, value="deleted", expire=0, path="", domain="", secure=0) {
-            if (expire == 0) {
-                var now = new Date();
-                expire = now.toGMTString();
+            function put_cookie(name, value, expires, path, domain, secure) {
+                var curCookie = name + "=" + escape(value) +
+                ((expires) ? "; expires=" + expires : "") +
+                ((path) ? "; path=" + path : "") +
+                ((domain) ? "; domain=" + domain : "") +
+                ((secure) ? "; secure" : "");
+                document.cookie = curCookie;
             }
-
-            if (path == "") {
-                path = window.location.pathname;
-            }
-
-            if (domain == "") {
-                domain = window.location.host;
-            }
-
-            // create cookie string (expire in GMT TIME!)
-            var cookie = '';
-            cookie = name+"="+value+"; expires="+expire+"; path="+path+"; domain="+domain+"; secure="+secure"; HttpOnly";
-            document.cookie += cookie;
-        }
-        setcookie(<?php echo $name?>, <?php echo $value?>, <?php echo $expire?>, <?php echo $path?>, <?php echo $domain?>, <?php echo $secure?>);
+            put_cookie('<?php echo $name?>', '<?php echo $value?>', '<?php echo $expire?>', '<?php echo $path?>', '<?php echo $domain?>', '<?php echo $secure?>');
         </script>
         <?php
         return true;
@@ -1288,9 +1435,9 @@
 
     $fid = (int) $fid;
     $tid = (int) $tid;
-    $action = checkInput($action);
-    $user = checkInput($user);
-    $reason = checkInput($reason);
+    $action = cdataOut($action);
+    $user = cdataOut($user);
+    $reason = cdataOut($reason);
 
     $db->query("INSERT ".X_PREFIX."logs (tid, username, action, fid, date) VALUES ('$tid', '$user', '$action', '$fid', " . $db->time() . ")");
     return true;
@@ -1326,65 +1473,62 @@
 
 function altMail($to, $subject, $message, $additional_headers='', $additional_parameters=null) {
     global $mailer, $SETTINGS;
-    static $isInc, $handlers;
+    static $handlers;
 
     $message = str_replace(array("\r\n", "\r", "\n"), array("\n", "\n", "\r\n"), $message);
-    $subject = str_replace(array("\r\n", "\r", "\n"), array("\n", "\n", "\r\n"), $subject);
+    $subject = str_replace(array("\r", "\n"), array('', ''), $subject);
 
-    switch($mailer['type']) {
-        case 'socket_SMTP':
-            if (!isset($isInc['socket_SMTP'])) {
-                require ROOT.'include/smtp.inc.php';
-                $isInc['socket_SMTP'] = true;
-            }
+    if ($mailer['type'] == 'socket_SMTP') {
+        require_once(ROOT.'include/smtp.inc.php');
 
-            if (!isset($handlers['socket_SMTP'])) {
-                if (DEBUG) {
-                    $mail = new socket_SMTP(true, './smtp-log.txt');
-                } else {
-                    $mail = new socket_SMTP;
-                }
-                $handlers['socket_SMTP'] = &$mail;
-                $mail->connect($mailer['host'], $mailer['port'], $mailer['username'], $mailer['password']);
-                register_shutdown_function(array(&$mail, 'disconnect'));
+        if (!isset($handlers['socket_SMTP'])) {
+            if (DEBUG) {
+                $mail = new socket_SMTP(true, './smtp-log.txt');
             } else {
-                $mail = &$handlers['socket_SMTP'];
+                $mail = new socket_SMTP;
             }
+            $handlers['socket_SMTP'] = &$mail;
+            $mail->connect($mailer['host'], $mailer['port'], $mailer['username'], $mailer['password']);
+            register_shutdown_function(array(&$mail, 'disconnect'));
+        } else {
+            $mail = &$handlers['socket_SMTP'];
+        }
 
-            $subjectInHeader = false;
-            $toInHeader = false;
-            $additional_headers = explode("\r\n", $additional_headers);
-            foreach($additional_headers as $k=>$h) {
-                if (strpos(trim($h), 'ubject:') === 1) {
-                    $additional_headers[$k] = 'Subject: '.$subject."\r\n";
-                    $subjectInHeader = true;
-                    continue;
-                }
-
-                if (strpos(trim(strtolower($h)), 'to:') === 0) {
-                    $toInHeader = true;
-                }
+        $subjectInHeader = false;
+        $toInHeader = false;
+        $additional_headers = explode("\r\n", $additional_headers);
+        foreach($additional_headers as $k=>$h) {
+            if (strpos(trim($h), 'ubject:') === 1) {
+                $additional_headers[$k] = 'Subject: '.$subject."\r\n";
+                $subjectInHeader = true;
+                continue;
             }
 
-            if (!$subjectInHeader) {
-                $additional_headers[] = 'Subject: '.$subject;
+            if (strpos(trim(strtolower($h)), 'to:') === 0) {
+                $toInHeader = true;
             }
+        }
 
-            if (!$toInHeader) {
-                $additional_headers[] = 'To: '.$to;
-            }
+        if (!$subjectInHeader) {
+            $additional_headers[] = 'Subject: '.$subject;
+        }
 
-            $additional_headers = implode("\r\n", $additional_headers);
+        if (!$toInHeader) {
+            $additional_headers[] = 'To: '.$to;
+        }
 
-            return $mail->sendMessage($SETTINGS['adminemail'], $to, $message, $additional_headers);
-            break;
-        default:
-            if (ini_get('safe_mode') == "1") {
-                return mail($to, $subject, $message, $additional_headers);
-            } else {
-                return mail($to, $subject, $message, $additional_headers, $additional_parameters);
-            }
-            break;
+        $additional_headers = implode("\r\n", $additional_headers);
+
+        return $mail->sendMessage($SETTINGS['adminemail'], $to, $message, $additional_headers);
+    } else {
+        if (PHP_OS == 'WINNT' Or PHP_OS == 'WIN32') {  // Official XMB hack for PHP bug #45305 a.k.a. #28038
+            ini_set('sendmail_from', ini_get('sendmail_from'));
+        }
+        if (ini_get('safe_mode') == "1") {
+            return mail($to, $subject, $message, $additional_headers);
+        } else {
+            return mail($to, $subject, $message, $additional_headers, $additional_parameters);
+        }
     }
 }
 
@@ -1532,86 +1676,202 @@
     return $months[$num-1];
 }
 
-function forumList($selectname='srchfid', $multiple=false, $allowall=true, $currentfid=0) {
-    global $db, $self, $lang, $SETTINGS;
+/**
+ * Creates a db query result containing all active forums and forum categories.
+ *
+ * Important: The return value is passed by reference.  There is only one query object.  This cannot be used in nested functions.
+ *
+ * @return object
+ */
+function forumCache() {
+    global $db;
+    static $cache = FALSE;
 
-    $query = $db->query("SELECT f.* FROM ".X_PREFIX."forums f WHERE f.status='on' ORDER BY f.displayorder ASC");
+    if ($cache === FALSE) {
+        $cache = $db->query("SELECT f.* FROM ".X_PREFIX."forums f WHERE f.status='on' ORDER BY f.displayorder ASC");
+    }
+    
+    if ($cache !== FALSE) {
+        if ($db->num_rows($cache) > 0) {
+            $db->data_seek($cache, 0);  // Restores the pointer for fetch_array().
+        }
+    }
 
-    $standAloneForums = array();
-    $forums = array();
-    $categories = array();
-    $subforums = array();
-    while($forum = $db->fetch_array($query)) {
-        $perms = checkForumPermissions($forum);
-        if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $forum['type'] == 'group' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
-            $forum['name'] = fnameOut($forum['name']);
-            if (!X_SADMIN && $forum['password'] != '') {
-                $fidpw = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
-                if ($forum['password'] !== $fidpw) {
-                    continue;
+    return $cache;
+}
+
+/**
+ * Creates an associative array for the specified forum.
+ */
+function getForum($fid) {
+    global $db;
+    
+    $forums = forumCache();
+    while($forum = $db->fetch_array($forums)) {
+        if (intval($forum['fid']) == intval($fid)) {
+            return $forum;
+        }
+    }
+    return FALSE;
+}
+
+/**
+ * Creates a multi-dimensional array of forums.
+ *
+ * The array uses the following associative subscripts:
+ *  0:forums.type
+ *  1:forums.fup (always '0' for groups)
+ *  2:forums.fid
+ *  3:forums.*
+ * Usage example:
+ *  $forums = getStructuredForums();
+ *  echo fnameOut($forums['forum']['9']['14']['name']);
+ *
+ * @param bool $usePerms If TRUE then not all forums are returned, only visible forums.
+ * @return array
+ */
+function getStructuredForums($usePerms=FALSE) {
+    global $db;
+    
+    if ($usePerms) {
+        $forums = permittedForums(forumCache(), 'forum');
+    } else {
+        $forums = array();
+        $query = forumCache();
+        while($forum = $db->fetch_array($query)) {
+            $forums[] = $forum;
+        }
+    }
+    
+    // This function guarantees the following subscripts exist, regardless of forum count.
+    $structured['group'] = array();
+    $structured['forum'] = array();
+    $structured['sub'] = array();
+    $structured['group']['0'] = array();
+    $structured['forum']['0'] = array();
+
+    foreach($forums as $forum) {
+        $structured[$forum['type']][$forum['fup']][$forum['fid']] = $forum;
+    }
+    
+    return $structured;
+}
+
+/**
+ * Creates an array of permitted forum arrays.
+ *
+ * @param object $forums DB query result, preferably from forumCache().
+ * @param string $mode Whether to check for 'forum' listing permissions or 'thread' listing permissions.
+ * @param string $output If set to 'csv' causes the return value to be a CSV string of permitted forum IDs instead of an 'array' of arrays.
+ * @param bool $check_parents Indicates whether each forum's permissions depend on the parent forum also being permitted.
+ * @param bool $user_status Optional masquerade value passed to checkForumPermissions().
+ * @return array
+ */
+function permittedForums($forums, $mode='thread', $output='array', $check_parents=TRUE, $user_status=FALSE) {
+    global $db, $SETTINGS;
+    
+    $permitted = array();
+    $fids['group'] = array();
+    $fids['forum'] = array();
+    $fids['sub'] = array();
+    
+    while($forum = $db->fetch_array($forums)) {
+        $perms = checkForumPermissions($forum, $user_status);
+        if ($mode == 'thread') {
+            if ($forum['type'] == 'group' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_PASSWORD])) {
+                $permitted[] = $forum;
+                $fids[$forum['type']][] = $forum['fid'];
+            }
+        } elseif ($mode == 'forum') {
+            if ($SETTINGS['hideprivate'] == 'off' || $forum['type'] == 'group' || $perms[X_PERMS_VIEW]) {
+                $permitted[] = $forum;
+                $fids[$forum['type']][] = $forum['fid'];
+            }
+        }
+    }
+
+    if ($check_parents) { // Use the $fids array to see if each forum's parent is permitted.
+        $filtered = array();
+        $fids['forum'] = array();
+        $fids['sub'] = array();
+        foreach($permitted as $forum) {
+            if ($forum['type'] == 'group') {
+                $filtered[] = $forum;
+            } elseif ($forum['type'] == 'forum') {
+                if (intval($forum['fup']) == 0) {
+                    $filtered[] = $forum;
+                    $fids['forum'][] = $forum['fid'];
+                } elseif (array_search($forum['fup'], $fids['group']) !== FALSE) {
+                    $filtered[] = $forum;
+                    $fids['forum'][] = $forum['fid'];
                 }
             }
+        }
 
-            switch($forum['type']) {
-                case 'group':
-                    $categories[] = $forum;
-                    break;
-                case 'sub':
-                    if (!isset($subforums[$forum['fup']])) {
-                        $subforums[$forum['fup']] = array();
-                    }
-                    $subforums[$forum['fup']][] = $forum;
-                    break;
-                case 'forum':
-                default:
-                    if ($forum['fup'] == 0) {
-                        $standAloneForums[] = $forum;
-                    } else {
-                        if (!isset($forums[$forum['fup']])) {
-                            $forums[$forum['fup']] = array();
-                        }
-                        $forums[$forum['fup']][] = $forum;
-                    }
-                    break;
+        foreach($permitted as $forum) {
+            if ($forum['type'] == 'sub') {
+                if (intval($forum['fup']) == 0) {
+                    $filtered[] = $forum;
+                    $fids['sub'][] = $forum['fid'];
+                } elseif (array_search($forum['fup'], $fids['forum']) !== FALSE) {
+                    $filtered[] = $forum;
+                    $fids['sub'][] = $forum['fid'];
+                }
             }
         }
+        
+        $permitted = $filtered;
     }
-    $db->free_result($query);
+    
+    if ($output == 'csv') {
+        $permitted = implode(', ', array_merge($fids['group'], $fids['forum'], $fids['sub']));
+    }
+    
+    return $permitted;
+}
 
+function forumList($selectname='srchfid', $multiple=false, $allowall=true, $currentfid=0) {
+    global $lang;
+
+    // Initialize $forumselect
     $forumselect = array();
     if (!$multiple) {
         $forumselect[] = '<select name="'.$selectname.'">';
     } else {
-        $forumselect[] = '<select name="'.$selectname.'" multiple="multiple">';
+        $forumselect[] = '<select name="'.$selectname.'[]" size="10" multiple="multiple">';
     }
 
     if ($allowall) {
-        $forumselect[] = '<option value="all" selected="selected">'.$lang['textallforumsandsubs'].'</option>';
+        if ($currentfid == 0) {
+            $forumselect[] = '<option value="all" selected="selected">'.$lang['textallforumsandsubs'].'</option>';
+        } else {
+            $forumselect[] = '<option value="all">'.$lang['textallforumsandsubs'].'</option>';
+        }
     } else if (!$allowall && !$multiple) {
         $forumselect[] = '<option value="" disabled="disabled" selected="selected">'.$lang['textforum'].'</option>';
     }
 
-    unset($forum);
-    reset($forums);
+    // Populate $forumselect
+    $permitted = getStructuredForums(TRUE);
 
-    foreach($standAloneForums as $forum) {
-        $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.$forum['name'].'</option>';
-        if (isset($subforums[$forum['fid']])) {
-            foreach($subforums[$forum['fid']] as $sub) {
-                $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
+    foreach($permitted['forum']['0'] as $forum) {
+        $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.fnameOut($forum['name']).'</option>';
+        if (isset($permitted['sub'][$forum['fid']])) {
+            foreach($permitted['sub'][$forum['fid']] as $sub) {
+                $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.fnameOut($sub['name']).'</option>';
             }
         }
     }
 
     $forumselect[] = '<option value="0" disabled="disabled">&nbsp;</option>';
-    foreach($categories as $group) {
-        if (isset($forums[$group['fid']]) && count($forums[$group['fid']]) > 0) {
-            $forumselect[] = '<option value="'.intval($group['fid']).'" disabled="disabled">'.$group['name'].'</option>';
-            foreach($forums[$group['fid']] as $forum) {
-                $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.$forum['name'].'</option>';
-                if (isset($subforums[$forum['fid']])) {
-                    foreach($subforums[$forum['fid']] as $sub) {
-                        $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
+    foreach($permitted['group']['0'] as $group) {
+        if (isset($permitted['forum'][$group['fid']]) && count($permitted['forum'][$group['fid']]) > 0) {
+            $forumselect[] = '<option value="'.intval($group['fid']).'" disabled="disabled">'.fnameOut($group['name']).'</option>';
+            foreach($permitted['forum'][$group['fid']] as $forum) {
+                $forumselect[] = '<option value="'.intval($forum['fid']).'"'.($forum['fid'] == $currentfid ? ' selected="selected"' : '').'> &nbsp; &raquo; '.fnameOut($forum['name']).'</option>';
+                if (isset($permitted['sub'][$forum['fid']])) {
+                    foreach($permitted['sub'][$forum['fid']] as $sub) {
+                        $forumselect[] = '<option value="'.intval($sub['fid']).'"'.($sub['fid'] == $currentfid ? ' selected="selected"' : '').'>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &raquo; '.fnameOut($sub['name']).'</option>';
                     }
                 }
             }
@@ -1622,91 +1882,42 @@
     return implode("\n", $forumselect);
 }
 
-function readFileAsINI($filename) {
-    $lines = file($filename);
-    foreach($lines as $line_num => $line) {
-        $temp = explode("=",$line);
-        if ($temp[0] != 'dummy') {
-            $key = trim($temp[0]);
-            $val = trim($temp[1]);
-            $thefile[$key] = $val;
-        }
-    }
-    return $thefile;
-}
-
 function forumJump() {
-    global $db, $self, $lang, $SETTINGS;
+    global $fid, $lang, $selHTML;
 
-    $query = $db->query("SELECT f.* FROM ".X_PREFIX."forums f WHERE f.status='on' ORDER BY f.displayorder ASC");
-
-    $standAloneForums = array();
-    $forums = array();
-    $categories = array();
-    $subforums = array();
-    while($forum = $db->fetch_array($query)) {
-        $perms = checkForumPermissions($forum);
-        if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || $forum['type'] == 'group' || ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST])) {
-            $forum['name'] = fnameOut($forum['name']);
-            if (!X_SADMIN && $forum['password'] != '') {
-                $fidpw = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
-                if ($forum['password'] !== $fidpw) {
-                    continue;
-                }
-            }
-
-            switch($forum['type']) {
-                case 'group':
-                    $categories[] = $forum;
-                    break;
-                case 'sub':
-                    if (!isset($subforums[$forum['fup']])) {
-                        $subforums[$forum['fup']] = array();
-                    }
-                    $subforums[$forum['fup']][] = $forum;
-                    break;
-                case 'forum':
-                default:
-                    if ($forum['fup'] == 0) {
-                        $standAloneForums[] = $forum;
-                    } else {
-                        if (!isset($forums[$forum['fup']])) {
-                            $forums[$forum['fup']] = array();
-                        }
-                        $forums[$forum['fup']][] = $forum;
-                    }
-                    break;
-            }
-        }
-    }
-    $db->free_result($query);
-
+    // Initialize $forumselect
     $forumselect = array();
+    $checkid = max($fid, getInt('gid', 'r'));
 
     $forumselect[] = "<select onchange=\"if (this.options[this.selectedIndex].value) {window.location=(''+this.options[this.selectedIndex].value)}\">";
-    $forumselect[] = '<option value="0" selected="selected">'.$lang['forumjumpselect'].'</option>';
+    $forumselect[] = '<option value="">'.$lang['forumjumpselect'].'</option>';
 
-    unset($forum);
-    reset($forums);
+    // Populate $forumselect
+    $permitted = getStructuredForums(TRUE);
 
-    foreach($standAloneForums as $forum) {
-        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.$forum['name'].'</option>';
-        if (isset($subforums[$forum['fid']])) {
-            foreach($subforums[$forum['fid']] as $sub) {
-                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
+    foreach($permitted['forum']['0'] as $forum) {
+        $dropselc1 = ( $checkid == $forum['fid'] ) ? $selHTML : '';
+        $forumselect[] = '<option value="forumdisplay.php?fid='.intval($forum['fid']).'" '.$dropselc1.'> &nbsp; &raquo; '.fnameOut($forum['name']).'</option>';
+        if (isset($permitted['sub'][$forum['fid']])) {
+            foreach($permitted['sub'][$forum['fid']] as $sub) {
+                $dropselc2 = ( $checkid == $sub['fid'] ) ? $selHTML : '';
+                $forumselect[] = '<option value="forumdisplay.php?fid='.intval($sub['fid']).'" '.$dropselc2.'>&nbsp; &nbsp; &raquo; '.fnameOut($sub['name']).'</option>';
             }
         }
     }
 
-    foreach($categories as $group) {
-        if (isset($forums[$group['fid']])) {
-            $forumselect[] = '<option value="0"></option>';
-            $forumselect[] = '<option value="'.ROOT.'index.php?gid='.intval($group['fid']).'">'.$group['name'].'</option>';
-            foreach($forums[$group['fid']] as $forum) {
-                $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($forum['fid']).'"> &nbsp; &raquo; '.$forum['name'].'</option>';
-                if (isset($subforums[$forum['fid']])) {
-                    foreach($subforums[$forum['fid']] as $sub) {
-                        $forumselect[] = '<option value="'.ROOT.'forumdisplay.php?fid='.intval($sub['fid']).'">&nbsp; &nbsp; &raquo; '.$sub['name'].'</option>';
+    foreach($permitted['group']['0'] as $group) {
+        if (isset($permitted['forum'][$group['fid']])) {
+            $dropselc3 = ( $checkid == $group['fid'] ) ? $selHTML : '';
+            $forumselect[] = '<option value=""></option>';
+            $forumselect[] = '<option value="index.php?gid='.intval($group['fid']).'" '.$dropselc3.'>'.fnameOut($group['name']).'</option>';
+            foreach($permitted['forum'][$group['fid']] as $forum) {
+                $dropselc4 = ( $checkid == $forum['fid'] ) ? $selHTML : '';
+                $forumselect[] = '<option value="forumdisplay.php?fid='.intval($forum['fid']).'" '.$dropselc4.'> &nbsp; &raquo; '.fnameOut($forum['name']).'</option>';
+                if (isset($permitted['sub'][$forum['fid']])) {
+                    foreach($permitted['sub'][$forum['fid']] as $sub) {
+                        $dropselc5 = ( $checkid == $sub['fid'] ) ? $selHTML : '';
+                        $forumselect[] = '<option value="forumdisplay.php?fid='.intval($sub['fid']).'" '.$dropselc5.'>&nbsp; &nbsp; &raquo; '.fnameOut($sub['name']).'</option>';
                     }
                 }
             }
@@ -1716,74 +1927,120 @@
     return implode("\n", $forumselect);
 }
 
-function checkForumPermissions($forum) {
-    // 1. Check Forum Permissions
-    global $self;
-    $status = array(
-        'Super Administrator' => 1,
-        'Administrator'       => 2,
-        'Super Moderator'     => 4,
-        'Moderator'           => 8,
-        'Member'              => 16,
-        ''                    => 32,
-        'Banned'              => (1 << 30));  //$status['Banned'] == 2^30
+/**
+ * Creates a set of boolean permissions for a specific forum.
+ *
+ * Normal Usage Example
+ *  $fid = 1;
+ *  $forum = getForum($fid);
+ *  $perms = checkForumPermissions($forum);
+ *  if ($perms[X_PERMS_VIEW]) { //$self is allowed to view $forum }
+ * Masquerade Example
+ *  $result = $db->query('SELECT * FROM '.X_PREFIX.'members WHERE uid=1');
+ *  $user = $db->fetch_array($result);
+ *  $perms = checkForumPermissions($forum, $user['status']);
+ *  if ($perms[X_PERMS_VIEW]) { //$user is allowed to view $forum }
+ * Masquerade Example 2
+ *  $perms = checkForumPermissions($forum, 'Moderator');
+ *  if ($perms[X_PERMS_VIEW]) { //Moderators are allowed to view $forum }
+ *
+ * @param array $forum One query row from the forums table, preferably provided by getForum().
+ * @param string $user_status_in Optional. Masquerade as this user status, e.g. 'Guest'
+ * @return array Of bools, indexed by X_PERMS_* constants.
+ */
+function checkForumPermissions($forum, $user_status_in=FALSE) {
+    global $self, $status_enum;
 
-    // NewPoll,NewThread,NewReply,View,Userlist,Password
-    $ret = array(false, false, false, false, false, false);
+    if (is_string($user_status_in)) {
+        $user_status = $status_enum[$user_status_in];
+    } else {
+        $user_status = $status_enum[$self['status']];
+    }
+
+    // 1. Initialize $ret with zero permissions
+    $ret = array_fill(0, X_PERMS_COUNT, FALSE);
+    $ret[X_PERMS_POLL] = FALSE;
+    $ret[X_PERMS_THREAD] = FALSE;
+    $ret[X_PERMS_REPLY] = FALSE;
+    $ret[X_PERMS_VIEW] = FALSE;
+    $ret[X_PERMS_USERLIST] = FALSE;
+    $ret[X_PERMS_PASSWORD] = FALSE;
+    
+    // 2. Check Forum Postperm
     $pp = explode(',', $forum['postperm']);
     foreach($pp as $key=>$val) {
-        if (($val & $status[$self['status']]) == $status[$self['status']]) {
-            $ret[$key] = true;
+        if ((intval($val) & $user_status) != 0) {
+            $ret[$key] = TRUE;
         }
     }
 
-    // 2. Check for userlist
-    $userlist = trim($forum['userlist']);
+    // 3. Check Forum Userlist
+    if ($user_status_in === FALSE) {
+        $userlist = $forum['userlist'];
 
-    if (strlen($userlist) > 0) {
-        if (modcheck($self['username'], $forum['moderator']) == "Moderator") {
-            $ret[X_PERMS_USERLIST] = true;
-        } else {
+        if (modcheck($self['username'], $forum['moderator'], FALSE) == "Moderator") {
+            $ret[X_PERMS_USERLIST] = TRUE;
+            $ret[X_PERMS_VIEW] = TRUE;
+        } elseif (!X_GUEST) {
             $users = explode(',', $userlist);
             foreach($users as $user) {
                 if (strtolower(trim($user)) == strtolower($self['username'])) {
-                    $ret[X_PERMS_USERLIST] = true;
+                    $ret[X_PERMS_USERLIST] = TRUE;
+                    $ret[X_PERMS_VIEW] = TRUE;
                     break;
                 }
             }
         }
-    } else {
-        $ret[X_PERMS_USERLIST] = true;
     }
+    
+    // 4. Set Effective Permissions
+    $ret[X_PERMS_POLL]   = $ret[X_PERMS_RAWPOLL];
+    $ret[X_PERMS_THREAD] = $ret[X_PERMS_RAWTHREAD];
+    $ret[X_PERMS_REPLY]  = $ret[X_PERMS_RAWREPLY];
+    $ret[X_PERMS_VIEW]   = $ret[X_PERMS_RAWVIEW] || $ret[X_PERMS_USERLIST];
 
-    // 3.Check for password
+    // 5. Check Forum Password
     $pwinput = postedVar('fidpw'.$forum['fid'], '', FALSE, FALSE, FALSE, 'c');
-    if ($forum['password'] != '') {
-        if ($pwinput == $forum['password']) {
-            $ret[X_PERMS_PASSWORD] = true;
-        } else {
-            $ret[X_PERMS_PASSWORD] = false;
-        }
-    } else {
-        $ret[X_PERMS_PASSWORD] = true;
+    if ($forum['password'] == '' Or $pwinput == $forum['password']) {
+        $ret[X_PERMS_PASSWORD] = TRUE;
     }
 
     return $ret;
 }
 
+/**
+ * Enables you to do complex comparisons without string parsing.
+ *
+ * Normal Usage Example
+ *  $fid = 1;
+ *  $forum = getForum($fid);
+ *  $viewperms = getOneForumPerm($forum, X_PERMS_RAWVIEW);
+ *  if ($viewperms >= $status_enum['Member']) { //Some non-staff status has perms to view $forum }
+ *  if ($viewperms == $status_enum['Guest']) { //$forum is guest-only }
+ *  if ($viewperms == $status_enum['Member'] - 1) { //$forum is staff-only }
+ *
+ * @param array $forum
+ * @param int $bitfield Enumerated by X_PERMS_RAW* constants.  Other X_PERMS_* values will not work!
+ * @return bool
+ */
+function getOneForumPerm($forum, $bitfield) {
+    $pp = explode(',', $forum['postperm']);
+    return $pp[$bitfield];
+}
+
 function handlePasswordDialog($fid) {
-    global $db, $url, $cookiepath, $cookiedomain;  // function vars
+    global $db, $full_url, $url, $cookiepath, $cookiedomain;  // function vars
     global $THEME, $lang, $oToken, $altbg1, $altbg2, $tablewidth, $tablespace, $bordercolor;  // template vars
 
-    $pwform = '';
+    $fid = intval($fid);
     $pwinput = postedVar('pw', '', FALSE, FALSE);
-    $query = $db->query("SELECT password FROM ".X_PREFIX."forums WHERE fid=$fid");
-    if ($pwinput != '' And $db->num_rows($query) == 1) {
-        $pass = $db->result($query, 0);
 
-        if ($pwinput == $pass) {
-            put_cookie('fidpw'.$fid, $pass, (time() + (86400*30)), $cookiepath, $cookiedomain);
-            redirect($url, 0);
+    $forum = getForum($fid);
+    if (strlen($pwinput) != 0 And $forum !== FALSE) {
+        if ($pwinput == $forum['password']) {
+            put_cookie('fidpw'.$fid, $forum['password'], (time() + (86400*30)), $cookiepath, $cookiedomain);
+            $newurl = preg_replace('/[^\x20-\x7e]/', '', $url);
+            redirect($full_url.substr($newurl, strlen($cookiepath)), 0);
         } else {
             eval('$pwform = "'.template('forumdisplay_password').'";');
             error($lang['invalidforumpw'], true, '', $pwform, false, true, false, true);
@@ -1793,4 +2050,86 @@
         error($lang['forumpwinfo'], true, '', $pwform, false, true, false, true);
     }
 }
+
+function createLangFileSelect($currentLangFile) {
+    global $db;
+
+    $lfs = array();
+
+    $query = $db->query("SELECT b.devname, t.cdata "
+                      . "FROM ".X_PREFIX."lang_base AS b "
+                      . "LEFT JOIN ".X_PREFIX."lang_text AS t USING (langid) "
+                      . "INNER JOIN ".X_PREFIX."lang_keys AS k USING (phraseid) "
+                      . "WHERE k.langkey='language' "
+                      . "ORDER BY t.cdata ASC");
+    while ($row = $db->fetch_array($query)) {
+        if ($row['devname'] == $currentLangFile) {
+            $lfs[] = '<option value="'.$row['devname'].'" selected="selected">'.$row['cdata'].'</option>';
+        } else {
+            $lfs[] = '<option value="'.$row['devname'].'">'.$row['cdata'].'</option>';
+        }
+    }
+    return '<select name="langfilenew">'.implode("\n", $lfs).'</select>';
+}
+
+/**
+ * Creates an XHTML link to the forum search page.
+ *
+ * @param int $fid Optional. Current FID number used to create a context-sensitive search.
+ * @return string Empty string if the forum search page is disabled.
+ */
+function makeSearchLink($fid=0) {
+    global $imgdir, $lang, $SETTINGS;
+
+    $fid = intval($fid);
+
+    if ($SETTINGS['searchstatus'] == 'on') {
+        $fid = intval($fid);
+        if ($fid == 0) {
+            $fid = '';
+        } else {
+            $fid = "?fid=$fid";
+        }
+        return '<img src="'.$imgdir.'/top_search.gif" alt="'.$lang['altsearch'].'" border="0" /> <a href="search.php'.$fid.'"><font class="navtd">'.$lang['textsearch'].'</font></a> &nbsp; ';
+    } else {
+        return '';
+    }
+}
+
+/**
+ * Sets an SEO variable used in the header template to indicate the proper current relative URI.
+ *
+ * @param string $relURI Path to the current page, relative to the base href (see header.php).
+ */
+function setCanonicalLink($relURI) {
+    global $canonical_link, $cookiepath, $url;
+    
+    $testurl = $cookiepath;
+    if ($relURI != './') {
+        $testurl .= str_replace('&amp;', '&', $relURI);
+    }
+    if ($url != $testurl) {
+        $canonical_link = '<link rel="canonical" href="'.$relURI.'" />';
+    }
+}
+
+function phpShorthandValue($ininame) {
+    $rawstring = trim(ini_get($ininame));
+    $rchr = strtoupper(substr($rawstring, -1));
+    switch ($rchr) {
+    case 'G':
+        $rawstring *= 1073741824;
+        break;
+    case 'M':
+        $rawstring *= 1048576;
+        break;
+    case 'K':
+        $rawstring *= 1024;
+        break;
+    default:
+        $rawstring = intval($rawstring);
+        break;
+    }
+    return $rawstring;
+}
 ?>
Index: include/global.inc.php
===================================================================
--- include/global.inc.php	(revision 1746)
+++ include/global.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
@@ -41,15 +41,46 @@
     $_REQUEST = array_merge($_GET, $_POST, $_COOKIE);
 }
 
-$global = @array(0 => $_REQUEST, 1 => $_FILES, 2 => $_SERVER, 3 => $_SESSION, 4 => $_ENV);
-
 // make sure magic_quotes_runtime doesn't kill XMB
 @set_magic_quotes_runtime(0);
 
 // force registerglobals
-foreach($global as $num => $array) {
-    if (is_array($array)) {
-        extract($array, EXTR_SKIP);
+if (is_array($_REQUEST)) {
+    extract($_REQUEST, EXTR_SKIP);
+}
+
+/**
+ * Kill the script and debug dirty output streams.
+ *
+ * @author Robert Chapin (miqrogroove)
+ * @param string $error_source File name to mention if a dirty buffer is found.
+ * @param bool   $use_debug    Optional.  When FALSE the value of DEBUG is ignored.
+ * @since 1.9.11
+ */
+function assertEmptyOutputStream($error_source, $use_debug = TRUE) {
+    global $SETTINGS;
+    
+    $buffered_fault = (ob_get_length() > 0); // Checks top of buffer stack only.
+    $unbuffered_fault = headers_sent();
+    
+    if ($buffered_fault Or $unbuffered_fault) {
+        if ($buffered_fault) header('HTTP/1.0 500 Internal Server Error');
+
+        if ($use_debug And defined('DEBUG') And DEBUG == FALSE) {
+            echo "Error: XMB failed to start.  Set DEBUG to TRUE in config.php to see file system details.";
+        } elseif ($unbuffered_fault) {
+            headers_sent($filepath, $linenum);
+            echo "Error: XMB failed to start due to file corruption.  Please inspect $filepath at line number $linenum.";
+        } else {
+            $buffer = ob_get_clean();
+            echo 'OB:';
+            var_dump(ini_get('output_buffering'));
+            echo 'GZ:';
+            var_dump($SETTINGS['gzipcompress']);
+            echo "<br /><br />Error: XMB failed to start due to file corruption. "
+               . "Please inspect $error_source.  It has generated the following unexpected output:$buffer";
+        }
+        exit;
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/online.inc.php
===================================================================
--- include/online.inc.php	(revision 1746)
+++ include/online.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,44 +26,18 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
 function url_to_text($url) {
-    global $db, $lang, $self, $xmbuser;
-    static $restrict, $rset, $fname, $tsub;
+    global $db, $lang, $self, $xmbuser, $SETTINGS;
+    static $fname, $tsub;
+    static $restrict = '';
 
-    if (!$rset) {
-        if (X_SADMIN) {
-            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
-            while($f = $db->fetch_array($q)) {
-                $fids[] = $f['fid'];
-            }
-        } else {
-            $fCache = array();
-            $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
-            while($forum = $db->fetch_array($q)) {
-                $perms = checkForumPermissions($forum);
-                $fCache[$forum['fid']] = $perms;
-
-                if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
-                    if ($forum['type'] == 'sub') {
-                        // also check above forum!
-                        $parentP = $fCache[$forum['fup']];
-                        if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
-                            $fids[] = $forum['fid'];
-                        }
-                    } else {
-                        $fids[] = $forum['fid'];
-                    }
-                }
-            }
-        }
-
-        $fids = implode(',', $fids);
+    if ($restrict == '') {
+        $fids = permittedForums(forumCache(), 'thread', 'csv');
         $restrict = ' f.fid IN('.$fids.')';
-
-        $rset = true;
     }
 
     if (false !== strpos($url, '/viewthread.php')) {
@@ -91,11 +64,6 @@
                 }
                 $db->free_result($query);
             }
-
-            if (false !== strpos($url, 'action=attachment')) {
-                $url = substr($url, 0, strpos($url, '?'));
-                $url .= '?tid='.$tid;
-            }
         } else {
             $location = $lang['onlinenothread'];
         }
@@ -116,12 +84,12 @@
             if (isset($fname[$fid])) {
                 $location = $lang['onlineforumdisplay'].' '.$fname[$fid];
             } else {
-                $query = $db->query("SELECT name FROM ".X_PREFIX."forums f WHERE $restrict AND f.fid='$fid'");
-                while($locate = $db->fetch_array($query)) {
-                    $location = $lang['onlineforumdisplay'].' '.$locate['name'];
+                $locate = getForum($fid);
+                $perms = checkForumPermissions($locate);
+                if ($SETTINGS['hideprivate'] == 'off' || $locate['type'] == 'group' || $perms[X_PERMS_VIEW]) {
+                    $location = $lang['onlineforumdisplay'].' '.fnameOut($locate['name']);
                     $fname[$fid] = $locate['name'];
                 }
-                $db->free_result($query);
             }
         } else {
             $location = $lang['onlinenoforum'];
@@ -142,33 +110,23 @@
             $url = 'index.php';
         }
     } else if (false !== strpos($url, '/editprofile.php')) {
-        $temp = explode('?', $url);
+        $location = $lang['onlinecp'];
         if (!X_SADMIN) {
             $url = 'index.php';
         }
-
-        if (false!== strpos($temp[1], 'user=')) {
-            if (isset($temp[1]) && !empty($temp[1]) && $temp[1] != 'user=') {
-                $user = str_replace('user=', '', $temp[1]);
-                eval("\$location = \"$lang[onlineeditprofile]\";");
-            } else {
-                $location = $lang['onlineeditnoprofile'];
-            }
-        } else {
-            $location = $lang['onlineeditnoprofile'];
-        }
     } else if (false !== strpos($url, '/faq.php')) {
         $location = $lang['onlinefaq'];
     } else if (false !== strpos($url, '/index.php')) {
         if (false !== strpos($url, 'gid=')) {
             $temp = explode('?', $url);
             $gid = (int) str_replace('gid=', '', $temp[1]);
-            $q = $db->query("SELECT name FROM ".X_PREFIX."forums f WHERE $restrict AND f.fid='$gid'");
-            $cat = $db->fetch_array($q);
-            if (!$cat) {
+            $cat = getForum($gid);
+            if ($cat === FALSE) {
                 $location = $lang['onlinecatunknown'];
+            } elseif ($cat['type'] != 'group') {
+                $location = $lang['onlinecatunknown'];
             } else {
-                $location = $lang['onlineviewcat'].$cat['name'];
+                $location = $lang['onlineviewcat'].fnameOut($cat['name']);
             }
         } else {
             $location = $lang['onlineindex'];
@@ -177,30 +135,31 @@
         if (false !== strpos($url, 'action=reg')) {
             $location = $lang['onlinereg'];
         } else if (false !== strpos($url, 'action=viewpro')) {
+            $location = $lang['onlinenoprofile']; // initialize
             $temp = explode('?', $url);
             $urls = explode('&', $temp[1]);
             if (isset($urls[1]) && !empty($urls[1]) && $urls[1] != 'member=') {
                 foreach($urls as $argument) {
-                    if (strpos($argument, 'member') !== false) {
+                    if (strpos($argument, 'member=') !== false) {
                         $member = str_replace('member=', '', $argument);
+                        $member = rawurldecode(str_replace('+', ' ', $member));
+                        $member = preg_replace('#[\]\'\x00-\x1F\x7F<>\\\\|"[,@]#', '', $member);
+                        $member = cdataOut(censor($member));
+                        eval('$location = "'.$lang['onlineviewpro'].'";');
+                        break;
                     }
                 }
-                eval("\$location = \"$lang[onlineviewpro]\";");
-            } else {
-                $location = $lang['onlinenoprofile'];
             }
         } else if (false !== strpos($url, 'action=coppa')) {
             $location = $lang['onlinecoppa'];
         } else {
-            $location = $lang['onlinenoprofile'];
+            $location = $lang['onlineunknown'];
         }
     } else if (false !== strpos($url, 'misc.php')) {
         if (false !== strpos($url, 'login')) {
             $location = $lang['onlinelogin'];
         } else if (false !== strpos($url, 'logout')) {
             $location = $lang['onlinelogout'];
-        } else if (false !== strpos($url, 'search')) {
-            $location = $lang['onlinesearch'];
         } else if (false !== strpos($url, 'lostpw')) {
             $location = $lang['onlinelostpw'];
         } else if (false !== strpos($url, 'online')) {
@@ -224,6 +183,8 @@
         } else {
             $location = $lang['onlineunknown'];
         }
+    } else if (false !== strpos($url, '/search.php')) {
+        $location = $lang['onlinesearch'];
     } else if (false !== strpos($url, '/stats.php')) {
         $location = $lang['onlinestats'];
     } else if (false !== strpos($url, '/today.php')) {
@@ -266,12 +227,9 @@
         $location = $lang['onlineindex'];
     }
 
-    $location = html_entity_decode(str_replace('%20', '&nbsp;', htmlspecialchars($location)));
-    $url = addslashes(trim($url));
-
     $return = array();
-    $return['url'] = checkInput($url, 'yes');
+    $return['url'] = attrOut($url, 'javascript');
     $return['text'] = $location;
     return $return;
 }
-?>
\ No newline at end of file
+?>
Index: include/smtp.inc.php
===================================================================
--- include/smtp.inc.php	(revision 1746)
+++ include/smtp.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
@@ -184,4 +184,4 @@
         }
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/spelling.inc.php
===================================================================
--- include/spelling.inc.php	(revision 1746)
+++ include/spelling.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
@@ -52,7 +52,7 @@
         return true;
     }
 
-    function check_word($word) {
+    function check_word(&$word) {
         if (pspell_check($this->link, $word)) {
             return true;
         } else {
@@ -82,4 +82,4 @@
         return $return;
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/u2u.inc.php
===================================================================
--- include/u2u.inc.php	(revision 1746)
+++ include/u2u.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,6 +26,7 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
@@ -59,16 +59,16 @@
 }
 
 function u2u_send_recp($msgto, $subject, $message, $u2uid=0) {
-    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $del, $oToken, $xmbuser;
+    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $cookiedomain, $del, $oToken, $xmbuser, $full_url;
 
     $del = ('yes' === $del) ? 'yes' : 'no';
     $errors = '';
 
-    $query = $db->query("SELECT username, email, lastvisit, ignoreu2u, emailonu2u, status FROM ".X_PREFIX."members WHERE username='$msgto'");
+    $query = $db->query("SELECT username, email, lastvisit, ignoreu2u, emailonu2u, status, langfile FROM ".X_PREFIX."members WHERE username='$msgto'");
     if ($rcpt = $db->fetch_array($query)) {
         $ilist = array_map('trim', explode(',', $rcpt['ignoreu2u']));
         if (!in_array($self['username'], $ilist) || X_ADMIN) {
-            $username = $rcpt['username'];
+            $username = $db->escape_var($rcpt['username']);
             db_u2u_insert($username, $xmbuser, 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes');
             if ($self['saveogu2u'] == 'yes') {
                 db_u2u_insert($username, $xmbuser, 'outgoing', $xmbuser, 'Outbox', $subject, $message, 'no', 'yes');
@@ -76,16 +76,23 @@
 
             $u2uid = (int) $u2uid;
             if ($del == 'yes' && $u2uid > 0) {
-                   $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
+                $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
             }
 
             if ($rcpt['emailonu2u'] == 'yes' && $rcpt['status'] != 'Banned') {
-                $lastvisitcheck = $onlinetime - 600;
-                if ($lastvisitcheck > $rcpt['lastvisit']) {
-                    $u2uurl = $SETTINGS['boardurl'] . 'u2u.php';
-                    $rawusername = htmlspecialchars_decode($self['username'], ENT_QUOTES);
-                    altMail($rcpt['email'], "$lang[textnewu2uemail]", "$rawusername $lang[textnewu2ubody] \n$u2uurl", "From: $bbname <$adminemail>");
-                }
+                $lang2 = loadPhrases(array('charset','textnewu2uemail','textnewu2ubody'));
+                $translate = $lang2[$rcpt['langfile']];
+                $u2uurl = $full_url.'u2u.php';
+                $rawusername = htmlspecialchars_decode($self['username'], ENT_QUOTES);
+                $rawaddress = htmlspecialchars_decode($rcpt['email'], ENT_QUOTES);
+                $headers = array();
+                $headers[] = "From: $bbname <$adminemail>";
+                $headers[] = 'X-Mailer: PHP';
+                $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+                $headers[] = 'X-AntiAbuse: Username - '.$rawusername;
+                $headers[] = 'Content-Type: text/plain; charset='.$translate['charset'];
+                $headers = implode("\r\n", $headers);
+                altMail($rawaddress, $translate['textnewu2uemail'], "$rawusername ".$translate['textnewu2ubody']." \n$u2uurl", $headers);
             }
         } else {
             $errors = '<br />'.$lang['u2ublocked'];
@@ -99,14 +106,14 @@
 }
 
 function u2u_send($u2uid, $msgto, $subject, $message, $u2upreview) {
-    global $db, $self, $lang, $xmbuser, $SETTINGS, $del;
+    global $db, $self, $lang, $xmbuser, $SETTINGS, $del, $full_url;
     global $u2uheader, $u2ufooter, $u2ucount, $u2uquota, $oToken;
     global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
-    global $forward, $reply, $sendsubmit, $savesubmit, $previewsubmit;
+    global $forward, $reply, $previewsubmit;
 
     $dbsubject = $db->escape(addslashes($subject)); //message and subject were historically double-slashed
     $dbmessage = $db->escape(addslashes($message));
-    $dbto = $db->escape($msgto);
+    $dbto = $db->escape_var($msgto);
 
     $leftpane = '';
     $del = ($del == 'yes') ? 'yes' : 'no';
@@ -122,19 +129,19 @@
 
     if (onSubmit('savesubmit')) {
         // fixed by John Briggs
-        $dbsubject = (empty($dbsubject) ? $db->escape($lang['textnosub']) : $dbsubject);
+        $dbsubject = (empty($dbsubject) ? $db->escape_var($lang['textnosub']) : $dbsubject);
 
         if (empty($message)) {
             error($lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
         db_u2u_insert('', '', 'draft', $xmbuser, 'Drafts', $dbsubject, $dbmessage, 'yes', 'no');
-        u2u_msg($lang['imsavedmsg'], 'u2u.php?folder=Drafts');
+        u2u_msg($lang['imsavedmsg'], $full_url.'u2u.php?folder=Drafts');
     }
 
     if (onSubmit('sendsubmit')) {
         $errors = '';
         // fixed by John Briggs
-        $dbsubject = (empty($dbsubject) ? $db->escape($lang['textnosub']) : $dbsubject);
+        $dbsubject = (empty($dbsubject) ? $db->escape_var($lang['textnosub']) : $dbsubject);
 
         // fixed lang variable use by John Briggs
         if (empty($message)) {
@@ -154,9 +161,9 @@
         }
 
         if (empty($errors)) {
-            u2u_msg($lang['imsentmsg'], 'u2u.php');
+            u2u_msg($lang['imsentmsg'], $full_url.'u2u.php');
         } else {
-            u2u_msg(substr($errors, 6) , 'u2u.php');
+            u2u_msg(substr($errors, 6) , $full_url.'u2u.php');
         }
     }
 
@@ -165,7 +172,7 @@
         $quote = $db->fetch_array($query);
         if ($quote) {
             if (!isset($previewsubmit)) {
-                $prefixes = array($lang['textre'], $lang['textfwd']);
+                $prefixes = array($lang['textre'].' ', $lang['textfwd'].' ');
                 $subject = str_replace($prefixes, '', $quote['subject']);
                 $message = rawHTMLmessage(stripslashes($quote['message']));  //message and subject were historically double-slashed
                 if ($forward == 'yes') {
@@ -196,7 +203,7 @@
 
 function u2u_view($u2uid, $folders) {
     global $db, $dateformat, $timecode, $timeoffset, $addtime, $lang, $self, $oToken, $xmbuser;
-    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth, $full_url;
     global $sendoptions, $u2uheader, $u2ufooter, $SETTINGS;
 
     $delchecked = '';
@@ -205,7 +212,7 @@
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php", true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php', true, false, false);
         return;
     }
 
@@ -269,7 +276,8 @@
 }
 
 function u2u_print($u2uid, $eMail = false) {
-    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken, $xmbuser, $text;
+    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $full_url, $cookiedomain, $adminemail,
+           $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken, $xmbuser, $text;
 
     $mailHeader = '';
     $mailFooter = '';
@@ -277,7 +285,7 @@
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php", true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php', true, false, false);
         return;
     }
 
@@ -299,11 +307,20 @@
         if ($eMail) {
             eval('$mailHeader = "'.template('email_html_header').'";');
             eval('$mailFooter = "'.template('email_html_footer').'";');
-            $email = $mailHeader.$lang['textsubject']." ".$u2usubject."<br />\n".$lang['textfrom']." ".$u2ufrom."<br />\n".$lang['textto']." ".$u2uto."<br />\n".$lang['textu2ufolder']." ".$u2ufolder."<br />\n".$lang['textsent']." ".$u2udateline."<br />\n<br />\n".stripslashes($u2umessage).$mailFooter;
-            altMail($self['email'], $lang['textu2utoemail']." ".$u2usubject, $email, 'From: '.$bbname.' <'.$self['email'].">\r\n".'Content-type: text/html');
-            u2u_msg($lang['textu2utoemailsent'], 'u2u.php?action=view&u2uid='.$u2uid);
+            $email = $mailHeader.$lang['textsubject']." ".$u2usubject."<br />\n".$lang['textfrom']." ".$u2ufrom."<br />\n".$lang['textto']." ".$u2uto."<br />\n".$lang['textu2ufolder']." ".$u2ufolder."<br />\n".$lang['textsent']." ".$u2udateline."<br />\n<br />\n".$u2umessage."<br />\n<br />\n".$full_url.$mailFooter;
+            $rawemail = htmlspecialchars_decode($self['email'], ENT_QUOTES);
+            $rawuser = htmlspecialchars_decode($self['username'], ENT_QUOTES);
+            $headers = array();
+            $headers[] = "From: $bbname <$adminemail>";
+            $headers[] = 'X-Mailer: PHP';
+            $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+            $headers[] = 'X-AntiAbuse: Username - '.$rawuser;
+            $headers[] = 'Content-Type: text/html; charset='.$charset;
+            $headers = implode("\r\n", $headers);
+            $result = altMail($rawemail, $lang['textu2utoemail']." ".$u2usubject, $email, $headers);
+            u2u_msg($lang['textu2utoemailsent'], $full_url.'u2u.php?action=view&u2uid='.$u2uid);
         } else {
-            eval('echo stripslashes("'.template('u2u_printable').'");');
+            eval('echo "'.template('u2u_printable').'";');
             exit;
         }
     } else {
@@ -312,12 +329,12 @@
 }
 
 function u2u_delete($u2uid, $folder) {
-    global $db, $self, $lang, $xmbuser, $u2uheader, $u2ufooter, $oToken;
+    global $db, $self, $lang, $xmbuser, $u2uheader, $u2ufooter, $oToken, $full_url;
 
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php', true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php', true, false, false);
         return;
     }
 
@@ -327,11 +344,11 @@
         $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     }
 
-    u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.recodeOut($folder));
+    u2u_msg($lang['imdeletedmsg'], $full_url.'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_mod_delete($folder, $u2u_select) {
-    global $db, $self, $lang, $oToken, $xmbuser;
+    global $db, $self, $lang, $oToken, $xmbuser, $full_url;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -345,35 +362,35 @@
         $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid IN($in) AND owner='$xmbuser'");
     }
 
-    u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.recodeOut($folder));
+    u2u_msg($lang['imdeletedmsg'], $full_url.'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_move($u2uid, $tofolder) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken, $xmbuser;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken, $xmbuser, $full_url;
 
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php', true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php', true, false, false);
         return;
     }
 
     if (empty($tofolder)) {
-        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
+        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
     } else {
         if (!(in_array($tofolder, $folders) || $tofolder == 'Inbox' || $tofolder == 'Outbox' || $tofolder == 'Drafts') || ($tofolder == 'Inbox' && ($type == 'draft' || $type == 'outgoing')) || ($tofolder == 'Outbox' && ($type == 'incoming' || $type == 'draft')) || ($tofolder == 'Drafts' && ($type == 'incoming' || $type == 'outgoing'))) {
-            error($lang['textcantmove'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
+            error($lang['textcantmove'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
         }
 
-        $dbfolder = $db->escape($tofolder);
+        $dbfolder = $db->escape_var($tofolder);
         $db->query("UPDATE ".X_PREFIX."u2u SET folder='$dbfolder' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
 
-        u2u_msg($lang['textmovesucc'], 'u2u.php?folder='.recodeOut($folder));
+        u2u_msg($lang['textmovesucc'], $full_url.'u2u.php?folder='.recodeOut($folder));
     }
 }
 
 function u2u_mod_move($tofolder, $u2u_select) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder, $xmbuser;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder, $xmbuser, $full_url;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -387,50 +404,50 @@
     }
 
     if (empty($in)) {
-        error($lang['textcantmove'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
+        error($lang['textcantmove'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php?folder='.recodeOut($folder), true, false, false);
         return;
     }
 
-    $dbfolder = $db->escape($tofolder);
+    $dbfolder = $db->escape_var($tofolder);
     $db->query("UPDATE ".X_PREFIX."u2u SET folder='$dbfolder' WHERE u2uid IN($in) AND owner='$xmbuser'");
 
-    u2u_msg($lang['textmovesucc'], 'u2u.php?folder='.recodeOut($folder));
+    u2u_msg($lang['textmovesucc'], $full_url.'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_markUnread($u2uid, $folder, $type) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken, $xmbuser;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken, $xmbuser, $full_url;
 
     $u2uid = (int) $u2uid;
 
     if (!($u2uid > 0)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php", true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url."u2u.php", true, false, false);
         return;
     }
 
     if (empty($folder)) {
-        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
+        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
         return;
     }
 
     if ($type == 'outgoing') {
-        error($lang['textnomur'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
+        error($lang['textnomur'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php?folder='.recodeOut($folder), true, false, false);
     }
 
     $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid=$u2uid AND owner='$xmbuser'");
 
-    u2u_msg($lang['textmarkedunread'], 'u2u.php?folder='.recodeOut($folder));
+    u2u_msg($lang['textmarkedunread'], $full_url.'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_mod_markUnread($folder, $u2u_select) {
-    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken, $xmbuser;
+    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken, $xmbuser, $full_url;
 
     if (empty($folder)) {
-        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
+        error($lang['textnofolder'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
         return;
     }
 
     if (empty($u2u_select)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php?folder='.recodeOut($folder), true, false, false);
         return;
     }
 
@@ -446,16 +463,16 @@
     }
 
     if (empty($in)) {
-        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, 'u2u.php?folder='.recodeOut($folder), true, false, false);
+        error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php?folder='.recodeOut($folder), true, false, false);
     }
 
     $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid IN($in) AND owner='$xmbuser'");
 
-    u2u_msg($lang['textmarkedunread'], 'u2u.php?folder='.recodeOut($folder));
+    u2u_msg($lang['textmarkedunread'], $full_url.'u2u.php?folder='.recodeOut($folder));
 }
 
 function u2u_folderSubmit($u2ufolders, $folders) {
-    global $db, $lang, $self, $farray, $oToken, $xmbuser;
+    global $db, $lang, $self, $farray, $oToken, $xmbuser, $full_url;
 
     $error = '';
 
@@ -485,11 +502,11 @@
     $u2ufolders = $db->escape(implode(', ', $newfolders));
     $db->query("UPDATE ".X_PREFIX."members SET u2ufolders='$u2ufolders' WHERE username='$xmbuser'");
 
-    u2u_msg($lang['foldersupdate'].$error, "u2u.php?folder=Inbox");
+    u2u_msg($lang['foldersupdate'].$error, $full_url.'u2u.php?folder=Inbox');
 }
 
 function u2u_ignore() {
-    global $self, $lang, $db, $oToken, $xmbuser;
+    global $self, $lang, $db, $oToken, $xmbuser, $full_url;
     global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $thewidth;
 
     $leftpane = '';
@@ -497,7 +514,7 @@
         $ignorelist = postedVar('ignorelist');
         $self['ignoreu2u'] = $ignorelist;
         $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='" . $self['ignoreu2u'] . "' WHERE username='$xmbuser'");
-        u2u_msg($lang['ignoreupdate'], "u2u.php?action=ignore");
+        u2u_msg($lang['ignoreupdate'], $full_url.'u2u.php?action=ignore');
     } else {
         eval('$leftpane = "'.template('u2u_ignore').'";');
     }
@@ -515,7 +532,7 @@
     $u2usdraft = '';
     $leftpane = '';
     $folderrecode = recodeOut($folder);
-    $folder = $db->escape($folder);
+    $folder = $db->escape_var($folder);
 
     if (empty($folder)) {
         $folder = "Inbox";
@@ -672,4 +689,4 @@
 
     return $u2ucount;
 }
-?>
\ No newline at end of file
+?>
Index: include/validate.inc.php
===================================================================
--- include/validate.inc.php	(revision 1746)
+++ include/validate.inc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,136 +26,11 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
 /**
-* CSRF protection class. Call this to obtain and test a page token.
-*
-* From XMB 1.9.8, each user has a single token per page no matter which destination
-* action. These should be used for all actions. XMB 2.0 will extend this to include
-* unique tokens per action, making it much harder for attackers to spoof any particular
-* action.
-*
-* As each page has many old and new, and only one token slot in the session,
-* there is a way to re-seed the session.
-*/
-class page_token {
-    /**
-    * @access private
-    * @var mixed
-    */
-    var $pageToken;
-    /**
-    * @access private
-    * @var mixed
-    */
-    var $sessionToken;
-    /**
-    * @access public
-    * @var string
-    */
-    var $newToken;
-    /**
-    * Initialization of the class
-    *
-    * Sets all the class variables to their needed values
-    */
-    function init() {
-        $this->pageToken = $this->get_page_token();
-        $this->sessionToken = $this->get_session_token();
-        $this->newToken = md5(sha1(uniqid(rand(), true)));
-        $this->set_session_token($this->newToken);
-    }
-
-    /**
-    * Sets the 'token' SESSION variable
-    *
-    * @param   string   $token   the token to set the 'token' variable as
-    * @return   string   the token that was retrieved
-    */
-    function set_session_token($token) {
-        $_SESSION['token'] = $token;
-        return $token;
-    }
-
-    /**
-    * Retrieves the 'token' REQUEST variable
-    *
-    * @return   string   the token that was retrieved
-    */
-    function get_page_token() {
-        return getRequestVar('token');
-    }
-
-    /**
-    * Retrieves the 'token' SESSION variable
-    *
-    * @return   mixed   the token that was retrieved if it's set, false otherwise
-    */
-    function get_session_token() {
-        return (isset($_SESSION['token'])) ? $_SESSION['token'] : false;
-    }
-
-    /**
-    * Retrieves the a new token generated at initialization
-    *
-    * @return   string   the new token
-    */
-    function get_new_token() {
-        return $this->newToken;
-    }
-
-    /**
-    * Checks for valid token. Error's if there is not one.
-    *
-    * @return   boolean   true no matter what
-    */
-    function assert_token() {
-        global $lang;
-
-        if ($this->sessionToken === false || $this->pageToken === false || $this->sessionToken !== $this->pageToken) {
-            error($lang['textnoaction'], false);
-        }
-        // This old token has been used - prevent reuse
-        $this->sessionToken = false;
-        $this->pageToken = false;
-
-        return true;
-    }
-}
-
-/**
-* Checks if the supplied email address is valid
-*
-* @return   boolean   true if the e-mail address is valid, false otherwise
-*/
-function isValidEmail($addr) {
-    $emailPattern = "^([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$";
-    $emailValid = false;
-
-    if (eregi($emailPattern, $addr)) {
-        // Under Windows, PHP does not possess getmxrr(), so we skip it
-        if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
-            $emailValid = true;
-            break;
-        }
-
-        $user = '';
-        $domain = '';
-        list($user, $domain) = split('@', $addr);
-
-        // Check if the site has an MX record. We can't send unless there is.
-        $mxrecords = '';
-        if (getmxrr($domain, $mxrecords)) {
-            $emailValid = true;
-        }
-    }
-
-    return $emailValid;
-}
-
-/**
 * Has the named submit button been invoked?
 *
 * Looks in the form post data for a named submit
@@ -186,87 +60,116 @@
 // postedVar is an all-purpose function for retrieving and sanitizing user input.
 // This is the preferred function as of version 1.9.8 SP3.
 function postedVar($varname, $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE, $sourcearray='p') {
-    $foundvar = FALSE;
+    $retval = '';
+
     switch($sourcearray) {
-        case 'p':
-            if (isset($_POST[$varname])) {
-                $retval = $_POST[$varname];
-                $foundvar = TRUE;
-            }
-            break;
-        case 'g':
-            if (isset($_GET[$varname])) {
-                $retval = $_GET[$varname];
-                $foundvar = TRUE;
-            }
-            break;
-        case 'c':
-            if (isset($_COOKIE[$varname])) {
-                $retval = $_COOKIE[$varname];
-                $foundvar = TRUE;
-            }
-            break;
-        case 'r':
-        default:
-            if (isset($_REQUEST[$varname])) {
-                $retval = $_REQUEST[$varname];
-                $foundvar = TRUE;
-            }
-            break;
+    case 'p':
+        $sourcearray =& $_POST;
+        break;
+    case 'g':
+        $sourcearray =& $_GET;
+        break;
+    case 'c':
+        $sourcearray =& $_COOKIE;
+        break;
+    case 'r':
+    default:
+        $sourcearray =& $_REQUEST;
+        break;
     }
+    
+    if (isset($sourcearray[$varname])) {
+        if (is_string($sourcearray[$varname])) {
+            $retval = $sourcearray[$varname];
 
-    if ($foundvar) {
-        if (get_magic_quotes_gpc()) {
-            $retval = stripslashes($retval);
-        }
+            if (get_magic_quotes_gpc()) {
+                $retval = stripslashes($retval);
+            }
 
-        if ($word != '') {
-            $retval = str_ireplace($word, "_".$word, $retval);
-        }
+            $retval = str_replace("\x00", '', $retval);
 
-        if ($htmlencode) {
-            if ($quoteencode) {
-                $retval = htmlspecialchars($retval, ENT_QUOTES);
-            } else {
-                $retval = htmlspecialchars($retval, ENT_NOQUOTES);
+            if ($word != '') {
+                $retval = str_ireplace($word, "_".$word, $retval);
             }
-        }
 
-        if ($dbescape) {
-            $retval = $GLOBALS['db']->escape($retval);
+            if ($htmlencode) {
+                if ($quoteencode) {
+                    $retval = htmlspecialchars($retval, ENT_QUOTES);
+                } else {
+                    $retval = htmlspecialchars($retval, ENT_NOQUOTES);
+                }
+            }
+
+            if ($dbescape) {
+                $retval = $GLOBALS['db']->escape_var($retval);
+            }
         }
-    } else {
-        $retval = '';
     }
 
+    unset($sourcearray);
     return $retval;
 }
 
-function postedArray($varname, $type = 'string', $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE) {
-    $arrayItems = array();
+function postedArray($varname, $type = 'string', $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE, $sourcearray='p') {
+
+    switch($sourcearray) {
+    case 'p':
+        $sourcearray =& $_POST;
+        break;
+    case 'g':
+        $sourcearray =& $_GET;
+        break;
+    case 'c':
+        $sourcearray =& $_COOKIE;
+        break;
+    case 'r':
+    default:
+        $sourcearray =& $_REQUEST;
+        break;
+    }
+
     // Convert a single or comma delimited list to an array
-    if (isset($_POST[$varname]) && !is_array($_POST[$varname])) {
-        if (strpos($_POST[$varname], ',') !== false) {
-            $_POST[$varname] = explode(',', $_POST[$varname]);
+    if (isset($sourcearray[$varname]) && !is_array($sourcearray[$varname])) {
+        if (strpos($sourcearray[$varname], ',') !== false) {
+            $sourcearray[$varname] = explode(',', $sourcearray[$varname]);
         } else {
-            $_POST[$varname] = array($_POST[$varname]);
+            $sourcearray[$varname] = array($sourcearray[$varname]);
         }
     }
 
-    if (isset($_POST[$varname]) && is_array($_POST[$varname]) && count($_POST[$varname]) > 0) {
-        $arrayItems = $_POST[$varname];
+    $arrayItems = array();
+    if (isset($sourcearray[$varname]) && is_array($sourcearray[$varname]) && count($sourcearray[$varname]) > 0) {
+        $arrayItems = $sourcearray[$varname];
         foreach($arrayItems as $item => $theObject) {
-            $theObject = & $arrayItems[$item];
+            $theObject =& $arrayItems[$item];
             switch($type) {
-                case 'int':
-                    $theObject = intval($theObject);
-                    break;
-                case 'string':
-                default:
+            case 'onoff':
+                if (strtolower($theObject) == 'on') {
+                    $theObject = 'on';
+                } else {
+                    $theObject = 'off';
+                }
+                break;
+            case 'yesno':
+                if (strtolower($theObject) == 'yes') {
+                    $theObject = 'yes';
+                } else {
+                    $theObject = 'no';
+                }
+                break;
+                break;
+            case 'int':
+                $theObject = intval($theObject);
+                break;
+            case 'string':
+            default:
+                if (is_string($theObject)) {
                     if (get_magic_quotes_gpc()) {
                         $theObject = stripslashes($theObject);
                     }
 
+                    $theObject = str_replace("\x00", '', $theObject);
+
                     if ($word != '') {
                         $theObject = str_ireplace($word, "_".$word, $theObject);
                     }
@@ -280,9 +183,12 @@
                     }
 
                     if ($dbescape) {
-                        $theObject = $GLOBALS['db']->escape($theObject);
+                        $theObject = $GLOBALS['db']->escape_var($theObject);
                     }
-                    break;
+                } else {
+                    $theObject = '';
+                }
+                break;
             }
             unset($theObject);
         }
@@ -367,61 +273,6 @@
 }
 
 /**
-* Retrieve the contents of an array from a POST
-*
-* This function will attempt to retrieve a named array($varname)
-* and sanitize it based upon type($type). If a string, $striptags indicates
-* if striptags should be used, and $quotes is only enabled when you want it
-*
-* This function always returns an array. It will be an empty array if there's
-* no data or variable to be returned.
-*
-* @param   string   $varname   name of the variable in $_POST
-* @param   boolean   $striptags   strings only: do a striptags to remove HTML tags
-* @param   boolean   $quotes   strings only: do a htmlspecialchars to sanitize input for XSS
-* @param   string   $type   'string' or 'int' to specify what needs to be done to the values
-* @return   array   the array found for $varname, empty otherwise
-*/
-/* formArray() is deprecated */
-function formArray($varname, $striptags = true, $quotes = false, $type = 'string') {
-    $arrayItems = array();
-    // Convert a single or comma delimited list to an array
-    if (isset($_POST[$varname]) && !is_array($_POST[$varname])) {
-        if (strpos($_POST[$varname], ',') !== false) {
-            $_POST[$varname] = explode(',', $_POST[$varname]);
-        } else {
-            $_POST[$varname] = array($_POST[$varname]);
-        }
-    }
-
-    if (isset($_POST[$varname]) && is_array($_POST[$varname]) && count($_POST[$varname]) > 0) {
-        $arrayItems = $_POST[$varname];
-        foreach($arrayItems as $item => $theObject) {
-            $theObject = & $arrayItems[$item];
-            switch($type) {
-                case 'int':
-                    $theObject = intval($theObject);
-                    break;
-                case 'string':
-                default:
-                    if ($striptags) {
-                        $theObject = strip_tags($theObject);
-                    }
-                    if ($quotes) {
-                        $theObject = htmlspecialchars($theObject, ENT_QUOTES);
-                    } else {
-                        $theObject = htmlspecialchars($theObject, ENT_NOQUOTES);
-                    }
-                    break;
-            }
-            unset($theObject);
-        }
-    }
-
-    return $arrayItems;
-}
-
-/**
 * Retrieve a gpc integer and sanitize it
 *
 * @param   string   $varname   name of the variable in a superglobal array such as $_GET
@@ -482,24 +333,6 @@
 }
 
 /**
-* Retrieve a REQUEST variable
-*
-* @param   string   $varname   name of the variable in $_REQUEST
-* @return   mixed   the value of $varname, false otherwise
-*/
-function getRequestVar($varname) {
-    if (isset($_REQUEST[$varname])) {
-        if (get_magic_quotes_gpc()) {
-            return $_REQUEST[$varname];
-        } else {
-            return addslashes($_REQUEST[$varname]);
-        }
-    } else {
-        return FALSE;
-    }
-}
-
-/**
 * Retrieve a POST integer and sanitize it
 *
 * @param   string   $varname   name of the variable in $_POST
@@ -634,41 +467,7 @@
     return sprintf('%02x%02x%02x%02x', $ip_sep[0], $ip_sep[1], $ip_sep[2], $ip_sep[3]);
 }
 
-function createLangFileSelect($currentLangFile) {
-    $lfs = array();
-    $dir = opendir(ROOT.'lang/');
-    while($file = readdir($dir)) {
-        if (is_file(ROOT.'lang/'.$file) && false !== strpos($file, '.lang.php')) {
-            $file = str_replace('.lang.php', '', $file);
-            if ($file == $currentLangFile) {
-                $lfs[] = '<option value="'.md5($file).'" selected="selected">'.$file.'</option>';
-            } else {
-                $lfs[] = '<option value="'.md5($file).'">'.$file.'</option>';
-            }
-        }
-    }
-    natcasesort($lfs);
-
-    return '<select name="langfilenew">'.implode("\n", $lfs).'</select>';
-}
-
-function getLangFileNameFromHash($ordinal) {
-    global $member;
-
-    $dir = opendir(ROOT.'lang/');
-    while($file = readdir($dir)) {
-        if (is_file(ROOT.'lang/'.$file) && false !== strpos($file, '.lang.php')) {
-            $file = str_replace('.lang.php', '', $file);
-            if (md5($file) == $ordinal) {
-                return $file;
-            }
-        }
-    }
-
-    return false;
-}
-
 function isValidFilename($filename) {
-    return preg_match("#^[\\w\\^\\-\\#\\] `~!@$&()_+=[{};',.]*$#", trim($filename));
+    return preg_match("#^[\\w\\^\\-\\#\\] `~!@$&()_+=[{};',.]+$#", trim($filename));
 }
 ?>
Index: index.php
===================================================================
--- index.php	(revision 1746)
+++ index.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -52,7 +51,7 @@
 $ticker = '';
 if ($SETTINGS['tickerstatus'] == 'on') {
     $contents = '';
-    $news = explode("\n", str_replace(array("\r\n", "\r"), array("\n"), $tickercontents));
+    $news = explode("\n", str_replace(array("\r\n", "\r"), array("\n"), $SETTINGS['tickercontents']));
     for($i=0;$i<count($news);$i++) {
         if (strlen(trim($news[$i])) == 0) {
             continue;
@@ -64,23 +63,30 @@
     eval('$ticker = "'.template('index_ticker').'";');
 }
 
-$gid = 0;
 if (onSubmit('gid')) {
     $gid = getInt('gid');
     $SETTINGS['tickerstatus'] = 'off';
     $SETTINGS['whosonlinestatus'] = 'off';
     $SETTINGS['index_stats'] = 'off';
-    $query = $db->query("SELECT name FROM ".X_PREFIX."forums WHERE fid=$gid AND type='group' AND status='on' LIMIT 1");
-    if ($db->num_rows($query) != 1) {
-        header('HTTP/1.1 404 Not Found');
+    $cat = getForum($gid);
+    if ($cat === FALSE) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnocat']);
+    } elseif ($cat['type'] != 'group' Or $cat['status'] != 'on') {
+        header('HTTP/1.0 404 Not Found');
+        error($lang['textnocat']);
     }
-    $cat = $db->fetch_array($query);
-    $db->free_result($query);
+    setCanonicalLink("index.php?gid=$gid");
     nav(fnameOut($cat['name']));
+    if ($SETTINGS['subject_in_title'] == 'on') {
+        $threadSubject = '- '.fnameOut($cat['name']);
+    }
+} else {
+    $gid = 0;
+    setCanonicalLink('./');
 }
 
-eval('echo "'.template('header').'";');
+eval('$header = "'.template('header').'";');
 
 $statsbar = '';
 if ($SETTINGS['index_stats'] == 'on') {
@@ -119,25 +125,20 @@
 
     $whosonline = $whosonlinetoday = '';
     if ($SETTINGS['whosonlinestatus'] == 'on') {
-        $guestcount = $membercount = $hiddencount = 0;
+        $hiddencount = 0;
+        $membercount = 0;
+        $guestcount = $db->result($db->query("SELECT COUNT(DISTINCT ip) AS guestcount FROM ".X_PREFIX."whosonline WHERE username = 'xguest123'"), 0);
         $member = array();
-        $query  = $db->query("SELECT m.status, m.username, m.invisible, w.* FROM ".X_PREFIX."whosonline w LEFT JOIN ".X_PREFIX."members m ON m.username=w.username ORDER BY w.username");
+        $query  = $db->query("SELECT m.username, MAX(m.status) AS status, MAX(m.invisible) AS invisible FROM ".X_PREFIX."members AS m INNER JOIN ".X_PREFIX."whosonline USING (username) GROUP BY m.username ORDER BY m.username");
         while($online = $db->fetch_array($query)) {
-            switch($online['username']) {
-                case 'xguest123':
-                    $guestcount++;
-                    break;
-                default:
-                    if ($online['invisible'] != 0 && X_ADMIN) {
-                        $member[] = $online;
-                        $hiddencount++;
-                    } else if ($online['invisible'] != 0) {
-                        $hiddencount++;
-                    } else {
-                        $member[] = $online;
-                        $membercount++;
-                    }
-                    break;
+            if ($online['invisible'] != 0 && X_ADMIN) {
+                $member[] = $online;
+                $hiddencount++;
+            } else if ($online['invisible'] != 0) {
+                $hiddencount++;
+            } else {
+                $member[] = $online;
+                $membercount++;
             }
         }
         $db->free_result($query);
@@ -237,23 +238,30 @@
             } else {
                 $memontoday = $todaymembersnum.$lang['textmemberstoday'];
             }
+            eval($lang['last50todayeval']);
             eval('$whosonlinetoday = "'.template('index_whosonline_today').'";');
         }
 
         eval('$whosonline = "'.template('index_whosonline').'";');
     }
 
-    if ($SETTINGS['catsonly'] == 'on') {
-        $fquery = $db->query("SELECT name as cat_name, fid as cat_fid FROM ".X_PREFIX."forums WHERE type='group' AND status='on' ORDER BY displayorder ASC");
-    } else {
-        $fquery = $db->query("SELECT f.*, c.name as cat_name, c.fid as cat_fid FROM ".X_PREFIX."forums f LEFT JOIN ".X_PREFIX."forums c ON (f.fup=c.fid) WHERE (c.type='group' AND f.type='forum' AND c.status='on' AND f.status='on') OR (f.type='forum' AND f.fup='' AND f.status='on') ORDER BY c.displayorder ASC, f.displayorder ASC");
-    }
+    $forums = getStructuredForums(TRUE);
+    $fquery = getIndexForums($forums);
 } else {
     $ticker = $welcome = $whosonline = $statsbar = $whosonlinetoday = '';
-    $fquery = $db->query("SELECT f.*, c.name as cat_name, c.fid as cat_fid FROM ".X_PREFIX."forums f LEFT JOIN ".X_PREFIX."forums c ON (f.fup=c.fid) WHERE (c.type='group' AND f.type='forum' AND c.status='on' AND f.status='on' AND f.fup='$gid') ORDER BY c.displayorder ASC, f.displayorder ASC");
+
+    $forums = getStructuredForums(TRUE);
+    $fquery = array();
+    if (isset($forums['forum'][$cat['fid']])) {
+        foreach($forums['forum'][$cat['fid']] as $forum) {
+            $forum['cat_fid'] = $cat['fid'];
+            $forum['cat_name'] = $cat['name'];
+            $fquery[] = $forum;
+        }
+    }
 }
 
-$indexBarTop = $indexBar = $forumlist =  $spacer = '';
+$indexBarTop = $indexBar = $forumlist = $spacer = '';
 $forumarray = array();
 $catLessForums = $lastcat = 0;
 
@@ -274,24 +282,22 @@
     eval('$indexBar = "'.template('index_category_hr').'";');
 }
 
+// Collect Subforums ordered by fup, displayorder
+$index_subforums = array();
 if ($SETTINGS['showsubforums'] == 'on') {
-    $index_subforums = array();
     if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
-        $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE status='on' AND type='sub' ORDER BY fup, displayorder");
-        while($queryrow = $db->fetch_array($query)) {
-            $subperms = checkForumPermissions($queryrow);
-            if (X_SADMIN || $SETTINGS['hideprivate'] == 'off' || ($subperms[X_PERMS_VIEW] && $subperms[X_PERMS_USERLIST])) {
-                $index_subforums[] = $queryrow;
+        foreach($forums['sub'] as $subForumsByFUP) {
+            foreach($subForumsByFUP as $forum) {
+                $index_subforums[] = $forum;
             }
         }
-        $db->free_result($query);
     }
 }
 
-while($thing = $db->fetch_array($fquery)) {
+foreach($fquery as $thing) {
 
     if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
-        $cforum = forum($thing, "index_forum");
+        $cforum = forum($thing, "index_forum", $index_subforums);
     } else {
         $cforum = '';
     }
@@ -325,7 +331,7 @@
 if ($forumlist == '') {
     eval('$forumlist = "'.template('index_noforum').'";');
 }
-$db->free_result($fquery);
+unset($fquery);
 
 if ($catLessForums == 0 && $SETTINGS['indexshowbar'] == 1) {
     $indexBarTop = '';
@@ -334,5 +340,46 @@
 eval('$index = "'.template('index').'";');
 end_time();
 eval('$footer = "'.template('footer').'";');
-echo $index.$footer;
+echo $header.$index.$footer;
+
+/**
+ * @param array $forums Read-Only Variable. Must be a return value from the function getStructuredForums()
+ * @return array Two-dimensional array of forums sorted by the group's displayorder, then the forum's displayorder.
+ */
+function getIndexForums(&$forums) {
+    global $db, $SETTINGS;
+
+    // First sort the groups by displayorder.
+    $groups = array();
+    foreach($forums['group']['0'] as $group) {
+        $group['cat_fid'] = $group['fid'];
+        $group['cat_name'] = $group['name'];
+        $groups[$group['displayorder']] = $group;
+    }
+    ksort($groups);
+
+    if ($SETTINGS['catsonly'] == 'on') {
+        $sorted =& $groups;
+    } else {
+        // Now simply sort the forums by each group.  Remember to put ungrouped forums first.
+        $sorted = array();
+        foreach($forums['forum']['0'] as $forum) {
+            $forum['cat_fid'] = '';
+            $forum['cat_name'] = '';
+            $sorted[] = $forum;
+        }
+        foreach($groups as $group) {
+            if (isset($forums['forum'][$group['fid']])) {
+                foreach($forums['forum'][$group['fid']] as $forum) {
+                    $forum['cat_fid'] = $group['fid'];
+                    $forum['cat_name'] = $group['name'];
+                    $sorted[] = $forum;
+                }
+            }
+        }
+    }
+
+    return $sorted;
+}
+
 ?>
Index: js/bbcodefns-ie.js
===================================================================
--- js/bbcodefns-ie.js	(revision 1746)
+++ js/bbcodefns-ie.js	(working copy)
@@ -1,6 +1,3 @@
-var bbcode_prompt_link1 = bbcode_prompt_link_desc;
-var bbcode_prompt_link2 = bbcode_prompt_list_item;
-
 var defmode = 'normal';
 
 if (defmode == 'advanced') {
@@ -53,13 +50,15 @@
     } else if (advmode) {
         AddText('', '', "[email]"+document.selection.createRange().text+"[/email]", messageElement);
     } else {
-        txt2=prompt(bbcode_prompt_email_email,"");
-        if (txt2!=null) {
-            txt=prompt(bbcode_prompt_email_error,"user@example.com");
-            if (txt2=="") {
-                AddText('', '', "[email]"+txt+"[/email]", messageElement);
-            } else {
-                AddText('', '', "[email="+txt+"]"+txt2+"[/email]", messageElement);
+        txt2=prompt(bbcode_prompt_email_desc,"");
+        if (txt2!=null)    {
+            txt=prompt(bbcode_prompt_email_email,"");
+            if (txt2!=null) {
+                if (txt2=="") {
+                    AddText('', '', "[email]"+txt+"[/email]", messageElement);
+                } else {
+                    AddText('', '', "[email="+txt+"]"+txt2+"[/email]", messageElement);
+                }
             }
         }
     }
@@ -162,9 +161,9 @@
     } else if (advmode) {
         AddText('', '', "[url]"+document.selection.createRange().text+"[/url]", messageElement);
     } else {
-        txt2=prompt(bbcode_prompt_link1,"");
+        txt2=prompt(bbcode_prompt_link_desc,"");
         if (txt2!=null)    {
-            txt=prompt(bbcode_prompt_link2,"http://");
+            txt=prompt(bbcode_prompt_link_url,"http://");
             if (txt!=null)    {
                 if (txt2=="") {
                     AddText('', '', "[url]"+txt+"[/url]", messageElement);
@@ -262,4 +261,4 @@
 
 function loadEls() {
     messageElement = document.getElementById("message");
-}
\ No newline at end of file
+}
Index: js/bbcodefns-mozilla.js
===================================================================
--- js/bbcodefns-mozilla.js	(revision 1746)
+++ js/bbcodefns-mozilla.js	(working copy)
@@ -84,7 +84,7 @@
         if (hasSelection(messageElement)) {
             if (fetchSelection(messageElement).match(/(.+)@(.+)/) != null) {
                 text = prompt(bbcode_prompt_email_email, fetchSelection(messageElement));
-                desc = prompt(bbcode_prompt_link_desc, '');
+                desc = prompt(bbcode_prompt_email_desc, '');
                 while(text.length == 0 || text.match(/(.+)@(.+)/) == null) {
                     text = prompt(bbcode_prompt_email_error, fetchSelection(messageElement));
                 }
@@ -111,7 +111,7 @@
                 desc = prompt(bbcode_prompt_email_email, fetchSelection(messageElement));
                 if (desc == fetchSelection(messageElement)) {
                     wrapText('[email='+text+']', '[/email]', messageElement);
-                } else {
+                } else if (desc != null) {
                     AddText('[email='+text+']', '[/email]', desc, messageElement);
                 }
             }
@@ -122,7 +122,7 @@
                     text = prompt(bbcode_prompt_email_error, text);
                 }
 
-                desc = prompt(bbcode_prompt_link_desc, '');
+                desc = prompt(bbcode_prompt_email_desc, '');
                 if (desc.length == 0) {
                     AddText('[email]', '[/email]', text, messageElement);
                 } else {
@@ -145,9 +145,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_size+size, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[size='+size+']', '[/size]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[size='+size+']', '[/size]', text, messageElement);
             }
         } else {
@@ -173,9 +173,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_font+font, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[font='+font+']', '[/font]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[font='+font+']', '[/font]', text, messageElement);
             }
         } else {
@@ -201,9 +201,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_bold, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[b]', '[/b]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[b]', '[/b]', text, messageElement);
             }
         } else {
@@ -227,9 +227,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_italic, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[i]', '[/i]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[i]', '[/i]', text, messageElement);
             }
         } else {
@@ -253,9 +253,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_underline, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[u]', '[/u]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[u]', '[/u]', text, messageElement);
             }
         } else {
@@ -279,9 +279,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_center, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[align=center]', '[/align]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[align=center]', '[/align]', text, messageElement);
             }
         } else {
@@ -307,7 +307,7 @@
             text = prompt(bbcode_prompt_image, fetchSelection(messageElement));
             if (text == fetchSelection(messageElement)) {
                 wrapText('[img]', '[/img]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[img]', '[/img]', text, messageElement);
             }
         } else {
@@ -331,9 +331,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_quote, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText("\r\n"+'[quote]'+"\r\n", '[/quote]'+"\r\n", messageElement);
-            } else {
+            } else if (text != null) {
                 AddText("\r\n"+'[quote]'+"\r\n", '[/quote]'+"\r\n", text, messageElement);
             }
         } else {
@@ -357,9 +357,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_code, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText("\r\n"+'[code]', '[/code]'+"\r\n", messageElement);
-            } else {
+            } else if (text != null) {
                 AddText("\r\n"+'[code]', '[/code]'+"\r\n", text, messageElement);
             }
         } else {
@@ -383,9 +383,9 @@
     } else {
         if (hasSelection(messageElement)) {
             text = prompt(bbcode_prompt_color+color, fetchSelection(messageElement));
-            if (text == fetchSelection(messageElement)) {
+            if (text == fetchSelection(messageElement).replace(/\n/g, ' ')) {
                 wrapText('[color='+color+']', '[/color]', messageElement);
-            } else {
+            } else if (text != null) {
                 AddText('[color='+color+']', '[/color]', text, messageElement);
             }
         } else {
@@ -444,7 +444,7 @@
                     var desc = prompt(bbcode_prompt_link_desc, fetchSelection(messageElement));
                     if (desc == fetchSelection(messageElement)) {
                         wrapText('[url='+url+']', '[/url]', messageElement);
-                    } else {
+                    } else if (desc != null) {
                         AddText('[url='+url+']', '[/url]', desc, messageElement);
                     }
                 }
Index: js/bbcodefns-opera.js
===================================================================
--- js/bbcodefns-opera.js	(revision 1746)
+++ js/bbcodefns-opera.js	(working copy)
@@ -1,6 +1,3 @@
-var bbcode_prompt_link1 = bbcode_prompt_link_desc;
-var bbcode_prompt_link2 = bbcode_prompt_list_item;
-
 var defmode = 'normal';
 
 if (defmode == 'advanced') {
@@ -35,13 +32,15 @@
         alert(bbcode_normode);
     }
 }
+
 function AddText(bbFirst, bbLast, text, el) {
-    if (el.createTextRange && el.caretPos) {
-        var caretPos = el.caretPos
-        el.caretPos.text = el.caretPos.text.charAt(el.caretPos.text.length - 1) == ' ' ? text + ' ' : text;
-    } else {
-        el.value  += text;
-    }
+    var len   = el.textLength;
+    var start = el.selectionStart;
+    var end   = el.selectionEnd;
+    var pre   = el.value.substring(0, start);
+    var post  = el.value.substring(end, len);
+
+    el.value = pre + bbFirst + text + bbLast + post;
     el.focus();
 }
 
@@ -51,13 +50,15 @@
     } else if (advmode) {
         AddText('', '', "[email] [/email]", messageElement);
     } else {
-        txt2=prompt(bbcode_prompt_email_email,"");
-        if (txt2!=null) {
-            txt=prompt(bbcode_prompt_email_error,"user@example.com");
-            if (txt2=="") {
-                AddText('', '', "[email]"+txt+"[/email]", messageElement);
-            } else {
-                AddText('', '', "[email="+txt+"]"+txt2+"[/email]", messageElement);
+        txt2=prompt(bbcode_prompt_email_desc,"");
+        if (txt2!=null)    {
+            txt=prompt(bbcode_prompt_email_email,"");
+            if (txt2!=null) {
+                if (txt2=="") {
+                    AddText('', '', "[email]"+txt+"[/email]", messageElement);
+                } else {
+                    AddText('', '', "[email="+txt+"]"+txt2+"[/email]", messageElement);
+                }
             }
         }
     }
@@ -160,9 +161,9 @@
     } else if (advmode) {
         AddText('', '', "[url] [/url]", messageElement);
     } else {
-        txt2=prompt(bbcode_prompt_link1,"");
+        txt2=prompt(bbcode_prompt_link_desc,"");
         if (txt2!=null)    {
-            txt=prompt(bbcode_prompt_link2,"http://");
+            txt=prompt(bbcode_prompt_link_url,"http://");
             if (txt!=null)    {
                 if (txt2=="") {
                     AddText('', '', "[url]"+txt+"[/url]", messageElement);
@@ -208,7 +209,7 @@
         AddText('', '', "\r[list]\r[*]\r[*]\r[*]\r[/list]", messageElement);
     } else {
         st=prompt(bbcode_prompt_list_start,"");
-        if ((st!="") && (st!="A") && (st!="a") && (st!="1") && (st!=null)) {
+        while ((st!="") && (st!="A") && (st!="a") && (st!="1") && (st!=null)) {
             st = prompt(bbcode_prompt_list_error,"");
         }
 
@@ -259,4 +260,4 @@
 
 function loadEls() {
     messageElement = document.getElementById("message");
-}
\ No newline at end of file
+}
Index: js/header.js
===================================================================
--- js/header.js	(revision 1746)
+++ js/header.js	(working copy)
@@ -42,7 +42,7 @@
     "toolbar=no,location=no,directories=no,"+
     "status=no,menubar=no,scrollbars=yes,"+
     "resizable=yes,width="+window_width+",height="+window_height;
-    NewWindow=window.open(url,window_name,settings);
+    window.open(url,window_name,settings);
 }
 
 
@@ -52,9 +52,9 @@
 
 function avatarCheck(input, max_size) {
     var image = new Image();
+    var avatarCheck = document.getElementById('avatarCheck');
+    var isValid = document.getElementById('newavatarcheck');
     image.onload = function() {
-        var avatarCheck = document.getElementById('avatarCheck');
-        var isValid = document.getElementById('newavatarcheck');
         max_size = max_size.split("x");
 
         if (input.value == "") {
@@ -74,7 +74,18 @@
             avatarCheck.innerHTML = "Valid Image";
         }
     }
-    image.src = input.value;
+    if (input.value.substring(0, 7) == 'http://' || input.value.substring(0, 6) == 'ftp://') {
+        avatarCheck.innerHTML = "Checking URL...";
+        image.src = input.value;
+    } else {
+        if (input.value == '') {
+            avatarCheck.innerHTML = "";
+        } else {
+            avatarCheck.style.color = "#ff0000";
+            avatarCheck.innerHTML = "Invalid: Invalid Image";
+        }
+        isValid.value = "no";
+    }
 }
 
 self.name = 'mainwindow';
Index: js/ticker.js
===================================================================
--- js/ticker.js	(revision 1746)
+++ js/ticker.js	(working copy)
@@ -39,4 +39,9 @@
     tickerrun();
     runid = window.setInterval(tickerrun, delay, '');
     running = true;
-}
\ No newline at end of file
+}
+
+function setTickerEvent() {
+    var old = (window.onload) ? window.onload : function () {};
+    window.onload = function () {old(); tickerstart()};
+}
Index: lang/English.lang.php
===================================================================
--- lang/English.lang.php	(revision 1746)
+++ lang/English.lang.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -27,17 +26,30 @@
  **/
 
 if (!defined('IN_CODE')) {
+    header('HTTP/1.0 403 Forbidden');
     exit("Not allowed to run this file directly.");
 }
 
-$charset = 'ISO-8859-1';
+// Name assigned by XMB for internal use.
+$devname = 'English';
 
+// Meta Data
+$lang['charset'] = 'ISO-8859-1';
+$lang['iso639'] = 'en';
+$lang['language'] = 'English';
+
+// Translation
 $lang['4spaces'] = "&nbsp;&nbsp;&nbsp;&nbsp;";
-$lang['add_buddy'] = "Add more addresses";
 $lang['addressname'] = "Address:";
+$lang['addressupdate'] = "Update";
 $lang['addtime'] = "To crank the base time up, or down, input a number here. Time will be raised, or lowered by this amount for everyone. Put X to add time, or -X to subtract.";
 $lang['addtoaddresses'] = "Add To Address Book";
 $lang['addtobuddies'] = "Add to Address Book";
+$lang['add_buddy'] = "Add more addresses";
+$lang['adminemail'] = "Administrator E-Mail:";
+$lang['adminoption'] = "Administration Option:";
+$lang['adminprofilechange'] = "Thank you, you have successfully changed a members profile content.";
+$lang['adminverifyemail'] = "Verify Users E-mail Address";
 $lang['admin_edituseraccount'] = "Edit Users Account";
 $lang['admin_main_settings1'] = "Board Details";
 $lang['admin_main_settings2'] = "Default Settings";
@@ -46,19 +58,16 @@
 $lang['admin_main_settings5'] = "User Control";
 $lang['admin_main_settings6'] = "Other";
 $lang['admin_main_settings7'] = 'Captcha Image Settings';
+$lang['admin_main_settings8'] = 'File Attachment Settings';
 $lang['admin_rename_fail'] = "Could not rename user. Either the user does not exist, or there's more than one.";
 $lang['admin_rename_success'] = "Successfully renamed user.";
 $lang['admin_rename_txt'] = "Rename User";
 $lang['admin_rename_userfrom'] = "From: ";
 $lang['admin_rename_userto'] = "To: ";
 $lang['admin_rename_warn_self'] = "Warning: You have changed your own username, and thus will be logged out now. To log back in, please use your new username with your (old) password.";
-$lang['adminemail'] = "Administrator E-Mail:";
-$lang['adminoption'] = "Administration Option:";
-$lang['adminprofilechange'] = "Thank you, you have successfully changed a members profile content.";
-$lang['adminverifyemail'] = "Verify Users E-mail Address";
 $lang['allowrankedit'] = "Prevent Staff Post Editing?:<br /><span class=\"smalltxt\">(To prevent staff from editing posts by other staff set status to ON)</span>";
 $lang['alreadyreg'] = "That name and/ or e-mail has already been registered, please try again.";
-$lang['alreadyvoted']  = 'You have already voted in this poll!';
+$lang['alreadyvoted'] = 'You have already voted in this poll!';
 $lang['altadmintools'] = "Administration Tools";
 $lang['altavatar'] = "Avatar";
 $lang['altboardlogo'] = 'Board Logo';
@@ -94,7 +103,7 @@
 $lang['and'] = 'and';
 $lang['anystatus'] = "Any status";
 $lang['asc'] = "Ascending";
-$lang['attachimginpost'] = "Attached Images in Posts:<br /><span class=\"smalltxt\">Do you want to show attachments that are images in the posts?</span>";
+$lang['attachimginpost'] = "Show Thumbnails in Posts:";
 $lang['attachmanwhereauthor'] = "and author is:";
 $lang['attachmanwheredaysold'] = "and where post is this many days old:";
 $lang['attachmanwheredlcountgreater'] = "and download count is greater than:";
@@ -103,13 +112,18 @@
 $lang['attachmanwherename'] = "Where filename contains:";
 $lang['attachmanwheresizegreater'] = "and size is greater than (bytes):";
 $lang['attachmanwheresizesmaller'] = "and size is smaller than (bytes):";
+$lang['attachmaxdims'] = "Image limit is";
+$lang['attachmaxsize'] = "Upload size limit is";
+$lang['attachmaxtotal'] = "Multiple upload size limit per submission is";
 $lang['attachment'] = "Attachment:";
+$lang['attachmentm'] = "Multi-Attach:";
 $lang['attachments'] = "Attachments";
 $lang['attachments_num_restored'] = "attachments restored";
 $lang['attachments_num_stored'] = "attachments stored";
+$lang['attachmore'] = "Click here to upload another file";
 $lang['attachtoobig'] = "The attachment you are trying to upload is too big.";
+$lang['autoinsertposticons'] = "Insert all post icons from smilies directory";
 $lang['autoinsertsmilies'] = "Insert all smilies from smilies directory";
-$lang['autoinsertposticons'] = "Insert all post icons from smilies directory";
 $lang['avatar_too_big'] = "Your avatar is too big! The maximum allowed avatar size on this board is: ";
 $lang['aweek'] = "a week";
 $lang['backto'] = "Back to:";
@@ -123,7 +137,10 @@
 $lang['bannedmessage'] = "You are banned. You may not view the forums, post, make new topics, send U2U's or edit your posts.";
 $lang['banpost'] = "Posting";
 $lang['banu2u'] = "U2U";
+$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [pid]12345[/pid] &nbsp; (Post Link)<br /><br /> [email]mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
+$lang['bbcodeoff'] = "Turn BBCode off?";
 $lang['bbcode_advmode'] = "Advanced Mode\\nThe BB Code will be inserted without options as soon as you hit the button.";
+$lang['bbcode_helpmode'] = "Help Mode\\nClick on any of the formatting buttons for a description and instructions.";
 $lang['bbcode_help_bold'] = "Bold Tag\\nMakes the enclosed text bold.\\nUsage: [b]This is some bold text[/b]";
 $lang['bbcode_help_center'] = "Centered tag\\nCenters the enclosed text.\\nUsage: [align=center]This text is centered[/align]";
 $lang['bbcode_help_code'] = "Code Tag\\nBlockquotes the text you reference and preserves the formatting.\\nuseful for posting code.\\nUsage: [code]This is formatted text[/code]";
@@ -135,9 +152,8 @@
 $lang['bbcode_help_link'] = "Hyperlink Tag\\nTurns an URL into a hyperlink.\\nUsage: [url]http://www.anywhere.com[/url]\\nUsage: [url=http://www.anywhere.com]link text[/url]";
 $lang['bbcode_help_list'] = "List Tag\\nBuilds a bulleted, numbered, or alphabetical list.\\nUsage: [list]\\n[*]item1\\n[*]item2\\n[*]item3\\n[/list]";
 $lang['bbcode_help_quote'] = "Quote tag\\nQuotes the enclosed text to reference something specific that someone has posted.\\nUsage: [quote]This is a quote[/quote]";
-$lang['bbcode_help_size'] = "Size Tag\\nSets the text size.\\n\\nUsage: The size given will be a relative size, relative to the default board size.\\n Eg. default text size is 12pt, setting".'[size=-3]This is size -3pt text[/size]\n will provide a text of size 9pt (because 12pt-3pt = 9pt)';
+$lang['bbcode_help_size'] = "Size Tag\\nSets the text size.\\n\\nUsage: The size given will be a relative size, relative to the default board size.\\n Eg. default text size is 12pt, setting[size=-3]This is size -3pt text[/size]\\n will provide a text of size 9pt (because 12pt-3pt = 9pt)";
 $lang['bbcode_help_underline'] = "Underline Tag\\nUnderlines the enclosed text.\\nUsage: [u]This text is underlined[/u]";
-$lang['bbcode_helpmode'] = "Help Mode\\nClick on any of the formatting buttons for a description and instructions.";
 $lang['bbcode_normode'] = "Normal Mode\\nPopups will bring you step by step through the process of inserting BB Code.";
 $lang['bbcode_prompt_bold'] = "Please enter the text that should be bolded.";
 $lang['bbcode_prompt_center'] = "Please enter the text that should be centered.";
@@ -159,8 +175,6 @@
 $lang['bbcode_prompt_quote'] = "Please enter the text you want quoted.";
 $lang['bbcode_prompt_size'] = "Please enter the text to be size ";
 $lang['bbcode_prompt_underline'] = "Please enter the text that should be underlined.";
-$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [email] mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
-$lang['bbcodeoff'] = "Turn BBCode off?";
 $lang['bbinsert'] = "Auto BB Code Inserter:";
 $lang['bbname'] = "Forum Name:";
 $lang['beenfound'] = "accounts have been found, matching the given query:";
@@ -174,24 +188,27 @@
 $lang['cannotmergesamethread'] = 'I am sorry, but it is impossible to merge a thread with itself.';
 $lang['cantsplit'] = "This topic cannot be split as there are no replies.";
 $lang['cantthreadprune'] = "This topic cannot be pruned as there are no replies.";
-$lang['captchastatus'] = 'Main Status:';
-$lang['captcharegstatus'] = 'Registration Status:';
-$lang['captchapoststatus'] = 'Anonymous Posting Status:';
+$lang['captchacaseon'] = "This code is case-sensitive.";
 $lang['captchacharset'] = 'Code Characters:';
+$lang['captchacodecase'] = 'Case Sensitive Code:';
 $lang['captchacodelength'] = 'Code Length:';
-$lang['captchacodecase'] = 'Case Sensitive Code:';
 $lang['captchacodeshadow'] = 'Code Shadow:';
-$lang['captchaimagetype'] = 'Image Type:';
-$lang['captchaimagewidth'] = 'Image Width:';
-$lang['captchaimageheight'] = 'Image Height:';
 $lang['captchaimagebg'] = 'Image Background(s):';
+$lang['captchaimagecolor'] = 'Use Full Color:';
 $lang['captchaimagedots'] = 'Number of Random Dots:';
+$lang['captchaimagefonts'] = 'Image Font(s):';
+$lang['captchaimageheight'] = 'Image Height:';
+$lang['captchaimageinvalid'] = "The image verification code that you entered was incorrect. Please enter the code exactly how it appears in the image.";
 $lang['captchaimagelines'] = 'Number of Random Lines:';
-$lang['captchaimagefonts'] = 'Image Font(s):';
+$lang['captchaimagemaxfont'] = 'Max Font Size:';
 $lang['captchaimageminfont'] = 'Min Font Size:';
-$lang['captchaimagemaxfont'] = 'Max Font Size:';
-$lang['captchaimagecolor'] = 'Use Full Color:';
-$lang['captchaimageinvalid'] = "The image verification code that you entered was incorrect. Please enter the code exactly how it appears in the image.";
+$lang['captchaimagetype'] = 'Image Type:';
+$lang['captchaimagewidth'] = 'Image Width:';
+$lang['captchaindebug'] = "Captcha features are not available in DEBUG mode.";
+$lang['captchapoststatus'] = 'Anonymous Posting Status:';
+$lang['captcharegstatus'] = 'Registration Status:';
+$lang['captchasearchstatus'] = 'Anonymous Searching Status:';
+$lang['captchastatus'] = 'Main Status:';
 $lang['captchaverification'] = "Captcha Image Verification";
 $lang['cb_advmode'] = "Advanced";
 $lang['cb_fomatting'] = "Formatting Mode:";
@@ -221,11 +238,11 @@
 $lang['copythread'] = "Copy Thread";
 $lang['copythreadmsg'] = "This thread has been copied. Redirecting you to the original forum.";
 $lang['copythreadto'] = "Copy thread to";
-$lang['cp_deleteposts'] = "Delete Posts";
-$lang['cp_subscription'] = "Newsletter Subscription?";
 $lang['cprestricted'] = "Restriction Manager";
 $lang['cpsearch'] = "Search";
 $lang['cpwodump'] = "Clear Whos Online";
+$lang['cp_deleteposts'] = "Delete Posts";
+$lang['cp_subscription'] = "Newsletter Subscription?";
 $lang['currentip'] = "Your current IP Address is";
 $lang['dateformat'] = "Date Format (mm/dd/yyyy, dd-mm-yy, etc):";
 $lang['day1'] = "last day";
@@ -237,12 +254,13 @@
 $lang['daysold'] = "Days Old";
 $lang['db_backup'] = "Database Backup";
 $lang['defaultTimezoneDesc'] = "Default TimeZone";
-$lang['delete_all_themes'] = "You can not delete your last theme! Your board won't work without it!";
+$lang['deleteaborted'] = 'The delete action was aborted due to a protection error.';
 $lang['deletebutton'] = "Delete";
 $lang['deletecolon'] = "Delete:";
 $lang['deletecurrent'] = "&nbsp;Delete current file.";
 $lang['deletethread'] = "Delete Thread";
 $lang['deletethreadmsg'] = "Thank you, the topic has been deleted. You are now being forwarded back to the thread list.";
+$lang['delete_all_themes'] = "You can not delete your last theme! Your board won't work without it!";
 $lang['desc'] = "Descending";
 $lang['developedby'] = "Developed By";
 $lang['dotfolders'] = "'dot' Folders:<br /><span class=\"smalltxt\">Do you want to show dots on folders for the users that have posted in them?</span>";
@@ -290,23 +308,33 @@
 $lang['evalstats8'] = '$lang["stats8"] = "The most popular forum is $popforum with $pop[posts] posts and $pop[threads] topics";';
 $lang['evalstats9'] = '$lang["stats9"] = "$mempost posts per member";';
 $lang['evaltrevlt'] = '$lang["trevltmsg"] = "This is a long topic, click <a href=\"$threadlink\">here</a> to review it.";';
+$lang['evalu2ustaffquota'] = '$lang["uqinfo"] = "You have $u2ucount U2Us with no limits.";';
 $lang['evaluqinfo'] = '$lang["uqinfo"] = "You have $u2ucount U2Us. This is $percent% of the maximum, the maximum is set to $u2uquota.";';
 $lang['evaluqinfo_over'] = '$lang["uqinfo"] = "<strong>Note! You cannot send any U2Us before you lessen the number of your current U2Us.</strong><br />You have $u2ucount U2Us. The maximum is set to $u2uquota.";';
-$lang['evalu2ustaffquota'] = '$lang["uqinfo"] = "You have $u2ucount U2Us with no limits.";';
 $lang['evalusercpwelcome'] = '$lang["usercpwelcome"] = "Hello $xmbuser, welcome to your user control panel. Here you can edit your profile, board options, send/ read your U2U messages, view your favorite threads and more.";';
 $lang['existingip'] = "This IP Address is already banned";
-$lang['export_fid_expl'] = "Which forum (fid) should all orphaned threads be moved?";
+$lang['export_fid_expl'] = "To which forum (fid) should all orphaned threads be moved?";
 $lang['export_fid_not_there'] = "No forum was specified to send the orphaned threads to.";
+$lang['export_tid_expl'] = "To which thread (tid) should all orphaned posts be moved?";
+$lang['export_tid_not_there'] = "No thread was specified to send the orphaned posts to.";
 $lang['favaddedmsg'] = "The thread has successfully been added to your favorites list. You will now be taken to it.";
 $lang['favonlistmsg'] = "The selected thread is already on your favorites list.";
 $lang['favsdeletedmsg'] = "The selected threads have successfully been removed from your favorites list, you will now be taken back to it.";
 $lang['featurewarning'] = "Warning";
 $lang['filecorrupt'] = "The file you are trying to download appears corrupt. File download aborted.";
-$lang['floodprotect'] = "Your last post was less than $SETTINGS[floodctrl] seconds ago, and you are not allowed to post that frequently. If you double posted on accident, your first post has been posted, it's just your second post that was stopped.";
-$lang['floodprotect_u2u'] = "Your last U2U was less than $SETTINGS[floodctrl] seconds ago, and you are not allowed to message that frequently. If you double sent on accident, your first U2U has been sent succesfully, it's just your second U2U that was stopped.";
+$lang['fileuploaderror1'] = 'XMB Error: The Attachment Storage Path setting appears to be invalid.';
+$lang['fileuploaderror2'] = 'You have attached the maximum number of files allowed per post.';
+$lang['fileuploaderror3'] = 'There appears to be an invalid URL in one of the IMG links in your message.';
+$lang['fileuploaderror4'] = 'One of the IMG links in your message points to a non-image file.';
+$lang['fileuploaderror5'] = 'The image you uploaded exceeds our width and height limits.  Please re-size the image and try again.';
+$lang['fileuploaderror6'] = 'Sorry, the file you uploaded exceeds our size limit.';
+$lang['fileuploaderror7'] = 'XMB Error: Could not find a temporary directory for remote attachments.';
+$lang['fileuploaderror8'] = 'Sorry, there was a problem attaching one of your files or images to this message.';
+$lang['floodprotect'] = "You are not allowed to post this frequently.  Flood protection is triggered when more than one post is submitted in an unexpected manner.  Check if your post is already saved or try again in a few moments.";
+$lang['floodprotect_u2u'] = "You are not allowed to send messages this frequently.  Flood protection is triggered when more than one message is submitted in an unexpected manner.  Check if your message is already saved or try again in a few moments.";
 $lang['fnasorry'] = "Sorry, this feature is currently not available...";
 $lang['fnasorry2'] = "We apologize for the inconvenience.";
-$lang['fnasorry3'] = "We apologize for the inconvenience.<br />The board administrator has disabled this option, and it cannot be used at this time. If you believe you have received this message in error, please contact the board <a href=\"mailto:$adminemail\"><strong>webmaster</strong></a>";
+$lang['fnasorry3'] = "We apologize for the inconvenience.<br />The board administrator has disabled this option, and it cannot be used at this time. If you believe you have received this message in error, please contact the board webmaster";
 $lang['folderlist'] = "Manage Folders";
 $lang['foldermsg'] = "Separate all folders by commas (i.e. \"Folder 1, Folder 2\").";
 $lang['foldersupdate'] = "Folders list successfully updated.";
@@ -314,25 +342,28 @@
 $lang['footer_options'] = 'Footer Options:';
 $lang['forgotpw'] = "Forgot password?";
 $lang['forumjumpselect'] = "Select A Forum";
+$lang['forumnotempty'] = 'The selected forum is not empty.  A forum must be empty to perform this action.';
+$lang['forumpermissions'] = 'Forum Permissions:';
 $lang['forumpruned'] = "Forum successfully pruned";
-$lang['forumpermissions'] = 'Forum Permissions:';
 $lang['forumpw'] = "Password:<br /><span class=\"smalltxt\">(leave blank for none)</span>";
 $lang['forumpwinfo'] = "This forum is password protected. To view this forum you need to enter the correct password below.";
 $lang['found'] = "Found";
 $lang['general'] = 'General';
+$lang['generic_file'] = 'File to Upload:';
+$lang['generic_missing'] = 'The item you requested could not be found.';
 $lang['gotobottom'] = "Go To Bottom";
 $lang['gototop'] = "Go To Top";
 $lang['guestpostingonmsg'] = "<br />Anonymous Posting is on for this forum.<br /><span class=\"smalltxt\"> Do not enter a username or password to post anonymously.</span>";
 $lang['gzipcompression'] = "Use Gzip Page Compression<br /><span class=\"smalltxt\">Requires PHP 4.0.4 or higher</span>";
 $lang['helpbar'] = "Help";
 $lang['hidden'] = "Invisible";
-$lang['hottopic'] = "more than $hottopic replies";
-$lang['ipreg'] = "Allow maximum 1 user to register per ip per day?";
+$lang['hottopiceval'] = "\$lang['hottopic'] = \"more than \$hottopic replies\";";
 $lang['ignorelist'] = "Ignore List";
 $lang['ignoremsg'] = "Ignore List:<br /><span class=\"smalltxt\">Separate names with commas (i.e. \"Person 1, Person 2,\"). Make sure you leave a comma after the last name.</span>";
 $lang['ignoreupdate'] = "Ignore list updated successfully!";
 $lang['imdeletedmsg'] = "U2U(s) successfully deleted. You will now be taken to your IM list.";
 $lang['imgdir'] = "Image Directory:";
+$lang['imgdiradm'] = "Admin Image Directory:";
 $lang['impossiblebanall'] = "You can not ban <strong>all</strong> ips from your board!!";
 $lang['imsavedmsg'] = "Your U2U message has been saved. You will now be taken to your drafts folder.";
 $lang['imsentmsg'] = "Your U2U message has been sent. You will now be taken back to your inbox.";
@@ -342,20 +373,26 @@
 $lang['indexShowBarTop'] = "Top of the page only";
 $lang['index_stats'] = "Index Stats Bar Status:<br /><span class=\"smalltxt\">This option will enable/disable the stats bar on index.</span>";
 $lang['insertdata'] = "Insert your Data";
+$lang['invalidFilename'] = "Invalid Filename";
 $lang['invalidforumpw'] = "The password you entered is invalid.";
 $lang['invalidip'] = "Invalid IP Address Format";
-$lang['invalidFilename'] = "Invalid Filename";
 $lang['invalidtid'] = "Thread cannot be merged.  Invalid Thread ID (tid)";
 $lang['invertselection'] = "Invert Selection";
+$lang['ipbandisable'] = "Disable IP Banning";
+$lang['ipbanenable'] = "Enable IP Banning";
+$lang['ipreg'] = "Allow maximum 1 user to register per ip per day?";
 $lang['ipwarning'] = "<br /><strong>Warning!</strong> Your IP Address is on the list. You'll be permanently banned if you log out.";
 $lang['key'] = 'Key: ';
-$lang['last50today'] = "Last $onlinetodaycount Members Who Have Visited Today (if applicable)";
+$lang['langimportfail'] = "The language could not be imported.";
+$lang['langimportsuccess'] = "The language imported successfully.";
+$lang['last50todayeval'] = "\$lang['last50today'] = \"Last \$onlinetodaycount Members Who Have Visited Today (if applicable)\";";
 $lang['lastactive'] = "Last active:";
 $lang['lastreply1'] = "on";
 $lang['lastsadmin'] = "You just tried to de-admin the last remaining Super Administrator. This is a dangerous thing to do. Once de-admin'd, it is not possible anymore to reset one's status back to Super Administrator";
 $lang['lastyear'] = "last year";
 $lang['launchbuddylist'] = "Open Address Book";
 $lang['leaveuntouched'] = "&nbsp;Leave current file untouched";
+$lang['location'] = "Location";
 $lang['locktopic'] = "A closed topic";
 $lang['loggedin'] = "Logged in as";
 $lang['loggedinuser'] = "Logged In User:";
@@ -365,7 +402,7 @@
 $lang['lostpw_in24hrs'] = "You have already requested your password once in the last 24 hours.<br />You can not rerequest it in the same 24-hour period.";
 $lang['lpoststats'] = "last post";
 $lang['max_addresses_per_entry'] = "Due to server-protection, it is not allowed to save more than 10 addresses at one time.";
-$lang['max_attachment_size'] = "Maximum Attachment size (in bytes):";
+$lang['max_attachment_size'] = "Maximum File Size (in bytes):";
 $lang['max_avatar_size_h'] = "The maximum avatar Height (in pixels):";
 $lang['max_avatar_size_w'] = "The maximum avatar Width (in pixels):";
 $lang['max_daily_regs'] = "Maximum number of new registrations per day.<br />Set to 0 for unlimited registrations per day.";
@@ -375,15 +412,26 @@
 $lang['mcpuid'] = "UID";
 $lang['memberisoff'] = "Member Is Offline";
 $lang['memberison'] = "Member Is <strong>Online</strong>";
+$lang['memcpmood'] = "Your Current Mood:";
 $lang['memcp_otherinfo'] = "Other Information";
 $lang['memcp_otheroptions'] = "Other Options";
-$lang['memcpmood'] = "Your Current Mood:";
 $lang['memposts'] = "Posts";
-$lang['message'] = "Message";
 $lang['mergethreadmsg'] = "Thank you, the topics have been merged. You are now being forwarded back to the thread list.";
 $lang['mergewithmsg'] = "TID of the topic to be merged and deleted:<br /><span class=\"smalltxt\">viewthread.php?tid=48, the tid would be 48</span>";
+$lang['message'] = "Message";
 $lang['misconlinetoday'] = "The following ";
-$lang['misconlinetoday2'] = " members have visited $bbname today...";
+$lang['misconlinetoday2'] = " members have visited today...";
+$lang['modlog_bump'] = "Thread Bumped";
+$lang['modlog_close'] = "Thread Closed";
+$lang['modlog_copy'] = "Thread Copied";
+$lang['modlog_empty'] = "Thread Emptied";
+$lang['modlog_merge'] = "Threads Merged";
+$lang['modlog_move'] = "Thread Moved";
+$lang['modlog_open'] = "Thread Opened";
+$lang['modlog_split'] = "Thread Split";
+$lang['modlog_threadprune'] = "Thread Pruned";
+$lang['modlog_top'] = "Thread Topped";
+$lang['modlog_untop'] = "Thread Untopped";
 $lang['month1'] = "a month";
 $lang['month3'] = "3 months";
 $lang['month6'] = "6 months";
@@ -392,6 +440,8 @@
 $lang['moved'] = "Moved:";
 $lang['moveques'] = "Move?";
 $lang['movethreadmsg'] = "Thank you, the topic has been moved. You are now being forwarded back to the thread list.";
+$lang['movetodb'] = 'Move to Database';
+$lang['movetodisk'] = 'Move to Disk';
 $lang['multipnote'] = "Note: To ban multiple IP addresses at once, replace any of the 4 parts of the IP with a * (ex: 220.194.45.*)";
 $lang['multmodnote'] = "Note: To make multiple moderators, separate moderators with a comma (including a space) (ex: Moderator 1, Moderator 2)";
 $lang['mysql_tools'] = "Database Tools";
@@ -408,13 +458,10 @@
 $lang['newu2u1'] = "You have";
 $lang['newu2u2'] = "new U2U message(s)";
 $lang['nextsearch'] = "[Next Page]";
-$lang['no_buddies'] = "There are no addresses in your address book";
-$lang['no_poll'] = "This is not a poll!";
-$lang['no_templates'] = "templates.xmb was not found.";
 $lang['noadminsession'] = "No Administration Login Session Found.";
-$lang['noadminsession2'] = "Welcome to the administration control panel, currently running $bbname.";
+$lang['noadminsession2'] = "Welcome to the administration control panel, currently running.";
 $lang['noadminsession3'] = "Please enter your username and password which currently has administration status.";
-$lang['noadminsession4'] = "If you still have issues logging in, please contact the board <strong><a href=\"mailto:$adminemail?subject=Admin Login Failure At $bbname\">webmaster</a></strong>";
+$lang['noadminsession4'] = "If you still have issues logging in, please contact the board webmaster.";
 $lang['noban'] = "Nothing";
 $lang['nobuddyselected'] = "You did not select a user to add to your address book.";
 $lang['noedit'] = "Sorry, you are not allowed to edit or delete this post.";
@@ -434,12 +481,20 @@
 $lang['notloggedin'] = "Not logged in";
 $lang['notpermitted'] = "You are not permitted to perform this operation.";
 $lang['nou2umsg'] = "You currently do not have any U2U Messages in your inbox.";
+$lang['no_buddies'] = "There are no addresses in your address book";
+$lang['no_poll'] = "This is not a poll!";
+$lang['no_templates'] = "templates.xmb was not found.";
+$lang['no_url_fopen'] = "This feature has been disabled by the allow_url_fopen directive in your server's PHP configuration.";
 $lang['numberusing'] = "Used:";
-$lang['o_attach_submit'] = "Delete all orphaned attachments";
-$lang['o_attachments_found'] = " orphaned attachments found and deleted.";
-$lang['o_threads_found'] = " orphaned threads found and reallocated";
+$lang['onlinebuddy'] = "Viewing address book";
+$lang['onlinebuddyadd'] = "Adding user(s) to address book";
+$lang['onlinebuddyadd2u2u'] = "Adding user(s) to U2U";
+$lang['onlinebuddydelete'] = "Deleting user(s) from address book";
+$lang['onlinebuddyedit'] = "Editing address book";
+$lang['onlinecatunknown'] = "Viewing an unknown category";
 $lang['onlinecoppa'] = "Reading coppa license";
 $lang['onlinecp'] = "Using the administration panel";
+$lang['onlineeditnoprofile'] = 'Editing an unknown profile';
 $lang['onlineeditprofile'] = 'Editing $user\'s profile';
 $lang['onlinefaq'] = "Reading the FAQ";
 $lang['onlineforumdisplay'] = "Viewing forum: ";
@@ -449,7 +504,13 @@
 $lang['onlinelostpw'] = "Recovering lost password";
 $lang['onlinemanagefolders'] = "Managing U2U folders";
 $lang['onlinememcp'] = "Viewing user control panel";
+$lang['onlinememcpfav'] = "Viewing favorite threads";
+$lang['onlinememcppro'] = "Updating personal profile";
+$lang['onlinememcpsub'] = "Viewing subscribed threads";
 $lang['onlinememlist'] = "Viewing member list";
+$lang['onlinenoforum'] = 'Viewing an unknown forum';
+$lang['onlinenoprofile'] = 'Viewing an unknown profile';
+$lang['onlinenothread'] = 'Viewing an unknown thread';
 $lang['onlineonlinetoday'] = "Viewing members who have been online today";
 $lang['onlineother'] = "Other";
 $lang['onlinepostedit'] = "Editing a post";
@@ -464,32 +525,25 @@
 $lang['onlinetopicadmin'] = "Moderating the board";
 $lang['onlineu2udelete'] = "Deleting a U2U";
 $lang['onlineu2uignore'] = "Adding user to ignore list";
+$lang['onlineu2uint'] = 'Viewing U2U messenger';
 $lang['onlineu2usend'] = "Sending a U2U";
 $lang['onlineu2uview'] = "Reading a U2U";
+$lang['onlineunknown'] = 'Performing an unknown action';
+$lang['onlineviewcat'] = "Viewing category: ";
 $lang['onlineviewpro'] = 'Viewing $member\'s profile';
 $lang['onlineviewthread'] = "Reading thread: ";
 $lang['onlinewhosonline'] = "Viewing members online";
-$lang['onlinenothread'] = 'Viewing an unknown thread';
-$lang['onlinenoforum'] = 'Viewing an unknown forum';
-$lang['onlineeditnoprofile'] = 'Editing an unknown profile';
-$lang['onlinenoprofile'] = 'Viewing an unknown profile';
-$lang['onlineunknown'] = 'Performing an unknown action';
-$lang['onlineu2uint'] = 'Viewing U2U messenger';
-$lang['onlineviewcat'] = "Viewing category: ";
-$lang['onlinecatunknown'] = "Viewing an unknown category";
-$lang['onlinememcppro'] = "Updating personal profile";
-$lang['onlinememcpsub'] = "Viewing subscribed threads";
-$lang['onlinememcpfav'] = "Viewing favorite threads";
-$lang['onlinebuddy'] = "Viewing address book";
-$lang['onlinebuddyadd'] = "Adding user(s) to address book";
-$lang['onlinebuddyedit'] = "Editing address book";
-$lang['onlinebuddydelete'] = "Deleting user(s) from address book";
-$lang['onlinebuddyadd2u2u'] = "Adding user(s) to U2U";
 $lang['opennew'] = "An open topic with new posts";
 $lang['opentopic'] = "An open topic";
 $lang['optimize'] = 'Optimize Tables';
 $lang['optional'] = "Optional:";
 $lang['origpostedby'] = "Originally posted by";
+$lang['o_attachments_found'] = " orphaned attachments found and deleted.";
+$lang['o_attach_submit'] = "Delete all orphaned attachments";
+$lang['o_polls_found'] = " orphaned polls found and deleted.";
+$lang['o_poll_submit'] = "Delete all orphaned polls";
+$lang['o_posts_found'] = " orphaned posts found and reallocated.";
+$lang['o_threads_found'] = " orphaned threads found and reallocated";
 $lang['parenopt'] = "(optional)";
 $lang['piconexists'] = 'PostIcon already exists';
 $lang['picons'] = "Post Icons";
@@ -521,6 +575,7 @@
 $lang['prunetopped'] = "Topped Posts";
 $lang['pruneusers'] = "The number of days after which a new user, who has never logged in, will be deleted.<br />Set to 0 to disable.";
 $lang['pspell_needed'] = "(<strong>This feature can not be turned on until your host installs the pspell/aspell extension!</strong>)";
+$lang['pwchange'] = "Change Password";
 $lang['pwnomatch'] = "Passwords do not match";
 $lang['pwnote'] = "Enter new password if changing, otherwise leave blank.";
 $lang['queries'] = "Queries";
@@ -532,14 +587,15 @@
 $lang['raw_mysql'] = "Insert Raw SQL";
 $lang['reason'] = "Reason:";
 $lang['refreshbuddylist'] = "Refresh Address Book";
-$lang['reg_on'] = "Allow User Registration";
-$lang['regoptional'] = "Optional fields on registration status:<br /><span class=\"smalltxt\">This option enables/disables optional fields on registration such as AIM, BIO, ICQ, Signatures etc.</span>";
-$lang['reg_today'] = "You have already registered today, you can re-register again in 24 hours.<br />";
+$lang['refreshpage'] = 'Refresh Page';
+$lang['regeneratethumbnail'] = "Regenerate Thumbnail";
 $lang['regged'] = "Thank you for registering. We have logged you in and are forwarding you to the main page.";
 $lang['reggedonly'] = "You must be registered to view these boards.";
 $lang['registerrulestitle'] = "Registration Terms";
+$lang['regoptional'] = "Optional fields on registration status:<br /><span class=\"smalltxt\">This option enables/disables optional fields on registration such as AIM, BIO, ICQ, Signatures etc.</span>";
 $lang['regques'] = "Need to register?";
-$lang['refreshpage'] = 'Refresh Page';
+$lang['reg_on'] = "Allow User Registration";
+$lang['reg_today'] = "You have already registered today, you can re-register again in 24 hours.<br />";
 $lang['renamefile'] = "&nbsp;Rename current file to:";
 $lang['repair'] = 'Repair Tables';
 $lang['replace'] = "Replace";
@@ -556,9 +612,13 @@
 $lang['restricted'] = "Sorry, you are unable to register this name as it is currently reserved. Please try again..";
 $lang['restrictedname'] = "Current usernames &amp; e-mail addresses not allowed";
 $lang['restrictedupdate'] = "Restricted usernames updated successfully!";
-$lang['rulesoninfo'] = "The <a href=\"mailto:$adminemail\"> board administrator</a> has requested that all new registered users must agree to the following terms before registering and using the services on the board \"$bbname\". Please read the following terms and if you agree to them, select the \"I agree\" button found at the bottom of the terms.";
+$lang['rulesoninfo'] = "The board administrator has requested that all new registered users must agree to the following terms before registering and using the services on this board. Please read the following terms and if you agree to them, select the \"I agree\" button found at the bottom of the terms.";
+$lang['searchbody'] = "Post body and subject.";
+$lang['searchguesterror'] = "Anonymous users are limited to only one page of search results.";
+$lang['searchinvalid'] = "That search text is not allowed.  Please try a different keyword.";
+$lang['searchsubject'] = "Subject only.";
+$lang['searchusermsg'] = '<a href="search.php?srchuname=*USER*&amp;searchsubmit=a&amp;f=all&amp;srchfrom=0">Search</a> for all posts by this user';
 $lang['search_advanced'] = "Advanced Search";
-$lang['searchusermsg'] = '<a href="misc.php?action=search&amp;srchuname=*USER*&amp;searchsubmit=a&amp;srchfid=all&amp;srchfrom=0">Search</a> for all posts by this user';
 $lang['secure_login'] = "Secure Login - increased security on public computers";
 $lang['selecttemplate'] = "Please select a template...";
 $lang['seperatebycomma'] = "Seperate multiple entries using commas";
@@ -577,12 +637,12 @@
 $lang['smtotal'] = "Total Visible Clickable Smilies:";
 $lang['sortby'] = " and sort them by";
 $lang['space_cats'] = "Spaced Categories Status:";
-$lang['spell_checker'] = "Spellchecker ";
 $lang['spellingchecker'] = 'Spellcheck';
 $lang['spellingcomplete'] = 'Spellcheck complete';
+$lang['spell_checker'] = "Spellchecker ";
 $lang['splitthreadmsg'] = "Thank you, the topic has been split. You are now being forwarded back to the thread list.";
 $lang['srchbyforum'] = "in (forum):";
-$lang['srchfilter_double'] = "Filter out all double posts?";
+$lang['srchfilter_double'] = "Show only one post per thread?";
 $lang['startticker'] = "Resume";
 $lang['statistics'] = "Statistics";
 $lang['stats4'] = "Please welcome our newest member";
@@ -657,6 +717,7 @@
 $lang['textborderwidth'] = "Border Width:";
 $lang['textbriefsummary'] = "Brief Account Summary For";
 $lang['textbstatus'] = "Board Status:";
+$lang['textbstatusdefault'] = "This message board is currently turned off.";
 $lang['textbuddylist'] = "Address Book";
 $lang['textbumpthread'] = "Bump Thread";
 $lang['textby'] = "by";
@@ -732,7 +793,7 @@
 $lang['textfaqans16'] = "Smilies are the little faces to the right of the input for message. They display graphical faces instead of simply a <strong>:)</strong>.<br />Here is a list of current supported smilies:";
 $lang['textfaqans17'] = "You can create a poll by visiting the forum you want to post the poll in and click on Start Poll. The screen following after you click the button is just like a normal new thread page but has an extra box for Poll Answers. You should enter one answer per line.<br /><br />You can vote on polls in threads by visiting the thread with the poll in it and selecting the option you want to vote for, then clicking the submit button. You can only vote on a poll once, so once you vote, you cant change your mind.<br /><br />The Administrator could have disabled this option for each forum.";
 $lang['textfaqans19'] = "Most of the time the answer is no, but ask your Admin.";
-$lang['textfaqans2'] = "Yes. $bbname uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
+$lang['textfaqans2'] = "Yes. This board uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
 $lang['textfaqans21'] = "You can logout by clicking Logout at the top of the page. When you logout the cookies that store your username and password will be removed and you will become a Guest or Anonymous user.";
 $lang['textfaqans3'] = "To add a signature to your posts you have to log into your <a href=\"memcp.php\">profile</a> and insert into the signature text box the signature you wish to use.<br /><br />BB Code and HTML maybe turned off or on. This can effect what you can insert into your signature.";
 $lang['textfaqans4'] = "Again in your <a href=\"memcp.php\">profile</a> there is a place for an 'Avatar' and avatar is the image under your name. Check with your Admin about the size of your avatar, it's usually considered common courtesy to use one under 150 pixels wide.";
@@ -746,11 +807,30 @@
 $lang['textfavorites'] = "Favorites";
 $lang['textfeb'] = "February";
 $lang['textfilename'] = "Filename:";
+$lang['textfilesbase'] = 'Attachment Virtual URL:<br /><span class="smalltxt">Optional, base URL if different from $full_url.</span>';
 $lang['textfilesize'] = "Filesize:";
+$lang['textfilesminsize'] = 'Attachment Minimum Storage Size:<br /><span class="smalltxt">Storage Path is ignored for files<br />smaller than this many bytes.</span>';
+$lang['textfilespath'] = 'Attachment Storage Path:<br /><span class="smalltxt">Optional, disk storage location for new files.</span>';
+$lang['textfilesperpost'] = 'Maximum Files Per Post:';
+$lang['textfilessizeh'] = 'Maximum Image Height:';
+$lang['textfilessizew'] = 'Maximum Image Width:';
+$lang['textfilessubdir'] = 'Attachment Subdirectory Scheme:';
+$lang['textfilessubdir1'] = 'Year/Month';
+$lang['textfilessubdir2'] = 'Year/Month/Day';
+$lang['textfilesthumbh'] = 'Maximum Thumbnail Height:';
+$lang['textfilesthumbw'] = 'Maximum Thumbnail Width:';
+$lang['textfilesurlpath'] = 'Attachment URL Format:<br /><span class="smalltxt">For Advanced Webmasters Only</span>';
+$lang['textfilesurlpath1'] = '____(default) /files.php?pid=$pid&amp;aid=$aid';
+$lang['textfilesurlpath2'] = '(+MultiViews) /files/$pid/$aid/';
+$lang['textfilesurlpath3'] = '(+MultiViews) /files/$aid/$filename';
+$lang['textfilesurlpath4'] = '(mod_rewrite) /$pid/$aid/';
+$lang['textfilesurlpath5'] = '(mod_rewrite) /$aid/$filename';
 $lang['textfixlastposts'] = "Fix Last Posts";
 $lang['textfixmemposts'] = "Fix Member Post Totals";
 $lang['textfixmoods'] = "Reset Blank Moods";
 $lang['textfixoattachments'] = "Fix Orphaned Attachments";
+$lang['textfixopolls'] = "Fix Orphaned Polls";
+$lang['textfixoposts'] = "Fix Orphaned Posts";
 $lang['textfixothreads'] = "Fix Orphaned Threads";
 $lang['textfixposts'] = "Fix Forum Totals";
 $lang['textfixthread'] = "Fix Thread Totals";
@@ -785,8 +865,7 @@
 $lang['textillegalquery'] = "The query you used is not allowed.";
 $lang['textimgcode'] = "IMG Code";
 $lang['textimgcodeis'] = "[img] Code is";
-$lang['textimportsubmit'] = "Import Theme into $bbname";
-$lang['textimporttheme'] = "Import Theme:";
+$lang['textimporttheme'] = "Import Theme";
 $lang['textinforum'] = "in forum:";
 $lang['textinthread'] = "In Thread:";
 $lang['textinvisible'] = "Browse the board invisible";
@@ -810,7 +889,7 @@
 $lang['textlogin'] = "Login";
 $lang['textlogin_incorrect'] = "Login Details Incorrect";
 $lang['textlogout'] = "Logout";
-$lang['textlogsdump'] = "Clear Logs";
+$lang['textlogsdump'] = "Clear Control Panel Logs";
 $lang['textlostpw'] = "Recover Lost Password";
 $lang['textlostpwnote'] = "Please enter both your <strong>Username</strong> and your <strong>e-mail</strong>.";
 $lang['textmanagefolders'] = "Manage Folders";
@@ -858,7 +937,7 @@
 $lang['textnewsmilie'] = "New Smilie";
 $lang['textnewsubf'] = "New Sub-Forum";
 $lang['textnewtheme'] = "New Theme";
-$lang['textnewu2ubody'] = "has sent you an U2U at $bbname.\nTo stop receiving these notifications, please login to your user control panel.\n\nYou can read the U2U by going to\n\n";
+$lang['textnewu2ubody'] = "has sent you a new U2U.\nTo stop receiving these notifications, please login to your user control panel.\n\nYou can read the U2U by going to\n\n";
 $lang['textnewu2uemail'] = "You received a new U2U";
 $lang['textno'] = "No";
 $lang['textnoaction'] = "Sorry, you are not authorized to perform this action";
@@ -880,6 +959,7 @@
 $lang['textoff'] = "Off";
 $lang['textoffline'] = "Offline";
 $lang['textoftotposts'] = "of total posts";
+$lang['textoldpassword'] = "Old Password";
 $lang['texton'] = "On";
 $lang['textonline'] = "Online";
 $lang['textopenthread'] = "Open Thread";
@@ -917,7 +997,7 @@
 $lang['textprune'] = "Prune";
 $lang['textprunethread'] = "Prune Thread";
 $lang['textpw1'] = "Sorry, the username/password you have entered appears to be incorrect.";
-$lang['textpw2'] = "Please press the back button on your browser now, and try again.";
+$lang['textpw2'] = "Please try again.";
 $lang['textpwincorrect'] = 'You entered an incorrect password';
 $lang['textquote'] = "Quote:";
 $lang['textre'] = "Re:";
@@ -927,6 +1007,7 @@
 $lang['textreggedonly'] = "Allow only registered users to view boards?";
 $lang['textregister'] = "Register";
 $lang['textregistered'] = "Registered:";
+$lang['textremoteimages'] = 'Attach Remote Images:<br /><span class="smalltxt">Convert new [img] BBCodes to attachments.</span>';
 $lang['textreplies'] = "Replies:";
 $lang['textreply'] = "Reply";
 $lang['textreplytrash'] = "Reply and delete";
@@ -974,21 +1055,21 @@
 $lang['textstats'] = "Stats";
 $lang['textstatsstatus'] = "Statistics Status:";
 $lang['textstatus'] = "Avatar &amp; Member Status:";
-$lang['textsubbody'] = "has replied to a thread you have subscribed to at $bbname.\nTo stop receiving these notifications, please login to your user control panel.\n\nYou can visit the thread by going to\n\n";
+$lang['textsubbody'] = "has replied to a thread you subscribed to.\nTo stop receiving these notifications, please login to your user control panel.\n\nYou can visit the thread by going to\n\n";
 $lang['textsubforums'] = "Sub-Forums:";
 $lang['textsubject'] = "Subject:";
 $lang['textsubmit'] = "Submit";
 $lang['textsubmitchanges'] = "Submit Changes";
 $lang['textsubscribe'] = "Subscribe";
 $lang['textsubscriptions'] = "Subscriptions";
-$lang['textsubsubject'] = "$bbname - New Reply To Subscribed Thread";
+$lang['textsubsubject'] = "New Reply To Subscribed Thread";
 $lang['textsupermod'] = "Super Moderator";
 $lang['texttabletext'] = "Table Text Color:";
 $lang['texttext'] = "Text Color:";
 $lang['texttheme'] = "Theme:";
-$lang['textthemefile'] = "$bbname Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
-$lang['textthemeimportfail'] = "The theme could not be imported into $bbname.";
-$lang['textthemeimportsuccess'] = "The theme has successfully been imported into $bbname.";
+$lang['textthemefile'] = "Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
+$lang['textthemeimportfail'] = "The theme could not be imported.";
+$lang['textthemeimportsuccess'] = "The theme has been been imported successfully.";
 $lang['textthemename'] = "Theme Name:";
 $lang['texttime'] = "Time:";
 $lang['texttimeformat'] = "Time Format:";
@@ -1042,14 +1123,14 @@
 $lang['textyes'] = "Yes";
 $lang['textyesip'] = "This user had an ip of";
 $lang['textyourpw'] = "Your Login Information";
-$lang['textyourpwis'] = "This is an automatic e-mail. Your new login credentials for $bbname can be found below:";
-$lang['theme_already_exists'] = "A theme with this name already exists!";
+$lang['textyourpwis'] = "This is an automatic e-mail. Your new login credentials can be found below:";
 $lang['themes'] = "Themes";
 $lang['themeupdate'] = "Themes updated successfully!";
+$lang['theme_already_exists'] = "A theme with this name already exists!";
 $lang['threads'] = 'Threads';
+$lang['thumbnail'] = 'Thumbnail';
 $lang['tickercontents'] = "News In Newsticker:";
 $lang['tickername'] = "News &amp; Updates";
-$lang['tidnoexist'] = "Thread cannot be merged.  Thread ($othertid) does not exist";
 $lang['timemsg'] = "Processed in";
 $lang['timezone1'] = "(GMT -12:00) Eniwetok, Kwajalein";
 $lang['timezone10'] = "(GMT -3:30) Newfoundland";
@@ -1085,10 +1166,10 @@
 $lang['timezone8'] = "(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima, Quito";
 $lang['timezone9'] = "(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz, Santiago";
 $lang['tocont'] = "to continue.";
+$lang['todaydays'] = "days";
 $lang['todaygo'] = "Go!";
-$lang['todaydays'] = "days";
 $lang['todayshow'] = "Show thread activity from the past";
-$lang['too_few_pollopts'] = "You have put in too few poll-answers. The minimum amount is 2.";
+$lang['tools'] = 'Tools';
 $lang['tool_completed'] = "Tool Request Completed!";
 $lang['tool_forumtotal'] = 'Fixed Forum Totals';
 $lang['tool_lastpost'] = 'Fixed Last Posts';
@@ -1098,13 +1179,26 @@
 $lang['tool_threadtotal'] = 'Fixed Thread Totals';
 $lang['tool_u2u'] = 'U2Us Cleared';
 $lang['tool_whosonline'] = 'Whos Online Cleared';
-$lang['tools'] = 'Tools';
+$lang['too_few_pollopts'] = "You have put in too few poll-answers. The minimum amount is 2.";
 $lang['topmsgques'] = "Top this topic?";
 $lang['toppedpost'] = "This post is topped";
 $lang['toppedprefix'] = "pin.gif";
 $lang['topthreadmsg'] = "You have successfully topped/untopped the message you will now be taken back to the thread list";
 $lang['topuntop'] = "Top/Untop";
+$lang['translations'] = "Translations";
+$lang['translation_delete'] = "Translation(s) deleted.";
+$lang['translation_import'] = "Install New Language";
+$lang['translation_name'] = "Translation Name";
+$lang['translation_phrase'] = "Phrase Name";
+$lang['translation_select'] = "Please select a phrase...";
+$lang['translation_update'] = "Phrase text saved successfully.";
 $lang['u2uadmin_noperm'] = "You do not have permission to use this feature.";
+$lang['u2ualert1'] = "U2U Alert Feature";
+$lang['u2ualert2'] = "On Every Page";
+$lang['u2ualert3'] = "On Index Only";
+$lang['u2ualert4'] = "No Alert";
+$lang['u2ualert5'] = " unread U2U message. Would you like to view it now?";
+$lang['u2ualert6'] = " unread U2U messages. Would you like to view them now?";
 $lang['u2ublocked'] = "The would-be recipient of this U2U has blocked you, so you can't send this message.";
 $lang['u2udump'] = "Clear All U2Us";
 $lang['u2udump_confirm'] = 'Are you sure you want to Delete all u2u\'s?';
@@ -1122,6 +1216,7 @@
 $lang['uploadinstead'] = "&nbsp;Upload this file instead:";
 $lang['usercpeditpromsg'] = "You have successfully edited your profile. Taking you back to the user control panel.";
 $lang['userip'] = "Search for user with the following IP address";
+$lang['usernamechars'] = "Usernames may contain printable characters except []'&lt;&gt;\|&quot;,@";
 $lang['username_length_invalid'] = 'The length of the username you supplied is invalid. Please ensure it is a minimum of 3 characters and a maximum of 32 characters.';
 $lang['userprofilemood'] = "Current Mood:";
 $lang['verificationnote'] = "Please enter the text contained within the image into the textbox below it. This process is used to prevent automated bots.";
@@ -1148,9 +1243,10 @@
 $lang['whoodump_confirm'] = 'Are you sure you want to empty the whosonline?';
 $lang['whosoneval'] = '$lang["whosonmsg"] = "There are currently $guestn, $membern and $hiddenn browsing $bbname";';
 $lang['whosonline'] = "Who's Online";
+$lang['whosonlinetoday'] = "Who's Online Today";
 $lang['whosonline_on'] = "Who's online in index status:";
-$lang['whosonlinetoday'] = "Who's Online Today";
 $lang['whoview'] = "Who Can View This Forum?";
 $lang['xmb'] = "XMB";
+$lang['xmbforum'] = '<abbr title="eXtreme Message Board">XMB</abbr> Forum Software';
 $lang['xmbgroup'] = "The XMB Group";
-?>
\ No newline at end of file
+?>
Index: member.php
===================================================================
--- member.php	(revision 1746)
+++ member.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -61,29 +60,28 @@
         nav($lang['textcoppa']);
         break;
     default:
-        nav($lang['error']);
+        header('HTTP/1.0 404 Not Found');
+        error($lang['textnoaction']);
         break;
 }
 
 switch($action) {
     case 'coppa':
-        if (X_MEMBER) {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('misc_feature_not_while_loggedin').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit();
-        }
-
-        if ($SETTINGS['coppa'] != 'on') {
-            redirect('member.php?action=reg', 0);
-        }
-
-        if (onSubmit('coppasubmit')) {
-            redirect('member.php?action=reg', 0);
+        eval('$header = "'.template('header').'";');
+        if ($SETTINGS['regstatus'] == 'off') {
+            header('HTTP/1.0 403 Forbidden');
+            eval('$memberpage = "'.template('misc_feature_notavailable').'";');
+        } elseif (X_MEMBER) {
+            eval('$memberpage = "'.template('misc_feature_not_while_loggedin').'";');
         } else {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('member_coppa').'";');
+            if ($SETTINGS['coppa'] != 'on') {
+                redirect($full_url.'member.php?action=reg', 0);
+            }
+            if (onSubmit('coppasubmit')) {
+                redirect($full_url.'member.php?action=reg', 0);
+            } else {
+                eval('$memberpage = "'.template('member_coppa').'";');
+            }
         }
         break;
 
@@ -94,7 +92,7 @@
         }
 
         if ($SETTINGS['maxdayreg'] > 0) {
-            $time = $onlinetime - 86400; // take the date and distract 24 hours from it
+            $time = $onlinetime - 86400; // subtract 24 hours
             $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE regdate > $time");
             if ($db->result($query, 0) > $SETTINGS['maxdayreg']) {
                 error($lang['max_regs']);
@@ -102,27 +100,17 @@
             $db->free_result($query);
         }
 
+        eval('$header = "'.template('header').'";');
+
         if ($SETTINGS['regstatus'] == 'off') {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('misc_feature_notavailable').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit();
-        }
-
-        if (X_MEMBER) {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('misc_feature_not_while_loggedin').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit();
-        }
-
-        if (noSubmit('regsubmit')) {
-            eval('echo "'.template('header').'";');
+            header('HTTP/1.0 403 Forbidden');
+            eval('$memberpage = "'.template('misc_feature_notavailable').'";');
+        } elseif (X_MEMBER) {
+            eval('$memberpage = "'.template('misc_feature_not_while_loggedin').'";');
+        } elseif (noSubmit('regsubmit')) {
             if ($SETTINGS['bbrules'] == 'on' && noSubmit('rulesubmit')) {
                 $SETTINGS['bbrulestxt'] = nl2br($SETTINGS['bbrulestxt']);
-                eval('echo "'.template('member_reg_rules').'";');
+                eval('$memberpage = "'.template('member_reg_rules').'";');
             } else {
                 $currdate = gmdate($timecode, $onlinetime+ ($addtime * 3600));
                 eval($lang['evaloffset']);
@@ -138,7 +126,7 @@
                 $themelist = implode("\n", $themelist);
                 $db->free_result($query);
 
-                $langfileselect = createLangFileSelect($SETTINGS['langfile']);
+                $langfileselect = createLangFileSelect($langfile);
 
                 $dayselect = array();
                 $dayselect[] = '<select name="day">';
@@ -289,9 +277,9 @@
                 } else if ($SETTINGS['avastatus'] == 'list') {
                     $avatars = array();
                     $avatars[] = '<option value=""/>'.$lang['textnone'].'</option>';
-                    $dirHandle = opendir('./images/avatars');
+                    $dirHandle = opendir(ROOT.'images/avatars');
                     while($avFile = readdir($dirHandle)) {
-                        if (is_file('./images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..') {
+                        if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
                             $avatars[] = '<option value="./images/avatars/'.$avFile.'" />'.$avFile.'</option>';
                         }
                     }
@@ -315,24 +303,40 @@
                     $Captcha = new Captcha(250, 50);
                     if ($Captcha->bCompatible !== false) {
                         $imghash = $Captcha->GenerateCode();
+                        if ($SETTINGS['captcha_code_casesensitive'] == 'off') {
+                            $lang['captchacaseon'] = '';
+                        }
                         eval('$captcharegcheck = "'.template('member_reg_captcha').'";');
                     }
                 }
-                eval('echo "'.template('member_reg').'";');
+                eval('$memberpage = "'.template('member_reg').'";');
             }
         } else {
-            if ($_POST['username'] != preg_replace('#[\]\'\x00-\x1F\x7F<>\\\\|"[,@]#', '', $_POST['username'])) {
-                error($lang['restricted']);
-            }
+            $username = trim(postedVar('username', '', TRUE, FALSE));
 
-            $username = postedVar('username', '', TRUE, FALSE);
-
             if (strlen($username) < 3 || strlen($username) > 32) {
                 error($lang['username_length_invalid']);
             }
 
-            $username = postedVar('username');
+            $nonprinting = '\\x00-\\x1F\\x7F';  //Universal chars that are invalid.
+            $specials = '\\]\'<>\\\\|"[,@';  //Other universal chars disallowed by XMB: []'"<>\|,@
+            $icharset = strtoupper($charset);
+            if (substr($icharset, 0, 8) == 'ISO-8859') {
+                if ($icharset == 'ISO-8859-11') {
+                    $nonprinting .= '-\\x9F\\xDB-\\xDE\\xFC-\\xFF';  //More chars invalid for the Thai set.
+                } else {
+                    $nonprinting .= '-\\x9F\\xAD';  //More chars invalid for all ISO 8859 sets except Part 11 (Thai).
+                }
+            } elseif (substr($icharset, 0, 11) == 'WINDOWS-125') {
+                $nonprinting .= '\\xAD';  //More chars invalid for all Windows code pages.
+            }
+                        
+            if ($_POST['username'] != preg_replace("#[{$nonprinting}{$specials}]#", '', $_POST['username'])) {
+                error($lang['restricted']);
+            }
 
+            $username = trim(postedVar('username'));
+
             if ($SETTINGS['ipreg'] != 'off') {
                 $time = $onlinetime-86400;
                 $query = $db->query("SELECT uid FROM ".X_PREFIX."members WHERE regip='$onlineip' AND regdate >= $time");
@@ -356,6 +360,11 @@
                 $db->free_result($query);
                 error($lang['alreadyreg']);
             }
+            
+            $postcount = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE author='$username'"), 0);
+            if (intval($postcount) > 0) {
+                error($lang['alreadyreg']);
+            }
 
             if ($SETTINGS['emailcheck'] == 'on') {
                 $password = '';
@@ -366,7 +375,9 @@
                     $password .= $chars[mt_rand(0, $get)];
                 }
                 $password2 = $password;
-                } else {
+            } elseif (!isset($_POST['password']) Or !isset($_POST['password2'])) {
+                error($lang['textpw1']);
+            } else {
                 $password = $_POST['password'];
                 $password2 = $_POST['password2'];
             }
@@ -381,7 +392,7 @@
             while($restriction = $db->fetch_array($query)) {
                 $t_username = $username;
                 $t_email = $email;
-                if ($restriction['case_sensitivity'] == 1) {
+                if ($restriction['case_sensitivity'] == 0) {
                     $t_username = strtolower($t_username);
                     $t_email = strtolower($t_email);
                     $restriction['name'] = strtolower($restriction['name']);
@@ -415,7 +426,10 @@
                 error($lang['emailrestricted']);
             }
 
-            if (false === strpos($email, "@")) {
+            require ROOT.'include/validate-email.inc.php';
+            $test = new EmailAddressValidator();
+            $rawemail = postedVar('email', '', FALSE, FALSE);
+            if (false === $test->check_email_address($rawemail)) {
                 error($lang['bademail']);
             }
 
@@ -439,14 +453,11 @@
                 }
             }
 
-            $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
-            $langfilenew = getLangFileNameFromHash($langfilenew);
-            if ($langfilenew === FALSE) {
+            $langfilenew = postedVar('langfilenew');
+            $result = $db->query("SELECT devname FROM ".X_PREFIX."lang_base WHERE devname='$langfilenew'");
+            if ($db->num_rows($result) == 0) {
                 $langfilenew = $SETTINGS['langfile'];
-            } else {
-                $langfilenew = basename($langfilenew);
             }
-            $langfilenew = $db->escape($langfilenew);
 
             $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members");
             $count1 = $db->result($query,0);
@@ -463,6 +474,7 @@
             $saveogu2u = formYesNo('saveogu2u');
             $emailonu2u = formYesNo('emailonu2u');
             $useoldu2u = formYesNo('useoldu2u');
+            $u2ualert = formInt('u2ualert');
             $year = formInt('year');
             $month = formInt('month');
             $day = formInt('day');
@@ -483,10 +495,8 @@
             $password = md5($password);
 
             if ($SETTINGS['regoptional'] == 'off') {
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u, u2ualert) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u', $u2ualert)");
             } else {
-                $avatar = postedVar('avatar', 'javascript', TRUE, TRUE, TRUE);
-                $avatarcheck = postedVar('newavatarcheck');
                 $location = postedVar('location', 'javascript', TRUE, TRUE, TRUE);
                 $icq = postedVar('icq', '', FALSE, FALSE);
                 $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
@@ -498,248 +508,314 @@
                 $mood = postedVar('mood', 'javascript', TRUE, TRUE, TRUE);
                 $sig = postedVar('sig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-                $max_size = explode('x', $SETTINGS['max_avatar_size']);
-                if (ini_get('allow_url_fopen')) {
-                    if ($max_size[0] > 0 && $max_size[1] > 0) {
-                        $size = @getimagesize($_POST['avatar']);
-                        if ($size === false) {
-                            $avatar = '';
-                        } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
-                            error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                if ($SETTINGS['avastatus'] == 'on') {
+                    $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+                    $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+
+                    $newavatarcheck = postedVar('newavatarcheck');
+
+                    $max_size = explode('x', $SETTINGS['max_avatar_size']);
+
+                    if (preg_match('#^(http|ftp)://[:a-z\\./_\-0-9%~]+(\?[a-z=0-9&_\-;~]*)?$#Smi', $rawavatar) == 0) {
+                        $avatar = '';
+                    } elseif (ini_get('allow_url_fopen')) {
+                        if ($max_size[0] > 0 And $max_size[1] > 0 And strlen($rawavatar) > 0) {
+                            $size = @getimagesize($rawavatar);
+                            if ($size === FALSE) {
+                                $avatar = '';
+                            } elseif (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
+                                error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                            }
                         }
+                    } elseif ($newavatarcheck == "no") {
+                        $avatar = '';
                     }
-                } else if ($newavatarcheck == "no") {
+                    unset($rawavatar);
+                } elseif ($SETTINGS['avastatus'] == 'list') {
+                    $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+                    $dirHandle = opendir(ROOT.'images/avatars');
+                    $filefound = FALSE;
+                    while($avFile = readdir($dirHandle)) {
+                        if ($rawavatar == './images/avatars/'.$avFile) {
+                            if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
+                                $filefound = TRUE;
+                            }
+                        }
+                    }
+                    closedir($dirHandle);
+                    unset($rawavatar);
+                    if ($filefound) {
+                        $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+                    } else {
+                        $avatar = '';
+                    }
+                } else {
                     $avatar = '';
                 }
 
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]', '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u, u2ualert) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]', '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u', $u2ualert)");
             }
 
+            $lang2 = loadPhrases(array('charset','textnewmember','textnewmember2','textyourpw','textyourpwis','textusername','textpassword'));
+
             if ($SETTINGS['notifyonreg'] != 'off') {
-                if ($SETTINGS['notifyonreg'] == 'u2u') {
-                    $mailquery = $db->query("SELECT username FROM ".X_PREFIX."members WHERE status='Super Administrator'");
-                    while($admin = $db->fetch_array($mailquery)) {
-                        $db->query("INSERT INTO ".X_PREFIX."u2u (u2uid, msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('', '$admin[username]', '".addslashes($bbname)."', 'incoming', '$admin[username]', 'Inbox', '$lang[textnewmember]', '$lang[textnewmember2]', '".$onlinetime."', 'no', 'yes')");
-                    }
-                    $db->free_result($mailquery);
-                } else {
-                    $headers[] = "From: $bbname <$SETTINGS[adminemail]>";
-                    $headers[] = "X-Sender: <$SETTINGS[adminemail]>";
-                    $headers[] = 'X-Mailer: PHP';
-                    $headers[] = 'X-AntiAbuse: Board servername - '.$SETTINGS['bbname'];
-                    $headers[] = 'X-AntiAbuse: Username - '.$xmbuser;
-                    $headers[] = 'X-Priority: 2';
-                    $headers[] = "Return-Path: <$SETTINGS[adminemail]>";
-                    $headers[] = 'Content-Type: text/plain; charset=ASCII';
-                    $headers = implode("\r\n", $headers);
+                $mailquery = $db->query("SELECT username, email, langfile FROM ".X_PREFIX."members WHERE status = 'Super Administrator'");
+                while($admin = $db->fetch_array($mailquery)) {
+                    $translate = $lang2[$admin['langfile']];
+                    if ($SETTINGS['notifyonreg'] == 'u2u') {
+                        $db->query("INSERT INTO ".X_PREFIX."u2u (u2uid, msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('', '$admin[username]', '".$db->escape_var($bbname)."', 'incoming', '$admin[username]', 'Inbox', '$translate[textnewmember]', '$translate[textnewmember2]', '".$onlinetime."', 'no', 'yes')");
+                    } else {
+                        $rawuser = postedVar('username', '', FALSE, FALSE);
+                        $headers = array();
+                        $headers[] = "From: $bbname <$adminemail>";
+                        $headers[] = 'X-Mailer: PHP';
+                        $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+                        $headers[] = 'X-AntiAbuse: Username - '.$rawuser;
+                        $headers[] = 'Content-Type: text/plain; charset='.$translate['charset'];
+                        $headers = implode("\r\n", $headers);
 
-                    $mailquery = $db->query("SELECT email FROM ".X_PREFIX."members WHERE status = 'Super Administrator'");
-                    while($notify = $db->fetch_array($mailquery)) {
-                        altMail($notify['email'], $lang['textnewmember'], $lang['textnewmember2'], $headers);
+                        $adminemail = htmlspecialchars_decode($admin['email'], ENT_QUOTES);
+                        altMail($adminemail, $translate['textnewmember'], $translate['textnewmember2']."\n\n$full_url", $headers);
                     }
-                    $db->free_result($mailquery);
                 }
+                $db->free_result($mailquery);
             }
 
             if ($SETTINGS['emailcheck'] == 'on') {
-                $username = $_POST['username'];
-                altMail($email, '['.$bbname.'] '.$lang['textyourpw'], "{$lang['textyourpwis']} \n\n{$lang['textusername']} $username\n{$lang['textpassword']} $password2", "From: $bbname <$adminemail>");
+                $translate = $lang2[$langfilenew];
+                $username = trim(postedVar('username', '', FALSE, FALSE));
+                $headers = array();
+                $headers[] = "From: $bbname <$adminemail>";
+                $headers[] = 'X-Mailer: PHP';
+                $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+                $headers[] = 'X-AntiAbuse: Username - '.$username;
+                $headers[] = 'Content-Type: text/plain; charset='.$translate['charset'];
+                $headers = implode("\r\n", $headers);
+                altMail($rawemail, '['.$bbname.'] '.$translate['textyourpw'], "{$translate['textyourpwis']} \n\n{$translate['textusername']} $username\n{$translate['textpassword']} $password2\n\n$full_url", $headers);
             } else {
-                $username = postedVar('username', '', TRUE, FALSE);
+                $username = trim(postedVar('username', '', TRUE, FALSE));
                 $currtime = $onlinetime + (86400*30);
                 put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
                 put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
             }
-            eval('echo "'.template('header').'";');
-            echo ($SETTINGS['emailcheck'] == 'on') ? "<center><span class=\"mediumtxt \">$lang[emailpw]</span></center>" : "<center><span class=\"mediumtxt \">$lang[regged]</span></center>";
+            $memberpage = ($SETTINGS['emailcheck'] == 'on') ? "<center><span class=\"mediumtxt \">$lang[emailpw]</span></center>" : "<center><span class=\"mediumtxt \">$lang[regged]</span></center>";
 
-            redirect('index.php', 2, X_REDIRECT_JS);
+            redirect($full_url, 2, X_REDIRECT_JS);
         }
         break;
 
     case 'viewpro':
+        $member = postedVar('member', '', TRUE, FALSE, FALSE, 'g');
+        if (strlen($member) < 3 || strlen($member) > 32) {
+            header('HTTP/1.0 404 Not Found');
+            error($lang['nomember']);
+        }
+
         $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
-        if ($member == '') {
+
+        $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$member'");
+        if ($db->num_rows($query) != 1) {
+            header('HTTP/1.0 404 Not Found');
             error($lang['nomember']);
+        }
+        $memberinfo = $db->fetch_array($query);
+        $memberinfo['password'] = '';
+        $db->free_result($query);
+
+        if ($memberinfo['status'] == 'Banned') {
+            $memberinfo['avatar'] = '';
+            $rank = array(
+            'title' => 'Banned',
+            'posts' => 0,
+            'id' => 0,
+            'stars' => 0,
+            'allowavatars' => 'no',
+            'avatarrank' => ''
+            );
         } else {
-            $memberinfo = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$member'"));
             if ($memberinfo['status'] == 'Administrator' || $memberinfo['status'] == 'Super Administrator' || $memberinfo['status'] == 'Super Moderator' || $memberinfo['status'] == 'Moderator') {
                 $limit = "title = '$memberinfo[status]'";
             } else {
-                $limit = "posts <= '$memberinfo[postnum]' AND title != 'Super Administrator' AND title != 'Administrator' AND title != 'Super Moderator' AND title != 'Super Moderator' AND title != 'Moderator'";
+                $limit = "posts <= '$memberinfo[postnum]' AND title != 'Super Administrator' AND title != 'Administrator' AND title != 'Super Moderator' AND title != 'Moderator'";
             }
 
             $rank = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."ranks WHERE $limit ORDER BY posts DESC LIMIT 1"));
+        }
 
-            if ($memberinfo['uid'] == '') {
-                error($lang['nomember']);
-            } else {
-                eval('echo "'.template('header').'";');
+        eval('$header = "'.template('header').'";');
+        
+        $encodeuser = recodeOut($memberinfo['username']);
+        if (X_GUEST) {
+            $memberlinks = '';
+        } else {
+            $memberlinks = " <small>(<a href=\"u2u.php?action=send&amp;username=$encodeuser\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">{$lang['textu2u']}</a>)&nbsp;&nbsp;(<a href=\"buddy.php?action=add&amp;buddys=$encodeuser\" onclick=\"Popup(this.href, 'Window', 450, 400); return false;\">{$lang['addtobuddies']}</a>)</small>";
+        }
 
-                $daysreg = ($onlinetime - $memberinfo['regdate']) / (24*3600);
-                if ($daysreg > 1) {
-                    $ppd = $memberinfo['postnum'] / $daysreg;
-                    $ppd = round($ppd, 2);
-                } else {
-                    $ppd = $memberinfo['postnum'];
-                }
+        $daysreg = ($onlinetime - $memberinfo['regdate']) / (24*3600);
+        if ($daysreg > 1) {
+            $ppd = $memberinfo['postnum'] / $daysreg;
+            $ppd = round($ppd, 2);
+        } else {
+            $ppd = $memberinfo['postnum'];
+        }
 
-                $memberinfo['regdate'] = gmdate($dateformat , $memberinfo['regdate'] + ($addtime * 3600) + ($timeoffset * 3600));
+        $memberinfo['regdate'] = gmdate($dateformat , $memberinfo['regdate'] + ($addtime * 3600) + ($timeoffset * 3600));
 
-                if (strpos($memberinfo['site'], 'http') === false) {
-                    $memberinfo['site'] = "http://$memberinfo[site]";
-                }
+        if (strpos($memberinfo['site'], 'http') === false) {
+            $memberinfo['site'] = "http://$memberinfo[site]";
+        }
 
-                if ($memberinfo['site'] != 'http://') {
-                    $site = $memberinfo['site'];
-                } else {
-                    $site = '';
-                }
+        if ($memberinfo['site'] != 'http://') {
+            $site = $memberinfo['site'];
+        } else {
+            $site = '';
+        }
 
-                if (X_MEMBER && $memberinfo['email'] != '' && $memberinfo['showemail'] == 'yes') {
-                    $email = $memberinfo['email'];
-                } else {
-                    $email = '';
-                }
+        if (X_MEMBER && $memberinfo['email'] != '' && $memberinfo['showemail'] == 'yes') {
+            $email = $memberinfo['email'];
+        } else {
+            $email = '';
+        }
 
-                $rank['avatarrank'] = trim($rank['avatarrank']);
-                $memberinfo['avatar'] = trim($memberinfo['avatar']);
+        $rank['avatarrank'] = trim($rank['avatarrank']);
+        $memberinfo['avatar'] = trim($memberinfo['avatar']);
 
-                if ($rank['avatarrank'] != '') {
-                    $rank['avatarrank'] = '<img src="'.$rank['avatarrank'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                }
+        if ($rank['avatarrank'] != '') {
+            $rank['avatarrank'] = '<img src="'.$rank['avatarrank'].'" alt="'.$lang['altavatar'].'" border="0" />';
+        }
+        
+        if ($memberinfo['avatar'] != '') {
+            $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
+        }
 
-                if ($memberinfo['avatar'] != '') {
-                    $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                }
+        if ($rank['avatarrank'] || $memberinfo['avatar']) {
+            if (isset($site) && strlen(trim($site)) > 0) {
+                $sitelink = $site;
+            } else {
+                $sitelink = "about:blank";
+            }
+        } else {
+            $sitelink = "about:blank";
+        }
 
-                if ($rank['avatarrank'] || $memberinfo['avatar']) {
-                    if (isset($site) && strlen(trim($site)) > 0) {
-                        $sitelink = $site;
-                    } else {
-                        $sitelink = "about:blank";
-                    }
-                } else {
-                    $sitelink = "about:blank";
-                }
+        $showtitle = $rank['title'];
+        $stars = str_repeat('<img src="'.$imgdir.'/star.gif" alt="*" border="0" />', $rank['stars']);
 
-                $showtitle = $rank['title'];
-                $stars = str_repeat('<img src="'.$imgdir.'/star.gif" alt="*" border="0" />', $rank['stars']);
+        if ($memberinfo['customstatus'] != '') {
+            $showtitle = $rank['title'];
+            $customstatus = '<br />'.censor($memberinfo['customstatus']);
+        } else {
+            $showtitle = $rank['title'];
+            $customstatus = '';
+        }
 
-                if ($memberinfo['customstatus'] != '') {
-                    $showtitle = $rank['title'];
-                    $customstatus = '<br />'.censor($memberinfo['customstatus']);
-                } else {
-                    $showtitle = $rank['title'];
-                    $customstatus = '';
-                }
+        if (!($memberinfo['lastvisit'] > 0)) {
+            $lastmembervisittext = $lang['textpendinglogin'];
+        } else {
+            $lastvisitdate = gmdate($dateformat, $memberinfo['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
+            $lastvisittime = gmdate($timecode, $memberinfo['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
+            $lastmembervisittext = $lastvisitdate.' '.$lang['textat'].' '.$lastvisittime;
+        }
 
-                if (!($memberinfo['lastvisit'] > 0)) {
-                    $lastmembervisittext = $lang['textpendinglogin'];
-                } else {
-                    $lastvisitdate = gmdate($dateformat, $memberinfo['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
-                    $lastvisittime = gmdate($timecode, $memberinfo['lastvisit'] + ($timeoffset * 3600) + ($addtime * 3600));
-                    $lastmembervisittext = $lastvisitdate.' '.$lang['textat'].' '.$lastvisittime;
-                }
+        $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts");
+        $posts = $db->result($query, 0);
+        $db->free_result($query);
 
-                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts");
-                $posts = $db->result($query, 0);
-                $db->free_result($query);
+        $posttot = $posts;
+        if ($posttot == 0) {
+            $percent = '0';
+        } else {
+            $percent = $memberinfo['postnum']*100/$posttot;
+            $percent = round($percent, 2);
+        }
 
-                $posttot = $posts;
-                if ($posttot == 0) {
-                    $percent = '0';
-                } else {
-                    $percent = $memberinfo['postnum']*100/$posttot;
-                    $percent = round($percent, 2);
-                }
+        $memberinfo['bio'] = censor($memberinfo['bio']);
+        $memberinfo['bio'] = nl2br($memberinfo['bio']);
 
-                $memberinfo['bio'] = censor($memberinfo['bio']);
-                $memberinfo['bio'] = nl2br($memberinfo['bio']);
-                $encodeuser = recodeOut($memberinfo['username']);
+        $emailblock = '';
+        if ($memberinfo['showemail'] == 'yes') {
+            eval('$emailblock = "'.template('member_profile_email').'";');
+        }
 
-                $emailblock = '';
-                if ($memberinfo['showemail'] == 'yes') {
-                    eval('$emailblock = "'.template('member_profile_email').'";');
-                }
+        if (X_SADMIN) {
+            $admin_edit = "<br />$lang[adminoption] <a href=\"./editprofile.php?user=$encodeuser\">$lang[admin_edituseraccount]</a>";
+        } else {
+            $admin_edit = NULL;
+        }
 
-                if (X_SADMIN) {
-                    $admin_edit = "<br />$lang[adminoption] <a href=\"./editprofile.php?user=$encodeuser\">$lang[admin_edituseraccount]</a>";
-                } else {
-                    $admin_edit = NULL;
-                }
+        if ($memberinfo['mood'] != '') {
+            $memberinfo['mood'] = postify($memberinfo['mood'], 'no', 'no', 'yes', 'no', 'yes', 'no', true, 'yes');
+        } else {
+            $memberinfo['mood'] = '';
+        }
 
-                if ($memberinfo['mood'] != '') {
-                    $memberinfo['mood'] = postify($memberinfo['mood'], 'no', 'no', 'yes', 'no', 'yes', 'no', true, 'yes');
-                } else {
-                    $memberinfo['mood'] = '';
-                }
+        $memberinfo['location'] = censor($memberinfo['location']);
+        $memberinfo['aim'] = censor($memberinfo['aim']);
+        $memberinfo['aimrecode'] = recodeOut($memberinfo['aim']);
+        $memberinfo['icq'] = ($memberinfo['icq'] > 0) ? $memberinfo['icq'] : '';
+        $memberinfo['yahoo'] = censor($memberinfo['yahoo']);
+        $memberinfo['yahoorecode'] = recodeOut($memberinfo['yahoo']);
+        $memberinfo['msn'] = censor($memberinfo['msn']);
+        $memberinfo['msnrecode'] = recodeOut($memberinfo['msn']);
 
-                $memberinfo['location'] = censor($memberinfo['location']);
-                $memberinfo['aim'] = censor($memberinfo['aim']);
-                $memberinfo['aimrecode'] = recodeOut($memberinfo['aim']);
-                $memberinfo['icq'] = ($memberinfo['icq'] > 0) ? $memberinfo['icq'] : '';
-                $memberinfo['yahoo'] = censor($memberinfo['yahoo']);
-                $memberinfo['yahoorecode'] = recodeOut($memberinfo['yahoo']);
-                $memberinfo['msn'] = censor($memberinfo['msn']);
-                $memberinfo['msnrecode'] = recodeOut($memberinfo['msn']);
+        if ($memberinfo['bday'] === iso8601_date(0,0,0)) {
+            $memberinfo['bday'] = $lang['textnone'];
+        } else {
+            $memberinfo['bday'] = gmdate($dateformat, gmmktime(12,0,0,substr($memberinfo['bday'],5,2),substr($memberinfo['bday'],8,2),substr($memberinfo['bday'],0,4)));
+        }
 
-                if ($memberinfo['bday'] === iso8601_date(0,0,0)) {
-                    $memberinfo['bday'] = $lang['textnone'];
-                } else {
-                    $memberinfo['bday'] = gmdate($dateformat, gmmktime(12,0,0,substr($memberinfo['bday'],5,2),substr($memberinfo['bday'],8,2),substr($memberinfo['bday'],0,4)));
-                }
+        // Forum most active in
+        $found = false;
+        $query = $db->query("SELECT f.userlist, f.password, f.postperm, f.moderator, f.name, p.fid, COUNT(DISTINCT p.pid) as posts FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f ON p.fid=f.fid WHERE p.author='$member' AND f.status='on' GROUP BY p.fid ORDER BY posts DESC");
+        while($f = $db->fetch_array($query)) {
+            $pp = checkForumPermissions($f);
+            if ($pp[X_PERMS_VIEW] && $pp[X_PERMS_PASSWORD]) {
+                $forum = $f;
+                $found = true;
+                break;
+            }
+        }
 
-                // Forum most active in
-                $found = false;
-                $query = $db->query("SELECT f.userlist, f.password, f.postperm, f.name, p.fid, COUNT(DISTINCT p.pid) as posts FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f ON p.fid=f.fid WHERE p.author='$member' AND f.status='on' GROUP BY p.fid ORDER BY posts DESC");
-                while($f = $db->fetch_array($query)) {
-                    $pp = checkForumPermissions($f);
-                    if ($pp[X_PERMS_VIEW] && $pp[X_PERMS_USERLIST] && $pp[X_PERMS_PASSWORD]) {
-                        $forum = $f;
-                        $found = true;
-                        break;
-                    }
-                }
+        if (!$found || $forum['posts'] < 1) {
+            $topforum = $lang['textnopostsyet'];
+        } else if ($memberinfo['postnum'] <= 0) {
+            $topforum = $lang['textnopostsyet'];
+        } else {
+            $topforum = "<a href=\"./forumdisplay.php?fid=$forum[fid]\">".fnameOut($forum['name'])."</a> ($forum[posts] $lang[memposts]) [".round(($forum['posts']/$memberinfo['postnum'])*100, 1)."% $lang[textoftotposts]]";
+        }
 
-                if (!$found || $forum['posts'] < 1) {
-                    $topforum = $lang['textnopostsyet'];
-                } else if ($memberinfo['postnum'] <= 0) {
-                    $topforum = $lang['textnopostsyet'];
-                } else {
-                    $topforum = "<a href=\"./forumdisplay.php?fid=$forum[fid]\">$forum[name]</a> ($forum[posts] $lang[memposts]) [".round(($forum['posts']/$memberinfo['postnum'])*100, 1)."% $lang[textoftotposts]]";
-                }
+        // Last post
+        $lpfound = false;
+        $pq = $db->query("SELECT t.tid, t.subject, p.dateline, p.pid, f.fid, f.postperm, f.password, f.userlist, f.moderator FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE p.fid=f.fid AND p.author='$memberinfo[username]' AND p.tid=t.tid AND f.status='on' ORDER BY p.dateline DESC");
+        while($post = $db->fetch_array($pq)) {
+            $pp = checkForumPermissions($post);
+            if (!($pp[X_PERMS_VIEW] && $pp[X_PERMS_PASSWORD])) {
+                continue;
+            }
+            $lpfound = true;
+            $posts = $db->result($db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid='$post[tid]' AND pid < '$post[pid]'"), 0)+1; // +1 is faster than doing <= !
+            validatePpp();
 
-                // Last post
-                $lpfound = false;
-                $pq = $db->query("SELECT t.tid, t.subject, p.dateline, p.pid, f.fid, f.postperm, f.password, f.userlist FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE p.fid=f.fid AND p.author='$memberinfo[username]' AND p.tid=t.tid AND f.status='on' ORDER BY p.dateline DESC");
-                while($post = $db->fetch_array($pq)) {
-                    $pp = checkForumPermissions($post);
-                    if (!($pp[X_PERMS_VIEW] && $pp[X_PERMS_USERLIST] && $pp[X_PERMS_PASSWORD])) {
-                        continue;
-                    }
-                    $lpfound = true;
-                    $posts = $db->result($db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid='$post[tid]' AND pid < '$post[pid]'"), 0)+1; // +1 is faster than doing <= !
-                    validatePpp();
+            $page = quickpage($posts, $ppp);
 
-                    $page = quickpage($posts, $ppp);
+            $lastpostdate = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
+            $lastposttime = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
 
-                    $lastpostdate = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
-                    $lastposttime = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600));
+            $lastposttext = $lastpostdate.' '.$lang['textat'].' '.$lastposttime;
+            $post['subject'] = rawHTMLsubject(stripslashes($post['subject']));
+            $lastpost = "<a href=\"./viewthread.php?tid=$post[tid]&amp;page=$page#pid$post[pid]\">$post[subject]</a> ($lastposttext)";
+            break;
+        }
+        if (!$lpfound) {
+            $lastpost = $lang['textnopostsyet'];
+        }
 
-                    $lastposttext = $lastpostdate.' '.$lang['textat'].' '.$lastposttime;
-                    $post['subject'] = rawHTMLsubject(stripslashes($post['subject']));
-                    $lastpost = "<a href=\"./viewthread.php?tid=$post[tid]&amp;page=$page#pid$post[pid]\">$post[subject]</a> ($lastposttext)";
-                    break;
-                }
-                if (!$lpfound) {
-                    $lastpost = $lang['textnopostsyet'];
-                }
-
-                $lang['searchusermsg'] = str_replace('*USER*', recodeOut($memberinfo['username']), $lang['searchusermsg']);
-                eval('echo "'.template('member_profile').'";');
-            }
+        if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_search_status'] == 'on' && !DEBUG) {
+            $lang['searchusermsg'] = '';
+        } else {
+            $lang['searchusermsg'] = str_replace('*USER*', recodeOut($memberinfo['username']), $lang['searchusermsg']);
         }
+        eval('$memberpage = "'.template('member_profile').'";');
         break;
 
     default:
@@ -748,5 +824,6 @@
 }
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$memberpage.$footer;
+?>
Index: memcp.php
===================================================================
--- memcp.php	(revision 1746)
+++ memcp.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
- * eXtreme MessageBoard
- * XMB 1.9.10 Karl
+ * eXtreme Message Board
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -30,6 +29,8 @@
 
 require 'header.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates(
 'buddylist_buddy_offline',
 'buddylist_buddy_online',
@@ -47,6 +48,7 @@
 'memcp_profile_avatarurl',
 'memcp_subscriptions',
 'memcp_subscriptions_button',
+'memcp_subscriptions_multipage',
 'memcp_subscriptions_none',
 'memcp_subscriptions_row'
 );
@@ -55,7 +57,11 @@
 
 eval('$css = "'.template('css').'";');
 
-$favs = $buddys = NULL;
+$buddys = array();
+$favs = '';
+$footer = '';
+$header = '';
+$mempage = '';
 
 $action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
@@ -77,57 +83,59 @@
 }
 
 function makenav($current) {
-    global $THEME, $bordercolor, $tablewidth, $tablespacing, $altbg1, $altbg2, $lang;
-    ?>
-    <table cellpadding="0" cellspacing="0" border="0" bgcolor="<?php echo $bordercolor?>" width="<?php echo $tablewidth?>" align="center"><tr><td>
-    <table cellpadding="4" cellspacing="<?php echo $THEME['borderwidth']?>" border="0" width="100%">
-    <tr align="center" class="tablerow">
-    <?php
+    global $THEME, $bordercolor, $tablewidth, $altbg1, $altbg2, $lang;
+    
+    $output =
+      '<table cellpadding="0" cellspacing="0" border="0" bgcolor="'.$bordercolor.'" width="'.$tablewidth.'" align="center"><tr><td>
+      <table cellpadding="4" cellspacing="'.$THEME['borderwidth'].'" border="0" width="100%">
+      <tr align="center" class="tablerow">';
+
     if ($current == '') {
-        echo "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textmyhome']. "</td>";
+        $output .= "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textmyhome']. "</td>";
     } else {
-        echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php\">" .$lang['textmyhome']. "</a></td>";
+        $output .= "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php\">" .$lang['textmyhome']. "</a></td>";
     }
 
     if ($current == 'profile') {
-        echo "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['texteditpro']. "</td>";
+        $output .= "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['texteditpro']. "</td>";
     } else {
-        echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=profile\">" .$lang['texteditpro']. "</a></td>";
+        $output .= "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=profile\">" .$lang['texteditpro']. "</a></td>";
     }
 
     if ($current == 'subscriptions') {
-        echo "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textsubscriptions']. "</td>";
+        $output .= "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textsubscriptions']. "</td>";
     } else {
-        echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=subscriptions\">" .$lang['textsubscriptions']. "</a></td>";
+        $output .= "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=subscriptions\">" .$lang['textsubscriptions']. "</a></td>";
     }
 
     if ($current == 'favorites') {
-        echo "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textfavorites']. "</td>";
+        $output .= "<td bgcolor=\"$altbg1\" width=\"15%\" class=\"ctrtablerow\">" .$lang['textfavorites']. "</td>";
     } else {
-        echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=favorites\">" .$lang['textfavorites']. "</a></td>";
+        $output .= "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"memcp.php?action=favorites\">" .$lang['textfavorites']. "</a></td>";
     }
 
-    echo "<td bgcolor=\"$altbg2\" width=\"20%\" class=\"ctrtablerow\"><a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">" .$lang['textu2umessenger']. "</a></td>";
-    echo "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"buddy.php\" onclick=\"Popup(this.href, 'Window', 450, 400); return false;\">" .$lang['textbuddylist']. "</a></td>";
-    echo "<td bgcolor=\"$altbg2\" width=\"10%\" class=\"ctrtablerow\"><a href=\"faq.php\">" .$lang['helpbar']. "</a></td>";
-    ?>
-    </tr>
-    </table>
-    </td>
-    </tr>
-    </table>
-    <br />
-    <?php
+    $output .= "<td bgcolor=\"$altbg2\" width=\"20%\" class=\"ctrtablerow\"><a href=\"u2u.php\" onclick=\"Popup(this.href, 'Window', 700, 450); return false;\">" .$lang['textu2umessenger']. "</a></td>";
+    $output .= "<td bgcolor=\"$altbg2\" width=\"15%\" class=\"ctrtablerow\"><a href=\"buddy.php\" onclick=\"Popup(this.href, 'Window', 450, 400); return false;\">" .$lang['textbuddylist']. "</a></td>";
+    $output .= "<td bgcolor=\"$altbg2\" width=\"10%\" class=\"ctrtablerow\"><a href=\"faq.php\">" .$lang['helpbar']. "</a></td>";
+    $output .=
+      '</tr>
+      </table>
+      </td>
+      </tr>
+      </table>
+      <br />';
+      
+    return $output;
 }
 
 if (X_GUEST) {
-    redirect('misc.php?action=login', 0);
+    redirect($full_url.'misc.php?action=login', 0);
     exit();
 }
 
 if ($action == 'profile') {
-    eval('echo "'.template('header').'";');
-    makenav($action);
+    eval('$header = "'.template('header').'";');
+    $header .= makenav($action);
 
     if (noSubmit('editsubmit')) {
         $member = $self;
@@ -274,6 +282,20 @@
                 break;
         }
 
+        $u2uasel0 = $u2uasel1 = $u2uasel2 = '';
+        switch($member['u2ualert']) {
+            case 2:
+                $u2uasel2 = $selHTML;
+                break;
+            case 1:
+                $u2uasel1 = $selHTML;
+                break;
+            case 0:
+            default:
+                $u2uasel0 = $selHTML;
+                break;
+        }
+
         $themelist = array();
         $themelist[] = '<select name="thememem">';
         $themelist[] = '<option value="0">'.$lang['textusedefault'].'</option>';
@@ -340,9 +362,9 @@
         if ($SETTINGS['avastatus'] == 'list')  {
             $avatars = '<option value="" />'.$lang['textnone'].'</option>';
             $dir1 = opendir(ROOT.'images/avatars');
-            while($avatar1 = readdir($dir1)) {
-                if (is_file(ROOT.'images/avatars/'.$avatar1)) {
-                    $avatars .= '<option value="'.ROOT.'images/avatars/'.$avatar1.'" />'.$avatar1.'</option>';
+            while($avFile = readdir($dir1)) {
+                if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
+                    $avatars .= '<option value="./images/avatars/'.$avFile.'" />'.$avFile.'</option>';
                 }
             }
             $avatars = str_replace('value="'.$member['avatar'].'"', 'value="'.$member['avatar'].'" selected="selected"', $avatars);
@@ -352,43 +374,44 @@
         }
 
         $member['icq'] = ($member['icq'] > 0) ? $member['icq'] : '';
-        eval('echo "'.template('memcp_profile').'";');
+        eval('$mempage = "'.template('memcp_profile').'";');
     }
 
     if (onSubmit('editsubmit')) {
-        $newemail = postedVar('newemail', '', FALSE, FALSE);
-        if ($newemail && (!$newemail || isset($_GET['newemail']))) {
-            $auditaction = $_SERVER['REQUEST_URI'];
-            $aapos = strpos($auditaction, "?");
-            if ($aapos !== false) {
-                $auditaction = substr($auditaction, $aapos + 1);
+        if ($_POST['newpassword'] != '' || $_POST['newpasswordcf'] != '') {
+            if (!isset($_POST['oldpassword'])) {
+                error($lang['textpwincorrect']);
             }
-            $auditaction = addslashes("$onlineip|#|$auditaction");
-            audit($xmbuser, $auditaction, 0, 0, "Potential XSS exploit using newemail");
-            die("Hack atttempt recorded in audit logs.");
-        }
+            if (!elevateUser($xmbuser, md5($_POST['oldpassword']))) {
+                error($lang['textpwincorrect']);
+            }
+            if ($_POST['newpassword'] != $_POST['newpasswordcf']) {
+                error($lang['pwnomatch']);
+            }
 
-        $newpassword = postedVar('newpassword', '', FALSE, FALSE);
-        $newpasswordcf = postedVar('newpasswordcf', '', FALSE, FALSE);
-        if ($newpassword && (!$newpassword || isset($_GET['newpassword']))) {
-            $auditaction = $_SERVER['REQUEST_URI'];
-            $aapos = strpos($auditaction, "?");
-            if ($aapos !== false) {
-                $auditaction = substr($auditaction, $aapos + 1);
+            $newpassword = md5($_POST['newpassword']);
+
+            $pwtxt = "password='$newpassword',";
+
+            $query = $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE username='$xmbuser'");
+
+            put_cookie("xmbuser", '', 0, $cookiepath, $cookiedomain);
+            put_cookie("xmbpw", '', 0, $cookiepath, $cookiedomain);
+
+            foreach($_COOKIE as $key=>$val) {
+                if (preg_match('#^fidpw([0-9]+)$#', $key)) {
+                    put_cookie($key, '', 0, $cookiepath, $cookiedomain);
+                }
             }
-            $auditaction = addslashes("$onlineip|#|$auditaction");
-            audit($xmbuser, $auditaction, 0, 0, "Potential XSS exploit using newpassword");
-            die("Hack atttempt recorded in audit logs.");
+        } else {
+            $pwtxt = '';
         }
 
-        $langfilenew = postedVar('langfilenew', '', FALSE, FALSE);
-        $fileNameHash = getLangFileNameFromHash($langfilenew);
-        if ($fileNameHash === false) {
+        $langfilenew = postedVar('langfilenew');
+        $result = $db->query("SELECT devname FROM ".X_PREFIX."lang_base WHERE devname='$langfilenew'");
+        if ($db->num_rows($result) == 0) {
             $langfilenew = $SETTINGS['langfile'];
-        } else {
-            $langfilenew = basename($fileNameHash);
         }
-        $langfilenew = $db->escape($langfilenew);
 
         $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
         $thememem = formInt('thememem');
@@ -413,12 +436,11 @@
         $invisible = formInt('newinv');
         $showemail = formYesNo('newshowemail');
         $newsletter = formYesNo('newnewsletter');
+        $u2ualert = formInt('u2ualert');
         $year = formInt('year');
         $month = formInt('month');
         $day = formInt('day');
         $bday = iso8601_date($year, $month, $day);
-        $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
-        $newavatarcheck = postedVar('newavatarcheck');
         $location = postedVar('newlocation', 'javascript', TRUE, TRUE, TRUE);
         $icq = postedVar('newicq', '', FALSE, FALSE);
         $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
@@ -431,117 +453,157 @@
         $mood = postedVar('newmood', 'javascript', TRUE, TRUE, TRUE);
         $sig = postedVar('newsig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-        if ($SETTINGS['doublee'] == 'off' && false !== strpos($email, "@")) {
-            $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE email = '$email' AND username != '$xmbuser'");
-            $count1 = $db->result($query,0);
-            $db->free_result($query);
-            if ($count1 != 0) {
-                error($lang['alreadyreg']);
+        if ($email != $db->escape_var($self['email'])) {
+            if ($SETTINGS['doublee'] == 'off' && false !== strpos($email, "@")) {
+                $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE email = '$email' AND username != '$xmbuser'");
+                $count1 = $db->result($query,0);
+                $db->free_result($query);
+                if ($count1 != 0) {
+                    error($lang['alreadyreg']);
+                }
             }
-        }
 
-        $efail = false;
-        $query = $db->query("SELECT * FROM ".X_PREFIX."restricted");
-        while($restriction = $db->fetch_array($query)) {
-            $t_email = $email;
-            if ($restriction['case_sensitivity'] == 1) {
-                $t_email = strtolower($t_email);
-                $restriction['name'] = strtolower($restriction['name']);
-            }
+            $efail = false;
+            $query = $db->query("SELECT * FROM ".X_PREFIX."restricted");
+            while($restriction = $db->fetch_array($query)) {
+                $t_email = $email;
+                if ($restriction['case_sensitivity'] == 0) {
+                    $t_email = strtolower($t_email);
+                    $restriction['name'] = strtolower($restriction['name']);
+                }
 
-            if ($restriction['partial'] == 1) {
-                if (strpos($t_email, $restriction['name']) !== false) {
-                    $efail = true;
+                if ($restriction['partial'] == 1) {
+                    if (strpos($t_email, $restriction['name']) !== false) {
+                        $efail = true;
+                    }
+                } else {
+                    if ($t_email == $restriction['name']) {
+                        $efail = true;
+                    }
                 }
-            } else {
-                if ($t_email == $restriction['name']) {
-                    $efail = true;
-                }
             }
-        }
-        $db->free_result($query);
+            $db->free_result($query);
 
-        if ($efail) {
-            error($lang['emailrestricted']);
+            if ($efail) {
+                error($lang['emailrestricted']);
+            }
+
+            require ROOT.'include/validate-email.inc.php';
+            $test = new EmailAddressValidator();
+            $rawemail = postedVar('newemail', '', FALSE, FALSE);
+            if (false === $test->check_email_address($rawemail)) {
+                error($lang['bademail']);
+            }
         }
 
         if ($SETTINGS['resetsigs'] == 'on') {
             if (strlen(trim($self['sig'])) == 0) {
                 if (strlen($sig) > 0) {
-                    $db->query("UPDATE ".X_PREFIX."posts SET usesig='yes' WHERE author='".$self['username']."'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET usesig='yes' WHERE author='$xmbuser'");
                 }
             } else {
                 if (strlen(trim($sig)) == 0) {
-                    $db->query("UPDATE ".X_PREFIX."posts SET usesig='no' WHERE author='".$self['username']."'");
+                    $db->query("UPDATE ".X_PREFIX."posts SET usesig='no' WHERE author='$xmbuser'");
                 }
             }
         }
 
-        $max_size = explode('x', $SETTINGS['max_avatar_size']);
-        if (ini_get('allow_url_fopen')) {
-            if ($max_size[0] > 0 && $max_size[1] > 0) {
-                $size = @getimagesize($_POST['newavatar']);
-                if ($size === false) {
-                    $avatar = '';
-                } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
-                    error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px', false);
+        if ($SETTINGS['avastatus'] == 'on') {
+            $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+            $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+
+            $newavatarcheck = postedVar('newavatarcheck');
+
+            $max_size = explode('x', $SETTINGS['max_avatar_size']);
+
+            if (preg_match('#^(http|ftp)://[:a-z\\./_\-0-9%~]+(\?[a-z=0-9&_\-;~]*)?$#Smi', $rawavatar) == 0) {
+                $avatar = '';
+            } elseif (ini_get('allow_url_fopen')) {
+                if ($max_size[0] > 0 And $max_size[1] > 0 And strlen($rawavatar) > 0) {
+                    $size = @getimagesize($rawavatar);
+                    if ($size === FALSE) {
+                        $avatar = '';
+                    } elseif ((($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) && !X_SADMIN) {
+                        error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                    }
                 }
+            } elseif ($newavatarcheck == "no") {
+                $avatar = '';
             }
-        } else if ($newavatarcheck == "no") {
-            $avatar = '';
-        }
-
-        if ($_POST['newpassword'] != '' || $_POST['newpasswordcf'] != '') {
-            if ($_POST['newpassword'] != $_POST['newpasswordcf']) {
-                error($lang['pwnomatch'], false);
+            unset($rawavatar);
+        } elseif ($SETTINGS['avastatus'] == 'list') {
+            $rawavatar = postedVar('newavatar', '', FALSE, FALSE);
+            $dirHandle = opendir(ROOT.'images/avatars');
+            $filefound = FALSE;
+            while($avFile = readdir($dirHandle)) {
+                if ($rawavatar == './images/avatars/'.$avFile) {
+                    if (is_file(ROOT.'images/avatars/'.$avFile) && $avFile != '.' && $avFile != '..' && $avFile != 'index.html') {
+                        $filefound = TRUE;
+                    }
+                }
             }
-
-            $newpassword = md5($_POST['newpassword']);
-
-            $pwtxt = "password='$newpassword',";
-
-            $currtime = $onlinetime - (86400*30);
-            put_cookie("xmbuser", $self['username'], $currtime, $cookiepath, $cookiedomain);
-            put_cookie("xmbpw", $newpassword, $currtime, $cookiepath, $cookiedomain);
+            closedir($dirHandle);
+            unset($rawavatar);
+            if ($filefound) {
+                $avatar = postedVar('newavatar', 'javascript', TRUE, TRUE, TRUE);
+            } else {
+                $avatar = '';
+            }
         } else {
-            $pwtxt = '';
+            $avatar = '';
         }
 
-        $db->query("UPDATE ".X_PREFIX."members SET $pwtxt email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u' WHERE username='$xmbuser'");
+        $db->query("UPDATE ".X_PREFIX."members SET $pwtxt email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u', u2ualert=$u2ualert WHERE username='$xmbuser'");
 
-        message($lang['usercpeditpromsg'], false, '', '', 'memcp.php', true, false, true);
+        message($lang['usercpeditpromsg'], TRUE, '', '', $full_url.'memcp.php', true, false, true);
     }
 } else if ($action == 'favorites') {
-    eval('echo "'.template('header').'";');
-    makenav($action);
+    eval('$header = "'.template('header').'";');
+    $header .= makenav($action);
 
     $favadd = getInt('favadd');
     if (noSubmit('favsubmit') && $favadd) {
         if ($favadd == 0) {
-            error($lang['fnasorry'], false);
+            error($lang['generic_missing']);
         }
 
-        $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid='$favadd' AND username='$xmbuser' AND type='favorite'");
+        $query = $db->query("SELECT fid FROM ".X_PREFIX."threads WHERE tid=$favadd");
+        if ($db->num_rows($query) == 0) {
+            error($lang['privforummsg']);
+        }
+        $row = $db->fetch_array($query);
+        $forum = getForum($row['fid']);
+        $perms = checkForumPermissions($forum);
+        if (!($perms[X_PERMS_VIEW] && $perms[X_PERMS_PASSWORD])) {
+            error($lang['privforummsg']);
+        }
+        if ($forum['type'] == 'sub') {
+            $perms = checkForumPermissions(getForum($forum['fup']));
+            if (!($perms[X_PERMS_VIEW] && $perms[X_PERMS_PASSWORD])) {
+                error($lang['privforummsg']);
+            }
+        }
+
+        $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE tid=$favadd AND username='$xmbuser' AND type='favorite'");
         $favthread = $db->fetch_array($query);
         $db->free_result($query);
 
         if ($favthread) {
-            error($lang['favonlistmsg'], false);
+            error($lang['favonlistmsg']);
         }
 
-        $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ('$favadd', '$xmbuser', 'favorite')");
-        message($lang['favaddedmsg'], false, '', '', 'memcp.php?action=favorites', true, false, true);
+        $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ($favadd, '$xmbuser', 'favorite')");
+        message($lang['favaddedmsg'], TRUE, '', '', $full_url.'memcp.php?action=favorites', true, false, true);
     }
 
     if (!$favadd && noSubmit('favsubmit')) {
-        $query = $db->query("SELECT f.*, t.fid, t.icon, t.lastpost, t.subject, t.replies FROM ".X_PREFIX."favorites f, ".X_PREFIX."threads t WHERE f.tid=t.tid AND f.username='$xmbuser' AND f.type='favorite' ORDER BY t.lastpost DESC");
+        $fids = permittedForums(forumCache(), 'thread', 'csv');
+        $query = $db->query("SELECT f.*, t.fid, t.icon, t.lastpost, t.subject, t.replies FROM ".X_PREFIX."favorites f INNER JOIN ".X_PREFIX."threads t USING (tid) WHERE f.username='$xmbuser' AND f.type='favorite' AND t.fid IN ($fids) ORDER BY t.lastpost DESC");
         $favnum = 0;
         $favs = '';
         $tmOffset = ($timeoffset * 3600) + ($addtime * 3600);
         while($fav = $db->fetch_array($query)) {
-            $query2 = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
-            $forum = $db->fetch_array($query2);
-            $db->free_result($query2);
+            $forum = getForum($fav['fid']);
             $forum['name'] = fnameOut($forum['name']);
 
             $lastpost = explode('|', $fav['lastpost']);
@@ -571,33 +633,44 @@
             eval('$favs = "'.template('memcp_favs_none').'";');
         }
         $db->free_result($query);
-        eval('echo "'.template('memcp_favs').'";');
+        eval('$mempage = "'.template('memcp_favs').'";');
     }
 
     if (!$favadd && onSubmit('favsubmit')) {
         $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND type='favorite'");
+        $tids = array();
         while($fav = $db->fetch_array($query)) {
             $delete = formInt('delete'.$fav['tid']);
-            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND tid='$delete' AND type='favorite'");
+            if ($delete == intval($fav['tid'])) {
+                $tids[] = $delete;
+            }
         }
         $db->free_result($query);
-
-        message($lang['favsdeletedmsg'], false, '', '', 'memcp.php?action=favorites', true, false, true);
+        if (count($tids) > 0) {
+            $tids = implode(', ', $tids);
+            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND tid IN ($tids) AND type='favorite'");
+        }
+        message($lang['favsdeletedmsg'], TRUE, '', '', $full_url.'memcp.php?action=favorites', true, false, true);
     }
 } else if ($action == 'subscriptions') {
-    eval('echo "'.template('header').'";');
-    makenav($action);
-
     $subadd = getInt('subadd');
     if (!$subadd && noSubmit('subsubmit')) {
-        $query = $db->query("SELECT f.*, t.fid, t.icon, t.lastpost, t.subject, t.replies FROM ".X_PREFIX."favorites f, ".X_PREFIX."threads t WHERE f.tid=t.tid AND f.username='$xmbuser' AND f.type='subscription' ORDER BY t.lastpost DESC");
+        $num = $db->result($db->query("SELECT COUNT(*) FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND type='subscription'"), 0);
+        $mpage = multipage($num, $tpp, 'memcp.php?action=subscriptions');
+        $multipage =& $mpage['html'];
+        if (strlen($mpage['html']) != 0) {
+            eval('$multipage = "'.template('memcp_subscriptions_multipage').'";');
+        }
+
+        eval('$header = "'.template('header').'";');
+        $header .= makenav($action);
+
+        $query = $db->query("SELECT f.*, t.fid, t.icon, t.lastpost, t.subject, t.replies FROM ".X_PREFIX."favorites f INNER JOIN ".X_PREFIX."threads t USING (tid) WHERE f.username='$xmbuser' AND f.type='subscription' ORDER BY t.lastpost DESC LIMIT {$mpage['start']}, $tpp");
         $subnum = 0;
         $subscriptions = '';
         $tmOffset = ($timeoffset * 3600) + ($addtime * 3600);
         while($fav = $db->fetch_array($query)) {
-            $query2 = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
-            $forum = $db->fetch_array($query2);
-            $db->free_result($query2);
+            $forum = getForum($fav['fid']);
             $forum['name'] = fnameOut($forum['name']);
 
             $lastpost = explode('|', $fav['lastpost']);
@@ -626,29 +699,36 @@
             eval('$subscriptions = "'.template('memcp_subscriptions_none').'";');
         }
         $db->free_result($query);
-        eval('echo "'.template('memcp_subscriptions').'";');
+        eval('$mempage = "'.template('memcp_subscriptions').'";');
     } else if ($subadd && noSubmit('subsubmit')) {
         $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."favorites WHERE tid='$subadd' AND username='$xmbuser' AND type='subscription'");
         if ($db->result($query,0) == 1) {
             $db->free_result($query);
-            error($lang['subonlistmsg'], false);
+            error($lang['subonlistmsg'], TRUE);
         } else {
             $db->query("INSERT INTO ".X_PREFIX."favorites (tid, username, type) VALUES ('$subadd', '$xmbuser', 'subscription')");
-            message($lang['subaddedmsg'], false, '', '', 'memcp.php?action=subscriptions', true, false, true);
+            message($lang['subaddedmsg'], TRUE, '', '', $full_url.'memcp.php?action=subscriptions', true, false, true);
         }
     } else if (!$subadd && onSubmit('subsubmit')) {
         $query = $db->query("SELECT tid FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND type='subscription'");
+        $tids = array();
         while($sub = $db->fetch_array($query)) {
             $delete = formInt('delete'.$sub['tid']);
-            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND tid='$delete' AND type='subscription'");
+            if ($delete == intval($sub['tid'])) {
+                $tids[] = $delete;
+            }
         }
         $db->free_result($query);
-        message($lang['subsdeletedmsg'], false, '', '', 'memcp.php?action=subscriptions', true, false, true);
+        if (count($tids) > 0) {
+            $tids = implode(', ', $tids);
+            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE username='$xmbuser' AND tid IN ($tids) AND type='subscription'");
+        }
+        message($lang['subsdeletedmsg'], TRUE, '', '', $full_url.'memcp.php?action=subscriptions', true, false, true);
     }
 } else {
-    eval('echo "'.template('header').'";');
+    eval('$header = "'.template('header').'";');
     eval($lang['evalusercpwelcome']);
-    makenav($action);
+    $header .= makenav($action);
 
     $q = $db->query("SELECT b.buddyname, w.invisible, w.username FROM ".X_PREFIX."buddys b LEFT JOIN ".X_PREFIX."whosonline w ON (b.buddyname=w.username) WHERE b.username='$xmbuser'");
     $buddys = array();
@@ -671,6 +751,7 @@
         $db->free_result($q);
     } else {
         while($buddy = $db->fetch_array($q)) {
+            $recodename = recodeOut($buddy['buddyname']);
             if (strlen($buddy['username']) > 0) {
                 if ($buddy['invisible'] == 1) {
                    eval("\$buddys[offline] .= \"".template("buddylist_buddy_offline")."\";");
@@ -729,14 +810,13 @@
     }
     $db->free_result($u2uquery);
 
-    $query2 = $db->query("SELECT * FROM ".X_PREFIX."favorites f, ".X_PREFIX."threads t, ".X_PREFIX."posts p WHERE f.tid=t.tid AND p.tid=t.tid AND p.subject=t.subject AND f.username='$xmbuser' AND f.type='favorite' ORDER BY t.lastpost DESC LIMIT 0,5");
+    $fids = permittedForums(forumCache(), 'thread', 'csv');
+    $query2 = $db->query("SELECT t.tid, t.fid, t.lastpost, t.subject, t.icon, t.replies FROM ".X_PREFIX."favorites f INNER JOIN ".X_PREFIX."threads t USING (tid) WHERE f.username='$xmbuser' AND f.type='favorite' AND t.fid IN ($fids) ORDER BY t.lastpost DESC LIMIT 0,5");
     $favnum = $db->num_rows($query2);
     $favs = '';
     $tmOffset = ($timeoffset * 3600) + ($addtime * 3600);
     while($fav = $db->fetch_array($query2)) {
-        $query = $db->query("SELECT name, fup, fid FROM ".X_PREFIX."forums WHERE fid='$fav[fid]'");
-        $forum = $db->fetch_array($query);
-        $db->free_result($query);
+        $forum = getForum($fav['fid']);
         $forum['name'] = fnameOut($forum['name']);
 
         $lastpost = explode('|', $fav['lastpost']);
@@ -759,9 +839,10 @@
         eval('$favs = "'.template('memcp_home_favs_none').'";');
     }
     $db->free_result($query2);
-    eval('echo "'.template('memcp_home').'";');
+    eval('$mempage = "'.template('memcp_home').'";');
 }
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$mempage.$footer;
+?>
Index: misc.php
===================================================================
--- misc.php	(revision 1746)
+++ misc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -29,7 +28,6 @@
 define('X_SCRIPT', 'misc.php');
 
 require 'header.php';
-require ROOT.'include/online.inc.php';
 
 loadtemplates(
 'functions_smilieinsert',
@@ -54,11 +52,6 @@
 'misc_online_row',
 'misc_online_row_admin',
 'misc_online_today',
-'misc_search',
-'misc_search_nextlink',
-'misc_search_results',
-'misc_search_results_none',
-'misc_search_results_row',
 'misc_smilies',
 'popup_footer',
 'popup_header'
@@ -76,7 +69,6 @@
         nav($lang['textlogout']);
         break;
     case 'search':
-        nav($lang['textsearch']);
         break;
     case 'lostpw':
         nav($lang['textlostpw']);
@@ -93,8 +85,12 @@
     case 'captchaimage':
         nav($lang['textregister']);
         break;
+    case 'smilies':
+        nav($lang['smilies']);
+        break;
     default:
-        nav($lang['error']);
+        header('HTTP/1.0 404 Not Found');
+        error($lang['textnoaction']);
         break;
 }
 
@@ -102,39 +98,39 @@
 
 switch($action) {
     case 'login':
-        if (X_MEMBER) {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('misc_feature_not_while_loggedin').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit();
+        $password = '';
+        $invisible = formInt('hide');
+        if ($invisible == 2) { // '2' may be set explicitly when we want to ignore this input.
+            $invisible = NULL;
+        } else {
+            $invisible = ($invisible == 1);
         }
-
-        if (noSubmit('loginsubmit')) {
+        if (X_MEMBER) {
+            eval('$misc = "'.template('misc_feature_not_while_loggedin').'";');
+        } elseif (noSubmit('loginsubmit')) {
             eval('$misc = "'.template('misc_login').'";');
+        } elseif (loginUser(postedVar('username'), md5($_POST['password']), $invisible, (formYesNo('secure') == 'yes'))) {
+            if ($server == 'Mic') {
+                $misc = message($lang['onlinelogin'], FALSE, '', '', $full_url, FALSE, TRUE, FALSE);
+            } else {
+                redirect($full_url, 0);
+            }
         } else {
-            $password = '';
-            if (loginUser(postedVar('username'), md5($_POST['password']), (formInt('hide') == 1), (formYesNo('secure') == 'yes'))) {
-                if ($server != 'Mic') {
-                    redirect('index.php', 0);
-                }
+            if ($self['status'] == "Banned") {
+                error($lang['bannedmessage']);
             } else {
-                eval('echo "'.template('header').'";');
-                eval('echo "'.template('misc_login_incorrectdetails').'";');
-                end_time();
-                eval('echo "'.template('footer').'";');
-                exit();
+                eval('$misc = "'.template('misc_login_incorrectdetails').'";');
+                eval('$misc .= "'.template('misc_login').'";');
             }
         }
         break;
 
     case 'logout':
         if (X_GUEST) {
-            redirect("index.php", 0);
+            redirect($full_url, 0);
             break;
         }
 
-        $currtime = $onlinetime - (86400*30);
         $query = $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE username='$xmbuser'");
 
         put_cookie("xmbuser", '', 0, $cookiepath, $cookiedomain);
@@ -146,192 +142,25 @@
             }
         }
 
-        redirect('index.php', 0);
+        redirect($full_url, 0);
         break;
 
     case 'search':
-        if ($SETTINGS['searchstatus'] != 'on') {
-            eval('echo "'.template('header').'";');
-            eval('echo "'.template('misc_feature_notavailable').'";');
-            end_time();
-            eval('echo "'.template('footer').'";');
-            exit();
-        }
-
-        if (!isset($searchsubmit) && !isset($page)) {
-            $forumselect = forumList('srchfid', FALSE, TRUE);
-            eval('$search = "'.template('misc_search').'";');
-            $misc = $search;
+        $newurl = preg_replace('/[^\x20-\x7e]/', '', $url);
+        if (substr($newurl, -22) == 'misc.php?action=search') {
+            $newurl = substr($newurl, 0, -22).'search.php';
         } else {
-            if (!isset($filter_distinct) || $filter_distinct != 'yes') {
-                $filter_distinct = '';
-            }
-            $srchtxt = postedVar('srchtxt', '', FALSE, FALSE, FALSE, 'r');
-            $srchuname = postedVar('srchuname', '', TRUE, TRUE, FALSE, 'r');
-            $rawsrchuname = postedVar('srchuname', '', FALSE, FALSE, FALSE, 'r');
-            $filter_distinct = postedVar('filter_distinct', '', FALSE, FALSE, FALSE, 'r');
-            if (strlen($srchuname) < 3 && (empty($srchtxt) || strlen($srchtxt) < 3)) {
-                error($lang['nosearchq']);
-            }
-
-            if (strlen($srchuname) < 3) {
-                $srchuname = '';
-            }
-
-            if ($searchsubmit || $page) {
-                validatePpp();
-
-                $searchresults = '';
-
-                if (!isset($page)) {
-                    $page = 1;
-                    $offset = 0;
-                    $start = 0;
-                } else {
-                    if ($page < 1) {
-                        $page = 1;
-                    }
-
-                    $offset = ($page-1) * ($ppp);
-                    $start = $offset;
-                }
-
-                $sql = "SELECT COUNT(p.tid), p.*, t.tid AS ttid, t.subject AS tsubject, f.fid, f.postperm, f.userlist, f.password FROM ".X_PREFIX."posts p, ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON  f.fid=t.fid WHERE p.tid=t.tid";
-
-                if (!isset($srchfrom) Or $srchfrom == 0) {
-                    $srchfrom = $onlinetime;
-                    $srchfromold = 0;
-                } else {
-                    $srchfromold = $srchfrom;
-                }
-
-                $ext = array();
-                $srchfrom = $onlinetime - (int) $srchfrom;
-                if (!empty($srchtxt)) {
-                    $srchtxtsq = explode(' ', $srchtxt);
-                    $sql .= ' AND (';
-                    foreach($srchtxtsq as $stxt) {
-                        $dblikebody = $db->like_escape(addslashes(cdataOut($stxt)));  //Messages are historically double-slashed.
-                        $dblikesub = $db->like_escape(addslashes(attrOut($stxt)));
-                        $sqlsrch[] = "p.message LIKE '%$dblikebody%' OR p.subject LIKE '%$dblikesub%'";
-                    }
-
-                    $sql .= implode(') AND (', $sqlsrch);
-                    $sql .= ')';
-                    $ext[] = 'srchtxt='.rawurlencode($srchtxt);
-                }
-
-                if ($srchuname != "") {
-                    $sql .= " AND p.author='$srchuname'";
-                    $ext[] = 'srchuname='.rawurlencode($rawsrchuname);
-                }
-
-                if (isset($srchfid)) {
-                    if ($srchfid != "all" && $srchfid != "") {
-                        $sql .= " AND p.fid='".(int)$srchfid."'";
-                        $ext[] = 'srchfid='.((int) $srchfid);
-                    }
-                }
-
-                if ($srchfrom) {
-                    $sql .= " AND p.dateline >= '$srchfrom'";
-                    $ext[] = 'srchfrom='.((int) $srchfromold);
-                }
-
-                $sql .=" GROUP BY dateline ORDER BY dateline DESC LIMIT $start, $ppp";
-                if (!isset($page) || $page < 1) {
-                    $pagenum = 2;
-                } else {
-                    $pagenum = $page+1;
-                }
-
-                $querysrch = $db->query($sql);
-                $results = 0;
-                $results = $db->num_rows($querysrch);
-
-                $temparray = array();
-                $searchresults = '';
-
-                $forumCache = array();
-                while($post = $db->fetch_array($querysrch)) {
-                    $forumPerms = array();
-
-                    if (isset($forumCache[$post['fid']])) {
-                        $forumPerms = $forumCache[$post['fid']];
-                    } else {
-                        $forumPerms = checkForumPermissions($post);
-                        $forumCache[$post['fid']] = $forumPerms;
-                    }
-
-                    if ($forumPerms[X_PERMS_VIEW] && $forumPerms[X_PERMS_USERLIST] && $forumPerms[X_PERMS_PASSWORD]) {
-                        if ($filter_distinct != 'yes' Or !array_key_exists($post['ttid'], $temparray)) {
-                            $tid = $post['ttid'];
-                            $temparray[$tid] = true;
-                            $message = stripslashes($post['message']);
-
-                            if (empty($srchtxt)) {
-                                $position = 0;
-                            } else {
-                                $position = stripos($message, cdataOut($srchtxtsq[0]), 0);
-                            }
-
-                            $show_num = 100;
-                            $msg_leng = strlen($message);
-
-                            if ($position <= $show_num) {
-                                $min = 0;
-                                $add_pre = '';
-                            } else {
-                                $min = $position - $show_num;
-                                $add_pre = '...';
-                            }
-
-                            if (($msg_leng - $position) <= $show_num) {
-                                $max = $msg_leng;
-                                $add_post = '';
-                            } else {
-                                $max = $position + $show_num;
-                                $add_post = '...';
-                            }
-
-                            if (trim($post['subject']) == '') {
-                                $post['subject'] = $post['tsubject'];
-                            }
-
-                            $show = substr($message, $min, $max - $min);
-                            $post['subject'] = stripslashes($post['subject']);
-                            if (!empty($srchtxt)) {
-                                foreach($srchtxtsq as $stxt) {
-                                    $show = str_ireplace(cdataOut($stxt), '<b><i>'.cdataOut($stxt).'</i></b>', $show);
-                                    $post['subject'] = str_ireplace(attrOut($stxt), '<i>'.attrOut($stxt).'</i>', $post['subject']);
-                                }
-                            }
-
-                            $show = postify($show, 'no', 'yes', 'yes', 'no', 'no', 'no');
-                            $post['subject'] = rawHTMLsubject($post['subject']);
-
-                            $date = gmdate($dateformat, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-                            $time = gmdate($timecode, $post['dateline'] + ($timeoffset * 3600) + ($addtime * 3600));
-
-                            $poston = $date.' '.$lang['textat'].' '.$time;
-                            $postby = $post['author'];
-                            eval('$searchresults .= "'.template('misc_search_results_row').'";');
-                        }
-                    }
-                }
-            }
-
-            if ($results == 0) {
-                eval('$searchresults = "'.template('misc_search_results_none').'";');
-            } else if ($results == $ppp) {
-                // create a string containing the stuff to search for
-                $ext = implode('&', $ext);
-                eval('$nextlink = "'.template('misc_search_nextlink').'";');
-            }
-
-            eval('$search = "'.template('misc_search_results').'";');
-            $misc = $search;
+            $newurl = str_replace('misc.php?action=search&', 'search.php?', $newurl);
         }
+        if ($newurl == $url) { // Unexpected query string.
+            $newurl = str_replace('&action=search', '', $newurl);
+            $newurl = str_replace('/misc', '/search', $newurl);
+        }
+        $newurl = substr($full_url, 0, -strlen($cookiepath)).$newurl;
+        header('HTTP/1.0 301 Moved Permanently');
+        header('Location: '.$newurl);
+        exit;
+
         break;
 
     case 'lostpw':
@@ -347,20 +176,25 @@
             eval('$misc = "'.template('misc_lostpw').'";');
         } else {
             $username = postedVar('username');
+            if (strlen($username) < 3) {
+                error($lang['badinfo']);
+            }
             $email = postedVar('email');
-            $query = $db->query("SELECT username, email, pwdate FROM ".X_PREFIX."members WHERE username='$username' AND email='$email'");
+            $query = $db->query("SELECT username, email, pwdate, langfile, status FROM ".X_PREFIX."members WHERE username='$username' AND email='$email'");
+            if ($db->num_rows($query) != 1) {
+                error($lang['badinfo']);
+            }
             $member = $db->fetch_array($query);
             $db->free_result($query);
+            if ($member['status'] == 'Banned') {
+                error($lang['bannedmessage']);
+            }
 
             $time = $onlinetime - 86400;
             if ($member['pwdate'] > $time) {
                 error($lang['lostpw_in24hrs']);
             }
 
-            if (!$member['username']) {
-                error($lang['badinfo']);
-            }
-
             $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';
             $newpass = '';
             mt_srand((double)microtime() * 1000000);
@@ -372,8 +206,18 @@
 
             $db->query("UPDATE ".X_PREFIX."members SET password='$newmd5pass', pwdate='".$onlinetime."' WHERE username='$member[username]' AND email='$member[email]'");
 
+            $lang2 = loadPhrases(array('charset','textyourpw','textyourpwis','textusername','textpassword'));
+            $translate = $lang2[$member['langfile']];
             $emailuname = htmlspecialchars_decode($member['username'], ENT_QUOTES);
-            altMail($member['email'], '['.$bbname.'] '.$lang['textyourpw'], "{$lang['textyourpwis']} \n\n{$lang['textusername']} $emailuname\n{$lang['textpassword']} $newpass", "From: $bbname <$adminemail>");
+            $emailaddy = htmlspecialchars_decode($member['email'], ENT_QUOTES);
+            $headers = array();
+            $headers[] = "From: $bbname <$adminemail>";
+            $headers[] = 'X-Mailer: PHP';
+            $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+            $headers[] = 'X-AntiAbuse: Username - '.$emailuname;
+            $headers[] = 'Content-Type: text/plain; charset='.$translate['charset'];
+            $headers = implode("\r\n", $headers);
+            altMail($emailaddy, '['.$bbname.'] '.$translate['textyourpw'], "{$translate['textyourpwis']} \n\n{$translate['textusername']} $emailuname\n{$translate['textpassword']} $newpass\n\n$full_url", $headers);
 
             $misc .= '<span class="mediumtxt"><center>'.$lang['emailpw'].'</span></center><br />';
             $misc .= '<script>function redirect() {window.location.replace("index.php");}setTimeout("redirect();", 1250);</script>';
@@ -381,7 +225,10 @@
         break;
 
     case 'online':
+        require ROOT.'include/online.inc.php';
+
         if ($SETTINGS['whosonlinestatus'] == 'off') {
+            header('HTTP/1.0 403 Forbidden');
             eval('echo "'.template('header').'";');
             eval('echo "'.template('misc_feature_notavailable').'";');
             end_time();
@@ -389,17 +236,10 @@
             exit();
         }
 
-        $page = getInt('page');
-        $count = $db->num_rows($db->query("SELECT * FROM ".X_PREFIX."whosonline"));
-        $max_page = (int) ($count / $tpp) + 1;
-        if ($page && $page >= 1 && $page <= $max_page) {
-            $start_limit = ($page-1) * $tpp;
-        } else {
-            $start_limit = 0;
-            $page = 1;
-        }
-
-        if (($multipage = multi($count, $tpp, $page, 'misc.php?action=online&amp;page='.$page)) !== false) {
+        $count = $db->result($db->query("SELECT COUNT(*) FROM ".X_PREFIX."whosonline"), 0);
+        $mpage = multipage($count, $tpp, 'misc.php?action=online');
+        $multipage =& $mpage['html'];
+        if (strlen($mpage['html']) != 0) {
             if (X_ADMIN) {
                 eval('$multipage = "'.template('misc_online_multipage_admin').'";');
             } else {
@@ -407,12 +247,21 @@
             }
         }
 
-        if (X_ADMIN) {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."whosonline ORDER BY username ASC LIMIT $start_limit, $tpp");
-        } else {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."whosonline WHERE invisible='0' OR (invisible='1' AND username='$xmbuser') ORDER BY username ASC LIMIT $start_limit, $tpp");
+        $where = "WHERE username != 'xguest123'";
+        if (!X_ADMIN) {
+            $where .= " AND (invisible='0' OR username='$xmbuser')";
         }
 
+        // UNION Syntax Reminder: "Use of ORDER BY for individual SELECT statements implies nothing about the order in which the rows appear."
+        $sql = "SELECT username, 1 AS sort_col, MAX(ip) AS ip, MAX(`time`) as `time`, MAX(location) AS location, MAX(invisible) AS invisible "
+             . "FROM ".X_PREFIX."whosonline $where GROUP BY username, sort_col "
+             . "UNION ALL "
+             . "SELECT username, 2 AS sort_col, ip, `time`, location, invisible "
+             . "FROM ".X_PREFIX."whosonline WHERE username = 'xguest123' "
+             . "ORDER BY sort_col, username, `time` DESC "
+             . "LIMIT {$mpage['start']}, $tpp";
+        $query = $db->query($sql);
+
         $onlineusers = '';
         while($online = $db->fetch_array($query)) {
             $array = url_to_text($online['location']);
@@ -440,6 +289,8 @@
             if (X_ADMIN) {
                 eval('$onlineusers .= "'.template('misc_online_row_admin').'";');
             } else {
+                $online['invisible'] = '';
+                $online['ip'] = '';
                 eval('$onlineusers .= "'.template('misc_online_row').'";');
             }
         }
@@ -455,6 +306,7 @@
 
     case 'onlinetoday':
         if ($SETTINGS['whosonlinestatus'] == 'off' || $SETTINGS['onlinetoday_status'] == 'off') {
+            header('HTTP/1.0 403 Forbidden');
             eval('echo "'.template('header').'";');
             eval('echo "'.template('misc_feature_notavailable').'";');
             end_time();
@@ -490,14 +342,8 @@
         break;
 
     case 'list':
-        $order = postedVar('order', '', FALSE, FALSE, FALSE, 'g');
-        $desc = postedVar('desc', '', FALSE, FALSE, FALSE, 'g');
-        $page = getInt('page');
-        $dblikemem = $db->like_escape(postedVar('srchmem', '', TRUE, FALSE));
-        $dblikeemail = $db->like_escape(postedVar('srchemail', '', TRUE, FALSE, TRUE));
-        $dblikeip = $db->like_escape(postedVar('srchip', '', TRUE, FALSE));
-
         if ($SETTINGS['memliststatus'] == 'off') {
+            header('HTTP/1.0 403 Forbidden');
             eval('echo "'.template('header').'";');
             eval('echo "'.template('misc_feature_notavailable').'";');
             end_time();
@@ -505,24 +351,25 @@
             exit();
         }
 
+
+        /* Validate All Inputs */
+
+        $order = postedVar('order', '', FALSE, FALSE, FALSE, 'g');
+        $desc = postedVar('desc', '', FALSE, FALSE, FALSE, 'g');
+        $page = getInt('page');
+        $dblikemem = $db->like_escape(postedVar('srchmem', '', TRUE, FALSE, FALSE, 'g'));
+        $dblikeemail = $db->like_escape(postedVar('srchemail', '', TRUE, FALSE, TRUE, 'g'));
+        $dblikeip = $db->like_escape(postedVar('srchip', '', TRUE, FALSE, TRUE, 'g'));
+
         if (strtolower($desc) != 'desc') {
             $desc = 'asc';
         }
 
-        $result = $db->result($db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE lastvisit!=0"), 0);
-        $max_page = (int) ($result / $memberperpage) + 1;
-        if ($page && $page >= 1 && $page <= $max_page) {
-            $start_limit = ($page-1) * $SETTINGS['memberperpage'];
-        } else {
-            $start_limit = 0;
-            $page = 1;
-        }
-
-        if ($order != 'username' && $order != 'postnum' && $order != 'status') {
-            $orderby = "uid";
-            $order = 'uid';
+        if ($order != 'username' && $order != 'postnum' && $order != 'status' && $order != 'location') {
+            $order = '';
+            $orderby = 'regdate';
         } else if ($order == 'status') {
-            $orderby = "if (status='Super Administrator',1, if (status='Administrator', 2, if (status='Super Moderator', 3, if (status='Moderator', 4, if (status='member', 5, if (status='banned',6,7))))))";
+            $orderby = "if (status='Super Administrator',1, if (status='Administrator', 2, if (status='Super Moderator', 3, if (status='Moderator', 4, if (status='Member', 5, if (status='Banned',6,7))))))";
         } else {
             $orderby = $order;
         }
@@ -531,14 +378,21 @@
             $dblikeip = '';
             $dblikeemail = '';
             $misc_mlist_template = 'misc_mlist';
-            $where = array();
         } else {
-            $where = array();
             $misc_mlist_template = 'misc_mlist_admin';
         }
 
-        $ext = array('&order='.$order);
-
+        $where = array();
+        $ext = array();
+        
+        if ($desc != 'asc') {
+            $ext[] = "desc=$desc";
+        }
+        
+        if ($order != '') {
+            $ext[] = 'order='.$order;
+        }
+        
         if ($dblikeemail != '') {
             if (!X_SADMIN) {
                 $where[] = " email LIKE '%$dblikeemail%'";
@@ -546,8 +400,8 @@
             } else {
                 $where[] = " email LIKE '%$dblikeemail%'";
             }
-            $ext[] = 'srchemail='.rawurlencode(postedVar('srchemail', '', FALSE, FALSE));
-            $srchemail = postedVar('srchemail', 'javascript', TRUE, FALSE, TRUE);
+            $ext[] = 'srchemail='.rawurlencode(postedVar('srchemail', '', FALSE, FALSE, FALSE, 'g'));
+            $srchemail = postedVar('srchemail', 'javascript', TRUE, FALSE, TRUE, 'g');
             /* Warning: $srchemail is used for template output */
         } else {
             $srchemail = '';
@@ -555,8 +409,8 @@
 
         if ($dblikeip != '') {
             $where[] = " regip LIKE '%$dblikeip%'";
-            $ext[] = 'srchip='.rawurlencode(postedVar('srchip', '', FALSE, FALSE));
-            $srchip = postedVar('srchip', 'javascript', TRUE, FALSE, TRUE);
+            $ext[] = 'srchip='.rawurlencode(postedVar('srchip', '', FALSE, FALSE, FALSE, 'g'));
+            $srchip = postedVar('srchip', 'javascript', TRUE, FALSE, TRUE, 'g');
             /* Warning: $srchip is used for template output */
         } else {
             $srchip = '';
@@ -564,21 +418,36 @@
 
         if ($dblikemem != '') {
             $where[] = " username LIKE '%$dblikemem%'";
-            $ext[] = 'srchmem='.rawurlencode(postedVar('srchmem', '', FALSE, FALSE));
-            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE);
+            $ext[] = 'srchmem='.rawurlencode(postedVar('srchmem', '', FALSE, FALSE, FALSE, 'g'));
+            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE, TRUE, 'g');
             /* Warning: $srchmem is used for template output */
         } else {
             $srchmem = '';
         }
 
-        $where[] = " lastvisit!=0 ";
+        if (count($ext) > 0) {
+            $ext = '&amp;'.implode('&amp;', $ext);
+        } else {
+            $ext = '';
+        }
 
+        $where[] = " lastvisit!=0 ";
         $q = implode(' AND', $where);
-        $querymem = $db->query("SELECT * FROM ".X_PREFIX."members WHERE $q ORDER BY $orderby $desc LIMIT $start_limit, $memberperpage");
         $num = $db->result($db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE $q"), 0);
+        $canonical = 'misc.php?action=list';
+        $baseurl = $canonical.$ext;
+        $mpage = multipage($num, $memberperpage, $baseurl, $canonical);
+        $multipage =& $mpage['html'];
+        if (strlen($mpage['html']) != 0) {
+            eval('$multipage = "'.template('misc_mlist_multipage').'";');
+        }
+        unset($num, $where);
 
-        $ext = implode('&amp;', $ext);
 
+        /* Generate Output */
+
+        $querymem = $db->query("SELECT * FROM ".X_PREFIX."members WHERE $q ORDER BY $orderby $desc LIMIT {$mpage['start']}, $memberperpage");
+
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
 
         $replace = array('http://', 'https://', 'ftp://');
@@ -623,18 +492,7 @@
             $db->free_result($querymem);
         }
 
-        if (!isset($memberperpage)) {
-            $memberperpage = $postperpage;
-        }
-
-        $mpurl = 'misc.php?action=list&amp;desc='.$desc.''.$ext;
-        if (($multipage = multi($num, $memberperpage, $page, $mpurl)) === false) {
-            $multipage = '';
-        } else {
-            eval('$multipage = "'.template('misc_mlist_multipage').'";');
-        }
-
-        if ($desc == 'desc') {
+        if (strtolower($desc) == 'desc') {
             $init['ascdesc'] = 'asc';
             $ascdesc = $lang['asc'];
         } else {
@@ -650,8 +508,7 @@
         eval('$css = "'.template('css').'";');
         eval('$header = "'.template('popup_header').'";');
         eval('$footer = "'.template('popup_footer').'";');
-        $smtotal = 0;
-        $smilies = smilieinsert();
+        $smilies = smilieinsert('full');
         eval('$misc = "'.template('misc_smilies').'";');
         echo $header;
         echo $misc;
@@ -660,7 +517,16 @@
         break;
 
     case 'captchaimage':
+        if ($SETTINGS['captcha_status'] == 'off') {
+            header('HTTP/1.0 403 Forbidden');
+            eval('echo "'.template('header').'";');
+            eval('echo "'.template('misc_feature_notavailable').'";');
+            end_time();
+            eval('echo "'.template('footer').'";');
+            exit();
+        }
         require ROOT.'include/captcha.inc.php';
+        header('X-Robots-Tag: noindex');
         $oPhpCaptcha = new Captcha(250, 50);
         $imagehash = postedVar('imagehash', '', FALSE, TRUE, FALSE, 'g');
         $oPhpCaptcha->Create($imagehash);
@@ -676,4 +542,4 @@
 end_time();
 eval('$footer = "'.template('footer').'";');
 echo $header.$misc.$footer;
-?>
\ No newline at end of file
+?>
Index: post.php
===================================================================
--- post.php	(revision 1746)
+++ post.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -30,11 +29,14 @@
 
 require 'header.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates(
 'post_captcha',
 'post_notloggedin',
 'post_loggedin',
 'post_preview',
+'post_attachment_orphan',
 'post_attachmentbox',
 'post_newthread',
 'post_reply_review_toolong',
@@ -47,7 +49,12 @@
 'forumdisplay_password',
 'functions_bbcode',
 'post_newpoll',
-'post_edit_attachment'
+'post_edit_attachment',
+'viewthread_post_attachmentthumb',
+'viewthread_post_attachmentimage',
+'viewthread_post_attachment',
+'viewthread_post_nosig',
+'viewthread_post_sig'
 );
 
 eval('$css = "'.template('css').'";');
@@ -71,6 +78,7 @@
     $pid = getRequestInt('pid');
     $query = $db->query("SELECT f.*, t.tid FROM ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) LEFT JOIN ".X_PREFIX."forums AS f ON f.fid=t.fid WHERE p.pid=$pid");
     if ($db->num_rows($query) != 1) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnothread']);
     }
     $forum = $db->fetch_array($query);
@@ -82,6 +90,7 @@
     $repquote = getInt('repquote');
     $query = $db->query("SELECT f.* FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."forums AS f USING (fid) WHERE t.tid=$tid");
     if ($db->num_rows($query) != 1) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnothread']);
     }
     $forum = $db->fetch_array($query);
@@ -89,17 +98,18 @@
     $fid = $forum['fid'];
 } else if ($action == 'newthread') {
     $fid = getRequestInt('fid');
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
-    if ($db->num_rows($query) != 1) {
+    $forum = getForum($fid);
+    if ($forum === FALSE) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnoforum']);
     }
-    $forum = $db->fetch_array($query);
-    $db->free_result($query);
 } else {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoaction']);
 }
 
 if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoforum']);
 }
 
@@ -108,6 +118,7 @@
 if ($tid > 0) {
     $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid=$tid");
     if ($db->num_rows($query) != 1) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnothread']);
     }
     $thread = $db->fetch_array($query);
@@ -119,10 +130,15 @@
 }
 
 //Warning! These variables are used for template output.
+$attachfile = '';
+$attachment = '';
 $captchapostcheck = '';
 $dissubject = '';
+$errors = '';
+$imghash = '';
 $message = '';
 $message1 = '';
+$postinfo = array();
 $preview = '';
 $spelling_lang = '';
 $spelling_submit1 = '';
@@ -144,8 +160,13 @@
 
 // check permissions on this forum (and top forum if it's a sub?)
 $perms = checkForumPermissions($forum);
-if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
-    error($lang['privforummsg']);
+if (!$perms[X_PERMS_VIEW]) {
+    if (X_GUEST) {
+        redirect("{$full_url}misc.php?action=login", 0);
+        exit;
+    } else {
+        error($lang['privforummsg']);
+    }
 } else if (!$perms[X_PERMS_PASSWORD]) {
     handlePasswordDialog($fid);
 }
@@ -153,11 +174,21 @@
 // check posting permissions specifically
 if ($action == 'newthread') {
     if (($poll == '' && !$perms[X_PERMS_THREAD]) || ($poll == 'yes' && !$perms[X_PERMS_POLL])) {
-        error($lang['textnoaction']);
+        if (X_GUEST) {
+            redirect("{$full_url}misc.php?action=login", 0);
+            exit;
+        } else {
+            error($lang['textnoaction']);
+        }
     }
 } else if ($action == 'reply') {
     if (!$perms[X_PERMS_REPLY]) {
-        error($lang['textnoaction']);
+        if (X_GUEST) {
+            redirect("{$full_url}misc.php?action=login", 0);
+            exit;
+        } else {
+            error($lang['textnoaction']);
+        }
     }
 } else if ($action == 'edit') {
     // let's allow edits for now, we'll check for permissions later on in the script (due to need for $orig['author'])
@@ -167,66 +198,71 @@
 
 $fup = array();
 if ($forum['type'] == 'sub') {
-    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
-
+    $fup = getForum($forum['fup']);
     // prevent access to subforum when upper forum can't be viewed.
     $fupPerms = checkForumPermissions($fup);
-    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST] || !$fupPerms[X_PERMS_PASSWORD]) {
+    if (!$fupPerms[X_PERMS_VIEW]) {
+        if (X_GUEST) {
+            redirect("{$full_url}misc.php?action=login", 0);
+            exit;
+        } else {
+            error($lang['privforummsg']);
+        }
+    } else if (!$fupPerms[X_PERMS_PASSWORD]) {
         error($lang['privforummsg']);     // do not show password-dialog here; it makes the situation too complicated
     } else if ($fup['fup'] > 0) {
-        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+        $fupup = getForum($fup['fup']);
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fupup['name']).'</a>');
+        unset($fupup);
     }
     nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 } else if ($forum['fup'] > 0) { // 'forum' in a 'group'
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
+    $fup = getForum($forum['fup']);
     nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 }
 nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forum['name']).'</a>');
 
-$attachfile = '';
-if (isset($forum['attachstatus']) && $forum['attachstatus'] == 'on') {
-    eval('$attachfile = "'.template("post_attachmentbox").'";');
+// Search-link
+$searchlink = makeSearchLink($forum['fid']);
+
+if ($forum['attachstatus'] == 'on') {
+    require 'include/attach.inc.php';
+    $attachlimits = ' '.$lang['attachmaxsize'].' '.getSizeFormatted($SETTINGS['maxattachsize']).'.  '.$lang['attachmaxdims'].' '.$SETTINGS['max_image_size'].'.';
 }
 
+$posticon = postedVar('posticon', 'javascript', TRUE, TRUE, TRUE);
+if (!isValidFilename($posticon)) {
+    $posticon = '';
+} elseif (!file_exists($smdir.'/'.$posticon)) {
+    $posticon = '';
+}
+
 $listed_icons = 0;
 $icons = '<input type="radio" name="posticon" value="" /> <img src="'.$imgdir.'/default_icon.gif" alt="[*]" border="0" />';
+$querysmilie = $db->query("SELECT url, code FROM ".X_PREFIX."smilies WHERE type='picon'");
+while($smilie = $db->fetch_array($querysmilie)) {
+    $icons .= ' <input type="radio" name="posticon" value="'.$smilie['url'].'" /><img src="'.$smdir.'/'.$smilie['url'].'" alt="'.$smilie['code'].'" border="0" />';
+    $listed_icons++;
+    if ($listed_icons == 9) {
+        $icons .= '<br />';
+        $listed_icons = 0;
+    }
+}
+$db->free_result($querysmilie);
+
 if ($action != 'edit') {
-    $captchapostcheck = '';
+    $icons = str_replace('<input type="radio" name="posticon" value="'.$posticon.'" />', '<input type="radio" name="posticon" value="'.$posticon.'" checked="checked" />', $icons);
+
     if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
         require ROOT.'include/captcha.inc.php';
     }
-
-    $querysmilie = $db->query("SELECT url, code FROM ".X_PREFIX."smilies WHERE type='picon'");
-    while($smilie = $db->fetch_array($querysmilie)) {
-        $icons .= ' <input type="radio" name="posticon" value="'.$smilie['url'].'" /><img src="'.$smdir.'/'.$smilie['url'].'" alt="'.$smilie['code'].'" border="0" />';
-        $listed_icons += 1;
-        if ($listed_icons == 9) {
-            $icons .= '<br />';
-            $listed_icons = 0;
-        }
-    }
-    $db->free_result($querysmilie);
 }
 
-eval('$bbcodescript = "'.template('functions_bbcode').'";');
+$allowimgcode = ($forum['allowimgcode'] == 'yes' And $forum['allowbbcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowhtml = ($forum['allowhtml'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowsmilies = ($forum['allowsmilies'] == 'yes') ? $lang['texton'] : $lang['textoff'];
+$allowbbcode = ($forum['allowbbcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
 
-if (!isset($usesig)) {
-    $usesig = 'no';
-}
-
-if ($usesig != 'yes') {
-    $usesig = 'no';
-}
-
-$allowimgcode = (isset($forum['allowimgcode']) && $forum['allowimgcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowhtml = (isset($forum['allowhtml']) && $forum['allowhtml'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowsmilies = (isset($forum['allowsmilies']) && $forum['allowsmilies'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-$allowbbcode = (isset($forum['allowbbcode']) && $forum['allowbbcode'] == 'yes') ? $lang['texton'] : $lang['textoff'];
-
 if (isset($smileyoff) && $smileyoff == 'yes') {
     $smileoffcheck = $cheHTML;
 } else {
@@ -248,13 +284,24 @@
     $emailnotify = 'no';
 }
 
-if (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($spellcheckersubmit))) {
-    $sc = true;
+// New bool vars to clear up the confusion about effective settings.
+$bBBcodeInserterEnabled = ($SETTINGS['bbinsert'] == 'on' And $forum['allowbbcode'] == 'yes');
+$bBBcodeOnForThisPost = ($forum['allowbbcode'] == 'yes' And $bbcodeoff == 'no');
+$bIMGcodeOnForThisPost = ($bBBcodeOnForThisPost And $forum['allowimgcode'] == 'yes');
+$bSmilieInserterEnabled = ($SETTINGS['smileyinsert'] == 'on' And $forum['allowsmilies'] == 'yes');
+$bSmiliesOnForThisPost = ($forum['allowsmilies'] == 'yes' And $smileyoff = 'no');
+
+if (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit))) {
+    $sc = TRUE;
 } else {
-    $sc = false;
+    $sc = FALSE;
 }
 
-if ((isset($previewpost) || $sc) && isset($usesig) && $usesig == 'yes') {
+if (!(isset($usesig) && $usesig == 'yes')) {
+    $usesig = 'no';
+}
+
+if ((isset($previewpost) || $sc) && $usesig == 'yes') {
     $usesigcheck = $cheHTML;
 } else if (isset($previewpost) || $sc) {
     $usesigcheck = '';
@@ -283,21 +330,12 @@
     $closecheck = '';
 }
 
-$posticon = postedVar('posticon', 'javascript', TRUE, TRUE, TRUE);
-if ($posticon != '') {
-    $thread['icon'] = (file_exists($smdir.'/'.$posticon)) ? "<img src=\"$smdir/$posticon\" />" : '';
-    $icons = str_replace('<input type="radio" name="posticon" value="'.$posticon.'" />', '<input type="radio" name="posticon" value="'.$posticon.'" checked="checked" />', $icons);
-} else {
-    $thread['icon'] = '';
-    $icons = str_replace('<input type="radio" name="posticon" value="" />', '<input type="radio" name="posticon" value="" checked="checked" />', $icons);
-}
-
 $messageinput = postedVar('message', '', TRUE, FALSE);  //postify() is responsible for DECODING if html is allowed.
 
 if ($SETTINGS['spellcheck'] == 'on') {
     $spelling_submit1 = '<input type="hidden" name="subaction" value="spellcheck" /><input type="submit" class="submit" name="spellchecksubmit" value="'.$lang['checkspelling'].'" />';
     $spelling_lang = '<select name="language"><option value="en" selected="selected">English</option></select>';
-    if (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit))) {
+    if ($sc) {
         if (isset($language) && !isset($updates_submit)) {
             require ROOT.'include/spelling.inc.php';
             $spelling = new spelling($language);
@@ -330,21 +368,19 @@
     }
 }
 
-$bbcodeinsert = bbcodeinsert();
-$smilieinsert = smilieinsert();
-
-//Allow sanitized message to pass-through to template in case of: #1 preview, #2 post error
-$subject = rawHTMLsubject(postedVar('subject', 'javascript', TRUE, FALSE, TRUE));  //per viewthread design of version 1.9.9, HTML is never allowed in subjects.
-$message = rawHTMLmessage($messageinput);
-
-if (isset($previewpost)) {
-    $currtime = $onlinetime;
-    $date = gmdate($dateformat, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
-    $time = gmdate($timecode, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
-    $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
-    $dissubject = $subject;
-    $message1 = postify($messageinput, $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
-    eval('$preview = "'.template('post_preview').'";');
+$bbcodeinsert = '';
+$bbcodescript = '';
+$moresmilies = '';
+$smilieinsert = '';
+if ($bBBcodeInserterEnabled Or $bSmilieInserterEnabled) {
+    eval('$bbcodescript = "'.template('functions_bbcode').'";');
+    if ($bBBcodeInserterEnabled) {
+        eval('$bbcodeinsert = "'.template('functions_bbcodeinsert').'";'); // Uses $spelling_lang
+    }
+    if ($bSmilieInserterEnabled) {
+        $smilieinsert = smilieinsert();
+        $moresmilies = "<a href=\"misc.php?action=smilies\" onclick=\"Popup(this.href, 'Window', 175, 250); return false;\">[{$lang['moresmilies']}]</a>";
+    }
 }
 
 switch($action) {
@@ -356,14 +392,44 @@
             $threadSubject = '- '.$threadname;
         }
 
-        eval('echo "'.template('header').'";');
+        eval('$header = "'.template('header').'";');
 
         $replyvalid = onSubmit('replysubmit'); // This new flag will indicate a message was submitted and successful.
 
+        if ($forum['attachstatus'] == 'on' And $username != 'Anonymous') {
+            for ($i=1; $i<=$SETTINGS['filesperpost']; $i++) {
+                if (isset($_FILES['attach'.$i])) {
+                    $result = attachUploadedFile('attach'.$i);
+                    if ($result < 0 And $result != X_EMPTY_UPLOAD) {
+                        $errors .= softerror($attachmentErrors[$result]);
+                        $replyvalid = FALSE;
+                    }
+                }
+            }
+            $result = doAttachmentEdits($deletes);
+            if ($result < 0) {
+                $errors .= softerror($attachmentErrors[$result]);
+                $replyvalid = FALSE;
+            }
+            foreach($deletes as $aid) {
+                $messageinput = str_replace("[file]{$aid}[/file]", '', $messageinput);
+            }
+            if ($SETTINGS['attach_remote_images'] == 'on' And $bIMGcodeOnForThisPost) {
+                $result = extractRemoteImages(0, $messageinput);
+                if ($result < 0) {
+                    $errors .= softerror($attachmentErrors[$result]);
+                    $replyvalid = FALSE;
+                }
+            }
+            $attachSkipped = FALSE;
+        } else {
+            $attachSkipped = TRUE;
+        }
+
         //Check all replying permissions for this $tid.
         if (!X_SADMIN And $thread['closed'] != '') {
             if ($replyvalid) {
-                softerror($lang['closedmsg']);
+                $errors .= softerror($lang['closedmsg']);
             } else {
                 error($lang['closedmsg']);
             }
@@ -376,43 +442,44 @@
                 if (strlen(postedVar('username')) > 0 And isset($_POST['password'])) {
                     if (loginUser(postedVar('username'), md5($_POST['password']))) {
                         if ($self['status'] == "Banned") {
-                            softerror($lang['bannedmessage']);
+                            $errors .= softerror($lang['bannedmessage']);
                             $replyvalid = FALSE;
                         } else if ($self['ban'] == "posts" || $self['ban'] == "both") {
-                            softerror($lang['textbanfrompost']);
+                            $errors .= softerror($lang['textbanfrompost']);
                             $replyvalid = FALSE;
                         } else {
                             $username = $xmbuser;
 
                             // check permissions on this forum (and top forum if it's a sub?)
                             $perms = checkForumPermissions($forum);
-                            if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
-                                softerror($lang['privforummsg']);
+                            if (!$perms[X_PERMS_VIEW]) {
+                                $errors .= softerror($lang['privforummsg']);
                                 $topicvalid = FALSE;
                             } else if (!$perms[X_PERMS_REPLY]) {
-                                softerror($lang['textnoaction']);
+                                $errors .= softerror($lang['textnoaction']);
                                 $topicvalid = FALSE;
                             }
 
                             if ($forum['type'] == 'sub') {
                                 // prevent access to subforum when upper forum can't be viewed.
                                 $fupPerms = checkForumPermissions($fup);
-                                if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
-                                    softerror($lang['privforummsg']);
+                                if (!$fupPerms[X_PERMS_VIEW]) {
+                                    $errors .= softerror($lang['privforummsg']);
                                     $topicvalid = FALSE;
                                 }
                             }
                         }
                     } else {
-                        softerror($lang['textpw1']);
+                        $errors .= softerror($lang['textpw1']);
                         $replyvalid = FALSE;
                     }
                 } else if ($SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
                     $Captcha = new Captcha(250, 50);
                     if ($Captcha->bCompatible !== false) {
-                        $imghash = $db->escape($imghash);
+                        $imgcode = postedVar('imgcode', '', FALSE, FALSE);
+                        $imghash = postedVar('imghash');
                         if ($Captcha->ValidateCode($imgcode, $imghash) !== TRUE) {
-                            softerror($lang['captchaimageinvalid']);
+                            $errors .= softerror($lang['captchaimageinvalid']);
                             $replyvalid = FALSE;
                         }
                     }
@@ -422,13 +489,8 @@
         }
 
         if ($replyvalid) {
-            $attachedfile = FALSE;
-            if (isset($_FILES['attach'])) {
-                $attachedfile = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize']);
-            }
-
-            if (strlen(postedVar('subject')) == 0 && strlen($messageinput) == 0 && $attachedfile === FALSE) {
-                softerror($lang['postnothing']);
+            if (strlen(postedVar('subject')) == 0 && strlen($messageinput) == 0) {
+                $errors .= softerror($lang['postnothing']);
                 $replyvalid = FALSE;
             }
         }
@@ -438,7 +500,7 @@
                 $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
                 if ($db->num_rows($query) == 0) {
                     $posticon = '';
-                    softerror($lang['error']);
+                    $errors .= softerror($lang['error']);
                     $replyvalid = FALSE;
                 }
                 $db->free_result($query);
@@ -451,24 +513,25 @@
                 $rightnow = $onlinetime - $floodctrl;
                 if ($rightnow <= $lastpost[0] && $username == $lastpost[1]) {
                     $floodlink = "<a href=\"viewthread.php?fid=$fid&tid=$tid\">Click here</a>";
-                    softerror($lang['floodprotect'].' '.$floodlink.' '.$lang['tocont']);
+                    $errmsg = $lang['floodprotect'].' '.$floodlink.' '.$lang['tocont'];
+                    $errors .= softerror($errmsg);
                     $replyvalid = FALSE;
                 }
             }
         }
 
         if ($replyvalid) {
-            if ($usesig != "yes") {
-                $usesig = "no";
+            $thatime = $onlinetime;
+            if ($bBBcodeOnForThisPost) {
+                postLinkBBcode($messageinput);
             }
-
-            $thatime = $onlinetime;
             $dbmessage = $db->escape(addslashes($messageinput)); //The message column is historically double-quoted.
             $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
             $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ($fid, $tid, '$username', '$dbmessage', '$dbsubject', ".$db->time(time()).", '$posticon', '$usesig', '$onlineip', '$bbcodeoff', '$smileyoff')");
             $pid = $db->insert_id();
 
-            if ((X_STAFF) && $closetopic == 'yes') {
+            $moderator = (modcheck($username, $forum['moderator']) == 'Moderator');
+            if ($moderator && $closetopic == 'yes') {
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
             }
 
@@ -487,16 +550,15 @@
             $posts = $db->result($query,0);
             $db->free_result($query);
 
-            if ($posts > $ppp) {
-                $topicpages = quickpage($posts, $ppp);
-            } else {
-                $topicpages = 1;
-            }
-
-            $date = $db->result($db->query("SELECT dateline FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid < $pid ORDER BY pid ASC LIMIT 1"), 0);
-            $subquery = $db->query("SELECT m.email, m.lastvisit, m.ppp, m.status FROM ".X_PREFIX."favorites f LEFT JOIN ".X_PREFIX."members m ON (m.username=f.username) WHERE f.type='subscription' AND f.tid='$tid' AND f.username!= '$username'");
+            $lang2 = loadPhrases(array('charset','textsubsubject','textsubbody'));
+            $viewperm = getOneForumPerm($forum, X_PERMS_RAWVIEW);
+            $date = $db->result($db->query("SELECT dateline FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid < $pid ORDER BY dateline DESC LIMIT 1"), 0);
+            $subquery = $db->query("SELECT m.email, m.lastvisit, m.ppp, m.status, m.langfile "
+                                 . "FROM ".X_PREFIX."favorites f "
+                                 . "INNER JOIN ".X_PREFIX."members m USING (username) "
+                                 . "WHERE f.type = 'subscription' AND f.tid = $tid AND m.username != '$username' AND m.lastvisit >= $date");
             while($subs = $db->fetch_array($subquery)) {
-                if ($subs['status'] == 'banned' || $subs['lastvisit'] < $date) {
+                if ($viewperm < $status_enum[$subs['status']]) {
                     continue;
                 }
 
@@ -504,10 +566,21 @@
                     $subs['ppp'] = $posts;
                 }
 
+                $translate = $lang2[$subs['langfile']];
                 $topicpages = quickpage($posts, $subs['ppp']);
-                $threadurl = $SETTINGS['boardurl'] . 'viewthread.php?tid='.$tid.'&page='.$topicpages.'#pid'.$pid;
+                $topicpages = ($topicpages == 1) ? '' : '&page='.$topicpages;
+                $threadurl = $full_url.'viewthread.php?tid='.$tid.$topicpages.'#pid'.$pid;
                 $rawsubject = htmlspecialchars_decode($threadname, ENT_QUOTES);
-                altMail($subs['email'], $lang['textsubsubject'].' '.$rawsubject, $username.' '.$lang['textsubbody']." \n".$threadurl, "From: $bbname <$adminemail>");
+                $rawusername = htmlspecialchars_decode($username, ENT_QUOTES);
+                $rawemail = htmlspecialchars_decode($subs['email'], ENT_QUOTES);
+                $headers = array();
+                $headers[] = "From: $bbname <$adminemail>";
+                $headers[] = 'X-Mailer: PHP';
+                $headers[] = 'X-AntiAbuse: Board servername - '.$cookiedomain;
+                $headers[] = 'X-AntiAbuse: Username - '.$rawusername;
+                $headers[] = 'Content-Type: text/plain; charset='.$translate['charset'];
+                $headers = implode("\r\n", $headers);
+                altMail($rawemail, $rawsubject.' ('.$translate['textsubsubject'].')', $rawusername.' '.$translate['textsubbody']." \n".$threadurl, $headers);
             }
             $db->free_result($subquery);
 
@@ -519,19 +592,120 @@
                 $db->free_result($query);
             }
 
-            if ($attachedfile != FALSE) {
-                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$filetype', '$filesize', '$attachedfile', 0)");
+            if ($forum['attachstatus'] == 'on') {
+                if ($attachSkipped) {
+                    for ($i=1; $i<=$SETTINGS['filesperpost']; $i++) {
+                        if (isset($_FILES['attach'.$i])) {
+                            attachUploadedFile('attach'.$i, $pid);
+                        }
+                    }
+                    if ($SETTINGS['attach_remote_images'] == 'on' And $bIMGcodeOnForThisPost) {
+                        extractRemoteImages($pid, $messageinput);
+                        $newdbmessage = $db->escape(addslashes($messageinput));
+                        if ($newdbmessage != $dbmessage) { // Anonymous message was modified after save, in order to use the pid.
+                            $db->query("UPDATE ".X_PREFIX."posts SET message='$newdbmessage' WHERE pid=$pid");
+                        }
+                    }
+                } elseif ($username != 'Anonymous') {
+                    claimOrphanedAttachments($pid);
+                }
             }
 
             $topicpages = quickpage($posts, $ppp);
-            message($lang['replymsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
+            $topicpages = ($topicpages == 1) ? '' : '&page='.$topicpages;
+            message($lang['replymsg'], TRUE, '', '', $full_url."viewthread.php?tid={$tid}{$topicpages}#pid{$pid}", true, false, true);
         }
 
         if (!$replyvalid) {
+            if (isset($repquote) && ($repquote = (int) $repquote)) {
+                $query = $db->query("SELECT p.message, p.tid, p.fid, p.author FROM ".X_PREFIX."posts p WHERE p.pid=$repquote");
+                $thaquote = $db->fetch_array($query);
+                $db->free_result($query);
+                $quoteperms = checkForumPermissions(getForum($thaquote['fid']));
+                if ($quoteperms[X_PERMS_VIEW] And $quoteperms[X_PERMS_PASSWORD]) {
+                    $thaquote['message'] = preg_replace('@\\[file\\]\\d*\\[/file\\]@', '', $thaquote['message']); //These codes will not work inside quotes.
+                    //Note this bbcode is a pseudo-link. Treat it as cdata.  Do not recode the author string.
+                    $messageinput = "[rquote=$repquote&amp;tid={$thaquote['tid']}&amp;author={$thaquote['author']}]".rawHTMLmessage(stripslashes($thaquote['message']))."[/rquote]"; //Messages are historically double-quoted.
+                }
+            }
+
+            // Fill $attachfile
+            $files = array();
+            if ($forum['attachstatus'] == 'on' And $username != 'Anonymous') {
+                $attachfile = '';
+                $query = $db->query("SELECT a.aid, a.pid, a.filename, a.filetype, a.filesize, a.downloads, a.img_size, thumbs.aid AS thumbid, thumbs.filename AS thumbname, thumbs.img_size AS thumbsize FROM ".X_PREFIX."attachments AS a LEFT JOIN ".X_PREFIX."attachments AS thumbs ON a.aid=thumbs.parentid WHERE a.uid={$self['uid']} AND a.pid=0 AND a.parentid=0");
+                $counter = 0;
+                while ($postinfo = $db->fetch_array($query)) {
+                    $files[] = $postinfo;
+                    $postinfo['filename'] = attrOut($postinfo['filename']);
+                    $postinfo['filesize'] = number_format($postinfo['filesize'], 0, '.', ',');
+                    eval('$attachfile .= "'.template('post_attachment_orphan').'";');
+                    if ($bBBcodeOnForThisPost) {
+                        $bbcode = "[file]{$postinfo['aid']}[/file]";
+                        if (strpos($messageinput, $bbcode) === FALSE) {
+                            if ($counter == 0 Or $postinfo['img_size'] == '' Or $prevsize = '' Or $SETTINGS['attachimgpost'] == 'off') {
+                                $messageinput .= "\r\n\r\n";
+                            }
+                            $messageinput .= ' '.$bbcode; // Use a leading space to prevent awkward line wraps.
+                            $counter++;
+                            $prevsize = $postinfo['img_size'];
+                        }
+                    }
+                }
+                $maxtotal = phpShorthandValue('post_max_size');
+                if ($maxtotal > 0) {
+                    $lang['attachmaxtotal'] .= ' '.getSizeFormatted($maxtotal);
+                } else {
+                    $lang['attachmaxtotal'] = '';
+                }
+                $maxuploads = $SETTINGS['filesperpost'] - $db->num_rows($query);
+                if ($maxuploads > 0) {
+                    eval('$attachfile .= "'.template("post_attachmentbox").'";');
+                }
+                $db->free_result($query);
+            }
+
+            //Allow sanitized message to pass-through to template in case of: #1 preview, #2 post error
+            $subject = rawHTMLsubject(postedVar('subject', 'javascript', TRUE, FALSE, TRUE));
+            $message = rawHTMLmessage($messageinput);
+
+            if (isset($previewpost)) {
+                if ($posticon != '') {
+                    $thread['icon'] = "<img src=\"$smdir/$posticon\" />";
+                } else {
+                    $thread['icon'] = '';
+                }
+                $currtime = $onlinetime;
+                $date = gmdate($dateformat, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $time = gmdate($timecode, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
+                $dissubject = $subject;
+                if ($bBBcodeOnForThisPost) {
+                    postLinkBBcode($messageinput);
+                }
+                $message1 = postify($messageinput, $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+
+                if (count($files) > 0) {
+                    bbcodeFileTags($message1, $files, 0, $bBBcodeOnForThisPost);
+                }
+
+                if ($usesig == 'yes') {
+                    $post['sig'] = postify($self['sig'], 'no', 'no', $forum['allowsmilies'], $SETTINGS['sightml'], $SETTINGS['sigbbcode'], $forum['allowimgcode'], false);
+                    eval('$message1 .= "'.template('viewthread_post_sig').'";');
+                } else {
+                    eval('$message1 .= "'.template('viewthread_post_nosig').'";');
+                }
+
+                eval('$preview = "'.template('post_preview').'";');
+            }
+
             if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
                 $Captcha = new Captcha(250, 50);
                 if ($Captcha->bCompatible !== false) {
                     $imghash = $Captcha->GenerateCode();
+                    if ($SETTINGS['captcha_code_casesensitive'] == 'off') {
+                        $lang['captchacaseon'] = '';
+                    }
                     eval('$captchapostcheck = "'.template('post_captcha').'";');
                 }
                 unset($Captcha);
@@ -539,24 +713,12 @@
 
             $posts = '';
 
-            if (X_STAFF) {
+            if (modcheck($username, $forum['moderator']) == 'Moderator') {
                 $closeoption = '<br /><input type="checkbox" name="closetopic" value="yes" '.$closecheck.' /> '.$lang['closemsgques'].'<br />';
             } else {
                 $closeoption = '';
             }
 
-            if (isset($repquote) && ($repquote = (int) $repquote)) {
-                $query = $db->query("SELECT p.message, p.fid, p.author, f.postperm, f.userlist, f.password FROM ".X_PREFIX."posts p, ".X_PREFIX."forums f WHERE p.pid=$repquote AND f.fid=p.fid");
-                $thaquote = $db->fetch_array($query);
-                $db->free_result($query);
-                $quotefid = $thaquote['fid'];
-
-                $quoteperms = checkForumPermissions($thaquote);
-                if ($quoteperms[X_PERMS_VIEW] And $quoteperms[X_PERMS_USERLIST]) {
-                    $message = "[quote][i]{$lang['origpostedby']} {$thaquote['author']}[/i]\n".rawHTMLmessage(stripslashes($thaquote['message']))." [/quote]"; //Messages are historically double-quoted.
-                }
-            }
-
             $querytop = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
             $replynum = $db->result($querytop, 0);
             if ($replynum >= $ppp) {
@@ -577,6 +739,7 @@
                         $post['icon'] = '<img src="'.$imgdir.'/default_icon.gif" alt="[*]" border="0" />';
                     }
 
+                    $post['message'] = preg_replace('@\\[file\\]\\d*\\[/file\\]@', '', $post['message']); //These codes do not work in postify()
                     $post['message'] = postify(stripslashes($post['message']), $post['smileyoff'], $post['bbcodeoff'], $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
                     eval('$posts .= "'.template('post_reply_review_post').'";');
                     if ($thisbg == $altbg2) {
@@ -589,12 +752,11 @@
             }
             $db->free_result($querytop);
 
-            $rawperms = explode(',', $forum['postperm']);
-            if ($rawperms[X_PERMS_REPLY] == 32) { // Member posting is not allowed, do not request credentials!
+            if (getOneForumPerm($forum, X_PERMS_RAWREPLY) == $status_enum['Guest']) { // Member posting is not allowed, do not request credentials!
                 $loggedin = '';
             }
 
-            eval('echo "'.template('post_reply').'";');
+            eval('$postpage = "'.template('post_reply').'";');
         }
         break;
 
@@ -609,54 +771,85 @@
             $threadSubject = '- '.$dissubject;
         }
 
-        eval('echo "'.template('header').'";');
+        eval('$header = "'.template('header').'";');
 
         $pollanswers = postedVar('pollanswers', '', TRUE, FALSE);
         $topicvalid = onSubmit('topicsubmit'); // This new flag will indicate a message was submitted and successful.
 
+        if ($forum['attachstatus'] == 'on' And $username != 'Anonymous') {
+            for ($i=1; $i<=$SETTINGS['filesperpost']; $i++) {
+                if (isset($_FILES['attach'.$i])) {
+                    $result = attachUploadedFile('attach'.$i);
+                    if ($result < 0 And $result != X_EMPTY_UPLOAD) {
+                        $errors .= softerror($attachmentErrors[$result]);
+                        $topicvalid = FALSE;
+                    }
+                }
+            }
+            $result = doAttachmentEdits($deletes);
+            if ($result < 0) {
+                $errors .= softerror($attachmentErrors[$result]);
+                $topicvalid = FALSE;
+            }
+            foreach($deletes as $aid) {
+                $messageinput = str_replace("[file]{$aid}[/file]", '', $messageinput);
+            }
+            if ($SETTINGS['attach_remote_images'] == 'on' And $bIMGcodeOnForThisPost) {
+                $result = extractRemoteImages(0, $messageinput);
+                if ($result < 0) {
+                    $errors .= softerror($attachmentErrors[$result]);
+                    $topicvalid = FALSE;
+                }
+            }
+            $attachSkipped = FALSE;
+        } else {
+            $attachSkipped = TRUE;
+        }
+
         if ($topicvalid) {
             if (X_GUEST) { // Anonymous posting is allowed, and was checked in forum perms at top of file.
                 $password = '';
                 if (strlen(postedVar('username')) > 0 And isset($_POST['password'])) {
                     if (loginUser(postedVar('username'), md5($_POST['password']))) {
                         if ($self['status'] == "Banned") {
-                            softerror($lang['bannedmessage']);
+                            $errors .= softerror($lang['bannedmessage']);
                             $topicvalid = FALSE;
                         } else if ($self['ban'] == "posts" || $self['ban'] == "both") {
-                            softerror($lang['textbanfrompost']);
+                            $errors .= softerror($lang['textbanfrompost']);
                             $topicvalid = FALSE;
                         } else {
                             $username = $xmbuser;
 
                             // check permissions on this forum (and top forum if it's a sub?)
                             $perms = checkForumPermissions($forum);
-                            if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
-                                softerror($lang['privforummsg']);
+                            if (!$perms[X_PERMS_VIEW]) {
+                                $errors .= softerror($lang['privforummsg']);
                                 $topicvalid = FALSE;
                             } else if (($poll == '' && !$perms[X_PERMS_THREAD]) || ($poll == 'yes' && !$perms[X_PERMS_POLL])) {
-                                softerror($lang['textnoaction']);
+                                $errors .= softerror($lang['textnoaction']);
                                 $topicvalid = FALSE;
                             }
 
                             if ($forum['type'] == 'sub') {
                                 // prevent access to subforum when upper forum can't be viewed.
                                 $fupPerms = checkForumPermissions($fup);
-                                if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
-                                    softerror($lang['privforummsg']);
+                                if (!$fupPerms[X_PERMS_VIEW]) {
+                                    $errors .= softerror($lang['privforummsg']);
                                     $topicvalid = FALSE;
                                 }
                             }
                         }
                     } else {
-                        softerror($lang['textpw1']);
+                        $errors .= softerror($lang['textpw1']);
                         $topicvalid = FALSE;
                     }
                 } else if ($SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
                     $Captcha = new Captcha(250, 50);
                     if ($Captcha->bCompatible !== false) {
-                        $imghash = $db->escape($imghash);
+                        $imgcode = postedVar('imgcode', '', FALSE, FALSE);
+                        $imghash = postedVar('imghash');
                         if ($Captcha->ValidateCode($imgcode, $imghash) !== TRUE) {
-                            softerror($lang['captchaimageinvalid']);
+                            $errors .= softerror($lang['captchaimageinvalid']);
                             $topicvalid = FALSE;
                         }
                     }
@@ -667,7 +860,7 @@
 
         if ($topicvalid) {
             if (strlen(postedVar('subject')) == 0) {
-                softerror($lang['textnosubject']);
+                $errors .= softerror($lang['textnosubject']);
                 $topicvalid = FALSE;
             }
         }
@@ -677,7 +870,7 @@
                 $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
                 if ($db->num_rows($query) == 0) {
                     $posticon = '';
-                    softerror($lang['error']);
+                    $errors .= softerror($lang['error']);
                     $topicvalid = FALSE;
                 }
                 $db->free_result($query);
@@ -689,7 +882,7 @@
                 $lastpost = explode('|', $forum['lastpost']);
                 $rightnow = $onlinetime - $floodctrl;
                 if ($rightnow <= $lastpost[0] && $username == $lastpost[1]) {
-                    softerror($lang['floodprotect']);
+                    $errors .= softerror($lang['floodprotect']);
                     $topicvalid = FALSE;
                 }
             }
@@ -697,11 +890,18 @@
 
         if ($topicvalid) {
             if ($poll == 'yes') {
-                $pollopts = explode("\n", $pollanswers);
+                $pollopts = array();
+                $pollopts2 = explode("\n", $pollanswers);
+                foreach($pollopts2 as $value) {
+                    $value = trim($value);
+                    if ($value != '') {
+                        $pollopts[] = $value;
+                    }
+                }
                 $pnumnum = count($pollopts);
 
                 if ($pnumnum < 2) {
-                    softerror($lang['too_few_pollopts']);
+                    $errors .= softerror($lang['too_few_pollopts']);
                     $topicvalid = FALSE;
                 }
             }
@@ -710,6 +910,9 @@
         if ($topicvalid) {
             $thatime = $onlinetime;
 
+            if ($bBBcodeOnForThisPost) {
+                postLinkBBcode($messageinput);
+            }
             $dbmessage = $db->escape(addslashes($messageinput)); //The message column is historically double-quoted.
             $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
             $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$dbsubject', '$posticon', '$thatime|$username', 0, 0, '$username', '', 0)");
@@ -745,7 +948,7 @@
                 $vote_id =  $db->insert_id();
                 $i = 1;
                 foreach($pollopts as $p) {
-                    $p = $db->escape($p);
+                    $p = $db->escape_var($p);
                     $db->query("INSERT INTO ".X_PREFIX."vote_results (vote_id, vote_option_id, vote_option_text, vote_result) VALUES ($vote_id, $i, '$p', 0)");
                     $i++;
                 }
@@ -763,42 +966,128 @@
 
             $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+1 WHERE username='$username'");
 
-            if ((X_STAFF) && $toptopic == 'yes') {
-                $db->query("UPDATE ".X_PREFIX."threads SET topped='1' WHERE tid='$tid' AND fid='$fid'");
+            $moderator = (modcheck($username, $forum['moderator']) == 'Moderator');
+            if ($moderator) {
+                if ($toptopic == 'yes') {
+                    $db->query("UPDATE ".X_PREFIX."threads SET topped='1' WHERE tid='$tid' AND fid='$fid'");
+                }
+                if ($closetopic == 'yes') {
+                    $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
+                }
             }
 
-            if ((X_STAFF) && $closetopic == 'yes') {
-                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
+            if ($forum['attachstatus'] == 'on') {
+                if ($attachSkipped) {
+                    for ($i=1; $i<=$SETTINGS['filesperpost']; $i++) {
+                        if (isset($_FILES['attach'.$i])) {
+                            attachUploadedFile('attach'.$i, $pid);
+                        }
+                    }
+                    if ($SETTINGS['attach_remote_images'] == 'on' And $bIMGcodeOnForThisPost) {
+                        extractRemoteImages($pid, $messageinput);
+                        $newdbmessage = $db->escape(addslashes($messageinput));
+                        if ($newdbmessage != $dbmessage) { // Anonymous message was modified after save, in order to use the pid.
+                            $db->query("UPDATE ".X_PREFIX."posts SET message='$newdbmessage' WHERE pid=$pid");
+                        }
+                    }
+                } elseif ($username != 'Anonymous') {
+                    claimOrphanedAttachments($pid);
+                }
             }
 
-            $attachedfile = FALSE;
-            if (isset($_FILES['attach'])) {
-                $attachedfile = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize']);
-            }
-
-            if ($attachedfile !== FALSE) {
-                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$filetype', '$filesize', '$attachedfile', 0)");
-            }
-
             $query = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
             $posts = $db->result($query, 0);
             $db->free_result($query);
 
             $topicpages = quickpage($posts, $ppp);
-            message($lang['postmsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
+            $topicpages = ($topicpages == 1) ? '' : '&page='.$topicpages;
+            message($lang['postmsg'], TRUE, '', '', $full_url."viewthread.php?tid={$tid}{$topicpages}#pid{$pid}", true, false, true);
         }
 
         if (!$topicvalid) {
+            // Fill $attachfile
+            $files = array();
+            if ($forum['attachstatus'] == 'on' And $username != 'Anonymous') {
+                $attachfile = '';
+                $query = $db->query("SELECT a.aid, a.pid, a.filename, a.filetype, a.filesize, a.downloads, a.img_size, thumbs.aid AS thumbid, thumbs.filename AS thumbname, thumbs.img_size AS thumbsize FROM ".X_PREFIX."attachments AS a LEFT JOIN ".X_PREFIX."attachments AS thumbs ON a.aid=thumbs.parentid WHERE a.uid={$self['uid']} AND a.pid=0 AND a.parentid=0");
+                $counter = 0;
+                while ($postinfo = $db->fetch_array($query)) {
+                    $files[] = $postinfo;
+                    $postinfo['filename'] = attrOut($postinfo['filename']);
+                    $postinfo['filesize'] = number_format($postinfo['filesize'], 0, '.', ',');
+                    eval('$attachfile .= "'.template('post_attachment_orphan').'";');
+                    if ($bBBcodeOnForThisPost) {
+                        $bbcode = "[file]{$postinfo['aid']}[/file]";
+                        if (strpos($messageinput, $bbcode) === FALSE) {
+                            if ($counter == 0 Or $postinfo['img_size'] == '' Or $prevsize == '' Or $SETTINGS['attachimgpost'] == 'off') {
+                                $messageinput .= "\r\n\r\n";
+                            }
+                            $messageinput .= ' '.$bbcode; // Use a leading space to prevent awkward line wraps.
+                            $counter++;
+                            $prevsize = $postinfo['img_size'];
+                        }
+                    }
+                }
+                $maxtotal = phpShorthandValue('post_max_size');
+                if ($maxtotal > 0) {
+                    $lang['attachmaxtotal'] .= ' '.getSizeFormatted($maxtotal);
+                } else {
+                    $lang['attachmaxtotal'] = '';
+                }
+                $maxuploads = $SETTINGS['filesperpost'] - $db->num_rows($query);
+                if ($maxuploads > 0) {
+                    eval('$attachfile .= "'.template("post_attachmentbox").'";');
+                }
+                $db->free_result($query);
+            }
+
+            //Allow sanitized message to pass-through to template in case of: #1 preview, #2 post error
+            $subject = rawHTMLsubject(postedVar('subject', 'javascript', TRUE, FALSE, TRUE));
+            $message = rawHTMLmessage($messageinput);
+
+            if (isset($previewpost)) {
+                if ($posticon != '') {
+                    $thread['icon'] = "<img src=\"$smdir/$posticon\" />";
+                } else {
+                    $thread['icon'] = '';
+                }
+                $currtime = $onlinetime;
+                $date = gmdate($dateformat, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $time = gmdate($timecode, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
+                $dissubject = $subject;
+                if ($bBBcodeOnForThisPost) {
+                    postLinkBBcode($messageinput);
+                }
+                $message1 = postify($messageinput, $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+
+                if (count($files) > 0) {
+                    bbcodeFileTags($message1, $files, 0, $bBBcodeOnForThisPost);
+                }
+
+                if ($usesig == 'yes') {
+                    $post['sig'] = postify($self['sig'], 'no', 'no', $forum['allowsmilies'], $SETTINGS['sightml'], $SETTINGS['sigbbcode'], $forum['allowimgcode'], false);
+                    eval('$message1 .= "'.template('viewthread_post_sig').'";');
+                } else {
+                    eval('$message1 .= "'.template('viewthread_post_nosig').'";');
+                }
+
+                eval('$preview = "'.template('post_preview').'";');
+            }
+
             if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
                 $Captcha = new Captcha(250, 50);
                 if ($Captcha->bCompatible !== false) {
                     $imghash = $Captcha->GenerateCode();
+                    if ($SETTINGS['captcha_code_casesensitive'] == 'off') {
+                        $lang['captchacaseon'] = '';
+                    }
                     eval('$captchapostcheck = "'.template('post_captcha').'";');
                 }
                 unset($Captcha);
             }
 
-            if (X_STAFF) {
+            if (modcheck($username, $forum['moderator']) == 'Moderator') {
                 $topoption = '<br /><input type="checkbox" name="toptopic" value="yes" '.$topcheck.' /> '.$lang['topmsgques'];
                 $closeoption = '<br /><input type="checkbox" name="closetopic" value="yes" '.$closecheck.' /> '.$lang['closemsgques'].'<br />';
             } else {
@@ -810,15 +1099,14 @@
                 $spelling_submit2 = '';
             }
 
-            $rawperms = explode(',', $forum['postperm']);
-            if ($rawperms[X_PERMS_THREAD] == 32) { // Member posting is not allowed, do not request credentials!
+            if (getOneForumPerm($forum, X_PERMS_RAWTHREAD) == $status_enum['Guest']) { // Member posting is not allowed, do not request credentials!
                 $loggedin = '';
             }
 
             if (isset($poll) && $poll == 'yes') {
-                eval('echo "'.template('post_newpoll').'";');
+                eval('$postpage = "'.template('post_newpoll').'";');
             } else {
-                eval('echo "'.template('post_newthread').'";');
+                eval('$postpage = "'.template('post_newthread').'";');
             }
         }
         break;
@@ -831,32 +1119,60 @@
             $threadSubject = '- '.$threadname;
         }
 
-        eval('echo "'.template('header').'";');
+        eval('$header = "'.template('header').'";');
 
-        $editvalid = onSubmit('editsubmit'); // This new flag will indicate a message was submitted and successful.
+        $editvalid = TRUE; // This new flag will indicate a message was submitted and successful.
 
         //Check all editing permissions for this $pid.  Based on viewthread design, forum Moderators can always edit, $orig['author'] can edit open threads only.
-        $query = $db->query("SELECT p.author as author, m.status as status, p.subject as subject FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON p.author=m.username WHERE pid=$pid");
+        $query = $db->query("SELECT p.*, m.status FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON p.author=m.username WHERE p.pid=$pid");
         $orig = $db->fetch_array($query);
         $db->free_result($query);
 
         $status1 = modcheckPost($self['username'], $forum['moderator'], $orig['status']);
 
         if ($status1 != 'Moderator' And ($self['username'] != $orig['author'] Or $thread['closed'] != '')) {
-            if ($editvalid) {
-                softerror($lang['noedit']);
-            } else {
-                error($lang['noedit']);
-            }
+            $errors .= softerror($lang['noedit']);
             $editvalid = FALSE;
         }
 
         if ($editvalid) {
+            if ($forum['attachstatus'] == 'on') {
+                for ($i=1; $i<=$SETTINGS['filesperpost']; $i++) {
+                    if (isset($_FILES['attach'.$i])) {
+                        $result = attachUploadedFile('attach'.$i, $pid);
+                        if ($result < 0 And $result != X_EMPTY_UPLOAD) {
+                            $errors .= softerror($attachmentErrors[$result]);
+                            $editvalid = FALSE;
+                        }
+                    }
+                }
+                $result = doAttachmentEdits($deletes, $pid);
+                if ($result < 0) {
+                    $errors .= softerror($attachmentErrors[$result]);
+                    $editvalid = FALSE;
+                }
+                foreach($deletes as $aid) {
+                    $messageinput = str_replace("[file]{$aid}[/file]", '', $messageinput);
+                }
+                $temp = '';
+                if ($SETTINGS['attach_remote_images'] == 'on' And $bIMGcodeOnForThisPost) {
+                    $result = extractRemoteImages($pid, $messageinput);
+                    if ($result < 0) {
+                        $errors .= softerror($attachmentErrors[$result]);
+                        $editvalid = FALSE;
+                    }
+                }
+            }
+        }
+
+        $editvalid &= onSubmit('editsubmit');
+
+        if ($editvalid) {
             if ($posticon != '') {
                 $query = $db->query("SELECT id FROM ".X_PREFIX."smilies WHERE type='picon' AND url='$posticon'");
                 if ($db->num_rows($query) == 0) {
                     $posticon = '';
-                    softerror($lang['error']);
+                    $errors .= softerror($lang['error']);
                     $editvalid = FALSE;
                 }
                 $db->free_result($query);
@@ -864,12 +1180,12 @@
         }
 
         if ($editvalid) {
-            $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline LIMIT 1");
+            $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline LIMIT 1");
             $isfirstpost = $db->fetch_array($query);
             $db->free_result($query);
 
             if ((strlen(postedVar('subject')) == 0 && $pid == $isfirstpost['pid']) && !(isset($delete) && $delete == 'yes')) {
-                softerror($lang['textnosubject']);
+                $errors .= softerror($lang['textnosubject']);
                 $editvalid = FALSE;
             }
         }
@@ -877,114 +1193,151 @@
         if ($editvalid) {
             $threaddelete = 'no';
 
-            $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
-            if ($isfirstpost['pid'] == $pid && !(isset($delete) && $delete == 'yes')) {
-                $db->query("UPDATE ".X_PREFIX."threads SET icon='$posticon', subject='$dbsubject' WHERE tid='$tid'");
-            }
+            if (!(isset($delete) && $delete == 'yes')) {
+                if ($SETTINGS['editedby'] == 'on') {
+                    $messageinput .= "\n\n[".$lang['textediton'].' '.gmdate($dateformat).' '.$lang['textby']." $username]";
+                }
 
-            if ($SETTINGS['editedby'] == 'on') {
-                $messageinput .= "\n\n[".$lang['textediton'].' '.gmdate($dateformat).' '.$lang['textby']." $username]";
-            }
+                if ($bBBcodeOnForThisPost) {
+                    postLinkBBcode($messageinput);
+                }
+                $dbmessage = $db->escape(addslashes($messageinput)); //The subject and message columns are historically double-quoted.
+                $dbsubject = addslashes(postedVar('subject', 'javascript', TRUE, TRUE, TRUE));
 
-            $dbmessage = $db->escape(addslashes($messageinput)); //The subject and message columns are historically double-quoted.
-            $db->query("UPDATE ".X_PREFIX."posts SET message='$dbmessage', usesig='$usesig', bbcodeoff='$bbcodeoff', smileyoff='$smileyoff', icon='$posticon', subject='$dbsubject' WHERE pid='$pid'");
+                if ($isfirstpost['pid'] == $pid) {
+                    $db->query("UPDATE ".X_PREFIX."threads SET icon='$posticon', subject='$dbsubject' WHERE tid=$tid");
+                }
 
-            if (isset($_FILES['attach']) && ($file = get_attached_file($_FILES['attach'], $forum['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
-                $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attach[type]', '$filesize', '$file', 0)");
-            }
+                $db->query("UPDATE ".X_PREFIX."posts SET message='$dbmessage', usesig='$usesig', bbcodeoff='$bbcodeoff', smileyoff='$smileyoff', icon='$posticon', subject='$dbsubject' WHERE pid=$pid");
+            } else {
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid=$pid");
+                $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape_var($orig['author'])."'");
+                deleteAllAttachments($pid);
 
-            if (isset($attachment) && is_array($attachment)) {
-                switch($attachment['action']) {
-                    case 'replace':
-                        if (isset($_FILES['attachment_replace']) && ($file = get_attached_file($_FILES['attachment_replace'], $forum['attachstatus'], $SETTINGS['maxattachsize'])) !== false) {
-                            $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                            $db->query("INSERT INTO ".X_PREFIX."attachments (tid, pid, filename, filetype, filesize, attachment, downloads) VALUES ($tid, $pid, '$filename', '$attachment_replace[type]', '$filesize', '$file', 0)");
-                        }
-                        break;
-                    case 'rename':
-                        $rename = trim(postedVar('attach_name', '', FALSE, FALSE));
-                        if (isValidFilename($rename)) {
-                            $dbrename = $db->escape($rename);
-                            $db->query("UPDATE ".X_PREFIX."attachments SET filename='$dbrename' WHERE pid=$pid");
-                        }
-                        break;
-                    case 'delete':
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                        break;
-                    default:
-                        break;
-                }
-            }
+                if ($isfirstpost['pid'] == $pid) {
+                    $query = $db->query("SELECT COUNT(pid) AS pcount FROM ".X_PREFIX."posts WHERE tid=$tid");
+                    $numrows = $db->fetch_array($query);
+                    $numrows = $numrows['pcount'];
+                    $db->free_result($query);
 
-            if (isset($delete) && $delete == 'yes' && !($isfirstpost['pid'] == $pid)) {
-                $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($orig['author'])."'");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
-                updatethreadcount($tid);
-                updateforumcount($fid);
-            } else if (isset($delete) && $delete == 'yes' && $isfirstpost['pid'] == $pid) {
-                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                $numrows = $db->num_rows($query);
-                $db->free_result($query);
+                    if ($numrows == 0) {
+                        $threaddelete = 'yes';
+                        $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$tid'");
 
-                if ($numrows == 1) {
-                    $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                    while($result = $db->fetch_array($query)) {
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($result['author'])."'");
+                        $db->query("DELETE FROM d, r, v "
+                                 . "USING ".X_PREFIX."vote_desc AS d "
+                                 . "LEFT JOIN ".X_PREFIX."vote_results AS r ON r.vote_id = d.vote_id "
+                                 . "LEFT JOIN ".X_PREFIX."vote_voters AS v  ON v.vote_id = d.vote_id "
+                                 . "WHERE d.topic_id = $tid");
+
+                        $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid=$tid OR closed='moved|$tid'");
+                    } else {
+                        $db->query("UPDATE ".X_PREFIX."posts SET subject='".$db->escape_var($orig['subject'])."' WHERE tid=$tid ORDER BY dateline LIMIT 1");
                     }
-                    $db->free_result($query);
-                    $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$tid'");
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid='$tid'");
-                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                    $threaddelete = 'yes';
                 }
-
-                if ($numrows > 1) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($orig['author'])."'");
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid='$pid'");
-                    $db->query("UPDATE ".X_PREFIX."posts SET subject='".$db->escape($orig['subject'])."' WHERE tid='$tid' ORDER BY dateline ASC LIMIT 1");
-                    $threaddelete = 'no';
-                }
                 updatethreadcount($tid);
                 updateforumcount($fid);
             }
 
-            if ($threaddelete != 'yes') {
-                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE pid <= '$pid' AND tid='$tid' AND fid='$fid'");
+            if ($threaddelete == 'no') {
+                $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE dateline <= {$orig['dateline']} AND tid=$tid");
                 $posts = $db->result($query,0);
                 $db->free_result($query);
                 $topicpages = quickpage($posts, $ppp);
-                message($lang['editpostmsg'], false, '', '', "viewthread.php?tid=${tid}&page=${topicpages}#pid${pid}", true, false, true);
+                $topicpages = ($topicpages == 1) ? '' : '&page='.$topicpages;
+                message($lang['editpostmsg'], TRUE, '', '', $full_url."viewthread.php?tid={$tid}{$topicpages}#pid{$pid}", true, false, true);
             } else {
-                message($lang['editpostmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+                message($lang['editpostmsg'], TRUE, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
             }
         }
 
         if (!$editvalid) {
+            // Fill $postinfo
             $subjectinput = postedVar('subject', 'javascript', TRUE, FALSE, TRUE);
-            if (onSubmit('editsubmit') || isset($previewpost) || (isset($subaction) && $subaction == 'spellcheck' && (isset($spellchecksubmit) || isset($updates_submit)))) {
+            if (onSubmit('editsubmit') || isset($previewpost) || $sc) {
                 $postinfo = array("usesig"=>$usesig, "bbcodeoff"=>$bbcodeoff, "smileyoff"=>$smileyoff, "message"=>$messageinput, "subject"=>$subjectinput, 'icon'=>$posticon);
-                $query = $db->query("SELECT filename, filesize, downloads FROM ".X_PREFIX."attachments WHERE pid='$pid' AND tid='$tid'");
-                if ($db->num_rows($query) > 0) {
-                    $postinfo = array_merge($postinfo, $db->fetch_array($query));
-                }
-                $db->free_result($query);
             } else {
-                $query = $db->query("SELECT a.filename, a.filesize, a.downloads, p.* FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."attachments a  ON (a.pid=p.pid) WHERE p.pid='$pid' AND p.tid='$tid' AND p.fid=".$forum['fid']);
-                $postinfo = $db->fetch_array($query);
-                $db->free_result($query);
+                $postinfo = $orig;
                 $postinfo['message'] = stripslashes($postinfo['message']); //Messages are historically double-quoted.
                 $postinfo['subject'] = stripslashes($postinfo['subject']);
+                $bBBcodeOnForThisPost = ($forum['allowbbcode'] == 'yes' And $postinfo['bbcodeoff'] == 'no');
+                $bIMGcodeOnForThisPost = ($bBBcodeOnForThisPost And $forum['allowimgcode'] == 'yes');
+                $bSmiliesOnForThisPost = ($forum['allowsmilies'] == 'yes' And $postinfo['smileyoff'] = 'no');
             }
 
-            //update
-            if (isset($postinfo['filesize'])) {
-                $postinfo['filesize'] = number_format($postinfo['filesize'], 0, '.', ',');
+            // Fill $attachment
+            $attachment = '';
+            $query = $db->query("SELECT a.aid, a.pid, a.filename, a.filetype, a.filesize, a.downloads, a.img_size, thumbs.aid AS thumbid, thumbs.filename AS thumbname, thumbs.img_size AS thumbsize FROM ".X_PREFIX."attachments AS a LEFT JOIN ".X_PREFIX."attachments AS thumbs ON a.aid=thumbs.parentid WHERE a.pid=$pid AND a.parentid=0");
+            $counter = 0;
+            $files = array();
+            while ($attach = $db->fetch_array($query)) {
+                $files[] = $attach;
+                $postinfo['aid'] = $attach['aid'];
+                $postinfo['downloads'] = $attach['downloads'];
+                $postinfo['filename'] = attrOut($attach['filename']);
+                $postinfo['filesize'] = number_format($attach['filesize'], 0, '.', ',');
+                $postinfo['url'] = getAttachmentURL($attach['aid'], $pid, $attach['filename']);
+                eval('$attachment .= "'.template('post_edit_attachment').'";');
+                if ($bBBcodeOnForThisPost) {
+                    $bbcode = "[file]{$attach['aid']}[/file]";
+                    if (strpos($postinfo['message'], $bbcode) === FALSE) {
+                        if ($counter == 0 Or $attach['img_size'] == '' Or $prevsize = '' Or $SETTINGS['attachimgpost'] == 'off') {
+                            $postinfo['message'] .= "\r\n\r\n";
+                        }
+                        $postinfo['message'] .= ' '.$bbcode; // Use a leading space to prevent awkward line wraps.
+                        $counter++;
+                        $prevsize = $attach['img_size'];
+                    }
+                }
             }
+            $maxtotal = phpShorthandValue('post_max_size');
+            if ($maxtotal > 0) {
+                $lang['attachmaxtotal'] .= ' '.getSizeFormatted($maxtotal);
+            } else {
+                $lang['attachmaxtotal'] = '';
+            }
+            $maxuploads = $SETTINGS['filesperpost'] - $db->num_rows($query);
+            if ($maxuploads > 0) {
+                eval('$attachment .= "'.template("post_attachmentbox").'";');
+            }
+            $db->free_result($query);
 
-            if (isset($postinfo['filename'])) {
-                $postinfo['filename'] = attrOut($postinfo['filename']);
+            //Allow sanitized message to pass-through to template in case of: #1 preview, #2 post error
+            $subject = rawHTMLsubject($postinfo['subject']);
+            $message = rawHTMLmessage($postinfo['message']);
+
+            if (isset($previewpost)) {
+                if ($postinfo['icon'] != '') {
+                    $thread['icon'] = "<img src=\"$smdir/{$postinfo['icon']}\" />";
+                } else {
+                    $thread['icon'] = '';
+                }
+                $currtime = $onlinetime;
+                $date = gmdate($dateformat, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $time = gmdate($timecode, $currtime + ($timeoffset * 3600) + ($addtime * 3600));
+                $poston = $lang['textposton'].' '.$date.' '.$lang['textat'].' '.$time;
+                $dissubject = $subject;
+                $message1 = $postinfo['message'];
+                if ($SETTINGS['editedby'] == 'on') {
+                    $message1 .= "\n\n[".$lang['textediton'].' '.gmdate($dateformat).' '.$lang['textby']." $username]";
+                }
+                if ($bBBcodeOnForThisPost) {
+                    postLinkBBcode($message1);
+                }
+                $message1 = postify($message1, $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+
+                if (count($files) > 0) {
+                    bbcodeFileTags($message1, $files, $pid, $bBBcodeOnForThisPost);
+                }
+
+                if ($usesig == 'yes') {
+                    $post['sig'] = postify($self['sig'], 'no', 'no', $forum['allowsmilies'], $SETTINGS['sightml'], $SETTINGS['sigbbcode'], $forum['allowimgcode'], false);
+                    eval('$message1 .= "'.template('viewthread_post_sig').'";');
+                } else {
+                    eval('$message1 .= "'.template('viewthread_post_nosig').'";');
+                }
+
+                eval('$preview = "'.template('post_preview').'";');
             }
 
             if ($postinfo['bbcodeoff'] == 'yes') {
@@ -1005,30 +1358,12 @@
                 $offcheck3 = '';
             }
 
-            $querysmilie = $db->query("SELECT * FROM ".X_PREFIX."smilies WHERE type='picon'");
-            while($smilie = $db->fetch_array($querysmilie)) {
-                if ($postinfo['icon'] == $smilie['url']) {
-                    $icons .= " <input type=\"radio\" name=\"posticon\" value=\"$smilie[url]\" checked=\"checked\"/><img src=\"$smdir/$smilie[url]\" alt=\"$smilie[code]\" />";
-                } else {
-                    $icons .= " <input type=\"radio\" name=\"posticon\" value=\"$smilie[url]\" /><img src=\"$smdir/$smilie[url]\" alt=\"$smilie[code]\" />";
-                }
-                $listed_icons += 1;
-                if ($listed_icons == 9) {
-                    $icons .= '<br />';
-                    $listed_icons = 0;
-                }
-            }
-            $db->free_result($querysmilie);
+            $icons = str_replace('<input type="radio" name="posticon" value="'.$postinfo['icon'].'" />', '<input type="radio" name="posticon" value="'.$postinfo['icon'].'" checked="checked" />', $icons);
 
             $postinfo['message'] = rawHTMLmessage($postinfo['message']);
             $postinfo['subject'] = rawHTMLsubject($postinfo['subject']);
 
-            if (isset($postinfo['filename']) && $postinfo['filename'] != '') {
-                eval('$attachment = "'.template('post_edit_attachment').'";');
-            } else {
-                $attachment = $attachfile;
-            }
-            eval('echo "'.template('post_edit').'";');
+            eval('$postpage = "'.template('post_edit').'";');
         }
         break;
 
@@ -1038,19 +1373,41 @@
 }
 
 end_time();
-eval('echo "'.template('footer').'";');
+eval('$footer = "'.template('footer').'";');
+echo $header.$errors.$postpage.$footer;
 
-function bbcodeinsert() {
-    global $imgdir, $bbinsert, $altbg1, $altbg2, $lang, $SETTINGS, $spelling_lang;
+function postLinkBBcode(&$message) {
+    global $db;
+    
+    $items = array();
+    $pattern = "@\\[pid](\\d+)\\[/pid]@si";
+    preg_match_all($pattern, $message, $results, PREG_SET_ORDER);
+    if (count($results) == 0) {
+        return TRUE;
+    }
+    foreach($results as $result) {
+        $items[] = $result[1];
+    }
 
-    $bbcode = '';
-    if ($SETTINGS['bbinsert'] == 'on') {
-        eval('$bbcode = "'.template('functions_bbcodeinsert').'";');
+    $pids = implode(', ', $items);
+    $query = $db->query("SELECT p.pid, p.tid, p.subject, t.subject AS tsubject, t.fid FROM ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) WHERE pid IN ($pids)");
+    while($row = $db->fetch_array($query)) {
+        $perms = checkForumPermissions(getForum($row['fid']));
+        if ($perms[X_PERMS_VIEW] And $perms[X_PERMS_PASSWORD]) {
+            if ($row['subject'] != '') {
+                $subject = stripslashes($row['subject']);
+            } else {
+                $subject = stripslashes($row['tsubject']);
+            }
+            $pattern = "[pid]{$row['pid']}[/pid]";
+            $replacement = "[pid={$row['pid']}&amp;tid={$row['tid']}]{$subject}[/pid]";
+            $message = str_replace($pattern, $replacement, $message);
+        }
     }
-    return $bbcode;
+    return TRUE;
 }
 
-function softerror($msg) {
-    error($msg, FALSE, '', '', FALSE, FALSE, FALSE, FALSE);
+function softerror(&$msg) {
+    return error($msg, FALSE, '', '', FALSE, FALSE, TRUE, FALSE);
 }
 ?>
Index: stats.php
===================================================================
--- stats.php	(revision 1746)
+++ stats.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -36,41 +35,16 @@
 
 smcwcache();
 
-eval('$css = "'.template('css').'";');
-
-eval('echo "'.template('header').'";');
-
 if ($SETTINGS['stats'] == 'off') {
-    error($lang['fnasorry3'], false);
+    header('HTTP/1.0 403 Forbidden');
+    error($lang['fnasorry3'], TRUE);
 }
 
-if (X_SADMIN) {
-    $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
-    while($f = $db->fetch_array($q)) {
-        $fids[] = $f['fid'];
-    }
-} else {
-    $fCache = array();
-    $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
-    while($forum = $db->fetch_array($q)) {
-        $perms = checkForumPermissions($forum);
-        $fCache[$forum['fid']] = $perms;
+setCanonicalLink('stats.php');
+eval('$css = "'.template('css').'";');
+eval('$header = "'.template('header').'";');
 
-        if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
-            if ($forum['type'] == 'sub') {
-                // also check above forum!
-                $parentP = $fCache[$forum['fup']];
-                if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
-                    $fids[] = $forum['fid'];
-                }
-            } else {
-                $fids[] = $forum['fid'];
-            }
-        }
-    }
-}
-
-$fids = implode(',', $fids);
+$fids = permittedForums(forumCache(), 'thread', 'csv');
 $restrict = ' fid IN ('.$fids.')';
 
 $query = $db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members UNION ALL SELECT COUNT(tid) FROM ".X_PREFIX."threads UNION ALL SELECT COUNT(pid) FROM ".X_PREFIX."posts");
@@ -116,7 +90,7 @@
 
 // In case any of these is 0, the stats will show wrong info, take care of that
 if ($posts == 0 || $members == 0 || $threads == 0 || $forums == 0 || $days < 1) {
-    message($lang['stats_incomplete'], false);
+    message($lang['stats_incomplete']);
 }
 
 // Get amount of posts per user
@@ -142,7 +116,7 @@
 
 // Get top 5 most viewed threads
 $viewmost = array();
-$query = $db->query("SELECT views, tid, subject FROM ".X_PREFIX."threads WHERE $restrict GROUP BY tid ORDER BY views DESC LIMIT 5");
+$query = $db->query("SELECT views, tid, subject FROM ".X_PREFIX."threads WHERE $restrict ORDER BY views DESC LIMIT 5");
 while($views = $db->fetch_array($query)) {
     $views['subject'] = shortenString(rawHTMLsubject(stripslashes($views['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
     $viewmost[] = '<a href="viewthread.php?tid='.intval($views['tid']).'">'.$views['subject'].'</a> ('.$views['views'].')';
@@ -152,7 +126,7 @@
 
 // Get top 5 most replied to threads
 $replymost = array();
-$query = $db->query("SELECT replies, tid, subject FROM ".X_PREFIX."threads WHERE $restrict GROUP BY tid ORDER BY replies DESC LIMIT 5");
+$query = $db->query("SELECT replies, tid, subject FROM ".X_PREFIX."threads WHERE $restrict ORDER BY replies DESC LIMIT 5");
 while($reply = $db->fetch_array($query)) {
     $reply['subject'] = shortenString(rawHTMLsubject(stripslashes($reply['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
     $replymost[] = '<a href="viewthread.php?tid='.intval($reply['tid']).'">'.$reply['subject'].'</a> ('.$reply['replies'].')';
@@ -162,7 +136,7 @@
 
 // Get last 5 posts
 $latest = array();
-$query = $db->query("SELECT lastpost, tid, subject FROM ".X_PREFIX."threads WHERE $restrict GROUP BY tid ORDER BY lastpost DESC LIMIT 5");
+$query = $db->query("SELECT lastpost, tid, subject FROM ".X_PREFIX."threads WHERE $restrict ORDER BY lastpost DESC LIMIT 5");
 $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
 while($last = $db->fetch_array($query)) {
     $lpdate = gmdate($dateformat, $last['lastpost'] + $adjTime);
@@ -220,8 +194,9 @@
 eval($lang['evalstats14']);
 eval($lang['evalstats15']);
 
-eval('echo "'.template('feature_statistics').'";');
+eval('$statspage = "'.template('feature_statistics').'";');
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$statspage.$footer;
+?>
Index: templates.xmb
===================================================================
--- templates.xmb	(revision 1746)
+++ templates.xmb	(working copy)
@@ -1,6 +1,6 @@
 admintool_editprofile|#*XMB TEMPLATE*#|
-<form method="post" action="editprofile.php?user=$userrecode" name="reg">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="editprofile.php?user=$userrecode" name="reg">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -9,17 +9,39 @@
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textpassword]</td>
-<td bgcolor="$altbg2"><input type="password" name="newpassword" size="25" />&nbsp;$lang[pwnote]</td>
+<td bgcolor="$altbg1" width="22%">{$lang['textusername']}</td>
+<td bgcolor="$altbg2">{$member['username']}</td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textemail]</td>
-<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /><br /><a href="http://network-tools.com/default.asp?prog=validate&amp;host=$member[email]" target="_blank">$lang[adminverifyemail]</a></td>
+<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /><br /><a href="http://network-tools.com/default.asp?prog=validate&amp;host=$member[email]" onclick="window.open(this.href); return false;">$lang[adminverifyemail]</a></td>
 </tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">{$lang['textstatus']}</td>
+<td bgcolor="$altbg2"><select name="status">
+<option value="Super Administrator" $sadminselect>{$lang['superadmin']}</option>
+<option value="Administrator" $adminselect>{$lang['textadmin']}</option>
+<option value="Super Moderator" $smodselect>{$lang['textsupermod']}</option>
+<option value="Moderator" $modselect>{$lang['textmod']}</option>
+<option value="Member" $memselect>{$lang['textmem']}</option>
+<option value="Banned" $banselect>{$lang['textbanned']}</option>
+</select></td>
+</tr>
 <tr>
+<td colspan="2" class="category"><font color="$cattext"><strong>$lang[pwchange] - $lang[optional]</strong></font></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textnewpassword]</td>
+<td bgcolor="$altbg2"><input type="password" name="newpassword" size="25" />&nbsp;$lang[pwnote]</td>
+</tr>
+<tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[optional]</strong></font></td>
 </tr>
 <tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">{$lang['textcusstatus']}:</td>
+<td bgcolor="$altbg2"><input type="text" name="cusstatus" size="25" value="$custout" /></td>
+</tr>
+<tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textsite]</td>
 <td bgcolor="$altbg2"><input type="text" name="newsite" size="25" value="$member[site]" /></td>
 </tr>
@@ -50,11 +72,13 @@
 $avatar
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textbio]</td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newbio">$member[bio]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newbio">
+$member[bio]</textarea></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textsig]<br /><span class="smalltxt">$lang[texthtmlis] $htmlis<br />$lang[textbbcodeis] $bbcodeis</span></td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newsig">$member[sig]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newsig">
+$member[sig]</textarea></td>
 </tr>
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[textoptions]</strong></font></td>
@@ -110,6 +134,16 @@
 </td>
 </tr>
 <tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[u2ualert1]</td>
+<td bgcolor="$altbg2">
+<select name="u2ualert">
+<option value="2" $u2uasel2>$lang[u2ualert2]</option>
+<option value="1" $u2uasel1>$lang[u2ualert3]</option>
+<option value="0" $u2uasel0>$lang[u2ualert4]</option>
+</select>
+</td>
+</tr>
+<tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[texttimeformat]</td>
 <td bgcolor="$altbg2"><input type="radio" value="24" name="timeformatnew" $check24 />&nbsp;$lang[text24hour]&nbsp;<input type="radio" value="12" name="timeformatnew" $check12 />&nbsp;$lang[text12hour]</td>
 </tr>
@@ -119,7 +153,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[editprofile_minfo]</td>
-<td bgcolor="$altbg2"><strong>$lang[editprofile_userid]</strong> $member[uid]<br />$lang[editprofile_lastlogin] $lastlogdate<br />$lang[editprofile_regdate] $registerdate<br />$lang[editprofile_regip] <a href="http://network-tools.com/default.asp?prog=whois&host=$member[regip]" target="_blank">$member[regip]</a></td>
+<td bgcolor="$altbg2"><strong>$lang[editprofile_userid]</strong> $member[uid]<br />$lang[editprofile_lastlogin] $lastlogdate<br />$lang[editprofile_regdate] $registerdate<br />$lang[editprofile_regip] <a href="http://network-tools.com/default.asp?prog=whois&host=$member[regip]" onclick="window.open(this.href); return false;">$member[regip]</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[editprosearch]</td>
@@ -212,8 +246,8 @@
 <table cellspacing="0" cellpadding="0" border="0" width="95%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<form method="post" action="buddy.php?action=delete">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="buddy.php?action=delete">
+<input type="hidden" name="token" value="" />
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[editbuddylist]</font></strong></td>
@@ -224,7 +258,7 @@
 </tr>
 $buddys
 <tr>
-<td class="tablerow" colspan="2" bgcolor="$altbg2"><input type="submit" class="submit" name="editsubmit" value="Update" /><br /></td>
+<td class="tablerow" colspan="2" bgcolor="$altbg2"><input type="submit" class="submit" name="editsubmit" value="{$lang['addressupdate']}" /><br /></td>
 </tr>
 </table>
 </form>
@@ -235,8 +269,8 @@
 <table cellspacing="0" cellpadding="0" border="0" width="95%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<form method="post" action="buddy.php?action=add">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="buddy.php?action=add">
+<input type="hidden" name="token" value="" />
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[addtoaddresses]</font></strong></td>
@@ -254,7 +288,7 @@
 <td class="tablerow" bgcolor="$altbg1"><a href="#" onclick="javascript:add();return false;">&raquo; $lang[add_buddy]</a></td>
 </tr>
 <tr>
-<td class="tablerow" bgcolor="$altbg2"><input type="submit" class="submit" name="editsubmit" value="Update" /><br /></td>
+<td class="tablerow" bgcolor="$altbg2"><input type="submit" class="submit" name="editsubmit" value="{$lang['addressupdate']}" /><br /></td>
 </tr>
 </table>
 </form>
@@ -312,7 +346,7 @@
 <tr>
 <td class="tablerow" bgcolor="$altbg1">
 <form action="#" onsubmit="javascript:add();">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<input type="hidden" name="token" value="" />
 <table width="98%">
 <tr>
 <td class="tablerow" bgcolor="$altbg2" colspan="2"><strong>$lang[textonline]</strong></td>
@@ -357,14 +391,14 @@
 <style type="text/css">
 /*<![CDATA[*/
 body {
-    scrollbar-arrow-color: $header;
-    scrollbar-base-color: $altbg1;
+    scrollbar-arrow-color: {$THEME['header']};
+    scrollbar-base-color: {$THEME['altbg1']};
     text-align: left;
-    $bgcode
+    {$THEME['bgcode']}
 }
 
 a {
-    color: $link;
+    color: {$THEME['link']};
     text-decoration: none;
 }
 
@@ -373,7 +407,7 @@
 }
 
 .category a {
-    color: $cattext;
+    color: {$THEME['cattext']};
     text-decoration: none;
 }
 
@@ -382,71 +416,71 @@
 }
 
 hr {
-    color:  $bordercolor;
-    background-color: $bordercolor;
+    color:  {$THEME['bordercolor']};
+    background-color: {$THEME['bordercolor']};
     border: 0px;
     height: 1px;
 }
 
 #tickertoggle {
-    color: $cattext;
+    color: {$THEME['cattext']};
 }
 
 table.code {
-    border: 1px solid $bordercolor;
+    border: 1px solid {$THEME['bordercolor']};
     margin: 15px auto 10px auto;
     width: 80%;
 }
 
 td.code {
-    background-color: $header;
-    border-bottom: 1px solid $bordercolor;
-    color: $headertext;
-    font-family: $font;
-    font-size: $fontsize;
+    background-color: {$THEME['header']};
+    border-bottom: 1px solid {$THEME['bordercolor']};
+    color: {$THEME['headertext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     font-weight: bold;
     height: 20px;
     padding-left: 5px;
 }
 
 td.codemessage {
-    background-color: $altbg2;
-    color: $tabletext;
+    background-color: {$THEME['altbg2']};
+    color: {$THEME['tabletext']};
     font-family: Courier New;
-    font-size: $fontsize;
+    font-size: {$THEME['fontsize']};
     padding: 10px 5px 10px 5px;
     white-space: pre;
 }
 
 table.quote {
-    border: 1px solid $bordercolor;
+    border: 1px solid {$THEME['bordercolor']};
     margin: 15px 5% 10px 5%;
     width: 80%;
 }
 
 td.quote {
-    background-color: $header;
-    border-bottom: 1px solid $bordercolor;
-    color: $headertext;
-    font-family: $font;
-    font-size: $fontsize;
+    background-color: {$THEME['header']};
+    border-bottom: 1px solid {$THEME['bordercolor']};
+    color: {$THEME['headertext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     font-weight: bold;
     height: 20px;
     padding-left: 5px;
 }
 
 td.quotemessage {
-    background-color: $altbg2;
-    color: $tabletext;
-    font-family: $font;
-    font-size: $fontsize;
+    background-color: {$THEME['altbg2']};
+    color: {$THEME['tabletext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     padding: 10px 0 20px 5px;
 }
 
 textarea, select, input, object {
-    background-color: $altbg1;
-    border: 1px solid $bordercolor;
-    color: $tabletext;
+    background-color: {$THEME['altbg1']};
+    border: 1px solid {$THEME['bordercolor']};
+    color: {$THEME['tabletext']};
     font-family: Verdana, arial, helvetica, sans-serif;
     font-size: 12px;
     font-weight: normal;
@@ -455,31 +489,31 @@
 
 .category {
     $catcss
-    font-family: $font;
-    font-size: $fontsize;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     table-layout: fixed;
     text-align: left;
 }
 
 .ctrcategory {
     $catcss
-    font-family: $font;
-    font-size: $fontsize;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     table-layout: fixed;
     text-align: center;
 }
 
 .ctrtablerow {
-    color: $tabletext;
-    font-family: $font;
-    font-size: $fontsize;
+    color: {$THEME['tabletext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     table-layout: fixed;
     text-align: center;
 }
 
 .header {
-    background-color: $header;
-    color: $headertext;
+    background-color: {$THEME['header']};
+    color: {$THEME['headertext']};
     font-family: Verdana;
     font-size: 10px;
     font-weight: bold;
@@ -487,7 +521,7 @@
 }
 
 .header2 {
-    background-color: $altbg1;
+    background-color: {$THEME['altbg1']};
     font-family: Verdana;
     font-size: 11px;
     font-weight: bold;
@@ -495,74 +529,74 @@
 }
 
 .mediumtxt {
-    color: $tabletext;
-    font-family: $font;
-    font-size: $fontsize;
+    color: {$THEME['tabletext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     font-weight: normal;
     table-layout: fixed;
 }
 
 .multi {
-    font-family: $font;
+    font-family: {$THEME['font']};
     font-size: 11px;
     table-layout: fixed;
 }
 
 .nav {
-    font-family: $font;
-    font-size: $fontsize;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     font-weight: bold;
     table-layout: fixed;
 }
 
 .navtd {
-    background-color: $header;
-    color: $headertext;
-    font-family: $font;
+    background-color: {$THEME['header']};
+    color: {$THEME['headertext']};
+    font-family: {$THEME['font']};
     font-size: 11px;
     table-layout: fixed;
     text-decoration: none;
 }
 
 .navtd2 {
-    background-color: $header;
-    color: $headertext;
-    font-family: $font;
+    background-color: {$THEME['header']};
+    color: {$THEME['headertext']};
+    font-family: {$THEME['font']};
     font-size: 9px;
     table-layout: fixed;
     text-decoration: none;
 }
 
 .post {
-    font-family: $font;
-    font-size: $font3;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['font3']};
     font-weight: normal;
 }
 
 .rghttablerow {
-    color: $tabletext;
-    font-family: $font;
-    font-size: $fontsize;
+    color: {$THEME['tabletext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     table-layout: fixed;
     text-align: right;
 }
 
 .sig {
-    border-top: 1px dashed $bordercolor;
+    border-top: 1px dashed {$THEME['bordercolor']};
     padding: 13px 0 0 3px;
-    font-family: $font;
-    font-size: $fontsize;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
 }
 
 .smalltxt {
-    font-family: $font;
-    font-size: $font1;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['font1']};
     table-layout: fixed;
 }
 
 .subject {
-    font-family: $font;
-    font-size: $fontsize;
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     font-weight: bold;
 }
 
@@ -571,16 +605,16 @@
 }
 
 .tablerow {
-    color: $tabletext;
-    font-family: $font;
-    font-size: $fontsize;
+    color: {$THEME['tabletext']};
+    font-family: {$THEME['font']};
+    font-size: {$THEME['fontsize']};
     table-layout: fixed;
 }
 
 .status_Super_Administrator {
     text-decoration: underline;
     font-weight: bold;
-    color: $tabletext;
+    color: {$THEME['tabletext']};
     font-family: Verdana;
     font-size: 10px;
     font-style: italic;
@@ -589,7 +623,7 @@
 .status_Administrator {
     text-decoration: underline;
     font-weight: bold;
-    color: $tabletext;
+    color: {$THEME['tabletext']};
     font-family: Verdana;
     font-size: 10px;
 }
@@ -597,7 +631,7 @@
 .status_Super_Moderator {
     text-decoration: none;
     font-weight: bold;
-    color: $tabletext;
+    color: {$THEME['tabletext']};
     font-family: Verdana;
     font-size: 10px;
     font-style: italic;
@@ -606,7 +640,7 @@
 .status_Moderator {
     text-decoration: none;
     font-weight: bold;
-    color: $tabletext;
+    color: {$THEME['tabletext']};
     font-family: Verdana;
     font-size: 10px;
 }
@@ -614,7 +648,7 @@
 .status_Member, .status_Banned {
     text-decoration: none;
     font-weight: normal;
-    color: $tabletext;
+    color: {$THEME['tabletext']};
     font-family: Verdana;
     font-size: 10px;
 }
@@ -630,7 +664,7 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html>
 <head>
-<base href="$SETTINGS[boardurl]" />
+<base href="$full_url" />
 <meta http-equiv="Content-Type" content="text/html; charset=$charset" />
 <title>$bbname &gt; $lang[textu2utoemail]</title>
 $css
@@ -639,15 +673,15 @@
 
 |#*XMB TEMPLATE FILE*#|error|#*XMB TEMPLATE*#|
 $header
-<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
+<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="{$THEME['bordercolor']}">
 <tr>
 <td>
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class="category"><font color="$cattext"><strong>$lang[error]</strong></font></td>
+<td class="category"><font color="{$THEME['cattext']}"><strong>$lang[error]</strong></font></td>
 </tr>
 <tr>
-<td class="tablerow" bgcolor="$altbg1">$message</td>
+<td class="tablerow" bgcolor="{$THEME['altbg1']}">$message</td>
 </tr>
 </table>
 </td>
@@ -655,8 +689,9 @@
 </table>
 
 |#*XMB TEMPLATE FILE*#|error_nologinsession|#*XMB TEMPLATE*#|
-<form method="post" action="misc.php?action=login">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="misc.php?action=login">
+<input type="hidden" name="token" value="" />
+<input type="hidden" name="hide" value="2" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -1284,7 +1319,7 @@
 <tr>
 <td class="nav" style="padding-bottom: 1px" bgcolor="$altbg2">&nbsp;<a href="index.php">$bbname</a>$navigation</td>
 <td class="tablerow" align="right" bgcolor="$altbg2">$quickjump&nbsp;</td>
-<td align="right" bgcolor="$altbg2" width="2%"><a href="#top"><img src="$imgdir/arrow_up.gif" style="margin-right: 3px" border="0" alt="$lang[gototop]" /></a></td>
+<td align="right" bgcolor="$altbg2" width="2%"><a href="#top" title="$lang[gototop]"><img src="$imgdir/arrow_up.gif" style="margin-right: 3px" border="0" alt="$lang[gototop]" /></a></td>
 </tr>
 </table>
 </td>
@@ -1300,7 +1335,7 @@
 <font class="smalltxt">
 $versionlong
 <br />
-$lang[developedby]&nbsp;<a href="http://www.xmbforum.com" target="_blank"><strong>$lang[xmbgroup]</strong></a>&nbsp;&copy; $copyright
+<a href="http://www.xmbforum.com" onclick="window.open(this.href); return false;"><strong>{$lang['xmbforum']}</strong></a>&nbsp;&copy; $copyright $lang[xmbgroup]
 <br />
 $footerstuff[totaltime]
 $footerstuff[querynum]
@@ -1352,7 +1387,6 @@
 <td width="19%">$lang[textlastpost]</td>
 </tr>
 $threadlist
-</form>
 $sortby
 $multipage
 </table>
@@ -1378,8 +1412,8 @@
 
 |#*XMB TEMPLATE FILE*#|forumdisplay_admin|#*XMB TEMPLATE*#|
 $subforums
-<form method="post" name="geatneet" action="topicadmin.php?fid=$forum[fid]">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="geatneet" action="topicadmin.php?fid=$forum[fid]">
+<input type="hidden" name="token" value="" />
 <table width="$tablewidth" cellspacing="0" cellpadding="0" align="center">
 <tr>
 <td class="post" align="right">&nbsp;$newtopiclink$newpolllink</td>
@@ -1391,7 +1425,7 @@
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header" align="center">
-<td width="4%"><a href="cp.php?action=forum&amp;fdetails=$forum[fid]"><img src="./images/admin/editforumsets.gif" border="0" alt="$lang[alteditsettings]" /></a></td>
+<td width="4%">$fadminlink</td>
 <td width="4%">$lang[texticon]</td>
 <td width="45%">$lang[textsubject]</td>
 <td width="6%">$lang[topuntop]</td>
@@ -1409,7 +1443,7 @@
 <tr>
 <td class="tablerow" align="right">
 <input type="hidden" name="fid" value="$fid" />
-<input type="hidden" name="token" value="$oToken->newToken" />
+<input type="hidden" name="token" value="" />
 <span class="mediumtxt"><strong>$lang[textadminoptions]</strong>
 <select name="action">
 <option value="" selected="selected"></option>
@@ -1455,11 +1489,6 @@
 </tr>
 </table>
 
-|#*XMB TEMPLATE FILE*#|forumdisplay_invalidforum|#*XMB TEMPLATE*#|
-<tr class="tablerow">
-<td colspan="8" bgcolor="$altbg1">$notexist</td>
-</tr>
-
 |#*XMB TEMPLATE FILE*#|forumdisplay_multipage|#*XMB TEMPLATE*#|
 <tr class="tablerow" bgcolor="$altbg2">
 <td colspan="7" class="multi">&nbsp;$multipage</td>
@@ -1471,10 +1500,10 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|forumdisplay_newpoll|#*XMB TEMPLATE*#|
-<a href="post.php?action=newthread&amp;fid=$fid&amp;poll=yes"><img src="$imgdir/poll.gif" border="0" alt="$lang[textnewpoll]" /></a>
+<a href="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" title="$lang[textnewpoll]"><img src="$imgdir/poll.gif" border="0" alt="$lang[textnewpoll]" /></a>
 
 |#*XMB TEMPLATE FILE*#|forumdisplay_newtopic|#*XMB TEMPLATE*#|
-<a href="post.php?action=newthread&amp;fid=$fid"><img src="$imgdir/newtopic.gif" border="0" alt="$lang[altpostnewthread]" /></a>
+<a href="post.php?action=newthread&amp;fid=$fid" title="$lang[altpostnewthread]"><img src="$imgdir/newtopic.gif" border="0" alt="$lang[altpostnewthread]" /></a>
 
 |#*XMB TEMPLATE FILE*#|forumdisplay_nothreads|#*XMB TEMPLATE*#|
 <tr class="tablerow">
@@ -1483,8 +1512,8 @@
 
 |#*XMB TEMPLATE FILE*#|forumdisplay_password|#*XMB TEMPLATE*#|
 <br />
-<form method="post" action="$url">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="$url">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -1505,8 +1534,8 @@
 |#*XMB TEMPLATE FILE*#|forumdisplay_sortby|#*XMB TEMPLATE*#|
 <tr>
 <td colspan="10" class="ctrtablerow" bgcolor="$altbg2">
-<form method="post" action="forumdisplay.php?fid=$fid">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="forumdisplay.php?fid=$fid">
+<input type="hidden" name="token" value="" />
 $lang[showtopics]
 &nbsp;&nbsp;
 <select name="cusdate">
@@ -1562,7 +1591,7 @@
 <table cellpadding="0" cellspacing="0" border="0" width="100%">
 <tr align="right">
 <td bgcolor="$altbg1" class="rghttablerow" nowrap="nowrap"><font class="smalltxt">$lastpost</font></td>
-<td bgcolor="$altbg1" class="rghttablerow" nowrap="nowrap">&nbsp;<a href="viewthread.php?goto=lastpost&amp;fid=$forum[fid]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
+<td bgcolor="$altbg1" class="rghttablerow" nowrap="nowrap">&nbsp;<a href="viewthread.php?goto=lastpost&amp;fid=$forum[fid]" title="$lang[altlastpost]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
 </tr>
 </table>
 
@@ -1594,7 +1623,7 @@
 <td bgcolor="$altbg2" class="ctrtablerow"><font class="mediumtxt">$thread[replies]</font></td>
 <td bgcolor="$altbg1" class="ctrtablerow"><font class="mediumtxt">$thread[views]</font></td>
 <td bgcolor="$altbg2" class="rghttablerow">$lastpostrow</td>
-<td bgcolor="$altbg1" class="ctrtablerow"><a href="topicadmin.php?tid=$thread[realtid]&amp;fid=$forum[fid]&amp;action=delete"><img src="./images/admin/deletetopic.gif" alt="$lang[deletethread]" border="0" /></a></td>
+<td bgcolor="$altbg1" class="ctrtablerow"><a href="topicadmin.php?tid=$thread[realtid]&amp;fid=$forum[fid]&amp;action=delete"><img src="$admdir/deletetopic.gif" alt="$lang[deletethread]" border="0" /></a></td>
 <td bgcolor="$altbg1" class="ctrtablerow"><input type="checkbox" name="tid[]" value="$thread[realtid]" /></td>
 </tr>
 
@@ -1602,7 +1631,7 @@
 <table cellpadding="0" cellspacing="0" border="0" width="100%">
 <tr align="right">
 <td bgcolor="$altbg2" class="rghttablerow" nowrap="nowrap"><font class="smalltxt">$lastpost</font></td>
-<td bgcolor="$altbg2" class="rghttablerow" nowrap="nowrap">&nbsp;<a href="viewthread.php?goto=lastpost&amp;tid=$thread[tid]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
+<td bgcolor="$altbg2" class="rghttablerow" nowrap="nowrap">&nbsp;<a href="viewthread.php?goto=lastpost&amp;tid=$thread[tid]" title="$lang[altlastpost]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
 </tr>
 </table>
 
@@ -1612,6 +1641,7 @@
 var bbcode_advmode = "$lang[bbcode_advmode]";
 var bbcode_normode = "$lang[bbcode_normode]";
 var bbcode_help_email = "$lang[bbcode_help_email]";
+var bbcode_prompt_email_desc = "$lang[bbcode_prompt_email_desc]";
 var bbcode_prompt_email_email = "$lang[bbcode_prompt_email_email]";
 var bbcode_prompt_email_error = "$lang[bbcode_prompt_email_error]";
 var bbcode_help_size = "$lang[bbcode_help_size]";
@@ -1703,18 +1733,25 @@
 </select>
 $spelling_lang
 <br />
-<a href="javascript:bold()" accesskey="b"><img src="$imgdir/bb_bold.gif" border="0" width="23" height="22" alt="$lang[cb_insert_bold]" /></a>
-<a href="javascript:italicize()" accesskey="i"><img src="$imgdir/bb_italicize.gif" border="0" width="23" height="22" alt="$lang[cb_insert_italics]" /></a>
-<a href="javascript:underline()" accesskey="u"><img src="$imgdir/bb_underline.gif" border="0" width="23" height="22" alt="$lang[cb_insert_underlined]" /></a>
-<a href="javascript:center()"><img src="$imgdir/bb_center.gif" border="0" width="23" height="22" alt="$lang[cb_insert_centered]" /></a>
-<a href="javascript:hyperlink()"><img src="$imgdir/bb_url.gif" border="0" width="23" height="22" alt="$lang[cb_insert_hyperlink]" /></a>
-<a href="javascript:email()"><img src="$imgdir/bb_email.gif" border="0" width="23" height="22" alt="$lang[cb_insert_email]" /></a>
-<a href="javascript:image()"><img src="$imgdir/bb_image.gif" border="0" width="23" height="22" alt="$lang[cb_insert_image]" /></a>
-<a href="javascript:code()"><img src="$imgdir/bb_code.gif" border="0" width="23" height="22" alt="$lang[cb_insert_code]" /></a>
-<a href="javascript:quote()"><img src="$imgdir/bb_quote.gif" border="0" width="23" height="22" alt="$lang[cb_insert_quote]" /></a>
-<a href="javascript:list()"><img src="$imgdir/bb_list.gif" border="0" width="23" height="22" alt="$lang[cb_insert_list]" /></a></td>
+<a href="javascript:bold()" accesskey="b" title="$lang[cb_insert_bold]"><img src="$imgdir/bb_bold.gif" border="0" width="23" height="22" alt="$lang[cb_insert_bold]" /></a>
+<a href="javascript:italicize()" accesskey="i" title="$lang[cb_insert_italics]"><img src="$imgdir/bb_italicize.gif" border="0" width="23" height="22" alt="$lang[cb_insert_italics]" /></a>
+<a href="javascript:underline()" accesskey="u" title="$lang[cb_insert_underlined]"><img src="$imgdir/bb_underline.gif" border="0" width="23" height="22" alt="$lang[cb_insert_underlined]" /></a>
+<a href="javascript:center()" title="lang[cb_insert_centered]" ><img src="$imgdir/bb_center.gif" border="0" width="23" height="22" alt="$lang[cb_insert_centered]" /></a>
+<a href="javascript:hyperlink()" title="$lang[cb_insert_hyperlink]" ><img src="$imgdir/bb_url.gif" border="0" width="23" height="22" alt="$lang[cb_insert_hyperlink]" /></a>
+<a href="javascript:email()" title="$lang[cb_insert_email]" ><img src="$imgdir/bb_email.gif" border="0" width="23" height="22" alt="$lang[cb_insert_email]" /></a>
+<a href="javascript:image()" title="$lang[cb_insert_image]" ><img src="$imgdir/bb_image.gif" border="0" width="23" height="22" alt="$lang[cb_insert_image]" /></a>
+<a href="javascript:code()" title="$lang[cb_insert_code]" ><img src="$imgdir/bb_code.gif" border="0" width="23" height="22" alt="$lang[cb_insert_code]" /></a>
+<a href="javascript:quote()" title="$lang[cb_insert_quote]" ><img src="$imgdir/bb_quote.gif" border="0" width="23" height="22" alt="$lang[cb_insert_quote]" /></a>
+<a href="javascript:list()" title="$lang[cb_insert_list]" ><img src="$imgdir/bb_list.gif" border="0" width="23" height="22" alt="$lang[cb_insert_list]" /></a></td>
 </tr>
 
+|#*XMB TEMPLATE FILE*#|functions_bbcode_quickreply|#*XMB TEMPLATE*#|
+<script type="text/javascript" src="./js/bbcodefns-$browser.js"></script>
+<script type="text/javascript">
+var messageElement;
+loadEls();
+</script>
+
 |#*XMB TEMPLATE FILE*#|functions_smilieinsert|#*XMB TEMPLATE*#|
 <td>
 <table align="center">
@@ -1726,14 +1763,16 @@
 <td valign="top"><a style="cursor:hand" onclick="javascript:icon('$smilie[code]')"><img src="$smdir/$smilie[url]" border="0" alt="$smilie[code]"/></a></td>
 
 |#*XMB TEMPLATE FILE*#|header|#*XMB TEMPLATE*#|
+<?xml version="1.0" encoding="$charset"?>
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
 <!-- $versionlong  -->
 <!-- Build: $versionbuild -->
 <!-- $versioncompany -->
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html>
 <head>
+$baseelement$canonical_link
 <meta http-equiv="Content-Type" content="text/html; charset=$charset" />
-<title>$bbname $threadSubject - $versionlong</title>
+<title>{$SETTINGS['bbname']} $threadSubject - $versionlong</title>
 $css
 <script language="JavaScript" type="text/javascript" src="./js/header.js"></script>
 </head>
@@ -1761,8 +1800,8 @@
 <td class="navtd">
 <table width="100%" cellpadding="0" cellspacing="0">
 <tr>
-<td class="navtd"><font class="navtd">$links $pluglink</font></td>
-<td align="right"><a href="$siteurl"><font class="navtd">$lang[backto] <img src="$imgdir/top_home.gif" border="0" alt="$sitename" /></font></a></td>
+<td class="navtd"><font class="navtd">$searchlink $links $pluglink</font></td>
+<td align="right"><a href="$siteurl" title="$sitename"><font class="navtd">$lang[backto] <img src="$imgdir/top_home.gif" border="0" alt="$sitename" /></font></a></td>
 </tr>
 </table>
 </td>
@@ -1775,9 +1814,9 @@
 <tr>
 <td><table width="100%" cellspacing="0" cellpadding="$tablespace" align="center">
 <tr>
-<td class="nav"> <a href="index.php">$bbname</a> $navigation</td>
+<td class="nav"> <a href="./">$bbname</a> $navigation</td>
 <td align="right">$quickjump</td>
-<td align="right" width="1"><a href="#bottom"><img src="$imgdir/arrow_dw.gif" border="0" alt="$lang[gotobottom]" /></a></td>
+<td align="right" width="1"><a href="#bottom" title="$lang[gotobottom]"><img src="$imgdir/arrow_dw.gif" border="0" alt="$lang[gotobottom]" /></a></td>
 </tr>
 </table>
 </td>
@@ -1839,7 +1878,7 @@
 <table cellpadding="0" cellspacing="0" border="0" width="100%">
 <tr class="rghttablerow">
 <td bgcolor="$altbg1" nowrap="nowrap"><font class="smalltxt">$lastpost</font></td>
-<td bgcolor="$altbg1" nowrap="nowrap">&nbsp;<a href="./viewthread.php?goto=lastpost&amp;fid=$forum[fid]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
+<td bgcolor="$altbg1" nowrap="nowrap">&nbsp;<a href="./viewthread.php?goto=lastpost&amp;fid=$forum[fid]" title="$lang[altlastpost]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
 </tr>
 </table>
 
@@ -1877,15 +1916,17 @@
 |#*XMB TEMPLATE FILE*#|index_ticker|#*XMB TEMPLATE*#|
 <script type="text/javascript" language="JavaScript" src="./js/ticker.js"></script>
 <script type="text/javascript" language="JavaScript">
+<!--//--><![CDATA[//><!--
 var stopticker = "$lang[stopticker]";
 var startticker = "$lang[startticker]";
-var delay = $tickerdelay;;
+var delay = {$SETTINGS['tickerdelay']};
 var node = '';
 var current = 0;
 var running = false;
 var contents = new Array();
 $contents
-window.onload = tickerstart;
+setTickerEvent();
+//--><!]]>
 </script>
 <table border="0" cellpadding="0" cellspacing="0" width="$tablewidth" align="center">
 <tr>
@@ -1920,8 +1961,9 @@
 <tr bgcolor="$altbg2" class="tablerow">
 <td><font size="1">$lang[welcomeunreg]</font></td>
 <td align="right" width="25%">
-<form method="post" action="misc.php?action=login">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="misc.php?action=login">
+<input type="hidden" name="token" value="" />
+<input type="hidden" name="hide" value="2" />
 <table border="0" cellpadding="0" cellspacing="0">
 <tr>
 <td nowrap="nowrap">
@@ -2017,8 +2059,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_coppa|#*XMB TEMPLATE*#|
-<form method="post" action="member.php?action=reg">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="member.php?action=reg">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2048,7 +2090,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textusername]</td>
-<td bgcolor="$altbg2">{$memberinfo['username']} <small>(<a href="u2u.php?action=send&amp;username=$encodeuser" onclick="Popup(this.href, 'Window', 700, 450); return false;">{$lang['textu2u']}</a>)&nbsp;&nbsp;(<a href="buddy.php?action=add&amp;buddys=$encodeuser" onclick="Popup(this.href, 'Window', 450, 400); return false;">{$lang['addtobuddies']}</a>)</small></td>
+<td bgcolor="$altbg2">{$memberinfo['username']}$memberlinks</td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textregistered]</td>
@@ -2059,7 +2101,7 @@
 <td bgcolor="$altbg2">$memberinfo[postnum] ($percent% $lang[textoftotposts])</td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" valign="top">$lang[textstatus]<br /><a href="$sitelink" target="_blank">$memberinfo[avatar]</a></td>
+<td bgcolor="$altbg1" valign="top">$lang[textstatus]<br /><a href="$sitelink" onclick="window.open(this.href); return false;">$memberinfo[avatar]</a></td>
 <td bgcolor="$altbg2">$showtitle$customstatus<br />$stars<br /><br />$rank[avatarrank]</td>
 </tr>
 <tr class="tablerow">
@@ -2080,7 +2122,7 @@
 $emailblock
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textsite]</td>
-<td bgcolor="$altbg2"><a href="$site" target="_blank">$site</a></td>
+<td bgcolor="$altbg2"><a href="$site" onclick="window.open(this.href); return false;">$site</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textaim]</td>
@@ -2088,15 +2130,15 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[texticq]</td>
-<td bgcolor="$altbg2"><a href="http://people.icq.com/people/about_me.php?uin=$memberinfo[icq]" target="_blank">$memberinfo[icq]</a></td>
+<td bgcolor="$altbg2"><a href="http://people.icq.com/people/about_me.php?uin=$memberinfo[icq]" onclick="window.open(this.href); return false;">$memberinfo[icq]</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textyahoo]</td>
-<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/{$memberinfo['yahoorecode']}" target="_blank">{$memberinfo['yahoo']}</a></td>
+<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/{$memberinfo['yahoorecode']}" onclick="window.open(this.href); return false;">{$memberinfo['yahoo']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textmsn]</td>
-<td bgcolor="$altbg2"><a href="http://members.msn.com/{$memberinfo['msnrecode']}" target="_blank">{$memberinfo['msn']}</a></td>
+<td bgcolor="$altbg2"><a href="http://members.msn.com/{$memberinfo['msnrecode']}" onclick="window.open(this.href); return false;">{$memberinfo['msn']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textlocation]</td>
@@ -2149,8 +2191,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_reg|#*XMB TEMPLATE*#|
-<form method="post" action="member.php?action=reg">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="member.php?action=reg">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2160,7 +2202,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textusername]</td>
-<td bgcolor="$altbg2"><input type="text" name="username" size="25" maxlength="25" /></td>
+<td bgcolor="$altbg2"><input type="text" name="username" size="25" maxlength="25" /> {$lang['usernamechars']}</td>
 </tr>
 $pwtd
 <tr class="tablerow">
@@ -2211,13 +2253,23 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textshowemail]</td>
-<td bgcolor="$altbg2"><input type="checkbox" name="showemail" value="yes" checked="checked" /></td>
+<td bgcolor="$altbg2"><input type="checkbox" name="showemail" value="yes" /></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textgetnews]</td>
 <td bgcolor="$altbg2"><input type="checkbox" name="newsletter" value="yes" checked="checked" /> </td>
 </tr>
 <tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[u2ualert1]</td>
+<td bgcolor="$altbg2">
+<select name="u2ualert">
+<option value="2">$lang[u2ualert2]</option>
+<option value="1">$lang[u2ualert3]</option>
+<option value="0">$lang[u2ualert4]</option>
+</select>
+</td>
+</tr>
+<tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textuseoldu2u]</td>
 <td bgcolor="$altbg2"><input type="checkbox" name="useoldu2u" value="yes" />
 </td>
@@ -2292,8 +2344,8 @@
 |#*XMB TEMPLATE FILE*#|member_reg_avatarlist|#*XMB TEMPLATE*#|
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textavatar]</td>
-<td bgcolor="$altbg2"><select name="avatar" onchange="document.images.avatarpic.src = this[this.selectedIndex].value;">$avatars</select>&nbsp;&amp;&nbsp;
-<img src="./images/avatars/clear_avatar.gif" name="avatarpic" align="middle" border="0" alt="*" /></td>
+<td bgcolor="$altbg2"><select name="newavatar" onchange="document.images.avatarpic.src = this[this.selectedIndex].value;">$avatars</select> &nbsp;
+<img src="./images/avatars/clear_avatar.gif" id="avatarpic" align="middle" border="0" alt="*" /></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_reg_avatarurl|#*XMB TEMPLATE*#|
@@ -2312,7 +2364,11 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[verificationnote]</td>
-<td bgcolor="$altbg2"><img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" /><br /><br /><input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /></td>
+<td bgcolor="$altbg2">
+ <img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" /><br /><br />
+ <input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /><br />
+ {$lang['captchacaseon']}
+</td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_reg_optional|#*XMB TEMPLATE*#|
@@ -2368,8 +2424,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|member_reg_rules|#*XMB TEMPLATE*#|
-<form method="post" action="member.php?action=reg">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="member.php?action=reg">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2393,8 +2449,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|memcp_favs|#*XMB TEMPLATE*#|
-<form method="post" action="memcp.php?action=favorites">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="memcp.php?action=favorites">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2602,8 +2658,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|memcp_profile|#*XMB TEMPLATE*#|
-<form method="post" action="memcp.php?action=profile" name="reg">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="memcp.php?action=profile" name="reg">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2612,17 +2668,28 @@
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textpassword]</td>
+<td bgcolor="$altbg1" width="22%">{$lang['textusername']}</td>
+<td bgcolor="$altbg2">{$self['username']}</td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textemail]</td>
+<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /></td>
+</tr>
+<tr>
+<td colspan="2" class="category"><font color="$cattext"><strong>$lang[pwchange] - $lang[optional]</strong></font></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">{$lang['textoldpassword']}</td>
+<td bgcolor="$altbg2"><input type="password" name="oldpassword" size="25" /></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textnewpassword]</td>
 <td bgcolor="$altbg2"><input type="password" name="newpassword" size="25" /> $lang[pwnote]</td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textpasswordcf]</td>
 <td bgcolor="$altbg2"><input type="password" name="newpasswordcf" size="25" /></td>
 </tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textemail]</td>
-<td bgcolor="$altbg2"><input type="text" name="newemail" size="25" value="$member[email]" /></td>
-</tr>
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[optional]</strong></font></td>
 </tr>
@@ -2657,11 +2724,13 @@
 $avatar
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textbio]</td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newbio">$member[bio]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newbio">
+$member[bio]</textarea></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textsig]<br /><span class="smalltxt">$lang[texthtmlis] $htmlis<br />$lang[textbbcodeis] $bbcodeis</span></td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newsig">$member[sig]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="45" name="newsig">
+$member[sig]</textarea></td>
 </tr>
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[textoptions]</strong></font></td>
@@ -2715,6 +2784,16 @@
 <td bgcolor="$altbg2"><input type="checkbox" name="newnewsletter" value="yes" $newschecked /> </td>
 </tr>
 <tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[u2ualert1]</td>
+<td bgcolor="$altbg2">
+<select name="u2ualert">
+<option value="2" $u2uasel2>$lang[u2ualert2]</option>
+<option value="1" $u2uasel1>$lang[u2ualert3]</option>
+<option value="0" $u2uasel0>$lang[u2ualert4]</option>
+</select>
+</td>
+</tr>
+<tr class="tablerow">
 <td bgcolor="$altbg1" width="22%">$lang[textuseoldu2u]</td>
 <td bgcolor="$altbg2"><input type="checkbox" name="useoldu2u" value="yes" $uou2uchecked />
 </td>
@@ -2787,7 +2866,7 @@
 |#*XMB TEMPLATE FILE*#|memcp_profile_avatarlist|#*XMB TEMPLATE*#|
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textavatar]</td>
-<td bgcolor="$altbg2">$avatarbox &nbsp;<img src="./images/avatars/clear_avatar.gif" name="avatarpic" align="middle" alt="*" border="0" /></td>
+<td bgcolor="$altbg2">$avatarbox &nbsp;<img src="./images/avatars/clear_avatar.gif" id="avatarpic" align="middle" alt="*" border="0" /></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|memcp_profile_avatarurl|#*XMB TEMPLATE*#|
@@ -2801,8 +2880,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|memcp_subscriptions|#*XMB TEMPLATE*#|
-<form method="post" action="memcp.php?action=subscriptions">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="memcp.php?action=subscriptions">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2810,6 +2889,7 @@
 <tr>
 <td colspan="6" class="category" align="center" $catbgcode><strong><font color="$cattext">$lang[textsubscriptions]</font></strong></td>
 </tr>
+$multipage
 <tr class="header">
 <td width="4%" align="center">$lang[deletebutton]</td>
 <td width="4%" align="center">$lang[texticon]</td>
@@ -2819,6 +2899,7 @@
 <td width="19%">$lang[textlastpost]</td>
 </tr>
 $subscriptions
+$multipage
 $subsbtn
 </table>
 </td>
@@ -2831,6 +2912,11 @@
 <td bgcolor="$altbg2" colspan="6"><input type="submit" class="submit" name="subsubmit" value="$lang[textdeleteselectedsubs]" /></td>
 </tr>
 
+|#*XMB TEMPLATE FILE*#|memcp_subscriptions_multipage|#*XMB TEMPLATE*#|
+<tr class="tablerow" bgcolor="$altbg2">
+<td colspan="6" class="multi">&nbsp;$multipage</td>
+</tr>
+
 |#*XMB TEMPLATE FILE*#|memcp_subscriptions_none|#*XMB TEMPLATE*#|
 <tr>
 <td class="tablerow" bgcolor="$altbg2" colspan="6">$lang[nosubmsg]</td>
@@ -2848,15 +2934,15 @@
 
 |#*XMB TEMPLATE FILE*#|message|#*XMB TEMPLATE*#|
 $header
-<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
+<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="{$THEME['bordercolor']}">
 <tr>
 <td>
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td class="category"><font color="$cattext"><strong>$lang[message]</strong></font></td>
+<td class="category"><font color="{$THEME['cattext']}"><strong>$lang[message]</strong></font></td>
 </tr>
 <tr>
-<td class="tablerow" bgcolor="$altbg1">$message</td>
+<td class="tablerow" bgcolor="{$THEME['altbg1']}">$message</td>
 </tr>
 </table>
 </td>
@@ -2872,7 +2958,7 @@
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="8%" align="center"><img src="./images/admin/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
+<td bgcolor="$altbg1" width="8%" align="center"><img src="$admdir/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
 <td bgcolor="$altbg2"><span class="smalltxt"><strong>$lang[fnasorry2]</strong></span><br />$lang[fnasorry3]<br/></td>
 </tr>
 </table>
@@ -2889,7 +2975,7 @@
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="8%" align="center"><img src="./images/admin/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
+<td bgcolor="$altbg1" width="8%" align="center"><img src="$admdir/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
 <td bgcolor="$altbg2"><span class="smalltxt"><strong>$lang[fnasorry2]</strong></span><br />$lang[plogtuf]<br /></td>
 </tr>
 </table>
@@ -2898,8 +2984,8 @@
 </table>
 
 |#*XMB TEMPLATE FILE*#|misc_login|#*XMB TEMPLATE*#|
-<form method="post" action="misc.php?action=login">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="misc.php?action=login">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2940,7 +3026,7 @@
 <td class="header" colspan="2"><font color="$cattext"><strong>$lang[textlogin_incorrect]</strong></font></td>
 </tr>
 <tr class="tablerow">
-<td bgcolor="$altbg1" width="8%" align="center"><img src="./images/admin/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
+<td bgcolor="$altbg1" width="8%" align="center"><img src="$admdir/exclamation.gif" border="0" alt="$lang[featurewarning]" /></td>
 <td bgcolor="$altbg2"><span class="smalltxt"><strong>$lang[textpw1]</strong></span><br />$lang[textpw2]<br /></td>
 </tr>
 </table>
@@ -2949,8 +3035,8 @@
 </table>
 
 |#*XMB TEMPLATE FILE*#|misc_lostpw|#*XMB TEMPLATE*#|
-<form method="post" action="misc.php?action=lostpw">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="misc.php?action=lostpw">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -2984,22 +3070,24 @@
 <td bgcolor="$bordercolor">
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
+<td colspan="6" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
 <tr class="ctrtablerow">
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=postnum&amp;desc=desc"><strong>$lang[textpostnum]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=username"><strong>$lang[textalpha]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list"><strong>$lang[textregdate]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=status"><strong>$lang[status]</strong></a></td>
-<td bgcolor="$altbg2" width="10%"><a href="misc.php?action=list&amp;desc=$init[ascdesc]&amp;page=$page$ext"><strong>$ascdesc</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=username"><strong>$lang[textalpha]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=status"><strong>$lang[status]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=location"><strong>{$lang['location']}</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list"><strong>$lang[textregdate]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=postnum&amp;desc=desc"><strong>$lang[textpostnum]</strong></a></td>
+<td bgcolor="$altbg2" width="10%"><a href="misc.php?action=list&amp;desc=$init[ascdesc]$ext"><strong>$ascdesc</strong></a></td>
 </tr>
 </table>
 </td>
 </tr>
 </table>
 <br />
-<form method="post" action="misc.php?action=list">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="get" action="misc.php">
+<input type="hidden" name="token" value="" />
+<input type="hidden" name="action" value="list" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3034,22 +3122,24 @@
 <td bgcolor="$bordercolor">
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
-<td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
+<td colspan="6" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
 <tr class="ctrtablerow">
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=postnum&amp;desc=desc"><strong>$lang[textpostnum]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=username"><strong>$lang[textalpha]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list"><strong>$lang[textregdate]</strong></a></td>
-<td bgcolor="$altbg2" width="18%"><a href="misc.php?action=list&amp;order=status"><strong>$lang[status]</strong></a></td>
-<td bgcolor="$altbg2" width="10%"><a href="misc.php?action=list&amp;desc=$init[ascdesc]&amp;page=$page$ext"><strong>$ascdesc</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=username"><strong>$lang[textalpha]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=status"><strong>$lang[status]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=location"><strong>{$lang['location']}</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list"><strong>$lang[textregdate]</strong></a></td>
+<td bgcolor="$altbg2"><a href="misc.php?action=list&amp;order=postnum&amp;desc=desc"><strong>$lang[textpostnum]</strong></a></td>
+<td bgcolor="$altbg2" width="10%"><a href="misc.php?action=list&amp;desc=$init[ascdesc]$ext"><strong>$ascdesc</strong></a></td>
 </tr>
 </table>
 </td>
 </tr>
 </table>
 <br />
-<form method="post" action="misc.php?action=list">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="get" action="misc.php">
+<input type="hidden" name="token" value="" />
+<input type="hidden" name="action" value="list" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3100,10 +3190,10 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|misc_mlist_row_email|#*XMB TEMPLATE*#|
-<a href="mailto:$member[email]"><img src="$imgdir/email.gif" border="0" alt="$lang[altemailuser]" /></a>
+<a href="mailto:$member[email]" title="$lang[altemailuser]"><img src="$imgdir/email.gif" border="0" alt="$lang[altemailuser]" /></a>
 
 |#*XMB TEMPLATE FILE*#|misc_mlist_row_site|#*XMB TEMPLATE*#|
-<a href="$member[site]" target="_blank"><img src="$imgdir/site.gif" border="0" alt="$lang[altvisitsite]" /></a>
+<a href="$member[site]" onclick="window.open(this.href); return false;" title="$lang[altvisitsite]"><img src="$imgdir/site.gif" border="0" alt="$lang[altvisitsite]" /></a>
 
 |#*XMB TEMPLATE FILE*#|misc_mlist_separator|#*XMB TEMPLATE*#|
 <tr>
@@ -3180,10 +3270,10 @@
 <td align="center" width="10%">$onlinetime</td>
 <td>$online[location]</td>
 <td align="center">
-<a href="http://network-tools.com/default.asp?prog=whois&host=$online[ip]" target="_blank" />W</a>
-<a href="http://network-tools.com/default.asp?prog=trace&host=$online[ip]" target="_blank" />T</a>
-<a href="http://network-tools.com/default.asp?prog=lookup&host=$online[ip]" target="_blank">L</a>
-<a href="http://www.networldmap.com/TryIt.htm?GetLocation&amp;Template=demo.htm&amp;ipaddress=$online[ip]" target="_blank">M</a> $online[ip]</a></td>
+<a href="http://network-tools.com/default.asp?prog=whois&host=$online[ip]" onclick="window.open(this.href); return false;" />W</a>
+<a href="http://network-tools.com/default.asp?prog=trace&host=$online[ip]" onclick="window.open(this.href); return false;" />T</a>
+<a href="http://network-tools.com/default.asp?prog=lookup&host=$online[ip]" onclick="window.open(this.href); return false;">L</a>
+<a href="http://www.networldmap.com/TryIt.htm?GetLocation&amp;Template=demo.htm&amp;ipaddress=$online[ip]" onclick="window.open(this.href); return false;">M</a> $online[ip]</a></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|misc_online_today|#*XMB TEMPLATE*#|
@@ -3209,87 +3299,6 @@
 </tr>
 </table>
 
-|#*XMB TEMPLATE FILE*#|misc_search|#*XMB TEMPLATE*#|
-<form method="post" action="misc.php?action=search">
-<input type="hidden" name="token" value="$oToken->newToken" />
-<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
-<tr>
-<td bgcolor="$bordercolor">
-<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
-<tr>
-<td colspan="2" class="category"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textsearchfor]</td>
-<td bgcolor="$altbg2"><input type="text" name="srchtxt" size="30" maxlength="40" /></td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textsrchuname]</td>
-<td bgcolor="$altbg2"><input type="text" name="srchuname" size="30" maxlength="40" /></td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[srchbyforum]</td>
-<td bgcolor="$altbg2">$forumselect</td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[textlfrom]</td>
-<td bgcolor="$altbg2">
-<select name="srchfrom">
-<option value="86400">$lang[day1]</option>
-<option value="604800">$lang[aweek]</option>
-<option value="2592000">$lang[month1]</option>
-<option value="7948800">$lang[month3]</option>
-<option value="15897600">$lang[month6]</option>
-<option value="31536000">$lang[lastyear]</option>
-<option value="0" $selHTML>$lang[beginning]</option>
-</select>
-</td>
-</tr>
-<tr class="tablerow">
-<td bgcolor="$altbg1" width="22%">$lang[srchfilter_double]</td>
-<td bgcolor="$altbg2"><input type="checkbox" name="filter_distinct" value="yes" checked="checked" /></td>
-</tr>
-<tr class="ctrtablerow">
-<td bgcolor="$altbg2" colspan="2"><input type="submit" class="submit" name="searchsubmit" value="$lang[textsearch]" /></td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</form>
-
-|#*XMB TEMPLATE FILE*#|misc_search_nextlink|#*XMB TEMPLATE*#|
-<tr class="mediumtxt" bgcolor="$altbg1">
-<td colspan="3" align="right"><a href="misc.php?action=search&amp;page=$pagenum&amp;$ext&amp;filter_distinct=$filter_distinct&amp;searchsubmit=a">$lang[nextsearch]</a></td>
-</tr>
-
-|#*XMB TEMPLATE FILE*#|misc_search_results|#*XMB TEMPLATE*#|
-<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
-<tr>
-<td bgcolor="$bordercolor">
-<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
-<tr>
-<td class="category" colspan="3"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
-</tr>
-$nextlink
-$searchresults
-$nextlink
-</table>
-</td>
-</tr>
-</table>
-
-|#*XMB TEMPLATE FILE*#|misc_search_results_none|#*XMB TEMPLATE*#|
-<tr class="tablerow">
-<td bgcolor="$altbg2" colspan="3"><span class="mediumtxt">$lang[noresults]</span></td>
-</tr>
-
-|#*XMB TEMPLATE FILE*#|misc_search_results_row|#*XMB TEMPLATE*#|
-<tr class="tablerow">
-<td bgcolor="$altbg1"><strong><a href="viewthread.php?tid={$post['ttid']}&amp;goto=search&amp;pid={$post['pid']}">{$post['subject']}</a></strong><br />$add_pre $show $add_post</td>
-<td bgcolor="$altbg1">$poston<br />$lang[textby]: $postby</td>
-</tr>
-
 |#*XMB TEMPLATE FILE*#|misc_smilies|#*XMB TEMPLATE*#|
 <div align="center">
 <table border="0">
@@ -3321,24 +3330,90 @@
 
 |#*XMB TEMPLATE FILE*#|post_attachmentbox|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td bgcolor="$altbg1">$lang[attachment]</td>
+ <td bgcolor="{$THEME['altbg1']}">{$lang['attachment']}</td>
+ <td bgcolor="{$THEME['altbg2']}" id="uploads">
+  <input type="hidden" name="MAX_FILE_SIZE" value="{$SETTINGS['maxattachsize']}" />
+  <input type="file" name="attach1" size="20" />$attachlimits
+ </td>
+</tr>
+<tr class="tablerow" id="multiattachrow" style="display: none;">
+ <td bgcolor="{$THEME['altbg1']}">{$lang['attachmentm']}</td>
+ <td bgcolor="{$THEME['altbg2']}">
+  <a href="javascript:multiAttach()" id="multiattachlink">{$lang['attachmore']}</a>
+ </td>
+</tr>
+<script type="text/javascript">
+ <!--//--><![CDATA[//><!--
+  var uploadBoxCount = 1;
+  var uploadBoxMax = $maxuploads;
+  var uploadTotalLimits = '{$lang['attachmaxtotal']}';
+
+  if (uploadBoxMax > 1) {
+    document.getElementById('multiattachrow').removeAttribute('style');
+  }
+
+  function multiAttach() {
+    var uploadBoxCode = '';
+    if (uploadBoxCount < uploadBoxMax) {
+      uploadBoxCount++;
+      uploadBoxCode = '<br /><input type="file" name="attach' + uploadBoxCount + '" size="20" />';
+      document.getElementById('uploads').innerHTML += uploadBoxCode;
+      if (uploadBoxCount == 2 && uploadTotalLimits != '') {
+        document.getElementById('multiattachlink').parentNode.innerHTML += '<br />' + uploadTotalLimits;
+      }
+    }
+    if (uploadBoxCount >= uploadBoxMax) {
+      noMoreMultiAttach();
+    }
+  }
+
+  function noMoreMultiAttach() {
+    var multiAttachRow;
+    if (uploadBoxCount == 1) {
+      multiAttachRow = document.getElementById('multiattachrow');
+      multiAttachRow.parentNode.removeChild(multiAttachRow);
+    } else {
+      document.getElementById('multiattachlink').parentNode.innerHTML = uploadTotalLimits;
+    }
+  }
+ //--><!]]>
+</script>
+
+|#*XMB TEMPLATE FILE*#|post_attachment_orphan|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg1"><strong>$lang[attachment]</strong>
+<br />
+<div style="padding-left: 10px;">
+$lang[textfilename] <em>$postinfo[filename]</em>
+<br />
+$lang[textfilesize] <em>$postinfo[filesize] $lang[byte]</em>
+</div>
+</td>
 <td bgcolor="$altbg2">
-<input type="file" name="attach" size="20" />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="leave" checked="checked" />$lang[leaveuntouched].<br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="replace" />$lang[uploadinstead]<br />
 <input type="hidden" name="MAX_FILE_SIZE" value="$SETTINGS[maxattachsize]" />
-<input type="hidden" name="attachment_action" value="edit" />
+<input type="file" name="replace_{$postinfo['aid']}" style="margin-left: 2em;" width="25" size="25" /><br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="rename" />$lang[renamefile]<br />
+<input type="text" name="rename_{$postinfo['aid']}" style="margin-left: 2em;" size="22" value="$postinfo[filename]"/><br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="delete" />$lang[deletecurrent]<br />
 </td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|post_captcha|#*XMB TEMPLATE*#|
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[verificationnote]</td>
-<td bgcolor="$altbg2"><img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" /><br /><br /><input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /></td>
+<td bgcolor="$altbg2">
+ <img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" /><br /><br />
+ <input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /><br />
+ {$lang['captchacaseon']}
+</td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|post_edit|#*XMB TEMPLATE*#|
 $preview
-<form method="post" name="input" action="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$pid" enctype="multipart/form-data">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$pid" enctype="multipart/form-data">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3364,10 +3439,11 @@
 <td bgcolor="$altbg2" class="tablerow">
 <table width="100%">
 <tr>
-<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$postinfo[message]</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">
+$postinfo[message]</textarea></td>
 $smilieinsert
 </tr>
-<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
+<tr><td class="ctrtablerow smalltxt">$moresmilies</td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $offcheck2 /> $lang[textdissmileys]<br />
@@ -3387,7 +3463,6 @@
 <input type="hidden" name="fid" value="$fid" />
 <input type="hidden" name="tid" value="$tid" />
 <input type="hidden" name="pid" value="$pid" />
-<input type="hidden" name="postsubject" value="$postinfo[subject]" />
 </form>
 
 |#*XMB TEMPLATE FILE*#|post_edit_attachment|#*XMB TEMPLATE*#|
@@ -3402,17 +3477,17 @@
 $lang[textdownloads] <em>$postinfo[downloads]</em>
 <br />
 <br />
-<em>&raquo; <a href="./viewthread.php?action=attachment&amp;tid=$tid&amp;pid=$pid">$lang[textdownload]</a></em>
+<em>&raquo; <a href="{$postinfo['url']}">$lang[textdownload]</a></em>
 </div>
 </td>
 <td bgcolor="$altbg2">
-<input type="radio" name="attachment[action]" value="leave" checked="checked" />$lang[leaveuntouched].<br />
-<input type="radio" name="attachment[action]" value="replace" />$lang[uploadinstead]<br />
-<input type="file" name="attachment_replace" style="margin-left: 2em;" width="25" size="25" />
-<input type="hidden" name="MAX_FILE_SIZE" value="$SETTINGS[maxattachsize]" /><br />
-<input type="radio" name="attachment[action]" value="rename" />$lang[renamefile]<br />
-<input type="text" name="attach_name" style="margin-left: 2em;" size="22" value="$postinfo[filename]"/><br />
-<input type="radio" name="attachment[action]" value="delete" />$lang[deletecurrent]<br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="leave" checked="checked" />$lang[leaveuntouched].<br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="replace" />$lang[uploadinstead]<br />
+<input type="hidden" name="MAX_FILE_SIZE" value="$SETTINGS[maxattachsize]" />
+<input type="file" name="replace_{$postinfo['aid']}" style="margin-left: 2em;" width="25" size="25" /><br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="rename" />$lang[renamefile]<br />
+<input type="text" name="rename_{$postinfo['aid']}" style="margin-left: 2em;" size="22" value="$postinfo[filename]"/><br />
+<input type="radio" name="attachment[{$postinfo['aid']}][action]" value="delete" />$lang[deletecurrent]<br />
 </td>
 </tr>
 
@@ -3424,8 +3499,8 @@
 
 |#*XMB TEMPLATE FILE*#|post_newpoll|#*XMB TEMPLATE*#|
 $preview
-<form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" enctype="multipart/form-data">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" enctype="multipart/form-data">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3450,9 +3525,11 @@
 $lang[textimgcodeis] $allowimgcode</span></td>
 <td class="tablerow" bgcolor="$altbg2"><table width="100%">
 <tr>
-<td width="70%"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">
+$message</textarea></td>
 $smilieinsert
 </tr>
+<tr><td class="ctrtablerow smalltxt">$moresmilies</td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $smileoffcheck /> $lang[textdissmileys]<br />
@@ -3462,7 +3539,8 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" valign="top">$lang[pollanswers]</td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="40" name="pollanswers">$pollanswers</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="40" name="pollanswers">
+$pollanswers</textarea></td>
 </tr>
 $attachfile
 $captchapostcheck
@@ -3478,8 +3556,8 @@
 
 |#*XMB TEMPLATE FILE*#|post_newthread|#*XMB TEMPLATE*#|
 $preview
-<form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid" enctype="multipart/form-data" >
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="post.php?action=newthread&amp;fid=$fid" enctype="multipart/form-data" >
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3506,10 +3584,11 @@
 <td class="tablerow" bgcolor="$altbg2">
 <table width="100%">
 <tr>
-<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">
+$message</textarea></td>
 $smilieinsert
 </tr>
-<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
+<tr><td class="ctrtablerow smalltxt">$moresmilies</td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $smileoffcheck /> $lang[textdissmileys]<br />
@@ -3552,7 +3631,7 @@
 <td>$thread[icon]&nbsp;$poston</td>
 </tr>
 <tr bgcolor="$altbg1" class="tablerow">
-<td><strong><font class="subject">$dissubject</font></strong><br /><br /><font class="mediumtxt">$message1</font><br /></td>
+<td><strong><font class="subject">$dissubject</font></strong><br /><br /><font class="mediumtxt">$message1</td>
 </tr>
 </table>
 </td>
@@ -3562,8 +3641,8 @@
 
 |#*XMB TEMPLATE FILE*#|post_reply|#*XMB TEMPLATE*#|
 $preview
-<form method="post" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid" enctype="multipart/form-data">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid" enctype="multipart/form-data">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3587,10 +3666,11 @@
 $lang[textimgcodeis] $allowimgcode</span></td>
 <td class="tablerow" bgcolor="$altbg2"><table width="100%">
 <tr>
-<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">$message</textarea></td>
+<td width="70%" rowspan="2"><textarea rows="12" cols="65" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">
+$message</textarea></td>
 $smilieinsert
 </tr>
-<tr><td class="ctrtablerow smalltxt"><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 175, 250); return false;">[$lang[moresmilies]]</a></td></tr>
+<tr><td class="ctrtablerow smalltxt">$moresmilies</td></tr>
 </table>
 <br />
 <input type="checkbox" name="smileyoff" value="yes" $smileoffcheck /> $lang[textdissmileys]<br />
@@ -3637,10 +3717,106 @@
 <td colspan="2" valign="top" width="19%">$lang[trevltmsg]</td>
 </tr>
 
+|#*XMB TEMPLATE FILE*#|search|#*XMB TEMPLATE*#|
+<form method="get" action="search.php">
+<input type="hidden" name="token" value="" />
+<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
+<tr>
+<td bgcolor="$bordercolor">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
+<tr>
+<td colspan="2" class="category"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textsearchfor]</td>
+<td bgcolor="$altbg2">
+  <input type="text" name="srchtxt" size="30" maxlength="40" /><br />
+  <input type="radio" name="srchfield" value="body" checked="checked" />{$lang['searchbody']}<br />
+  <input type="radio" name="srchfield" value="subject" />{$lang['searchsubject']}<br />
+</td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textsrchuname]</td>
+<td bgcolor="$altbg2"><input type="text" name="srchuname" size="30" maxlength="40" /></td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[srchbyforum]</td>
+<td bgcolor="$altbg2">$forumselect</td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[textlfrom]</td>
+<td bgcolor="$altbg2">
+<select name="srchfrom">
+<option value="86400">$lang[day1]</option>
+<option value="604800">$lang[aweek]</option>
+<option value="2592000">$lang[month1]</option>
+<option value="7948800">$lang[month3]</option>
+<option value="15897600">$lang[month6]</option>
+<option value="31536000">$lang[lastyear]</option>
+<option value="0" $selHTML>$lang[beginning]</option>
+</select>
+</td>
+</tr>
+<tr class="tablerow">
+<td bgcolor="$altbg1" width="22%">$lang[srchfilter_double]</td>
+<td bgcolor="$altbg2"><input type="checkbox" name="filter_distinct" value="yes" checked="checked" /></td>
+</tr>
+$captchasearchcheck
+<tr class="ctrtablerow">
+<td bgcolor="$altbg2" colspan="2"><input type="submit" class="submit" name="searchsubmit" value="$lang[textsearch]" /></td>
+</tr>
+</table>
+</td>
+</tr>
+</table>
+</form>
+
+|#*XMB TEMPLATE FILE*#|search_captcha|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg1">$lang[verificationnote]</td>
+<td bgcolor="$altbg2">
+ <img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" /><br /><br />
+ <input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /><br />
+ {$lang['captchacaseon']}
+</td>
+</tr>
+
+|#*XMB TEMPLATE FILE*#|search_nextlink|#*XMB TEMPLATE*#|
+<tr class="mediumtxt" bgcolor="$altbg1">
+<td colspan="3" align="right"><a href="search.php?page=$pagenum&amp;$ext&amp;filter_distinct=$filter_distinct&amp;searchsubmit=a">$lang[nextsearch]</a></td>
+</tr>
+
+|#*XMB TEMPLATE FILE*#|search_results|#*XMB TEMPLATE*#|
+<table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
+<tr>
+<td bgcolor="$bordercolor">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
+<tr>
+<td class="category" colspan="3"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
+</tr>
+$nextlink
+$searchresults
+$nextlink
+</table>
+</td>
+</tr>
+</table>
+
+|#*XMB TEMPLATE FILE*#|search_results_none|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg2" colspan="3"><span class="mediumtxt">$lang[noresults]</span></td>
+</tr>
+
+|#*XMB TEMPLATE FILE*#|search_results_row|#*XMB TEMPLATE*#|
+<tr class="tablerow">
+<td bgcolor="$altbg1"><strong><a href="viewthread.php?tid={$post['tid']}&amp;goto=search&amp;pid={$post['pid']}">{$post['subject']}</a></strong><br />$add_pre $show $add_post</td>
+<td bgcolor="$altbg1">$poston<br />$lang[textby]: $postby</td>
+</tr>
+
 |#*XMB TEMPLATE FILE*#|spelling_suggestion|#*XMB TEMPLATE*#|
 <br />
-<form action="post.php?fid=$fid&amp;tid=$tid&amp;action=$action&amp;pid=$pid" method="post">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form action="post.php?fid=$fid&amp;tid=$tid&amp;action=$action&amp;pid=$pid" method="POST">
+<input type="hidden" name="token" value="" />
 <table border="0" cellpadding="0" cellspacing="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3668,8 +3844,8 @@
 
 |#*XMB TEMPLATE FILE*#|spelling_suggestion_no|#*XMB TEMPLATE*#|
 <br />
-<form action="post.php?fid=$fid&amp;tid=$tid&amp;action=$action" method="post">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form action="post.php?fid=$fid&amp;tid=$tid&amp;action=$action" method="POST">
+<input type="hidden" name="token" value="" />
 <table border="0" cellpadding="0" cellspacing="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3704,8 +3880,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|today|#*XMB TEMPLATE*#|
-<form method="post" action="today.php">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="today.php">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3747,26 +3923,19 @@
 
 |#*XMB TEMPLATE FILE*#|today_row|#*XMB TEMPLATE*#|
 <tr class="tablerow">
-<td width="4%" bgcolor="$altbg1" align="center">$folder</td>
-<td width="4%" bgcolor="$altbg2" align="center">$thread[icon]</td>
-<td width="43%" bgcolor="$altbg1"><font class="12px">$prefix <a href="viewthread.php?tid=$thread[tid]">$thread[subject]</a> $multipage2</font></td>
-<td width="14%" bgcolor="$altbg2" align="center">$authorlink</td>
-<td width="14%" bgcolor="$altbg1" align="center"><font class="11px"><a href="forumdisplay.php?fid=$thread[fid]">$thread[name]</a></font></td>
-<td width="5%" bgcolor="$altbg2" align="center"><font class="11px">$thread[replies]</font></td>
-<td width="5%" bgcolor="$altbg1" align="center"><font class="11px">$thread[views]</font></td>
-<td width="23%" bgcolor="$altbg2">
-<table cellpadding="0" cellspacing="0" border="0" width="100%">
-<tr class="tablerow" align="right">
-<td bgcolor="$altbg2" nowrap="nowrap"><font size="1" face="verdana">$lastpost</font></td>
-<td bgcolor="$altbg2" nowrap="nowrap">&nbsp;<a href="viewthread.php?goto=lastpost&amp;tid=$thread[tid]"><img src="$imgdir/lastpost.gif" border="0" alt="$lang[altlastpost]" /></a></td>
+<td width="4%" bgcolor="$altbg1" class="ctrtablerow">$folder</td>
+<td width="4%" bgcolor="$altbg2" class="ctrtablerow">$thread[icon]</td>
+<td width="43%" bgcolor="$altbg1" class="tablerow"><font class="12px">$prefix <a href="viewthread.php?tid=$thread[tid]">$thread[subject]</a> $multipage2</font></td>
+<td width="14%" bgcolor="$altbg2" class="ctrtablerow">$authorlink</td>
+<td width="14%" bgcolor="$altbg1" class="ctrtablerow"><font class="11px"><a href="forumdisplay.php?fid=$thread[fid]">$thread[name]</a></font></td>
+<td width="5%" bgcolor="$altbg2" class="ctrtablerow"><font class="11px">$thread[replies]</font></td>
+<td width="5%" bgcolor="$altbg1" class="ctrtablerow"><font class="11px">$thread[views]</font></td>
+<td width="23%" bgcolor="$altbg2" class="rghttablerow">$lastpostrow</td>
 </tr>
-</table>
-</td>
-</tr>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_bump|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=bump">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=bump">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3787,8 +3956,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_copy|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=copy">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=copy">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3814,8 +3983,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_delete|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=delete">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=delete">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3836,8 +4005,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_empty|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=empty">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=empty">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3858,8 +4027,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_merge|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=merge">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=merge">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3885,8 +4054,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_move|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=move">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=move">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -3921,8 +4090,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_openclose|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=$action">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=$action">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3943,8 +4112,8 @@
 </form>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_split|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=split">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=split">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -3985,8 +4154,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_threadprune|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=threadprune">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=threadprune">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -4019,8 +4188,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|topicadmin_topuntop|#*XMB TEMPLATE*#|
-<form method="post" action="topicadmin.php?action=top">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="topicadmin.php?action=top">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
@@ -4095,8 +4264,8 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|u2u_folders|#*XMB TEMPLATE*#|
-<form method="post" action="u2u.php?action=folders">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="u2u.php?action=folders">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -4107,7 +4276,8 @@
 
 <tr class="tablerow">
 <td bgcolor="$altbg1" valign="top">$lang[foldermsg]</td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="30" name="u2ufolders">$self[u2ufolders]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="30" name="u2ufolders">
+$self[u2ufolders]</textarea></td>
 </tr>
 <tr>
 <td class="ctrtablerow" colspan="2" bgcolor="$altbg2"><input type="submit" name="folderssubmit" class="submit" value="$lang[textsubmitchanges]" /></td>
@@ -4124,7 +4294,7 @@
 <tr>
 <td align="center"><font style="font-size: 10px; font-family: Verdana">$versionlong
 <br />
-$lang[developedby]&nbsp;<a href="http://www.xmbforum.com" target="_blank">$lang[xmbgroup]</a>&nbsp;&copy; $copyright</font></td>
+$lang[developedby]&nbsp;<a href="http://www.xmbforum.com" onclick="window.open(this.href); return false;">$lang[xmbgroup]</a>&nbsp;&copy; $copyright</font></td>
 </tr>
 </table>
 </body>
@@ -4164,8 +4334,8 @@
 <br />
 
 |#*XMB TEMPLATE FILE*#|u2u_ignore|#*XMB TEMPLATE*#|
-<form method="post" action="u2u.php?action=ignore">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="u2u.php?action=ignore">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -4175,7 +4345,8 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1" valign="top">$lang[ignoremsg]</td>
-<td bgcolor="$altbg2"><textarea rows="5" cols="30" name="ignorelist">$self[ignoreu2u]</textarea></td>
+<td bgcolor="$altbg2"><textarea rows="5" cols="30" name="ignorelist">
+$self[ignoreu2u]</textarea></td>
 </tr>
 <tr>
 <td class="ctrtablerow" bgcolor="$altbg2" colspan="2"><input type="submit" name="ignoresubmit" class="submit" value="$lang[textsubmitchanges]" /></td>
@@ -4208,8 +4379,8 @@
 </table>
 
 |#*XMB TEMPLATE FILE*#|u2u_main|#*XMB TEMPLATE*#|
-<form method="post" action="u2u.php?action=mod" name="u2u_main">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="u2u.php?action=mod" name="u2u_main">
+<input type="hidden" name="token" value="" />
 $u2ulist
 <br />
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
@@ -4374,8 +4545,8 @@
 <script type="text/javascript" language="JavaScript">
 var sendMode = true;
 </script>
-<form method="post" action="u2u.php?action=send">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="u2u.php?action=send">
+<input type="hidden" name="token" value="" />
 <input name="u2uid" type="hidden" value="$u2uid" />
 $u2upreview
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
@@ -4395,7 +4566,8 @@
 </tr>
 <tr class="tablerow">
 <td valign="top" bgcolor="$altbg1">$lang[textmessage]</td>
-<td bgcolor="$altbg2"><textarea rows="10" name="message" id="message" cols="50">$message</textarea><br /></td>
+<td bgcolor="$altbg2"><textarea rows="10" name="message" id="message" cols="50">
+$message</textarea><br /></td>
 </tr>
 <tr>
 <td valign="top" class="ctrtablerow" bgcolor="$altbg1" colspan="2">
@@ -4462,14 +4634,14 @@
 </table>
 <table cellspacing="2" cellpadding="2" border="0" align="center">
 <tr>
-<td align="right" class="tablerow"><a href="u2u.php?action=printable&amp;u2uid=$u2uid" target="_blank">$lang[textprintver]</a></td>
+<td align="right" class="tablerow"><a href="u2u.php?action=printable&amp;u2uid=$u2uid" onclick="window.open(this.href); return false;">$lang[textprintver]</a></td>
 </tr>
 </table>
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<form method="post" action="u2u.php?action=modif">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" action="u2u.php?action=modif">
+<input type="hidden" name="token" value="" />
 <table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext">$lang[textu2uoptions]</font></td>
@@ -4498,7 +4670,7 @@
 $poll
 <table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
-<td class="smalltxt"><a href="viewthread.php?fid=$fid&amp;tid=$tid&amp;action=printable">$lang[textprintver]</a> | <a href="memcp.php?action=subscriptions&amp;subadd=$tid">$lang[textsubscribe]</a> | <a href="memcp.php?action=favorites&amp;favadd=$tid">$lang[textaddfav]</a></td>
+<td class="smalltxt"><a href="viewthread.php?action=printable&amp;fid=$fid&amp;tid=$tid" rel="alternate">$lang[textprintver]</a>$memcplink</td>
 <td class="post" align="right" valign="bottom">&nbsp;$newtopiclink$newpolllink$replylink</td>
 </tr>
 </table>
@@ -4527,15 +4699,23 @@
 </table>
 $quickreply
 
-|#*XMB TEMPLATE FILE*#|viewthread_invalid|#*XMB TEMPLATE*#|
-<tr class="tablerow">
-<td colspan="8" bgcolor="$altbg1">$notexist</td>
+|#*XMB TEMPLATE FILE*#|viewthread_modlog|#*XMB TEMPLATE*#|
+<tr bgcolor="$thisbg">
+<td valign="top" class="tablerow" style="width: 18%;">
+<font class="mediumtxt"><strong>$profilelink</strong></font>
+<br />
+<div class="smalltxt"><a name="pid$post[pid]"></a>
+$showtitle
+</div>
+</td>
+<td class="tablerow" valign="top" style="width: 82%" >
+<font class="mediumtxt">$post[message]</font></td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|viewthread_modoptions|#*XMB TEMPLATE*#|
 <a NAME="admintools"></a>
 <form action="topicadmin.php?tid=$tid&amp;fid=$fid" method="get">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<input type="hidden" name="token" value="" />
 <span class="mediumtxt"><strong>$lang[textadminoptions]</strong>
 <br />
 <select name="action" id="action" onchange="if(this.options[this.selectedIndex].value != '') { window.location=('topicadmin.php?tid=$tid&amp;fid=$fid&amp;action='+this.options[this.selectedIndex].value) }">
@@ -4560,14 +4740,14 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|viewthread_newpoll|#*XMB TEMPLATE*#|
-<a href="post.php?action=newthread&amp;fid=$fid&amp;poll=yes"><img src="$imgdir/poll.gif" border="0" alt="$lang[textpoll]" /></a>
+<a href="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" title="$lang[textpoll]"><img src="$imgdir/poll.gif" border="0" alt="$lang[textpoll]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_newtopic|#*XMB TEMPLATE*#|
-<a href="post.php?action=newthread&amp;fid=$fid"><img src="$imgdir/newtopic.gif" border="0" alt="$lang[altpostnewthread]" /></a>
+<a href="post.php?action=newthread&amp;fid=$fid" title="$lang[altpostnewthread]"><img src="$imgdir/newtopic.gif" border="0" alt="$lang[altpostnewthread]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_poll|#*XMB TEMPLATE*#|
-<form method="post" name="poll" action="vtmisc.php?action=votepoll&amp;fid=$fid&amp;tid=$tid">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="poll" action="vtmisc.php?action=votepoll&amp;fid=$fid&amp;tid=$tid">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
@@ -4606,7 +4786,7 @@
 |#*XMB TEMPLATE FILE*#|viewthread_post|#*XMB TEMPLATE*#|
 <tr bgcolor="$thisbg">
 <td rowspan="3" valign="top" class="tablerow" style="width: 18%;">
-<a href="./member.php?action=viewpro&amp;member=$encodename"><font class="mediumtxt"><strong>$post[author]</strong></font></a>
+<font class="mediumtxt"><strong>$profilelink</strong></font>
 <br />
 <div class="smalltxt"><a name="pid$post[pid]"></a>
 $showtitle
@@ -4636,7 +4816,7 @@
 <td valign="top" class="tablerow" style="height: 30px; width: 82%;">
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
-<td class="smalltxt" valign="top">$post[icon] $poston</td>
+<td class="smalltxt" valign="top">$post[icon] <a href="viewthread.php?tid={$post['tid']}&amp;goto=search&amp;pid={$post['pid']}" title="$linktitle" rel="nofollow">$poston</a></td>
 <td class="smalltxt" align="right" valign="top">$edit$repquote$reportlink</td>
 </tr>
 </table>
@@ -4665,51 +4845,48 @@
 </tr>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_aim|#*XMB TEMPLATE*#|
-<a href="aim:goim?screenname=$post[aim]&amp;message=Hi+$post[aim].+Are+you+there+I+got+your+aim+name+from+a+message+board."><img src="$imgdir/aim.gif" alt="" border="0" /></a>
+<a href="aim:goim?screenname=$post[aim]&amp;message=Hi+$post[aim].+Are+you+there+I+got+your+aim+name+from+a+message+board." title="{$lang['textaim']}"><img src="$imgdir/aim.gif" alt="" border="0" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_attachment|#*XMB TEMPLATE*#|
+$lang[attachment] <a href="{$post['fileurl']}" onclick="window.open(this.href); return false;">$post[filename]</a> ($attachsize)
 <br />
-<br />
-$lang[attachment] <a href="./viewthread.php?action=attachment&amp;tid=$tid&amp;pid=$post[pid]" target="_blank">$post[filename]</a> ($attachsize)
-<br />
 <font class="smalltxt">$lang[textdownloadcount1] $downloadcount $lang[textdownloadcount2]</font>
-<br />
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_attachmentimage|#*XMB TEMPLATE*#|
-<br />
-<br />
-$post[author] $lang[textattachedimg]<br /><img src="viewthread.php?action=attachment&amp;tid=$tid&amp;pid=$post[pid]" title="$post[filename] - $attachsize" alt="$post[filename] - $attachsize"/>
-<br />
+<img src="{$post['fileurl']}" title="$post[filename] - $attachsize" alt="$post[filename] - $attachsize" {$post['filedims']} />
 
+|#*XMB TEMPLATE FILE*#|viewthread_post_attachmentthumb|#*XMB TEMPLATE*#|
+<a href="{$post['fileurl']}" title="$post[filename] - $attachsize" onclick="window.open(this.href); return false;"><img src="{$post['thumburl']}" alt="$post[filename] - $attachsize" border="0px" {$post['filedims']} /></a>
+
 |#*XMB TEMPLATE FILE*#|viewthread_post_edit|#*XMB TEMPLATE*#|
-<a href="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]"><img src="$imgdir/edit.gif" border="0" alt="$lang[alteditpost]" /></a>
+<a href="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]" title="$lang[alteditpost]"><img src="$imgdir/edit.gif" border="0" alt="$lang[alteditpost]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_email|#*XMB TEMPLATE*#|
-<a href="mailto:$post[email]"><img src="$imgdir/email.gif" border="0" alt="$lang[altemailuser]" /></a>
+<a href="mailto:$post[email]" title="$lang[altemailuser]"><img src="$imgdir/email.gif" border="0" alt="$lang[altemailuser]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_icq|#*XMB TEMPLATE*#|
-<a href="http://people.icq.com/people/about_me.php?uin=$post[icq]" target="_blank"><img src="$imgdir/icq.gif" alt="" border="0" /></a>
+<a href="http://people.icq.com/people/about_me.php?uin=$post[icq]" onclick="window.open(this.href); return false;" title="{$lang['texticq']}"><img src="$imgdir/icq.gif" alt="" border="0" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_ip|#*XMB TEMPLATE*#|
-<a href="topicadmin.php?action=getip&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]"><img src="$imgdir/ip.gif" border="0" alt="$lang[altgetip]" /></a>
+<a href="topicadmin.php?action=getip&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]" title="$lang[altgetip]"><img src="$imgdir/ip.gif" border="0" alt="$lang[altgetip]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_msn|#*XMB TEMPLATE*#|
-<a href="http://members.msn.com/$post[msn]" target="_blank"><img src="$imgdir/msn.gif" border="0" alt="$lang[altmsnyes]" /></a>
+<a href="http://members.msn.com/$post[msn]" onclick="window.open(this.href); return false;" title="$lang[altmsnyes]"><img src="$imgdir/msn.gif" border="0" alt="$lang[altmsnyes]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_nosig|#*XMB TEMPLATE*#|
 </font>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_profile|#*XMB TEMPLATE*#|
-<a href="member.php?action=viewpro&amp;member=$encodename"><img src="$imgdir/profile.gif" border="0" alt="$lang[altviewprofile]" /></a>
+<a href="member.php?action=viewpro&amp;member=$encodename" title="$lang[altviewprofile]"><img src="$imgdir/profile.gif" border="0" alt="$lang[altviewprofile]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_report|#*XMB TEMPLATE*#|
-<a href="vtmisc.php?action=report&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]"><img src="$imgdir/report.gif" border="0" alt="$lang[altreportpost]" /></a>
+<a href="vtmisc.php?action=report&amp;fid=$fid&amp;tid=$tid&amp;pid=$post[pid]" title="$lang[altreportpost]"><img src="$imgdir/report.gif" border="0" alt="$lang[altreportpost]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_repquote|#*XMB TEMPLATE*#|
-<a href="post.php?action=reply&amp;fid=$fid&amp;tid=$tid&amp;repquote=$post[pid]"><img src="$imgdir/quote.gif" border="0" alt="$lang[altquote]" /></a>
+<a href="post.php?action=reply&amp;fid=$fid&amp;tid=$tid&amp;repquote=$post[pid]" title="$lang[altquote]"><img src="$imgdir/quote.gif" border="0" alt="$lang[altquote]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_search|#*XMB TEMPLATE*#|
-<a href="misc.php?action=search&amp;srchuname=$encodename&amp;searchsubmit=a&amp;srchfid=all&amp;srchfrom=0"><img src="$imgdir/find.gif" border="0" alt="$lang[altfindposts]" /></a>
+<a href="search.php?srchuname=$encodename&amp;searchsubmit=a&amp;f=all&amp;srchfrom=0" title="$lang[altfindposts]"><img src="$imgdir/find.gif" border="0" alt="$lang[altfindposts]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_sig|#*XMB TEMPLATE*#|
 </font>
@@ -4720,63 +4897,66 @@
 <div class="sig">$post[sig]</div>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_site|#*XMB TEMPLATE*#|
-<a href="$post[site]" target="_blank"><img src="$imgdir/site.gif" border="0" alt="$lang[altvisitsite]" /></a>
+<a href="$post[site]" onclick="window.open(this.href); return false;" title="$lang[altvisitsite]"><img src="$imgdir/site.gif" border="0" alt="$lang[altvisitsite]" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_u2u|#*XMB TEMPLATE*#|
-<a href="u2u.php?action=send&amp;username=$encodename" onclick="Popup(this.href, 'Window', 700, 500); return false;"><img src="$imgdir/u2u.gif" border="0" alt="{$lang['altu2umember']}" /></a>
+<a href="u2u.php?action=send&amp;username=$encodename" onclick="Popup(this.href, 'Window', 700, 500); return false;" title="{$lang['altu2umember']}"><img src="$imgdir/u2u.gif" border="0" alt="{$lang['altu2umember']}" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_post_yahoo|#*XMB TEMPLATE*#|
-<a href="http://profiles.yahoo.com/$post[yahoo]" target="_blank"><img src="$imgdir/yahoo.gif" alt="" border="0" /></a>
+<a href="http://profiles.yahoo.com/$post[yahoo]" onclick="window.open(this.href); return false;" title="{$lang['textyahoo']}"><img src="$imgdir/yahoo.gif" alt="" border="0" /></a>
 
 |#*XMB TEMPLATE FILE*#|viewthread_printable|#*XMB TEMPLATE*#|
-<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html>
+<?xml version="1.0" encoding="$charset"?>
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<!-- $versionlong  -->
+<!-- Build: $versionbuild -->
+<!-- $versioncompany -->
 <head>
-<meta http-equiv="Content-Type" content="text/html; charset=$charset">
+$baseelement
+<meta http-equiv="Content-Type" content="text/html; charset=$charset" />
+<title>{$SETTINGS['bbname']} $threadSubject - $versionlong</title>
 <style type="text/css">
-p {
+.mediumtxt {
 font-size: 14px;
 font-family: arial, verdana;
 }
 
-.16px {
-font-size: 16px;
-font-family: arial, verdana;
-font-weight: bold;
+h2, h3 {
+margin-bottom: 0px;
+margin-top: 0px;
 }
 
-.14px {
+.s14px {
 font-size: 14px;
 font-family: arial, verdana;
 font-weight: bold;
 }
 
-.13px {
+.s13px {
 font-size: 14px;
 font-family: arial, verdana;
 }
 </style>
-<title>$bbname - $lang[textpowered]</title>
 </head>
 <body>
 $logo
 <br />
 <br />
-<span class="16px">$thread[subject]</span>
+<h2><a href="$threadlink" rel="canonical" rev="alternate">$thread[subject]</a></h2>
 $posts
-<hr />
 </body>
 </html>
 
 |#*XMB TEMPLATE FILE*#|viewthread_printable_row|#*XMB TEMPLATE*#|
-<hr /><span class="14px">$post[author]</span> - <span class="13px">$poston</span>
-<p>$post[message]</p>
+<h3>$subject</h3><span class="s14px">$post[author]</span> - <span class="s13px">$poston</span><br /><br />
+<font class="mediumtxt">$post[message]</font><hr />
 
 |#*XMB TEMPLATE FILE*#|viewthread_quickreply|#*XMB TEMPLATE*#|
 <br />
 <a name="qreply"></a>
-<form method="post" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid">
+<input type="hidden" name="token" value="" />
 <table width="$tablewidth" border="0" align="center" cellpadding="0" cellspacing="0" bgcolor="$bordercolor">
 <tr>
 <td><input type="hidden" name="subject" value="" />
@@ -4789,9 +4969,10 @@
 <td width="8%" height="101" bgcolor="$altbg1" class="tablerow"> <div align="left"><span class="smalltxt">$lang[texthtmlis] $allowhtml<br />
 $lang[textsmiliesare] $allowsmilies<br />
 $lang[textbbcodeis] $allowbbcode<br />
-$lang[textimgcodeis] $allowimgcode</span><hr /></div><div align="center">
-$smilies<br /><a href="misc.php?action=smilies" onclick="Popup(this.href, 'Window', 200, 250); return false;">{$lang['moresmilies']}</a></div></td>
+$lang[textimgcodeis] $allowimgcode</span></div>
+$smilies
 <td bgcolor="$altbg2" width="56%" class="tablerow"> <div align="center"><textarea rows="10" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);" style="width: 100%;"></textarea></div></td>
+$quickbbcode
 <td width="20%" height="101" bgcolor="$altbg2" class="tablerow"> <div align="center">
 <table width="100%" border="0" class="tablerow" cellspacing="0" cellpadding="0">
 <tr>
@@ -4811,7 +4992,10 @@
 <td width="85%"> <div align="left">$lang[textemailnotify] </div></td>
 </tr>
 </table></div>
-<div align="left"><br />&nbsp;&nbsp;<input type="submit" name="replysubmit" value="$lang[textpostreply]" class="submit" /></div></td>
+<div align="left">
+<br />&nbsp;&nbsp;<input type="submit" name="replysubmit" value="$lang[textpostreply]" class="submit" />
+<br /><br />&nbsp;&nbsp;<input type="submit" name="previewpost" value="$lang[textpreview]" class="submit" />
+</div></td>
 </tr>
 </table>
 </td>
@@ -4821,23 +5005,21 @@
 
 |#*XMB TEMPLATE FILE*#|viewthread_quickreply_captcha|#*XMB TEMPLATE*#|
 <tr>
-<td colspan="3" class="ctrtablerow" bgcolor="$altbg1">
-$lang[verificationnote]
-<br />
-<br />
-<img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" />
-<br />
-<br />
-<input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" />
+<td bgcolor="$altbg1" />
+<td class="rghttablerow" bgcolor="$altbg2">
+ <img src="misc.php?action=captchaimage&amp;imagehash=$imghash" alt="$lang[captchaverification]" title="$lang[captchaverification]" /><br />
+ <input type="text" name="imgcode" value="" /><input type="hidden" name="imghash" value="$imghash" /><br />
+ {$lang['captchacaseon']}
 </td>
+<td class="tablerow" bgcolor="$altbg2">$lang[verificationnote]</td>
 </tr>
 
 |#*XMB TEMPLATE FILE*#|viewthread_reply|#*XMB TEMPLATE*#|
 <a href="./post.php?action=reply&amp;fid=$fid&amp;tid=$tid"><img src="$imgdir/reply.gif" border="0" alt="$lang[textpostreply]" /></a>
 
 |#*XMB TEMPLATE FILE*#|vtmisc_report|#*XMB TEMPLATE*#|
-<form method="post" name="input" action="vtmisc.php?action=report">
-<input type="hidden" name="token" value="$oToken->newToken" />
+<form method="POST" name="input" action="vtmisc.php?action=report">
+<input type="hidden" name="token" value="" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
Index: today.php
===================================================================
--- today.php	(revision 1746)
+++ today.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -31,6 +30,7 @@
 require 'header.php';
 
 loadtemplates(
+'forumdisplay_thread_lastpost',
 'today',
 'today_noposts',
 'today_row',
@@ -41,52 +41,20 @@
 
 nav($lang['navtodaysposts']);
 
-eval('$css = "'.template('css').'";');
-eval('echo "'.template('header').'";');
-
 if ($SETTINGS['todaysposts'] == 'off') {
-    error($lang['fnasorry3'], false);
+    header('HTTP/1.0 403 Forbidden');
+    error($lang['fnasorry3'], TRUE);
 }
 
-$daysold = (isset($daysold) && is_numeric($daysold) ? (int) $daysold : 1);
+$daysold = getInt('daysold', 'r');
+if ($daysold < 1) {
+    $daysold = 1;
+}
 $srchfrom = $onlinetime - (86400 * $daysold);
 
-$fids = array();
 $tids = array();
-$fup = array();
+$fids = permittedForums(forumCache(), 'thread', 'csv');
 
-if (X_SADMIN) {
-    $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE status = 'on'");
-    while($f = $db->fetch_array($q)) {
-        $fids[] = $f['fid'];
-    }
-} else {
-    $fCache = array();
-    $q = $db->query("SELECT fid, postperm, userlist, password, type, fup FROM ".X_PREFIX."forums WHERE status = 'on' AND type != 'group' ORDER BY type ASC");
-    while($forum = $db->fetch_array($q)) {
-        $perms = checkForumPermissions($forum);
-        $fCache[$forum['fid']] = $perms;
-
-        if ($perms[X_PERMS_VIEW] && $perms[X_PERMS_USERLIST] && $perms[X_PERMS_PASSWORD]) {
-            if ($forum['type'] == 'sub') {
-                // also check above forum!
-                $parentP = $fCache[$forum['fup']];
-                if ($parentP[X_PERMS_VIEW] && $parentP[X_PERMS_USERLIST] && $parentP[X_PERMS_PASSWORD]) {
-                    $fids[] = $forum['fid'];
-                }
-            } else {
-                $fids[] = $forum['fid'];
-            }
-        }
-    }
-}
-
-if (count($fids) == 0) {
-    error($lang['nopoststoday'], false);
-}
-
-$fids = implode(', ', $fids);
-
 $query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE lastpost >= '$srchfrom' AND fid IN ($fids)");
 $results = $db->num_rows($query);
 while($t = $db->fetch_array($query)) {
@@ -95,11 +63,29 @@
 $db->free_result($query);
 $tids = implode(', ', $tids);
 
+eval('$css = "'.template('css').'";');
+
 if ($results == 0) {
+    eval('$header = "'.template('header').'";');
     $noPostsMessage = ($daysold == 1) ? $lang['nopoststoday'] : $lang['noPostsTimePeriod'];
     $multipage = '';
     eval('$rows = "'.template('today_noposts').'";');
 } else {
+    validateTpp();
+    validatePpp();
+
+    if ($daysold == 1) {
+        $mpage = multipage($results, $tpp, 'today.php');
+    } else {
+        $mpage = multipage($results, $tpp, 'today.php?daysold='.$daysold);
+    }
+    $multipage =& $mpage['html'];
+    if (strlen($mpage['html']) != 0) {
+        eval('$multipage = "'.template('today_multipage').'";');
+    }
+
+    eval('$header = "'.template('header').'";');
+
     $t_extension = get_extension($lang['toppedprefix']);
     switch($t_extension) {
         case 'gif':
@@ -120,28 +106,15 @@
             break;
     }
 
-    validateTpp();
-    validatePpp();
-
-    $max_page = (int) ($results / $tpp) + 1;
-    $page = (isset($page) && is_numeric($page) && $page >= 1 && $page <= $max_page) ? ($page < 1 ? 1 : ((int) $page)) : 1;
-    $start_limit = ($page > 1) ? (($page-1) * $tpp) : 0;
-
-    $mpurl = 'today.php?daysold='.$daysold;
-    $multipage = '';
-    if (($multipage = multi($results, $tpp, $page, $mpurl)) !== false) {
-        eval('$multipage = "'.template('today_multipage').'";');
-    }
-
-    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN ($tids) ORDER BY t.lastpost DESC LIMIT $start_limit, $tpp");
+    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN ($tids) ORDER BY t.lastpost DESC LIMIT {$mpage['start']}, $tpp");
     $today_row = array();
     $tmOffset = ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600);
     while($thread = $db->fetch_array($query)) {
         $thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
         $thread['name'] = fnameOut($thread['name']);
 
-        if ($thread['author'] == $lang['textanonymous']) {
-            $authorlink = $thread['author'];
+        if ($thread['author'] == 'Anonymous') {
+            $authorlink = $lang['textanonymous'];
         } else {
             $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
 
@@ -151,13 +124,13 @@
         $dalast = $lastpost[0];
         $lastPid = $lastpost[2];
 
-        if ($lastpost[1] != $lang['textanonymous']) {
+        if ($lastpost[1] != 'Anonymous') {
             $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         }
 
         $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
         $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
-        $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.'<br />'.$lang['textby'].' '.$lastpost[1];
+        $lastpost = $lastreplydate.' '.$lang['textat'].' '.$lastreplytime.'<br />'.$lang['textby'].' '.$lastpost[1];
 
         if ($thread['icon'] != '' && file_exists($smdir.'/'.$thread['icon'])) {
             $thread['icon'] = '<img src="'.$smdir.'/'.$thread['icon'].'" alt="'.$thread['icon'].'" border="0" />';
@@ -188,6 +161,8 @@
             }
         }
 
+        eval('$lastpostrow = "'.template('forumdisplay_thread_lastpost').'";');
+
         $prefix = '';
         if ($thread['pollopts'] == 1) {
             $prefix = $lang['pollprefix'].' ';
@@ -197,12 +172,12 @@
             $prefix = $lang['toppedprefix'].' '.$prefix;
         }
 
-        if ($thread['posts'] > $ppp) {
-            $pagelinks = multi($thread['posts'], $ppp, 0, 'viewthread.php?tid='.$thread['tid']);
-            $multipage2 = '(<small>'.$pagelinks.'</small>)';
-        } else {
-            $pagelinks = $multipage2 = '';
+        $mpurl = 'viewthread.php?tid='.$thread['tid'];
+        $multipage2 = multi(1, quickpage($thread['replies']+1, $ppp), $mpurl, FALSE);
+        if (strlen($multipage2) != 0) {
+            $multipage2 = "(<small>$multipage2</small>)";
         }
+        unset($mpurl);
 
         eval('$today_row[] = "'.template('today_row').'";');
     }
@@ -210,8 +185,9 @@
     $db->free_result($query);
 }
 
-eval('echo "'.template('today').'";');
+eval('$todaypage = "'.template('today').'";');
 
 end_time();
-eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+eval('$footer = "'.template('footer').'";');
+echo $header.$todaypage.$footer;
+?>
Index: tools.php
===================================================================
--- tools.php	(revision 1746)
+++ tools.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -59,34 +58,23 @@
 
 switch($action) {
     case 'fixftotals':
-        $fquery = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum'");
-        while($forum = $db->fetch_array($fquery)) {
-            $threadnum = $postnum = $sub_threadnum = $sub_postnum = 0;
-            $squery = $stquery = $spquery = $ftquery = $fpquery = '';
-            $squery = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$forum[fid]' AND type='sub'");
-            while($sub = $db->fetch_array($squery)) {
-                $stquery = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."threads WHERE fid='$sub[fid]'");
-                $sub_threadnum = $db->result($stquery, 0);
+        // Update all forums using as few queries as possible.
+        $sql = "UPDATE ".X_PREFIX."forums AS f "
+             . " INNER JOIN (SELECT fid, COUNT(tid) AS tcount FROM ".X_PREFIX."threads GROUP BY fid) AS query2 ON f.fid=query2.fid "
+             . " INNER JOIN (SELECT fid, COUNT(pid) AS pcount FROM ".X_PREFIX."posts GROUP BY fid) AS query3 ON f.fid=query3.fid "
+             . "SET f.threads = query2.tcount, f.posts = query3.pcount "
+             . "WHERE f.type = 'sub'";
+        $db->query($sql);
 
-                $spquery = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE fid='$sub[fid]'");
-                $sub_postnum = $db->result($spquery, 0);
+        $sql = "UPDATE ".X_PREFIX."forums AS f "
+             . " LEFT JOIN (SELECT fup, SUM(threads) AS tcount, SUM(posts) AS pcount FROM ".X_PREFIX."forums GROUP BY fup) AS query2 ON f.fid=query2.fup "
+             . " LEFT JOIN (SELECT fid, COUNT(tid) AS tcount FROM ".X_PREFIX."threads GROUP BY fid) AS query3 ON f.fid=query3.fid "
+             . " LEFT JOIN (SELECT fid, COUNT(pid) AS pcount FROM ".X_PREFIX."posts GROUP BY fid) AS query4 ON f.fid=query4.fid "
+             . "SET f.threads = IFNULL(query2.tcount, 0) + IFNULL(query3.tcount, 0), "
+             . "    f.posts   = IFNULL(query2.pcount, 0) + IFNULL(query4.pcount, 0) "
+             . "WHERE f.type = 'forum'";
+        $db->query($sql);
 
-                $db->query("UPDATE ".X_PREFIX."forums SET threads='$sub_threadnum', posts='$sub_postnum' WHERE fid='$sub[fid]'");
-                $threadnum += $sub_threadnum;
-                $postnum += $sub_postnum;
-            }
-            $db->free_result($squery);
-
-            $ftquery = $db->query("SELECT COUNT(tid) FROM ".X_PREFIX."threads WHERE fid='$forum[fid]'");
-            $threadnum += $db->result($ftquery, 0);
-            $db->free_result($ftquery);
-
-            $fpquery = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE fid='$forum[fid]'");
-            $postnum += $db->result($fpquery, 0);
-            $db->free_result($fpquery);
-
-            $db->query("UPDATE ".X_PREFIX."forums SET threads='$threadnum', posts='$postnum' WHERE fid='$forum[fid]'");
-        }
         nav($lang['tools']);
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['tool_completed'].' - '.$lang['tool_forumtotal'].'</td></tr></table></table>';
         end_time();
@@ -95,14 +83,12 @@
         break;
 
     case 'fixttotals':
-        $queryt = $db->query("SELECT * FROM ".X_PREFIX."threads");
-        while($threads = $db->fetch_array($queryt)) {
-            $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$threads[tid]'");
-            $replynum = $db->result($query, 0) -1;
-            $db->free_result($query);
-            $db->query("UPDATE ".X_PREFIX."threads SET replies='$replynum' WHERE tid='$threads[tid]'");
-        }
-        $db->free_result($queryt);
+        // Update all threads using as few queries as possible.
+        $sql = "UPDATE ".X_PREFIX."threads AS t "
+             . " INNER JOIN (SELECT tid, COUNT(pid) as pcount FROM ".X_PREFIX."posts GROUP BY tid) AS query2 USING (tid) "
+             . "SET t.replies = query2.pcount - 1";
+        $db->query($sql);
+
         nav($lang['tools']);
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['tool_completed'].' - '.$lang['tool_threadtotal'].'</td></tr></table></table>';
         end_time();
@@ -111,15 +97,12 @@
         break;
 
     case 'fixmposts':
-        $queryt = $db->query("SELECT username FROM ".X_PREFIX."members");
-        while($mem = $db->fetch_array($queryt)) {
-            $mem['username'] = addslashes(stripslashes($mem['username']));
-            $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE author='$mem[username]'");
-            $postsnum = $db->result($query, 0);
-            $db->free_result($query);
-            $db->query("UPDATE ".X_PREFIX."members SET postnum='$postsnum' WHERE username='$mem[username]'");
-        }
-        $db->free_result($queryt);
+        // Update all members using as few queries as possible.
+        $sql = "UPDATE ".X_PREFIX."members AS m "
+             . " INNER JOIN (SELECT author, COUNT(pid) as pcount FROM ".X_PREFIX."posts GROUP BY author) AS query2 ON m.username = query2.author "
+             . "SET m.postnum = query2.pcount";
+        $db->query($sql);
+
         nav($lang['tools']);
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['tool_completed'].' - '.$lang['tool_mempost'].'</td></tr></table></table>';
         end_time();
@@ -129,29 +112,92 @@
 
     case 'fixlastposts':
         if (postedVar('scope', '', FALSE, FALSE, FALSE, 'g') == 'forumsonly') {
-            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE (fup='0' OR fup='') AND type='forum'");
+            // Update all forums using as few queries as possible
+            $sql = 'SELECT f.fid, f.lastpost, p.author, p.dateline, p.pid, log.username, log.date '
+                 . 'FROM '.X_PREFIX.'forums AS f '
+                 . 'LEFT JOIN '.X_PREFIX.'posts AS p ON f.fid=p.fid '
+                 . 'INNER JOIN ( '
+                 . '    SELECT p2.fid, MAX(pid) AS lastpid '
+                 . '    FROM '.X_PREFIX.'posts AS p2 '
+                 . '    INNER JOIN ( '
+                 . '        SELECT fid, MAX(dateline) AS lastdate '
+                 . '        FROM '.X_PREFIX.'posts '
+                 . '        GROUP BY fid '
+                 . '    ) AS query3 ON p2.fid=query3.fid AND p2.dateline=query3.lastdate '
+                 . '    GROUP BY p2.fid '
+                 . ') AS query2 ON p.pid=query2.lastpid '
+                 . 'LEFT JOIN ( /* Self-join order is critical with no unique key available */ '
+                 . '    SELECT log2.fid, log2.date, log2.username '
+                 . '    FROM '.X_PREFIX.'logs AS log2 '
+                 . '    INNER JOIN ( '
+                 . '        SELECT fid, MAX(`date`) AS lastdate '
+                 . '        FROM '.X_PREFIX.'logs '
+                 . '        WHERE `action` = "bump" '
+                 . '        GROUP BY fid '
+                 . '    ) AS query4 ON log2.fid=query4.fid AND log2.date=query4.lastdate '
+                 . ') AS log ON f.fid=log.fid '
+                 . 'WHERE f.type="forum"';
+
+            $q = $db->query($sql);
             while($loner = $db->fetch_array($q)) {
                 $lastpost = array();
-                $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$loner[fid]'");
+
+                // Update all subforums using as few queries as possible
+                $sql = 'SELECT f.fid, f.lastpost, p.author, p.dateline, p.pid, log.username, log.date '
+                     . 'FROM '.X_PREFIX.'forums AS f '
+                     . 'LEFT JOIN '.X_PREFIX.'posts AS p ON f.fid=p.fid '
+                     . 'INNER JOIN ( '
+                     . '    SELECT p2.fid, MAX(pid) AS lastpid '
+                     . '    FROM '.X_PREFIX.'posts AS p2 '
+                     . '    INNER JOIN ( '
+                     . '        SELECT fid, MAX(dateline) AS lastdate '
+                     . '        FROM '.X_PREFIX.'posts '
+                     . '        GROUP BY fid '
+                     . '    ) AS query3 ON p2.fid=query3.fid AND p2.dateline=query3.lastdate '
+                     . '    GROUP BY p2.fid '
+                     . ') AS query2 ON p.pid=query2.lastpid '
+                     . 'LEFT JOIN ( /* Self-join order is critical with no unique key available */ '
+                     . '    SELECT log2.fid, log2.date, log2.username '
+                     . '    FROM '.X_PREFIX.'logs AS log2 '
+                     . '    INNER JOIN ( '
+                     . '        SELECT fid, MAX(`date`) AS lastdate '
+                     . '        FROM '.X_PREFIX.'logs '
+                     . '        WHERE `action` = "bump" '
+                     . '        GROUP BY fid '
+                     . '    ) AS query4 ON log2.fid=query4.fid AND log2.date=query4.lastdate '
+                     . ') AS log ON f.fid=log.fid '
+                     . 'WHERE f.fup='.$loner['fid'];
+
+                $subq = $db->query($sql);
                 while($sub = $db->fetch_array($subq)) {
-                    $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
-                    if ($db->num_rows($pq) > 0) {
-                        $curr = $db->fetch_array($pq);
-                        $lastpost[] = $curr;
-                        $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
+                    if ($sub['pid'] !== NULL) {
+                        if ($sub['date'] !== NULL) {
+                            if ($sub['date'] > $sub['dateline']) {
+                                $sub['dateline'] = $sub['date'];
+                                $sub['author'] = $sub['username'];
+                            }
+                        }
+                        $lastpost[] = $sub;
+                        $lp = $sub['dateline'].'|'.$sub['author'].'|'.$sub['pid'];
                     } else {
                         $lp = '';
                     }
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
-                    $db->free_result($pq);
+                    if ($sub['lastpost'] != $lp) {
+                        $lp = $db->escape_var($lp);
+                        $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid={$sub['fid']}");
+                    }
                 }
                 $db->free_result($subq);
 
-                $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$loner[fid]' ORDER BY pid DESC LIMIT 1");
-                if ($db->num_rows($pq) > 0) {
-                    $lastpost[] = $db->fetch_array($pq);
+                if ($loner['pid'] !== NULL) {
+                    if ($loner['date'] !== NULL) {
+                        if ($loner['date'] > $loner['dateline']) {
+                            $loner['dateline'] = $loner['date'];
+                            $loner['author'] = $loner['username'];
+                        }
+                    }
+                    $lastpost[] = $loner;
                 }
-                $db->free_result($pq);
 
                 if (count($lastpost) == 0) {
                     $lastpost = '';
@@ -166,76 +212,64 @@
                     }
                     $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
                 }
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$loner[fid]'");
+                $lastpost = $db->escape_var($lastpost);
+                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='{$loner['fid']}'");
             }
             $db->free_result($q);
 
-            $q = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='group'");
-            while($cat = $db->fetch_array($q)) {
-                $fq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE type='forum' AND fup='$cat[fid]'");
-                while($forum = $db->fetch_array($fq)) {
-                    $lastpost = array();
-                    $subq = $db->query("SELECT fid FROM ".X_PREFIX."forums WHERE fup='$forum[fid]'");
-                    while($sub = $db->fetch_array($subq)) {
-                        $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$sub[fid]' ORDER BY pid DESC LIMIT 1");
-                        if ($db->num_rows($pq) > 0) {
-                            $curr = $db->fetch_array($pq);
-                            $lastpost[] = $curr;
-                            $lp = $curr['dateline'].'|'.$curr['author'].'|'.$curr['pid'];
-                        } else {
-                            $lp = '';
-                        }
-                        $db->free_result($pq);
-                        $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lp' WHERE fid='$sub[fid]'");
-                    }
-                    $db->free_result($subq);
-
-                    $pq = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE fid='$forum[fid]' ORDER BY pid DESC LIMIT 1");
-                    if ($db->num_rows($pq) > 0) {
-                        $lastpost[] = $db->fetch_array($pq);
-                    }
-                    $db->free_result($pq);
-
-                    if (count($lastpost) == 0) {
-                        $lastpost = '';
-                    } else {
-                        $top = 0;
-                        $mkey = -1;
-                        foreach($lastpost as $key => $v) {
-                            if ($v['dateline'] > $top) {
-                                $mkey = $key;
-                                $top = $v['dateline'];
-                            }
-                        }
-                        $lastpost = $lastpost[$mkey]['dateline'].'|'.$lastpost[$mkey]['author'].'|'.$lastpost[$mkey]['pid'];
-                    }
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$lastpost' WHERE fid='$forum[fid]'");
-                }
-                $db->free_result($fq);
-            }
-            $db->free_result($q);
-
         } else { // Update all threads using as few queries as possible
-            $newsql = 'SELECT t.tid, t.lastpost, p.author, p.dateline, p.pid '
+            $newsql = 'SELECT t.tid, t.lastpost, t.closed, p.author, p.dateline, p.pid, log.username, log.date '
                     . 'FROM '.X_PREFIX.'threads AS t '
                     . 'LEFT JOIN '.X_PREFIX.'posts AS p ON t.tid=p.tid '
-                    . 'INNER JOIN ('
-                    . '    SELECT MAX(pid) AS lastpid '
-                    . '    FROM '.X_PREFIX.'posts '
-                    . '    GROUP BY tid'
-                    . ') AS query2 ON p.pid=query2.lastpid';
+                    . 'INNER JOIN ( '
+                    . '    SELECT p2.tid, MAX(pid) AS lastpid '
+                    . '    FROM '.X_PREFIX.'posts AS p2 '
+                    . '    INNER JOIN ( '
+                    . '        SELECT tid, MAX(dateline) AS lastdate '
+                    . '        FROM '.X_PREFIX.'posts '
+                    . '        GROUP BY tid '
+                    . '    ) AS query3 ON p2.tid=query3.tid AND p2.dateline=query3.lastdate '
+                    . '    GROUP BY p2.tid '
+                    . ') AS query2 ON p.pid=query2.lastpid '
+                    . 'LEFT JOIN ( /* Self-join order is critical with no unique key available */ '
+                    . '    SELECT log2.tid, log2.date, log2.username '
+                    . '    FROM '.X_PREFIX.'logs AS log2 '
+                    . '    INNER JOIN ( '
+                    . '        SELECT tid, MAX(`date`) AS lastdate '
+                    . '        FROM '.X_PREFIX.'logs '
+                    . '        WHERE `action` = "bump" '
+                    . '        GROUP BY tid '
+                    . '    ) AS query4 ON log2.tid=query4.tid AND log2.date=query4.lastdate '
+                    . ') AS log ON t.tid=log.tid';
 
             $lpquery = $db->query($newsql);
 
             while($thread = $db->fetch_array($lpquery)) {
-                if ($thread['pid'] !== NULL) {
+                if (!is_null($thread['pid'])) {
+                    if ($thread['dateline'] == '0' And substr($thread['closed'], 0, 6) == 'moved|') {
+                        // Handle situation where versions before 1.9.11 set posts.dateline=0 when redirecting threads.
+                        $newtid = intval(substr($thread['closed'], 6));
+                        $lastdate = $db->result($db->query("SELECT MAX(dateline) AS lastdate FROM ".X_PREFIX."posts WHERE tid=$newtid"), 0);
+                        if (is_null($lastdate)) {
+                            // Redirector is orphaned.  Set dateline to some non-zero value.
+                            $db->query("UPDATE ".X_PREFIX."posts SET dateline=1 WHERE tid={$thread['tid']} AND dateline = 0");
+                        } else {
+                            $thread['dateline'] = $lastdate;
+                            $db->query("UPDATE ".X_PREFIX."posts SET dateline=$lastdate WHERE tid={$thread['tid']} AND dateline = 0");
+                        }
+                    }
                     $lp = $thread['dateline'].'|'.$thread['author'].'|'.$thread['pid'];
+                    if (!is_null($thread['date'])) {
+                        if ($thread['date'] > $thread['dateline']) {
+                            $lp = $thread['date'].'|'.$thread['username'].'|'.$thread['pid'];
+                        }
+                    }
                 } else {
                     $lp = '';
                 }
 
                 if ($thread['lastpost'] != $lp) {
-                    $lp = $db->escape($lp);
+                    $lp = $db->escape_var($lp);
                     $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$lp' WHERE tid={$thread['tid']}");
                 }
             }
@@ -257,7 +291,8 @@
             echo '</form>';
         } else {
             $export_fid = formInt('export_fid');
-            if (!$export_fid) {
+            $export_forum = getForum($export_fid);
+            if ($export_forum['type'] != 'forum' And $export_forum['type'] != 'sub') {
                 error($lang['export_fid_not_there'], false, '</table></table><br />');
             }
 
@@ -286,6 +321,47 @@
         }
         break;
 
+    case 'fixorphanedposts':
+        if (noSubmit('orphpostsubmit')) {
+            echo '<form action="tools.php?action=fixorphanedposts" method="post">';
+            echo '<tr bgcolor="'.$altbg1.'" class="ctrtablerow"><td><input type="text" name="export_tid" size="4"/>&nbsp;'.$lang['export_tid_expl'].'</td></tr>';
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td><input class="submit" type="submit" name="orphpostsubmit" value="'.$lang['textsubmitchanges'].'" /></td></tr>';
+            echo '</form>';
+        } else {
+            // Validate Input
+            $export_tid = formInt('export_tid');
+            $query = $db->query("SELECT fid FROM ".X_PREFIX."threads WHERE tid=$export_tid");
+            if ($db->num_rows($query) != 1) {
+                error($lang['export_tid_not_there'], false, '</table></table><br />');
+            }
+            $row = $db->fetch_array($query);
+            $export_fid = $row['fid'];
+            $db->free_result($query);
+            
+            // Fix Invalid FIDs
+            $db->query("UPDATE ".X_PREFIX."posts AS p INNER JOIN ".X_PREFIX."threads AS t USING (tid) "
+                     . "SET p.fid = t.fid "
+                     . "WHERE p.fid != t.fid");
+            $i = $db->affected_rows();
+            
+            // Fix Invalid TIDs
+            $db->query("UPDATE ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) "
+                     . "SET p.fid = $export_fid, p.tid = $export_tid "
+                     . "WHERE t.tid IS NULL");
+            $i += $db->affected_rows();
+
+            updatethreadcount($export_tid);
+            updateforumcount($export_fid);
+            $forum = getForum($export_fid);
+            if ($forum['type'] == 'sub') {
+                updateforumcount($forum['fup']);
+            }
+            
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>';
+            echo $i.$lang['o_posts_found'].'</td></tr>';
+        }
+        break;
+
     case 'fixorphanedattachments':
         if (noSubmit('orphattachsubmit')) {
             echo '<form action="tools.php?action=fixorphanedattachments" method="post">';
@@ -293,20 +369,44 @@
             echo '<input type="submit" name="orphattachsubmit" value="'.$lang['o_attach_submit'].'" /></td></tr>';
             echo '</form>';
         } else {
-            $i = 0;
-            $q = $db->query("SELECT aid, pid FROM ".X_PREFIX."attachments");
-            while($a = $db->fetch_array($q)) {
-               $result = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE pid={$a['pid']}");
-                  if ($db->num_rows($result) == 0) {
-                  $db->free_result($result);
-                  $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid={$a['aid']}");
-                  $i++;
+            require('include/attach-admin.inc.php');
+            $i = deleteOrphans();
+
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>';
+            echo $i.$lang['o_attachments_found'].'</td></tr>';
+        }
+        break;
+
+    case 'fixorphanedpolls':
+        if (noSubmit('orphpollsubmit')) {
+            echo '<form action="tools.php?action=fixorphanedpolls" method="post">';
+            echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>';
+            echo '<input type="submit" name="orphpollsubmit" value="'.$lang['o_poll_submit'].'" /></td></tr>';
+            echo '</form>';
+        } else {
+            $q = $db->query("SELECT topic_id "
+                          . "FROM ".X_PREFIX."vote_desc AS v "
+                          . "LEFT JOIN ".X_PREFIX."threads AS t ON t.tid=v.topic_id "
+                          . "WHERE t.tid IS NULL");
+            $i = $db->num_rows($q);
+            if ($i > 0) {
+                $tids = array();
+                while($row = $db->fetch_array($q)) {
+                    $tids[] = $row['topic_id'];
                 }
+                $tids = implode(', ', $tids);
+                
+                // Important: Do not alias tables in multi-table delete queries as long as MySQL 4.0 is supported.
+                $db->query("DELETE FROM ".X_PREFIX."vote_desc, ".X_PREFIX."vote_results, ".X_PREFIX."vote_voters "
+                         . "USING ".X_PREFIX."vote_desc "
+                         . "LEFT JOIN ".X_PREFIX."vote_results ON ".X_PREFIX."vote_results.vote_id = ".X_PREFIX."vote_desc.vote_id "
+                         . "LEFT JOIN ".X_PREFIX."vote_voters  ON ".X_PREFIX."vote_voters.vote_id  = ".X_PREFIX."vote_desc.vote_id "
+                         . "WHERE ".X_PREFIX."vote_desc.topic_id IN ($tids)");
+
             }
-            $db->free_result($q);
 
             echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>';
-            echo $i.$lang['o_attachments_found'].'</td></tr>';
+            echo $i.$lang['o_polls_found'].'</td></tr>';
         }
         break;
 
@@ -330,7 +430,7 @@
             eval('echo "'.template('footer').'";');
             exit();
         } else {
-            redirect('./cp.php', 0);
+            redirect($full_url.'cp.php', 0);
         }
         break;
 
@@ -345,7 +445,7 @@
             eval('echo "'.template('footer').'";');
             exit();
         } else {
-            redirect('./cp.php', 0);
+            redirect($full_url.'cp.php', 0);
         }
         break;
 
@@ -357,74 +457,50 @@
         if (noSubmit('yessubmit')) {
             echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['logsdump_confirm'].'<br /><form action="tools.php?action=logsdump" method="post"><input type="submit" name="yessubmit" value="'.$lang['textyes'].'" /> - <input type="submit" name="yessubmit" value="'.$lang['textno'].'" /></form></td></tr>';
         } else if ($lang['textyes'] == $yessubmit) {
-            $db->query("TRUNCATE ".X_PREFIX."logs");
+            $db->query("DELETE FROM ".X_PREFIX."logs WHERE fid=0");
             nav($lang['tools']);
             echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['tool_completed'].' - '.$lang['tool_logs'].'</td></tr></table></table>';
             end_time();
             eval('echo "'.template('footer').'";');
             exit();
         } else {
-            redirect('./cp.php', 0);
+            redirect($full_url.'cp.php', 0);
         }
         break;
 
     case 'repairtables':
-        $start = true;
+        $start = TRUE;
         @set_time_limit(180);
-        $tables = $db->fetch_tables($dbname);
-        $q = array();
-        foreach($tables as $key=>$val) {
-            if ($start) {
-                dump_query($db->query('REPAIR TABLE `'.$val.'`'));
-                $start = false;
-            } else {
-                dump_query($db->query('REPAIR TABLE `'.$val.'`'), false);
-            }
+        foreach($tables as $val) {
+            dump_query($db->query('REPAIR TABLE `'.X_PREFIX.$val.'`'), $start);
+            $start = FALSE;
         }
         break;
 
     case 'optimizetables':
-        $start = true;
+        $start = TRUE;
         @set_time_limit(180);
-        $tables = $db->fetch_tables($dbname);
-        $q = array();
-        foreach($tables as $key=>$val) {
-            if ($start) {
-                dump_query($db->query('OPTIMIZE TABLE `'.$val.'`'));
-                $start = false;
-            } else {
-                dump_query($db->query('OPTIMIZE TABLE `'.$val.'`'), false);
-            }
+        foreach($tables as $val) {
+            dump_query($db->query('OPTIMIZE TABLE `'.X_PREFIX.$val.'`'), $start);
+            $start = FALSE;
         }
         break;
 
     case 'analyzetables':
-        $start = true;
+        $start = TRUE;
         @set_time_limit(180);
-        $tables = $db->fetch_tables($dbname);
-        $q = array();
-        foreach($tables as $key=>$val) {
-            if ($start) {
-                dump_query($db->query('ANALYZE TABLE `'.$val.'`'));
-                $start = false;
-            } else {
-                dump_query($db->query('ANALYZE TABLE `'.$val.'`'), false);
-            }
+        foreach($tables as $val) {
+            dump_query($db->query('ANALYZE TABLE `'.X_PREFIX.$val.'`'), $start);
+            $start = FALSE;
         }
         break;
 
     case 'checktables':
-        $start = true;
+        $start = TRUE;
         @set_time_limit(180);
-        $tables = $db->fetch_tables($dbname);
-        $q = array();
-        foreach($tables as $key=>$val) {
-            if ($start) {
-                dump_query($db->query('CHECK TABLE `'.$val.'`'));
-                $start = false;
-            } else {
-                dump_query($db->query('CHECK TABLE `'.$val.'`'), false);
-            }
+        foreach($tables as $val) {
+            dump_query($db->query('CHECK TABLE `'.X_PREFIX.$val.'`'), $start);
+            $start = FALSE;
         }
         break;
 }
@@ -432,4 +508,4 @@
 echo '</td></tr></table></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: topicadmin.php
===================================================================
--- topicadmin.php	(revision 1746)
+++ topicadmin.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -29,37 +28,23 @@
 define('X_SCRIPT', 'topicadmin.php');
 
 require 'header.php';
-require ROOT.'include/topicadmin.inc.php';
 
-$_tid = isset($_POST['tid']) ? $_POST['tid'] : (isset($_GET['tid']) ? $_GET['tid'] : 0);
+if (X_GUEST) {
+    redirect("{$full_url}misc.php?action=login", 0);
+    exit;
+}
+
+smcwcache();
+
+$tids = array_unique(postedArray('tid', 'int', '', FALSE, FALSE, FALSE, 'r'));
 $fid = getInt('fid', 'p');
 if ($fid == 0) {
     $fid = getInt('fid');
 }
 $pid = getInt('pid');
 $othertid = formInt('othertid');
-$action = postedVar('action');
-if ($action == '') {
-    $action = postedVar('action', '', TRUE, TRUE, FALSE, 'g');
-}
+$action = postedVar('action', '', TRUE, TRUE, FALSE, 'r');
 
-if (is_array($_tid)) {
-    $tids = array_unique(array_map('intval', $_tid));
-    $tid = array();
-    foreach($tids as $value) {
-        $tid[] = $value;
-    }
-} else if (strstr($_tid, ',')) {
-    $tids = array_unique(array_map('intval', explode(',', $_tid)));
-    $tid = array();
-    foreach($tids as $value) {
-        $tid[] = $value;
-    }
-    $tid = implode(',', $tid);
-} else {
-    $tid = (int) $_tid;
-}
-
 loadtemplates(
 'topicadmin_delete',
 'topicadmin_openclose',
@@ -77,8 +62,8 @@
 
 eval('$css = "'.template('css').'";');
 
-if ($tid && !is_array($tid) && false === strstr($tid, ',')) {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
+if (count($tids) == 1) {
+    $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid={$tids[0]}");
     $thread = $db->fetch_array($query);
     $db->free_result($query);
     $threadname = rawHTMLsubject(stripslashes($thread['subject']));
@@ -87,17 +72,16 @@
     $threadname = '';
 }
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid AND status='on'");
-$forums = $db->fetch_array($query);
-$db->free_result($query);
+$forums = getForum($fid);
 
 if (($forums['type'] != 'forum' && $forums['type'] != 'sub') || $forums['status'] != 'on') {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoforum']);
 }
 
 // Check for authorization to be here in the first place
 $perms = checkForumPermissions($forums);
-if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+if (!$perms[X_PERMS_VIEW]) {
     error($lang['privforummsg']);
 } else if (!$perms[X_PERMS_PASSWORD]) {
     handlePasswordDialog($fid);
@@ -105,29 +89,26 @@
 
 $fup = array();
 if ($forums['type'] == 'sub') {
-    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forums['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
-
+    $fup = getForum($forums['fup']);
     // prevent access to subforum when upper forum can't be viewed.
     $fupPerms = checkForumPermissions($fup);
-    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+    if (!$fupPerms[X_PERMS_VIEW]) {
         error($lang['privforummsg']);
     } else if (!$fupPerms[X_PERMS_PASSWORD]) {
         handlePasswordDialog($fup['fid']);
     } else if ($fup['fup'] > 0) {
-        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+        $fupup = getForum($fup['fup']);
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fupup['name']).'</a>');
+        unset($fupup);
     }
     nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 } else if ($forums['fup'] > 0) { // 'forum' in a 'group'
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forums['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
+    $fup = getForum($forums['fup']);
     nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
 }
 nav('<a href="forumdisplay.php?fid='.$fid.'">'.fnameOut($forums['name']).'</a>');
-if (isset($thread['subject'])) {
-    nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
+if (count($tids) == 1) {
+    nav('<a href="viewthread.php?tid='.$tids[0].'">'.$threadname.'</a>');
 }
 
 $kill = FALSE;
@@ -155,6 +136,7 @@
         nav($lang['textmovemethod1']);
         break;
     case 'getip':
+        $kill |= !X_ADMIN;
         nav($lang['textgetip']);
         break;
     case 'bump':
@@ -177,8 +159,7 @@
         break;
 }
 
-$mod = new mod();
-$kill |= !X_STAFF || !$mod->statuscheck($fid);
+$kill |= !X_STAFF || !statuscheck($fid);
 
 if ($kill) {
     error($lang['notpermitted']);
@@ -188,42 +169,64 @@
     $threadSubject = '- '.$threadname;
 }
 
+// Search-link
+$searchlink = makeSearchLink($forums['fid']);
+
 eval('echo "'.template('header').'";');
 
+//Assert permissions on all TIDs
+if (count($tids) > 1) {
+    $csv = implode(',', $tids);
+    $tids = array();
+    $query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE tid IN ($csv) AND fid=$fid");
+    while ($row = $db->fetch_array($query)) {
+        $tids[] = $row['tid'];
+    }
+    $db->free_result($query);
+    unset($csv);
+}
+
 switch($action) {
     case 'delete':
         if (noSubmit('deletesubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             eval('echo "'.template('topicadmin_delete').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
+            require('include/attach.inc.php');
+            
             foreach($tids AS $tid) {
-                $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid'");
+                $query = $db->query("SELECT author, COUNT(pid) AS pidcount FROM ".X_PREFIX."posts WHERE tid=$tid GROUP BY author");
                 while($result = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='".$db->escape($result['author'])."'");
+                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-{$result['pidcount']} WHERE username='".$db->escape_var($result['author'])."'");
                 }
                 $db->free_result($query);
 
-                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$tid'");
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid'");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid='$tid'");
-                $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$tid'");
+                deleteThreadAttachments($tid);  // Must delete attachments before posts!
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid=$tid");
+                $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid=$tid");
+                
+                $db->query("DELETE FROM d, r, v "
+                         . "USING ".X_PREFIX."vote_desc AS d "
+                         . "LEFT JOIN ".X_PREFIX."vote_results AS r ON r.vote_id = d.vote_id "
+                         . "LEFT JOIN ".X_PREFIX."vote_voters AS v  ON v.vote_id = d.vote_id "
+                         . "WHERE d.topic_id = $tid");
 
-                $db->query("DELETE FROM ".X_PREFIX."threads WHERE closed='moved|$tid'");
+                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid=$tid OR closed='moved|$tid'");
 
                 if ($forums['type'] == 'sub') {
                     updateforumcount($fup['fid']);
                 }
                 updateforumcount($fid);
 
-                $mod->log($xmbuser, $action, $fid, $tid);
+                audit($xmbuser, $action, $fid, $tid);
             }
-            message($lang['deletethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['deletethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'close':
-        $query = $db->query("SELECT closed FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+        $tid = $tids[0];
+        $query = $db->query("SELECT closed FROM ".X_PREFIX."threads WHERE tid=$tid");
         if ($db->num_rows($query) == 0) {
             error($lang['textnothread'], FALSE);
         }
@@ -239,107 +242,123 @@
             eval('echo "'.template('topicadmin_openclose').'";');
         } else {
             if ($closed == 'yes') {
-                $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid='$tid' AND fid='$fid'");
+                $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid=$tid");
             } else {
-                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
+                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid=$tid");
             }
 
             $act = ($closed != '') ? 'open' : 'close';
-            $mod->log($xmbuser, $act, $fid, $tid);
+            audit($xmbuser, $act, $fid, $tid);
 
-            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['closethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'f_close':
         if (noSubmit('closesubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             eval('echo "'.template('topicadmin_openclose').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
-            foreach($tids AS $tid) {
-                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
-                $mod->log($xmbuser, 'close', $fid, $tid);
+            if (count($tids) > 0) {
+                $csv = implode(',', $tids);
+                $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid IN ($csv)");
+                foreach($tids AS $tid) {
+                    audit($xmbuser, 'close', $fid, $tid);
+                }
             }
-
-            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['closethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'f_open':
         if (noSubmit('closesubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             $lang['textclosethread'] = $lang['textopenthread'];
             eval('echo "'.template('topicadmin_openclose').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
-            foreach($tids AS $tid) {
-                $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid='$tid' AND fid='$fid'");
-                $mod->log($xmbuser, 'open', $fid, $tid);
+            if (count($tids) > 0) {
+                $csv = implode(',', $tids);
+                $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid IN ($csv)");
+                foreach($tids AS $tid) {
+                    audit($xmbuser, 'open', $fid, $tid);
+                }
             }
-
-            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['closethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'move':
         if (noSubmit('movesubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             $forumselect = forumList('moveto', false, false, $fid);
             eval('echo "'.template('topicadmin_move').'";');
         } else {
             $moveto = formInt('moveto');
-            $query = $db->query("SELECT type, fup FROM ".X_PREFIX."forums WHERE fid=$moveto");
-            if ($db->num_rows($query) == 0) {
+            $type = postedVar('type');
+            
+            $movetorow = getForum($moveto);
+            if ($movetorow === FALSE) {
                 error($lang['textnoforum'], FALSE);
             }
-            $movetorow = $db->fetch_array($query);
-
-            if ($movetorow['type'] == 'group') {
+            if ($movetorow['type'] == 'group' Or $moveto == $fid) {
                 error($lang['errormovingthreads'], FALSE);
             }
 
-            $tids = $mod->create_tid_array($tid);
-            foreach($tids AS $tid) {
-                if ($type == "normal") {
-                    $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid'");
-                    $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid'");
-                } else {
-                    $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
-                    $info = $db->fetch_array($query);
-                    $db->free_result($query);
+            //Perform sanity checks on all redirects
+            if ($type != 'normal' And count($tids) > 0) {
+                $csv = implode(',', $tids);
+                $tids = array();
+                $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid IN ($csv)");
+                while ($info = $db->fetch_array($query)) {
+                    if (substr($info['closed'], 0, 5) != 'moved') {
+                        //Insert all thread redirectors.
+                        $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ({$info['fid']}, '".$db->escape_var($info['subject'])."', '', '".$db->escape_var($info['lastpost'])."', 0, 0, '".$db->escape_var($info['author'])."', 'moved|{$info['tid']}', '{$info['topped']}')");
+                        $ntid = $db->insert_id();
 
-                    $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ({$info['fid']}, '".$db->escape($info['subject'])."', '', '".$db->escape($info['lastpost'])."', 0, 0, '".$db->escape($info['author'])."', 'moved|{$info['tid']}', '{$info['topped']}')");
-                    $ntid = $db->insert_id();
+                        $lastpost = explode('|', $info['lastpost']);
+                        $lastposttime = intval($lastpost[0]);
 
-                    $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ({$info['fid']}, '$ntid', '".$db->escape($info['author'])."', '{$info['tid']}', '".$db->escape($info['subject'])."', 0, '', '', '', '', '')");
-                    $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
-                    $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid='$tid' AND fid='$fid'");
+                        $db->query("INSERT INTO ".X_PREFIX."posts (fid, tid, author, message, subject, dateline, icon, usesig, useip, bbcodeoff, smileyoff) VALUES ({$info['fid']}, '$ntid', '".$db->escape_var($info['author'])."', '{$info['tid']}', '".$db->escape_var($info['subject'])."', $lastposttime, '', '', '', '', '')");
+                        $tids[] = $info['tid'];
+                    }
                 }
-                updatethreadcount($tid);
-                $f = "$fid -> $moveto";
-                $mod->log($xmbuser, $action, $moveto, $tid);
+                $db->free_result($query);
             }
 
-            if ($forums['type'] == 'sub') {
-                updateforumcount($fup['fid']);
-            }
-            if ($movetorow['type'] == 'sub') {
-                if ($movetorow['fup'] != $fup['fid']) {
-                    updateforumcount($movetorow['fup']);
+            if (count($tids) > 0) {
+                //Perform all moves using as few queries as possible.
+                $csv = implode(',', $tids);
+                $db->query("UPDATE ".X_PREFIX."threads SET fid=$moveto WHERE tid IN ($csv)");
+                $db->query("UPDATE ".X_PREFIX."posts SET fid=$moveto WHERE tid IN ($csv)");
+                foreach($tids AS $tid) {
+                    audit($xmbuser, $action, $moveto, $tid);
                 }
+
+                //Update all summary columns.
+                if ($forums['type'] == 'sub') {
+                    updateforumcount($fup['fid']);
+                }
+                if ($movetorow['type'] == 'sub') {
+                    $doupdate = TRUE;
+                    if (isset($fup['fid'])) {
+                        $doupdate = ($movetorow['fup'] != $fup['fid']);
+                    }
+                    if ($doupdate) {
+                        updateforumcount($movetorow['fup']);
+                    }
+                }
+                updateforumcount($fid);
+                updateforumcount($moveto);
             }
-            updateforumcount($fid);
-            updateforumcount($moveto);
 
-            message($lang['movethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['movethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'top':
         if (noSubmit('topsubmit')) {
-            if (!is_array($tid)) {
-                $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+            if (count($tids) == 1) {
+                $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE tid={$tids[0]}");
                 if ($db->num_rows($query) == 0) {
                     $db->free_result($query);
                     error($lang['textnothread'], FALSE);
@@ -352,12 +371,11 @@
             } else {
                 $lang['texttopthread'] = $lang['texttopthread'].' / '.$lang['textuntopthread'];
             }
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             eval('echo "'.template('topicadmin_topuntop').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+                $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE tid=$tid");
                 if ($db->num_rows($query) == 0) {
                     $db->free_result($query);
                     error($lang['textnothread'], FALSE);
@@ -366,16 +384,16 @@
                 $db->free_result($query);
 
                 if ($topped == 1) {
-                    $db->query("UPDATE ".X_PREFIX."threads SET topped='0' WHERE tid='$tid' AND fid='$fid'");
+                    $db->query("UPDATE ".X_PREFIX."threads SET topped='0' WHERE tid=$tid");
                 } else if ($topped == 0)    {
-                    $db->query("UPDATE ".X_PREFIX."threads SET topped='1' WHERE tid='$tid' AND fid='$fid'");
+                    $db->query("UPDATE ".X_PREFIX."threads SET topped='1' WHERE tid=$tid");
                 }
 
                 $act = ($topped ? 'untop' : 'top');
-                $mod->log($xmbuser, $act, $fid, $tid);
+                audit($xmbuser, $act, $fid, $tid);
             }
 
-            message($lang['topthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['topthreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -383,7 +401,7 @@
         if ($pid) {
             $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE pid='$pid'");
         } else {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
+            $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid={$tids[0]}");
         }
         $ipinfo = $db->fetch_array($query);
         $db->free_result($query);
@@ -398,91 +416,95 @@
         <tr bgcolor="<?php echo $altbg2?>">
         <td class="tablerow"><?php echo $lang['textyesip']?> <strong><?php echo $ipinfo['useip']?></strong> - <?php echo gethostbyaddr($ipinfo['useip'])?>
         <?php
-        if (X_ADMIN) {
-            $ip = explode('.', $ipinfo['useip']);
-            $query = $db->query("SELECT * FROM ".X_PREFIX."banned WHERE (ip1='$ip[0]' OR ip1='-1') AND (ip2='$ip[1]' OR ip2='-1') AND (ip3='$ip[2]' OR ip3='-1') AND (ip4='$ip[3]' OR ip4='-1')");
-            $result = $db->fetch_array($query);
-            $db->free_result($query);
-            if ($result) {
-                $buttontext = $lang['textunbanip'];
-                for($i=1; $i<=4; ++$i) {
-                    $j = "ip$i";
-                    if ($result[$j] == -1) {
-                        $result[$j] = "*";
-                        $foundmask = 1;
-                    }
+
+        $ip = explode('.', $ipinfo['useip']);
+        $query = $db->query("SELECT * FROM ".X_PREFIX."banned WHERE (ip1='$ip[0]' OR ip1='-1') AND (ip2='$ip[1]' OR ip2='-1') AND (ip3='$ip[2]' OR ip3='-1') AND (ip4='$ip[3]' OR ip4='-1')");
+        $result = $db->fetch_array($query);
+        $db->free_result($query);
+        if ($result) {
+            $buttontext = $lang['textunbanip'];
+            for($i=1; $i<=4; ++$i) {
+                $j = "ip$i";
+                if ($result[$j] == -1) {
+                    $result[$j] = "*";
+                    $foundmask = 1;
                 }
+            }
 
-                if ($foundmask) {
-                    $ipmask = "<strong>$result[ip1].$result[ip2].$result[ip3].$result[ip4]</strong>";
-                    eval($lang['evalipmask']);
-                    $lang['bannedipmask'] = stripslashes($lang['bannedipmask']);
-                    echo $lang['bannedipmask'];
-                } else {
-                    $lang['textbannedip'] = stripslashes($lang['textbannedip']);
-                    echo $lang['textbannedip'];
-                }
-                echo "<input type=\"hidden\" name=\"delete$result[id]\" value=\"$result[id]\" />";
+            if ($foundmask) {
+                $ipmask = "<strong>$result[ip1].$result[ip2].$result[ip3].$result[ip4]</strong>";
+                eval($lang['evalipmask']);
+                $lang['bannedipmask'] = stripslashes($lang['bannedipmask']);
+                echo $lang['bannedipmask'];
             } else {
-                $buttontext = $lang['textbanip'];
-                for($i=1; $i<=4; ++$i) {
-                    $j = $i - 1;
-                    echo "<input type=\"hidden\" name=\"newip$i\" value=\"$ip[$j]\" />";
-                }
+                $lang['textbannedip'] = stripslashes($lang['textbannedip']);
+                echo $lang['textbannedip'];
             }
-            ?>
-            </td>
-            </tr>
-            <tr bgcolor="<?php echo $altbg1?>"><td class="ctrtablerow"><input type="submit" name="ipbansubmit" value="<?php echo $buttontext?>" />
-            <?php
+            echo "<input type=\"hidden\" name=\"delete$result[id]\" value=\"$result[id]\" />";
+        } else {
+            $buttontext = $lang['textbanip'];
+            for($i=1; $i<=4; ++$i) {
+                $j = $i - 1;
+                echo "<input type=\"hidden\" name=\"newip$i\" value=\"$ip[$j]\" />";
+            }
         }
+        ?>
+        </td>
+        </tr>
+        <tr bgcolor="<?php echo $altbg1?>"><td class="ctrtablerow"><input type="submit" name="ipbansubmit" value="<?php echo $buttontext?>" />
+        <?php
+
         echo '</td></tr></table></td></tr></table></form>';
         break;
 
     case 'bump':
         if (noSubmit('bumpsubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             eval('echo "'.template('topicadmin_bump').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid DESC LIMIT 1");
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline DESC, pid DESC LIMIT 1");
                 if ($db->num_rows($query) == 1) {
                     $pid = $db->result($query, 0);
 
-                    $db->query("UPDATE ".X_PREFIX."threads SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE tid=$tid AND fid=$fid");
-                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE fid=$fid");
+                    $where = "WHERE fid=$fid";
+                    if ($forums['type'] == 'sub') {
+                        $where .= " OR fid={$forums['fup']}";
+                    }
 
-                    $mod->log($xmbuser, $action, $fid, $tid);
+                    $db->query("UPDATE ".X_PREFIX."threads SET lastpost='$onlinetime|$xmbuser|$pid' WHERE tid=$tid");
+                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='$onlinetime|$xmbuser|$pid' $where");
+
+                    audit($xmbuser, $action, $fid, $tid);
                 }
                 $db->free_result($query);
             }
 
-            message($lang['bumpthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['bumpthreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'empty':
         if (noSubmit('emptysubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             eval('echo "'.template('topicadmin_empty').'";');
         } else {
-            $tids = $mod->create_tid_array($tid);
+            require('include/attach.inc.php');
             foreach($tids AS $tid) {
-                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid ASC LIMIT 1");
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline ASC LIMIT 1");
                 if ($db->num_rows($query) == 1) {
                     $pid = $db->result($query, 0);
-                    $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
+                    $query = $db->query("SELECT author, COUNT(pid) AS pidcount FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid GROUP BY author");
                     while($result = $db->fetch_array($query)) {
-                        $dbauthor = $db->escape($result['author']);
-                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
+                        $dbauthor = $db->escape_var($result['author']);
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-{$result['pidcount']} WHERE username='$dbauthor'");
                     }
 
+                    emptyThreadAttachments($tid, $pid);  // Must delete attachments before posts!
                     $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid=$tid");
 
                     updatethreadcount($tid); //Also updates lastpost
-                    $mod->log($xmbuser, $action, $fid, $tid);
+                    audit($xmbuser, $action, $fid, $tid);
                 }
                 $db->free_result($query);
             }
@@ -491,13 +513,14 @@
             }
             updateforumcount($fid);
 
-            message($lang['emptythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['emptythreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'split':
+        $tid = $tids[0];
         if (noSubmit('splitsubmit')) {
-            $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
+            $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid=$tid");
             if ($db->num_rows($query) == 0) {
                 error($lang['textnothread'], FALSE);
             }
@@ -507,13 +530,13 @@
                 error($lang['cantsplit'], false);
             }
 
-            $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline");
+            $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline");
             $posts = '';
             while($post = $db->fetch_array($query))    {
                 $bbcodeoff = $post['bbcodeoff'];
                 $smileyoff = $post['smileyoff'];
                 $post['message'] = stripslashes($post['message']);
-                $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, "", "", X_PREFIX."words", X_PREFIX."forums", X_PREFIX."smilies");
+                $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, 'no', 'no');
                 eval('$posts .= "'.template('topicadmin_split_row').'";');
             }
             $db->free_result($query);
@@ -526,14 +549,14 @@
 
             $threadcreated = false;
             $firstmove = false;
-            $query = $db->query("SELECT pid, author, dateline, subject FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC");
+            $query = $db->query("SELECT pid, author, dateline, subject FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline ASC");
             $movecount = 0;
             while($post = $db->fetch_array($query)) {
                 $move = getInt('move'.$post['pid'], 'p');
                 if ($move == $post['pid']) {
                     if (!$threadcreated) {
                         $thatime = $onlinetime;
-                        $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$subject', '', '$thatime|$xmbuser', 0, 0, '".$db->escape($post['author'])."', '', 0)");
+                        $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ($fid, '$subject', '', '$thatime|$xmbuser', 0, 0, '".$db->escape_var($post['author'])."', '', 0)");
                         $newtid = $db->insert_id();
                         $threadcreated = true;
                     }
@@ -544,30 +567,29 @@
                         $firstmove = true;
                     }
                     $db->query("UPDATE ".X_PREFIX."posts SET tid=$newtid $newsub WHERE pid=$move");
-                    $db->query("UPDATE ".X_PREFIX."attachments SET tid=$newtid WHERE pid=$move");
-                    $lastpost = $post['dateline'].'|'.$db->escape($post['author']).'|'.$post['pid'];
+                    $lastpost = $post['dateline'].'|'.$db->escape_var($post['author']).'|'.$post['pid'];
                     $movecount++;
                 } else {
-                    $oldlastpost = $post['dateline'].'|'.$db->escape($post['author']).'|'.$post['pid'];
+                    $oldlastpost = $post['dateline'].'|'.$db->escape_var($post['author']).'|'.$post['pid'];
                 }
             }
             $db->query("UPDATE ".X_PREFIX."threads SET replies=$movecount-1, lastpost='$lastpost' WHERE tid='$newtid'");
-            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-$movecount, lastpost='$oldlastpost' WHERE tid='$tid'");
+            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-$movecount, lastpost='$oldlastpost' WHERE tid=$tid");
             $db->free_result($query);
 
-            $mod->log($xmbuser, $action, $fid, $tid);
+            audit($xmbuser, $action, $fid, $tid);
 
             if ($forums['type'] == 'sub') {
                 updateforumcount($fup['fid']);
             }
             updateforumcount($fid);
 
-            message($lang['splitthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['splitthreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'merge':
-        $tid = intval($tid);
+        $tid = $tids[0];
         if (noSubmit('mergesubmit')) {
             eval('echo "'.template('topicadmin_merge').'";');
         } else {
@@ -581,54 +603,70 @@
 
             if ($db->num_rows($queryadd1) == 0) {
                 $db->free_result($queryadd1);
-                error($lang['tidnoexist'], false);
+                error($lang['invalidtid'], false);
             }
             $otherthread = $db->fetch_array($queryadd1);
             $db->free_result($queryadd1);
-            $replyadd = $otherthread['replies'];
+            $replyadd = intval($otherthread['replies']) + 1;
             $otherfid = $otherthread['fid'];
 
-            $db->query("UPDATE ".X_PREFIX."posts SET tid='$tid', fid='$fid' WHERE tid='$othertid'");
-            $db->query("UPDATE ".X_PREFIX."attachments SET tid='$tid' WHERE tid='$othertid'");
+            $db->query("UPDATE ".X_PREFIX."posts SET tid=$tid, fid='$fid' WHERE tid='$othertid'");
 
+            $db->query("UPDATE ".X_PREFIX."threads SET closed='moved|$tid' WHERE closed='moved|$othertid'");
+
             $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid='$othertid'");
 
-            $query = $db->query("SELECT * FROM ".X_PREFIX."favorites WHERE tid='$othertid' OR tid='$tid'");
-            if ($db->num_rows($query) == 2) {
-                $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$othertid'");
-            } else {
-                $db->query("UPDATE ".X_PREFIX."favorites SET tid='$tid' WHERE tid='$othertid'");
-            }
-            $db->free_result($query);
+            $db->query("DELETE FROM d, r, v "
+                     . "USING ".X_PREFIX."vote_desc AS d "
+                     . "LEFT JOIN ".X_PREFIX."vote_results AS r ON r.vote_id = d.vote_id "
+                     . "LEFT JOIN ".X_PREFIX."vote_voters AS v  ON v.vote_id = d.vote_id "
+                     . "WHERE d.topic_id = $othertid");
 
-            $query = $db->query("SELECT subject, author, icon FROM ".X_PREFIX."posts WHERE tid='$tid' OR tid='$othertid' ORDER BY pid ASC LIMIT 1");
+            $db->query("UPDATE ".X_PREFIX."favorites AS f "
+                     . "INNER JOIN ".X_PREFIX."members AS m ON m.username = f.username "
+                     . "INNER JOIN ( "
+                     . " SELECT username, COUNT(*) AS fcount "
+                     . " FROM ".X_PREFIX."favorites AS f2 "
+                     . " WHERE tid=$tid "
+                     . " GROUP BY username "
+                     . ") AS query2 ON m.username = query2.username "
+                     . "SET f.tid=$tid "
+                     . "WHERE f.tid='$othertid' AND query2.fcount=0");
+            $db->query("DELETE FROM ".X_PREFIX."favorites WHERE tid='$othertid'");
+
+            $query = $db->query("SELECT subject, author, icon FROM ".X_PREFIX."posts WHERE tid=$tid OR tid='$othertid' ORDER BY pid ASC LIMIT 1");
             $thread = $db->fetch_array($query);
             $db->free_result($query);
-            $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0, 1");
+            $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline DESC LIMIT 0, 1");
             $lastpost = $db->fetch_array($query);
             $db->free_result($query);
-            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies+'$replyadd', subject='".$db->escape($thread['subject'])."', icon='{$thread['icon']}', author='".$db->escape($thread['author'])."', lastpost='{$lastpost['dateline']}|".$db->escape($lastpost['author'])."|{$lastpost['pid']}' WHERE tid='$tid'");
+            $db->query("UPDATE ".X_PREFIX."threads SET replies=replies+'$replyadd', subject='".$db->escape_var($thread['subject'])."', icon='{$thread['icon']}', author='".$db->escape_var($thread['author'])."', lastpost='{$lastpost['dateline']}|".$db->escape_var($lastpost['author'])."|{$lastpost['pid']}' WHERE tid=$tid");
 
-            $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
+            audit($xmbuser, $action, $fid, $tid);
 
             if ($forums['type'] == 'sub') {
                 updateforumcount($fup['fid']);
             }
             if ($otherthread['type'] == 'sub') {
-                if ($otherthread['fup'] != $fup['fid']) {
+                $doupdate = TRUE;
+                if (isset($fup['fid'])) {
+                    $doupdate = ($otherthread['fup'] != $fup['fid']);
+                }
+                if ($doupdate) {
                     updateforumcount($otherthread['fup']);
                 }
             }
             updateforumcount($fid);
             updateforumcount($otherfid);
 
-            message($lang['mergethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['mergethreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'threadprune':
+        $tid = $tids[0];
         if (noSubmit('threadprunesubmit')) {
-            $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
+            $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid=$tid");
             if ($db->num_rows($query) == 0) {
                 error($lang['textnothread'], FALSE);
             }
@@ -642,19 +680,19 @@
             if (X_SADMIN || $SETTINGS['allowrankedit'] == 'off') {
                 $disablePost = '';
                 $posts = '';
-                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline");
+                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline");
                 while($post = $db->fetch_array($query)) {
                     $bbcodeoff = $post['bbcodeoff'];
                     $smileyoff = $post['smileyoff'];
                     $post['message'] = stripslashes($post['message']);
-                    $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, "", "", X_PREFIX."words", X_PREFIX."forums", X_PREFIX."smilies");
+                    $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, 'no', 'no');
                     eval('$posts .= "'.template('topicadmin_threadprune_row').'";');
                 }
                 $db->free_result($query);
             } else {
                 $ranks = array('Super Administrator'=>5, 'Administrator'=>4, 'Super Moderator'=>3, 'Moderator'=>2, 'Member'=>1, ''=>0);
                 $posts = '';
-                $query = $db->query("SELECT p.*, m.status FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON (m.username=p.author) WHERE tid='$tid' ORDER BY dateline");
+                $query = $db->query("SELECT p.*, m.status FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON (m.username=p.author) WHERE tid=$tid ORDER BY dateline");
                 while($post = $db->fetch_array($query)) {
                     if ($ranks[$post['status']] > $ranks[$self['status']]) {
                         $disablePost = 'disabled="disabled"';
@@ -664,30 +702,41 @@
                     $bbcodeoff = $post['bbcodeoff'];
                     $smileyoff = $post['smileyoff'];
                     $post['message'] = stripslashes($post['message']);
-                    $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, "", "", X_PREFIX."words", X_PREFIX."forums", X_PREFIX."smilies");
+                    $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, 'no', 'no');
                     eval('$posts .= "'.template('topicadmin_threadprune_row').'";');
                 }
                 $db->free_result($query);
             }
             eval('echo "'.template('topicadmin_threadprune').'";');
         } else {
+            $postcount = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid=$tid"), 0);
+            $delcount = 0;
+            foreach($_POST as $key=>$val) {
+                if (substr($key, 0, 4) == 'move') {
+                    $delcount++;
+                }
+            }
+            if ($delcount >= $postcount) {
+                error($lang['cantthreadprune'], false);
+            }
+            require('include/attach.inc.php');
             if (X_SADMIN || $SETTINGS['allowrankedit'] == 'off') {
-                $query = $db->query("SELECT author, pid, message FROM ".X_PREFIX."posts WHERE tid='$tid'");
+                $query = $db->query("SELECT author, pid, message FROM ".X_PREFIX."posts WHERE tid=$tid");
                 while($post = $db->fetch_array($query))    {
                     $move = "move".$post['pid'];
                     $move = getInt($move, 'p');
                     if (!empty($move)) {
-                        $dbauthor = $db->escape($post['author']);
+                        $dbauthor = $db->escape_var($post['author']);
                         $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
                         $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid=$move");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid=$move");
-                        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
+                        deleteAllAttachments($move);
+                        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid=$tid");
                     }
                 }
                 $db->free_result($query);
             } else {
                 $ranks = array('Super Administrator'=>5, 'Administrator'=>4, 'Super Moderator'=>3, 'Moderator'=>2, 'Member'=>1, ''=>0);
-                $query = $db->query("SELECT m.status, p.author, p.pid FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON (m.username=p.author) WHERE p.tid='$tid'");
+                $query = $db->query("SELECT m.status, p.author, p.pid FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON (m.username=p.author) WHERE p.tid=$tid");
                 while($post = $db->fetch_array($query))    {
                     if ($ranks[$post['status']] > $ranks[$self['status']]) {
                         continue;
@@ -695,63 +744,60 @@
                     $move = "move".$post['pid'];
                     $move = getInt($move, 'p');
                     if (!empty($move)) {
-                        $dbauthor = $db->escape($post['author']);
+                        $dbauthor = $db->escape_var($post['author']);
                         $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
                         $db->query("DELETE FROM ".X_PREFIX."posts WHERE pid=$move");
-                        $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid=$move");
-                        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
+                        deleteAllAttachments($move);
+                        $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid=$tid");
                     }
                 }
                 $db->free_result($query);
             }
 
-            $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC LIMIT 0,1");
-            $firstauthor = $db->escape($db->result($query, 0));
-            $db->free_result($query);
+            $firstauthor = $db->result($db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline ASC LIMIT 0,1"), 0);
+            $firstauthor = $db->escape_var($firstauthor);
 
-            $query = $db->query("SELECT pid, author, dateline FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0,1");
+            $query = $db->query("SELECT pid, author, dateline FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline DESC LIMIT 0,1");
             $lastpost = $db->fetch_array($query);
             $db->free_result($query);
 
-            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|".$db->escape($lastpost['author'])."|$lastpost[pid]' WHERE tid='$tid'");
+            $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|".$db->escape_var($lastpost['author'])."|$lastpost[pid]' WHERE tid=$tid");
 
             if ($forums['type'] == 'sub') {
                 updateforumcount($fup['fid']);
             }
             updateforumcount($fid);
 
-            $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
+            audit($xmbuser, $action, $fid, $tid);
 
-            message($lang['complete_threadprune'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['complete_threadprune'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'copy':
         if (noSubmit('copysubmit')) {
-            $tid = $mod->create_tid_string($tid);
+            $tid = implode(',', $tids);
             $forumselect = forumList('newfid', false, false);
             eval('echo "'.template('topicadmin_copy').'";');
         } else {
+            require('include/attach.inc.php');
             if (!formInt('newfid')) {
                 error($lang['privforummsg'], false);
             }
 
             $newfid = getRequestInt('newfid');
             
-            $query = $db->query("SELECT type, fup FROM ".X_PREFIX."forums WHERE fid=$newfid");
-            if ($db->num_rows($query) != 1) {
+            $otherforum = getForum($newfid);
+            if ($otherforum === FALSE) {
                 error($lang['textnoforum'], FALSE);
             }
-            $otherforum = $db->fetch_array($query);
-            $db->free_result($query);
 
-            if (!$mod->statuscheck($newfid)) {
+            if (!statuscheck($newfid)) {
                 error($lang['notpermitted'], false);
             }
 
-            $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $thread = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'"));
+                $thread = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid=$tid"));
 
                 $thread['fid'] = $newfid;
                 unset($thread['tid']);
@@ -761,7 +807,7 @@
 
                 foreach($thread as $key=>$val) {
                     $cols[] = $key;
-                    $vals[] = $db->escape($val);
+                    $vals[] = $db->escape_var($val);
                 }
                 $columns = implode(', ', $cols);
                 $values  = "'".implode("', '", $vals)."'";
@@ -770,7 +816,7 @@
 
                 $newtid = $db->insert_id();
 
-                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid ASC");
+                $query = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid ASC");
                 while($post = $db->fetch_array($query)) {
                     $oldPid = $post['pid'];
                     $post['fid'] = $newfid;
@@ -782,7 +828,7 @@
 
                     foreach($post as $key=>$val) {
                         $cols[] = $key;
-                        $vals[] = $db->escape($val);
+                        $vals[] = $db->escape_var($val);
                     }
                     $columns = implode(', ', $cols);
                     $values  = "'".implode("', '", $vals)."'";
@@ -790,10 +836,16 @@
                     $db->query("INSERT INTO ".X_PREFIX."posts ($columns) VALUES ($values)");
                     $newpid = $db->insert_id();
 
-                    $db->query("INSERT INTO ".X_PREFIX."attachments (`tid`,`pid`,`filename`,`filetype`,`filesize`,`attachment`,`downloads`) SELECT '$newtid','$newpid',`filename`,`filetype`,`filesize`,`attachment`,`downloads` FROM ".X_PREFIX."attachments WHERE pid='$oldPid'");
+                    copyAllAttachments($oldPid, $newpid);
                 }
 
-                $mod->log($xmbuser, $action, $fid, $tid);
+                $query = $db->query("SELECT author, COUNT(pid) AS pidcount FROM ".X_PREFIX."posts WHERE tid=$tid GROUP BY author");
+                while($result = $db->fetch_array($query)) {
+                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum+{$result['pidcount']} WHERE username='".$db->escape_var($result['author'])."'");
+                }
+                $db->free_result($query);
+
+                audit($xmbuser, $action, $fid, $tid);
                 
                 if ($otherforum['type'] == 'sub') {
                     updateforumcount($otherforum['fup']);
@@ -801,11 +853,22 @@
                 updateforumcount($newfid);
             }
 
-            message($lang['copythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
+            message($lang['copythreadmsg'], false, '', '', $full_url.'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 }
 
 end_time();
 eval('echo "'.template('footer').'";');
+
+function statuscheck($fid) {
+    global $self;
+
+    $forum = getForum($fid);
+    if ($forum === FALSE) {
+        return FALSE;
+    }
+
+    return (modcheck($self['username'], $forum['moderator']) == 'Moderator');
+}
 ?>
Index: u2u.php
===================================================================
--- u2u.php	(revision 1746)
+++ u2u.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -31,6 +30,8 @@
 require 'header.php';
 require ROOT.'include/u2u.inc.php';
 
+header('X-Robots-Tag: noindex');
+
 loadtemplates(
 'u2u_header',
 'u2u_footer',
@@ -66,7 +67,7 @@
 eval('$u2ufooter = "'.template('u2u_footer').'";');
 
 if (X_GUEST) {
-    error($lang['u2unotloggedin'], false, $u2uheader, $u2ufooter, false, true, false, false);
+    redirect("{$full_url}misc.php?action=login", 0);
     exit;
 }
 
@@ -103,30 +104,30 @@
         switch($mod) {
             case 'send':
                 if ($u2uid > 0) {
-                    redirect("u2u.php?action=send&u2uid=$u2uid", 0);
+                    redirect($full_url."u2u.php?action=send&u2uid=$u2uid", 0);
                 } else {
-                    redirect('u2u.php?action=send', 0);
+                    redirect($full_url.'u2u.php?action=send', 0);
                 }
                 break;
             case 'reply':
                 if ($u2uid > 0) {
-                    redirect("u2u.php?action=send&u2uid=$u2uid&reply=yes", 0);
+                    redirect($full_url."u2u.php?action=send&u2uid=$u2uid&reply=yes", 0);
                 } else {
-                    redirect("u2u.php?action=send&reply=yes", 0);
+                    redirect($full_url."u2u.php?action=send&reply=yes", 0);
                 }
                 break;
             case 'replydel':
                 if ($u2uid > 0) {
-                    redirect("u2u.php?action=send&u2uid=$u2uid&reply=yes&del=yes", 0);
+                    redirect($full_url."u2u.php?action=send&u2uid=$u2uid&reply=yes&del=yes", 0);
                 } else {
-                    redirect("u2u.php?action=send&reply=yes&del=yes", 0);
+                    redirect($full_url."u2u.php?action=send&reply=yes&del=yes", 0);
                 }
                 break;
             case 'forward':
                 if ($u2uid > 0) {
-                    redirect("u2u.php?action=send&u2uid=$u2uid&forward=yes", 0);
+                    redirect($full_url."u2u.php?action=send&u2uid=$u2uid&forward=yes", 0);
                 } else {
-                    redirect("u2u.php?action=send&forward=yes", 0);
+                    redirect($full_url."u2u.php?action=send&forward=yes", 0);
                 }
                 break;
             case 'sendtoemail':
@@ -154,29 +155,29 @@
         switch($modaction) {
             case 'delete':
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?folder=$folder_url", true, false, false);
                 }
                 u2u_mod_delete($folder, $u2u_select);
                 break;
             case 'move':
                 if (!isset($tofolder) || empty($tofolder)) {
-                    error($lang['textnofolder'], false, $u2uheader, $u2ufooter, 'u2u.php', true, false, false);
+                    error($lang['textnofolder'], false, $u2uheader, $u2ufooter, $full_url.'u2u.php', true, false, false);
                 }
 
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?folder=$folder_url", true, false, false);
                     return;
                 }
                 u2u_mod_move($tofolder, $u2u_select);
                 break;
             case 'markunread':
                 if (!isset($u2u_select) || empty($u2u_select)) {
-                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
+                    error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?folder=$folder_url", true, false, false);
                 }
                 u2u_mod_markUnread($folder, $u2u_select);
                 break;
             default:
-                error($lang['testnothingchos'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder_url", true, false, false);
+                error($lang['testnothingchos'], false, $u2uheader, $u2ufooter, $full_url."u2u.php?folder=$folder_url", true, false, false);
                 break;
         }
         break;
@@ -229,4 +230,4 @@
 eval('$u2uquotabar = "'.template('u2u_quotabar').'";');
 $tu2u = ($self['useoldu2u'] == 'yes') ? 'u2u_old' : 'u2u';
 eval('echo "'.template($tu2u).'";');
-?>
\ No newline at end of file
+?>
Index: viewthread.php
===================================================================
--- viewthread.php	(revision 1746)
+++ viewthread.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -35,87 +34,114 @@
 $pid = getInt('pid');
 $tid = getInt('tid');
 $fid = getInt('fid');
-$page = getInt('page');
 $goto = postedVar('goto', '', FALSE, FALSE, FALSE, 'g');
 $action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($goto == 'lastpost') {
     if ($pid > 0) {
-        if ($tid == 0) {
-            $tid = $db->result($db->query("SELECT tid FROM ".X_PREFIX."posts WHERE pid='$pid'"), 0);
-        }
-
-        $query = $db->query("SELECT COUNT(pid) as num FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid <= $pid");
-        $posts = $db->result($query, 0);
-        $db->free_result($query);
-
-        if ($posts == 0) {
-            header('HTTP/1.1 404 Not Found');
+        $query = $db->query("SELECT tid, dateline FROM ".X_PREFIX."posts WHERE pid=$pid");
+        if ($db->num_rows($query) == 1) {
+            $post = $db->fetch_array($query);
+            $tid = $post['tid'];
+            
+            $query = $db->query("SELECT COUNT(pid) as postcount FROM ".X_PREFIX."posts WHERE tid=$tid AND dateline <= {$post['dateline']}");
+            $posts = $db->result($query, 0);
+            $db->free_result($query);
+        } else {
+            header('HTTP/1.0 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
     } else if ($tid > 0) {
-        $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
+        $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid=$tid");
         $posts = $db->result($query, 0);
         $db->free_result($query);
 
         if ($posts == 0) {
-            header('HTTP/1.1 404 Not Found');
+            header('HTTP/1.0 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
 
-        $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid DESC LIMIT 0, 1");
+        $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY dateline DESC, pid DESC LIMIT 0, 1");
         $pid = $db->result($query, 0);
         $db->free_result($query);
     } else if ($fid > 0) {
-        $query = $db->query("SELECT pid, tid FROM ".X_PREFIX."posts WHERE fid='$fid' ORDER BY pid DESC LIMIT 0, 1");
-        $posts = $db->fetch_array($query);
-        $db->free_result($query);
+        $pid = 0;
+        $tid = 0;
+        $query = $db->query("SELECT pid, tid, dateline FROM ".X_PREFIX."posts WHERE fid=$fid ORDER BY dateline DESC, pid DESC LIMIT 0, 1");
+        if ($db->num_rows($query) == 1) {
+            $posts = $db->fetch_array($query);
+            $db->free_result($query);
 
-        $pid = $posts['pid'];
-        $tid = $posts['tid'];
+            $pid = $posts['pid'];
+            $tid = $posts['tid'];
+        }
 
-        $query = $db->query("SELECT p.pid, p.tid FROM ".X_PREFIX."posts p, ".X_PREFIX."forums f WHERE p.fid=f.fid and (f.fup=$fid) ORDER BY p.pid DESC LIMIT 0, 1");
-        $fupPosts = $db->fetch_array($query);
-        $db->free_result($query);
+        $query = $db->query("SELECT p.pid, p.tid, p.dateline FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."forums f USING (fid) WHERE f.fup=$fid ORDER BY p.dateline DESC, p.pid DESC LIMIT 0, 1");
+        if ($db->num_rows($query) == 1) {
+            $fupPosts = $db->fetch_array($query);
+            $db->free_result($query);
 
-        if ($fupPosts['pid'] > $pid) {
-            $pid = $fupPosts['pid'];
-            $tid = $fupPosts['tid'];
+            if ($pid == 0) {
+                $pid = $fupPosts['pid'];
+                $tid = $fupPosts['tid'];
+            } elseif ($fupPosts['dateline'] > $posts['dateline']) {
+                $pid = $fupPosts['pid'];
+                $tid = $fupPosts['tid'];
+            }
         }
 
-        $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
+        if ($pid == 0) {
+            header('HTTP/1.0 404 Not Found');
+            eval('$css = "'.template('css').'";');
+            error($lang['textnothread']);
+        }
+
+        $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid=$tid");
         $posts = $db->result($query, 0);
         $db->free_result($query);
     } else {
-        header('HTTP/1.1 404 Not Found');
+        header('HTTP/1.0 404 Not Found');
         eval('$css = "'.template('css').'";');
         error($lang['textnothread']);
     }
     $page = quickpage($posts, $ppp);
-    redirect("viewthread.php?tid=$tid&page=$page#pid$pid", 0);
+    if ($page == 1) {
+        $page = '';
+    } else {
+        $page = "&page=$page";
+    }
+    redirect("{$full_url}viewthread.php?tid=$tid$page#pid$pid", 0);
 
 } else if ($goto == 'search') {
-    $tidtest = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = $tid AND pid = $pid"), 0);
-    if ($tidtest == 0) {
-        header('HTTP/1.1 404 Not Found');
+    $tidtest = $db->query("SELECT dateline FROM ".X_PREFIX."posts WHERE tid = $tid AND pid = $pid");
+    if ($db->num_rows($tidtest) == 1) {
+        $post = $db->fetch_array($tidtest);
+        $posts = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = $tid AND dateline <= {$post['dateline']}"), 0);
+        $page = quickpage(($posts), $ppp);
+        if ($page == 1) {
+            $page = '';
+        } else {
+            $page = "&page=$page";
+        }
+        redirect("{$full_url}viewthread.php?tid=$tid$page#pid$pid", 0);
+    } else {
+        header('HTTP/1.0 404 Not Found');
         eval('$css = "'.template('css').'";');
         error($lang['textnothread']);
     }
-    $pbefore = $db->result($db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid = $tid AND pid < $pid"), 0);
-    $page = quickpage(($pbefore+1), $ppp);
-    redirect("viewthread.php?tid=$tid&page=$page#pid$pid", 0);
 }
 
 loadtemplates(
-'functions_bbcode',
+'functions_bbcode_quickreply',
+'functions_smilieinsert',
 'functions_smilieinsert_smilie',
 'viewthread_reply',
 'viewthread_quickreply',
 'viewthread_quickreply_captcha',
 'viewthread',
-'viewthread_invalid',
+'viewthread_modlog',
 'viewthread_modoptions',
 'viewthread_newpoll',
 'viewthread_newtopic',
@@ -137,6 +163,7 @@
 'viewthread_post_repquote',
 'viewthread_post_report',
 'viewthread_post_edit',
+'viewthread_post_attachmentthumb',
 'viewthread_post_attachmentimage',
 'viewthread_post_attachment',
 'viewthread_post_sig',
@@ -150,29 +177,36 @@
 
 eval('$css = "'.template('css').'";');
 
-$notexist = false;
-$notexist_txt = $posts = '';
+$posts = '';
 
-$query = $db->query("SELECT fid, subject, replies, closed, topped, lastpost FROM ".X_PREFIX."threads WHERE tid=$tid");
+$query = $db->query("SELECT t.fid, t.subject, t.closed, t.topped, t.lastpost, t.replies, COUNT(pid) AS postcount FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."posts USING (tid) WHERE t.tid=$tid GROUP BY t.tid");
 if ($db->num_rows($query) != 1) {
     $db->free_result($query);
-    header('HTTP/1.1 404 Not Found');
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnothread']);
 }
 
 $thread = $db->fetch_array($query);
 $db->free_result($query);
 
+$thislast = explode('|', $thread['lastpost']);
+
+// Perform automatic maintenance
+if ($thread['replies'] != $thread['postcount'] - 1) {
+    updatethreadcount($tid);
+}
+
 if (strpos($thread['closed'], '|') !== false) {
     $moved = explode('|', $thread['closed']);
     if ($moved[0] == 'moved') {
-        redirect('forumdisplay.php?tid='.$moved[1], 0);
+        header('HTTP/1.0 301 Moved Permanently');
+        header('Location: '.$full_url.'viewthread.php?tid='.$moved[1]);
+        exit();
     }
 }
 
 $thread['subject'] = shortenString(rawHTMLsubject(stripslashes($thread['subject'])), 125, X_SHORTEN_SOFT|X_SHORTEN_HARD, '...');
 
-$thislast = explode('|', $thread['lastpost']);
 $lastPid = isset($thislast[2]) ? $thislast[2] : 0;
 if (!isset($oldtopics)) {
     put_cookie('oldtopics', '|'.$lastPid.'|', $onlinetime+600, $cookiepath, $cookiedomain, null, X_SET_HEADER);
@@ -183,43 +217,48 @@
 }
 
 $fid = $thread['fid'];
+$forum = getForum($fid);
 
-$query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid=$fid");
-$forum = $db->fetch_array($query);
-$db->free_result($query);
-
 if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoforum']);
 }
 
 $perms = checkForumPermissions($forum);
-if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
-    error($lang['privforummsg']);
+if (!$perms[X_PERMS_VIEW]) {
+    if (X_GUEST) {
+        redirect("{$full_url}misc.php?action=login", 0);
+        exit;
+    } else {
+        error($lang['privforummsg']);
+    }
 } else if (!$perms[X_PERMS_PASSWORD]) {
     handlePasswordDialog($fid);
 }
 
 $fup = array();
 if ($forum['type'] == 'sub') {
-    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
-
+    $fup = getForum($forum['fup']);
     // prevent access to subforum when upper forum can't be viewed.
     $fupPerms = checkForumPermissions($fup);
-    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
-        error($lang['privforummsg']);
+    if (!$fupPerms[X_PERMS_VIEW]) {
+        if (X_GUEST) {
+            redirect("{$full_url}misc.php?action=login", 0);
+            exit;
+        } else {
+            error($lang['privforummsg']);
+        }
     } else if (!$fupPerms[X_PERMS_PASSWORD]) {
         handlePasswordDialog($fup['fid']);
     } else if ($fup['fup'] > 0) {
-        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+        $fupup = getForum($fup['fup']);
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fupup['name']).'</a>');
+        unset($fupup);
     }
     nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 } else if ($forum['fup'] > 0) { // 'forum' in a 'group'
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
+    $fup = getForum($forum['fup']);
     nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 }
@@ -230,92 +269,77 @@
     $threadSubject = '- '.$thread['subject'];
 }
 
+// Search-link
+$searchlink = makeSearchLink($forum['fid']);
+
 $allowimgcode = ($forum['allowimgcode'] == 'yes') ? $lang['texton']:$lang['textoff'];
 $allowhtml = ($forum['allowhtml'] == 'yes') ? $lang['texton']:$lang['textoff'];
 $allowsmilies = ($forum['allowsmilies'] == 'yes') ? $lang['texton']:$lang['textoff'];
 $allowbbcode = ($forum['allowbbcode'] == 'yes') ? $lang['texton']:$lang['textoff'];
 
-eval('$bbcodescript = "'.template('functions_bbcode').'";');
-
-if ($smileyinsert == 'on' && $smiliesnum > 0) {
-    $max = ($smiliesnum > 16) ? 16 : $smiliesnum;
-    srand((double)microtime() * 1000000);
-    // Fix for Invalid argument supplied for foreach()
-    // Provided by JDaniels
-    if ($max == 1) {
-        $keys = array_keys($smiliecache, $max);
-    } else {
-        $keys = array_rand($smiliecache, $max);
-    }
-    $smilies = array();
-    $smilies[] = '<table border="0"><tr>';
-    $i = 0;
-    $total = 0;
-    $pre = 'opener.';
-    foreach($keys as $key) {
-        if ($total == 16) {
-            break;
-        }
-        $smilie['code'] = $key;
-        $smilie['url'] = $smiliecache[$key];
-
-        if ($i >= 4) {
-            $smilies[] = '</tr><tr>';
-            $i = 0;
-        }
-        eval('$smilies[] = "'.template('functions_smilieinsert_smilie').'";');
-        $i++;
-        $total++;
-    }
-    $smilies[] = '</tr></table>';
-    $smilies = implode("\n", $smilies);
-}
-
-$usesig = false;
 $replylink = $quickreply = '';
 
 $status1 = modcheck($self['username'], $forum['moderator']);
 
 if ($action == '') {
-    if (X_MEMBER && $self['sig'] != '') {
-        $usesig = true;
+    $mpage = multipage($thread['postcount'], $ppp, 'viewthread.php?tid='.$tid);
+    $multipage =& $mpage['html'];
+    if (strlen($mpage['html']) != 0) {
+        eval('$multipage = "'.template('viewthread_multipage').'";');
     }
 
-    eval('echo "'.template('header').'";');
+    eval('$header = "'.template('header').'";');
 
-    $usesigcheck = $usesig ? 'checked="checked"' : '';
+    if ($perms[X_PERMS_REPLY] And ($thread['closed'] == '' Or X_SADMIN)) {
+        eval('$replylink = "'.template('viewthread_reply').'";');
+        if ($SETTINGS['quickreply_status'] == 'on') {
+            $usesigcheck = '';
+            if (X_MEMBER) {
+                if ($self['sig'] != '') {
+                    $usesigcheck = 'checked="checked"';
+                }
+            }
 
-    $captchapostcheck = '';
-    if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
-        require ROOT.'include/captcha.inc.php';
-        $Captcha = new Captcha(250, 50);
-        if ($Captcha->bCompatible !== false) {
-            $imghash = $Captcha->GenerateCode();
-            eval('$captchapostcheck = "'.template('viewthread_quickreply_captcha').'";');
-        }
-    }
+            $captchapostcheck = '';
+            if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_post_status'] == 'on' && !DEBUG) {
+                require ROOT.'include/captcha.inc.php';
+                $Captcha = new Captcha(250, 50);
+                if ($Captcha->bCompatible !== false) {
+                    $imghash = $Captcha->GenerateCode();
+                    if ($SETTINGS['captcha_code_casesensitive'] == 'off') {
+                        $lang['captchacaseon'] = '';
+                    }
+                    eval('$captchapostcheck = "'.template('viewthread_quickreply_captcha').'";');
+                }
+            }
 
-    if ($thread['closed'] == 'yes') {
-        if (X_SADMIN) {
-            eval('$replylink = "'.template('viewthread_reply').'";');
-            $quickreply = '';
-            if ($SETTINGS['quickreply_status'] == 'on') {
-                eval('$quickreply = "'.template('viewthread_quickreply').'";');
+            if ($SETTINGS['smileyinsert'] == 'on' And $forum['allowsmilies'] == 'yes' And $smiliesnum > 0) {
+                eval('$quickbbcode = "'.template('functions_bbcode_quickreply').'";');
+
+                $smilies = '<div align="center"><hr /><table border="0"><tr>';
+                $smilies .= smilieinsert('quick');
+                $smilies .= '</tr></table>';
+                $smilies .= "<a href=\"misc.php?action=smilies\" onclick=\"Popup(this.href, 'Window', 200, 250); return false;\">{$lang['moresmilies']}</a>";
+                $smilies .= "</div></td>";
+            } else {
+                $quickbbcode = '';
+                $smilies = '';
             }
+
+            eval('$quickreply = "'.template('viewthread_quickreply').'";');
         }
+    }
+    
+    if ($thread['closed'] == '') {
+        $closeopen = $lang['textclosethread'];
+    } else {
         $closeopen = $lang['textopenthread'];
+    }
+
+    if (X_GUEST) {
+        $memcplink = '';
     } else {
-        $closeopen = $lang['textclosethread'];
-        if ($perms[X_PERMS_REPLY]) {
-            eval('$replylink = "'.template('viewthread_reply').'";');
-            $quickreply = '';
-            if ($SETTINGS['quickreply_status'] == 'on') {
-                eval('$quickreply = "'.template('viewthread_quickreply').'";');
-            }
-        } else {
-            $replylink = '';
-            $quickreply = '';
-        }
+        $memcplink = " | <a href=\"memcp.php?action=subscriptions&amp;subadd=$tid\">{$lang['textsubscribe']}</a> | <a href=\"memcp.php?action=favorites&amp;favadd=$tid\">{$lang['textaddfav']}</a>";
     }
 
     if ($perms[X_PERMS_THREAD]) {
@@ -332,17 +356,6 @@
 
     $topuntop = ($thread['topped'] == 1) ? $lang['textuntopthread'] : $lang['texttopthread'];
 
-    $max_page = (int) ($thread['replies'] / $ppp) + 1;
-    if ($page && $page >= 1 && $page <= $max_page) {
-        if ($page < 1) {
-            $page = 1;
-        }
-        $start_limit = ($page-1) * $ppp;
-    } else {
-        $start_limit = 0;
-        $page = 1;
-    }
-
     $specialrank = array();
     $rankposts = array();
     $queryranks = $db->query("SELECT id, title, posts, stars, allowavatars, avatarrank FROM ".X_PREFIX."ranks");
@@ -358,16 +371,7 @@
     $db->free_result($queryranks);
 
     $db->query("UPDATE ".X_PREFIX."threads SET views=views+1 WHERE tid='$tid'");
-    $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'");
-    $num = $db->result($query, 0);
-    $db->free_result($query);
 
-    $mpurl = 'viewthread.php?tid='.$tid;
-    $multipage = '';
-    if (($multipage = multi($num, $ppp, $page, $mpurl)) !== false) {
-        eval('$multipage = "'.template('viewthread_multipage').'";');
-    }
-
     $pollhtml = $poll = '';
     $vote_id = $voted = 0;
 
@@ -389,7 +393,7 @@
         }
 
         $viewresults = (isset($viewresults) && $viewresults == 'yes') ? 'yes' : '';
-        if ($voted === 1 || $thread['closed'] == 'yes' || X_GUEST || $viewresults) {
+        if ($voted >= 1 || $thread['closed'] == 'yes' || X_GUEST || $viewresults) {
             if ($viewresults) {
                 $results = '- [<a href="viewthread.php?tid='.$tid.'"><font color="'.$cattext.'">'.$lang['backtovote'].'</font></a>]';
             } else {
@@ -439,11 +443,63 @@
         }
         eval('$poll = "'.template('viewthread_poll').'";');
     }
+    
+    $startdate = '0';
+    $enddate = '0';
+    $sql = "SELECT dateline "
+         . "FROM ".X_PREFIX."posts "
+         . "WHERE tid=$tid "
+         . "ORDER BY dateline ASC, pid ASC "
+         . "LIMIT {$mpage['start']}, ".($ppp + 1);
+    $query1 = $db->query($sql);
+    $rowcount = $db->num_rows($query1);
+    if ($rowcount > 0) {
+        $row = $db->fetch_array($query1);
+        $startdate = $row['dateline'];
+        if ($rowcount <= $ppp) {
+            $enddate = $onlinetime;
+        } else {
+            $db->data_seek($query1, $rowcount - 1);
+            $enddate = $row['dateline'];
+        }
+    }
+    $db->free_result($query1);
 
     $thisbg = $altbg2;
-    $querypost = $db->query("SELECT a.aid, a.filename, a.filetype, a.filesize, a.downloads, p.*, m.*,w.time FROM ".X_PREFIX."posts p LEFT JOIN ".X_PREFIX."members m ON m.username=p.author LEFT JOIN ".X_PREFIX."attachments a ON a.pid=p.pid LEFT JOIN ".X_PREFIX."whosonline w ON w.username=p.author WHERE p.fid='$fid' AND p.tid='$tid' GROUP BY p.pid ORDER BY p.pid ASC LIMIT $start_limit, $ppp");
+    $sql = "SELECT p.*, m.*, w.time "
+         . "FROM "
+         . "( "
+         . "  ( "
+         . "    SELECT 'post' AS type, fid, tid, author, subject, dateline, pid, message, icon, usesig, useip, bbcodeoff, smileyoff "
+         . "    FROM ".X_PREFIX."posts "
+         . "    WHERE tid=$tid "
+         . "    ORDER BY dateline ASC, pid ASC "
+         . "    LIMIT {$mpage['start']}, $ppp "
+         . "  ) "
+         . "  UNION ALL "
+         . "  ( "
+         . "    SELECT 'modlog' AS type, fid, tid, username AS author, action AS subject, date AS dateline, '', '', '', '', '', '', '' "
+         . "    FROM ".X_PREFIX."logs "
+         . "    WHERE tid=$tid AND date >= $startdate AND date < $enddate "
+         . "  ) "
+         . ") AS p "
+         . "LEFT JOIN ".X_PREFIX."members m ON m.username=p.author "
+         . "LEFT JOIN ".X_PREFIX."whosonline w ON w.username=p.author "
+         . "ORDER BY p.dateline ASC, p.type DESC, p.pid ASC ";
+    $querypost = $db->query($sql);
+
+    if ($forum['attachstatus'] == 'on') {
+        require('include/attach.inc.php');
+        $queryattach = $db->query("SELECT a.aid, a.pid, a.filename, a.filetype, a.filesize, a.downloads, a.img_size, thumbs.aid AS thumbid, thumbs.filename AS thumbname, thumbs.img_size AS thumbsize FROM ".X_PREFIX."attachments AS a LEFT JOIN ".X_PREFIX."attachments AS thumbs ON a.aid=thumbs.parentid INNER JOIN ".X_PREFIX."posts AS p ON a.pid=p.pid WHERE p.tid=$tid AND a.parentid=0");
+    }
+
     $tmoffset = ($timeoffset * 3600) + ($addtime * 3600);
     while($post = $db->fetch_array($querypost)) {
+        // Perform automatic maintenance
+        if ($post['type'] == 'post' And $post['fid'] != $thread['fid']) {
+            $db->query('UPDATE '.X_PREFIX.'posts SET fid='.$thread['fid'].' WHERE pid='.$post['pid']);
+        }
+
         $post['avatar'] = str_replace("script:", "sc ript:", $post['avatar']);
 
         $onlinenow = $lang['memberisoff'];
@@ -482,6 +538,7 @@
             }
 
             $encodename = recodeOut($post['author']);
+            $profilelink = "<a href=\"./member.php?action=viewpro&amp;member=$encodename\">{$post['author']}</a>";
 
             $icq = '';
             if ($post['icq'] != '' && $post['icq'] > 0) {
@@ -506,9 +563,18 @@
                 eval('$yahoo = "'.template('viewthread_post_yahoo').'";');
             }
 
-            eval('$search = "'.template('viewthread_post_search').'";');
+            if (X_GUEST && $SETTINGS['captcha_status'] == 'on' && $SETTINGS['captcha_search_status'] == 'on' && !DEBUG) {
+                $search = '';
+            } else {
+                eval('$search = "'.template('viewthread_post_search').'";');
+            }
+            
             eval('$profile = "'.template('viewthread_post_profile').'";');
-            eval('$u2u = "'.template('viewthread_post_u2u').'";');
+            if (X_GUEST) {
+                $u2u = '';
+            } else {
+                eval('$u2u = "'.template('viewthread_post_u2u').'";');
+            }
 
             $showtitle = $post['status'];
             $rank = array();
@@ -516,7 +582,7 @@
                 $sr = $post['status'];
                 $rankinfo = explode(",", $specialrank[$sr]);
                 $rank['allowavatars'] = $rankinfo[4];
-                $rank['title'] = $rankinfo[1];
+                $rank['title'] = $lang[$status_translate[$status_enum[$sr]]];
                 $rank['stars'] = $rankinfo[3];
                 $rank['avatarrank'] = $rankinfo[5];
             } else if ($post['status'] == 'Banned') {
@@ -591,6 +657,7 @@
             $location = '';
             $mood = '';
             $encodename = '';
+            $profilelink = $post['author'];
         }
 
         $ip = '';
@@ -608,10 +675,6 @@
             eval('$reportlink = "'.template('viewthread_post_report').'";');
         }
 
-        if ($post['subject'] != '') {
-            $post['subject'] = rawHTMLsubject(stripslashes($post['subject'])).'<br />';
-        }
-
         $edit = '';
         if (modcheckPost($self['username'], $forum['moderator'], $post['status']) == 'Moderator' || ($thread['closed'] != 'yes' && $post['author'] == $xmbuser)) {
             eval('$edit = "'.template('viewthread_post_edit').'";');
@@ -621,30 +684,17 @@
         $smileyoff = $post['smileyoff'];
         $post['message'] = postify(stripslashes($post['message']), $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
 
-        if ($post['filename'] != '' && $forum['attachstatus'] != 'off') {
-            $post['filename'] = attrOut($post['filename']);
-            $post['filetype'] = attrOut($post['filetype']);
-            $attachsize = $post['filesize'];
-            if ($attachsize >= 1073741824) {
-                $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
-            } else if ($attachsize >= 1048576) {
-                $attachsize = round($attachsize / 1048576 * 100) / 100 . "mb";
-            } else if ($attachsize >= 1024) {
-                $attachsize = round($attachsize / 1024 * 100) / 100 . "kb";
-            } else {
-                $attachsize = $attachsize . "b";
-            }
-
-            $extention = strtolower(substr(strrchr($post['filename'],"."),1));
-            if ($attachimgpost == 'on' && ($extention == 'jpg' || $extention == 'jpeg' || $extention == 'jpe' || $extention == 'gif' || $extention == 'png' || $extention == 'bmp')) {
-                eval("\$post['message'] .= \"".template('viewthread_post_attachmentimage')."\";");
-            } else {
-                $downloadcount = $post['downloads'];
-                if ($downloadcount == '') {
-                    $downloadcount = 0;
+        if ($forum['attachstatus'] == 'on' And $db->num_rows($queryattach) > 0) {
+            $files = array();
+            $db->data_seek($queryattach, 0);
+            while($attach = $db->fetch_array($queryattach)) {
+                if ($attach['pid'] == $post['pid']) {
+                    $files[] = $attach;
                 }
-                eval("\$post['message'] .= \"".template('viewthread_post_attachment')."\";");
             }
+            if (count($files) > 0) {
+                bbcodeFileTags($post['message'], $files, $post['pid'], ($forum['allowbbcode'] == 'yes' And $bbcodeoff == 'no'));
+            }
         }
 
         if ($post['usesig'] == 'yes') {
@@ -658,10 +708,23 @@
             $rank['avatar'] = '';
         }
 
-        if (!$notexist) {
+        if ($post['type'] == 'post') {
+
+            if ($post['subject'] != '') {
+                $linktitle = rawHTMLsubject(stripslashes($post['subject']));
+                $post['subject'] = $linktitle.'<br />';
+            } else {
+                $linktitle = $thread['subject'];
+            }
+
             eval('$posts .= "'.template('viewthread_post').'";');
+
         } else {
-            eval('$posts .= "'.template('viewthread_invalid').'";');
+
+            $poston = $date.' '.$lang['textat'].' '.$time;
+            $post['message'] = $lang["modlog_{$post['subject']}"].'<br />'.$poston;
+            eval('$posts .= "'.template('viewthread_modlog').'";');
+
         }
 
         if ($thisbg == $altbg2) {
@@ -676,36 +739,37 @@
     if ('Moderator' == $status1) {
         eval('$modoptions = "'.template('viewthread_modoptions').'";');
     }
-    eval('echo "'.template('viewthread').'";');
+    eval('$viewthread = "'.template('viewthread').'";');
     end_time();
-    eval('echo "'.template('footer').'";');
+    eval('$footer = "'.template('footer').'";');
+    echo $header.$viewthread.$footer;
     exit();
-} else if ($action == 'attachment' && $forum['attachstatus'] != 'off' && $pid > 0 && $tid > 0) {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."attachments WHERE pid='$pid' and tid='$tid'");
-    $file = $db->fetch_array($query);
-    $db->free_result($query);
+} else if ($action == 'attachment' && $forum['attachstatus'] == 'on' && $pid > 0 && $tid > 0) {
+    // Try to validate $pid
+    $query = $db->query("SELECT aid, filename FROM ".X_PREFIX."attachments AS a INNER JOIN ".X_PREFIX."posts AS p USING (pid) WHERE a.pid=$pid AND a.parentid=0 AND p.tid='$tid' ORDER BY aid LIMIT 1");
+    if ($db->num_rows($query) == 1) {
+        $file = $db->fetch_array($query);
+        $db->free_result($query);
+        require('include/attach.inc.php');
+        $url = getAttachmentURL($file['aid'], $pid, $file['filename'], FALSE);
+        header('HTTP/1.0 301 Moved Permanently');
+        header('Location: '.$url);
+        exit();
+    } else {
+        header('HTTP/1.0 404 Not Found');
+        eval('$css = "'.template('css').'";');
+        error($lang['textnothread']);
+    }
+} else if ($action == 'printable') {
+    $threadlink = "viewthread.php?tid=$tid";
 
-    $db->query("UPDATE ".X_PREFIX."attachments SET downloads=downloads+1 WHERE pid='$pid'");
-
-    if ($file['filesize'] != strlen($file['attachment'])) {
-        error($lang['filecorrupt']);
+    $querypost = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC, pid ASC");
+    if ($forum['attachstatus'] == 'on') {
+        require('include/attach.inc.php');
+        $queryattach = $db->query("SELECT a.aid, a.pid, a.filename, a.filetype, a.filesize, a.downloads, a.img_size, thumbs.aid AS thumbid, thumbs.filename AS thumbname, thumbs.img_size AS thumbsize FROM ".X_PREFIX."attachments AS a LEFT JOIN ".X_PREFIX."attachments AS thumbs ON a.aid=thumbs.parentid INNER JOIN ".X_PREFIX."posts AS p ON a.pid=p.pid WHERE p.tid=$tid AND a.parentid=0");
     }
 
-    $type = strtolower($file['filetype']);
-    $size = (int) $file['filesize'];
-    $type = ($type == 'text/html') ? 'text/plain' : $type;
-
-    header("Content-type: $type");
-    header("Content-length: $size");
-    header("Content-Disposition: attachment; filename=\"{$file['filename']}\"");
-    header("Content-Description: XMB Attachment");
-    header("Cache-Control: public; max-age=604800");
-    header("Expires: 604800");
-
-    echo $file['attachment'];
-    exit();
-} else if ($action == 'printable') {
-    $querypost = $db->query("SELECT * FROM ".X_PREFIX."posts WHERE fid='$fid' AND tid='$tid' ORDER BY pid");
+    $counter = 0;
     $posts = '';
     $tmoffset = ($timeoffset * 3600) + ($addtime * 3600);
     while($post = $db->fetch_array($querypost)) {
@@ -714,10 +778,28 @@
         $poston = "$date $lang[textat] $time";
         $bbcodeoff = $post['bbcodeoff'];
         $smileyoff = $post['smileyoff'];
+        if ($counter == 0) {
+            $subject = '';
+        } else {
+            $subject = rawHTMLsubject(stripslashes($post['subject']));
+        }
         $post['message'] = postify(stripslashes($post['message']), $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
+        if ($forum['attachstatus'] == 'on' And $db->num_rows($queryattach) > 0) {
+            $files = array();
+            $db->data_seek($queryattach, 0);
+            while($attach = $db->fetch_array($queryattach)) {
+                if ($attach['pid'] == $post['pid']) {
+                    $files[] = $attach;
+                }
+            }
+            if (count($files) > 0) {
+                bbcodeFileTags($post['message'], $files, $post['pid'], ($forum['allowbbcode'] == 'yes' And $bbcodeoff == 'no'));
+            }
+        }
         eval('$posts .= "'.template('viewthread_printable_row').'";');
+        $counter++;
     }
     $db->free_result($querypost);
-    eval('echo stripslashes("'.template('viewthread_printable').'");');
+    eval('echo "'.template('viewthread_printable').'";');
 }
-?>
\ No newline at end of file
+?>
Index: vtmisc.php
===================================================================
--- vtmisc.php	(revision 1746)
+++ vtmisc.php	(working copy)
@@ -1,14 +1,13 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.10 Karl
+ * XMB 1.9.11
  *
  * Developed And Maintained By The XMB Group
- * Copyright (c) 2001-2008, The XMB Group
+ * Copyright (c) 2001-2009, The XMB Group
  * http://www.xmbforum.com
  *
  * Sponsored By iEntry, Inc.
- * Copyright (c) 2007, iEntry, Inc.
  * http://www.ientry.com
  *
  * This program is free software; you can redistribute it and/or
@@ -30,17 +29,18 @@
 
 require 'header.php';
 
-eval('$css = "'.template('css').'";');
-
-if (!X_MEMBER) {
-    error($lang['notpermitted']);
-}
-
 loadtemplates(
 'vtmisc_report',
 'misc_feature_notavailable'
 );
 
+eval('$css = "'.template('css').'";');
+
+if (X_GUEST) {
+    redirect("{$full_url}misc.php?action=login", 0);
+    exit;
+}
+
 //Validate $action, $pid, $tid, and $fid
 $fid = -1;
 $tid = -1;
@@ -50,6 +50,7 @@
     $pid = getRequestInt('pid');
     $query = $db->query("SELECT f.*, t.tid, t.subject FROM ".X_PREFIX."posts AS p LEFT JOIN ".X_PREFIX."threads AS t USING (tid) LEFT JOIN ".X_PREFIX."forums AS f ON f.fid=t.fid WHERE p.pid=$pid");
     if ($db->num_rows($query) != 1) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnothread']);
     }
     $forum = $db->fetch_array($query);
@@ -60,22 +61,27 @@
     $tid = getRequestInt('tid');
     $query = $db->query("SELECT f.*, t.subject FROM ".X_PREFIX."threads AS t LEFT JOIN ".X_PREFIX."forums AS f USING (fid) WHERE t.tid=$tid");
     if ($db->num_rows($query) != 1) {
+        header('HTTP/1.0 404 Not Found');
         error($lang['textnothread']);
     }
     $forum = $db->fetch_array($query);
     $db->free_result($query);
     $fid = $forum['fid'];
 } else {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoaction']);
 }
 
 if (($forum['type'] != 'forum' && $forum['type'] != 'sub') || $forum['status'] != 'on') {
+    header('HTTP/1.0 404 Not Found');
     error($lang['textnoforum']);
 }
 
+smcwcache();
+
 // check permissions on this forum
 $perms = checkForumPermissions($forum);
-if (!$perms[X_PERMS_VIEW] || !$perms[X_PERMS_USERLIST]) {
+if (!($perms[X_PERMS_VIEW] || $perms[X_PERMS_USERLIST])) {
     error($lang['privforummsg']);
 } else if (!$perms[X_PERMS_PASSWORD]) {
     handlePasswordDialog($fid);
@@ -83,25 +89,22 @@
 
 $fup = array();
 if ($forum['type'] == 'sub') {
-    $query = $db->query("SELECT f.*, g.name AS groupname FROM ".X_PREFIX."forums AS f LEFT JOIN ".X_PREFIX."forums AS g ON f.fup=g.fid WHERE f.fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
-
+    $fup = getForum($forum['fup']);
     // prevent access to subforum when upper forum can't be viewed.
     $fupPerms = checkForumPermissions($fup);
-    if (!$fupPerms[X_PERMS_VIEW] || !$fupPerms[X_PERMS_USERLIST]) {
+    if (!$fupPerms[X_PERMS_VIEW]) {
         error($lang['privforummsg']);
     } else if (!$fupPerms[X_PERMS_PASSWORD]) {
         handlePasswordDialog($fup['fid']);
     } else if ($fup['fup'] > 0) {
-        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fup['groupname']).'</a>');
+        $fupup = getForum($fup['fup']);
+        nav('<a href="index.php?gid='.$fup['fup'].'">'.fnameOut($fupup['name']).'</a>');
+        unset($fupup);
     }
     nav('<a href="forumdisplay.php?fid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 } else if ($forum['fup'] > 0) { // 'forum' in a 'group'
-    $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid={$forum['fup']}");
-    $fup = $db->fetch_array($query);
-    $db->free_result($query);
+    $fup = getForum($forum['fup']);
     nav('<a href="index.php?gid='.$fup['fid'].'">'.fnameOut($fup['name']).'</a>');
     unset($fup);
 }
@@ -116,11 +119,15 @@
     $threadSubject = '- '.rawHTMLsubject(stripslashes($forum['subject']));
 }
 
+// Search-link
+$searchlink = makeSearchLink($forum['fid']);
+
 if ($action == 'report') {
     nav($lang['textreportpost']);
     eval('echo "'.template('header').'";');
 
     if ($SETTINGS['reportpost'] == 'off') {
+        header('HTTP/1.0 403 Forbidden');
         eval('echo "'.template('misc_feature_notavailable').'";');
         end_time();
         eval('echo "'.template('footer').'";');
@@ -130,26 +137,22 @@
     if (noSubmit('reportsubmit')) {
         eval('echo "'.template('vtmisc_report').'";');
     } else {
-        $query = $db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid=$tid");
-        $postcount = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
-        $db->free_result($query);
-
+        require('include/u2u.inc.php');
         $modquery = $db->query("SELECT username, ppp FROM ".X_PREFIX."members WHERE status='Super Administrator' OR status='Administrator' OR status='Super Moderator'");
         while($modusr = $db->fetch_array($modquery)) {
-            $mod = $db->escape($modusr['username']);
-            $page = quickpage($postcount, $modusr['ppp']);
+            $mod = $db->escape_var($modusr['username']);
 
-            $posturl = $SETTINGS['boardurl']."viewthread.php?tid=$tid&page=$page#pid$pid";
+            $posturl = $full_url."viewthread.php?tid=$tid&amp;goto=search&amp;pid=$pid";
             $reason = postedVar('reason', '', TRUE, FALSE);
             $message = $lang['reportmessage'].' '.$posturl."\n\n".$lang['reason'].' '.$reason;
             $message = $db->escape(addslashes($message)); //Messages are historically double-slashed.
             $subject = $db->escape(addslashes($lang['reportsubject']));
-            $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$mod', '$xmbuser', 'incoming', '$mod', 'Inbox', '$subject', '$message', ".$db->time($onlinetime).", 'no', 'yes')");
+
+            u2u_send_recp($mod, $subject, $message);
         }
         $db->free_result($modquery);
 
-        $page = quickpage($postcount, $tpp);
-        message($lang['reportmsg'], false, '', '', 'viewthread.php?tid='.$tid.'&page='.$page.'#pid'.$pid, true, false, true);
+        message($lang['reportmsg'], false, '', '', $full_url.'viewthread.php?tid='.$tid.'&goto=search&pid='.$pid, true, false, true);
     }
 
 } else if ($action == 'votepoll') {
@@ -175,7 +178,7 @@
 
     // does the poll option exist?
     $query = $db->query("SELECT COUNT(vote_option_id) FROM ".X_PREFIX."vote_results WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
-    $vote_result = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+    $vote_result = intval($db->result($query, 0)); //Aggregate functions with no grouping always return 1 row.
     $db->free_result($query);
     if ($vote_result != 1) {
         error($lang['pollvotenotselected'], false);
@@ -183,9 +186,9 @@
 
     // Has the user voted on this poll before?
     $query = $db->query("SELECT COUNT(vote_id) FROM ".X_PREFIX."vote_voters WHERE vote_id=$vote_id AND vote_user_id={$self['uid']}");
-    $voted = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+    $voted = intval($db->result($query, 0));
     $db->free_result($query);
-    if ($voted === 1) {
+    if ($voted >= 1) {
         error($lang['alreadyvoted'], false);
     }
 
@@ -194,12 +197,12 @@
     $db->query("UPDATE ".X_PREFIX."vote_results SET vote_result=vote_result+1 WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
 
     if ($tid > 0) {
-        message($lang['votemsg'], false, '', '', 'viewthread.php?tid='.$tid, true, false, true);
+        message($lang['votemsg'], false, '', '', $full_url.'viewthread.php?tid='.$tid, true, false, true);
     } else {
-        message($lang['votemsg'], false, '', '', 'index.php', true, false, true);
+        message($lang['votemsg'], false, '', '', $full_url, true, false, true);
     }
 }
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
