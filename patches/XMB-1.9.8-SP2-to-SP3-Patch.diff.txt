Index: buddy.php
===================================================================
--- buddy.php	(revision 761)
+++ buddy.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'buddy.php');
+
 require 'header.php';
 require ROOT.'include/buddy.inc.php';
 
@@ -45,12 +47,12 @@
     error($lang['u2unotloggedin']);
 }
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'add':
-        $buddys = getVar('buddys');
+        $buddys = postedVar('buddys', '', TRUE, TRUE, FALSE, 'g');
         if (empty($buddys)) {
-            $buddys = formArray('buddys');
+            $buddys = postedArray('buddys');
         }
         buddy_add($buddys);
         break;
@@ -58,7 +60,7 @@
         buddy_edit();
         break;
     case 'delete':
-        $delete = formArray('delete');
+        $delete = postedArray('delete');
         if ($delete) {
             buddy_delete($delete);
         } else {
@@ -69,4 +71,4 @@
         buddy_display();
         break;
 }
-?>
\ No newline at end of file
+?>
Index: config.php
===================================================================
--- config.php	(revision 761)
+++ config.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
Index: cp.php
===================================================================
--- cp.php	(revision 761)
+++ cp.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'cp.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
@@ -54,7 +56,7 @@
 
 displayAdminPanel();
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($action == "settings") {
     if (noSubmit('settingsubmit')) {
@@ -72,6 +74,7 @@
         }
         $themelist[] = '</select>';
         $themelist = implode("\n", $themelist);
+        $db->free_result($query);
 
         $onselect = $offselect = '';
         settingHTML('bbstatus', $onselect, $offselect);
@@ -406,7 +409,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan="2"><strong><font color="<?php echo $cattext?>">&raquo;&nbsp;<?php echo $lang['admin_main_settings1']?></font></strong></td>
         </tr>
@@ -572,15 +575,15 @@
         </tr>
         <?php
     } else {
-        $sitenamenew = formVar('sitenamenew');
-        $bbnamenew = formVar('bbnamenew');
-        $siteurlnew = formVar('siteurlnew');
-        $boardurlnew = formVar('boardurlnew');
-        $adminemailnew = formVar('adminemailnew');
+        $sitenamenew = postedVar('sitenamenew');
+        $bbnamenew = postedVar('bbnamenew');
+        $siteurlnew = postedVar('siteurlnew');
+        $boardurlnew = postedVar('boardurlnew');
+        $adminemailnew = postedVar('adminemailnew');
         $bbrulesnew = formOnOff('bbrulesnew');
-        $bbrulestxtnew = addslashes(formVar('bbrulestxtnew'));
+        $bbrulestxtnew = postedVar('bbrulestxtnew');
         $bbstatusnew = formOnOff('bbstatusnew');
-        $bboffreasonnew = addslashes(formVar('bboffreasonnew'));
+        $bboffreasonnew = postedVar('bboffreasonnew');
         $gzipcompressnew = formOnOff('gzipcompressnew');
 
         $langfilenew = getLangFileNameFromHash($langfilenew);
@@ -595,7 +598,7 @@
         $topicperpagenew = formInt('topicperpagenew');
         $memberperpagenew = formInt('memberperpagenew');
         $timeformatnew = formInt('timeformatnew');
-        $dateformatnew = formVar('dateformatnew');
+        $dateformatnew = postedVar('dateformatnew');
         $searchstatusnew = formOnOff('searchstatusnew');
         $faqstatusnew = formOnOff('faqstatusnew');
         $todaystatusnew = formOnOff('todaystatusnew');
@@ -640,7 +643,7 @@
         }
 
         $maxAttachSize = formInt('maxAttachSize');
-        $def_tz_new = formInt('def_tz_new');
+        $def_tz_new = isset($_POST['def_tz_new']) && is_numeric($_POST['def_tz_new']) ? $_POST['def_tz_new'] : 0;
         $addtimenew = isset($_POST['addtimenew']) && is_numeric($_POST['addtimenew']) ? $_POST['addtimenew'] : 0;
         $sigbbcodenew = formOnOff('sigbbcodenew');
         $sightmlnew = formOnOff('sightmlnew');
@@ -651,17 +654,17 @@
         $captchanew = formOnOff('captchanew');
         $captcharegnew = formOnOff('captcharegnew');
         $captchapostnew = formOnOff('captchapostnew');
-        $captchacharsetnew = formVar('captchacharsetnew');
+        $captchacharsetnew = postedVar('captchacharsetnew');
         $captchacodenew = formInt('captchacodenew');
         $captchacodecasenew = formOnOff('captchacodecasenew');
         $captchacodeshadownew = formOnOff('captchacodeshadownew');
-        $captchaimagetypenew = formVar('captchaimagetypenew');
+        $captchaimagetypenew = postedVar('captchaimagetypenew');
         $captchaimagewidthnew = formInt('captchaimagewidthnew');
         $captchaimageheightnew = formInt('captchaimageheightnew');
-        $captchaimagebgnew = formVar('captchaimagebgnew');
+        $captchaimagebgnew = postedVar('captchaimagebgnew');
         $captchaimagedotsnew = formInt('captchaimagedotsnew');
         $captchaimagelinesnew = formInt('captchaimagelinesnew');
-        $captchaimagefontsnew = formVar('captchaimagefontsnew');
+        $captchaimagefontsnew = postedVar('captchaimagefontsnew');
         $captchaimageminfontnew = formInt('captchaimageminfontnew');
         $captchaimagemaxfontnew = formInt('captchaimagemaxfontnew');
         $captchaimagecolornew = formOnOff('captchaimagecolornew');
@@ -786,7 +789,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><strong><font color="<?php echo $cattext?>"><?php echo $lang['admin_rename_txt']?></font></strong></td>
         </tr>
@@ -854,7 +857,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textforumopts']?></strong></font></td>
         </tr>
@@ -1056,7 +1059,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textforumopts']?></strong></font></td>
         </tr>
@@ -1077,6 +1080,7 @@
         }
         $themelist[] = '</select>';
         $themelist = implode("\n", $themelist);
+        $db->free_result($query);
 
         if ($forum['allowhtml'] == "yes") {
             $checked2 = $cheHTML;
@@ -1241,8 +1245,8 @@
         while($forum = $db->fetch_array($queryforum)) {
             $displayorder = formInt('displayorder'.$forum['fid']);
             $self['status'] = formOnOff('status'.$forum['fid']);
-            $name = formVar('name'.$forum['fid']);
-            $delete = formVar('delete'.$forum['fid']);
+            $name = postedVar('name'.$forum['fid']);
+            $delete = formInt('delete'.$forum['fid']);
             $moveto = formInt('moveto'.$forum['fid']);
 
             if ($delete) {
@@ -1261,7 +1265,6 @@
                 }
                 $db->free_result($querythread);
             }
-            $name = addslashes($name);
             $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='$self[status]', fup=".$moveto." WHERE fid='".$forum['fid']."'");
         }
 
@@ -1279,7 +1282,6 @@
                 }
                 $db->query("DELETE FROM ".X_PREFIX."forums WHERE type='group' AND fid='$delete'");
             }
-            $name = addslashes($name);
             $db->query("UPDATE ".X_PREFIX."forums SET name='$name', displayorder=".$displayorder.", status='".$self['status']."' WHERE fid='".$group['fid']."'");
         }
 
@@ -1325,7 +1327,7 @@
         $postperm2 = formInt('postperm2');
         $privatenew = formInt('privatenew');
         $userlistnew = addslashes(formVar('userlistnew'));
-        $passwordnew = formVar('passwordnew');
+        $passwordnew = postedVar('passwordnew', '', FALSE);
         $delete = formInt('delete');
 
         $db->query("UPDATE ".X_PREFIX."forums SET
@@ -1362,7 +1364,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textforum']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textmoderator']?></font></strong></td>
@@ -1422,7 +1424,7 @@
 }
 
 if ($action == "members") {
-    $members = getVar('members');
+    $members = postedVar('members', '', FALSE, FALSE, FALSE, 'g');
     if (noSubmit('membersubmit')) {
         if (!$members) {
             ?>
@@ -1432,7 +1434,7 @@
             <table cellspacing="0" cellpadding="0" border="0" width="90%" align="center">
             <tr>
             <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
             <tr>
             <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textmembers']?></strong></font></td>
             </tr>
@@ -1468,13 +1470,14 @@
             <?php
         } else if ($members == "search") {
             ?>
+            <script language="javascript" type="text/javascript">var delmem = Array();</script>
             <tr bgcolor="<?php echo $altbg2?>">
             <td align="center">
             <form method="post" action="cp.php?action=members">
             <table cellspacing="0" cellpadding="0" border="0" width="91%" align="center">
             <tr>
             <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
             <tr class="category">
             <td align="center" width="3%"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
             <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textusername']?></font></strong></td>
@@ -1485,8 +1488,8 @@
             <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textbanfrom']?></font></strong></td>
             </tr>
             <?php
-            $srchmem = formVar('srchmem');
-            $srchstatus = formVar('srchstatus');
+            $srchmem = postedVar('srchmem');
+            $srchstatus = postedVar('srchstatus');
             if ($srchstatus == '0') {
                 $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%' ORDER BY username");
             } else if ($srchstatus == "Pending") {
@@ -1545,7 +1548,7 @@
                 }
                 ?>
                 <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
-                <td align="center"><input type="checkbox" name="delete<?php echo $member['uid']?>" onclick="confirmActionCheckbox('<?php echo $lang['confirmDeleteUser']?>', this, true, false);" value="<?php echo $member['uid']?>" /></td>
+                <td align="center"><input type="checkbox" name="delete<?php echo $member['uid']?>" onclick="addUserDel(<?php echo $member['uid']?>, '<?php echo $member['username']?>', this)" value="<?php echo $member['uid']?>" /></td>
                 <td><a href="member.php?action=viewpro&amp;member=<?php echo $member['username']?>"><?php echo $member['username']?></a>
                 <br /><a href="javascript:confirmAction('<?php echo addslashes($lang['confirmDeletePosts']);?>', 'cp.php?action=deleteposts&amp;member=<?php echo $member['username']?>', false);"><strong><?php echo $lang['cp_deleteposts']?></strong></a><?php echo $pending ?>
                 </td>
@@ -1574,7 +1577,7 @@
             }
             ?>
             <tr>
-            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7"><input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="srchmem" value="<?php echo $srchmem?>" /><input type="hidden" name="srchstatus" value="<?php echo $srchstatus?>" /></td>
+            <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="7"><input type="submit" class="submit" name="membersubmit" value="<?php echo $lang['textsubmitchanges']?>" onclick="return confirmUserDel('<?php echo $lang['confirmDeleteUser']?>');" /><input type="hidden" name="srchmem" value="<?php echo $srchmem?>" /><input type="hidden" name="srchstatus" value="<?php echo $srchstatus?>" /></td>
             </tr>
             </table>
             </td>
@@ -1590,8 +1593,8 @@
         $sa_uid = $db->result($query, 0);
         $db->free_result($query);
 
-        $srchmem = formVar('srchmem');
-        $srchstatus = formVar('srchstatus');
+        $srchmem = postedVar('srchmem');
+        $srchstatus = postedVar('srchstatus');
         if ($srchstatus == '0') {
             $query = $db->query("SELECT uid, username, password, status FROM ".X_PREFIX."members WHERE username LIKE '%$srchmem%'");
         } else if ($srchstatus == "Pending") {
@@ -1662,7 +1665,7 @@
         <form method="post" action="cp.php?action=ipban">
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textip']?>:</font></strong></td>
@@ -1769,7 +1772,7 @@
 }
 
 if ($action == "deleteposts") {
-    $member = getVar('member');
+    $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
     $queryd = $db->query("DELETE FROM ".X_PREFIX."posts WHERE author='$member'");
     $queryt = $db->query("SELECT * FROM ".X_PREFIX."threads");
     while($threads = $db->fetch_array($queryt)) {
@@ -1822,7 +1825,7 @@
             <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
             <tr>
             <td bgcolor="<?php echo $bordercolor?>">
-            <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+            <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
             <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
             <td colspan="<?php echo $db->num_fields($query)?>"><strong><?php echo $lang['upgraderesults']?></strong>&nbsp;<?php echo $explode[$num]?>
             <?php
@@ -1848,7 +1851,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="<?php echo $tablewidth?>" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['upgradesuccess']?></td>
         </tr>
@@ -1868,7 +1871,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="tablerow" bgcolor="<?php echo $altbg1?>" colspan="2"><strong><?php echo $lang['textupgrade']?></strong></td>
         </tr>
@@ -1900,18 +1903,18 @@
 
 if ($action == "search") {
     if (onSubmit('searchsubmit')) {
-        $userip = formVar('userip');
-        $postip = formVar('postip');
-        $profileword = formVar('profileword');
-        $postword = formVar('postword');
+        $userip = postedVar('userip');
+        $postip = postedVar('postip');
+        $profileword = postedVar('profileword');
+        $postword = postedVar('postword');
 
         $found = 0;
         $list = array();
         if ($userip) {
             $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE regip = '$userip'");
             while($users = $db->fetch_array($query)) {
-                $link = "./member.php?action=viewpro&amp;member=$users[username]";
-                $list[] = "<a href = \"$link\">$users[username]<br />";
+                $link = "./member.php?action=viewpro&amp;member=".recodeOut($users['username']);
+                $list[] = "<a href = \"$link\">{$users['username']}<br />";
                 $found++;
             }
         }
@@ -1930,10 +1933,10 @@
         }
 
         if ($profileword) {
-            $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE bio = '%$profileword%'");
+            $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE bio LIKE '%$profileword%'");
             while($users = $db->fetch_array($query)) {
-                $link = "./member.php?action=viewpro&amp;member=$users[username]";
-                $list[] = "<a href = \"$link\">$users[username]<br />";
+                $link = "./member.php?action=viewpro&amp;member=".recodeOut($users['username']);
+                $list[] = "<a href = \"$link\">{$users['username']}<br />";
                 $found++;
             }
         }
@@ -1978,7 +1981,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan=2><strong><font color="<?php echo $cattext?>"><?php echo $lang['insertdata']?>:</font></strong></td>
         </tr>
Index: cp2.php
===================================================================
--- cp2.php	(revision 761)
+++ cp2.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,19 +26,21 @@
  *
  **/
 
+define('X_SCRIPT', 'cp2.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
 loadtemplates('error_nologinsession');
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if (X_ADMIN) {
     $download = formVar('download');
-    if ($action == "templates" && $download) {
+    if ($action == 'templates' && $download) {
         $code = '';
-        $templates  = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name ASC");
+        $templates = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name ASC");
         while($template = $db->fetch_array($templates)) {
             $template['template'] = trim($template['template']);
             $template['name'] = trim($template['name']);
@@ -57,7 +59,7 @@
         exit();
     }
 
-    $download = getVar('download');
+    $download = getInt('download');
     if ($action == "themes" && $download) {
         $contents = array();
         $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$download'");
@@ -106,7 +108,7 @@
         <table align="center" border="0" cellspacing="0" cellpadding="0" width="80%">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><span class="smalltxt"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></span></td>
         <td><span class="smalltxt"><strong><font color="<?php echo $cattext?>"><?php echo $lang['restrictedname']?></font></strong></span></td>
@@ -225,10 +227,12 @@
 }
 
 if ($action == 'themes') {
-    $single = getVar('single');
-    $newtheme = formVar('newtheme');
+    $single = '';
+    $single_str = postedVar('single', '', FALSE, FALSE, FALSE, 'g');
+    $single_int = getInt('single');
+    $newtheme = postedVar('newtheme', '', FALSE, FALSE, FALSE, 'g');
 
-    if (noSubmit('themesubmit') && !$single && noSubmit('importsubmit')) {
+    if (noSubmit('themesubmit') && $single_str == '' && noSubmit('importsubmit')) {
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td>
@@ -236,7 +240,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['textthemename']?></font></strong></td>
@@ -319,7 +323,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="header">
         <td colspan="2"><?php echo $lang['textimporttheme']?></td>
         </tr>
@@ -359,7 +363,7 @@
         $keysql = implode(', ', $keysql);
         $valsql = implode(', ', $valsql);
 
-        $query = $db->query("SELECT count(themeid) FROM ".X_PREFIX."themes WHERE name='".addslashes($name)."'");
+        $query = $db->query("SELECT COUNT(themeid) FROM ".X_PREFIX."themes WHERE name='".addslashes($name)."'");
         if ($db->result($query, 0) > 0) {
             error($lang['theme_already_exists'], false, '</td></tr></table></td></tr></table>');
         }
@@ -403,9 +407,10 @@
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
     }
 
-    if ($single && $single != "submit" && $single != "anewtheme1") {
-        $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$single'");
+    if ($single_int > 0) {
+        $query = $db->query("SELECT * FROM ".X_PREFIX."themes WHERE themeid='$single_int'");
         $themestuff = $db->fetch_array($query);
+        $db->free_result($query);
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td>
@@ -413,7 +418,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['texthemename']?></td>
         <td colspan="2"><input type="text" name="namenew" value="<?php echo $themestuff['name']?>" /></td>
@@ -511,7 +516,7 @@
         <td colspan="2"><input type="text"  value="<?php echo $themestuff['smdir']?>" name="smdirnew" /></td>
         </tr>
         <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="3"><input type="submit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="orig" value="<?php echo $single?>" /></td>
+        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="3"><input type="submit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="orig" value="<?php echo $single_int?>" /></td>
         </tr>
         </table>
         </td>
@@ -521,7 +526,7 @@
         </td>
         </tr>
         <?php
-    } else if ($single && $single == "anewtheme1") {
+    } else if ($single_str == "anewtheme1") {
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -529,7 +534,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr bgcolor="<?php echo $altbg2?>" class="tablerow">
         <td><?php echo $lang['texthemename']?></td>
         <td><input type="text" name="namenew" /></td>
@@ -614,8 +619,8 @@
         <td><?php echo $lang['smdir']?></td>
         <td><input type="text" name="smdirnew" value="images" /></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow" colspan="2"><input class="submit" type="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="newtheme" value="<?php echo $single?>" /></td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input class="submit" type="submit" value="<?php echo $lang['textsubmitchanges']?>" /><input type="hidden" name="newtheme" value="true" /></td>
         </tr>
         </table>
         </td>
@@ -625,53 +630,53 @@
         </td>
         </tr>
         <?php
-    } else if ($single && $single == "submit" && !$newtheme) {
-        $namenew = formVar('namenew');
-        $bgcolornew = formVar('bgcolornew');
-        $altbg1new = formVar('altbg1new');
-        $altbg2new = formVar('altbg2new');
-        $linknew = formVar('linknew');
-        $bordercolornew = formVar('bordercolornew');
-        $headernew = formVar('headernew');
-        $headertextnew = formVar('headertextnew');
-        $topnew = formVar('topnew');
-        $catcolornew = formVar('catcolornew');
-        $cattextnew = formVar('cattextnew');
-        $tabletextnew = formVar('tabletextnew');
-        $textnew = formVar('textnew');
-        $borderwidthnew = formVar('borderwidthnew');
-        $tablewidthnew = formVar('tablewidthnew');
-        $tablespacenew = formVar('tablespacenew');
-        $fnew = formVar('fnew');
-        $fsizenew = formVar('fsizenew');
-        $boardlogonew = formVar('boardlogonew');
-        $imgdirnew = formVar('imgdirnew');
-        $smdirnew = formVar('smdirnew');
+    } else if ($single_str == "submit" && !$newtheme) {
+        $namenew = postedVar('namenew');
+        $bgcolornew = postedVar('bgcolornew');
+        $altbg1new = postedVar('altbg1new');
+        $altbg2new = postedVar('altbg2new');
+        $linknew = postedVar('linknew');
+        $bordercolornew = postedVar('bordercolornew');
+        $headernew = postedVar('headernew');
+        $headertextnew = postedVar('headertextnew');
+        $topnew = postedVar('topnew');
+        $catcolornew = postedVar('catcolornew');
+        $cattextnew = postedVar('cattextnew');
+        $tabletextnew = postedVar('tabletextnew');
+        $textnew = postedVar('textnew');
+        $borderwidthnew = postedVar('borderwidthnew');
+        $tablewidthnew = postedVar('tablewidthnew');
+        $tablespacenew = postedVar('tablespacenew');
+        $fnew = postedVar('fnew');
+        $fsizenew = postedVar('fsizenew');
+        $boardlogonew = postedVar('boardlogonew');
+        $imgdirnew = postedVar('imgdirnew');
+        $smdirnew = postedVar('smdirnew');
 
         $db->query("UPDATE ".X_PREFIX."themes SET name='$namenew', bgcolor='$bgcolornew', altbg1='$altbg1new', altbg2='$altbg2new', link='$linknew', bordercolor='$bordercolornew', header='$headernew', headertext='$headertextnew', top='$topnew', catcolor='$catcolornew', tabletext='$tabletextnew', text='$textnew', borderwidth='$borderwidthnew', tablewidth='$tablewidthnew', tablespace='$tablespacenew', fontsize='$fsizenew', font='$fnew', boardimg='$boardlogonew', imgdir='$imgdirnew', smdir='$smdirnew', cattext='$cattextnew' WHERE themeid='$orig'");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
-    } else if ($single && $single == "submit" && $newtheme) {
-        $namenew = formVar('namenew');
-        $bgcolornew = formVar('bgcolornew');
-        $altbg1new = formVar('altbg1new');
-        $altbg2new = formVar('altbg2new');
-        $linknew = formVar('linknew');
-        $bordercolornew = formVar('bordercolornew');
-        $headernew = formVar('headernew');
-        $headertextnew = formVar('headertextnew');
-        $topnew = formVar('topnew');
-        $catcolornew = formVar('catcolornew');
-        $cattextnew = formVar('cattextnew');
-        $tabletextnew = formVar('tabletextnew');
-        $textnew = formVar('textnew');
-        $borderwidthnew = formVar('borderwidthnew');
-        $tablewidthnew = formVar('tablewidthnew');
-        $tablespacenew = formVar('tablespacenew');
-        $fnew = formVar('fnew');
-        $fsizenew = formVar('fsizenew');
-        $boardlogonew = formVar('boardlogonew');
-        $imgdirnew = formVar('imgdirnew');
-        $smdirnew = formVar('smdirnew');
+    } else if ($single_str == "submit" && $newtheme) {
+        $namenew = postedVar('namenew');
+        $bgcolornew = postedVar('bgcolornew');
+        $altbg1new = postedVar('altbg1new');
+        $altbg2new = postedVar('altbg2new');
+        $linknew = postedVar('linknew');
+        $bordercolornew = postedVar('bordercolornew');
+        $headernew = postedVar('headernew');
+        $headertextnew = postedVar('headertextnew');
+        $topnew = postedVar('topnew');
+        $catcolornew = postedVar('catcolornew');
+        $cattextnew = postedVar('cattextnew');
+        $tabletextnew = postedVar('tabletextnew');
+        $textnew = postedVar('textnew');
+        $borderwidthnew = postedVar('borderwidthnew');
+        $tablewidthnew = postedVar('tablewidthnew');
+        $tablespacenew = postedVar('tablespacenew');
+        $fnew = postedVar('fnew');
+        $fsizenew = postedVar('fsizenew');
+        $boardlogonew = postedVar('boardlogonew');
+        $imgdirnew = postedVar('imgdirnew');
+        $smdirnew = postedVar('smdirnew');
 
         $db->query("INSERT INTO ".X_PREFIX."themes (name, bgcolor, altbg1, altbg2, link, bordercolor, header, headertext, top, catcolor, tabletext, text, borderwidth, tablewidth, tablespace, font, fontsize, boardimg, imgdir, smdir, cattext) VALUES('$namenew', '$bgcolornew', '$altbg1new', '$altbg2new', '$linknew', '$bordercolornew', '$headernew', '$headertextnew', '$topnew', '$catcolornew', '$tabletextnew', '$textnew', '$borderwidthnew', '$tablewidthnew', '$tablespacenew', '$fnew', '$fsizenew', '$boardlogonew', '$imgdirnew', '$smdirnew', '$cattextnew')");
         echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['themeupdate'].'</td></tr>';
@@ -687,7 +692,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="4" align="left"><font color="<?php echo $cattext?>"><strong><?php echo $lang['smilies']?></strong></font></td>
         </tr>
@@ -773,14 +778,14 @@
         $smcode = formArray('smcode');
         $smurl = formArray('smurl');
 
-        $newcode = formVar('newcode');
-        $newurl1 = formVar('newurl1');
+        $newcode = postedVar('newcode');
+        $newurl1 = postedVar('newurl1');
         $autoinsertsmilies = formInt('autoinsertsmilies');
 
         $pidelete = formArray('pidelete');
         $piurl = formArray('piurl');
 
-        $newurl2 = formVar('newurl2');
+        $newurl2 = postedVar('newurl2');
         $autoinsertposticons = formInt('autoinsertposticons');
 
         if ($smcode) {
@@ -899,7 +904,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="450" align="center">
         <tr>
         <td style="background-color: <?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td width="4%" align="center"><font style="color: <?php echo $cattext?>"><strong><?php echo $lang['textdeleteques']?></strong></font></td>
         <td align="left"><font style="color: <?php echo $cattext?>"><strong><?php echo $lang['textcensorfind']?></strong></font></td>
@@ -940,14 +945,16 @@
     }
 
     if (onSubmit('censorsubmit')) {
+        $newfind = postedVar('newfind', 'javascript');
+        $newreplace = postedVar('newreplace', 'javascript');
         $querycensor = $db->query("SELECT id FROM ".X_PREFIX."words");
         while($censor = $db->fetch_array($querycensor)) {
-            $find = formVar('find'.$censor['id']);
-            $replace = formVar('replace'.$censor['id']);
-            $delete = formVar('delete'.$censor['id']);
+            $find = postedVar('find'.$censor['id']);
+            $replace = postedVar('replace'.$censor['id']);
+            $delete = formInt('delete'.$censor['id']);
 
             if ($delete) {
-                $db->query("DELETE FROM ".X_PREFIX."words WHERE id='$delete'");
+                $db->query("DELETE FROM ".X_PREFIX."words WHERE id=$delete");
             }
 
             if ($find) {
@@ -972,7 +979,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="650" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" align="center"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textdeleteques']?></font></strong></td>
         <td class="category" align="left"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textcusstatus']?></font></strong></td>
@@ -1040,11 +1047,11 @@
         $stars = formArray('stars');
         $allowavatars = formArray('allowavatars');
         $avaurl = formArray('avaurl');
-        $newtitle = formVar('newtitle');
+        $newtitle = postedVar('newtitle');
         $newposts = formInt('newposts');
         $newstars = formInt('newstars');
         $newallowavatars = formOnOff('newallowavatars');
-        $newavaurl = formVar('newavaurl');
+        $newavaurl = postedVar('newavaurl');
 
         $query = $db->query("SELECT * FROM ".X_PREFIX."ranks");
         $staffranks = array();
@@ -1087,7 +1094,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td colspan="2"><strong><font color="<?php echo $cattext?>"><?php echo $lang['textnewsletter']?></font></strong></td>
         </tr>
@@ -1215,7 +1222,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%" style="vertical-align: top;">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%" style="vertical-align: top;">
         <tr>
         <td class="category" colspan="2">
         <strong>
@@ -1233,7 +1240,7 @@
         <table>
         <tr>
         <td>
-        <input type="checkbox" name="pruneBy[date][check]" value="1" />
+        <input type="checkbox" name="pruneBy[date][check]" value="1" checked="checked" />
         </td>
         <td>
         <select name="pruneBy[date][type]">
@@ -1241,7 +1248,7 @@
         <option value="is"><?php echo $lang['pruneexactly']?></option>
         <option value="less"><?php echo $lang['prunelessthan']?></option>
         </select>
-        <input type="text" name="pruneBy[date][date]" value="10" /> <?php echo $lang['daysold']?>
+        <input type="text" name="pruneBy[date][date]" value="100" /> <?php echo $lang['daysold']?>
         </td>
         </tr>
         <tr>
@@ -1268,7 +1275,7 @@
         <table>
         <tr>
         <td>
-        <input type="radio" name="pruneFrom" value="all" checked="checked" />
+        <input type="radio" name="pruneFrom" value="all" />
         </td>
         <td>
         <?php echo $lang['textallforumsandsubs']?>
@@ -1284,7 +1291,7 @@
         </tr>
         <tr>
         <td>
-        <input type="radio" name="pruneFrom" value="fid" />
+        <input type="radio" name="pruneFrom" value="fid" checked="checked" />
         </td>
         <td>
         <?php echo $lang['prunefids']?> <input type="text" name="pruneFromFid" /> <span class="smalltxt">(<?php echo $lang['seperatebycomma']?>)</span>
@@ -1353,8 +1360,8 @@
                 error($lang['nopruneforums'], false, '</td></tr></table></td></tr></table><br />');
         }
 
+        $sign = '';
         if (isset($pruneBy['posts']['check']) && $pruneBy['posts']['check'] == 1) {
-            $sign = '';
             switch($pruneBy['posts']['type']) {
                 case 'less':
                     $sign = '<';
@@ -1371,7 +1378,6 @@
         }
 
         if (isset($pruneBy['date']['check']) && $pruneBy['date']['check'] == 1) {
-            $sign = '';
             switch($pruneBy['date']['type']) {
                 case 'less':
                     $queryWhere[] = 'lastpost >= '.(time()-(24*3600*$pruneBy['date']['date']));
@@ -1384,6 +1390,8 @@
                     $queryWhere[] = 'lastpost <= '.(time()-(24*3600*$pruneBy['date']['date']));
                     break;
             }
+        } elseif ($sign == '') {
+            $queryWhere[] = '1=0'; //Neither 'prune by' option was set, prune should abort.
         }
 
         if (!isset($pruneType['closed']) || $pruneType['closed'] != 1) {
@@ -1407,9 +1415,9 @@
                     $tids[] = $t['tid'];
                 }
                 $tids = implode(',', $tids);
-                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN($tids)");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid IN($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."threads WHERE tid IN ($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid IN ($tids)");
+                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid IN ($tids)");
             }
         } else {
             $db->query("TRUNCATE TABLE ".X_PREFIX."threads");
@@ -1430,7 +1438,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="80%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1444,20 +1452,21 @@
         <td bgcolor="<?php echo $altbg2?>" class="tablerow">
         <?php
         $query = $db->query("SELECT * FROM ".X_PREFIX."templates ORDER BY name");
-        echo "<select name=\"tid\"><option value=\"default\">$lang[selecttemplate]</option>";
+        echo '<select name="tid"><option value="default">'.$lang['selecttemplate'].'</option>';
         while($template = $db->fetch_array($query)) {
             if (!empty($template['name'])) {
-                echo "<option value=\"$template[id]\">$template[name]</option>\r\n";
+                echo '<option value="'.intval($template['id']).'">'.stripslashes($template['name']).'</option>\r\n';
             }
         }
-        echo "</select>&nbsp;&nbsp;";
+        echo '</select>&nbsp;&nbsp;';
+        $db->free_result($query);
         ?>
         </td>
         </tr>
         <tr>
         <td bgcolor="<?php echo $altbg2?>" class="tablerow">
-        <input type="submit" class="submit"name="edit" value="<?php echo $lang['textedit']?>" />&nbsp;
-        <input type="submit" class="submit"name="delete" value="<?php echo $lang['deletebutton']?>" />&nbsp;
+        <input type="submit" class="submit" name="edit" value="<?php echo $lang['textedit']?>" />&nbsp;
+        <input type="submit" class="submit" name="delete" value="<?php echo $lang['deletebutton']?>" />&nbsp;
         <input type="submit" class="submit" name="restore" value="<?php echo $lang['textrestoredeftemps']?>" />&nbsp;
         <input type="submit" class="submit" name="download" value="<?php echo $lang['textdownloadtemps']?>" />
         </td>
@@ -1480,7 +1489,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1517,8 +1526,10 @@
             $template[1] = isset($template[1]) ? addslashes($template[1]) : '';
             $db->query("INSERT INTO ".X_PREFIX."templates (name, template) VALUES ('".addslashes($template[0])."', '".addslashes($template[1])."')");
         }
+
         $db->query("DELETE FROM ".X_PREFIX."templates WHERE name=''");
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesrestoredone]</td></tr>";
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesrestoredone'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('edit') && noSubmit('editsubmit')) {
@@ -1526,6 +1537,7 @@
         if ($tid == 'default') {
             error($lang['selecttemplate'], false, '</td></tr></table></td></tr></table><br />');
         }
+        $tid = formInt('tid');
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1533,25 +1545,23 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr class="category">
         <td><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
         <?php
-        $query = $db->query("SELECT * FROM ".X_PREFIX."templates WHERE id='$tid' ORDER BY name");
+        $query = $db->query("SELECT * FROM ".X_PREFIX."templates WHERE id=$tid ORDER BY name");
         $template = $db->fetch_array($query);
-        $template['template'] = stripslashes($template['template']);
-        $template['template'] = htmlspecialchars($template['template']);
+        $db->free_result($query);
         ?>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><?php echo $lang['templatename']?>&nbsp;<strong><?php echo $template['name']?></strong></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td><?php echo $lang['templatename']?>&nbsp;<strong><?php echo stripslashes($template['name'])?></strong></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
-        <textarea cols="100" rows="30" name="templatenew"><?php echo $template['template']?></textarea></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg1?>">
+        <td><textarea cols="100" rows="30" name="templatenew"><?php echo stripslashes(htmlspecialchars($template['template']))?></textarea></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></strong></td>
+        <tr class="ctrtablerow" bgcolor="<?php echo $altbg2?>">
+        <td><input type="submit" name="editsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></strong></td>
         </tr>
         </table>
         </td>
@@ -1564,15 +1574,16 @@
     }
 
     if (onSubmit('editsubmit')) {
-        $tid = getVar('tid');
-        $namenew = formVar('namenew');
-        $templatenew = addslashes(getRequestVar('templatenew'));
+        $tid = postedVar('tid', '', FALSE, FALSE, FALSE, 'g');
+        $namenew = postedVar('namenew');
+        //Templates are double-slashed so that they can be eval'd as raw strings.
+        $templatenew = $db->escape(getRequestVar('templatenew'));
 
-        if ($tid == "new") {
+        if ($tid == 'new') {
             if (!$namenew) {
                 error($lang['templateempty'], false, '</td></tr></table></td></tr></table><br />');
             } else {
-                $check = $db->query("SELECT name FROM ".X_PREFIX."templates WHERE name = '$namenew'");
+                $check = $db->query("SELECT name FROM ".X_PREFIX."templates WHERE name='$namenew'");
                 if ($db->num_rows($check) != 0) {
                     error($lang['templateexists'], false, '</td></tr></table></td></tr></table><br />');
                 } else {
@@ -1580,15 +1591,18 @@
                 }
             }
         } else {
-            $db->query("UPDATE ".X_PREFIX."templates SET template='$templatenew' WHERE id='$tid'");
+            $tid = getInt('tid');
+            $db->query("UPDATE ".X_PREFIX."templates SET template='$templatenew' WHERE id=$tid");
         }
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesupdate]</td></tr>";
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesupdate'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('delete')) {
-        if ($tid == "default") {
+        if ($tid == 'default') {
             error($lang['selecttemplate'], false, '</td></tr></table></td></tr></table><br />');
         }
+        $tid = getInt('tid', 'r');
         ?>
         <tr bgcolor="<?php echo $altbg2?>">
         <td align="center">
@@ -1596,15 +1610,15 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg1?>" class="ctrtablerow"><?php echo $lang['templatedelconfirm']?></td>
+        <tr bgcolor="<?php echo $altbg1?>" class="ctrtablerow">
+        <td><?php echo $lang['templatedelconfirm']?></td>
         </tr>
-        <tr>
-        <td bgcolor="<?php echo $altbg2?>" class="ctrtablerow"><input type="submit" class="submit" name="deletesubmit" value="<?php echo $lang['textyes']?>" /></td>
+        <tr bgcolor="<?php echo $altbg2?>" class="ctrtablerow">
+        <td><input type="submit" class="submit" name="deletesubmit" value="<?php echo $lang['textyes']?>" /></td>
         </tr>
         </table>
         </td>
@@ -1617,8 +1631,10 @@
     }
 
     if (onSubmit('deletesubmit')) {
-        $db->query("DELETE FROM ".X_PREFIX."templates WHERE id='$tid'");
-        echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[templatesdelete]</td></tr>";
+        $tid = getInt('tid', 'r');
+        $db->query("DELETE FROM ".X_PREFIX."templates WHERE id=$tid");
+        echo '<tr bgcolor="'.$altbg2.'" class="ctrtablerow"><td>'.$lang['templatesdelete'].'</td></tr>';
+        redirect('cp2.php?action=templates', 2, X_REDIRECT_JS);
     }
 
     if (onSubmit('new')) {
@@ -1629,7 +1645,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category"><strong><font color="<?php echo $cattext?>"><?php echo $lang['templates']?></font></strong></td>
         </tr>
@@ -1662,44 +1678,44 @@
         <form method="post" action="cp2.php?action=attachments">
         <table cellspacing="0" cellpadding="0" border="0" width="550" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="2"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textsearch']?></font></strong></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwherename']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwherename']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="filename" size="30" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereauthor']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereauthor']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="author" size="40" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereforum']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwhereforum']?></td>
         <td bgcolor="<?php echo $altbg2?>"><?php echo $forumselect?></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizesmaller']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizesmaller']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="sizeless" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizegreater']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheresizegreater']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="sizemore" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountsmaller']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountsmaller']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="dlcountless" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountgreater']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredlcountgreater']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="dlcountmore" size="20" /></td>
         </tr>
-        <tr>
-        <td class="tablerow" bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredaysold']?></td>
+        <tr class="tablerow">
+        <td bgcolor="<?php echo $altbg1?>"><?php echo $lang['attachmanwheredaysold']?></td>
         <td bgcolor="<?php echo $altbg2?>"><input type="text" name="daysold" size="20" /></td>
         </tr>
-        <tr>
-        <td align="center" class="tablerow" bgcolor="<?php echo $altbg2?>" colspan="2"><input type="submit" name="searchsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></td>
+        <tr class="ctrtablerow">
+        <td bgcolor="<?php echo $altbg2?>" colspan="2"><input type="submit" name="searchsubmit" class="submit" value="<?php echo $lang['textsubmitchanges']?>" /></td>
         </tr>
         </table>
         </td>
@@ -1712,9 +1728,9 @@
     }
 
     if (onSubmit('searchsubmit')) {
-        $filename = formVar('filename');
-        $author = formVar('author');
-        $forumprune = formVar('forumprune');
+        $filename = postedVar('filename');
+        $author = postedVar('author');
+        $forumprune = postedVar('forumprune');
         $forumprune = $forumprune == 'all' ? '' : intval($forumprune);
         $sizeless = formInt('sizeless');
         $sizemore = formInt('sizemore');
@@ -1728,7 +1744,7 @@
         <table cellspacing="0" cellpadding="0" border="0" width="93%" align="center">
         <tr>
         <td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="category" colspan="6"><font color="<?php echo $cattext?>"><strong><?php echo $lang['textattachsearchresults']?></strong></font></td>
         </tr>
@@ -1745,7 +1761,7 @@
         $orderby = '';
 
         if ($forumprune) {
-            $restriction .= "AND p.fid=$forumprune ";
+            $restriction .= "AND t.fid=$forumprune ";
         }
 
         if ($daysold) {
@@ -1783,9 +1799,9 @@
             $orderby = ' ORDER BY a.downloads DESC ';
         }
 
-        $query = $db->query("SELECT a.*, p.*, t.tid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a, ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE a.pid=p.pid AND t.tid=a.tid AND f.fid=p.fid $restriction $orderby");
+        $query = $db->query("SELECT a.aid, a.pid, a.filename, LENGTH(a.attachment) AS rowsize, a.downloads, p.author, p.tid, t.fid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a LEFT JOIN (".X_PREFIX."posts p LEFT JOIN (".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f USING (fid)) USING (tid)) USING (pid) WHERE 1=1 $restriction $orderby");
         while($attachment = $db->fetch_array($query)) {
-            $attachsize = strlen($attachment['attachment']);
+            $attachsize = $attachment['rowsize'];
             if ($attachsize >= 1073741824) {
                 $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
             } else if ($attachsize >= 1048576) {
@@ -1796,9 +1812,9 @@
                 $attachsize = $attachsize . "b";
             }
 
-            $attachment['tsubject'] = html_entity_decode(stripslashes($attachment['tsubject']));
-            $attachment['fname'] = html_entity_decode(stripslashes($attachment['fname']));
-            $attachment['filename'] = stripslashes($attachment['filename']);
+            $attachment['tsubject'] = stripslashes($attachment['tsubject']); //old databases were double-slashed
+            $attachment['fname'] = stripslashes($attachment['fname']);
+            $attachment['filename'] = attrOut($attachment['filename'], 'javascript');
             ?>
             <tr>
             <td bgcolor="<?php echo $altbg1?>" class="tablerow" align="center" valign="middle"><a href="cp2.php?action=delete_attachment&amp;aid=<?php echo $attachment['aid']?>">Delete</a>
@@ -1818,14 +1834,6 @@
         </td>
         </tr>
         </table>
-        <input type="hidden" name="filename" value="<?php echo $filename?>" />
-        <input type="hidden" name="author" value="<?php echo $author?>" />
-        <input type="hidden" name="forumprune" value="<?php echo $forumprune?>" />
-        <input type="hidden" name="sizeless" value="<?php echo $sizeless?>" />
-        <input type="hidden" name="sizemore" value="<?php echo $sizemore?>" />
-        <input type="hidden" name="dlcountless" value="<?php echo $dlcountless?>" />
-        <input type="hidden" name="dlcountmore" value="<?php echo $dlcountmore?>" />
-        <input type="hidden" name="daysold" value="<?php echo $daysold?>" />
         </form>
         </td>
         </tr>
@@ -1833,55 +1841,20 @@
     }
 
     if (onSubmit('deletesubmit')) {
-        $filename1 = formVar('filename1');
-        $filename = formVar('filename');
-        $author = formVar('author');
-        $forumprune = formInt('forumprune');
-        $sizeless = formInt('sizeless');
-        $sizemore = formInt('sizemore');
-        $dlcountless = formInt('dlcountless');
-        $dlcountmore = formInt('dlcountmore');
-        $daysold = formInt('daysold');
-
-        if ($forumprune) {
-            $queryforum = "AND p.fid='$forumprune' ";
+        $filelist = '';
+        foreach ($_POST as $postedname => $rawvalue) {
+            if (substr($postedname, 0, 8) == 'filename' And is_numeric($fileaid = substr($postedname, 8))) {
+                $filelist .= $fileaid.', ';
+            }
         }
+        $filelist = substr($filelist, 0, -2);
 
-        if ($daysold) {
-            $datethen = $onlinetime - (86400 * $daysold);
-            $querydate = "AND p.dateline <= '$datethen' ";
-        }
-
-        if ($author) {
-            $queryauthor = "AND p.author = '$author' ";
-        }
-
-        if ($filename) {
-            $queryname = "AND a.filename LIKE '%$filename%' ";
-        }
-
-        if ($sizeless) {
-            $querysizeless = "AND a.filesize < '$sizeless' ";
-        }
-
-        if ($sizemore) {
-            $querysizemore = "AND a.filesize > '$sizemore' ";
-        }
-
-        if ($dlcountless) {
-            $querydlcountless = "AND a.downloads < '$dlcountless' ";
-        }
-
-        if ($dlcountmore) {
-            $querydlcountmore = "AND a.downloads > '$dlcountmore' ";
-        }
-
-        $query = $db->query("SELECT a.*, p.*, t.tid, t.subject AS tsubject, f.name AS fname FROM ".X_PREFIX."attachments a, ".X_PREFIX."posts p, ".X_PREFIX."threads t, ".X_PREFIX."forums f WHERE a.pid=p.pid AND t.tid=a.tid AND f.fid=p.fid $queryforum $querydate $queryauthor $queryname $querysizeless $querysizemore");
+        $query = $db->query("SELECT a.aid, a.filename FROM ".X_PREFIX."attachments a WHERE a.aid IN ($filelist)");
         while($attachment = $db->fetch_array($query)) {
             $afilename = "filename" . $attachment['aid'];
-            $afilename = isset($_POST[$afilename]) ? $_POST[$afilename] : '';
-            if ($attachment['filename'] != $afilename) {
-                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$afilename' WHERE aid='$attachment[aid]'");
+            if ($attachment['filename'] != $_POST[$afilename] And isValidFilename($_POST[$afilename])) {
+                $afilename = isset($_POST[$afilename]) ? $db->escape(trim($_POST[$afilename])) : '';
+                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$afilename' WHERE aid='{$attachment['aid']}'");
             }
         }
         echo "<tr bgcolor=\"$altbg2\" class=\"tablerow\"><td align=\"center\">$lang[textattachmentsupdate]</td></tr>";
@@ -1897,7 +1870,7 @@
     <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
     <tr>
     <td bgcolor="<?php echo $bordercolor?>">
-    <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+    <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
     <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
@@ -2019,7 +1992,7 @@
     <table cellspacing="0" cellpadding="0" border="0" width="500" align="center">
     <tr>
     <td bgcolor="<?php echo $bordercolor?>">
-    <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+    <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
     <tr class="category">
     <td><strong><font color="<?php echo $cattext?>">Username:</font></strong></td>
     <td><strong><font color="<?php echo $cattext?>">Time:</font></strong></td>
@@ -2129,12 +2102,12 @@
 }
 
 if ($action == "delete_attachment") {
-    $aid = getInt($aid);
-    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid='$aid'");
+    $aid = getInt('aid');
+    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid=$aid");
     echo "<p align=\"center\">Deleted ...</br>";
 }
 
 echo '</table></td></tr></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: db/mysql.php
===================================================================
--- db/mysql.php	(revision 761)
+++ db/mysql.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -40,35 +40,28 @@
 * Must be instantiated before first use.
 */
 class dbstuff {
-    var $querynum   = 0;
-    var $querylist  = array();
+    var $querynum = 0;
+    var $querylist = array();
     var $querytimes = array();
-    var $link       = '';
-    var $db         = '';
-    var $duration   = 0;
-    var $timer      = 0;
+    var $link = '';
+    var $db = '';
+    var $duration = 0;
+    var $timer = 0;
 
     function connect($dbhost="localhost", $dbuser, $dbpw, $dbname, $pconnect=0, $force_db=false) {
-        $die = false;
 
         if ($pconnect) {
-            $this->link = @mysql_pconnect($dbhost, $dbuser, $dbpw) or ($die = true);
+            $this->link = @mysql_pconnect($dbhost, $dbuser, $dbpw);
         } else {
-            $this->link = @mysql_connect($dbhost, $dbuser, $dbpw) or ($die = true);
+            $this->link = @mysql_connect($dbhost, $dbuser, $dbpw);
         }
 
-        if ($die) {
+        if ( $this->link == false ) {
             echo '<h3>Database connection error!</h3>';
             echo 'A connection to the Database could not be established.<br />';
             echo 'Please check your username, password, database name and host.<br />';
             echo 'Also make sure <i>config.php</i> is rightly configured!<br /><br />';
-            if (defined('X_SADMIN') && X_SADMIN && defined('DEBUG') && DEBUG) {
-                $num = mysql_errno();
-                $msg = mysql_error();
-                echo 'When connecting, the database returned:<br />';
-                echo '<i><b>Error '.$num.': </b>'.$msg.'</i>';
-            }
-            exit();
+            $this->panic();
         }
 
         unset($GLOBALS['dbhost'], $GLOBALS['dbuser'], $GLOBALS['dbpw']);
@@ -138,25 +131,37 @@
         return mysql_field_name($query, $field);
     }
 
-    function implicitError($sql, $overwriteErrorPerms=false) {
-        if (($error = $this->error()) !== false) {
-            if ($overwriteErrorPerms) {
-                return $error;
-            } else {
-                if ((defined('X_SADMIN') && X_SADMIN && defined('DEBUG') && DEBUG) || (!defined('X_MEMBER') && !defined('X_GUEST'))) {
-                    return 'MySQL encountered the following error: '.$error."\n<br />".'In the following query: <em>'.$sql.'</em>';
-                } else {
-                    return 'MySQL has encountered an unknown error. To find out the exact problem, please set the DEBUG flag to true in config.php.';
-                }
-            }
-        } else {
-            return 'oops';
-        }
+    function panic($sql = '') {
+    	
+    	if ( X_SADMIN && DEBUG )
+    	{
+    		// Check that we actually made a connection
+			if ( $this->link == false ) {
+				$this->link = null;
+			}    		
+    		
+    		$error = mysql_error($this->link);
+    		$errno = mysql_error($this->link);
+    		
+			echo '<pre>MySQL encountered the following error: '.$error."(errno = ".$errno.")\n<br />".'In the following query: <em>'.$sql.'</em></pre>';
+    	}
+    	else
+    	{
+    		echo '<pre>The system has failed to process your request. If you\'re an administrator, please set the DEBUG flag to true in config.php.</pre>';
+    	}
+    	exit;
     }
 
+    function escape($rawstring) {
+        return mysql_real_escape_string($rawstring, $this->link);
+    }
+
     function query($sql, $overwriteErrorPerms=false) {
         $this->start_timer();
-        $query = mysql_query($sql, $this->link) or die($this->implicitError($sql, $overwriteErrorPerms));
+        $query = mysql_query($sql, $this->link);
+		if ( $query == false ) {
+			$this->panic($sql);
+		}
         $this->querynum++;
         $this->querylist[] = $sql;
         $this->querytimes[] = $this->stop_timer();
@@ -165,7 +170,10 @@
 
     function unbuffered_query($sql) {
         $this->start_timer();
-        $query = mysql_unbuffered_query($sql, $this->link) or die(mysql_error());
+        $query = mysql_unbuffered_query($sql, $this->link);
+        if ( $query == false ) {
+        	$this->panic($sql);
+        }
         $this->querynum++;
         $this->querylist[] = $sql;
         $this->querytimes[] = $this->stop_timer();
@@ -234,4 +242,4 @@
 define('SQL_NUM', MYSQL_NUM);
 define('SQL_BOTH', MYSQL_BOTH);
 define('SQL_ASSOC', MYSQL_ASSOC);
-?>
\ No newline at end of file
+?>
Index: editprofile.php
===================================================================
--- editprofile.php	(revision 761)
+++ editprofile.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'editprofile.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -45,7 +47,7 @@
     error($lang['superadminonly'], false);
 }
 
-$user = getVar('user');
+$user = postedVar('user', '', TRUE, TRUE, FALSE, 'g');
 
 $userid = $db->fetch_array($db->query("SELECT uid FROM ".X_PREFIX."members WHERE username='$user'"));
 if (empty($userid['uid'])) {
@@ -53,7 +55,7 @@
 }
 
 if (noSubmit('editsubmit')) {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='".rawurldecode($user)."'");
+    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$user'");
     $member = $db->fetch_array($query);
 
     $checked = '';
@@ -190,7 +192,7 @@
         $langfilenew = basename($fileNameHash);
     }
 
-    $timeoffset1 = formInt('timeoffset1');
+    $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
     $thememem = formInt('thememem');
     $tppnew = isset($_POST['tppnew']) ? (int) $_POST['tppnew'] : $SETTINGS['topicperpage'];
     $pppnew = isset($_POST['pppnew']) ? (int) $_POST['pppnew'] : $SETTINGS['postperpage'];
@@ -215,21 +217,21 @@
     $day = formInt('day');
     $bday = iso8601_date($year, $month, $day);
     $newavatar = formVar('newavatar');
-    $avatar = $newavatar ? checkInput($newavatar, 'no', 'no', 'javascript', false) : '';
+    $avatar = $newavatar ? checkInput($newavatar, 'no', 'yes', 'javascript', false) : '';
     $newlocation = formVar('newlocation');
-    $location = $newlocation ? checkInput($newlocation, 'no', 'no', 'javascript', false) : '';
+    $location = $newlocation ? checkInput($newlocation, 'no', 'yes', 'javascript', false) : '';
     $newicq = formVar('newicq');
     $icq = ($newicq && is_numeric($newicq) && $newicq > 0) ? $newicq : 0;
     $newyahoo = formVar('newyahoo');
-    $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'no', 'javascript', false) : '';
+    $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'yes', 'javascript', false) : '';
     $newaim = formVar('newaim');
-    $aim = $newaim ? checkInput($newaim, 'no', 'no', 'javascript', false) : '';
+    $aim = $newaim ? checkInput($newaim, 'no', 'yes', 'javascript', false) : '';
     $newmsn = formVar('newmsn');
-    $msn = $newmsn ? checkInput($newmsn, 'no', 'no', 'javascript', false) : '';
+    $msn = $newmsn ? checkInput($newmsn, 'no', 'yes', 'javascript', false) : '';
     $newemail = formVar('newemail');
-    $email = $newemail ? checkInput($newemail, 'no', 'no', 'javascript', false) : '';
+    $email = $newemail ? checkInput($newemail, 'no', 'yes', 'javascript', false) : '';
     $newsite = formVar('newsite');
-    $site = $newsite ? checkInput($newsite, 'no', 'no', 'javascript', false) : '';
+    $site = $newsite ? checkInput($newsite, 'no', 'yes', 'javascript', false) : '';
     $bio = isset($_POST['newbio']) ? checkInput($_POST['newbio'], 'no', 'no', 'javascript', false) : '';
     $mood = isset($_POST['newmood']) ? checkInput($_POST['newmood'], 'no', 'no', 'javascript', false) : '';
     $sig = isset($_POST['newsig']) ? checkInput($_POST['newsig'], '', $SETTINGS['sightml'], '', false) : '';
@@ -246,8 +248,8 @@
     $sig = addslashes($sig);
 
     $max_size = explode('x', $SETTINGS['max_avatar_size']);
-    if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-        $size = @getimagesize($avatar);
+    if ($max_size[0] > 0 && $max_size[1] > 0 && ini_get('allow_url_fopen')) {
+        $size = @getimagesize($_POST['newavatar']);
         if ($size === false) {
             $avatar = '';
         } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
@@ -256,8 +258,7 @@
     }
 
     $db->query("UPDATE ".X_PREFIX."members SET email='$email', site='$site', aim='$aim', location='$location', bio='$bio', sig='$sig', showemail='$showemail', timeoffset='$timeoffset1', icq='$icq', avatar='$avatar', yahoo='$yahoo', theme='$thememem', bday='$bday', langfile='$langfilenew', tpp='$tppnew', ppp='$pppnew', newsletter='$newsletter', timeformat='$timeformatnew', msn='$msn', dateformat='$dateformatnew', mood='$mood', invisible='$invisible', saveogu2u='$saveogu2u', emailonu2u='$emailonu2u', useoldu2u='$useoldu2u' WHERE username='$user'");
-
-    $newpassword = formVar('newpassword');
+    $newpassword = $_POST['newpassword'];
     if ($newpassword) {
         $newpassword = md5($newpassword);
         $db->query("UPDATE ".X_PREFIX."members SET password='$newpassword' WHERE username='$user'");
@@ -269,4 +270,4 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: faq.php
===================================================================
--- faq.php	(revision 761)
+++ faq.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,9 +26,11 @@
  *
  **/
 
+define('X_SCRIPT', 'faq.php');
+
 require 'header.php';
 
-$page = getVar('page');
+$page = postedVar('page', '', FALSE, FALSE, FALSE, 'g');
 
 if ($SETTINGS['faqstatus'] == 'off' && $page != 'forumrules') {
     loadtemplates('misc_feature_notavailable');
@@ -67,7 +69,7 @@
         loadtemplates('faq_messages_smilierow', 'faq_messages');
         $smilierows = NULL;
         nav($lang['textpostread']);
-        $querysmilie = $db->query("SELECT * FROM `" .X_PREFIX. "smilies` WHERE type = 'smiley'") or die($db->error());
+        $querysmilie = $db->query("SELECT * FROM `" .X_PREFIX. "smilies` WHERE type = 'smiley'");
         while($smilie = $db->fetch_array($querysmilie)) {
             eval('$smilierows .= "'.template('faq_messages_smilierow').'";');
         }
@@ -96,4 +98,4 @@
 end_time();
 eval('$footer = "'.template('footer').'";');
 echo stripslashes($header.$faq.$footer);
-?>
\ No newline at end of file
+?>
Index: forumdisplay.php
===================================================================
--- forumdisplay.php	(revision 761)
+++ forumdisplay.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'forumdisplay.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -214,7 +216,7 @@
     if ($thread['author'] == $lang['textanonymous']) {
         $authorlink = $thread['author'];
     } else {
-        $authorlink = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($thread['author']).'">'.$thread['author'].'</a>';
+        $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
     }
 
     $prefix = '';
@@ -223,7 +225,7 @@
     $dalast = trim($lastpost[0]);
 
     if ($lastpost[1] != $lang['textanonymous']) {
-        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode(trim($lastpost[1])).'">'.trim($lastpost[1]).'</a>';
+        $lastpost[1] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut(trim($lastpost[1])).'">'.trim($lastpost[1]).'</a>';
     } else {
         $lastpost[1] = $lang['textanonymous'];
     }
Index: header.php
===================================================================
--- header.php	(revision 761)
+++ header.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -83,6 +83,7 @@
 $filetype = '';
 $quickjump = '';
 $newu2umsg = '';
+$othertid = '';
 
 define('COMMENTOUTPUT', false);
 define('MAXATTACHSIZE', 256000);
@@ -106,9 +107,9 @@
 if ($show_full_info) {
     $alpha = '';
     $beta = '';
-    $gamma = 'Final';
-    $service_pack = ' SP2';
-    $versionbuild = 20071231;
+    $gamma = '';
+    $service_pack = ' SP3';
+    $versionbuild = 20080509;
     $versionlong = 'Powered by '.$versiongeneral.' '.$alpha.$beta.$gamma.$service_pack.''.(DEBUG === true ? ' (Debug Mode)' : '');
 } else {
     $alpha = '';
@@ -141,7 +142,7 @@
 
 // Fix provided by whinpo :)
 // Browser incompatability regarding insertion.
-if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE')) {
+if (false !== strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE') && !defined('IS_IE')) {
     define('IS_IE', true);
     $browser = 'ie';
 }
@@ -221,15 +222,6 @@
     }
 }
 
-// Checks for various variables in the URL, if any of them is found, script is halted
-$url_check = Array('status=', 'xmbuser=', 'xmbpw=', '<script');
-$url = urldecode($url);
-foreach($url_check as $name) {
-    if (strpos(strtolower($url), $name)) {
-        exit();
-    }
-}
-
 // Load Objects, and such
 $tables = array(
     'attachments',
@@ -266,6 +258,21 @@
 $db = new dbstuff;
 $db->connect($dbhost, $dbuser, $dbpw, $dbname, $pconnect);
 
+// Checks for various variables in the URL, if any of them is found, script is halted
+$url_check = Array('status=', 'xmbuser=', 'xmbpw=', '%3cscript');
+foreach($url_check as $name) {
+    if (strpos(strtolower($url), $name)) {
+    	$auditaction = $_SERVER['REQUEST_URI'];
+		$aapos = strpos($auditaction, "?");
+		if ($aapos !== false) {
+		    $auditaction = substr($auditaction, $aapos + 1);
+		}
+		$auditaction = $db->escape("$onlineip|#|ATTACK: $auditaction");
+		audit($xmbuser, $auditaction, 0, 0);
+        exit("Attack logged.");
+    }
+}
+
 // Load a few constants
 define('XMB_VERSION', $versiongeneral);
 define('XMB_BUILD', $versionbuild);
@@ -290,18 +297,21 @@
     $cookiepath = $array['path'];
 }
 
-// Set cookies
-put_cookie('xmblva', $onlinetime, ($onlinetime + (86400*365)), $cookiepath, $cookiedomain);
+// Update last visit cookies
 
-if (isset($xmblvb)) {
-    $thetime = $xmblvb;
-} else if (isset($xmblva)) {
-    $thetime = $xmblva;
+$xmblva = getInt('xmblva', 'c'); // Last visit
+$xmblvb = getInt('xmblvb', 'c'); // Duration of this visit (considered to be up to 600 seconds)
+
+if ($xmblvb > 0) {
+    $thetime = $xmblvb;		// lvb will expire in 600 seconds, so if it's there, we're in a current session
+} else if ($xmblva > 0) {
+    $thetime = $xmblva;		// Not currently logged in, so let's get the time from the last visit
 } else {
-    $thetime = $onlinetime;
+    $thetime = $onlinetime;	// no cookie at all, so this is your first visit
 }
 
-put_cookie('xmblvb', $thetime, ($onlinetime + 600), $cookiepath, $cookiedomain);
+put_cookie('xmblva', $onlinetime, ($onlinetime + (86400*365)), $cookiepath, $cookiedomain); // lva == now
+put_cookie('xmblvb', $thetime, ($onlinetime + 600), $cookiepath, $cookiedomain); // lvb =
 
 $lastvisit = $thetime;
 $lastvisit2 = $lastvisit - 540;
@@ -335,21 +345,29 @@
 }
 
 // Get the user-vars, and make them semi-global
-if (!isset($xmbuser)) {
-    $xmbuser = '';
-    $xmbpw = '';
+$xmbuser = '';
+$xmbpw = '';
+if (isset($_COOKIE['xmbuser']) And isset($_COOKIE['xmbpw'])) {
+    $xmbuserinput = $db->escape($_COOKIE['xmbuser']);
+    $xmbpwinput = $_COOKIE['xmbpw'];
+} else {
+    $xmbuserinput = '';
+    $xmbpwinput = '';
     $self['status'] = '';
 }
 
 $q = false;
-if ($xmbuser != '') {
-    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuser'");
+if ($xmbuserinput != '') {
+    $query = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$xmbuserinput'");
     $userrec = $db->fetch_array($query);
-    if ($db->num_rows($query) == 1 && $userrec['password'] == $xmbpw) {
+    if ($db->num_rows($query) == 1 && $userrec['password'] == $xmbpwinput) {
         $q = true;
+        $xmbuser = $db->escape($userrec['username']);
+        $xmbpw = $xmbpwinput;
     }
     $db->free_result($query);
 }
+unset($xmbuserinput, $xmbpwinput);
 
 if ($q) {
     foreach($userrec as $key => $val) {
@@ -457,7 +475,7 @@
 define('X_SADMIN', $role['sadmin']);
 define('X_ADMIN', $role['admin']);
 define('X_SMOD', $role['smod']);
-define('X_MOD', $role['smod']);
+define('X_MOD', $role['mod']);
 define('X_STAFF', $role['staff']);
 
 // Get the required language file
@@ -483,7 +501,7 @@
     if (X_ADMIN) {
         $cplink = ' - <a href="cp.php">'.$lang['textcp'].'</a>';
     }
-    $notify = $lang['loggedin'].' <a href="member.php?action=viewpro&amp;member='.rawurlencode($onlineuser).'">'.$xmbuser.'</a><br />['.$loginout.' - '.$u2ulink.''.$memcp.''.$cplink.']';
+    $notify = $lang['loggedin'].' <a href="member.php?action=viewpro&amp;member='.recodeOut($xmbuser).'">'.$xmbuser.'</a><br />['.$loginout.' - '.$u2ulink.''.$memcp.''.$cplink.']';
 } else {
     $loginout = '<a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
     $onlineuser = 'xguest123';
@@ -502,8 +520,8 @@
 $dateformat = str_replace(array('mm', 'MM', 'dd', 'DD', 'yyyy', 'YYYY', 'yy', 'YY'), array('n', 'n', 'j', 'j', 'Y', 'Y', 'y', 'y'), $dateformat);
 
 // Get themes, [fid, [tid]]
-if (isset($tid) && $action != 'templates') {
-    $query = $db->query("SELECT f.fid, f.theme, t.subject FROM ".X_PREFIX."forums f, ".X_PREFIX."threads t WHERE f.fid=t.fid AND t.tid='$tid'");
+if (isset($tid) && is_numeric($tid) && $action != 'templates') {
+    $query = $db->query("SELECT f.fid, f.theme, t.subject FROM ".X_PREFIX."forums f, ".X_PREFIX."threads t WHERE f.fid=t.fid AND t.tid=$tid");
     $locate = $db->fetch_array($query);
     $db->free_result($query);
     $fid = $locate['fid'];
@@ -513,8 +531,8 @@
     } else {
         $threadSubject = '';
     }
-} else if (isset($fid)) {
-    $q = $db->query("SELECT theme FROM ".X_PREFIX."forums WHERE fid='$fid'");
+ } else if (isset($fid) && is_numeric($fid)) {
+    $q = $db->query("SELECT theme FROM ".X_PREFIX."forums WHERE fid=$fid");
     if ($db->num_rows($q) === 1) {
         $forumtheme = $db->result($q, 0);
         $db->free_result($q);
@@ -530,18 +548,6 @@
 $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE ((ip='$onlineip' && username='xguest123') OR (username='$xmbuser') OR (time < '$newtime'))");
 $db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
 
-// Find duplicate entries for users only
-$username = isset($username) ? $username : '';
-if (X_MEMBER) {
-    $result = $db->query("SELECT count(username) FROM ".X_PREFIX."whosonline WHERE (username='$xmbuser')");
-    $usercount = $db->result($result, 0);
-    if ($usercount > 1) {
-        $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE (username='$xmbuser')");
-        $db->query("INSERT INTO ".X_PREFIX."whosonline (username, ip, time, location, invisible) VALUES ('$onlineuser', '$onlineip', ".$db->time($onlinetime).", '$wollocation', '$invisible')");
-    }
-    $db->free_result($result);
-}
-
 // Check what theme to use
 if ((int) $themeuser > 0) {
     $theme = (int) $themeuser;
@@ -705,20 +711,15 @@
 }
 
 // If the board is offline, display an appropriate message
-if ($SETTINGS['bbstatus'] == 'off' && !(X_ADMIN) && false === strpos($url, 'misc.php') && false === strpos($url, 'member.php')) {
-    $newu2umsg = '';
+if ($SETTINGS['bbstatus'] == 'off' && !(X_ADMIN) && X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php') {
     eval('$css = "'.template('css').'";');
     message(nl2br(stripslashes($bboffreason)));
 }
 
 // If the board is set to 'reg-only' use, check if someone is logged in, and if not display a message
-if ($SETTINGS['regviewonly'] == 'on') {
-    if (X_GUEST && $action != 'reg' && $action != 'login' && $action != 'lostpw' && $action != 'coppa' && $action != 'captchaimage') {
-        if ($SETTINGS['coppa'] == 'on') {
-            $message = $lang['reggedonly'].' <a href="member.php?action=coppa">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-        } else {
-            $message = $lang['reggedonly'].' <a href="member.php?action=reg">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
-        }
+if ($SETTINGS['regviewonly'] == 'on' && X_GUEST) {
+    if (($action != 'reg' && $action != 'login' && $action != 'lostpw' && $action != 'coppa' && $action != 'captchaimage') || (X_SCRIPT != 'misc.php' && X_SCRIPT != 'member.php')) {
+        $message = $lang['reggedonly'].' <a href="member.php?action=coppa">'.$lang['textregister'].'</a> '.$lang['textor'].' <a href="misc.php?action=login">'.$lang['textlogin'].'</a>';
         eval('$css = "'.template('css').'";');
         message($message);
     }
@@ -751,7 +752,6 @@
 // create forum jump
 $quickjump = '';
 if ($SETTINGS['quickjump_status'] == 'on') {
-    $quickjump = base64_decode($quickjump);
     $quickjump = forumJump();
 }
-?>
\ No newline at end of file
+?>
Index: include/admin.inc.php
===================================================================
--- include/admin.inc.php	(revision 761)
+++ include/admin.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
Index: include/buddy.inc.php
===================================================================
--- include/buddy.inc.php	(revision 761)
+++ include/buddy.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -31,13 +31,15 @@
 }
 
 function blistmsg($message, $redirect='', $exit=false) {
-    global $bordercolor, $tablewidth, $borderwidth, $tablespace, $altbg1, $css, $bbname, $lang;
+    global $bordercolor, $tablewidth, $THEME, $tablespace, $altbg1, $css, $bbname, $lang;
     global $charset, $text, $redirectjs;
 
     if ($redirect != '') {
         redirect($redirect, 2);
     }
+    
     eval('echo stripslashes("'.template('buddylist_message').'");');
+    
     if ($exit) {
         exit();
     }
@@ -58,8 +60,6 @@
         if (empty($buddy) || (strlen(trim($buddy)) == 0)) {
             blistmsg($lang['nobuddyselected'], '', true);
         } else {
-            $buddy = addslashes(checkInput($buddy));
-
             if ($buddy == $xmbuser) {
                 blistmsg($lang['buddywarnaddself']);
             }
@@ -82,11 +82,10 @@
 
 function buddy_edit() {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     $buddys = array();
-
-    $q = $db->query("SELECT buddyname FROM ".X_PREFIX."buddys WHERE username='$xmbuser'") or die($db->error());
+    $q = $db->query("SELECT buddyname FROM ".X_PREFIX."buddys WHERE username='$xmbuser'");
     while($buddy = $db->fetch_array($q)) {
         eval('$buddys[] = "'.template('buddylist_edit_buddy').'";');
     }
@@ -102,10 +101,9 @@
 
 function buddy_delete($delete) {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     foreach($delete as $key=>$buddy) {
-        $buddy = addslashes(checkInput($buddy));
         $db->query("DELETE FROM ".X_PREFIX."buddys WHERE buddyname='$buddy' AND username='$xmbuser'");
     }
 
@@ -114,7 +112,7 @@
 
 function buddy_display() {
     global $db, $lang, $xmbuser, $oToken;
-    global $charset, $css, $bbname, $text, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
+    global $charset, $css, $bbname, $text, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $altbg1, $altbg2;
 
     $q = $db->query("SELECT b.buddyname, w.invisible, w.username FROM ".X_PREFIX."buddys b LEFT JOIN ".X_PREFIX."whosonline w ON (b.buddyname=w.username) WHERE b.username='$xmbuser'");
     $buddys = array();
@@ -139,4 +137,4 @@
     }
     eval('echo stripslashes("'.template('buddylist').'");');
 }
-?>
\ No newline at end of file
+?>
Index: include/captcha.inc.php
===================================================================
--- include/captcha.inc.php	(revision 761)
+++ include/captcha.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -291,8 +291,10 @@
         }
     }
 
-    function GenerateCode() {
+function GenerateCode() {
         global $db, $onlinetime;
+        
+        $db->query('DELETE FROM '.X_PREFIX.'captchaimages WHERE dateline < '.($onlinetime - 86400));
         // loop through and generate the code letter by letter
         for($i = 0; $i < $this->iNumChars; $i++) {
             if (count($this->aCharSet) >= $this->iNumChars) {
@@ -425,6 +427,8 @@
 
             // free memory used to create background image
             imagedestroy($oBackgroundImage);
+        } elseif ($this->bUseColor) {
+            $this->oImage = imagecreatetruecolor($this->iWidth, $this->iHeight);
         } else {
             // create new image
             $this->oImage = imagecreate($this->iWidth, $this->iHeight);
@@ -434,7 +438,12 @@
         $bg_red = hexdec(substr($THEME['altbg2'], 1, 2));
         $bg_green = hexdec(substr($THEME['altbg2'], 3, 2));
         $bg_blue = hexdec(substr($THEME['altbg2'], 5, 2));
-        imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
+        $bgcolor = imagecolorallocate($this->oImage, $bg_red, $bg_green, $bg_blue);
+        
+        if ($this->bUseColor And empty($this->aBackgroundImages)) {
+            imagefill($this->oImage, 0, 0, $bgcolor);
+        }
+
         $this->DrawDots();
         $this->DrawLines();
         $this->RetrieveCode($imghash);
@@ -486,4 +495,4 @@
         }
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/functions.inc.php
===================================================================
--- include/functions.inc.php	(revision 761)
+++ include/functions.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -32,7 +32,7 @@
     if (!$add) {
         $navigation = '';
     } else {
-        $navigation .= ($raquo ? ' / ' : ''). $add;
+        $navigation .= ($raquo ? ' &raquo; ' : ''). $add;
     }
 }
 
@@ -106,13 +106,22 @@
 
     if (is_array($censorcache)) {
         if (count($censorcache) > 0) {
+            $prevfind = '';
             foreach($censorcache as $find=>$replace) {
                 if ($ignorespaces === true) {
-                    $txt = str_replace($find, $replace, $txt);
+                    $txt = str_ireplace($find, $replace, $txt);
                 } else {
-                    $txt = preg_replace("#(^|[^a-z])(".preg_quote($find).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+                    if ($prevfind == '') {
+                        $prevfind = $find;
+                    }
+                    $txt = preg_replace("#(^|[^a-z])(".preg_quote($find)."|".preg_quote($prevfind).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+                    $prevfind = $find;
                 }
             }
+
+            if ($ignorespaces !== true) {
+                $txt = preg_replace("#(^|[^a-z])(".preg_quote($find).")($|[^a-z])#si", '\1'.$replace.'\3', $txt);
+            }
         }
     }
     return $txt;
@@ -170,7 +179,7 @@
 }
 
 function postify($message, $smileyoff='no', $bbcodeoff='no', $allowsmilies='yes', $allowhtml='yes', $allowbbcode='yes', $allowimgcode='yes', $ignorespaces=false, $ismood="no", $wrap="yes") {
-    global $imgdir, $bordercolor, $db, $smdir, $smiliecache, $censorcache, $smiliesnum, $wordsnum, $versionbuild, $lang, $fontsize;
+    global $imgdir, $bordercolor, $db, $smdir, $smiliecache, $censorcache, $smiliesnum, $wordsnum, $versionbuild, $fontsize;
 
     $message = checkOutput($message, $allowhtml, '', true);
     $message = censor($message, $ignorespaces);
@@ -186,33 +195,33 @@
         }
 
         $begin = array(
-                0 => '[b]',
-                1 => '[i]',
-                2 => '[u]',
-                3 => '[marquee]',
-                4 => '[blink]',
-                5 => '[strike]',
-                6 => '[quote]',
-                7 => '[code]',
-                8 => '[list]',
-                9 => '[list=1]',
-                10 => '[list=a]',
-                11 => '[list=A]',
+            0 => '[b]',
+            1 => '[i]',
+            2 => '[u]',
+            3 => '[marquee]',
+            4 => '[blink]',
+            5 => '[strike]',
+            6 => '[quote]',
+            7 => '[code]',
+            8 => '[list]',
+            9 => '[list=1]',
+            10 => '[list=a]',
+            11 => '[list=A]',
         );
 
         $end = array(
-                0 => '[/b]',
-                1 => '[/i]',
-                2 => '[/u]',
-                3 => '[/marquee]',
-                4 => '[/blink]',
-                5 => '[/strike]',
-                6 => '[/quote]',
-                7 => '[/code]',
-                8 => '[/list]',
-                9 => '[/list=1]',
-                10 => '[/list=a]',
-                11 => '[/list=A]',
+            0 => '[/b]',
+            1 => '[/i]',
+            2 => '[/u]',
+            3 => '[/marquee]',
+            4 => '[/blink]',
+            5 => '[/strike]',
+            6 => '[/quote]',
+            7 => '[/code]',
+            8 => '[/list]',
+            9 => '[/list=1]',
+            10 => '[/list=a]',
+            11 => '[/list=A]',
         );
 
         foreach($begin as $key=>$value) {
@@ -224,147 +233,45 @@
             }
         }
 
-        $find = array(
-                0 => '[b]',
-                1 => '[/b]',
-                2 => '[i]',
-                3 => '[/i]',
-                4 => '[u]',
-                5 => '[/u]',
-                6 => '[marquee]',
-                7 => '[/marquee]',
-                8 => '[blink]',
-                9 => '[/blink]',
-                10 => '[strike]',
-                11 => '[/strike]',
-                12 => '[quote]',
-                13 => '[/quote]',
-                14 => '[code]',
-                15 => '[/code]',
-                16 => '[list]',
-                17 => '[/list]',
-                18 => '[list=1]',
-                19 => '[list=a]',
-                20 => '[list=A]',
-                21 => '[/list=1]',
-                22 => '[/list=a]',
-                23 => '[/list=A]',
-                24 => '[*]',
-                25 => '<br />'
-        );
-
-        $replace = array(
-                0 => '<strong>',
-                1 => '</strong>',
-                2 => '<em>',
-                3 => '</em>',
-                4 => '<u>',
-                5 => '</u>',
-                6 => '<marquee>',
-                7 => '</marquee>',
-                8 => '<blink>',
-                9 => '</blink>',
-                10 => '<strike>',
-                11 => '</strike>',
-                12 => '</font><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage">',
-                13 => ' </td></tr></table><font class="mediumtxt">',
-                14 => '</font><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr><tr><td class="codemessage">',
-                15 => '</td></tr></table><font class="mediumtxt">',
-                16 => '<ul type="square">',
-                17 => '</ul>',
-                18 => '<ol type="1">',
-                19 => '<ol type="A">',
-                20 => '<ol type="A">',
-                21 => '</ol>',
-                22 => '</ol>',
-                23 => '</ol>',
-                24 => '<li />',
-                25 => '<br />'
-        );
-
-        if ($smiliesallow) {
-            $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
-            for($i = 0; $i < sizeof($messagearray); $i++) {
-                if (sizeof($messagearray) != 1) {
-                    if ($i == 0) {
-                        $messagearray[$i] = $messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i == sizeof($messagearray) - 1) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i];
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i % 2 == 0) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
+        $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
+        for($i = 0; $i < sizeof($messagearray); $i++) {
+            if (sizeof($messagearray) != 1) {
+                if ($i == 0) {
+                    $messagearray[$i] = $messagearray[$i]."[code]";
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
                     }
+                } else if ($i == sizeof($messagearray) - 1) {
+                    $messagearray[$i] = "[/code]".$messagearray[$i];
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                    }
+                } else if ($i % 2 == 0) {
+                    $messagearray[$i] = "[/code]".$messagearray[$i]."[code]";
+                    if ($smiliesallow) {
+                        $messagearray[$i] = bbcode(smile($messagearray[$i]), $allowimgcode);
+                    } else {
+                        $messagearray[$i] = bbcode($messagearray[$i], $allowimgcode);
+                    }
+                }
+            } else {
+                if ($smiliesallow) {
+                    $messagearray[0] = bbcode(smile($messagearray[0]), $allowimgcode);
                 } else {
-                    $messagearray[0] = smile($messagearray[0]);
+                    $messagearray[0] = bbcode($messagearray[0], $allowimgcode);
                 }
             }
-            $message = implode("", $messagearray);
         }
 
-        $message = str_replace($find, $replace, $message);
-
-        $patterns = array();
-        $replacements = array();
-
-        $patterns[] = "#\[color=([^\"'<>]*?)\](.*?)\[/color\]#Ssi";
-        $replacements[] = '<span style="color: $1;">$2</span>';
-        $patterns[] = "#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssie";
-        $replacements[] = '"<span style=\"font-size: ".createAbsFSizeFromRel(\'$1\').";\">".stripslashes(\'$2\')."</span>"';
-        $patterns[] = "#\[font=([a-z\r\n\t 0-9]+)\](.*?)\[/font\]#Ssi";
-        $replacements[] = '<span style="font-family: $1;">$2</span>';
-        $patterns[] = "#\[align=(left|center|right|justify)\](.+?)\[/align\]#Ssi";
-        $replacements[] = '<div style="text-align: $1;">$2</div>';
-
-        if ($allowimgcode != 'no' && $allowimgcode != 'off') {
-            if (false == strpos($message, 'javascript:')) {
-                $patterns[] = '#\[img\](http[s]?|ftp[s]?){1}://([:a-z\\./_\-0-9%~]+){1}\[/img\]#Smi';
-                $replacements[] = '<img src="\1://\2\3" border="0" alt="\1://\2\3"/>';
-                $patterns[] = "#\[img=([0-9]*?){1}x([0-9]*?)\](http[s]?|ftp[s]?){1}://([:~a-z\\./0-9_\-%]+){1}(\?[a-z=0-9&_\-;~]*)?\[/img\]#Smi";
-                $replacements[] = '<img width="\1" height="\2" src="\3://\4\5" alt="\3://\4\5" border="0" />';
-                $patterns[] = "#\[flash=([0-9]*?){1}x([0-9]*?)\]([^\"'<>]*?)\[/flash\]#Ssi";
-                $replacements[] = '<object type="application/x-shockwave-flash" data="$3" width="$1" height="$2"><param name="movie" value="$3" /><param name="AllowScriptAccess" value="never" /></object>';
-            }
-        }
-
-        $message = preg_replace_callback('#(^|\s|\()((((http(s?)|ftp(s?))://)|www)[-a-z0-9.]+\.[a-z]{2,4}[^\s()]*)i?#Smi', 'fixUrl', $message);
-
-        $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]*?)\[/url\]#Smi";
-        $replacements[] = '<a href="\1\2" target="_blank">\1\2</a>';
-        $patterns[] = "#\[url\]([^\[\"'<>]*?)\[/url\]#Smi";
-        $replacements[] = '<a href="http://\1" target="_blank">\1</a>';
-        $patterns[] = "#\[url=([a-z]+?://){1}([^\"'<>\[\]]*?)\](.*?)\[/url\]#Smi";
-        $replacements[] = '<a href="\1\2" target="_blank">\3</a>';
-        $patterns[] = "#\[url=([^\[\"'<>]*?)\](.*?)\[/url\]#Smi";
-        $replacements[] = '<a href="http://\1" target="_blank">\2</a>';
-        $patterns[] = "#\[email\]([^\"'<>]*?)\[/email\]#Smi";
-        $replacements[] = '<a href="mailto:\1">\1</a>';
-        $patterns[] = "#\[email=([^\"'<>]*?){1}([^\"]*?)\](.*?)\[/email\]#Smi";
-        $replacements[] = '<a href="mailto:\1\2">\3</a>';
-
-        $message = preg_replace($patterns, $replacements, $message);
+        $message = implode("", $messagearray);
         $message = addslashes($message);
     } else {
         if ($smiliesallow) {
-            $messagearray = preg_split("/\[code\]|\[\/code\]/", $message);
-            for($i = 0; $i < sizeof($messagearray); $i++) {
-                if (sizeof($messagearray) != 1) {
-                    if ($i == 0) {
-                        $messagearray[$i] = $messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i == sizeof($messagearray) - 1) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i];
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    } else if ($i % 2 == 0) {
-                        $messagearray[$i] = "[/code]".$messagearray[$i]."[code]";
-                        $messagearray[$i] = smile($messagearray[$i]);
-                    }
-                } else {
-                    $messagearray[0] = smile($messagearray[0]);
-                }
-            }
-            $message = implode("", $messagearray);
+            smile($message);
         }
     }
 
@@ -373,10 +280,114 @@
         $message = wordwrap($message, 150, "\n", 1);
         $message = preg_replace('#(\[/?.*)\n(.*\])#mi', '\\1\\2', $message);
     }
+
     $message = preg_replace('#(script|about|applet|activex|chrome):#Sis',"\\1 &#058;",$message);
+
     return $message;
 }
 
+function bbcode($message, $allowimgcode) {
+    global $lang;
+
+    $find = array(
+        0 => '[b]',
+        1 => '[/b]',
+        2 => '[i]',
+        3 => '[/i]',
+        4 => '[u]',
+        5 => '[/u]',
+        6 => '[marquee]',
+        7 => '[/marquee]',
+        8 => '[blink]',
+        9 => '[/blink]',
+        10 => '[strike]',
+        11 => '[/strike]',
+        12 => '[quote]',
+        13 => '[/quote]',
+        14 => '[code]',
+        15 => '[/code]',
+        16 => '[list]',
+        17 => '[/list]',
+        18 => '[list=1]',
+        19 => '[list=a]',
+        20 => '[list=A]',
+        21 => '[/list=1]',
+        22 => '[/list=a]',
+        23 => '[/list=A]',
+        24 => '[*]',
+        25 => '<br />'
+    );
+
+    $replace = array(
+        0 => '<strong>',
+        1 => '</strong>',
+        2 => '<em>',
+        3 => '</em>',
+        4 => '<u>',
+        5 => '</u>',
+        6 => '<marquee>',
+        7 => '</marquee>',
+        8 => '<blink>',
+        9 => '</blink>',
+        10 => '<strike>',
+        11 => '</strike>',
+        12 => '</font><table align="center" class="quote" cellspacing="0" cellpadding="0"><tr><td class="quote">'.$lang['textquote'].'</td></tr><tr><td class="quotemessage">',
+        13 => ' </td></tr></table><font class="mediumtxt">',
+        14 => '</font><table align="center" class="code" cellspacing="0" cellpadding="0"><tr><td class="code">'.$lang['textcode'].'</td></tr><tr><td class="codemessage">',
+        15 => '</td></tr></table><font class="mediumtxt">',
+        16 => '<ul type="square">',
+        17 => '</ul>',
+        18 => '<ol type="1">',
+        19 => '<ol type="A">',
+        20 => '<ol type="A">',
+        21 => '</ol>',
+        22 => '</ol>',
+        23 => '</ol>',
+        24 => '<li />',
+        25 => '<br />'
+    );
+
+    $message = str_replace($find, $replace, $message);
+
+    $patterns = array();
+    $replacements = array();
+
+    $patterns[] = "#\[color=([^\"'<>]*?)\](.*?)\[/color\]#Ssi";
+    $replacements[] = '<span style="color: $1;">$2</span>';
+    $patterns[] = "#\[size=([+-]?[0-9]{1,2})\](.*?)\[/size\]#Ssie";
+    $replacements[] = '"<span style=\"font-size: ".createAbsFSizeFromRel(\'$1\').";\">".stripslashes(\'$2\')."</span>"';
+    $patterns[] = "#\[font=([a-z\r\n\t 0-9]+)\](.*?)\[/font\]#Ssi";
+    $replacements[] = '<span style="font-family: $1;">$2</span>';
+    $patterns[] = "#\[align=(left|center|right|justify)\](.+?)\[/align\]#Ssi";
+    $replacements[] = '<div style="text-align: $1;">$2</div>';
+
+    if ($allowimgcode != 'no' && $allowimgcode != 'off') {
+        if (false == stripos($message, 'javascript:')) {
+            $patterns[] = '#\[img\](http[s]?|ftp[s]?){1}://([:a-z\\./_\-0-9%~]+){1}\[/img\]#Smi';
+            $replacements[] = '<img src="\1://\2\3" border="0" alt="\1://\2\3"/>';
+            $patterns[] = "#\[img=([0-9]*?){1}x([0-9]*?)\](http[s]?|ftp[s]?){1}://([:~a-z\\./0-9_\-%]+){1}(\?[a-z=0-9&_\-;~]*)?\[/img\]#Smi";
+            $replacements[] = '<img width="\1" height="\2" src="\3://\4\5" alt="\3://\4\5" border="0" />';
+        }
+    }
+
+    $message = preg_replace_callback('#(^|\s|\()((((http(s?)|ftp(s?))://)|www)[-a-z0-9.]+\.[a-z]{2,4}[^\s()]*)i?#Smi', 'fixUrl', $message);
+
+    $patterns[] = "#\[url\]([a-z]+?://){1}([^\"'<>]*?)\[/url\]#Smi";
+    $replacements[] = '<a href="\1\2" target="_blank">\1\2</a>';
+    $patterns[] = "#\[url\]([^\[\"'<>]*?)\[/url\]#Smi";
+    $replacements[] = '<a href="http://\1" target="_blank">\1</a>';
+    $patterns[] = "#\[url=([a-z]+?://){1}([^\"'<>\[\]]*?)\](.*?)\[/url\]#Smi";
+    $replacements[] = '<a href="\1\2" target="_blank">\3</a>';
+    $patterns[] = "#\[url=([^\[\"'<>]*?)\](.*?)\[/url\]#Smi";
+    $replacements[] = '<a href="http://\1" target="_blank">\2</a>';
+    $patterns[] = "#\[email\]([^\"'<>]*?)\[/email\]#Smi";
+    $replacements[] = '<a href="mailto:\1">\1</a>';
+    $patterns[] = "#\[email=([^\"'<>]*?){1}([^\"]*?)\](.*?)\[/email\]#Smi";
+    $replacements[] = '<a href="mailto:\1\2">\3</a>';
+
+    return preg_replace($patterns, $replacements, $message);
+}
+
 function modcheck($status, $username, $mods) {
 
     if (X_ADMIN || in_array($status, array('Super Moderator'))) {
@@ -447,7 +458,7 @@
         $lastpost = explode('|', $forum['lastpost']);
         $dalast = $lastpost[0];
         if ($lastpost[1] != 'Anonymous' && $lastpost[1] != '') {
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         } else {
             $lastpost[1] = $lang['textanonymous'];
         }
@@ -480,7 +491,7 @@
             $moderators = explode(', ', $forum['moderator']);
             $forum['moderator'] = array();
             for($num = 0; $num < count($moderators); $num++) {
-                $forum['moderator'][] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($moderators[$num]).'">'.$moderators[$num].'</a>';
+                $forum['moderator'][] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($moderators[$num]).'">'.$moderators[$num].'</a>';
             }
             $forum['moderator'] = implode(', ', $forum['moderator']);
             $forum['moderator'] = '('.$lang['textmodby'].' '.$forum['moderator'].')';
@@ -582,8 +593,7 @@
 
     $sms = array();
     $smilienum = 0;
-    $smilies = '';
-    $smilieinsert = '';
+    $smilies = $smilieinsert = '';
 
     if ($smileyinsert == 'on' && $smcols != '') {
         if ($smtotal == 0) {
@@ -626,8 +636,7 @@
 function updateforumcount($fid) {
     global $db;
 
-    $postcount = 0;
-    $threadcount = 0;
+    $postcount = $threadcount = 0;
 
     $query = $db->query("SELECT COUNT(pid) FROM ".X_PREFIX."posts WHERE fid='$fid'");
     $postcount = $db->result($query, 0);
@@ -674,8 +683,7 @@
     static $cached;
 
     if (!$cached) {
-        $smiliecache = array();
-        $censorcache = array();
+        $smiliecache = $censorcache = array();
 
         $query = $db->query("SELECT code, url FROM ".X_PREFIX."smilies WHERE type='smiley'");
         $smiliesnum = $db->num_rows($query);
@@ -704,7 +712,9 @@
     return false;
 }
 
+/* checkInput() is deprecated */
 function checkInput($input, $striptags='no', $allowhtml='no', $word='', $no_quotes=true) {
+
     $input = trim($input);
     if ($striptags == 'yes') {
         $input = strip_tags($input);
@@ -719,18 +729,20 @@
     }
 
     if ($word != '') {
-        $input = str_replace($word, "_".$word, $input);
+        $input = str_ireplace($word, "_".$word, $input);
     }
     return $input;
 }
 
+/* checkOutput() is deprecated */
 function checkOutput($output, $allowhtml='no', $word='', $allowEntities=false) {
+
     $output = trim($output);
     if ($allowhtml == 'yes' || $allowhtml == 'on') {
         $output = htmlspecialchars_decode($output);
     }
     if ($word != '') {
-        $output = str_replace($word, "_".$word, $output);
+        $output = str_ireplace($word, "_".$word, $output);
     }
 
     if ($allowEntities) {
@@ -809,7 +821,6 @@
     } else {
         $footerstuff['querydump'] = '';
     }
-
     return $footerstuff;
 }
 
@@ -958,11 +969,11 @@
 function get_attached_file($file, $attachstatus, $max_size=1000000) {
     global $lang, $filename, $filetype, $filesize;
 
-    $filename = '';
-    $filetype = '';
+    $filename = $filetype = '';
     $filesize = 0;
 
     if ($file['name'] != 'none' && !empty($file['name']) && $attachstatus != 'off' && is_uploaded_file($file['tmp_name'])) {
+        $file['name'] = trim($file['name']);
         if (!isValidFilename($file['name'])) {
             error($lang['invalidFilename'], false, '', '', false, false, false, false);
             return false;
@@ -974,9 +985,8 @@
             return false;
         } else {
             $attachment = addslashes(fread(fopen($file['tmp_name'], 'rb'), filesize($file['tmp_name'])));
-            $filename = $file['name'];
-            $filetype = $file['type'];
-            $filesize = $file['size'];
+            $filename = addslashes($file['name']);
+            $filetype = addslashes(preg_replace('#[\r\n%]#', '', $file['type']));
 
             if ($filesize == 0) {
                 return false;
@@ -1137,8 +1147,7 @@
 function mysql_syn_highlight($query) {
     global $tables, $tablepre;
 
-    $find = array();
-    $replace = array();
+    $find = $replace = array();
 
     foreach($tables as $name) {
         $find[] = $tablepre.$name;
@@ -1393,7 +1402,7 @@
 }
 
 function printGmTime($timestamp=null, $altFormat=null, $altOffset=0) {
-    global $self, $SETTINGS, $timeoffset, $addtime;
+    global $self, $SETTINGS, $timeoffset, $addtime, $timecode;
 
     if ($timestamp === null) {
         $timestamp = time();
@@ -1520,7 +1529,7 @@
     if ($restrict != '') {
         $sql = $db->query("SELECT fid, type, name, fup, status, private, userlist, password FROM ".X_PREFIX."forums WHERE $restrict AND status='on' ORDER BY displayorder");
     } else {
-        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password FROM ".X_PREFIX."forums ORDER BY displayorder");
+        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password FROM ".X_PREFIX."forums WHERE status='on' ORDER BY displayorder");
     }
 
     $standAloneForums = array();
@@ -1644,7 +1653,7 @@
     if ($restrict != '') {
         $sql = $db->query("SELECT fid, type, name, fup, status, private, userlist, password, displayorder FROM ".X_PREFIX."forums WHERE $restrict AND status='on' ORDER BY displayorder");
     } else {
-        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password, displayorder FROM ".X_PREFIX."forums ORDER BY displayorder");
+        $sql = $db->query("SELECT fid, type, name, fup, private, userlist, password, displayorder FROM ".X_PREFIX."forums WHERE status='on' ORDER BY displayorder");
     }
 
     $standAloneForums = array();
@@ -1719,4 +1728,4 @@
     $forumselect[] = '</select>';
     return implode("\n", $forumselect);
 }
-?>
\ No newline at end of file
+?>
Index: include/global.inc.php
===================================================================
--- include/global.inc.php	(revision 761)
+++ include/global.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -30,7 +30,7 @@
     exit("Not allowed to run this file directly.");
 }
 
-// This makes XMB compatible with the latest PHP changes (4.2.*) (mainly 4.2.1 and 4.2.2)
+// This is an old compatibility trick, kept in case superglobals are disabled.
 if (!isset($_SERVER)) {
     $_GET = &$HTTP_GET_VARS;
     $_POST = &$HTTP_POST_VARS;
@@ -41,37 +41,15 @@
     $_REQUEST = array_merge($_GET, $_POST, $_COOKIE);
 }
 
-$global = @array(0 => $_GET, 1 => $_POST, 2 => $_ENV, 3=> $_COOKIE, 4=> $_SESSION, 5 => $_SERVER, 6 => $_FILES, 7 => &$_REQUEST);
+$global = @array(0 => $_REQUEST, 1 => $_FILES, 2 => $_SERVER, 3 => $_SESSION, 4 => $_ENV);
 
 // make sure magic_quotes_runtime doesn't kill XMB
 @set_magic_quotes_runtime(0);
-if (get_magic_quotes_gpc() === 0) {
-    foreach($global as $keyg => $valg) {
-        if (is_array($valg)) {
-            foreach($valg as $keya => $vala) {
-                if (is_array($vala)) {
-                    foreach($vala as $keyv => $valv) {
-                        if (gettype($valv) == "string") {
-                            $global[$keyg][$keya][$keyv] = addslashes($valv);
-                        }
-                    }
-                } else if (gettype($vala) == "string") {
-                    $global[$keyg][$keya] = addslashes($vala);
-                }
-            }
-        }
-    }
 
-    foreach($global as $num => $array) {
-        if (is_array($array)) {
-            extract($array, EXTR_OVERWRITE);
-        }
+// force registerglobals
+foreach($global as $num => $array) {
+    if (is_array($array)) {
+        extract($array, EXTR_SKIP);
     }
-} else {
-    foreach($global as $num => $array) {
-        if (is_array($array)) {
-            extract($array, EXTR_OVERWRITE);
-        }
-    }
 }
 ?>
\ No newline at end of file
Index: include/online.inc.php
===================================================================
--- include/online.inc.php	(revision 761)
+++ include/online.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
Index: include/smtp.inc.php
===================================================================
--- include/smtp.inc.php	(revision 761)
+++ include/smtp.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
Index: include/spelling.inc.php
===================================================================
--- include/spelling.inc.php	(revision 761)
+++ include/spelling.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -44,7 +44,10 @@
 
         $charset = '';
         $this->language = $language;
-        $this->link = pspell_new($language, '', '', $charset, $mode);
+        @$this->link = pspell_new($language, '', '', $charset, $mode);
+        if ($this->link === FALSE) {
+            error('Failed to open the spelling dictionary for language "'.htmlspecialchars($language, ENT_QUOTES).'"');
+        }
         $this->mode = $mode;
         return true;
     }
Index: include/topicadmin.inc.php
===================================================================
--- include/topicadmin.inc.php	(revision 761)
+++ include/topicadmin.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -35,7 +35,6 @@
         global $self, $xmbuser, $xmbpw, $lang, $action, $oToken;
 
         if (!X_STAFF && $action != 'votepoll' && $action != 'report') {
-            extract($GLOBALS);
             error($lang['notpermitted'], false);
         }
     }
@@ -52,7 +51,6 @@
         }
 
         if ($status1 != 'Moderator') {
-            extract($GLOBALS);
             error($lang['textnoaction'], false);
         }
     }
@@ -94,4 +92,4 @@
         return $tidArr;
     }
 }
-?>
\ No newline at end of file
+?>
Index: include/u2u.inc.php
===================================================================
--- include/u2u.inc.php	(revision 761)
+++ include/u2u.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -31,7 +31,7 @@
 }
 
 function u2u_msg($msg, $redirect) {
-    global $u2uheader, $u2ufooter, $tablewidth, $bordercolor, $tablespace, $borderwidth, $altbg1;
+    global $u2uheader, $u2ufooter, $tablewidth, $bordercolor, $tablespace, $THEME, $altbg1;
 
     if (!empty($redirect)) {
         redirect($redirect);
@@ -43,9 +43,9 @@
 function db_u2u_insert($to, $from, $type, $owner, $folder, $subject, $message, $isRead, $isSent) {
     global $db, $onlinetime, $oToken;
 
-    $subject = checkInput(censor(addslashes($subject)));
-    $message = checkInput(censor(addslashes($message)));
-    $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('".addslashes($to)."', '".addslashes($from)."', '$type', '".addslashes($owner)."', '$folder', '$subject', '$message', '$onlinetime', '$isRead', '$isSent')");
+    $subject = censor($subject);
+    $message = censor($message);
+    $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$to', '$from', '$type', '$owner', '$folder', '$subject', '$message', '$onlinetime', '$isRead', '$isSent')");
 }
 
 function u2u_send_multi_recp($msgto, $subject, $message, $u2uid=0) {
@@ -59,7 +59,7 @@
 }
 
 function u2u_send_recp($msgto, $subject, $message, $u2uid=0) {
-    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $del, $oToken;
+    global $db, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $del, $oToken, $xmbuser;
 
     $del = ('yes' === $del) ? 'yes' : 'no';
     $errors = '';
@@ -69,21 +69,22 @@
         $ilist = array_map('trim', explode(',', $rcpt['ignoreu2u']));
         if (!in_array($self['username'], $ilist) || X_ADMIN) {
             $username = $rcpt['username'];
-            db_u2u_insert($username, $self['username'], 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes');
+            db_u2u_insert($username, $xmbuser, 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes');
             if ($self['saveogu2u'] == 'yes') {
-                db_u2u_insert($username, $self['username'], 'outgoing', $self['username'], 'Outbox', $subject, $message, 'no', 'yes');
+                db_u2u_insert($username, $xmbuser, 'outgoing', $xmbuser, 'Outbox', $subject, $message, 'no', 'yes');
             }
 
             $u2uid = (int) $u2uid;
             if ($del == 'yes' && $u2uid > 0){
-                   $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$self[username]'");
+                   $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
             }
 
             if ($rcpt['emailonu2u'] == 'yes' && $rcpt['status'] != 'Banned') {
                 $lastvisitcheck = $onlinetime - 600;
                 if ($lastvisitcheck > $rcpt['lastvisit']) {
                     $u2uurl = $SETTINGS['boardurl'] . 'u2u.php';
-                    altMail($rcpt['email'], "$lang[textnewu2uemail]", "$self[username] $lang[textnewu2ubody] \n$u2uurl", "From: $bbname <$adminemail>");
+                    $rawusername = htmlspecialchars_decode($self['username'], ENT_QUOTES);
+                    altMail($rcpt['email'], "$lang[textnewu2uemail]", "$rawusername $lang[textnewu2ubody] \n$u2uurl", "From: $bbname <$adminemail>");
                 }
             }
         } else {
@@ -97,16 +98,14 @@
 }
 
 function u2u_send($u2uid, $msgto, $subject, $message, $u2upreview) {
-    global $db, $self, $lang, $username, $SETTINGS, $del;
+    global $db, $self, $lang, $xmbuser, $SETTINGS, $del;
     global $u2uheader, $u2ufooter, $u2ucount, $u2uquota, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $cattext, $thewidth;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
     global $forward, $reply, $sendsubmit, $savesubmit, $previewsubmit;
 
     $leftpane = '';
     $del = ($del == 'yes') ? 'yes' : 'no';
-    $msgto = checkInput($msgto, '', '', 'script', false);
-    $subject = strip_tags($subject);
-    $username = checkInput($username, '', '', 'script', false);
+    $username = postedVar('username', 'javascript', TRUE, FALSE, TRUE, 'g'); //username is the param from u2u links on profiles.
 
     if ($self['ban'] == 'u2u' || $self['ban'] == 'both') {
         error($lang['textbanfromu2u'], false, $u2uheader, $u2ufooter, false, true, false, false);
@@ -121,7 +120,7 @@
         if (empty($subject) || empty($message)) {
             error($lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
-        db_u2u_insert('', '', 'draft', $self['username'], 'Drafts', $subject, $message, 'yes', 'no');
+        db_u2u_insert('', '', 'draft', $xmbuser, 'Drafts', $subject, $message, 'yes', 'no');
         u2u_msg($lang['imsavedmsg'], "u2u.php?folder=Drafts");
     }
 
@@ -132,7 +131,7 @@
             error($lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
 
-        if ($db->result($db->query("SELECT count(u2uid) FROM ".X_PREFIX."u2u WHERE msgfrom='$self[username]' AND dateline > ".(time()-$SETTINGS['floodctrl'])), 0) > 0) {
+        if ($db->result($db->query("SELECT count(u2uid) FROM ".X_PREFIX."u2u WHERE msgfrom='$xmbuser' AND dateline > ".(time()-$SETTINGS['floodctrl'])), 0) > 0) {
             error($lang['floodprotect_u2u'], false, $u2uheader, $u2ufooter, false, true, false, false);
         }
 
@@ -151,14 +150,17 @@
         }
     }
 
+    $subject = stripslashes($subject);
+    $message = stripslashes($message);
+
     if ($u2uid > 0) {
-        $query = $db->query("SELECT subject, msgfrom, message FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $query = $db->query("SELECT subject, msgfrom, message FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
         $quote = $db->fetch_array($query);
         if ($quote) {
             if (!isset($previewsubmit)) {
                 $prefixes = array($lang['textre'], $lang['textfwd']);
-                $subject = trim(stripslashes(str_replace($prefixes, '', $quote['subject'])));
-                $message = trim(stripslashes($quote['message']));
+                $subject = str_replace($prefixes, '', $quote['subject']);
+                $message = $quote['message'];
                 if ($forward == 'yes') {
                     $subject = $lang['textfwd'].' '.$subject;
                     $message = '[quote][i]'.$lang['origpostedby'].' '.$quote['msgfrom']."[/i]\n".$message.'[/quote]';
@@ -173,13 +175,11 @@
     }
 
     if (isset($previewsubmit)) {
-        $u2usubject = html_entity_decode(checkOutput(censor(checkInput(stripslashes($subject)))));
-        $u2umessage = checkOutput(censor(checkInput(stripslashes($message))));
+        $u2usubject = censor($subject);
+        $u2umessage = censor($message);
         $u2umessage = postify($u2umessage, "no", "", "yes", "no");
-        $username = htmlspecialchars($msgto);
-        $subject = html_entity_decode(htmlspecialchars($subject));
-        $message = html_entity_decode(htmlspecialchars($message));
         eval('$u2upreview = "'.template('u2u_send_preview').'";');
+        $username = $msgto;
     }
 
     eval('$leftpane = "'.template('u2u_send').'";');
@@ -187,12 +187,11 @@
 }
 
 function u2u_view($u2uid, $folders) {
-    global $db, $dateformat, $timecode, $timeoffset, $addtime, $lang, $self, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $cattext, $thewidth;
+    global $db, $dateformat, $timecode, $timeoffset, $addtime, $lang, $self, $oToken, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $cattext, $thewidth;
     global $sendoptions, $u2uheader, $u2ufooter;
 
-    $delchecked = '';
-    $leftpane = '';
+    $delchecked = $leftpane = '';
 
     $u2uid = (int) $u2uid;
 
@@ -201,11 +200,11 @@
         return;
     }
 
-    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     $u2u = $db->fetch_array($query);
     if ($u2u) {
         if ($u2u['type'] == 'incoming') {
-            $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid] OR (u2uid=$u2u[u2uid]+1 AND type='outgoing' AND msgto='$self[username]')");
+            $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid] OR (u2uid=$u2u[u2uid]+1 AND type='outgoing' AND msgto='$xmbuser')");
         } else if ($u2u['type'] == 'draft') {
             $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='yes' WHERE u2uid=$u2u[u2uid]");
         }
@@ -214,11 +213,11 @@
         $u2udate = gmdate($dateformat, $u2u['dateline'] + $adjTime);
         $u2utime = gmdate($timecode, $u2u['dateline'] + $adjTime);
         $u2udateline = $u2udate.' '.$lang['textat'].' '.$u2utime;
-        $u2usubject = html_entity_decode(checkOutput(censor($u2u['subject'])));
-        $u2umessage = html_entity_decode(checkOutput(postify($u2u['message'], 'no', '', 'yes', 'no')));
+        $u2usubject = censor($u2u['subject']);
+        $u2umessage = postify($u2u['message'], 'no', '', 'yes', 'no');
         $u2ufolder = $u2u['folder'];
-        $u2ufrom = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgfrom']).'" target="mainwindow">'.$u2u['msgfrom'].'</a>';
-        $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgto']).'" target="mainwindow">'.$u2u['msgto'].'</a>';
+        $u2ufrom = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgfrom']).'" target="mainwindow">'.$u2u['msgfrom'].'</a>';
+        $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgto']).'" target="mainwindow">'.$u2u['msgto'].'</a>';
         if ($u2u['type'] == 'draft') {
             $sendoptions = '<input type="radio" name="mod" value="send" /> '.$lang['textu2u'].'<br />';
             $delchecked = ' checked="checked"';
@@ -247,7 +246,7 @@
 }
 
 function u2u_print($u2uid, $eMail = false) {
-    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken;
+    global $SETTINGS, $css, $db, $self, $timeoffset, $lang, $u2uheader, $u2ufooter, $dateformat, $timecode, $addtime, $charset, $bbname, $logo, $oToken, $xmbuser;
     $mailHeader = $mailFooter = '';
 
     $u2uid = (int) $u2uid;
@@ -257,7 +256,7 @@
         return;
     }
 
-    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+    $query = $db->query("SELECT * FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     $u2u = $db->fetch_array($query);
     $db->free_result($query);
     if ($u2u) {
@@ -265,8 +264,8 @@
         $u2udate = gmdate($dateformat, $u2u['dateline'] +  $adjTime);
         $u2utime = gmdate($timecode, $u2u['dateline'] + $adjTime);
         $u2udateline = "$u2udate $lang[textat] $u2utime";
-        $u2usubject = html_entity_decode(stripslashes(checkOutput(censor($u2u['subject']))));
-        $u2umessage = postify(html_entity_decode(stripslashes($u2u['message'])), 'no', 'no', 'yes', 'no', 'yes', 'yes', false, "no", "yes");;
+        $u2usubject = censor($u2u['subject']);
+        $u2umessage = postify($u2u['message'], 'no', 'no', 'yes', 'no', 'yes', 'yes', false, "no", "yes");
         $u2ufolder = $u2u['folder'];
         $u2ufrom = $u2u['msgfrom'];
         $u2uto = ($u2u['type'] == 'draft') ? $lang['textu2unotsent'] : $u2u['msgto'];
@@ -287,7 +286,7 @@
 }
 
 function u2u_delete($u2uid, $folder) {
-    global $db, $self, $lang;
+    global $db, $self, $lang, $xmbuser;
     global $u2uheader, $u2ufooter, $oToken;
 
     $u2uid = (int) $u2uid;
@@ -298,15 +297,15 @@
     }
 
     if ($folder == "Trash") {
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     } else {
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
     }
     u2u_msg($lang['imdeletedmsg'], 'u2u.php?folder='.$folder);
 }
 
 function u2u_mod_delete($folder, $u2u_select) {
-    global $db, $self, $lang, $oToken;
+    global $db, $self, $lang, $oToken, $xmbuser;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -315,15 +314,15 @@
     }
 
     if ($folder == "Trash") {
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid IN($in) AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE u2uid IN($in) AND owner='$xmbuser'");
     } else {
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid IN($in) AND owner='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='Trash' WHERE u2uid IN($in) AND owner='$xmbuser'");
     }
     u2u_msg($lang['imdeletedmsg'], "u2u.php?folder=$folder");
 }
 
 function u2u_move($u2uid, $tofolder) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $type, $folder, $oToken, $xmbuser;
 
     $u2uid = (int) $u2uid;
 
@@ -338,13 +337,13 @@
         if (!(in_array($tofolder, $folders) || $tofolder == 'Inbox' || $tofolder == 'Outbox' || $tofolder == 'Drafts') || ($tofolder == 'Inbox' && ($type == 'draft' || $type == 'outgoing')) || ($tofolder == 'Outbox' && ($type == 'incoming' || $type == 'draft')) || ($tofolder == 'Drafts' && ($type == 'incoming' || $type == 'outgoing'))) {
             error($lang['textcantmove'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
         }
-        $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid='$u2uid' AND owner='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid='$u2uid' AND owner='$xmbuser'");
         u2u_msg($lang['textmovesucc'], "u2u.php?folder=$folder");
     }
 }
 
 function u2u_mod_move($tofolder, $u2u_select) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $folders, $oToken, $folder, $xmbuser;
 
     $in = '';
     foreach($u2u_select as $value) {
@@ -361,12 +360,12 @@
         error($lang['textcantmove'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
         return;
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid IN($in) AND owner='$self[username]'");
+    $db->query("UPDATE ".X_PREFIX."u2u SET folder='$tofolder' WHERE u2uid IN($in) AND owner='$xmbuser'");
     u2u_msg($lang['textmovesucc'], "u2u.php?folder=$folder");
 }
 
 function u2u_markUnread($u2uid, $folder, $type) {
-    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken;
+    global $db, $self, $lang, $u2uheader, $u2ufooter, $oToken, $xmbuser;
 
     $u2uid = (int) $u2uid;
 
@@ -383,12 +382,12 @@
     if ($type == 'outgoing') {
         error($lang['textnomur'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid=$u2uid AND owner='$self[username]'");
+    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid=$u2uid AND owner='$xmbuser'");
     u2u_msg($lang['textmarkedunread'], "u2u.php?folder=$folder");
 }
 
 function u2u_mod_markUnread($folder, $u2u_select) {
-    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken;
+    global $db, $lang, $u2uheader, $u2ufooter, $self, $oToken, $xmbuser;
 
     if (empty($folder)) {
         error($lang['textnofolder'], false, $u2uheader, $u2ufooter, "u2u.php?action=view&amp;u2uid=$u2uid", true, false, false);
@@ -414,12 +413,12 @@
     if (empty($in)) {
         error($lang['textnonechosen'], false, $u2uheader, $u2ufooter, "u2u.php?folder=$folder", true, false, false);
     }
-    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid IN($in) AND owner='$self[username]'");
+    $db->query("UPDATE ".X_PREFIX."u2u SET readstatus='no' WHERE u2uid IN($in) AND owner='$xmbuser'");
     u2u_msg($lang['textmarkedunread'], "u2u.php?folder=$folder");
 }
 
 function u2u_folderSubmit($u2ufolders, $folders) {
-    global $db, $lang, $self, $farray, $oToken;
+    global $db, $lang, $self, $farray, $oToken, $xmbuser;
 
     $error = '';
 
@@ -438,18 +437,18 @@
         }
     }
     $u2ufolders = checkInput(implode(', ', $newfolders));
-    $db->query("UPDATE ".X_PREFIX."members SET u2ufolders='$u2ufolders' WHERE username='$self[username]'");
+    $db->query("UPDATE ".X_PREFIX."members SET u2ufolders='$u2ufolders' WHERE username='$xmbuser'");
     u2u_msg($lang['foldersupdate'].$error, "u2u.php?folder=Inbox");
 }
 
 function u2u_ignore() {
-    global $ignorelist, $ignoresubmit, $self, $lang, $db, $oToken;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $thewidth;
+    global $ignorelist, $ignoresubmit, $self, $lang, $db, $oToken, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $thewidth;
 
     $leftpane = '';
     if (isset($ignoresubmit) && isset($ignorelist)) {
         $self['ignoreu2u'] = htmlspecialchars(checkInput($ignorelist));
-        $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='" . $self['ignoreu2u'] . "' WHERE username='$self[username]'");
+        $db->query("UPDATE ".X_PREFIX."members SET ignoreu2u='" . $self['ignoreu2u'] . "' WHERE username='$xmbuser'");
         u2u_msg($lang['ignoreupdate'], "u2u.php?action=ignore");
     } else {
         $self['ignoreu2u'] = checkOutput($self['ignoreu2u']);
@@ -459,20 +458,17 @@
 }
 
 function u2u_display($folder, $folders) {
-    global $db, $self, $lang;
-    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $tablewidth, $cattext, $thewidth;
+    global $db, $self, $lang, $xmbuser;
+    global $altbg1, $altbg2, $bordercolor, $THEME, $tablespace, $tablewidth, $cattext, $thewidth;
     global $addtime, $timeoffset, $dateformat, $timecode, $oToken;
 
-    $u2usin = '';
-    $u2usout = '';
-    $u2usdraft = '';
-    $leftpane = '';
+    $u2usin = $u2usout = $u2usdraft = $leftpane = '';
 
     if (empty($folder)) {
         $folder = "Inbox";
     }
 
-    $query = $db->query("SELECT u.*, w.username, w.invisible FROM ".X_PREFIX."u2u u LEFT JOIN ".X_PREFIX."whosonline w ON (u.msgto=w.username OR u.msgfrom=w.username) AND w.username!='$self[username]' WHERE u.folder='$folder' AND u.owner='$self[username]' ORDER BY dateline DESC");
+    $query = $db->query("SELECT u.*, w.username, w.invisible FROM ".X_PREFIX."u2u u LEFT JOIN ".X_PREFIX."whosonline w ON (u.msgto=w.username OR u.msgfrom=w.username) AND w.username!='$xmbuser' WHERE u.folder='$folder' AND u.owner='$xmbuser' ORDER BY dateline DESC");
     while($u2u = $db->fetch_array($query)) {
         if ($u2u['readstatus'] == 'yes') {
             $u2ureadstatus = $lang['textread'];
@@ -482,11 +478,9 @@
 
         if (empty($u2u['subject'])) {
             $u2u['subject'] = '&laquo;'.$lang['textnosub'].'&raquo;';
-        } else {
-            $u2u['subject'] = html_entity_decode($u2u['subject']);
         }
 
-        $u2usubject = checkOutput(censor($u2u['subject']));
+        $u2usubject = censor($u2u['subject']);
         if ($u2u['type'] == 'incoming') {
             if ($u2u['msgfrom'] == $u2u['username'] || $u2u['msgfrom'] == $self['username']) {
                 if ($u2u['invisible'] == 1) {
@@ -501,7 +495,7 @@
             } else {
                 $online = $lang['textoffline'];
             }
-            $u2usent = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgfrom']).'" target="_blank">'.$u2u['msgfrom'].'</a> ('.$online.')';
+            $u2usent = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgfrom']).'"target="_blank">'.$u2u['msgfrom'].'</a> ('.$online.')';
         } else if ($u2u['type'] == 'outgoing') {
             if ($u2u['msgto'] == $u2u['username'] || $u2u['msgto'] == $self['username']) {
                 if ($u2u['invisible'] == 1) {
@@ -516,7 +510,7 @@
             } else {
                 $online = $lang['textoffline'];
             }
-            $u2usent = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($u2u['msgto']).'" target="_blank">'.$u2u['msgto'].'</a> ('.$online.')';
+            $u2usent = '<a href="member.php?action=viewpro&amp;member='.recodeOut($u2u['msgto']).'"target="_blank">'.$u2u['msgto'].'</a> ('.$online.')';
         } else if ($u2u['type'] == 'draft') {
             $u2usent = $lang['textu2unotsent'];
         }
@@ -584,7 +578,7 @@
 }
 
 function u2u_folderList() {
-    global $db, $self, $lang, $altbg1, $oToken;
+    global $db, $self, $lang, $altbg1, $oToken, $xmbuser;
     global $folder, $folderlist, $folders, $farray; // <--- these are modified in here
 
     $u2ucount = 0;
@@ -595,7 +589,7 @@
     sort($folders);
     $folders = array_merge(array('Inbox' => $lang['textu2uinbox'], 'Outbox' => $lang['textu2uoutbox']), $folders, array('Drafts' => $lang['textu2udrafts'], 'Trash' => $lang['textu2utrash']));
 
-    $query = $db->query("SELECT folder, count(u2uid) as count FROM ".X_PREFIX."u2u WHERE owner='$self[username]' GROUP BY folder ORDER BY folder ASC");
+    $query = $db->query("SELECT folder, count(u2uid) as count FROM ".X_PREFIX."u2u WHERE owner='$xmbuser' GROUP BY folder ORDER BY folder ASC");
     $flist = array();
     while($flist = $db->fetch_array($query)) {
         $farray[$flist['folder']] = $flist['count'];
@@ -624,4 +618,4 @@
     }
     return $u2ucount;
 }
-?>
\ No newline at end of file
+?>
Index: include/validate.inc.php
===================================================================
--- include/validate.inc.php	(revision 761)
+++ include/validate.inc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -141,8 +141,7 @@
             break;
         }
 
-        $user = '';
-        $domain = '';
+        $user = $domain = '';
         list($user, $domain) = split('@', $addr);
 
         // Check if the site has an MX record. We can't send unless there is.
@@ -188,6 +187,7 @@
 * @param   boolean   $quotes   do a htmlspecialchars to sanitize input for XSS
 * @return   string   the "safe" string if the variable is available, empty otherwise
 */
+/* formVar() is deprecated */
 function formVar($varname, $striptags = true, $quotes = false) {
     $retval = '';
     if (isset($_POST[$varname]) && $_POST[$varname] !== '') {
@@ -205,6 +205,141 @@
     return $retval;
 }
 
+// postedVar is an all-purpose function for retrieving and sanitizing user input.
+// This is the preferred function as of version 1.9.8 SP3.
+function postedVar($varname, $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE, $sourcearray='p') {
+    $foundvar = FALSE;
+    switch ($sourcearray) {
+        case 'p':
+            if (isset($_POST[$varname])) {
+                $retval = $_POST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'g':
+            if (isset($_GET[$varname])) {
+                $retval = $_GET[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'c':
+            if (isset($_COOKIE[$varname])) {
+                $retval = $_COOKIE[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'r':
+        default:
+            if (isset($_REQUEST[$varname])) {
+                $retval = $_REQUEST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+    }
+    if ($foundvar) {
+        if (get_magic_quotes_gpc()) {
+            $retval = stripslashes($retval);
+        }
+        if ($word != '') {
+            $retval = str_ireplace($word, "_".$word, $retval);
+        }
+        if ($htmlencode) {
+            if ($quoteencode) {
+                $retval = htmlspecialchars($retval, ENT_QUOTES);
+            } else {
+                $retval = htmlspecialchars($retval, ENT_NOQUOTES);
+            }
+        }
+        if ($dbescape) {
+            $retval = $GLOBALS['db']->escape($retval);
+        }
+    } else {
+        $retval = '';
+    }
+    return $retval;
+}
+
+function postedArray($varname, $type = 'string', $word='', $htmlencode=TRUE, $dbescape=TRUE, $quoteencode=FALSE) {
+    $arrayItems = array();
+    // Convert a single or comma delimited list to an array
+    if (isset($_POST[$varname]) && !is_array($_POST[$varname])) {
+        if (strpos($_POST[$varname], ',') !== false) {
+            $_POST[$varname] = explode(',', $_POST[$varname]);
+        } else {
+            $_POST[$varname] = array($_POST[$varname]);
+        }
+    }
+
+    if (isset($_POST[$varname]) && is_array($_POST[$varname]) && count($_POST[$varname]) > 0) {
+        $arrayItems = $_POST[$varname];
+        foreach($arrayItems as $item => $theObject) {
+            $theObject = & $arrayItems[$item];
+            switch($type) {
+                case 'int':
+                    $theObject = intval($theObject);
+                    break;
+                case 'string':
+                default:
+                    if (get_magic_quotes_gpc()) {
+                        $theObject = stripslashes($theObject);
+                    }
+                    
+                    if ($word != '') {
+                        $theObject = str_ireplace($word, "_".$word, $theObject);
+                    }
+                    
+                    if ($htmlencode) {
+                        if ($quoteencode) {
+                            $theObject = htmlspecialchars($theObject, ENT_QUOTES);
+                        } else {
+                            $theObject = htmlspecialchars($theObject, ENT_NOQUOTES);
+                        }
+                    }
+                    
+                    if ($dbescape) {
+                        $theObject = $GLOBALS['db']->escape($theObject);
+                    }
+                    break;
+            }
+            unset($theObject);
+        }
+   }
+   return $arrayItems;
+}
+
+function recodeOut($rawstring) {
+    return rawurlencode(htmlspecialchars_decode($rawstring, ENT_QUOTES));
+}
+
+function cdataOut($rawstring) {
+    return htmlspecialchars($rawstring, ENT_NOQUOTES);
+}
+
+function attrOut($rawstring, $word='') { //Never safe for STYLE attributes.
+    $retval = $rawstring;
+    if ($word != '') {
+        $retval = str_ireplace($word, "_".$word, $retval);
+    }
+    return htmlspecialchars($retval, ENT_QUOTES);
+}
+
+if (!function_exists('stripos')) {
+    function stripos($haystack, $needle, $offset = 0) {
+        return strpos(strtolower($haystack), strtolower($needle), $offset);
+    }
+}
+
+if (!function_exists('str_ireplace')) {
+    function str_ireplace($search, $replace, $subject) {
+        $ipos = 0;
+        while (($ipos = stripos($subject, $search, $ipos)) !== FALSE) {
+            $subject = substr($subject, 0, $ipos).$replace.substr($subject, $ipos + strlen($search));
+            $ipos += strlen($replace);
+        }
+        return $subject;
+    }
+}
+
 /**
 * Retrieve the contents of an array from a POST
 *
@@ -221,6 +356,7 @@
 * @param   string   $type   'string' or 'int' to specify what needs to be done to the values
 * @return   array   the array found for $varname, empty otherwise
 */
+/* formArray() is deprecated */
 function formArray($varname, $striptags = true, $quotes = false, $type = 'string') {
     $arrayItems = array();
     // Convert a single or comma delimited list to an array
@@ -259,39 +395,45 @@
 }
 
 /**
-* Retrieve a GET variable and sanitize it
+* Retrieve a gpc integer and sanitize it
 *
-* @param   string   $varname   name of the variable in $_GET
-* @param   boolean   $striptags   do a striptags to remove HTML tags
-* @param   boolean   $quotes   do a htmlspecialchars to sanitize input for XSS
-* @return   string   the "safe" string if the variable is available, empty otherwise
-*/
-function getVar($varname, $striptags = true, $quotes = true) {
-    $retval = '';
-    if (isset($_GET[$varname]) && $_GET[$varname] !== '') {
-        $retval = urldecode(trim($_GET[$varname]));
-        if ($striptags) {
-            $retval = strip_tags($retval);
-        }
-
-        if ($quotes) {
-            $retval = htmlspecialchars($retval, ENT_QUOTES);
-        }
-    }
-    return $retval;
-}
-
-/**
-* Retrieve a GET integer and sanitize it
-*
-* @param   string   $varname   name of the variable in $_GET
+* @param   string   $varname   name of the variable in a superglobal array such as $_GET
+* @param   string   $sourcearray   abbreviation of the superglobal name, g for $_GET by default
 * @return   integer   the "safe" integer if the variable is available, zero otherwise
 */
-function getInt($varname) {
+function getInt($varname, $sourcearray='g') {
     $retval = 0;
-    if (isset($_GET[$varname]) && is_numeric($_GET[$varname])) {
-        $retval = (int) $_GET[$varname];
+    $foundvar = FALSE;
+    switch ($sourcearray) {
+        case 'g':
+            if (isset($_GET[$varname])) {
+                $retval = $_GET[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'p':
+            if (isset($_POST[$varname])) {
+                $retval = $_POST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'c':
+            if (isset($_COOKIE[$varname])) {
+                $retval = $_COOKIE[$varname];
+                $foundvar = TRUE;
+            }
+            break;
+        case 'r':
+        default:
+            if (isset($_REQUEST[$varname])) {
+                $retval = $_REQUEST[$varname];
+                $foundvar = TRUE;
+            }
+            break;
     }
+    if ($foundvar And is_numeric($retval)) {
+        $retval = intval($retval);
+    }
     return $retval;
 }
 
@@ -316,7 +458,15 @@
 * @return   mixed   the value of $varname, false otherwise
 */
 function getRequestVar($varname) {
-    return (isset($_REQUEST[$varname])) ? $_REQUEST[$varname] : false;
+    if (isset($_REQUEST[$varname])) {
+        if (get_magic_quotes_gpc()) {
+            return $_REQUEST[$varname];
+        } else {
+            return addslashes($_REQUEST[$varname]);
+        }
+    } else {
+        return FALSE;
+    }
 }
 
 /**
@@ -355,34 +505,22 @@
         return false;
     }
 
-    $retval = $_POST[$varname];
+    $retval = array();
+    $formval = $_POST[$varname];
+
     if ($doCount) {
         if (count($retval) == 1) {
             $retval = array($retval);
         }
     }
 
-    foreach($retval as $bits => $value) {
-        $value = intval($value);
+    foreach($formval as $value) {
+        $retval[] = intval($value);
     }
     return $retval;
 }
 
 /**
-* Sanitizes a integer
-*
-* @param   string   $varname   name of the variable
-* @return   integer   the "safe" integer if available, zero otherwise
-*/
-function valInt($varname) {
-    $retval = 0;
-    if (isset($varname) && is_numeric($varname)) {
-        $retval = (int) $varname;
-    }
-    return $retval;
-}
-
-/**
 * Retrieve a POST variable and check it for on value
 *
 * @param   string   $varname   name of the variable in $_POST
@@ -510,6 +648,6 @@
 }
 
 function isValidFilename($filename) {
-    return preg_match('#^[^:\\/?*<>|]+$#', trim($filename));
+    return preg_match("#^[\\w\\^\\-\\#\\] `~!@$&()_+=[{};',.]*$#", trim($filename));
 }
-?>
\ No newline at end of file
+?>
Index: index.php
===================================================================
--- index.php	(revision 761)
+++ index.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'index.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -101,7 +103,7 @@
     }
     $db->free_result($query);
 
-    $memhtml = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastmember['username']).'"><strong>'.$lastmember['username'].'</strong></a>.';
+    $memhtml = '<a href="member.php?action=viewpro&amp;member='.recodeOut($lastmember['username']).'"><strong>'.$lastmember['username'].'</strong></a>.';
     eval($lang['evalindexstats']);
     eval('$statsbar = "'.template('index_stats').'";');
 }
@@ -187,7 +189,7 @@
                 $show_inv_key = true;
             }
 
-            $memtally[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($online['username']).'">'.$pre.''.$online['username'].''.$suff.'</a>';
+            $memtally[] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($online['username']).'">'.$pre.''.$online['username'].''.$suff.'</a>';
             $num++;
         }
 
@@ -206,19 +208,24 @@
         if ($SETTINGS['onlinetoday_status'] == 'on') {
             $datecut = $onlinetime - (3600 * 24);
             if (X_ADMIN) {
-                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' ORDER BY lastvisit DESC LIMIT 0, $onlinetodaycount");
+                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' ORDER BY lastvisit DESC");
             } else {
-                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' AND invisible!=1 ORDER BY lastvisit DESC LIMIT 0, $onlinetodaycount");
+                $query = $db->query("SELECT username, status FROM ".X_PREFIX."members WHERE lastvisit >= '$datecut' AND invisible!=1 ORDER BY lastvisit DESC");
             }
 
-            $todaymembersnum = 0;
+            $todaymembersnum = $db->num_rows($query);
             $todaymembers = array();
             $pre = $suff = '';
+            $x = 0;
             while($memberstoday = $db->fetch_array($query)) {
-                $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
-                $suff = '</span>';
-                $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
-                ++$todaymembersnum;
+                if ($x <= $onlinetodaycount) {
+                    $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
+                    $suff = '</span>';
+                    $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
+                    $x++;
+                } else {
+                    continue;
+                }
             }
             $todaymembers = implode(', ', $todaymembers);
             $db->free_result($query);
@@ -244,7 +251,8 @@
     $fquery = $db->query("SELECT f.*, c.name as cat_name, c.fid as cat_fid FROM ".X_PREFIX."forums f LEFT JOIN ".X_PREFIX."forums c ON (f.fup=c.fid) WHERE (c.type='group' AND f.type='forum' AND c.status='on' AND f.status='on' AND f.fup='$gid') ORDER BY c.displayorder ASC, f.displayorder ASC");
 }
 
-$indexBarTop = $indexBar = $forumlist = $spacer = '';
+$indexBarTop = $indexBar = $forumlist =  $spacer = '';
+$forumarray = array();
 $catLessForums = $lastcat = 0;
 
 if ($SETTINGS['space_cats'] == 'on') {
@@ -276,6 +284,7 @@
 }
 
 while($thing = $db->fetch_array($fquery)) {
+
     if ($SETTINGS['catsonly'] != 'on' || $gid > 0) {
         $cforum = forum($thing, "index_forum");
     } else {
@@ -287,6 +296,10 @@
     }
 
     if ($lastcat != $thing['cat_fid'] && ($SETTINGS['catsonly'] == 'on' || (!empty($cforum) && $SETTINGS['catsonly'] != 'on'))) {
+        if ($forumlist != '') {
+            $forumarray[] = $forumlist;
+            $forumlist = '';
+        }
         $lastcat = $thing['cat_fid'];
         $thing['cat_name'] = html_entity_decode($thing['cat_name']);
         eval('$forumlist .= "'.template('index_category').'";');
@@ -298,9 +311,13 @@
     if (!empty($cforum)) {
         $forumlist .= $cforum;
     }
+
 }
 
-if (empty($forumlist)) {
+$forumarray[] = $forumlist;
+$forumlist = implode($spacer, $forumarray);
+
+if ($forumlist == '') {
     eval('$forumlist = "'.template('index_noforum').'";');
 }
 $db->free_result($fquery);
@@ -313,4 +330,4 @@
 end_time();
 eval('$footer = "'.template('footer').'";');
 echo stripslashes($index.$footer);
-?>
\ No newline at end of file
+?>
Index: lang/English.lang.php
===================================================================
--- lang/English.lang.php	(revision 761)
+++ lang/English.lang.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2 SP1 SP1
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -159,7 +159,7 @@
 $lang['bbcode_prompt_quote'] = "Please enter the text you want quoted.";
 $lang['bbcode_prompt_size'] = "Please enter the text to be size ";
 $lang['bbcode_prompt_underline'] = "Please enter the text that should be underlined.";
-$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [email] mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [flash=200x100]http://www.macromedia.com/flash.swf[/flash] &nbsp; (Flash Movie)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
+$lang['bbcodeinfo'] = "You can use BB Code, a simplified version of HTML, in your posts to create certain effects.<br /><br /> [b]Text here[/b] &nbsp; (Bold Text)<br /><br /> [i]Text here[/i] &nbsp; (Italicized Text)<br /><br /> [u]Text here[/u] &nbsp; (Underlined Text)<br /><br /> [url]http://www.php.net[/url] &nbsp; (Link)<br /><br /> [url=http://www.php.net]Home Page of PHP[/url] &nbsp; (Link)<br /><br /> [email] mail@xmbforum.com[/email] &nbsp; (E-Mail Link)<br /><br /> [email=mail@xmbforum.com]E-mail Me![/email] &nbsp; (E-Mail Link)<br /><br /> [quote]Text here[/quote] &nbsp; (Quoted Text)<br /><br /> [code]Text here[/code] &nbsp; (Text With Preserved Formatting)<br /><br /> [img]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Image)<br /><br /> [img=50x50]http://www.php.net/gifs/php_logo.gif[/img] &nbsp; (Resized Image)<br /><br /> [color=red]This color is red[/color] &nbsp; (Colored Text)<br /><br /> [size=3]This font size is 3[/size] &nbsp; (Sized Text)<br /><br /> [font=Tahoma]This font is Tahoma[/font] &nbsp; (Different Font Than Default)<br /><br /> [align=center]This is centered[/align] &nbsp; (Aligned Text)<br /><br /> [list]<br /> [*]List Item #1<br /> [*]List Item #2<br /> [*]List Item #2<br /> [/list] &nbsp; (List)";
 $lang['bbcodeoff'] = "Turn BBCode off?";
 $lang['bbinsert'] = "Auto BB Code Inserter:";
 $lang['bbname'] = "Forum Name:";
@@ -215,7 +215,7 @@
 $lang['closethreadmsg'] = "Thank you, the topic has been closed/ opened. You are now being forwarded back to the thread list.";
 $lang['complete_threadprune'] = "Thank you, the topic has been pruned. You are now being forwarded back to the thread list";
 $lang['confirmDeletePosts'] = "You are about to delete all this user's posts. Are you sure you wish to continue?";
-$lang['confirmDeleteUser'] = "By checking this checkbox, you mark this user to be deleted. If you are sure you wish to delete this user, press Ok, otherwise, press Cancel";
+$lang['confirmDeleteUser'] = "The following members will be deleted:";
 $lang['coppaagree'] = "I Agree That I Am 13 or Above";
 $lang['coppastatus'] = "COPPA Compliancy Status:";
 $lang['copythread'] = "Copy Thread";
@@ -245,7 +245,6 @@
 $lang['deletethreadmsg'] = "Thank you, the topic has been deleted. You are now being forwarded back to the thread list.";
 $lang['desc'] = "Descending";
 $lang['developedby'] = "Developed By";
-$lang['disclaimer'] = "Notice!\\n\\nThe above tools have been working in test environments. However, we advise board owners that this should not be the only form of backup procedure. For alternative methods, please check the Support forums at http://www.xmbforum.com/.";
 $lang['dotfolders'] = "'dot' Folders:<br /><span class=\"smalltxt\">Do you want to show dots on folders for the users that have posted in them?</span>";
 $lang['doublee'] = "Allow duplicate mails?";
 $lang['dump_attachments'] = "Dump Attachments";
@@ -263,13 +262,12 @@
 $lang['emailpw'] = "Your password has been reset, and details sent to your e-mail address on record.";
 $lang['emailrestricted'] = "Sorry, this e-mail address cannot be used to register on these forums.";
 $lang['emailverify'] = "E-mail verification (e-mail random password)?";
-$lang['emptythreadmsg'] = "Thank you, the thread has been emptied. You are now being forwarded back to the (emptied) thread.";
+$lang['emptythreadmsg'] = "Thank you, the thread has been emptied. You are now being forwarded back to the thread list.";
 $lang['Enable_Page_load'] = "Enable Page-loadtimes";
 $lang['Enable_PHP_SQL'] = "Enable PHP/SQL Calculation";
 $lang['Enable_Queries'] = "Enable Queries";
 $lang['Enable_Server_Load'] = "Enable Server Load";
 $lang['error'] = "Error";
-$lang['error_chmod_attach_dir'] = "attachments directory (\"./attachments\") should be chmodded to 777 so XMB can write to it.";
 $lang['errormovingthreads'] = "You did not select target forum or subforum. Please go back and try again.";
 $lang['evalbestmember'] = '$lang["bestmember"] = "Member of the Day is <strong>$membesthtml</strong> with <strong>$bestmemberpost</strong> posts";';
 $lang['evalindexstats'] = '$lang["indexstats"] = "<strong>$threads</strong> topics / <strong>$posts</strong> posts / <strong>$members</strong> members";';
@@ -346,10 +344,11 @@
 $lang['invalidforumpw'] = "The password you entered is invalid.";
 $lang['invalidip'] = "Invalid IP Address Format";
 $lang['invalidFilename'] = "Invalid Filename";
+$lang['invalidtid'] = "Thread cannot be merged.  Invalid Thread ID (tid)";
 $lang['invertselection'] = "Invert Selection";
 $lang['ipwarning'] = "<br /><strong>Warning!</strong> Your IP Address is on the list. You'll be permanently banned if you log out.";
 $lang['key'] = 'Key: ';
-$lang['last50today'] = "$onlinetodaycount Members Who Have Visited Today (if applicable)";
+$lang['last50today'] = "Last $onlinetodaycount Members Who Have Visited Today (if applicable)";
 $lang['lastactive'] = "Last active:";
 $lang['lastreply1'] = "on";
 $lang['lastsadmin'] = "You just tried to de-admin the last remaining Super Administrator. This is a dangerous thing to do. Once de-admin'd, it is not possible anymore to reset one's status back to Super Administrator";
@@ -412,7 +411,7 @@
 $lang['no_poll'] = "This is not a poll!";
 $lang['no_templates'] = "templates.xmb was not found.";
 $lang['noadminsession'] = "No Administration Login Session Found.";
-$lang['noadminsession2'] = "Welcome to the administration control panel for XMB 1.9, currently running $bbname.";
+$lang['noadminsession2'] = "Welcome to the administration control panel, currently running $bbname.";
 $lang['noadminsession3'] = "Please enter your username and password which currently has administration status.";
 $lang['noadminsession4'] = "If you still have issues logging in, please contact the board <strong><a href=\"mailto:$adminemail?subject=Admin Login Failure At $bbname\">webmaster</a></strong>";
 $lang['noban'] = "Nothing";
@@ -544,6 +543,7 @@
 $lang['repair'] = 'Repair Tables';
 $lang['replace'] = "Replace";
 $lang['replacedby'] = "Replace with";
+$lang['replies'] = 'Replies';
 $lang['replymsg'] = "Thank you, your post has been submitted. You are now being forwarded to your post.";
 $lang['reportmessage'] = "The following post has been reported by a user, please inspect it:";
 $lang['reportmsg'] = "Thank you, the post has been reported. You are now being forwarded back to the thread page";
@@ -731,7 +731,7 @@
 $lang['textfaqans16'] = "Smilies are the little faces to the right of the input for message. They display graphical faces instead of simply a <strong>:)</strong>.<br />Here is a list of current supported smilies:";
 $lang['textfaqans17'] = "You can create a poll by visiting the forum you want to post the poll in and click on Start Poll. The screen following after you click the button is just like a normal new thread page but has an extra box for Poll Answers. You should enter one answer per line.<br /><br />You can vote on polls in threads by visiting the thread with the poll in it and selecting the option you want to vote for, then clicking the submit button. You can only vote on a poll once, so once you vote, you cant change your mind.<br /><br />The Administrator could have disabled this option for each forum.";
 $lang['textfaqans19'] = "Most of the time the answer is no, but ask your Admin.";
-$lang['textfaqans2'] = "Yes. XMB uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
+$lang['textfaqans2'] = "Yes. $bbname uses cookies to store your login information, last visit, and threads that you have visited. We do this to make it easier for you so you can see which posts contain new replies and so you do not have to enter your username and password when posting or other certain things.<br /><br />If you logout, your cookies will be cleared. To logout <a href=\"misc.php?action=logout\">click here</a>.";
 $lang['textfaqans21'] = "You can logout by clicking Logout at the top of the page. When you logout the cookies that store your username and password will be removed and you will become a Guest or Anonymous user.";
 $lang['textfaqans3'] = "To add a signature to your posts you have to log into your <a href=\"memcp.php\">profile</a> and insert into the signature text box the signature you wish to use.<br /><br />BB Code and HTML maybe turned off or on. This can effect what you can insert into your signature.";
 $lang['textfaqans4'] = "Again in your <a href=\"memcp.php\">profile</a> there is a place for an 'Avatar' and avatar is the image under your name. Check with your Admin about the size of your avatar, it's usually considered common courtesy to use one under 150 pixels wide.";
@@ -784,7 +784,7 @@
 $lang['textillegalquery'] = "The query you used is not allowed.";
 $lang['textimgcode'] = "IMG Code";
 $lang['textimgcodeis'] = "[img] Code is";
-$lang['textimportsubmit'] = "Import Theme into XMB";
+$lang['textimportsubmit'] = "Import Theme into $bbname";
 $lang['textimporttheme'] = "Import Theme:";
 $lang['textinforum'] = "in forum:";
 $lang['textinthread'] = "In Thread:";
@@ -819,9 +819,9 @@
 $lang['textmem'] = "Member";
 $lang['textmemberlist'] = "Member List";
 $lang['textmembers'] = "Members";
-$lang['textmemberstoday'] = " members have already visited the site today";
+$lang['textmemberstoday'] = " members have visited the site today";
 $lang['textmembersupdate'] = "Members updated successfully!";
-$lang['textmembertoday'] = " member has already visited the site today ";
+$lang['textmembertoday'] = " member has visited the site today ";
 $lang['textmemliststatus'] = "Member List Status:";
 $lang['textmergethread'] = "Merge Thread";
 $lang['textmesperday'] = "messages per day";
@@ -905,7 +905,7 @@
 $lang['textpostread'] = "Posting &amp; Reading Messages";
 $lang['textpostreply'] = "Post Reply";
 $lang['textposts'] = "Posts:";
-$lang['textpowered'] = "powered by XMB";
+$lang['textpowered'] = "Powered By XMB";
 $lang['textppp'] = "Posts Per Page:";
 $lang['textpreview'] = "Preview Post";
 $lang['textpreviewu2u'] = "Preview U2U";
@@ -985,9 +985,9 @@
 $lang['texttabletext'] = "Table Text Color:";
 $lang['texttext'] = "Text Color:";
 $lang['texttheme'] = "Theme:";
-$lang['textthemefile'] = "XMB Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
-$lang['textthemeimportfail'] = "The theme could not be imported into XMB.";
-$lang['textthemeimportsuccess'] = "The theme has successfully been imported into XMB.";
+$lang['textthemefile'] = "$bbname Theme File:<br /><span class=\"smalltxt\">(must be valid!)</span>";
+$lang['textthemeimportfail'] = "The theme could not be imported into $bbname.";
+$lang['textthemeimportsuccess'] = "The theme has successfully been imported into $bbname.";
 $lang['textthemename'] = "Theme Name:";
 $lang['texttime'] = "Time:";
 $lang['texttimeformat'] = "Time Format:";
@@ -1045,8 +1045,10 @@
 $lang['theme_already_exists'] = "A theme with this name already exists!";
 $lang['themes'] = "Themes";
 $lang['themeupdate'] = "Themes updated successfully!";
+$lang['threads'] = 'Threads';
 $lang['tickercontents'] = "News In Newsticker:";
 $lang['tickername'] = "News &amp; Updates";
+$lang['tidnoexist'] = "Thread cannot be merged.  Thread ($othertid) does not exist";
 $lang['timemsg'] = "Processed in";
 $lang['timezone1'] = "(GMT -12:00) Eniwetok, Kwajalein";
 $lang['timezone10'] = "(GMT -3:30) Newfoundland";
@@ -1105,7 +1107,8 @@
 $lang['u2ublocked'] = "The would-be recipient of this U2U has blocked you, so you can't send this message.";
 $lang['u2udump'] = "Clear All U2Us";
 $lang['u2udump_confirm'] = 'Are you sure you want to Delete all u2u\'s?';
-$lang['u2uempty'] = 'The U2U you are trying to save is empty';
+$lang['u2uempty'] = 'The U2U you are trying to save is empty.';
+$lang['u2umsgempty'] = 'The U2U you are trying to send is empty.';
 $lang['u2unotloggedin'] = "You must be logged in or registered to use U2U";
 $lang['u2uquota'] = "U2U Quota:";
 $lang['u2ureachedquota'] = "You have reached the U2U quota limit. You must delete some u2us before you can send any";
@@ -1123,6 +1126,7 @@
 $lang['verificationnote'] = "Please enter the text contained within the image into the textbox below it. This process is used to prevent automated bots.";
 $lang['viaemail'] = 'Via E-mail';
 $lang['viau2u'] = 'Via U2U';
+$lang['view'] = 'View';
 $lang['viewcompleteinbox'] = "View Complete Inbox";
 $lang['viewresults'] = "View Results";
 $lang['votemsg'] = "Thank you, your vote has been submitted. You are now being forwarded back to the thread";
@@ -1148,5 +1152,6 @@
 $lang['whosonline_on'] = "Who's online in index status:";
 $lang['whosonlinetoday'] = "Who's Online Today";
 $lang['whoview'] = "Who Can View This Forum?";
+$lang['xmb'] = "XMB";
 $lang['xmbgroup'] = "The XMB Group";
-?>
\ No newline at end of file
+?>
Index: member.php
===================================================================
--- member.php	(revision 761)
+++ member.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'member.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -47,7 +49,7 @@
 
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'reg':
         nav($lang['textregister']);
@@ -318,28 +320,28 @@
                 eval('echo stripslashes("'.template('member_reg').'");');
             }
         } else {
-            $find = array('<', '>', '|', '"', '[', ']', '\\', ',', '@', '\'');
-            $username = formVar('username');
-            foreach($find as $needle) {
-                if (false !== strpos($username, $needle)) {
-                    error($lang['restricted']);
-                }
+            if ($_POST['username'] != preg_replace('#[\]\'\x00-\x1F\x7F<>\\\\|"[,@]#', '', $_POST['username'])) {
+                error($lang['restricted']);
             }
 
+            $username = postedVar('username', '', TRUE, FALSE);
+
             if (strlen($username) < 3 || strlen($username) > 32) {
                 error($lang['username_length_invalid']);
             }
 
+            $username = postedVar('username');
+
             if ($SETTINGS['ipreg'] != 'off') {
                 $time = $onlinetime-86400;
-                $query = $db->query("SELECT uid FROM ".X_PREFIX."members WHERE regip='$onlineip' AND regdate >= '$time'");
+                $query = $db->query("SELECT uid FROM ".X_PREFIX."members WHERE regip='$onlineip' AND regdate >= $time");
                 if ($db->num_rows($query) >= 1) {
                     error($lang['reg_today']);
                 }
                 $db->free_result($query);
             }
 
-            $email = addslashes(formVar('email'));
+            $email = postedVar('email', 'javascript', TRUE, TRUE, TRUE);
             if ($SETTINGS['doublee'] == 'off' && false !== strpos($email, "@")) {
                 $email1 = ", email";
                 $email2 = "OR email='$email'";
@@ -348,23 +350,26 @@
                 $email2 = '';
             }
 
+            $username = addslashes($username);
             $query = $db->query("SELECT username$email1 FROM ".X_PREFIX."members WHERE username='$username' $email2");
             if ($member = $db->fetch_array($query)) {
                 $db->free_result($query);
                 error($lang['alreadyreg']);
             }
 
-            $password = formVar('password');
             if ($SETTINGS['emailcheck'] == 'on') {
                 $password = '';
                 $chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz";
                 mt_srand((double)microtime() * 1000000);
-                for($get = strlen($chars); $i < 8; $i++) {
+                $get = strlen($chars) - 1;
+                for($i = 0; $i < 8; $i++) {
                     $password .= $chars[mt_rand(0, $get)];
                 }
                 $password2 = $password;
+                } else {
+                $password = $_POST['password'];
+                $password2 = $_POST['password2'];
             }
-            $password2 = trim($password2);
 
             if ($password != $password2) {
                 error($lang['pwnomatch']);
@@ -442,15 +447,15 @@
                 require ROOT.'include/captcha.inc.php';
                 $Captcha = new Captcha(250, 50);
                 if ($Captcha->bCompatible !== false) {
-                    $imghash = addslashes($imghash);
-                    $imgcode = addslashes($imgcode);
+                    $imghash = postedVar('imghash', '', FALSE, TRUE);
+                    $imgcode = postedVar('imgcode', '', FALSE, TRUE);
                     if ($Captcha->ValidateCode($imgcode, $imghash) !== true) {
                         error($lang['captchaimageinvalid']);
                     }
                 }
             }
 
-            $langfilenew = getLangFileNameFromHash(formVar('langfilenew'));
+            $langfilenew = getLangFileNameFromHash($_POST['langfilenew']);
             if (!$langfilenew) {
                 $langfilenew = $SETTINGS['langfile'];
             } else {
@@ -463,7 +468,7 @@
 
             $self['status'] = ($count1 != 0) ? 'Member' : 'Super Administrator';
 
-            $timeoffset1 = formInt('timeoffset1');
+            $timeoffset1 = isset($_POST['timeoffset1']) && is_numeric($_POST['timeoffset1']) ? $_POST['timeoffset1'] : 0;
             $thememem = formInt('thememem');
             $tpp = formInt('tpp');
             $ppp = formInt('ppp');
@@ -477,63 +482,44 @@
             $day = formInt('day');
             $bday = iso8601_date($year, $month, $day);
 
-            $dateformatnew = formVar('dateformatnew');
-            if (strlen($dateformatnew) == 0) {
+            $dateformatnew = postedVar('dateformatnew', 'javascript');
+            if (strlen($dateformatnew) == 0 Or intval($dateformatnew) > 0) { // Temporary validation of dateformat - if it contains numbers we assume the date is incorrect (blacklist approach) and therefore use the default dateformat otherwise we proceed to validation of input.
                 $dateformatnew = $SETTINGS['dateformat'];
-            } else {
-                $dateformatnew = (intval($dateformatnew) > 0 ? $SETTINGS['dateformat'] : checkInput($dateformatnew, '', '', 'javascript', true)); // Temporary validation of dateformat - if it contains numbers we assume the date is incorrect (blacklist approach) and therefore use the default dateformat otherwise we proceed to validation of input.
             }
 
             $timeformatnew = formInt('timeformatnew');
-            $timeformatnew = $timeformatnew ? checkInput($timeformatnew, '', '', 'script', true) : $SETTINGS['timeformat'];
-            $avatar = formVar('avatar');
-            $avatar = $avatar ? checkInput($avatar, '', '', 'javascript', false) : '';
-            $avatar = $avatar ? checkInput($avatar, '', '', 'php', false) : '';
-            $location = formVar('location');
-            $location = $location ? checkInput($location, '', '', "javascript", false) : '';
-            $icq = formVar('icq');
-            $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
-            $yahoo = formVar('yahoo');
-            $yahoo = $yahoo ? checkInput($yahoo, '', '', 'javascript', false) : '';
-            $aim = formVar('aim');
-            $aim = $aim ? checkInput($aim, '', '', 'javascript', false) : '';
-            $msn = formVar('msn');
-            $msn = $msn ? checkInput($msn, '', '', 'javascript', false) : '';
-            $email = formVar('email');
-            $email = $email ? checkInput($email, '', '', 'javascript', false) : '';
-            $site = formVar('site');
-            $site = $site ? checkInput($site, '', '', 'javascript', false) : '';
-            $bio = isset($_POST['bio']) ? checkInput($_POST['bio'], '', '', 'javascript', false) : '';
-            $mood = isset($_POST['mood']) ? checkInput($_POST['mood'], 'no', 'no', 'javascript', false) : '';
-            $sig = isset($_POST['sig']) ? checkInput($_POST['sig'], '', $SETTINGS['sightml'], '', false) : '';
+            if ($timeformatnew != 12 And $timeformatnew != 24) {
+                $timeformatnew = $SETTINGS['timeformat'];
+            }
 
-            $avatar = addslashes($avatar);
-            $location = addslashes($location);
-            $yahoo = addslashes($yahoo);
-            $aim = addslashes($aim);
-            $msn = addslashes($msn);
-            $email = addslashes($email);
-            $site = addslashes($site);
-            $bio = addslashes($bio);
-            $mood = addslashes($mood);
-            $sig = addslashes($sig);
+            $password = md5($password);
 
-            $password = md5(trim($password));
+            if ($SETTINGS['regoptional'] == 'off') {
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+            } else {
+                $avatar = postedVar('avatar', 'javascript', TRUE, TRUE, TRUE);
+                $location = postedVar('location', 'javascript', TRUE, TRUE, TRUE);
+                $icq = postedVar('icq', '', FALSE, FALSE);
+                $icq = ($icq && is_numeric($icq) && $icq > 0) ? $icq : 0;
+                $yahoo = postedVar('yahoo', 'javascript', TRUE, TRUE, TRUE);
+                $aim = postedVar('aim', 'javascript', TRUE, TRUE, TRUE);
+                $msn = postedVar('msn', 'javascript', TRUE, TRUE, TRUE);
+                $site = postedVar('site', 'javascript', TRUE, TRUE, TRUE);
+                $bio = postedVar('bio', 'javascript', TRUE, TRUE, TRUE);
+                $mood = postedVar('mood', 'javascript', TRUE, TRUE, TRUE);
+                $sig = postedVar('sig', 'javascript', ($SETTINGS['sightml']=='off'), TRUE, TRUE);
 
-            $max_size = explode('x', $SETTINGS['max_avatar_size']);
-            if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-                $size = @getimagesize($avatar);
-                if ($size === false ) {
-                    $avatar = '';
-                } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
-                    error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                $max_size = explode('x', $SETTINGS['max_avatar_size']);
+                if ($max_size[0] > 0 && $max_size[1] > 0 && ini_get('allow_url_fopen')) {
+                    $size = @getimagesize($_POST['avatar']);
+                    if ($size === false ) {
+                        $avatar = '';
+                    } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0)) {
+                        error($lang['avatar_too_big'] . $SETTINGS['max_avatar_size'] . 'px');
+                    }
                 }
-            }
 
-            if ($SETTINGS['regoptional'] == 'on') {
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]',  '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp,  '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, 0, '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
-            } else {
-                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '', '', '$self[status]', '', '', '', '$showemail', '$timeoffset1', '', '$avatar', '', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '', '', '$dateformatnew', '', 0, '', 0, 0, '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
+                $db->query("INSERT INTO ".X_PREFIX."members (username, password, regdate, postnum, email, site, aim, status, location, bio, sig, showemail, timeoffset, icq, avatar, yahoo, customstatus, theme, bday, langfile, tpp, ppp, newsletter, regip, timeformat, msn, ban, dateformat, ignoreu2u, lastvisit, mood, pwdate, invisible, u2ufolders, saveogu2u, emailonu2u, useoldu2u) VALUES ('$username', '$password', ".$db->time($onlinetime).", 0, '$email', '$site', '$aim', '$self[status]', '$location', '$bio', '$sig', '$showemail', '$timeoffset1', '$icq', '$avatar', '$yahoo', '', $thememem, '$bday', '$langfilenew', $tpp, $ppp, '$newsletter', '$onlineip', $timeformatnew, '$msn', '', '$dateformatnew', '', 0, '$mood', 0, '0', '', '$saveogu2u', '$emailonu2u', '$useoldu2u')");
             }
 
             if ($SETTINGS['notifyonreg'] != 'off') {
@@ -563,8 +549,10 @@
             }
 
             if ($SETTINGS['emailcheck'] == 'on') {
+                $username = $_POST['username'];
                 altMail($email, $lang['textyourpw'], $lang['textyourpwis']." \n\n$username\n$password2", "From: $bbname <$adminemail>");
             } else {
+                $username = postedVar('username', '', TRUE, FALSE);
                 $currtime = $onlinetime + (86400*30);
                 put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
                 put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
@@ -577,8 +565,8 @@
         break;
 
     case 'viewpro':
-        $member = getVar('member');
-        if (!$member) {
+        $member = postedVar('member', '', TRUE, TRUE, FALSE, 'g');
+        if ($member == '') {
             error($lang['nomember']);
         } else {
             $memberinfo = $db->fetch_array($db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$member'"));
@@ -629,12 +617,7 @@
                 }
 
                 if ($memberinfo['avatar'] != '') {
-                    if (false !== ($pos = strpos($memberinfo['avatar'], ',')) && substr($memberinfo['avatar'], $pos-4, 4) == '.swf') {
-                        $flashavatar = explode(',', $memberinfo['avatar']);
-                        $memberinfo['avatar'] = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-                    } else {
-                        $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                    }
+                    $memberinfo['avatar'] = '<img src="'.$memberinfo['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
                 }
 
                 if ($rank['avatarrank'] || $memberinfo['avatar']) {
@@ -680,7 +663,7 @@
 
                 $memberinfo['bio'] = stripslashes(censor($memberinfo['bio']));
                 $memberinfo['bio'] = nl2br($memberinfo['bio']);
-                $encodeuser = rawurlencode($memberinfo['username']);
+                $encodeuser = recodeOut($memberinfo['username']);
 
                 $emailblock = '';
                 if ($memberinfo['showemail'] == 'yes') {
@@ -702,9 +685,12 @@
 
                 $memberinfo['location'] = censor($memberinfo['location']);
                 $memberinfo['aim'] = censor($memberinfo['aim']);
+                $memberinfo['aimrecode'] = recodeOut($memberinfo['aim']);
                 $memberinfo['icq'] = ($memberinfo['icq'] > 0) ? $memberinfo['icq'] : '';
                 $memberinfo['yahoo'] = censor($memberinfo['yahoo']);
+                $memberinfo['yahoorecode'] = recodeOut($memberinfo['yahoo']);
                 $memberinfo['msn'] = censor($memberinfo['msn']);
+                $memberinfo['msnrecode'] = recodeOut($memberinfo['msn']);
 
                 if ($memberinfo['bday'] === iso8601_date(0,0,0)) {
                     $memberinfo['bday'] = $lang['textnone'];
@@ -765,7 +751,7 @@
                     $lastpost = $lang['textnopostsyet'];
                 }
 
-                $lang['searchusermsg'] = str_replace('*USER*', $memberinfo['username'], $lang['searchusermsg']);
+                $lang['searchusermsg'] = str_replace('*USER*', recodeOut($memberinfo['username']), $lang['searchusermsg']);
                 eval('echo stripslashes("'.template('member_profile').'");');
             }
         }
@@ -778,4 +764,4 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: memcp.php
===================================================================
--- memcp.php	(revision 761)
+++ memcp.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'memcp.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -55,7 +57,7 @@
 
 $favs = $buddys = NULL;
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'profile':
         nav('<a href="memcp.php">'.$lang['textusercp'].'</a>');
@@ -75,10 +77,10 @@
 }
 
 function makenav($current) {
-    global $bordercolor, $tablewidth, $borderwidth, $tablespacing, $altbg1, $altbg2, $lang;
+    global $THEME, $bordercolor, $tablewidth, $tablespacing, $altbg1, $altbg2, $lang;
     ?>
     <table cellpadding="0" cellspacing="0" border="0" bgcolor="<?php echo $bordercolor?>" width="<?php echo $tablewidth?>" align="center"><tr><td>
-    <table cellpadding="4" cellspacing="1" border="0" width="100%">
+    <table cellpadding="4" cellspacing="<?php echo $THEME['borderwidth']?>" border="0" width="100%">
     <tr align="center" class="tablerow">
     <?php
     if ($current == '') {
@@ -423,22 +425,21 @@
         $day = formInt('day');
         $bday = iso8601_date($year, $month, $day);
         $newavatar = formVar('newavatar');
-        $avatar = $newavatar ? checkInput($newavatar, 'no', 'no', 'javascript', false) : '';
-        $avatar = checkInput($newavatar, 'no', 'no', 'php', false);
+        $avatar = $newavatar ? checkInput($newavatar, 'no', 'yes', 'javascript', false) : '';
         $newlocation = formVar('newlocation');
-        $location = $newlocation ? checkInput($newlocation, 'no', 'no', 'javascript', false) : '';
+        $location = $newlocation ? checkInput($newlocation, 'no', 'yes', 'javascript', false) : '';
         $newicq = formVar('newicq');
         $icq = ($newicq && is_numeric($newicq) && $newicq > 0) ? $newicq : 0;
         $newyahoo = formVar('newyahoo');
-        $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'no', 'javascript', false) : '';
+        $yahoo = $newyahoo ? checkInput($newyahoo, 'no', 'yes', 'javascript', false) : '';
         $newaim = formVar('newaim');
-        $aim = $newaim ? checkInput($newaim, 'no', 'no', 'javascript', false) : '';
+        $aim = $newaim ? checkInput($newaim, 'no', 'yes', 'javascript', false) : '';
         $newmsn = formVar('newmsn');
-        $msn = $newmsn ? checkInput($newmsn, 'no', 'no', 'javascript', false) : '';
+        $msn = $newmsn ? checkInput($newmsn, 'no', 'yes', 'javascript', false) : '';
         $newemail = formVar('newemail');
-        $email = $newemail ? checkInput($newemail, 'no', 'no', 'javascript', false) : '';
+        $email = $newemail ? checkInput($newemail, 'no', 'yes', 'javascript', false) : '';
         $newsite = formVar('newsite');
-        $site = $newsite ? checkInput($newsite, 'no', 'no', 'javascript', false) : '';
+        $site = $newsite ? checkInput($newsite, 'no', 'yes', 'javascript', false) : '';
         $bio = isset($_POST['newbio']) ? checkInput($_POST['newbio'], 'no', 'no', 'javascript', false) : '';
         $mood = isset($_POST['newmood']) ? checkInput($_POST['newmood'], 'no', 'no', 'javascript', false) : '';
         $sig = isset($_POST['newsig']) ? checkInput($_POST['newsig'], '', $SETTINGS['sightml'], '', false) : '';
@@ -467,8 +468,8 @@
         $sig = addslashes($sig);
 
         $max_size = explode('x', $SETTINGS['max_avatar_size']);
-        if ($max_size[0] > 0 && $max_size[1] > 0 && substr_count($avatar, ',') < 2) {
-            $size = @getimagesize($avatar);
+        if ($max_size[0] > 0 && $max_size[1] > 0 && ini_get('allow_url_fopen')) {
+            $size = @getimagesize($_POST['newavatar']);
             if ($size === false ) {
                 $avatar = '';
             } else if (($size[0] > $max_size[0] && $max_size[0] > 0) || ($size[1] > $max_size[1] && $max_size[1] > 0) && !X_SADMIN) {
@@ -476,12 +477,12 @@
             }
         }
 
-        if ($newpassword != '' || $newpasswordcf != '' ) {
-            if ($newpassword != $newpasswordcf ) {
+        if ($_POST['newpassword'] != '' || $_POST['newpasswordcf'] != '' ) {
+            if ($_POST['newpassword'] != $_POST['newpasswordcf'] ) {
                 error($lang['pwnomatch'], false);
             }
 
-            $newpassword = md5(trim($newpassword));
+            $newpassword = md5($_POST['newpassword']);
 
             $pwtxt = "password='$newpassword',";
 
@@ -533,7 +534,7 @@
 
             $lastpost = explode('|', $fav['lastpost']);
             $dalast = $lastpost[0];
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
             $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
             $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
             $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
@@ -590,7 +591,7 @@
 
             $lastpost = explode('|', $fav['lastpost']);
             $dalast = $lastpost[0];
-            $lastpost['1'] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost['1'] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
             $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
             $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
             $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
@@ -682,12 +683,7 @@
     if ($member['avatar'] == '') {
         $member['avatar'] = '';
     } else {
-        if (false !== ($pos = strpos($member['avatar'], ',')) && substr($member['avatar'], $pos-4, 4) == '.swf') {
-            $flashavatar = explode(',',$member['avatar']);
-            $member['avatar'] = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-        } else {
-            $member['avatar'] = '<img src="'.$member['avatar'].'" border="0" alt="'.$lang['altavatar'].'" />';
-        }
+        $member['avatar'] = '<img src="'.$member['avatar'].'" border="0" alt="'.$lang['altavatar'].'" />';
     }
 
     if ($member['mood'] != '') {
@@ -737,7 +733,7 @@
 
         $lastpost = explode('|', $fav['lastpost']);
         $dalast = $lastpost[0];
-        $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+        $lastpost[1] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
         $lastreplytime = gmdate($timecode, $lastpost[0] + $tmOffset);
         $lastpost = $lang['lastreply1'].' '.$lastreplydate.' '.$lang['textat'].' '.$lastreplytime.' '.$lang['textby'].' '.$lastpost[1];
@@ -760,4 +756,4 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: misc.php
===================================================================
--- misc.php	(revision 761)
+++ misc.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'misc.php');
+
 require 'header.php';
 require ROOT.'include/online.inc.php';
 
@@ -65,7 +67,7 @@
 smcwcache();
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 switch($action) {
     case 'login':
         nav($lang['textlogin']);
@@ -112,9 +114,9 @@
             eval('$misc = "'.template('misc_login').'";');
             $misc = stripslashes($misc);
         } else {
-            $password = md5(formVar('password'));
-            $username = addslashes(formVar('username'));
-            $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$username' AND password='$password'");
+            $password = md5($_POST['password']);
+            $usernameinput = postedVar('username');
+            $query = $db->query("SELECT username FROM ".X_PREFIX."members WHERE username='$usernameinput' AND password='$password'");
             if ($query && $db->num_rows($query) == 1) {
                 $member = $db->fetch_array($query);
                 $db->free_result($query);
@@ -123,9 +125,9 @@
                 $username = $member['username'];
 
                 if (formInt('hide')) {
-                    $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$username'");
+                    $db->query("UPDATE ".X_PREFIX."members SET invisible='1' WHERE username='$usernameinput'");
                 } else {
-                    $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$username'");
+                    $db->query("UPDATE ".X_PREFIX."members SET invisible='0' WHERE username='$usernameinput'");
                 }
 
                 if ($server == 'Mic') {
@@ -150,8 +152,8 @@
                 } else {
                     $secure = formYesNo('secure');
                     if ($secure == 'yes') {
-                        put_cookie("xmbuser", $username);
-                        put_cookie("xmbpw", $password);
+                        put_cookie("xmbuser", $username, NULL, $cookiepath, $cookiedomain);
+                        put_cookie("xmbpw", $password, NULL, $cookiepath, $cookiedomain);
                     } else {
                         put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
                         put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
@@ -179,14 +181,12 @@
         $currtime = $onlinetime - (86400*30);
         $query = $db->query("DELETE FROM ".X_PREFIX."whosonline WHERE username='$xmbuser'");
 
-        put_cookie("xmbuser", $username, $currtime, $cookiepath, $cookiedomain);
-        put_cookie("xmbpw", $password, $currtime, $cookiepath, $cookiedomain);
         put_cookie("xmbuser", '', 0, $cookiepath, $cookiedomain);
         put_cookie("xmbpw", '', 0, $cookiepath, $cookiedomain);
 
         foreach($_COOKIE as $key=>$val) {
             if (preg_match('#^fidpw([0-9]+)$#', $key)) {
-                put_cookie($key, '');
+                put_cookie($key, '', 0, $cookiepath, $cookiedomain);
             }
         }
 
@@ -204,10 +204,10 @@
 
         $srchfrom = intval(getRequestVar('srchfrom'));
         $srchtxt = addslashes(getRequestVar('srchtxt'));
-        $srchuname = addslashes(getRequestVar('srchuname'));
-        $srchfid = formArray('srchfid');
+        $srchuname = cdataOut(stripslashes(getRequestVar('srchuname')));
+        $srchfid = getRequestInt('srchfid');
         if (empty($srchfid)) {
-            $srchfid[] = 'all';
+            $srchfid = 'all';
         }
 
         $filter_distinct = getRequestVar('filter_distinct');
@@ -223,19 +223,19 @@
         $searchresults = '';
 
         if (noSubmit('searchsubmit')) {
-            $forumselect = forumList('srchfid[]', true, true);
+            $forumselect = forumList('srchfid', FALSE, TRUE);
             eval('$search = "'.template('misc_search').'";');
             $misc = stripslashes($search);
         } else {
-            if (!$srchuname && !$srchtxt || (strlen($srchuname) < 3 && strlen($srchtxt) < 3)) {
+            if (strlen($srchuname) < 3 && strlen($srchtxt) < 3) {
                 error($lang['nosearchq']);
             }
 
-            if (!$srchuname || strlen($srchuname) < 3) {
+            if (strlen($srchuname) < 3) {
                 $srchuname = '';
             }
 
-            if (!$srchtxt || strlen($srchtxt) < 3) {
+            if (strlen($srchtxt) < 3) {
                 $srchtxt = '';
             }
 
@@ -263,28 +263,15 @@
                 }
 
                 if ($srchuname != '') {
-                    $sql .= " AND p.author='".addslashes($srchuname)."'";
-                    $ext[] = 'srchuname='.$srchuname;
+                    $sql .= " AND p.author='".$db->escape($srchuname)."'";
+                    $ext[] = 'srchuname='.recodeOut($srchuname);
                 }
 
-                $all = false;
-                $strsql = '';
-                if (!empty($srchfid)) {
-                    foreach($srchfid as $dummy=>$fid) {
-                        if ($fid == 'all') {
-                            $all = true;
-                            break;
-                        }
-                        $strsql .= "'".intval($fid)."', ";
-                    }
-                    $strsql = substr($strsql, 0, -2);
+                if ($srchfid != "all" && $srchfid != "") {
+                    $sql .= " AND p.fid='".(int)$srchfid."'";
+                    $ext[] = 'srchfid='.((int) $srchfid);
                 }
 
-                if ($all == false) {
-                    $sql .= " AND p.fid IN ($strsql)";
-                    $ext[] = 'srchfid IN ('.$strsql.')';
-                }
-
                 if ($srchfrom) {
                     $sql .= " AND p.dateline >= '$srchfrom'";
                     $ext[] = 'srchfrom'.((int)$srchfromold);
@@ -487,8 +474,8 @@
             eval('$misc = "'.template('misc_lostpw').'";');
             $misc = stripslashes($misc);
         } else {
-            $username = addslashes(formVar('username'));
-            $email = addslashes(formVar('email'));
+            $username = postedVar('username');
+            $email = postedVar('email');
             $query = $db->query("SELECT username, email, pwdate FROM ".X_PREFIX."members WHERE username='$username' AND email='$email'");
             $member = $db->fetch_array($query);
             $db->free_result($query);
@@ -505,15 +492,16 @@
             $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';
             $newpass = '';
             mt_srand((double)microtime() * 1000000);
-            $max = mt_rand(8, 12);
-            for ($get=strlen($chars), $i=0; $i < $max; $i++) {
+            $get = strlen($chars) - 1;
+            for ($i = 0; $i < 13; $i++) {
                 $newpass .= $chars[mt_rand(0, $get)];
             }
-            $newmd5pass = md5(trim($newpass));
+            $newmd5pass = md5($newpass);
 
             $db->query("UPDATE ".X_PREFIX."members SET password='$newmd5pass', pwdate='".$onlinetime."' WHERE username='$member[username]' AND email='$member[email]'");
 
-            altMail($member['email'], '['.$bbname.'] '.$lang['textyourpw'], $lang['textyourpwis']."\n\n".$member['username']."\n".$newpass, "From: ".$bbname." <".$adminemail.">");
+            $emailuname = htmlspecialchars_decode($member['username'], ENT_QUOTES);
+            altMail($member['email'], '['.$bbname.'] '.$lang['textyourpw'], $lang['textyourpwis']."\n\n".$emailuname."\n".$newpass, "From: ".$bbname." <".$adminemail.">");
 
             $misc .= '<span class="mediumtxt"><center>'.$lang['emailpw'].'</span></center><br />';
             $misc .= '<script>function redirect() {window.location.replace("index.php");}setTimeout("redirect();", 1250);</script>';
@@ -572,7 +560,7 @@
             }
 
             if (X_SADMIN && $online['username'] != 'xguest123' && $online['username'] != $lang['textguest1']) {
-                $online['username'] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($online['username']).'">'.$username.'</a>'.$hidden;
+                $online['username'] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($online['username']).'">'.$username.'</a>'.$hidden;
             } else {
                 $online['username'] = $username;
             }
@@ -616,7 +604,7 @@
         while($memberstoday = $db->fetch_array($query)) {
             $pre = '<span class="status_'.str_replace(' ', '_', $memberstoday['status']).'">';
             $suff = '</span>';
-            $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff.'</a>';
+            $todaymembers[] = '<a href="member.php?action=viewpro&amp;member='.recodeOut($memberstoday['username']).'">'.$pre.''.$memberstoday['username'].''.$suff. '</a>';
             ++$todaymembersnum;
         }
         $todaymembers = implode(', ', $todaymembers);
@@ -632,12 +620,12 @@
         break;
 
     case 'list':
-        $order = getVar('order');
-        $desc = getVar('desc');
+        $order = postedVar('order', '', FALSE, FALSE, FALSE, 'g');
+        $desc = postedVar('desc', '', FALSE, FALSE, FALSE, 'g');
         $page = getInt('page');
-        $srchmem = formVar('srchmem');
-        $srchemail = formVar('srchemail');
-        $srchip = formVar('srchip');
+        $srchmem = postedVar('srchmem', '', TRUE, FALSE);
+        $srchemail = postedVar('srchemail');
+        $srchip = postedVar('srchip');
 
         if ($SETTINGS['memliststatus'] == 'off') {
             eval('echo "'.template('header').'";');
@@ -647,7 +635,7 @@
             exit();
         }
 
-        if (!$desc || strtolower($desc) != 'desc') {
+        if (strtolower($desc) != 'desc') {
             $desc = 'asc';
         }
 
@@ -660,7 +648,7 @@
             $page = 1;
         }
 
-        if (!$order || ($order != 'username' && $order != 'postnum' && $order != 'status')) {
+        if ($order != 'username' && $order != 'postnum' && $order != 'status') {
             $orderby = "uid";
             $order = 'uid';
         } else if ($order == 'status') {
@@ -688,24 +676,27 @@
             } else {
                 $where[] = " email LIKE '%".$srchemail."%'";
             }
-            $ext[] = 'srchemail='.$srchemail;
-            $srchemail = htmlspecialchars($srchemail);
+            $ext[] = 'srchemail='.rawurlencode($_POST['srchemail']);
+            $srchemail = postedVar('srchemail', 'javascript', TRUE, FALSE);
+            /* Warning: $srchemail is used for template output */
         } else {
             $srchemail = '';
         }
 
         if ($srchip) {
             $where[] = " regip LIKE '%".$srchip."%'";
-            $ext[] = 'srchip='.$srchip;
-            $srchip = htmlspecialchars($srchip);
+            $ext[] = 'srchip='.rawurlencode($_POST['srchip']);
+            $srchip = postedVar('srchip', 'javascript', TRUE, FALSE);
+            /* Warning: $srchip is used for template output */
         } else {
             $srchip = '';
         }
 
         if ($srchmem) {
             $where[] = " username LIKE '%".addslashes(str_replace(array('%', '_'), array('\%', '\_'), $srchmem))."%'";
-            $ext[] = 'srchmem='.$srchmem;
-            $srchmem = htmlspecialchars($srchmem);
+            $ext[] = 'srchmem='.rawurlencode($_POST['srchmem']);
+            $srchmem = postedVar('srchmem', 'javascript', TRUE, FALSE);
+            /* Warning: $srchmem is used for template output */
         } else {
             $srchmem = '';
         }
@@ -716,7 +707,7 @@
         $querymem = $db->query("SELECT * FROM ".X_PREFIX."members WHERE $q ORDER BY $orderby $desc LIMIT $start_limit, $memberperpage");
         $num = $db->result($db->query("SELECT COUNT(uid) FROM ".X_PREFIX."members WHERE $q"), 0);
 
-        $ext = htmlspecialchars(implode('&amp;', $ext));
+        $ext = implode('&amp;', $ext);
 
         $adjTime = ($timeoffset * 3600) + ($addtime * 3600);
 
@@ -749,7 +740,7 @@
                     $member['location'] = '';
                 }
 
-                $memurl = rawurlencode($member['username']);
+                $memurl = recodeOut($member['username']);
                 if ($order == 'status') {
                     if ($oldst != $member['status']) {
                         $oldst = $member['status'];
@@ -801,7 +792,7 @@
     case 'captchaimage':
         require ROOT.'include/captcha.inc.php';
         $oPhpCaptcha = new Captcha(250, 50);
-        $imagehash = getVar('imagehash');
+        $imagehash = postedVar('imagehash', '', FALSE, TRUE, FALSE, 'g');
         $oPhpCaptcha->Create($imagehash);
         exit();
         break;
@@ -815,4 +806,4 @@
 end_time();
 eval('$footer = "'.template('footer').'";');
 echo stripslashes($header.$misc.$footer);
-?>
\ No newline at end of file
+?>
Index: post.php
===================================================================
--- post.php	(revision 761)
+++ post.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'post.php');
+
 require 'header.php';
 
 function bbcodeinsert() {
@@ -77,7 +79,7 @@
     if ($db->num_rows($query) == 1) {
         $thread = $db->fetch_array($query);
         $db->free_result($query);
-        $threadname = html_entity_decode(stripslashes(htmlspecialchars($thread['subject'])));
+        $threadname = stripslashes($thread['subject']);
         $fid = (int) $thread['fid'];
     } else {
         error($lang['textnothread']);
@@ -584,7 +586,8 @@
 
                     $topicpages = quickpage($posts, $subs['ppp']);
                     $threadurl = $SETTINGS['boardurl'] . 'viewthread.php?tid='.$tid.'&page='.$topicpages.'#pid'.$pid;
-                    altMail($subs['email'], $lang['textsubsubject'].' '.$threadname, $username.' '.$lang['textsubbody']." \n".$threadurl, "From: $bbname <$adminemail>");
+                    $rawsubject = htmlspecialchars_decode($threadname, ENT_QUOTES);
+                    altMail($subs['email'], $lang['textsubsubject'].' '.$rawsubject, $username.' '.$lang['textsubbody']." \n".$threadurl, "From: $bbname <$adminemail>");
                 }
                 $db->free_result($subquery);
 
@@ -658,6 +661,10 @@
                 eval('echo stripslashes("'.template('post_newthread').'");');
             }
         } else {
+            if ($subject == '' || $message == '') {
+                error($lang['postnothing']);
+            }
+
             if (!empty($username) && !empty($password)) {
                 if (X_GUEST) {
                     $password = md5(trim($password));
@@ -831,7 +838,7 @@
         break;
 
     case 'edit':
-        nav('<a href="viewthread.php?tid='.$tid.'">'.html_entity_decode($threadname).'</a>');
+        nav('<a href="viewthread.php?tid='.$tid.'">'.$threadname.'</a>');
         nav($lang['texteditpost']);
 
         if (!isset($editsubmit)) {
@@ -858,11 +865,17 @@
                 $postinfo = $db->fetch_array($query);
                 $db->free_result($query);
             }
-
+            
+            // update begin
             if (isset($postinfo['filesize'])) {
                 $postinfo['filesize'] = number_format($postinfo['filesize'], 0, '.', ',');
             }
-
+            
+            if (isset($postinfo['filename'])) {
+                $postinfo['filename'] = checkInput($postinfo['filename'], 'no', 'no', '', false);
+            }
+            // update end
+            
             $postinfo['subject'] = html_entity_decode($postinfo['subject']);
             $postinfo['message'] = html_entity_decode(stripslashes($postinfo['message']));
 
@@ -923,6 +936,9 @@
             if (X_GUEST) {
                 $username = trim($username);
                 $password = md5(trim($password));
+            } else {
+                $username = $xmbuser;
+                $password = $xmbpw;
             }
 
             $q = $db->query("SELECT * FROM ".X_PREFIX."members WHERE username='$username'");
@@ -1037,11 +1053,9 @@
                             }
                             break;
                         case 'rename':
-                            $name = basename($attach_name);
-                            if (strlen(trim($name)) > 2 || preg_match('#^[^a-z0-9]+$#', $name) == 1) {
-                                break;
-                            } else {
-                                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$name' WHERE pid='$pid'");
+                            if (isValidFilename($_POST['attach_name'])) {
+                                $name = addslashes(trim($_POST['attach_name']));
+                                $db->query("UPDATE ".X_PREFIX."attachments SET filename='$name' WHERE pid=$pid");
                             }
                             break;
                         case 'delete':
@@ -1108,4 +1122,4 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: stats.php
===================================================================
--- stats.php	(revision 761)
+++ stats.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'stats.php');
+
 require 'header.php';
 
 nav($lang['altstats']);
@@ -109,7 +111,7 @@
     if ($fids == '') {
          $restrict = '(1=2)';
     } else {
-         $restrict = 'fid IN('.$fids.')';
+         $restrict = 'fid IN ('.$fids.')';
     }
 }
 
@@ -239,7 +241,7 @@
     $bestmemberpost = 'No';
 } else {
     if ($info['Total'] != 0) {
-        $membesthtml = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($bestmember).'"><strong>'.$bestmember.'</strong></a>';
+        $membesthtml = '<a href="member.php?action=viewpro&amp;member='.recodeOut($bestmember).'"><strong>'.$bestmember.'</strong></a>';
         $bestmemberpost = $info['Total'];
         $eval = $lang['evalbestmember'];
     }
@@ -267,4 +269,4 @@
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
+?>
\ No newline at end of file
Index: templates.xmb
===================================================================
--- templates.xmb	(revision 761)
+++ templates.xmb	(revision 936)
@@ -4,7 +4,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
@@ -146,7 +146,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><strong><font color="$cattext">$lang[textbuddylist]</font></strong></td>
 </tr>
@@ -175,7 +175,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="ctrtablerow" bgcolor="$altbg1"><font class="mediumtxt"><a href="buddy.php?action=edit">$lang[editbuddylist]</a></font></td>
 </tr>
@@ -213,7 +213,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="buddy.php?action=delete">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[editbuddylist]</font></strong></td>
 </tr>
@@ -236,7 +236,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="buddy.php?action=add">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[addtoaddresses]</font></strong></td>
 </tr>
@@ -277,10 +277,10 @@
 <title>$bbname - $lang[textpowered]</title>
 </head>
 <body text="$text">
-<table cellspacing="2" cellpadding="0" border="0" width="$tablewidth" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="ctrtablerow" bgcolor="$altbg1"><font class="mediumtxt">$message$redirectjs</font></td>
 </tr>
@@ -304,7 +304,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="95%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header">$lang[textbuddylist]</td>
 </tr>
@@ -623,7 +623,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[error]</strong></font></td>
 </tr>
@@ -641,7 +641,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[noadminsession]</strong></font></td>
 </tr>
@@ -674,7 +674,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=usermaint"><font color="$cattext"><strong>$lang[textuserman]</strong></font></a></td>
 </tr>
@@ -698,7 +698,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=using"><font color="$cattext"><strong>$lang[textuseboa]</strong></font></a></td>
 </tr>
@@ -723,7 +723,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><a href="./faq.php?page=messages"><font color="$cattext"><strong>$lang[textpostread]</strong></font></a></td>
 </tr>
@@ -750,7 +750,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textbbrules]</strong></font></td>
 </tr>
@@ -766,7 +766,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textpostread]</strong></font></td>
 </tr>
@@ -792,7 +792,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq11]</strong></font></td>
 </tr>
@@ -807,7 +807,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a> $lang[textfaq12]</strong></font></td>
 </tr>
@@ -822,7 +822,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a> $lang[textfaq13]</strong></font></td>
 </tr>
@@ -837,7 +837,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a> $lang[textfaq14]</strong></font></td>
 </tr>
@@ -852,7 +852,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a> $lang[textfaq15]</strong></font></td>
 </tr>
@@ -867,7 +867,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a> $lang[textfaq17]</strong></font></td>
 </tr>
@@ -876,7 +876,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="50%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td width="25%">$lang[textsmiliecode]</td>
 <td width="75%">$lang[smiliepreview]</td>
@@ -896,7 +896,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="7"></a> $lang[textfaq19]</strong></font></td>
 </tr>
@@ -911,7 +911,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="8"></a> $lang[textfaq18]</strong></font></td>
 </tr>
@@ -934,7 +934,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textuserman]</strong></font></td>
 </tr>
@@ -958,7 +958,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq1]</strong></font></td>
 </tr>
@@ -973,7 +973,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a>$lang[textfaq2]</strong></font></td>
 </tr>
@@ -988,7 +988,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a>$lang[textfaq3]</strong></font></td></tr>
 <tr>
@@ -1002,7 +1002,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a>$lang[textfaq4]</strong></font></td>
 </tr>
@@ -1017,7 +1017,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a>$lang[textfaq5]</strong></font></td>
 </tr>
@@ -1032,7 +1032,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a>$lang[textfaq6]</strong></font></td>
 </tr>
@@ -1048,7 +1048,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textuseboa]</strong></font></td>
 </tr>
@@ -1073,7 +1073,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="1"></a>$lang[textfaq7]</strong></font></td>
 </tr>
@@ -1088,7 +1088,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="2"></a>$lang[textfaq16]</strong></font></td>
 </tr>
@@ -1103,7 +1103,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="3"></a>$lang[textfaq8]</strong></font></td>
 </tr>
@@ -1118,7 +1118,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="4"></a>$lang[textfaq9]</strong></font></td>
 </tr>
@@ -1133,7 +1133,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="5"></a>$lang[textfaq10]</strong></font></td>
 </tr>
@@ -1148,7 +1148,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="6"></a> $lang[textfaq20]</strong></font></td>
 </tr>
@@ -1163,7 +1163,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong><a name="7"></a> $lang[textfaq21]</strong></font></td>
 </tr>
@@ -1175,7 +1175,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="50%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="2" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="2" width="100%">
 $rankrows
 </table>
 </td>
@@ -1199,7 +1199,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textstats]</strong></font></td>
 </tr>
@@ -1258,7 +1258,7 @@
 
 |#*XMB TEMPLATE FILE*#|footer|#*XMB TEMPLATE*#|
 <br />
-<table cellspacing="$borderwidth" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
 <table width="100%" cellspacing="0" cellpadding="0">
@@ -1275,7 +1275,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="ctrtablerow">
 <td bgcolor="$altbg2">
 <font class="smalltxt">
@@ -1321,7 +1321,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header" align="center">
 <td width="4%">&nbsp;</td>
@@ -1340,13 +1340,13 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center" style="margin-top: 3px">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center" style="margin-top: 3px">
 <tr>
 <td class="post" align="right">&nbsp;$newtopiclink$newpolllink</td>
 </tr>
 </table>
 <br />
-<table width="$tablewidth" align="center"><tr>
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center"><tr>
 <td class="tablerow"><img src="$imgdir/red_folder.gif" alt="$lang[altredfolder]" />&nbsp;$lang[opennew] (&nbsp;
 <img src="$imgdir/hot_red_folder.gif" alt="$lang[althotredfolder]" />&nbsp;$lang[hottopic]&nbsp;)<br />
 <img src="./images/pixel.gif" width="1" height="4" alt="*" /><br/>
@@ -1369,7 +1369,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header" align="center">
 <td width="4%"><a href="cp.php?action=forum&amp;fdetails=$forum[fid]"><img src="./images/admin/editforumsets.gif" border="0" alt="$lang[alteditsettings]" /></a></td>
@@ -1417,13 +1417,13 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center" style="margin-top: 3px">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center" style="margin-top: 3px">
 <tr>
 <td class="post" align="right">&nbsp;$newtopiclink$newpolllink</td>
 </tr>
 </table>
 <br />
-<table width="$tablewidth" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="tablerow">
 <img src="$imgdir/red_folder.gif" alt="$lang[altredfolder]" />&nbsp;$lang[opennew] (&nbsp;
@@ -1469,7 +1469,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textpassword]</td>
 <td bgcolor="$altbg2"><input type="password" name="pw" size="25" /> <br /></td>
@@ -1524,7 +1524,7 @@
 |#*XMB TEMPLATE FILE*#|forumdisplay_subforums|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%" align="center">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%" align="center">
 <tr class="header">
 <td width="4%">&nbsp;</td>
 <td width="58%">$lang[textforum]</td>
@@ -1724,7 +1724,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="1" cellpadding="6" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="6" width="100%">
 <tr>
 <td width="74%" $topbgcode>
 <table border="0" width="100%" cellpadding="0" cellspacing="0">
@@ -1754,7 +1754,7 @@
 </table>
 <table cellspacing="0" cellpadding="1" border="0" width="$tablewidth" align="center">
 <tr>
-<td><table width="100%" cellspacing="0" cellpadding="2" align="center">
+<td><table width="100%" cellspacing="0" cellpadding="$tablespace" align="center">
 <tr>
 <td class="nav"> <a href="index.php">$bbname</a> $navigation</td>
 <td align="right">$quickjump</td>
@@ -1772,7 +1772,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%" align="center">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%" align="center">
 $indexBarTop
 $forumlist
 </table>
@@ -1783,7 +1783,6 @@
 $statsbar
 
 |#*XMB TEMPLATE FILE*#|index_category|#*XMB TEMPLATE*#|
-$spacer
 <tr>
 <td colspan="5" class="category"><a href="index.php?gid=$thing[cat_fid]"><font color="$cattext"><strong>$thing[cat_name]</strong></font></a></td>
 </tr>
@@ -1806,7 +1805,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 
 |#*XMB TEMPLATE FILE*#|index_forum|#*XMB TEMPLATE*#|
 <tr>
@@ -1842,7 +1841,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td align="left" class="category"><font color="$cattext"><strong>$lang[textstats]:</strong></font></td>
 <td align="left" class="category"><font color="$cattext"><strong>$lang[key]</strong></font></td>
@@ -1875,7 +1874,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td class="category"><strong><font color="$cattext">$lang[tickername] [<a id="tickertoggle" href="javascript:tickertoggle();">&nbsp;</a>]</font></strong></td>
 </tr>
@@ -1895,7 +1894,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[welcomeunregnotify]</strong></font></td>
 </tr>
@@ -1926,7 +1925,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" bgcolor="$bordercolor" align="center">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="3"><table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr class="tablerow">
@@ -1955,7 +1954,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="2" class="category">
 <a href="misc.php?action=online"><strong><font color="$cattext">$lang[whosonline]</font></strong></a><font color="$cattext"> - $memonmsg</font>
@@ -1994,6 +1993,9 @@
 $todaymembers&nbsp;
 </td>
 </tr>
+<tr>
+<td bgcolor="$altbg1" colspan="2" class="mediumtxt">$memontoday</td>
+</tr>
 
 |#*XMB TEMPLATE FILE*#|member_coppa|#*XMB TEMPLATE*#|
 <form method="post" action="member.php?action=reg">
@@ -2001,7 +2003,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textcoppa]</strong></font></td>
 </tr>
@@ -2021,7 +2023,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textprofor] $member</strong></font></td>
 </tr>
@@ -2052,7 +2054,7 @@
 <br />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[memcp_otherinfo]</strong></font></td>
 </tr>
@@ -2063,7 +2065,7 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textaim]</td>
-<td bgcolor="$altbg2"><a href="aim:goim?screenname=$memberinfo[aim]&amp;message=Hi+$memberinfo[aim].+Are+you+there+I+got+your+aim+name+from+a+message+board.">$memberinfo[aim]</a></td>
+<td bgcolor="$altbg2"><a href="aim:goim?screenname={$memberinfo['aimrecode']}&amp;message=Hi+{$memberinfo['aimrecode']}.+Are+you+there+I+got+your+aim+name+from+a+mess age+board.">{$memberinfo['aim']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[texticq]</td>
@@ -2071,11 +2073,11 @@
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textyahoo]</td>
-<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/$memberinfo[yahoo]" target="_blank">$memberinfo[yahoo]</a></td>
+<td bgcolor="$altbg2"><a href="http://profiles.yahoo.com/{$memberinfo['yahoorecode']}" target="_blank">{$memberinfo['yahoo']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textmsn]</td>
-<td bgcolor="$altbg2"><a href="http://members.msn.com/$memberinfo[msn]" target="_blank">$memberinfo[msn]</a></td>
+<td bgcolor="$altbg2"><a href="http://members.msn.com/{$memberinfo['msnrecode']}"target="_blank">{$memberinfo['msn']}</a></td>
 </tr>
 <tr class="tablerow">
 <td bgcolor="$altbg1">$lang[textlocation]</td>
@@ -2109,7 +2111,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[memcp_otheroptions]</strong></font></td>
 </tr>
@@ -2133,7 +2135,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textregister] - $lang[required]</strong></font></td>
 </tr>
@@ -2348,7 +2350,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[registerrulestitle]</strong></font></td>
 </tr>
@@ -2373,7 +2375,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="6" class="category" align="center" $catbgcode><strong><font color="$cattext">$lang[textfavorites]</font></strong></td>
 </tr>
@@ -2417,7 +2419,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg1">
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
@@ -2425,7 +2427,7 @@
 <td align="center" colspan="2" style="padding-bottom: 3px"><font class="mediumtxt">$lang[usercpwelcome]</font></td>
 </tr>
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="6" class="category"><font color="$cattext">$lang[textbriefsummary] $self[username] - [$self[status]]</font></td>
 </tr>
@@ -2478,7 +2480,7 @@
 <td valign="top">
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[textbuddylist]</strong></font></td>
 </tr>
@@ -2507,7 +2509,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="4"><font color="$cattext"><strong>$lang[textlatestu2us]</strong></font></td>
 </tr>
@@ -2529,7 +2531,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="5"><font color="$cattext"><strong>$lang[textlatestfavs]</strong></font></td>
 </tr>
@@ -2582,7 +2584,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpro] - $lang[required]</strong></font></td>
 </tr>
@@ -2777,7 +2779,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="6" class="category" align="center" $catbgcode><strong><font color="$cattext">$lang[textsubscriptions]</font></strong></td>
 </tr>
@@ -2822,7 +2824,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center" bgcolor="$bordercolor">
 <tr>
 <td>
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext"><strong>$lang[message]</strong></font></td>
 </tr>
@@ -2838,7 +2840,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
@@ -2855,7 +2857,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[fnasorry]</strong></font></td>
 </tr>
@@ -2874,7 +2876,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textlogin]</strong></font></td>
 </tr>
@@ -2906,7 +2908,7 @@
 |#*XMB TEMPLATE FILE*#|misc_login_incorrectdetails|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2"><font color="$cattext"><strong>$lang[textlogin_incorrect]</strong></font></td>
 </tr>
@@ -2925,7 +2927,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><font color="$cattext"><strong>$lang[textlostpw]</strong></font></td>
 </tr>
@@ -2953,7 +2955,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
@@ -2974,7 +2976,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="7" class="category"><font color="$cattext"><strong>$lang[textmemberlist]</strong></font></td>
 </tr>
@@ -3003,7 +3005,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="5" class="category"><font color="$cattext"><strong>$lang[textsortby]</strong></font></td>
 </tr>
@@ -3024,7 +3026,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="7" class="category"><font color="$cattext"><strong>$lang[textmemberlist]</strong></font></td>
 </tr>
@@ -3085,7 +3087,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="3">
 <font color="$cattext"><strong>$lang[whosonline]</strong></font> <font color="$cattext"><strong>-</strong></font> <a href="javascript:history.go(0)"><strong><font color="$cattext">$lang[refreshpage]</font></strong></a>
@@ -3108,7 +3110,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="4">
 <font color="$cattext"><strong>$lang[whosonline]</strong></font> <font color="$cattext"><strong>-</strong></font> <a href="javascript:history.go(0)"><strong><font color="$cattext">$lang[refreshpage]</font></strong></a>
@@ -3164,7 +3166,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%" align="center">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><strong><font color="$cattext">$lang[misconlinetoday] $todaymembersnum $lang[misconlinetoday2]</font></strong></td>
 </tr>
@@ -3186,7 +3188,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
 </tr>
@@ -3238,7 +3240,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="3"><font color="$cattext"><strong>$lang[textsearch]</strong></font></td>
 </tr>
@@ -3310,12 +3312,10 @@
 $preview
 <form method="post" name="input" action="post.php?action=edit&amp;fid=$fid&amp;tid=$tid&amp;pid=$pid" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texteditpost]</strong></font></td>
 </tr>
@@ -3399,12 +3399,10 @@
 $preview
 <form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid&amp;poll=yes" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostnew]</strong></font></td>
 </tr>
@@ -3459,12 +3457,10 @@
 $preview
 <form method="post" name="input" action="post.php?action=newthread&amp;fid=$fid" enctype="multipart/form-data" >
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostnew]</strong></font></td>
 </tr>
@@ -3532,7 +3528,7 @@
 |#*XMB TEMPLATE FILE*#|post_preview|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpreview]</strong></font></td>
 </tr>
@@ -3553,11 +3549,9 @@
 $preview
 <form method="post" name="input" action="post.php?action=reply&amp;fid=$fid&amp;tid=$tid" enctype="multipart/form-data">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<input type="hidden" name="username" value="$self[username]" />
-<input type="hidden" name="password" value="$xmbpw" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[textpostreply]</strong></font></td>
 </tr>
@@ -3607,7 +3601,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="1" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><font color="$cattext"><strong>$lang[texttopicreview]</strong></font></td>
 </tr>
@@ -3638,7 +3632,7 @@
 <table border="0" cellpadding="0" cellspacing="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><font class="mediumtxt" color="$cattext"><strong>$lang[spellingchecker]</strong></font></td>
 </tr>
@@ -3670,7 +3664,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="100%">
 <tr>
 <td class="tablerow" colspan="2" width="100%">
-<table cellspacing="1" cellpadding="$tablespace" border="0" width="100%" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" border="0" width="100%" align="center">
 <tr>
 <td colspan="6" class="category"><font class="mediumtxt" color="$cattext"><strong>$lang[spellingchecker]</strong></font></td>
 </tr>
@@ -3703,7 +3697,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="8" class="category"><font color="$cattext"><strong>$lang[navtodaysposts]</strong></font></td>
 </tr>
@@ -3763,7 +3757,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textbumpthread]</strong></font></td>
 </tr>
@@ -3786,7 +3780,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[copythread]:</strong></font></td>
 </tr>
@@ -3812,7 +3806,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textdeletethread]</strong></font></td>
 </tr>
@@ -3834,7 +3828,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textemptythread]</strong></font></td>
 </tr>
@@ -3857,7 +3851,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textmergethread]</strong></font></td>
 </tr>
@@ -3884,7 +3878,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textmovemethod1]</strong></font></td>
 </tr>
@@ -3919,7 +3913,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textclosethread]</strong></font></td>
 </tr>
@@ -3942,7 +3936,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textreportpost]</strong></font></td>
 </tr>
@@ -3964,7 +3958,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textsplitthread]</strong></font></td>
 </tr>
@@ -4007,7 +4001,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[textprunethread]</strong></font></td>
 </tr>
@@ -4040,7 +4034,7 @@
 <input type="hidden" name="token" value="$oToken->newToken" />
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class ="category" colspan="2"><font color="$cattext"><strong>$lang[texttopthread]</strong></font></td>
 </tr>
@@ -4065,7 +4059,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[textfolders]</font></strong></td>
 </tr>
@@ -4088,7 +4082,7 @@
 |#*XMB TEMPLATE FILE*#|u2u_drafts|#*XMB TEMPLATE*#|
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
-<td bgcolor="$bordercolor"><table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<td bgcolor="$bordercolor"><table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="5"><strong><font color="$cattext">$lang[textu2uprevsaved]</font></strong></td>
 </tr>
@@ -4117,7 +4111,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="100%" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td colspan="2" class="category"><strong><font color="$cattext">$lang[folderlist]</font></strong></td>
 </tr>
@@ -4160,7 +4154,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="0" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="0" width="100%">
 <tr>
 <td>
 <table border="0" cellspacing="0" cellpadding="$tablespace" width="100%">
@@ -4186,7 +4180,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category" colspan="2"><strong><font color="$cattext">$lang[ignorelist]</font></strong></td>
 </tr>
@@ -4207,7 +4201,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="5" class="category"><font color="$cattext">$lang[textu2uincoming]</font></td>
 </tr>
@@ -4232,7 +4226,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor" align="left">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="tablerow">
 <td bgcolor="$altbg2"><a href="u2u.php" onclick="setCheckboxes('u2u_main', true); return false;">$lang[checkall]</a> -
 <a href="u2u.php" onclick="setCheckboxes('u2u_main', false); return false;">$lang[uncheckall]</a> -
@@ -4262,7 +4256,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td width="100%" class="tablerow" bgcolor="$altbg1">$msg</td>
 </tr>
@@ -4277,7 +4271,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" align="center">
 <a href="u2u.php">$lang[textu2uinbox]</a> -
@@ -4299,7 +4293,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="header">
 <td colspan="5" class="category"><strong><font color="$cattext">$lang[textu2uoutgoing]</font></strong></td>
 </tr>
@@ -4361,7 +4355,7 @@
 <table border="0" cellspacing="0" cellpadding="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="mediumtxt" bgcolor="$altbg1">
 <div align="center">$lang[uqinfo]</div>
@@ -4398,7 +4392,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td width="100%" colspan="2" class="category" align="center"><strong><font color="$cattext">$lang[textu2u]</font></strong></td>
 </tr>
@@ -4431,7 +4425,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2">$lang[textsubject] $u2usubject</td>
 </tr>
@@ -4449,7 +4443,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$thewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="header" colspan="2">$lang[textsubject] $u2usubject</td>
 </tr>
@@ -4477,7 +4471,7 @@
 </td>
 </tr>
 </table>
-<table cellspacing="2" cellpadding="2" border="0" align="center">
+<table cellspacing="{$THEME['borderwidth']}" cellpadding="2" border="0" align="center">
 <tr>
 <td align="right" class="tablerow"><a href="u2u.php?action=printable&amp;u2uid=$u2uid" target="_blank">$lang[textprintver]</a></td>
 </tr>
@@ -4487,7 +4481,7 @@
 <td bgcolor="$bordercolor">
 <form method="post" action="u2u.php?action=modif">
 <input type="hidden" name="token" value="$oToken->newToken" />
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr>
 <td class="category"><font color="$cattext">$lang[textu2uoptions]</font></td>
 </tr>
@@ -4513,7 +4507,7 @@
 
 |#*XMB TEMPLATE FILE*#|viewthread|#*XMB TEMPLATE*#|
 $poll
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="smalltxt"><a href="viewthread.php?fid=$fid&amp;tid=$tid&amp;action=printable">$lang[textprintver]</a> | <a href="memcp.php?action=subscriptions&amp;subadd=$tid">$lang[textsubscribe]</a> | <a href="memcp.php?action=favorites&amp;favadd=$tid">$lang[textaddfav]</a></td>
 <td class="post" align="right" valign="bottom">&nbsp;$newtopiclink$newpolllink$replylink</td>
@@ -4522,7 +4516,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 $multipage
 <tr class="header">
 <td width="18%">$lang[textauthor] </td>
@@ -4534,7 +4528,7 @@
 </td>
 </tr>
 </table>
-<table width="$tablewidth" cellspacing="0" cellpadding="0" align="center">
+<table width="$tablewidth" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" align="center">
 <tr>
 <td class="post" align="right" style="padding-top: 3px">$newtopiclink$newpolllink$replylink</td>
 </tr>
@@ -4588,7 +4582,7 @@
 <table cellspacing="0" cellpadding="0" border="0" width="$tablewidth" align="center">
 <tr>
 <td bgcolor="$bordercolor">
-<table border="0" cellspacing="$borderwidth" cellpadding="$tablespace" width="100%">
+<table border="0" cellspacing="{$THEME['borderwidth']}" cellpadding="$tablespace" width="100%">
 <tr class="category">
 <td colspan="3"><font color="$cattext"><strong>$lang[textpoll] $thread[subject] $results</strong></font></td>
 </tr>
@@ -4797,7 +4791,7 @@
 <table width="$tablewidth" border="0" align="center" cellpadding="0" cellspacing="0" bgcolor="$bordercolor">
 <tr>
 <td><input type="hidden" name="subject" value="" />
-<table width="100%" border="0" cellpadding="$tablespace" cellspacing="1">
+<table width="100%" border="0" cellpadding="$tablespace" cellspacing="{$THEME['borderwidth']}">
 <tr bgcolor="$altbg1">
 <td colspan="3" class="category"><div align="left"><font color="$cattext"><strong>&nbsp;&raquo;&nbsp;$lang[quickreply]</strong>&nbsp;- [$lang[loggedin] <strong>$self[username]</strong>]</font></div></td>
 </tr>
@@ -4810,7 +4804,7 @@
 $lang[textsmiliesare] $allowsmilies<br />
 $lang[textbbcodeis] $allowbbcode<br />
 $lang[textimgcodeis] $allowimgcode</span><hr /></div><div align="center">
-$smilies<br /><a href="#qreply" onclick="Popup('misc.php?action=smilies', 'Window', 175, 250);">[$lang[moresmilies]]</a></div></td>
+$smilies<br /><a href="#qreply" onclick="Popup('misc.php?action=smilies', 'Window', 200, 250);">[$lang[moresmilies]]</a></div></td>
 <td bgcolor="$altbg2" width="56%" class="tablerow"> <div align="center"><textarea rows="10" name="message" id="message" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);" style="width: 100%;"></textarea></div></td>
 <td width="20%" height="101" bgcolor="$altbg2" class="tablerow"> <div align="center">
 <table width="100%" border="0" class="tablerow" cellspacing="0" cellpadding="0">
@@ -4855,4 +4849,4 @@
 |#*XMB TEMPLATE FILE*#|viewthread_reply|#*XMB TEMPLATE*#|
 <a href="./post.php?action=reply&amp;fid=$fid&amp;tid=$tid"><img src="$imgdir/reply.gif" border="0" alt="$lang[textpostreply]" /></a>
 
-|#*XMB TEMPLATE FILE*#|
\ No newline at end of file
+|#*XMB TEMPLATE FILE*#|
Index: today.php
===================================================================
--- today.php	(revision 761)
+++ today.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'today.php');
+
 require 'header.php';
 
 loadtemplates(
@@ -125,7 +127,7 @@
 
 $fids = implode(', ', $fids);
 
-$query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE lastpost >= '$srchfrom' AND fid IN($fids)");
+$query = $db->query("SELECT tid FROM ".X_PREFIX."threads WHERE lastpost >= '$srchfrom' AND fid IN ($fids)");
 $results = $db->num_rows($query);
 while($t = $db->fetch_array($query)) {
     $tids[] = $t['tid'];
@@ -171,7 +173,7 @@
         eval('$multipage = "'.template('today_multipage').'";');
     }
 
-    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN($tids) ORDER BY t.lastpost DESC LIMIT $start_limit, $tpp");
+    $query = $db->query("SELECT t.replies+1 as posts, t.tid, t.subject, t.author, t.lastpost, t.icon, t.replies, t.views, t.closed, t.topped, t.pollopts, f.fid, f.name FROM ".X_PREFIX."threads t LEFT JOIN ".X_PREFIX."forums f ON (f.fid=t.fid) WHERE t.tid IN ($tids) ORDER BY t.lastpost DESC LIMIT $start_limit, $tpp");
     $today_row = array();
     $tmOffset = ($timeoffset * 3600) + ($SETTINGS['addtime'] * 3600);
     while($thread = $db->fetch_array($query)) {
@@ -181,7 +183,8 @@
         if ($thread['author'] == $lang['textanonymous']) {
             $authorlink = $thread['author'];
         } else {
-            $authorlink = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($thread['author']).'">'.$thread['author'].'</a>';
+            $authorlink = '<a href="member.php?action=viewpro&amp;member='.recodeOut($thread['author']).'">'.$thread['author'].'</a>';
+
         }
 
         $lastpost = explode('|', $thread['lastpost']);
@@ -189,7 +192,7 @@
         $lastPid = $lastpost[2];
 
         if ($lastpost[1] != $lang['textanonymous']) {
-            $lastpost[1] = '<a href="member.php?action=viewpro&amp;member='.rawurlencode($lastpost[1]).'">'.$lastpost[1].'</a>';
+            $lastpost[1] = '<ahref="member.php?action=viewpro&amp;member='.recodeOut($lastpost[1]).'">'.$lastpost[1].'</a>';
         }
 
         $lastreplydate = gmdate($dateformat, $lastpost[0] + $tmOffset);
Index: tools.php
===================================================================
--- tools.php	(revision 761)
+++ tools.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'tools.php');
+
 require 'header.php';
 require ROOT.'include/admin.inc.php';
 
@@ -53,7 +55,7 @@
 
 displayAdminPanel();
 
-$action = getVar('action');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 switch($action) {
     case 'fixftotals':
@@ -281,11 +283,11 @@
             $i = 0;
             $q = $db->query("SELECT aid, pid FROM ".X_PREFIX."attachments");
             while($a = $db->fetch_array($q)) {
-                $result = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE pid='$a[pid]'");
-                if ($db->num_rows($result) == 0) {
-                    $db->free_result($result);
-                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid='$a[aid]'");
-                    $i++;
+               $result = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE pid={$a['pid']}");
+                  if ($db->num_rows($result) == 0) {
+                  $db->free_result($result);
+                  $db->query("DELETE FROM ".X_PREFIX."attachments WHERE aid={$a['aid']}");
+                  $i++;
                 }
             }
             $db->free_result($q);
@@ -417,4 +419,4 @@
 echo '</td></tr></table></table>';
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: topicadmin.php
===================================================================
--- topicadmin.php	(revision 761)
+++ topicadmin.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -25,6 +25,8 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  **/
+ 
+define('X_SCRIPT', 'topicadmin.php');
 
 require 'header.php';
 require ROOT.'include/topicadmin.inc.php';
@@ -51,7 +53,6 @@
 } else {
     $tid = (int) $_tid;
 }
-$kill = false;
 
 loadtemplates(
 'topicadmin_delete',
@@ -75,6 +76,7 @@
 if ($tid && !is_array($tid) && false === strstr($tid, ',')) {
     $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
     $thread = $db->fetch_array($query);
+    $db->free_result($query);
     $threadname = html_entity_decode(stripslashes($thread['subject']));
     $fid = $thread['fid'];
 } else {
@@ -83,9 +85,11 @@
 
 $query = $db->query("SELECT * FROM ".X_PREFIX."forums WHERE fid='$fid'");
 $forums = $db->fetch_array($query);
+$db->free_result($query);
 $forums['name'] = stripslashes($forums['name']);
 
-if ($fid == 0) {
+$kill = false;
+if ($fid == 0 Or !X_MEMBER) {
     $kill = true;
 } else if (isset($forums['type']) && $forums['type'] == 'forum') {
     nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode($forums['name'].'</a>'));
@@ -95,6 +99,7 @@
 } else if (isset($forums['type']) && $forums['type'] == 'sub') {
     $query = $db->query("SELECT name, fid FROM ".X_PREFIX."forums WHERE fid='$forums[fup]'");
     $fup = $db->fetch_array($query);
+    $db->free_result($query);
     $fup['name'] = stripslashes($fup['name']);
     nav('<a href="forumdisplay.php?fid='.intval($fup['fid']).'">'.html_entity_decode($fup['name']).'</a>');
     nav('<a href="forumdisplay.php?fid='.$fid.'">'.html_entity_decode($forums['name']).'</a>');
@@ -193,8 +198,7 @@
 
                 $mod->log($xmbuser, $action, $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['deletethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['deletethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -221,8 +225,7 @@
             $act = ($closed != '') ? 'open' : 'close';
             $mod->log($xmbuser, $act, $fid, $tid);
 
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -237,8 +240,8 @@
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='yes' WHERE tid='$tid' AND fid='$fid'");
                 $mod->log($xmbuser, 'close', $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -254,8 +257,8 @@
                 $db->query("UPDATE ".X_PREFIX."threads SET closed='' WHERE tid='$tid' AND fid='$fid'");
                 $mod->log($xmbuser, 'open', $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['closethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['closethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -287,6 +290,7 @@
                     } else {
                         $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
                         $info = $db->fetch_array($query);
+                        $db->free_result($query);
 
                         $db->query("INSERT INTO ".X_PREFIX."threads (fid, subject, icon, lastpost, views, replies, author, closed, topped) VALUES ('$info[fid]', '$info[subject]', '', '$info[lastpost]', 0, 0, '$info[author]', 'moved|$info[tid]', '$info[topped]')");
                         $ntid = $db->insert_id();
@@ -312,8 +316,7 @@
             updateforumcount($fid);
             updateforumcount($moveto);
 
-            echo '<center><span class="mediumtxt">'.$lang['movethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['movethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -322,7 +325,12 @@
         if (noSubmit('topsubmit')) {
             if (!is_array($tid)) {
                 $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+                if ($db->num_rows($query) == 0) {
+                	$db->free_result($query);
+                    error($lang['textnothread'], FALSE);
+                }
                 $topped = $db->result($query, 0);
+                $db->free_result($query);
                 if ($topped == 1) {
                     $lang['texttopthread'] = $lang['textuntopthread'];
                 }
@@ -335,7 +343,12 @@
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
                 $query = $db->query("SELECT topped FROM ".X_PREFIX."threads WHERE fid=$fid AND tid='$tid'");
+                if ($db->num_rows($query) == 0) {
+                	$db->free_result($query);
+                    error($lang['textnothread'], FALSE);
+                }
                 $topped = $db->result($query, 0);
+                $db->free_result($query);
 
                 if ($topped == 1) {
                     $db->query("UPDATE ".X_PREFIX."threads SET topped='0' WHERE tid='$tid' AND fid='$fid'");
@@ -347,8 +360,7 @@
                 $mod->log($xmbuser, $act, $fid, $tid);
             }
 
-            echo '<center><span class="mediumtxt">'.$lang['topthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['topthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -360,11 +372,12 @@
             $query = $db->query("SELECT * FROM ".X_PREFIX."threads WHERE tid='$tid'");
         }
         $ipinfo = $db->fetch_array($query);
+        $db->free_result($query);
         ?>
         <form method="post" action="cp.php?action=ipban">
         <table cellspacing="0" cellpadding="0" border="0" width="60%" align="center">
         <tr><td bgcolor="<?php echo $bordercolor?>">
-        <table border="0" cellspacing="<?php echo $borderwidth?>" cellpadding="<?php echo $tablespace?>" width="100%">
+        <table border="0" cellspacing="<?php echo $THEME['borderwidth']?>" cellpadding="<?php echo $tablespace?>" width="100%">
         <tr>
         <td class="header" colspan="3"><?php echo $lang['textgetip']?></td>
         </tr>
@@ -375,7 +388,7 @@
             $ip = explode('.', $ipinfo['useip']);
             $query = $db->query("SELECT * FROM ".X_PREFIX."banned WHERE (ip1='$ip[0]' OR ip1='-1') AND (ip2='$ip[1]' OR ip2='-1') AND (ip3='$ip[2]' OR ip3='-1') AND (ip4='$ip[3]' OR ip4='-1')");
             $result = $db->fetch_array($query);
-
+			$db->free_result($query);
             if ($result) {
                 $buttontext = $lang['textunbanip'];
                 for ($i=1; $i<=4; ++$i) {
@@ -420,14 +433,19 @@
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $pid = $db->result($db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid DESC LIMIT 1"), 0);
-                $db->query("UPDATE ".X_PREFIX."threads SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE tid='$tid' AND fid='$fid'");
-                $db->query("UPDATE ".X_PREFIX."forums SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE fid='$fid'");
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid DESC LIMIT 1");
+                if ($db->num_rows($query) == 1) {
+                    $pid = $db->result($query, 0);
 
-                $mod->log($xmbuser, $action, $fid, $tid);
+                    $db->query("UPDATE ".X_PREFIX."threads SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE tid=$tid AND fid=$fid");
+                    $db->query("UPDATE ".X_PREFIX."forums SET lastpost='".$onlinetime."|$xmbuser|$pid' WHERE fid=$fid");
+
+                    $mod->log($xmbuser, $action, $fid, $tid);
+                }
+                $db->free_result($query);
             }
-            echo '<center><span class="mediumtxt">'.$lang['bumpthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['bumpthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -439,26 +457,30 @@
         } else {
             $tids = $mod->create_tid_array($tid);
             foreach($tids AS $tid) {
-                $pid = $db->result($db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY pid ASC LIMIT 1"), 0);
-                $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid!='$pid'");
-                while($result = $db->fetch_array($query)) {
-                    $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$result[author]'");
+                $query = $db->query("SELECT pid FROM ".X_PREFIX."posts WHERE tid=$tid ORDER BY pid ASC LIMIT 1");
+                if ($db->num_rows($query) == 1) {
+                    $pid = $db->result($query, 0);
+                    $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
+                    while ($result = $db->fetch_array($query)) {
+                        $dbauthor = $db->escape($result['author']);
+                        $db->query("UPDATE ".X_PREFIX."members SET postnum=postnum-1 WHERE username='$dbauthor'");
+                    }
+                    $db->free_result($query);
+
+                    $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid=$tid AND pid!=$pid");
+                    $db->query("DELETE FROM ".X_PREFIX."attachments WHERE tid=$tid");
+
+                    updatethreadcount($tid); //Also updates lastpost
+                    $mod->log($xmbuser, $action, $fid, $tid);
                 }
                 $db->free_result($query);
-
-                $db->query("DELETE FROM ".X_PREFIX."posts WHERE tid='$tid' AND pid!='$pid'");
-                $db->query("DELETE FROM ".X_PREFIX."attachments WHERE pid='$pid'");
-
-                updatethreadcount($tid);
-                $mod->log($xmbuser, $action, $fid, $tid);
             }
             if (isset($forums['type']) && $forums['type'] == 'sub') {
                 updateforumcount($fup['fup']);
             }
             updateforumcount($fid);
 
-            echo '<center><span class="mediumtxt">'.$lang['emptythreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['emptythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -467,7 +489,7 @@
         if (noSubmit('splitsubmit')) {
             $query = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
             $replies = $db->result($query, 0);
-
+			$db->free_result($query);
             if ($replies == 0) {
                 error($lang['cantsplit'], false);
             }
@@ -481,6 +503,7 @@
                 $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $fid, $bordercolor, "", "", X_PREFIX."words", X_PREFIX."forums", X_PREFIX."smilies");
                 eval('$posts .= "'.template('topicadmin_split_row').'";');
             }
+            $db->free_result($query);
             eval('echo stripslashes("'.template('topicadmin_split').'");');
         } else {
             $subject = formVar('subject');
@@ -522,40 +545,55 @@
                     $db->query("UPDATE ".X_PREFIX."threads SET replies=replies-1 WHERE tid='$tid'");
                 }
             }
+            $db->free_result($query);
 
             $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$newtid' ORDER BY dateline ASC LIMIT 0,1");
             $firstauthor = $db->result($query, 0);
+            $db->free_result($query);
             $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid=$newtid ORDER BY dateline DESC LIMIT 0,1");
             $lastpost = $db->fetch_array($query);
+            $db->free_result($query);
             $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]', replies=replies-1 WHERE tid=$newtid");
 
             $query = $db->query("SELECT author FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline ASC LIMIT 0,1");
             $firstauthor = $db->result($query, 0);
+            $db->free_result($query);
             $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0,1");
             $lastpost = $db->fetch_array($query);
+            $db->free_result($query);
             $db->query("UPDATE ".X_PREFIX."threads SET author='$firstauthor', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]' WHERE tid='$tid'");
 
             $mod->log($xmbuser, $action, $fid, $tid);
 
-            echo '<center><span class="mediumtxt">'.$lang['splitthreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['splitthreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
     case 'merge':
         $mod->statuscheck($fid);
+        $tid = intval($tid);
         if (noSubmit('mergesubmit')) {
             eval('echo stripslashes("'.template('topicadmin_merge').'");');
         } else {
-            if ($tid == $othertid) {
-                error($lang['cannotmergesamethread']);
+            if ($othertid == 0) {
+                error($lang['invalidtid'], false);
+            } elseif ($tid == $othertid) {
+                error($lang['cannotmergesamethread'], false);
             }
 
             $queryadd1 = $db->query("SELECT replies, fid FROM ".X_PREFIX."threads WHERE tid='$othertid'");
-            $queryadd2 = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
+
+            if ($db->num_rows($queryadd1) == 0) {
+            	$db->free_result($queryadd1);
+                error($lang['tidnoexist'], false);
+            }
             $replyadd = $db->result($queryadd1, 0, 'replies');
             $otherfid = $db->result($queryadd1, 0, 'fid');
+            $db->free_result($queryadd1);
+
+            $queryadd2 = $db->query("SELECT replies FROM ".X_PREFIX."threads WHERE tid='$tid'");
             $replyadd2 = $db->result($queryadd2, 0);
+			$db->free_result($queryadd2);
             $replyadd++;
             $replyadd = $replyadd + $replyadd2;
 
@@ -571,17 +609,19 @@
             } else {
                 $db->query("UPDATE ".X_PREFIX."favorites SET tid='$tid' WHERE tid='$othertid'");
             }
+            $db->free_result($query);
 
             $query = $db->query("SELECT subject, author, icon FROM ".X_PREFIX."posts WHERE tid='$tid' OR tid='$othertid' ORDER BY pid ASC LIMIT 1");
             $thread = $db->fetch_array($query);
+            $db->free_result($query);
             $query = $db->query("SELECT author, dateline, pid FROM ".X_PREFIX."posts WHERE tid='$tid' ORDER BY dateline DESC LIMIT 0, 1");
             $lastpost = $db->fetch_array($query);
+            $db->free_result($query);
             $db->query("UPDATE ".X_PREFIX."threads SET replies='$replyadd', subject='$thread[subject]', icon='$thread[icon]', author='$thread[author]', lastpost='$lastpost[dateline]|$lastpost[author]|$lastpost[pid]' WHERE tid='$tid'");
 
             $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
 
-            echo '<center><span class="mediumtxt">'.$lang['mergethreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['mergethreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -682,8 +722,7 @@
 
             $mod->log($xmbuser, $action, $fid, "$othertid, $tid");
 
-            echo '<center><span class="mediumtxt">'.$lang['complete_threadprune'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+            message($lang['complete_threadprune'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -735,7 +774,7 @@
                 $columns = implode(', ', $cols);
                 $values  = "'".implode("', '", $vals)."'";
 
-                $db->query("INSERT INTO ".X_PREFIX."threads ($columns) VALUES ($values)") or die($db->error());
+                $db->query("INSERT INTO ".X_PREFIX."threads ($columns) VALUES ($values)");
 
                 $newtid = $db->insert_id();
                 $cols = array();
@@ -761,7 +800,7 @@
                     $cols = array();
                     $vals = array();
 
-                    $db->query("INSERT INTO ".X_PREFIX."posts ($columns) VALUES ($values)") or die($db->error());
+                    $db->query("INSERT INTO ".X_PREFIX."posts ($columns) VALUES ($values)");
                     $newpid = $db->insert_id();
 
                     $db->query("INSERT INTO ".X_PREFIX."attachments (`tid`,`pid`,`filename`,`filetype`,`filesize`,`attachment`,`downloads`) SELECT '$newtid','$newpid',`filename`,`filetype`,`filesize`,`attachment`,`downloads` FROM ".X_PREFIX."attachments WHERE pid='$oldPid'");
@@ -769,8 +808,8 @@
 
                 $mod->log($xmbuser, $action, $fid, $tid);
             }
-            echo '<center><span class="mediumtxt">'.$lang['copythreadmsg'].'</span></center>';
-            redirect('forumdisplay.php?fid='.$fid, 2, X_REDIRECT_JS);
+
+            message($lang['copythreadmsg'], false, '', '', 'forumdisplay.php?fid='.$fid, true, false, true);
         }
         break;
 
@@ -785,42 +824,34 @@
         if (noSubmit('reportsubmit')) {
             eval('echo stripslashes("'.template('topicadmin_report').'");');
         } else {
-            $postcount = $db->result($db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid='$tid'"), 0);
-            $query = $db->query("SELECT moderator FROM ".X_PREFIX."forums WHERE fid='$fid'");
-            $query2 = $db->query("SELECT username FROM ".X_PREFIX."members WHERE status='Super Administrator' OR status='Administrator' OR status='Super Moderator'");
+            $tid = intval($tid);
+            $pid = getInt('pid', 'p');
+            $query = $db->query("SELECT count(pid) FROM ".X_PREFIX."posts WHERE tid=$tid");
+            $postcount = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+            $db->free_result($query);
+            $query = $db->query("SELECT moderator FROM ".X_PREFIX."forums WHERE fid=$fid");
             $mods = explode(", ", $db->result($query, 0));
-            while($usr = $db->fetch_array($query2)) {
-                $mods[] = $usr['username'];
-            }
-            $sent = 0;
-            $time = $onlinetime;
-            foreach($mods as $key=>$mod) {
-                $mod = trim($mod);
-                $q = $db->query("SELECT ppp FROM ".X_PREFIX."members WHERE username='$mod'");
-                if ($db->num_rows($q) == 0) {
-                    continue;
-                }
-                $page = quickpage($postcount, $db->result($q, 0));
+            $db->free_result($query);
 
+            $modquery = $db->query("SELECT username, ppp FROM ".X_PREFIX."members WHERE status='Super Administrator' OR status='Administrator' OR status='Super Moderator'");
+            while($modusr = $db->fetch_array($modquery)) {
+                $mod = $db->escape($modusr['username']);
+                $page = quickpage($postcount, $modusr['ppp']);
+
                 $posturl = $SETTINGS['boardurl']."viewthread.php?tid=$tid&page=$page#pid$pid";
-                $reason = formVar('reason');
+                $reason = postedVar('reason');
                 $message = $lang['reportmessage'].' '.$posturl."\n\n".$lang['reason'].' '.$reason;
 
-                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$mod', '$self[username]', 'incoming', '$mod', 'Inbox', '$lang[reportsubject]', '$message', ".$db->time($time).", 'no', 'yes')");
-                $sent++;
+                $db->query("INSERT INTO ".X_PREFIX."u2u (msgto, msgfrom, type, owner, folder, subject, message, dateline, readstatus, sentstatus) VALUES ('$mod', '$xmbuser', 'incoming', '$mod', 'Inbox', '{$lang['reportsubject']}', '$message', ".$db->time($onlinetime).", 'no', 'yes')");
             }
-            echo "<center><span class=\"mediumtxt\">$lang[reportmsg]</span></center>";
-            $page = quickpage($postcount, $self['tpp']);
-            redirect('viewthread.php?tid='.$tid.'&page='.$page.'#pid'.$pid, 2, X_REDIRECT_JS);
+            $db->free_result($modquery);
+
+            $page = quickpage($postcount, $tpp);
+            message($lang['reportmsg'], false, '', '', 'viewthread.php?tid='.$tid.'&page='.$page.'#pid'.$pid, true, false, true);
         }
         break;
 
     case 'votepoll':
-        // Are we logged in? Only members can vote in polls (otherwise vote stuffing is trivial)
-        if (!X_MEMBER) {
-            error($lang['notloggedin'], false);
-        }
-
         // User voted in poll related to thread $tid. The vote option is contained in $postopnum
         $postopnum = formInt('postopnum');
         if ($postopnum === 0) {
@@ -828,41 +859,44 @@
         }
 
         // Does a poll exist for this thread?
-        $query = $db->query("SELECT vote_id FROM ".X_PREFIX."vote_desc WHERE topic_id='$tid'");
+        $tid = intval($tid);
+        $query = $db->query("SELECT vote_id FROM ".X_PREFIX."vote_desc WHERE topic_id=$tid");
         if ($query === false) {
             error($lang['pollvotenotselected'], false);
         }
 
         $vote_id = $db->fetch_array($query);
-        $vote_id = (int) $vote_id['vote_id'];
+        $vote_id = $vote_id['vote_id'];
         $db->free_result($query);
 
         // does the poll option exist?
-        $vote_result = $db->result($db->query("SELECT COUNT(vote_option_id) FROM ".X_PREFIX."vote_results WHERE vote_id='$vote_id' AND vote_option_id='$postopnum'"), 0);
+        $query = $db->query("SELECT COUNT(vote_option_id) FROM ".X_PREFIX."vote_results WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
+        $vote_result = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+        $db->free_result($query);
         if ($vote_result != 1) {
             error($lang['pollvotenotselected'], false);
         }
 
         // Has the user voted on this poll before?
-        $voted = $db->result($db->query("SELECT COUNT(vote_id) FROM ".X_PREFIX."vote_voters WHERE vote_id='$vote_id' AND vote_user_id='$self[uid]'"), 0);
+        $query = $db->query("SELECT COUNT(vote_id) FROM ".X_PREFIX."vote_voters WHERE vote_id=$vote_id AND vote_user_id={$self['uid']}");
+        $voted = $db->result($query, 0); //Aggregate functions with no grouping always return 1 row.
+        $db->free_result($query);
         if ($voted === 1) {
             error($lang['alreadyvoted'], false);
         }
 
         // Okay, the user is about to vote
-        $db->query("INSERT INTO ".X_PREFIX."vote_voters (vote_id, vote_user_id, vote_user_ip) VALUES ('$vote_id', '$self[uid]', '".encode_ip($onlineip)."')");
-        $db->query("UPDATE ".X_PREFIX."vote_results SET vote_result=vote_result+1 WHERE vote_id='$vote_id' AND vote_option_id='$postopnum'");
+        $db->query("INSERT INTO ".X_PREFIX."vote_voters (vote_id, vote_user_id, vote_user_ip) VALUES ($vote_id, {$self['uid']}, '".encode_ip($onlineip)."')");
+        $db->query("UPDATE ".X_PREFIX."vote_results SET vote_result=vote_result+1 WHERE vote_id=$vote_id AND vote_option_id=$postopnum");
 
         if ($tid > 0) {
-            echo '<center><span class="mediumtxt">'.$lang['votemsg'].'</span></center>';
-            redirect('viewthread.php?tid='.$tid, 2, X_REDIRECT_JS);
+            message($lang['votemsg'], false, '', '', 'viewthread.php?tid='.$tid, true, false, true);
         } else {
-            echo '<center><span class="mediumtxt">'.$lang['votemsg'].'</span></center>';
-            redirect('index.php', 2, X_REDIRECT_JS);
+            message($lang['votemsg'], false, '', '', 'index.php', true, false, true);
         }
         break;
 }
 
 end_time();
 eval('echo "'.template('footer').'";');
-?>
\ No newline at end of file
+?>
Index: u2u.php
===================================================================
--- u2u.php	(revision 761)
+++ u2u.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'u2u.php');
+
 require 'header.php';
 require ROOT.'include/u2u.inc.php';
 
@@ -57,8 +59,8 @@
 
 eval('$css = "'.template('css').'";');
 
-$action = getVar('action');
-$sendmode = (isset($action) && $action == 'send') ? "true" : "false";
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
+$sendmode = ($action == 'send') ? "true" : "false";
 
 eval('$u2uheader = "'.template('u2u_header').'";');
 eval('$u2ufooter = "'.template('u2u_footer').'";');
@@ -68,16 +70,16 @@
     exit;
 }
 
-$folder = formVar('folder');
-if (!$folder) {
-    $folder = getVar('folder');
+$folder = postedVar('folder', '', TRUE, TRUE, TRUE);
+if ($folder == '') {
+    $folder = postedVar('folder', '', TRUE, TRUE, TRUE, 'g');
 }
 
 $folderlist = '';
 $folders = '';
 $farray = array();
-if ($folder && (!$action || $action == 'mod' || $action == 'view')) {
-    $folder = checkInput($folder, true);
+if ($folder != '' && ($action == '' || $action == 'mod' || $action == 'view')) {
+    //$folder = checkInput($folder, true);
 } else {
     $folder = 'Inbox';
 }
@@ -85,7 +87,7 @@
 $u2ucount = u2u_folderList();
 $u2uid = getInt('u2uid');
 if (!$u2uid) {
-    $u2uid = formVar('u2uid');
+    $u2uid = postedVar('u2uid');
 }
 
 $thewidth = ($self['useoldu2u'] == 'yes') ? $tablewidth : '100%';
@@ -179,9 +181,9 @@
         }
         break;
     case 'send':
-        $msgto = formVar('msgto');
-        $subject = formVar('subject');
-        $message = formVar('message');
+        $msgto = postedVar('msgto', 'javascript', TRUE, TRUE, TRUE);
+        $subject = postedVar('subject', 'javascript', TRUE, TRUE, TRUE);
+        $message = postedVar('message');
         $leftpane = u2u_send($u2uid, $msgto, $subject, $message, $u2upreview);
         break;
     case 'view':
@@ -203,7 +205,7 @@
         $leftpane = u2u_ignore();
         break;
     case 'emptytrash':
-        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE folder='Trash' AND owner='$self[username]'");
+        $db->query("DELETE FROM ".X_PREFIX."u2u WHERE folder='Trash' AND owner='$xmbuser'");
         u2u_msg($lang['texttrashemptied'], 'u2u.php');
         break;
     default:
@@ -228,4 +230,4 @@
 eval('$u2uquotabar = "'.template('u2u_quotabar').'";');
 $tu2u = ($self['useoldu2u'] == 'yes') ? 'u2u_old' : 'u2u';
 eval('echo stripslashes("'.template($tu2u).'");');
-?>
\ No newline at end of file
+?>
Index: viewthread.php
===================================================================
--- viewthread.php	(revision 761)
+++ viewthread.php	(revision 936)
@@ -1,7 +1,7 @@
 <?php
 /**
  * eXtreme Message Board
- * XMB 1.9.8 Engage Final SP2
+ * XMB 1.9.8 Engage Final SP3
  *
  * Developed And Maintained By The XMB Group
  * Copyright (c) 2001-2008, The XMB Group
@@ -26,6 +26,8 @@
  *
  **/
 
+define('X_SCRIPT', 'viewthread.php');
+
 require 'header.php';
 
 validatePpp();
@@ -34,8 +36,8 @@
 $tid = getInt('tid');
 $fid = getInt('fid');
 $page = getInt('page');
-$goto = getVar('goto');
-$action = getVar('action');
+$goto = postedVar('goto', '', FALSE, FALSE, FALSE, 'g');
+$action = postedVar('action', '', FALSE, FALSE, FALSE, 'g');
 
 if ($goto == 'lastpost') {
     if ($pid > 0) {
@@ -48,6 +50,7 @@
         $db->free_result($query);
 
         if ($posts == 0) {
+            header('HTTP/1.1 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
@@ -57,6 +60,7 @@
         $db->free_result($query);
 
         if ($posts == 0) {
+            header('HTTP/1.1 404 Not Found');
             eval('$css = "'.template('css').'";');
             error($lang['textnothread']);
         }
@@ -137,6 +141,7 @@
 $query = $db->query("SELECT fid, subject, replies, closed, topped, lastpost FROM ".X_PREFIX."threads WHERE tid='$tid'");
 if ($tid == 0 || $db->num_rows($query) != 1) {
     $db->free_result($query);
+    header('HTTP/1.1 404 Not Found');
     error($lang['textnothread']);
 }
 
@@ -245,7 +250,7 @@
 
 $status1 = modcheck($self['status'], $xmbuser, $forum['moderator']);
 
-if (!$action) {
+if ($action == '') {
     if (X_MEMBER && $self['sig'] != '') {
         $usesig = true;
     }
@@ -460,7 +465,7 @@
                 eval('$site = "'.template('viewthread_post_site').'";');
             }
 
-            $encodename = rawurlencode($post['author']);
+            $encodename = recodeOut($post['author']);
 
             $icq = '';
             if ($post['icq'] != '' && $post['icq'] > 0) {
@@ -469,16 +474,19 @@
 
             $aim = '';
             if ($post['aim'] != '') {
+                $post['aim'] = recodeOut($post['aim']);
                 eval('$aim = "'.template('viewthread_post_aim').'";');
             }
 
             $msn = '';
             if ($post['msn'] != '') {
+                $post['msn'] = recodeOut($post['msn']);
                 eval('$msn = "'.template('viewthread_post_msn').'";');
             }
 
             $yahoo = '';
             if ($post['yahoo'] != '') {
+                $post['yahoo'] = recodeOut($post['yahoo']);
                 eval('$yahoo = "'.template('viewthread_post_yahoo').'";');
             }
 
@@ -531,12 +539,7 @@
             $avatar = '';
             if ($SETTINGS['avastatus'] == 'on' || $SETTINGS['avastatus'] == 'list') {
                 if ($post['avatar'] != '' && $allowavatars != "no") {
-                    if (false !== ($pos = strpos($post['avatar'], ',')) && substr($post['avatar'], $pos-4, 4) == '.swf') {
-                        $flashavatar = explode(',',$post['avatar']);
-                        $avatar = '<object type="application/x-shockwave-flash" data="'.$flashavatar[0].'" width="'.$flashavatar[1].'" height="'.$flashavatar[2].'"><param name="movie" value="'.$flashavatar[0].'" /><param name="AllowScriptAccess" value="never" /></object>';
-                    } else {
-                        $avatar = '<img src="'.$post['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
-                    }
+                    $avatar = '<img src="'.$post['avatar'].'" alt="'.$lang['altavatar'].'" border="0" />';
                 }
             }
 
@@ -606,7 +609,8 @@
         $post['message'] = postify($post['message'], $smileyoff, $bbcodeoff, $forum['allowsmilies'], $forum['allowhtml'], $forum['allowbbcode'], $forum['allowimgcode']);
 
         if ($post['filename'] != '' && $forum['attachstatus'] != 'off') {
-            $attachsize = $post['filesize'];
+                $post['filename'] = checkInput($post['filename'], 'no', 'no', '', false);
+                $post['filetype'] = checkInput($post['filetype'], 'no', 'no', '', false);$attachsize = $post['filesize'];
             if ($attachsize >= 1073741824) {
                 $attachsize = round($attachsize / 1073741824 * 100) / 100 . "gb";
             } else if ($attachsize >= 1048576) {
@@ -675,13 +679,12 @@
     }
 
     $type = strtolower($file['filetype']);
-    $name = str_replace(' ', '_', $file['filename']);
     $size = (int) $file['filesize'];
     $type = ($type == 'text/html') ? 'text/plain' : $type;
 
     header("Content-type: $type");
     header("Content-length: $size");
-    header("Content-Disposition: attachment; filename=$name");
+    header("Content-Disposition: attachment; filename=\"{$file['filename']}\"");
     header("Content-Description: XMB Attachment");
     header("Cache-Control: public; max-age=604800");
     header("Expires: 604800");
@@ -706,4 +709,4 @@
     $db->free_result($querypost);
     eval('echo stripslashes("'.template('viewthread_printable').'");');
 }
-?>
\ No newline at end of file
+?>
